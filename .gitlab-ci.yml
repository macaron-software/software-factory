stages:
  - deploy

# Architecture:
#   GitLab CI → triggers GitHub Actions (network-agnostic)
#   GitHub Actions → SSH to Azure VM (unrestricted outbound)
#
# Required GitLab CI/CD variables:
#   GH_DISPATCH_TOKEN  — GitHub PAT (repo + workflow scope)

deploy-azure:
  stage: deploy
  image: alpine
  before_script:
    - apk add --no-cache curl
  script:
    - |
      echo "Triggering GitHub Actions deploy-azure workflow..."
      HTTP=$(curl -s -o /tmp/gh_resp.txt -w "%{http_code}" \
        -X POST \
        -H "Authorization: Bearer $GH_DISPATCH_TOKEN" \
        -H "Accept: application/vnd.github+json" \
        "https://api.github.com/repos/macaron-software/software-factory/actions/workflows/deploy-azure.yml/dispatches" \
        -d '{"ref":"main"}')
      cat /tmp/gh_resp.txt
      if [ "$HTTP" = "204" ]; then
        echo "✓ GitHub Actions deploy triggered (HTTP 204)"
      else
        echo "✗ Dispatch failed (HTTP $HTTP)"
        exit 1
      fi
  only:
    - main
