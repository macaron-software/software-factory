{% extends "base.html" %}

{% block topbar_actions %}
<a href="/agents" class="btn">
    <svg class="icon icon-sm"><use href="#icon-arrow-right"/></svg> Back
</a>
{% endblock %}

{% block content %}
<form class="agent-form" method="post" action="/api/agents/{{ agent.id or '' }}">
    {% if agent.id %}
    <input type="hidden" name="id" value="{{ agent.id }}">
    {% endif %}

    <div class="form-grid">
        <!-- Left column: identity + skills + tools + memory -->
        <div class="form-column">
            <div class="panel">
                <div class="panel-header"><h3>{{ _("identity") }}</h3></div>
                <div class="panel-body">
                    <div class="form-row">
                        <div class="form-group" style="flex:2">
                            <label for="name">{{ _("name") }}</label>
                            <input type="text" id="name" name="name" value="{{ agent.name }}" required placeholder="e.g. Analyste de Données">
                        </div>
                        <div class="form-group" style="flex:1">
                            <label for="role">{{ _("role") }}</label>
                            <select id="role" name="role">
                                {% for r in roles %}
                                <option value="{{ r }}" {% if agent.role == r %}selected{% endif %}>{{ r }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="icon">{{ _("icon") }}</label>
                            <select id="icon" name="icon">
                                {% for ic in icons %}
                                <option value="{{ ic }}" {% if agent.icon == ic %}selected{% endif %}>{{ ic }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="color">{{ _("color") }}</label>
                            <input type="color" id="color" name="color" value="{{ agent.color }}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="avatar">{{ _("avatar_icon") }}</label>
                            <select id="avatar" name="avatar" style="width:140px">
                                <option value="">— default —</option>
                                {% for ic in icons %}
                                <option value="{{ ic }}" {% if agent.avatar == ic %}selected{% endif %}>{{ ic }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group" style="flex:1">
                            <label for="tagline">{{ _("tagline") }}</label>
                            <input type="text" id="tagline" name="tagline" value="{{ agent.tagline }}" placeholder="Short personality quote...">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="description">{{ _("description") }}</label>
                        <textarea id="description" name="description" rows="2" placeholder="What this agent does...">{{ agent.description }}</textarea>
                    </div>
                    <div class="form-group">
                        <label for="tags">{{ _("tags_comma_separated") }}</label>
                        <input type="text" id="tags" name="tags" value="{{ agent.tags | join(', ') }}" placeholder="coding, review, rust">
                    </div>
                </div>
            </div>

            <!-- Skills section (editable list) -->
            <div class="panel">
                <div class="panel-header">
                    <h3>{{ _("skills") }}</h3>
                    <button type="button" class="btn btn-sm" onclick="addSkillRow()">
                        <svg class="icon icon-xs"><use href="#icon-plus"/></svg> Add
                    </button>
                </div>
                <div class="panel-body" id="skills-list">
                    {% for s in agent.skills %}
                    <div class="editable-list-row">
                        <input type="text" name="skills[]" value="{{ s }}" class="list-row-input" placeholder="e.g. Python Data Analysis">
                        <button type="button" class="list-row-btn edit" onclick="this.previousElementSibling.focus()">
                            <svg class="icon icon-xs"><use href="#icon-settings"/></svg>
                        </button>
                        <button type="button" class="list-row-btn delete" onclick="this.parentElement.remove()">
                            <svg class="icon icon-xs"><use href="#icon-trash"/></svg>
                        </button>
                    </div>
                    {% endfor %}
                    {% if not agent.skills %}
                    <div class="editable-list-empty">{{ _("no_skills_assigned") }}</div>
                    {% endif %}
                </div>
            </div>

            <!-- Tools section -->
            <div class="panel">
                <div class="panel-header">
                    <h3>{{ _("tools") }}</h3>
                    <button type="button" class="btn btn-sm" onclick="addToolRow()">
                        <svg class="icon icon-xs"><use href="#icon-plus"/></svg> Add tools
                    </button>
                </div>
                <div class="panel-body" id="tools-list">
                    {% for t in agent.tools %}
                    <div class="editable-list-row">
                        <span class="list-row-icon"><svg class="icon icon-xs"><use href="#icon-plug"/></svg></span>
                        <input type="text" name="tools[]" value="{{ t }}" class="list-row-input" placeholder="e.g. git, build, test">
                        <button type="button" class="list-row-btn edit" onclick="this.previousElementSibling.focus()">
                            <svg class="icon icon-xs"><use href="#icon-settings"/></svg>
                        </button>
                        <button type="button" class="list-row-btn delete" onclick="this.parentElement.remove()">
                            <svg class="icon icon-xs"><use href="#icon-trash"/></svg>
                        </button>
                    </div>
                    {% endfor %}
                    {% if not agent.tools %}
                    <div class="editable-list-empty">{{ _("no_tools_connected") }}</div>
                    {% endif %}
                </div>
            </div>

            <!-- Memory section -->
            <div class="panel">
                <div class="panel-header"><h3>{{ _("memory") }}</h3></div>
                <div class="panel-body">
                    <div class="form-group">
                        <label for="memory_type">{{ _("memory_type") }}</label>
                        <select id="memory_type" name="memory_type">
                            <option value="session">{{ _("session_ephemeral") }}</option>
                            <option value="project">{{ _("project_persistent") }}</option>
                            <option value="global">{{ _("global_cross_project") }}</option>
                            <option value="vector">{{ _("vector_store") }}</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="context_window">{{ _("context_window_size") }}</label>
                        <input type="number" id="context_window" name="context_window" value="200" min="50" max="1000" step="50">
                    </div>
                </div>
            </div>
        </div>

        <!-- Right column: LLM + permissions + system prompt -->
        <div class="form-column">
            <div class="panel">
                <div class="panel-header"><h3>{{ _("llm_configuration") }}</h3></div>
                <div class="panel-body">
                    <div class="form-group">
                        <label for="provider">{{ _("provider") }}</label>
                        <select id="provider" name="provider" onchange="updateModels(this.value)">
                            {% for p in providers %}
                            <option value="{{ p.id }}" {% if agent.provider == p.id %}selected{% endif %} {% if not p.enabled %}disabled{% endif %}>
                                {{ p.name }}{% if not p.has_key %} (no API key){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="model">{{ _("model") }}</label>
                        <select id="model" name="model">
                            {% for m in models %}
                            <option value="{{ m.model }}" data-provider="{{ m.provider }}" {% if agent.model == m.model and agent.provider == m.provider %}selected{% endif %}>
                                {{ m.label }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="temperature">{{ _("temperature") }}</label>
                            <input type="number" id="temperature" name="temperature" value="{{ agent.temperature }}" min="0" max="2" step="0.1">
                        </div>
                        <div class="form-group">
                            <label for="max_tokens">{{ _("max_tokens") }}</label>
                            <input type="number" id="max_tokens" name="max_tokens" value="{{ agent.max_tokens }}" min="256" max="32768" step="256">
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header"><h3>{{ _("permissions") }}</h3></div>
                <div class="panel-body">
                    <label class="checkbox-label">
                        <input type="checkbox" name="can_veto" {% if agent.permissions.get('can_veto') %}checked{% endif %}>
                        Can veto (reject code/decisions)
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" name="can_approve" {% if agent.permissions.get('can_approve') %}checked{% endif %}>
                        Can approve (sign off on changes)
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" name="can_delegate" {% if agent.permissions.get('can_delegate') %}checked{% endif %}>
                        Can delegate (assign sub-tasks)
                    </label>
                </div>
            </div>

            <!-- System prompt -->
            <div class="panel">
                <div class="panel-header"><h3>{{ _("system_prompt") }}</h3></div>
                <div class="panel-body">
                    <textarea id="system_prompt" name="system_prompt" rows="12" class="code-textarea" placeholder="Instructions for the agent...">{{ agent.system_prompt }}</textarea>
                </div>
            </div>
        </div>
    </div>

    <div class="form-actions">
        <a href="/agents" class="btn">{{ _("cancel") }}</a>
        <button type="submit" class="btn btn-primary btn-lg">
            <svg class="icon icon-sm"><use href="#icon-check"/></svg>
            {{ 'Update' if agent.id else 'Create' }} Agent
        </button>
    </div>
</form>

<script>
function updateModels(provider) {
    const sel = document.getElementById('model');
    for (const opt of sel.options) {
        opt.hidden = opt.dataset.provider !== provider;
    }
    for (const opt of sel.options) {
        if (!opt.hidden) { sel.value = opt.value; break; }
    }
}
document.addEventListener('DOMContentLoaded', () => updateModels(document.getElementById('provider').value));

function addSkillRow() {
    const list = document.getElementById('skills-list');
    list.querySelector('.editable-list-empty')?.remove();
    const row = document.createElement('div');
    row.className = 'editable-list-row';
    row.innerHTML = `<input type="text" name="skills[]" class="list-row-input" placeholder="e.g. Python Data Analysis">
        <button type="button" class="list-row-btn edit" onclick="this.previousElementSibling.focus()"><svg class="icon icon-xs"><use href="#icon-settings"/></svg></button>
        <button type="button" class="list-row-btn delete" onclick="this.parentElement.remove()"><svg class="icon icon-xs"><use href="#icon-trash"/></svg></button>`;
    list.appendChild(row);
    row.querySelector('input').focus();
}

function addToolRow() {
    const list = document.getElementById('tools-list');
    list.querySelector('.editable-list-empty')?.remove();
    const row = document.createElement('div');
    row.className = 'editable-list-row';
    row.innerHTML = `<span class="list-row-icon"><svg class="icon icon-xs"><use href="#icon-plug"/></svg></span>
        <input type="text" name="tools[]" class="list-row-input" placeholder="e.g. git, build, test">
        <button type="button" class="list-row-btn edit" onclick="this.previousElementSibling.focus()"><svg class="icon icon-xs"><use href="#icon-settings"/></svg></button>
        <button type="button" class="list-row-btn delete" onclick="this.parentElement.remove()"><svg class="icon icon-xs"><use href="#icon-trash"/></svg></button>`;
    list.appendChild(row);
    row.querySelector('input').focus();
}
</script>
{% endblock %}
