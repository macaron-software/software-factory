{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="/static/css/monitoring.css?v=20260221c">

<div class="mon-page" id="monRoot">
    <div class="mon-header">
        <h1>
            <svg class="icon" style="width:20px;height:20px;vertical-align:middle;margin-right:0.3rem"><use href="#icon-activity"/></svg>
            Macaron Agent Platform â€” Monitoring
        </h1>
        <div class="mon-status">
            <span class="dot"></span>
            <span id="monUptime">â€”</span>
        </div>
    </div>

    <!-- Row 1: System vitals -->
    <div class="mon-grid" style="display:grid;grid-template-columns:repeat(5,1fr);gap:0.8rem">
        <div class="mon-card">
            <h3><svg class="icon"><use href="#icon-cpu"/></svg> {{ _("cpu") }}</h3>
            <div class="mon-big" id="monCpu">â€”</div>
            <div class="mon-sub" id="monCpuSys">{{ _("system") }}</div>
            <div class="mon-bar"><div class="mon-bar-fill green" id="monCpuBar" style="width:0%"></div></div>
        </div>
        <div class="mon-card">
            <h3><svg class="icon"><use href="#icon-layers"/></svg> {{ _("memory") }}</h3>
            <div class="mon-big" id="monMem">â€”</div>
            <div class="mon-sub" id="monMemSys">{{ _("system") }}</div>
            <div class="mon-bar"><div class="mon-bar-fill green" id="monMemBar" style="width:0%"></div></div>
        </div>
        <div class="mon-card">
            <h3><svg class="icon"><use href="#icon-database"/></svg> Disk</h3>
            <div class="mon-big" id="monDisk">â€”</div>
            <div class="mon-sub" id="monDiskSub">â€”</div>
            <div class="mon-bar"><div class="mon-bar-fill green" id="monDiskBar" style="width:0%"></div></div>
        </div>
        <div class="mon-card">
            <h3><svg class="icon"><use href="#icon-users"/></svg> Agents</h3>
            <div class="mon-row">
                <div class="mon-col"><div class="label">{{ _("registered") }}</div><div class="val" id="monAgentsRegistered">0</div></div>
                <div class="mon-col"><div class="label">{{ _("active_now") }}</div><div class="val" id="monAgentsActive">0</div></div>
                <div class="mon-col"><div class="label">{{ _("participated") }}</div><div class="val" id="monAgentsParticipated">0</div></div>
                <div class="mon-col"><div class="label">{{ _("sessions") }}</div><div class="val" id="monAgentsSessions">0</div></div>
            </div>
        </div>
        <div class="mon-card">
            <h3><svg class="icon"><use href="#icon-message-circle"/></svg> Messages</h3>
            <div class="mon-row">
                <div class="mon-col"><div class="label">24h</div><div class="val" id="monMsg24h">0</div></div>
                <div class="mon-col"><div class="label">{{ _("total") }}</div><div class="val" id="monMsgTotal">0</div></div>
                <div class="mon-col"><div class="label">{{ _("projects") }}</div><div class="val" id="monProjects">â€”</div></div>
            </div>
        </div>
    </div>

    <!-- Row 2: LLM Usage -->
    <div class="mon-grid mon-grid-2">
        <div class="mon-card">
            <h3 style="display:flex;align-items:center;gap:0.5rem">
                <svg class="icon"><use href="#icon-zap"/></svg>
                <span>{{ _("llm_usage") }}</span>
                <span id="monLlmPeriod" style="opacity:0.5;font-weight:400;font-size:0.75rem">(24h)</span>
                <div style="margin-left:auto;display:flex;gap:0.25rem">
                    <button class="mon-range-btn" onclick="setRange(24)" data-hours="24">24h</button>
                    <button class="mon-range-btn" onclick="setRange(168)" data-hours="168">7d</button>
                    <button class="mon-range-btn" onclick="setRange(720)" data-hours="720">30d</button>
                    <button class="mon-range-btn" onclick="setRange(8760)" data-hours="8760">1y</button>
                </div>
            </h3>
            <div class="mon-row" style="margin-bottom:1rem">
                <div class="mon-col"><div class="label">{{ _("calls") }}</div><div class="val" id="monLlmCalls">0</div></div>
                <div class="mon-col"><div class="label">{{ _("tokens_in") }}</div><div class="val" id="monLlmIn">0</div></div>
                <div class="mon-col"><div class="label">{{ _("tokens_out") }}</div><div class="val" id="monLlmOut">0</div></div>
                <div class="mon-col"><div class="label">{{ _("cost") }}</div><div class="val" id="monLlmCost">$0</div></div>
                <div class="mon-col"><div class="label">{{ _("latency") }}</div><div class="val" id="monLlmLatency">â€”</div></div>
                <div class="mon-col"><div class="label">{{ _("errors") }}</div><div class="val" id="monLlmErrors">0</div></div>
            </div>
            <div class="mon-chart" id="monLlmChart"><div class="mon-empty">{{ _("no_hourly_data") }}</div></div>
        </div>
        <div class="mon-card">
            <h3><svg class="icon"><use href="#icon-briefcase"/></svg> Missions & Sprints</h3>
            <div class="mon-section">
                <div class="mon-section-label">{{ _("missions") }}</div>
                <div id="monMissions" class="mon-badges-row"><span class="mon-empty">{{ _("no_missions") }}</span></div>
            </div>
            <div class="mon-section">
                <div class="mon-section-label">{{ _("sprints") }}</div>
                <div id="monSprints" class="mon-badges-row"><span class="mon-empty">{{ _("no_sprints") }}</span></div>
            </div>
            <div class="mon-section">
                <div class="mon-section-label">{{ _("features") }}</div>
                <div id="monFeatures" class="mon-badges-row"><span class="mon-empty">{{ _("no_features") }}</span></div>
            </div>
        </div>
    </div>

    <!-- Row 3: Providers + Top Agents -->
    <div class="mon-grid mon-grid-2">
        <div class="mon-card">
            <h3><svg class="icon"><use href="#icon-server"/></svg> LLM Providers</h3>
            <table class="mon-table">
                <thead><tr><th>{{ _("provider") }}</th><th>{{ _("model") }}</th><th>{{ _("calls") }}</th><th>{{ _("cost") }}</th><th>{{ _("avg_ms") }}</th></tr></thead>
                <tbody id="monProviders"><tr><td colspan="5" class="mon-empty">{{ _("loading_ellipsis") }}</td></tr></tbody>
            </table>
        </div>
        <div class="mon-card">
            <h3><svg class="icon"><use href="#icon-user"/></svg> Top Agents (by cost)</h3>
            <table class="mon-table">
                <thead><tr><th>{{ _("agent") }}</th><th>{{ _("calls") }}</th><th>{{ _("tokens_out") }}</th><th>{{ _("cost") }}</th></tr></thead>
                <tbody id="monTopAgents"><tr><td colspan="4" class="mon-empty">{{ _("loading_ellipsis") }}</td></tr></tbody>
            </table>
        </div>
    </div>

    <!-- Row 4: Database + Vector Store -->
    <div class="mon-grid mon-grid-2">
        <div class="mon-card">
            <h3><svg class="icon"><use href="#icon-database"/></svg> Database (SQLite)</h3>
            <div class="mon-row" style="margin-bottom:0.8rem">
                <div class="mon-col"><div class="label">{{ _("size") }}</div><div class="val" id="monDbSize">â€”</div></div>
                <div class="mon-col"><div class="label">{{ _("tables") }}</div><div class="val" id="monDbTables">â€”</div></div>
                <div class="mon-col"><div class="label">{{ _("rows") }}</div><div class="val" id="monDbRows">â€”</div></div>
                <div class="mon-col"><div class="label">{{ _("journal") }}</div><div class="val" id="monDbJournal">â€”</div></div>
            </div>
            <table class="mon-table">
                <thead><tr><th>{{ _("table") }}</th><th style="text-align:right">{{ _("rows") }}</th></tr></thead>
                <tbody id="monDbTopTables"><tr><td colspan="2" class="mon-empty">{{ _("loading_ellipsis") }}</td></tr></tbody>
            </table>
        </div>
        <div class="mon-card">
            <h3><svg class="icon"><use href="#icon-search"/></svg> Vector Store</h3>
            <div class="mon-row" style="margin-bottom:0.8rem">
                <div class="mon-col"><div class="label">{{ _("vectors") }}</div><div class="val" id="monVecTotal">0</div></div>
                <div class="mon-col"><div class="label">{{ _("embedded") }}</div><div class="val" id="monVecEmbedded">0</div></div>
                <div class="mon-col"><div class="label">{{ _("scopes") }}</div><div class="val" id="monVecScopes">0</div></div>
                <div class="mon-col"><div class="label">{{ _("dim") }}</div><div class="val" id="monVecDim">â€”</div></div>
            </div>
            <div class="mon-sub" id="monVecProvider">â€”</div>
            <div class="mon-bar" style="margin-top:0.5rem"><div class="mon-bar-fill purple" id="monVecBar" style="width:0%"></div></div>
            <div class="mon-sub" id="monVecPct" style="font-size:0.65rem;margin-top:0.2rem">0% embedded</div>
        </div>
    </div>

    <!-- Row 5: HTTP Requests + MCP Tool Calls -->
    <div class="mon-grid mon-grid-2">
        <div class="mon-card">
            <h3><svg class="icon"><use href="#icon-activity"/></svg> HTTP Requests (live)</h3>
            <div class="mon-row" style="margin-bottom:0.8rem">
                <div class="mon-col"><div class="label">{{ _("total") }}</div><div class="val" id="monReqTotal">0</div></div>
                <div class="mon-col"><div class="label">4xx</div><div class="val mon-val-yellow" id="monReq4xx">0</div></div>
                <div class="mon-col"><div class="label">5xx</div><div class="val mon-val-red" id="monReq5xx">0</div></div>
                <div class="mon-col"><div class="label">{{ _("avg_ms") }}</div><div class="val" id="monReqAvg">â€”</div></div>
            </div>
            <table class="mon-table">
                <thead><tr><th>{{ _("endpoint") }}</th><th style="text-align:right">{{ _("hits") }}</th><th style="text-align:right">{{ _("avg") }}</th><th style="text-align:right">{{ _("p95") }}</th></tr></thead>
                <tbody id="monReqEndpoints"><tr><td colspan="4" class="mon-empty">{{ _("no_requests_yet") }}</td></tr></tbody>
            </table>
            <div class="mon-section" style="margin-top:0.5rem">
                <div class="mon-section-label">{{ _("status_codes") }}</div>
                <div id="monReqStatus" class="mon-badges-row"><span class="mon-empty">â€”</span></div>
            </div>
        </div>
        <div class="mon-card">
            <h3><svg class="icon"><use href="#icon-plug"/></svg> MCP Tool Calls</h3>
            <div class="mon-row" style="margin-bottom:0.8rem">
                <div class="mon-col"><div class="label">{{ _("total") }}</div><div class="val" id="monMcpCallsTotal">0</div></div>
                <div class="mon-col"><div class="label">{{ _("errors") }}</div><div class="val mon-val-red" id="monMcpCallsErrors">0</div></div>
                <div class="mon-col"><div class="label">{{ _("avg_ms") }}</div><div class="val" id="monMcpCallsAvg">â€”</div></div>
            </div>
            <table class="mon-table">
                <thead><tr><th>{{ _("tool") }}</th><th>{{ _("calls") }}</th><th>{{ _("errors") }}</th><th>{{ _("avg_ms") }}</th></tr></thead>
                <tbody id="monMcpCallsTable"><tr><td colspan="4" class="mon-empty">{{ _("no_mcp_calls_yet") }}</td></tr></tbody>
            </table>
        </div>
    </div>

    <!-- Row 5b: Docker Monitoring -->
    <div class="mon-grid mon-grid-1">
        <div class="mon-card">
            <h3><svg class="icon"><use href="#icon-layers"/></svg> Docker</h3>
            <!-- Docker system overview -->
            <div class="mon-row" style="margin-bottom:1rem">
                <div class="mon-col"><div class="label">{{ _("version") }}</div><div class="val" id="monDockerVersion">â€”</div></div>
                <div class="mon-col"><div class="label">{{ _("running") }}</div><div class="val" id="monDockerRunning">â€”</div></div>
                <div class="mon-col"><div class="label">{{ _("stopped") }}</div><div class="val" id="monDockerStopped">â€”</div></div>
                <div class="mon-col"><div class="label">{{ _("images") }}</div><div class="val" id="monDockerImages">â€”</div></div>
                <div class="mon-col"><div class="label">{{ _("volumes") }}</div><div class="val" id="monDockerVolumes">â€”</div></div>
                <div class="mon-col"><div class="label">{{ _("disk_usage") }}</div><div class="val" id="monDockerDisk">â€”</div></div>
            </div>
            <!-- Docker disk breakdown -->
            <div class="mon-row" style="margin-bottom:1rem">
                <div class="mon-col"><div class="label">{{ _("images") }}</div><div class="val" style="font-size:0.7rem" id="monDockerImgDisk">â€”</div></div>
                <div class="mon-col"><div class="label">{{ _("containers") }}</div><div class="val" style="font-size:0.7rem" id="monDockerCtDisk">â€”</div></div>
                <div class="mon-col"><div class="label">{{ _("volumes") }}</div><div class="val" style="font-size:0.7rem" id="monDockerVolDisk">â€”</div></div>
                <div class="mon-col"><div class="label">{{ _("build_cache") }}</div><div class="val" style="font-size:0.7rem" id="monDockerCacheDisk">â€”</div></div>
            </div>
            <!-- Container table with CPU/Memory -->
            <table class="mon-table">
                <thead><tr><th>{{ _("container") }}</th><th>{{ _("status") }}</th><th>CPU</th><th>Memory</th><th>{{ _("net_i_o") }}</th><th>{{ _("pids") }}</th><th>{{ _("image") }}</th></tr></thead>
                <tbody id="monDockerTable"><tr><td colspan="7" class="mon-empty">{{ _("loading_ellipsis") }}</td></tr></tbody>
            </table>
        </div>
    </div>

    <!-- Row 5c: Git Activity -->
    <div class="mon-grid mon-grid-1">
        <div class="mon-card">
            <h3><svg class="icon"><use href="#icon-git-branch"/></svg> Git Activity</h3>
            <div class="mon-row" style="margin-bottom:0.8rem">
                <div class="mon-col"><div class="label">{{ _("branch") }}</div><div class="val" id="monGitBranch">â€”</div></div>
                <div class="mon-col"><div class="label">{{ _("last_commit") }}</div><div class="val" id="monGitLastCommit">â€”</div></div>
            </div>
            <table class="mon-table">
                <thead><tr><th>{{ _("hash") }}</th><th>{{ _("message") }}</th></tr></thead>
                <tbody id="monGitCommits"><tr><td colspan="2" class="mon-empty">{{ _("loading_ellipsis") }}</td></tr></tbody>
            </table>
        </div>
    </div>

    <!-- Row 6: MCP Servers + Incidents -->
    <div class="mon-grid mon-grid-2">
        <div class="mon-card">
            <h3><svg class="icon"><use href="#icon-server"/></svg> MCP Servers</h3>
            <div id="monMcpServers" class="mon-mcp-list">
                <div class="mon-empty">{{ _("loading_ellipsis") }}</div>
            </div>
        </div>
        <div class="mon-card">
            <h3><svg class="icon"><use href="#icon-alert-triangle"/></svg> Incidents</h3>
            <div class="mon-row" style="margin-bottom:0.8rem">
                <div class="mon-col"><div class="label">{{ _("open") }}</div><div class="val mon-val-red" id="monIncOpen">0</div></div>
                <div class="mon-col"><div class="label">{{ _("total") }}</div><div class="val" id="monIncTotal">0</div></div>
            </div>
            <div id="monIncBadges" class="mon-badges-row"><span class="mon-empty">{{ _("no_incidents") }}</span></div>
        </div>
    </div>

    <!-- Row 7: LLM Costs + Anonymization -->
    <div class="mon-grid mon-grid-2">
        <div class="mon-card">
            <h3><svg class="icon"><use href="#icon-zap"/></svg> LLM Costs (live session)</h3>
            <div class="mon-row" style="margin-bottom:0.8rem">
                <div class="mon-col"><div class="label">{{ _("total") }}</div><div class="val" id="monCostTotal">$0</div></div>
            </div>
            <table class="mon-table">
                <thead><tr><th>{{ _("provider") }}</th><th>{{ _("calls") }}</th><th>{{ _("tokens") }}</th><th>{{ _("cost") }}</th></tr></thead>
                <tbody id="monCostByProvider"><tr><td colspan="4" class="mon-empty">{{ _("no_llm_costs_yet") }}</td></tr></tbody>
            </table>
        </div>
        <div class="mon-card">
            <h3><svg class="icon"><use href="#icon-layers"/></svg> Anonymization (RLM)</h3>
            <div class="mon-row" style="margin-bottom:0.8rem">
                <div class="mon-col"><div class="label">{{ _("total") }}</div><div class="val" id="monAnonTotal">0</div></div>
            </div>
            <div id="monAnonByType" class="mon-badges-row"><span class="mon-empty">{{ _("no_anonymization_data") }}</span></div>
            <div class="mon-section" style="margin-top:0.5rem">
                <div class="mon-section-label">{{ _("rlm_cache_scopes") }}</div>
                <div id="monRlmScopes" class="mon-badges-row"><span class="mon-empty">â€”</span></div>
            </div>
        </div>
    </div>

    <!-- Row 8: Azure Infrastructure -->
    <div class="mon-grid mon-grid-2">
        <div class="mon-card">
            <h3><svg class="icon"><use href="#icon-server"/></svg> Azure VM</h3>
            <div class="mon-row" style="margin-bottom:0.8rem">
                <div class="mon-col"><div class="label">{{ _("name") }}</div><div class="val" id="monAzVmName">â€”</div></div>
                <div class="mon-col"><div class="label">{{ _("ip") }}</div><div class="val" id="monAzVmIp">â€”</div></div>
                <div class="mon-col"><div class="label">{{ _("region") }}</div><div class="val" id="monAzVmRegion">â€”</div></div>
                <div class="mon-col"><div class="label">{{ _("size") }}</div><div class="val" id="monAzVmSize">â€”</div></div>
            </div>
            <div class="mon-section-label">{{ _("services") }}</div>
            <div id="monAzServers" class="mon-mcp-list"><span class="mon-empty">{{ _("loading_ellipsis") }}</span></div>
        </div>
        <div class="mon-card">
            <h3><svg class="icon"><use href="#icon-database"/></svg> Azure Backup</h3>
            <div class="mon-row" style="margin-bottom:0.8rem">
                <div class="mon-col"><div class="label">{{ _("account") }}</div><div class="val" id="monAzBackupAcct">â€”</div></div>
                <div class="mon-col"><div class="label">{{ _("replication") }}</div><div class="val" id="monAzBackupGRS">â€”</div></div>
                <div class="mon-col"><div class="label">{{ _("sqlite_dbs") }}</div><div class="val" id="monAzBackupDbs">â€”</div></div>
            </div>
            <div class="mon-section" style="margin-top:0.3rem">
                <div class="mon-section-label">{{ _("containers") }}</div>
                <div id="monAzContainers" class="mon-badges-row"><span class="mon-empty">â€”</span></div>
            </div>
            <div class="mon-section" style="margin-top:0.3rem">
                <div class="mon-section-label">{{ _("retention") }}</div>
                <div id="monAzRetention" class="mon-badges-row"><span class="mon-empty">â€”</span></div>
            </div>
        </div>
    </div>

    <!-- Row 9: Azure Costs + Process -->
    <div class="mon-grid mon-grid-2">
        <div class="mon-card">
            <h3><svg class="icon"><use href="#icon-zap"/></svg> Azure Costs</h3>
            <div class="mon-section-label" style="margin-bottom:0.3rem">{{ _("llm_token_usage") }}</div>
            <div class="mon-row" style="margin-bottom:0.8rem">
                <div class="mon-col"><div class="label">{{ _("azure_llm") }}</div><div class="val" id="monAzCostAzure">$0</div></div>
                <div class="mon-col"><div class="label">{{ _("other_llm") }}</div><div class="val" id="monAzCostOther">$0</div></div>
                <div class="mon-col"><div class="label">{{ _("total_llm") }}</div><div class="val" id="monAzCostTotal">$0</div></div>
            </div>
            <div class="mon-section-label" style="margin-bottom:0.3rem">{{ _("infrastructure_monthly_est") }}</div>
            <div class="mon-row">
                <div class="mon-col"><div class="label">{{ _("vm_b2ms") }}</div><div class="val" id="monAzCostVm">â€”</div></div>
                <div class="mon-col"><div class="label">{{ _("pg_b1ms") }}</div><div class="val" id="monAzCostPg">â€”</div></div>
                <div class="mon-col"><div class="label">{{ _("storage") }}</div><div class="val" id="monAzCostStorage">â€”</div></div>
                <div class="mon-col"><div class="label">{{ _("total_mo") }}</div><div class="val" id="monAzCostInfra" style="color:var(--accent)">â€”</div></div>
            </div>
        </div>
        <div class="mon-card">
            <h3><svg class="icon"><use href="#icon-settings"/></svg> Process</h3>
            <div class="mon-row">
                <div class="mon-col"><div class="label">{{ _("pid") }}</div><div class="val" id="monPid">â€”</div></div>
                <div class="mon-col"><div class="label">{{ _("threads") }}</div><div class="val" id="monThreads">â€”</div></div>
                <div class="mon-col"><div class="label">{{ _("open_files") }}</div><div class="val" id="monFiles">â€”</div></div>
            </div>
        </div>
    </div>

    <!-- Row 10: Memory + Phase Stats -->
    <div class="mon-grid mon-grid-2">
        <div class="mon-card">
            <h3><svg class="icon"><use href="#icon-book-open"/></svg> Memory</h3>
            <div id="monMemory" class="mon-row"><span class="mon-empty">{{ _("loading_ellipsis") }}</span></div>
        </div>
        <div class="mon-card">
            <h3><svg class="icon"><use href="#icon-activity"/></svg> Mission Phases</h3>
            <table class="mon-table">
                <thead><tr><th>{{ _("phase") }}</th><th>{{ _("status") }}</th><th>{{ _("count") }}</th><th>{{ _("avg_time") }}</th></tr></thead>
                <tbody id="monPhaseStats"><tr><td colspan="4" class="mon-empty">{{ _("loading_ellipsis") }}</td></tr></tbody>
            </table>
        </div>
    </div>
</div>

<script>
let currentHours = 24;
function fmt(n) {
    if (n == null) return 'â€”';
    if (n >= 1e6) return (n/1e6).toFixed(1) + 'M';
    if (n >= 1e3) return (n/1e3).toFixed(1) + 'K';
    return String(n);
}
function fmtUsd(n) { return '$' + (n || 0).toFixed(2); }
function fmtTime(sec) {
    if (!sec) return 'â€”';
    if (sec < 60) return sec + 's';
    if (sec < 3600) return Math.floor(sec/60) + 'm';
    const h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60);
    return h + 'h' + (m ? m + 'm' : '');
}
function badges(obj, el) {
    const colors = {completed:'green',done:'green',active:'blue',running:'blue',in_progress:'purple',failed:'red',pending:'yellow',backlog:'yellow',planning:'yellow',blocked:'red',review:'purple'};
    const entries = Object.entries(obj || {});
    if (entries.length === 0) {
        el.innerHTML = '<span class="mon-empty">â€”</span>';
        return;
    }
    el.innerHTML = entries.map(([k,v]) =>
        `<span class="mon-badge ${colors[k]||'purple'}">${k}: ${v}</span>`
    ).join('');
}
function barColor(pct) { return pct > 80 ? 'red' : pct > 60 ? 'yellow' : 'green'; }
function $(id) { return document.getElementById(id); }

async function refresh() {
    try {
        const r = await fetch('/api/monitoring/live?hours=' + currentHours);
        if (!r.ok) return;
        const d = await r.json();
        const s = d.system || {};

        // System
        $('monCpu').textContent = (s.cpu_percent || 0) + '%';
        $('monCpuSys').textContent = 'System: ' + (s.sys_cpu_percent || 0) + '%';
        const cpuBar = $('monCpuBar');
        cpuBar.style.width = Math.min(s.cpu_percent || 0, 100) + '%';
        cpuBar.className = 'mon-bar-fill ' + barColor(s.cpu_percent || 0);

        $('monMem').textContent = (s.mem_rss_mb || 0).toFixed(1) + ' MB';
        $('monMemSys').textContent = (s.sys_mem_used_gb||0).toFixed(1) + ' / ' + (s.sys_mem_total_gb||0).toFixed(1) + ' GB (' + (s.sys_mem_percent||0) + '%)';
        const memBar = $('monMemBar');
        memBar.style.width = (s.sys_mem_percent || 0) + '%';
        memBar.className = 'mon-bar-fill ' + barColor(s.sys_mem_percent || 0);

        // Disk
        $('monDisk').textContent = (s.disk_percent || 0) + '%';
        $('monDiskSub').textContent = (s.disk_used_gb||0).toFixed(1) + ' / ' + (s.disk_total_gb||0).toFixed(1) + ' GB';
        const diskBar = $('monDiskBar');
        diskBar.style.width = (s.disk_percent || 0) + '%';
        diskBar.className = 'mon-bar-fill ' + barColor(s.disk_percent || 0);

        $('monUptime').textContent = 'Uptime: ' + fmtTime(s.uptime_seconds);
        $('monPid').textContent = s.pid || 'â€”';
        $('monThreads').textContent = s.threads || 'â€”';
        $('monFiles').textContent = s.open_files || 'â€”';

        // Agents
        const ag = d.agents || {};
        $('monAgentsRegistered').textContent = ag.registered || 0;
        $('monAgentsActive').textContent = ag.active || 0;
        $('monAgentsParticipated').textContent = ag.participated || 0;
        $('monAgentsSessions').textContent = ag.sessions_with_agents || 0;

        // Messages
        const msg = d.messages || {};
        $('monMsg24h').textContent = fmt(msg.last_24h || 0);
        $('monMsgTotal').textContent = fmt(msg.total || 0);
        $('monProjects').textContent = d.projects || 0;

        // LLM
        const l = d.llm || {};
        const periodLabels = {24:'24h',168:'7d',720:'30d',8760:'1y'};
        $('monLlmPeriod').textContent = '(' + (periodLabels[currentHours] || currentHours+'h') + ')';
        $('monLlmCalls').textContent = fmt(l.total_calls || 0);
        $('monLlmIn').textContent = fmt(l.total_tokens_in || 0);
        $('monLlmOut').textContent = fmt(l.total_tokens_out || 0);
        $('monLlmCost').textContent = '$' + (l.total_cost_usd || 0).toFixed(2);
        $('monLlmLatency').textContent = l.avg_duration_ms ? Math.round(l.avg_duration_ms) + 'ms' : 'â€”';
        $('monLlmErrors').textContent = l.error_count || 0;

        // LLM hourly chart
        const chart = $('monLlmChart');
        if (l.hourly && l.hourly.length > 0) {
            const maxCalls = Math.max(...l.hourly.map(h => h.calls), 1);
            chart.innerHTML = l.hourly.map(h => {
                const pct = Math.max((h.calls / maxCalls) * 100, 2);
                return `<div class="mon-chart-bar" style="height:${pct}%" title="${h.hour}h: ${h.calls} calls, ${fmt(h.tokens)} tok, $${h.cost.toFixed(3)}"></div>`;
            }).join('');
        } else {
            chart.innerHTML = '<div class="mon-empty" style="margin:auto">No hourly data</div>';
        }

        // Providers
        const prov = $('monProviders');
        if (l.by_provider && l.by_provider.length > 0) {
            prov.innerHTML = l.by_provider.map(p =>
                `<tr><td>${p.provider}</td><td style="font-size:0.7rem">${p.model}</td><td>${p.calls}</td><td>$${(p.cost_usd||0).toFixed(3)}</td><td>${Math.round(p.avg_ms||0)}</td></tr>`
            ).join('');
        } else {
            prov.innerHTML = '<tr><td colspan="5" class="mon-empty">No LLM calls yet</td></tr>';
        }

        // Top agents
        const agentsTb = $('monTopAgents');
        if (l.by_agent && l.by_agent.length > 0) {
            agentsTb.innerHTML = l.by_agent.slice(0, 10).map(a =>
                `<tr><td>${a.agent_id}</td><td>${a.calls}</td><td>${fmt(a.tokens_out||0)}</td><td>$${(a.cost_usd||0).toFixed(3)}</td></tr>`
            ).join('');
        } else {
            agentsTb.innerHTML = '<tr><td colspan="4" class="mon-empty">No agent data yet</td></tr>';
        }

        // Missions / Sprints / Features
        badges(d.missions, $('monMissions'));
        badges(d.sprints, $('monSprints'));
        badges(d.features, $('monFeatures'));

        // Memory
        const memEl = $('monMemory');
        if (d.memory && typeof d.memory === 'object') {
            const entries = Object.entries(d.memory);
            if (entries.length > 0) {
                memEl.innerHTML = entries.map(([k,v]) => {
                    const label = k.replace(/_/g, ' ');
                    return `<div class="mon-col"><div class="label">${label}</div><div class="val">${typeof v === 'number' ? fmt(v) : (v || 'â€”')}</div></div>`;
                }).join('');
            } else {
                memEl.innerHTML = '<span class="mon-empty">No memory data</span>';
            }
        }

        // Database
        const db = d.database || {};
        $('monDbSize').textContent = db.size_mb != null ? db.size_mb.toFixed(1) + ' MB' : 'â€”';
        $('monDbTables').textContent = db.tables || 'â€”';
        $('monDbRows').textContent = fmt(db.total_rows || 0);
        $('monDbJournal').textContent = db.journal_mode || 'â€”';
        const tbEl = $('monDbTopTables');
        if (db.top_tables && db.top_tables.length > 0) {
            tbEl.innerHTML = db.top_tables.map(([name, cnt]) =>
                `<tr><td>${name}</td><td style="text-align:right">${fmt(cnt)}</td></tr>`
            ).join('');
        } else {
            tbEl.innerHTML = '<tr><td colspan="2" class="mon-empty">No tables</td></tr>';
        }

        // Vectors
        const v = d.vectors || {};
        $('monVecTotal').textContent = fmt(v.total_vectors || 0);
        $('monVecEmbedded').textContent = fmt(v.with_embedding || 0);
        $('monVecScopes').textContent = v.scopes || 0;
        $('monVecDim').textContent = v.dimension || 'â€”';
        $('monVecProvider').textContent = v.provider || 'No provider configured';
        const vecPct = v.total_vectors > 0 ? Math.round((v.with_embedding || 0) / v.total_vectors * 100) : 0;
        $('monVecBar').style.width = vecPct + '%';
        $('monVecPct').textContent = vecPct + '% embedded';

        // MCP Servers
        if (d.mcp) {
            const mcpEl = $('monMcpServers');
            const entries = Object.entries(d.mcp).filter(([k]) => k !== 'error');
            if (entries.length > 0) {
                mcpEl.innerHTML = entries.map(([name, info]) => {
                    const up = info.status === 'up' || info.status === 'ok';
                    const statusClass = up ? 'mon-dot-up' : 'mon-dot-down';
                    const port = info.port ? `:${info.port}` : '';
                    let detail = [];
                    if (info.tools) detail.push(info.tools + ' tools');
                    if (info.sessions !== undefined) detail.push(info.sessions + ' sessions');
                    if (info.entries !== undefined) detail.push(fmt(info.entries) + ' entries');
                    if (info.size_mb) detail.push(info.size_mb + ' MB');
                    return `<div class="mon-mcp-item"><span class="mon-dot ${statusClass}"></span><span class="mon-mcp-name">${name}</span><span class="mon-mcp-detail">${port}${detail.length ? ' Â· ' + detail.join(' Â· ') : ''}</span></div>`;
                }).join('');
            } else {
                mcpEl.innerHTML = '<div class="mon-empty">No MCP servers detected</div>';
            }
        }

        // HTTP Requests
        const req = d.requests || {};
        $('monReqTotal').textContent = fmt(req.total_requests || 0);
        $('monReq4xx').textContent = fmt(req.errors_4xx || 0);
        $('monReq5xx').textContent = fmt(req.errors_5xx || 0);
        $('monReqAvg').textContent = req.avg_ms ? req.avg_ms.toFixed(1) + 'ms' : 'â€”';
        const reqEndEl = $('monReqEndpoints');
        if (req.top_endpoints && req.top_endpoints.length > 0) {
            reqEndEl.innerHTML = req.top_endpoints.slice(0,10).map(ep =>
                `<tr><td style="font-size:0.7rem">${ep.endpoint}</td><td style="text-align:right">${fmt(ep.hits)}</td><td style="text-align:right">${ep.avg_ms}ms</td><td style="text-align:right;color:${ep.p95_ms > 500 ? 'var(--red, #ef4444)' : 'inherit'}">${ep.p95_ms}ms</td></tr>`
            ).join('');
        } else {
            reqEndEl.innerHTML = '<tr><td colspan="4" class="mon-empty">No requests yet</td></tr>';
        }
        const statColors = {'200':'green','201':'green','204':'green','301':'blue','302':'blue','304':'blue','400':'yellow','401':'yellow','403':'yellow','404':'yellow','500':'red','502':'red','503':'red'};
        if (req.by_status && Object.keys(req.by_status).length > 0) {
            $('monReqStatus').innerHTML = Object.entries(req.by_status).map(([code,cnt]) =>
                `<span class="mon-badge ${statColors[code]||'purple'}">${code}: ${cnt}</span>`
            ).join('');
        } else {
            $('monReqStatus').innerHTML = '<span class="mon-empty">â€”</span>';
        }

        // MCP Tool Calls
        const mcpC = d.mcp_calls || {};
        $('monMcpCallsTotal').textContent = fmt(mcpC.total_calls || 0);
        $('monMcpCallsErrors').textContent = fmt(mcpC.total_errors || 0);
        $('monMcpCallsAvg').textContent = mcpC.avg_ms ? mcpC.avg_ms.toFixed(1) + 'ms' : 'â€”';
        const mcpTb = $('monMcpCallsTable');
        const mcpHealth = (d.mcp && d.mcp.mcp_sf) ? d.mcp.mcp_sf : (d.mcp && d.mcp.mcp_platform) ? d.mcp.mcp_platform : {};
        const byTool = mcpHealth.by_tool || mcpC.by_tool || {};
        const toolEntries = Object.entries(byTool);
        if (toolEntries.length > 0) {
            mcpTb.innerHTML = toolEntries.map(([tool, info]) => {
                if (typeof info === 'object') {
                    return `<tr><td style="font-size:0.7rem">${tool}</td><td>${info.calls||0}</td><td>${info.errors||0}</td><td>${info.avg_ms ? info.avg_ms.toFixed(0) : 'â€”'}</td></tr>`;
                }
                return `<tr><td style="font-size:0.7rem">${tool}</td><td>${info}</td><td>â€”</td><td>â€”</td></tr>`;
            }).join('');
        } else {
            mcpTb.innerHTML = '<tr><td colspan="4" class="mon-empty">No MCP calls yet</td></tr>';
        }

        // LLM Costs (live)
        const costs = d.llm_costs || {};
        $('monCostTotal').textContent = '$' + (costs.total_usd || 0).toFixed(4);
        const costTb = $('monCostByProvider');
        if (costs.by_provider && Object.keys(costs.by_provider).length > 0) {
            costTb.innerHTML = Object.entries(costs.by_provider).map(([prov, info]) =>
                `<tr><td>${prov}</td><td>${info.calls||0}</td><td>${fmt((info.tokens_in||0)+(info.tokens_out||0))}</td><td>$${(info.cost_usd||0).toFixed(4)}</td></tr>`
            ).join('');
        } else {
            costTb.innerHTML = '<tr><td colspan="4" class="mon-empty">No LLM costs yet</td></tr>';
        }

        // Anonymization
        const anon = d.anonymization || {};
        $('monAnonTotal').textContent = fmt(anon.total || 0);
        if (anon.by_type && Object.keys(anon.by_type).length > 0) {
            $('monAnonByType').innerHTML = Object.entries(anon.by_type).map(([t,c]) =>
                `<span class="mon-badge purple">${t}: ${c}</span>`
            ).join('');
        } else {
            $('monAnonByType').innerHTML = '<span class="mon-empty">No anonymization data</span>';
        }
        // RLM Cache scopes from MCP data
        const rlm = d.mcp && d.mcp.rlm_cache;
        if (rlm && rlm.by_scope && Object.keys(rlm.by_scope).length > 0) {
            $('monRlmScopes').innerHTML = Object.entries(rlm.by_scope).map(([s,c]) =>
                `<span class="mon-badge blue">${s}: ${c}</span>`
            ).join('');
        } else {
            $('monRlmScopes').innerHTML = `<span class="mon-empty">${rlm ? fmt(rlm.entries||0) + ' cached' : 'No RLM cache'}</span>`;
        }

        // Incidents
        const inc = d.incidents || {};
        $('monIncOpen').textContent = inc.open || 0;
        $('monIncTotal').textContent = inc.total || 0;
        const incEl = $('monIncBadges');
        if (inc.by_severity_status && inc.by_severity_status.length > 0) {
            const sevColors = {P0:'red',P1:'red',P2:'yellow',P3:'blue',P4:'purple'};
            incEl.innerHTML = inc.by_severity_status.map(r =>
                `<span class="mon-badge ${sevColors[r.severity]||'purple'}">${r.severity} ${r.status}: ${r.cnt}</span>`
            ).join('');
        } else {
            incEl.innerHTML = '<span class="mon-empty">No incidents âœ“</span>';
        }

        // Azure Infrastructure
        const az = d.azure || {};
        const vm = az.vm || {};
        $('monAzVmName').textContent = vm.name || 'â€”';
        $('monAzVmIp').textContent = vm.ip || 'â€”';
        $('monAzVmRegion').textContent = vm.region || 'â€”';
        $('monAzVmSize').textContent = vm.size || 'â€”';

        // Azure servers
        const srvEl = $('monAzServers');
        if (az.servers && az.servers.length > 0) {
            srvEl.innerHTML = az.servers.map(s => {
                const up = s.status === 'up';
                const cls = up ? 'mon-dot-up' : (s.status === 'down' ? 'mon-dot-down' : '');
                return `<div class="mon-mcp-item"><span class="mon-dot ${cls}"></span><span class="mon-mcp-name">${s.name}</span><span class="mon-mcp-detail">:${s.port}</span></div>`;
            }).join('');
        }

        // Azure backup
        const bk = az.backup || {};
        $('monAzBackupAcct').textContent = bk.storage_account || 'â€”';
        $('monAzBackupGRS').textContent = bk.replication || 'â€”';
        $('monAzBackupDbs').textContent = bk.sqlite_dbs || 'â€”';
        if (bk.containers && bk.containers.length > 0) {
            $('monAzContainers').innerHTML = bk.containers.map(c =>
                `<span class="mon-badge blue">${c}</span>`
            ).join('');
        }
        if (bk.retention) {
            $('monAzRetention').innerHTML = Object.entries(bk.retention).map(([k,v]) =>
                `<span class="mon-badge purple">${k}: ${v}</span>`
            ).join('');
        }

        // Azure costs
        const azc = az.costs || {};
        $('monAzCostAzure').textContent = fmtUsd(azc.azure_llm_usd);
        $('monAzCostOther').textContent = fmtUsd(azc.other_llm_usd);
        $('monAzCostTotal').textContent = fmtUsd(azc.total_llm_usd);
        $('monAzCostVm').textContent = fmtUsd(azc.vm_monthly_usd);
        $('monAzCostPg').textContent = fmtUsd(azc.pg_monthly_usd);
        $('monAzCostStorage').textContent = fmtUsd(azc.storage_monthly_usd);
        $('monAzCostInfra').textContent = fmtUsd(azc.total_infra_monthly_usd);

        // Docker system info
        const ds = d.docker_system || {};
        $('monDockerVersion').textContent = ds.server_version || 'â€”';
        $('monDockerRunning').textContent = ds.containers_running ?? 'â€”';
        $('monDockerRunning').className = 'val' + ((ds.containers_running > 0) ? '' : ' mon-val-red');
        $('monDockerStopped').textContent = ds.containers_stopped ?? 'â€”';
        $('monDockerStopped').className = 'val' + ((ds.containers_stopped > 0) ? ' mon-val-yellow' : '');
        $('monDockerImages').textContent = ds.images ?? 'â€”';
        $('monDockerVolumes').textContent = ds.volumes_count ?? 'â€”';
        $('monDockerDisk').textContent = ds.total_disk_gb ? ds.total_disk_gb + ' GB' : 'â€”';
        $('monDockerImgDisk').textContent = ds.images_size_gb ? ds.images_size_gb + ' GB' : 'â€”';
        $('monDockerCtDisk').textContent = ds.containers_disk_mb != null ? ds.containers_disk_mb + ' MB' : 'â€”';
        $('monDockerVolDisk').textContent = ds.volumes_size_gb ? ds.volumes_size_gb + ' GB' : 'â€”';
        $('monDockerCacheDisk').textContent = ds.build_cache_gb ? ds.build_cache_gb + ' GB' : 'â€”';

        // Docker containers with CPU/mem
        const dockerEl = $('monDockerTable');
        if (d.docker && d.docker.length > 0) {
            dockerEl.innerHTML = d.docker.map(c => {
                const up = c.state === 'running';
                const dot = up ? 'ðŸŸ¢' : (c.state === 'exited' ? 'ðŸ”´' : 'ðŸŸ¡');
                const memPct = (c.mem_limit_mb > 0) ? Math.round(c.mem_mb / c.mem_limit_mb * 100) : 0;
                const memBar = c.mem_limit_mb > 0 ? `<div style="background:var(--bg-tertiary,#1a1730);border-radius:3px;height:4px;width:60px;margin-top:2px"><div style="background:${memPct>80?'var(--red,#ef4444)':memPct>50?'var(--yellow,#eab308)':'var(--green,#22c55e)'};height:4px;border-radius:3px;width:${Math.min(memPct,100)}%"></div></div>` : '';
                const cpuColor = c.cpu_pct > 80 ? 'var(--red,#ef4444)' : c.cpu_pct > 40 ? 'var(--yellow,#eab308)' : 'var(--green,#22c55e)';
                return `<tr>
                    <td style="font-size:0.75rem;font-weight:500">${dot} ${c.name}</td>
                    <td style="font-size:0.7rem;opacity:0.8">${c.status}${c.restarts ? ' <span style="color:var(--yellow,#eab308)">('+c.restarts+' restarts)</span>' : ''}</td>
                    <td style="font-size:0.75rem;font-weight:600;color:${cpuColor}">${up ? c.cpu_pct+'%' : 'â€”'}</td>
                    <td style="font-size:0.7rem">${up ? c.mem_mb+' MB' : 'â€”'}${memBar}</td>
                    <td style="font-size:0.65rem;opacity:0.7">${up ? 'â†“'+c.net_rx_mb+' / â†‘'+c.net_tx_mb+' MB' : 'â€”'}</td>
                    <td style="font-size:0.7rem">${up ? c.pids : 'â€”'}</td>
                    <td style="font-size:0.65rem;opacity:0.6">${c.image}</td>
                </tr>`;
            }).join('');
        } else {
            dockerEl.innerHTML = '<tr><td colspan="7" class="mon-empty">No Docker info</td></tr>';
        }

        // Git activity
        const git = d.git || {};
        $('monGitBranch').textContent = git.branch || 'â€”';
        $('monGitLastCommit').textContent = git.last_commit_time ? git.last_commit_time.substring(0, 16) : 'â€”';
        const gitEl = $('monGitCommits');
        if (git.recent_commits && git.recent_commits.length > 0) {
            gitEl.innerHTML = git.recent_commits.map(c =>
                `<tr><td style="font-family:monospace;font-size:0.7rem;color:var(--accent)">${c.hash}</td><td style="font-size:0.7rem">${c.message}</td></tr>`
            ).join('');
        } else {
            gitEl.innerHTML = '<tr><td colspan="2" class="mon-empty">No git data</td></tr>';
        }

        // Phase stats
        const phaseEl = $('monPhaseStats');
        if (d.phase_stats && d.phase_stats.length > 0) {
            const statusColors = {completed:'color:var(--green,#22c55e)',running:'color:var(--blue,#3b82f6)',failed:'color:var(--red,#ef4444)',pending:'opacity:0.6'};
            phaseEl.innerHTML = d.phase_stats.map(p =>
                `<tr><td style="font-size:0.75rem">${p.phase_name||'â€”'}</td><td style="${statusColors[p.status]||''};font-size:0.7rem">${p.status}</td><td>${p.cnt}</td><td>${p.avg_sec ? fmtTime(Math.round(p.avg_sec)) : 'â€”'}</td></tr>`
            ).join('');
        } else {
            phaseEl.innerHTML = '<tr><td colspan="4" class="mon-empty">No phase data</td></tr>';
        }

    } catch(e) {
        console.warn('Monitoring refresh error:', e);
    }
}

function setRange(hours) {
    currentHours = hours;
    document.querySelectorAll('.mon-range-btn').forEach(b => {
        b.classList.toggle('active', parseInt(b.dataset.hours) === hours);
    });
    refresh();
}
// Init active button
document.querySelector('.mon-range-btn[data-hours="24"]').classList.add('active');

refresh();
setInterval(refresh, 5000);
</script>
{% endblock %}
