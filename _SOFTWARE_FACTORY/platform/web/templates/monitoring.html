{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="/static/css/monitoring.css?v=20260221b">

<div class="mon-page" id="monRoot">
    <div class="mon-header">
        <h1>
            <svg class="icon" style="width:20px;height:20px;vertical-align:middle;margin-right:0.3rem"><use href="#icon-activity"/></svg>
            Software Factory — Monitoring
        </h1>
        <div class="mon-status">
            <span class="dot"></span>
            <span id="monUptime">—</span>
        </div>
    </div>

    <!-- Row 1: System vitals -->
    <div class="mon-grid mon-grid-4">
        <div class="mon-card">
            <h3><svg class="icon"><use href="#icon-cpu"/></svg> CPU</h3>
            <div class="mon-big" id="monCpu">—</div>
            <div class="mon-sub" id="monCpuSys">System: —</div>
            <div class="mon-bar"><div class="mon-bar-fill green" id="monCpuBar" style="width:0%"></div></div>
        </div>
        <div class="mon-card">
            <h3><svg class="icon"><use href="#icon-layers"/></svg> Memory</h3>
            <div class="mon-big" id="monMem">—</div>
            <div class="mon-sub" id="monMemSys">System: —</div>
            <div class="mon-bar"><div class="mon-bar-fill green" id="monMemBar" style="width:0%"></div></div>
        </div>
        <div class="mon-card">
            <h3><svg class="icon"><use href="#icon-users"/></svg> Agents</h3>
            <div class="mon-row">
                <div class="mon-col"><div class="label">Active</div><div class="val" id="monAgentsActive">0</div></div>
                <div class="mon-col"><div class="label">Loops</div><div class="val" id="monAgentsTotal">0</div></div>
                <div class="mon-col"><div class="label">SSE</div><div class="val" id="monSSE">0</div></div>
            </div>
        </div>
        <div class="mon-card">
            <h3><svg class="icon"><use href="#icon-message-circle"/></svg> Messages</h3>
            <div class="mon-row">
                <div class="mon-col"><div class="label">24h</div><div class="val" id="monMsg24h">0</div></div>
                <div class="mon-col"><div class="label">Total</div><div class="val" id="monMsgTotal">0</div></div>
                <div class="mon-col"><div class="label">Projects</div><div class="val" id="monProjects">—</div></div>
            </div>
        </div>
    </div>

    <!-- Row 2: LLM Usage -->
    <div class="mon-grid mon-grid-2">
        <div class="mon-card">
            <h3><svg class="icon"><use href="#icon-zap"/></svg> LLM Usage (24h)</h3>
            <div class="mon-row" style="margin-bottom:1rem">
                <div class="mon-col"><div class="label">Calls</div><div class="val" id="monLlmCalls">0</div></div>
                <div class="mon-col"><div class="label">Tokens In</div><div class="val" id="monLlmIn">0</div></div>
                <div class="mon-col"><div class="label">Tokens Out</div><div class="val" id="monLlmOut">0</div></div>
                <div class="mon-col"><div class="label">Cost</div><div class="val" id="monLlmCost">$0</div></div>
                <div class="mon-col"><div class="label">Latency</div><div class="val" id="monLlmLatency">—</div></div>
                <div class="mon-col"><div class="label">Errors</div><div class="val" id="monLlmErrors">0</div></div>
            </div>
            <div class="mon-chart" id="monLlmChart"><div class="mon-empty">No hourly data</div></div>
        </div>
        <div class="mon-card">
            <h3><svg class="icon"><use href="#icon-briefcase"/></svg> Missions & Sprints</h3>
            <div class="mon-section">
                <div class="mon-section-label">Missions</div>
                <div id="monMissions" class="mon-badges-row"><span class="mon-empty">No missions</span></div>
            </div>
            <div class="mon-section">
                <div class="mon-section-label">Sprints</div>
                <div id="monSprints" class="mon-badges-row"><span class="mon-empty">No sprints</span></div>
            </div>
            <div class="mon-section">
                <div class="mon-section-label">Features</div>
                <div id="monFeatures" class="mon-badges-row"><span class="mon-empty">No features</span></div>
            </div>
        </div>
    </div>

    <!-- Row 3: Providers + Top Agents -->
    <div class="mon-grid mon-grid-2">
        <div class="mon-card">
            <h3><svg class="icon"><use href="#icon-server"/></svg> LLM Providers</h3>
            <table class="mon-table">
                <thead><tr><th>Provider</th><th>Model</th><th>Calls</th><th>Cost</th><th>Avg ms</th></tr></thead>
                <tbody id="monProviders"><tr><td colspan="5" class="mon-empty">Loading…</td></tr></tbody>
            </table>
        </div>
        <div class="mon-card">
            <h3><svg class="icon"><use href="#icon-user"/></svg> Top Agents (by cost)</h3>
            <table class="mon-table">
                <thead><tr><th>Agent</th><th>Calls</th><th>Tokens Out</th><th>Cost</th></tr></thead>
                <tbody id="monTopAgents"><tr><td colspan="4" class="mon-empty">Loading…</td></tr></tbody>
            </table>
        </div>
    </div>

    <!-- Row 4: Database + Vector Store -->
    <div class="mon-grid mon-grid-2">
        <div class="mon-card">
            <h3><svg class="icon"><use href="#icon-database"/></svg> Database (SQLite)</h3>
            <div class="mon-row" style="margin-bottom:0.8rem">
                <div class="mon-col"><div class="label">Size</div><div class="val" id="monDbSize">—</div></div>
                <div class="mon-col"><div class="label">Tables</div><div class="val" id="monDbTables">—</div></div>
                <div class="mon-col"><div class="label">Rows</div><div class="val" id="monDbRows">—</div></div>
                <div class="mon-col"><div class="label">Journal</div><div class="val" id="monDbJournal">—</div></div>
            </div>
            <table class="mon-table">
                <thead><tr><th>Table</th><th style="text-align:right">Rows</th></tr></thead>
                <tbody id="monDbTopTables"><tr><td colspan="2" class="mon-empty">Loading…</td></tr></tbody>
            </table>
        </div>
        <div class="mon-card">
            <h3><svg class="icon"><use href="#icon-search"/></svg> Vector Store</h3>
            <div class="mon-row" style="margin-bottom:0.8rem">
                <div class="mon-col"><div class="label">Vectors</div><div class="val" id="monVecTotal">0</div></div>
                <div class="mon-col"><div class="label">Embedded</div><div class="val" id="monVecEmbedded">0</div></div>
                <div class="mon-col"><div class="label">Scopes</div><div class="val" id="monVecScopes">0</div></div>
                <div class="mon-col"><div class="label">Dim</div><div class="val" id="monVecDim">—</div></div>
            </div>
            <div class="mon-sub" id="monVecProvider">—</div>
            <div class="mon-bar" style="margin-top:0.5rem"><div class="mon-bar-fill purple" id="monVecBar" style="width:0%"></div></div>
            <div class="mon-sub" id="monVecPct" style="font-size:0.65rem;margin-top:0.2rem">0% embedded</div>
        </div>
    </div>

    <!-- Row 5: HTTP Requests + MCP Tool Calls -->
    <div class="mon-grid mon-grid-2">
        <div class="mon-card">
            <h3><svg class="icon"><use href="#icon-activity"/></svg> HTTP Requests (live)</h3>
            <div class="mon-row" style="margin-bottom:0.8rem">
                <div class="mon-col"><div class="label">Total</div><div class="val" id="monReqTotal">0</div></div>
                <div class="mon-col"><div class="label">Errors</div><div class="val mon-val-red" id="monReqErrors">0</div></div>
                <div class="mon-col"><div class="label">Avg ms</div><div class="val" id="monReqAvg">—</div></div>
            </div>
            <table class="mon-table">
                <thead><tr><th>Endpoint</th><th style="text-align:right">Hits</th></tr></thead>
                <tbody id="monReqEndpoints"><tr><td colspan="2" class="mon-empty">No requests yet</td></tr></tbody>
            </table>
            <div class="mon-section" style="margin-top:0.5rem">
                <div class="mon-section-label">Status Codes</div>
                <div id="monReqStatus" class="mon-badges-row"><span class="mon-empty">—</span></div>
            </div>
        </div>
        <div class="mon-card">
            <h3><svg class="icon"><use href="#icon-plug"/></svg> MCP Tool Calls</h3>
            <div class="mon-row" style="margin-bottom:0.8rem">
                <div class="mon-col"><div class="label">Total</div><div class="val" id="monMcpCallsTotal">0</div></div>
                <div class="mon-col"><div class="label">Errors</div><div class="val mon-val-red" id="monMcpCallsErrors">0</div></div>
                <div class="mon-col"><div class="label">Avg ms</div><div class="val" id="monMcpCallsAvg">—</div></div>
            </div>
            <table class="mon-table">
                <thead><tr><th>Tool</th><th>Calls</th><th>Errors</th><th>Avg ms</th></tr></thead>
                <tbody id="monMcpCallsTable"><tr><td colspan="4" class="mon-empty">No MCP calls yet</td></tr></tbody>
            </table>
        </div>
    </div>

    <!-- Row 6: MCP Servers + Incidents -->
    <div class="mon-grid mon-grid-2">
        <div class="mon-card">
            <h3><svg class="icon"><use href="#icon-server"/></svg> MCP Servers</h3>
            <div id="monMcpServers" class="mon-mcp-list">
                <div class="mon-empty">Loading…</div>
            </div>
        </div>
        <div class="mon-card">
            <h3><svg class="icon"><use href="#icon-alert-triangle"/></svg> Incidents</h3>
            <div class="mon-row" style="margin-bottom:0.8rem">
                <div class="mon-col"><div class="label">Open</div><div class="val mon-val-red" id="monIncOpen">0</div></div>
                <div class="mon-col"><div class="label">Total</div><div class="val" id="monIncTotal">0</div></div>
            </div>
            <div id="monIncBadges" class="mon-badges-row"><span class="mon-empty">No incidents ✓</span></div>
        </div>
    </div>

    <!-- Row 7: LLM Costs + Anonymization -->
    <div class="mon-grid mon-grid-2">
        <div class="mon-card">
            <h3><svg class="icon"><use href="#icon-zap"/></svg> LLM Costs (live session)</h3>
            <div class="mon-row" style="margin-bottom:0.8rem">
                <div class="mon-col"><div class="label">Total</div><div class="val" id="monCostTotal">$0</div></div>
            </div>
            <table class="mon-table">
                <thead><tr><th>Provider</th><th>Calls</th><th>Tokens</th><th>Cost</th></tr></thead>
                <tbody id="monCostByProvider"><tr><td colspan="4" class="mon-empty">No LLM costs yet</td></tr></tbody>
            </table>
        </div>
        <div class="mon-card">
            <h3><svg class="icon"><use href="#icon-layers"/></svg> Anonymization (RLM)</h3>
            <div class="mon-row" style="margin-bottom:0.8rem">
                <div class="mon-col"><div class="label">Total</div><div class="val" id="monAnonTotal">0</div></div>
            </div>
            <div id="monAnonByType" class="mon-badges-row"><span class="mon-empty">No anonymization data</span></div>
            <div class="mon-section" style="margin-top:0.5rem">
                <div class="mon-section-label">RLM Cache Scopes</div>
                <div id="monRlmScopes" class="mon-badges-row"><span class="mon-empty">—</span></div>
            </div>
        </div>
    </div>

    <!-- Row 8: Memory + Process -->
    <div class="mon-grid mon-grid-2">
        <div class="mon-card">
            <h3><svg class="icon"><use href="#icon-book-open"/></svg> Memory</h3>
            <div id="monMemory" class="mon-row"><span class="mon-empty">Loading…</span></div>
        </div>
        <div class="mon-card">
            <h3><svg class="icon"><use href="#icon-settings"/></svg> Process</h3>
            <div class="mon-row">
                <div class="mon-col"><div class="label">PID</div><div class="val" id="monPid">—</div></div>
                <div class="mon-col"><div class="label">Threads</div><div class="val" id="monThreads">—</div></div>
                <div class="mon-col"><div class="label">Open Files</div><div class="val" id="monFiles">—</div></div>
            </div>
        </div>
    </div>
</div>

<script>
function fmt(n) {
    if (n == null) return '—';
    if (n >= 1e6) return (n/1e6).toFixed(1) + 'M';
    if (n >= 1e3) return (n/1e3).toFixed(1) + 'K';
    return String(n);
}
function fmtTime(sec) {
    if (!sec) return '—';
    if (sec < 60) return sec + 's';
    if (sec < 3600) return Math.floor(sec/60) + 'm';
    const h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60);
    return h + 'h' + (m ? m + 'm' : '');
}
function badges(obj, el) {
    const colors = {completed:'green',done:'green',active:'blue',running:'blue',in_progress:'purple',failed:'red',pending:'yellow',backlog:'yellow',planning:'yellow',blocked:'red',review:'purple'};
    const entries = Object.entries(obj || {});
    if (entries.length === 0) {
        el.innerHTML = '<span class="mon-empty">—</span>';
        return;
    }
    el.innerHTML = entries.map(([k,v]) =>
        `<span class="mon-badge ${colors[k]||'purple'}">${k}: ${v}</span>`
    ).join('');
}
function barColor(pct) { return pct > 80 ? 'red' : pct > 60 ? 'yellow' : 'green'; }
function $(id) { return document.getElementById(id); }

async function refresh() {
    try {
        const r = await fetch('/api/monitoring/live');
        if (!r.ok) return;
        const d = await r.json();
        const s = d.system || {};

        // System
        $('monCpu').textContent = (s.cpu_percent || 0) + '%';
        $('monCpuSys').textContent = 'System: ' + (s.sys_cpu_percent || 0) + '%';
        const cpuBar = $('monCpuBar');
        cpuBar.style.width = Math.min(s.cpu_percent || 0, 100) + '%';
        cpuBar.className = 'mon-bar-fill ' + barColor(s.cpu_percent || 0);

        $('monMem').textContent = (s.mem_rss_mb || 0).toFixed(1) + ' MB';
        $('monMemSys').textContent = (s.sys_mem_used_gb||0).toFixed(1) + ' / ' + (s.sys_mem_total_gb||0).toFixed(1) + ' GB (' + (s.sys_mem_percent||0) + '%)';
        const memBar = $('monMemBar');
        memBar.style.width = (s.sys_mem_percent || 0) + '%';
        memBar.className = 'mon-bar-fill ' + barColor(s.sys_mem_percent || 0);

        $('monUptime').textContent = 'Uptime: ' + fmtTime(s.uptime_seconds);
        $('monPid').textContent = s.pid || '—';
        $('monThreads').textContent = s.threads || '—';
        $('monFiles').textContent = s.open_files || '—';

        // Agents
        const ag = d.agents || {};
        $('monAgentsActive').textContent = ag.active || 0;
        $('monAgentsTotal').textContent = ag.total || 0;
        $('monSSE').textContent = d.sse_connections || 0;

        // Messages
        const msg = d.messages || {};
        $('monMsg24h').textContent = fmt(msg.last_24h || 0);
        $('monMsgTotal').textContent = fmt(msg.total || 0);
        $('monProjects').textContent = d.projects || 0;

        // LLM
        const l = d.llm || {};
        $('monLlmCalls').textContent = fmt(l.total_calls || 0);
        $('monLlmIn').textContent = fmt(l.total_tokens_in || 0);
        $('monLlmOut').textContent = fmt(l.total_tokens_out || 0);
        $('monLlmCost').textContent = '$' + (l.total_cost_usd || 0).toFixed(2);
        $('monLlmLatency').textContent = l.avg_duration_ms ? Math.round(l.avg_duration_ms) + 'ms' : '—';
        $('monLlmErrors').textContent = l.error_count || 0;

        // LLM hourly chart
        const chart = $('monLlmChart');
        if (l.hourly && l.hourly.length > 0) {
            const maxCalls = Math.max(...l.hourly.map(h => h.calls), 1);
            chart.innerHTML = l.hourly.map(h => {
                const pct = Math.max((h.calls / maxCalls) * 100, 2);
                return `<div class="mon-chart-bar" style="height:${pct}%" title="${h.hour}h: ${h.calls} calls, ${fmt(h.tokens)} tok, $${h.cost.toFixed(3)}"></div>`;
            }).join('');
        } else {
            chart.innerHTML = '<div class="mon-empty" style="margin:auto">No hourly data</div>';
        }

        // Providers
        const prov = $('monProviders');
        if (l.by_provider && l.by_provider.length > 0) {
            prov.innerHTML = l.by_provider.map(p =>
                `<tr><td>${p.provider}</td><td style="font-size:0.7rem">${p.model}</td><td>${p.calls}</td><td>$${(p.cost_usd||0).toFixed(3)}</td><td>${Math.round(p.avg_ms||0)}</td></tr>`
            ).join('');
        } else {
            prov.innerHTML = '<tr><td colspan="5" class="mon-empty">No LLM calls yet</td></tr>';
        }

        // Top agents
        const agentsTb = $('monTopAgents');
        if (l.by_agent && l.by_agent.length > 0) {
            agentsTb.innerHTML = l.by_agent.slice(0, 10).map(a =>
                `<tr><td>${a.agent_id}</td><td>${a.calls}</td><td>${fmt(a.tokens_out||0)}</td><td>$${(a.cost_usd||0).toFixed(3)}</td></tr>`
            ).join('');
        } else {
            agentsTb.innerHTML = '<tr><td colspan="4" class="mon-empty">No agent data yet</td></tr>';
        }

        // Missions / Sprints / Features
        badges(d.missions, $('monMissions'));
        badges(d.sprints, $('monSprints'));
        badges(d.features, $('monFeatures'));

        // Memory
        const memEl = $('monMemory');
        if (d.memory && typeof d.memory === 'object') {
            const entries = Object.entries(d.memory);
            if (entries.length > 0) {
                memEl.innerHTML = entries.map(([k,v]) => {
                    const label = k.replace(/_/g, ' ');
                    return `<div class="mon-col"><div class="label">${label}</div><div class="val">${typeof v === 'number' ? fmt(v) : (v || '—')}</div></div>`;
                }).join('');
            } else {
                memEl.innerHTML = '<span class="mon-empty">No memory data</span>';
            }
        }

        // Database
        const db = d.database || {};
        $('monDbSize').textContent = db.size_mb != null ? db.size_mb.toFixed(1) + ' MB' : '—';
        $('monDbTables').textContent = db.tables || '—';
        $('monDbRows').textContent = fmt(db.total_rows || 0);
        $('monDbJournal').textContent = db.journal_mode || '—';
        const tbEl = $('monDbTopTables');
        if (db.top_tables && db.top_tables.length > 0) {
            tbEl.innerHTML = db.top_tables.map(([name, cnt]) =>
                `<tr><td>${name}</td><td style="text-align:right">${fmt(cnt)}</td></tr>`
            ).join('');
        } else {
            tbEl.innerHTML = '<tr><td colspan="2" class="mon-empty">No tables</td></tr>';
        }

        // Vectors
        const v = d.vectors || {};
        $('monVecTotal').textContent = fmt(v.total_vectors || 0);
        $('monVecEmbedded').textContent = fmt(v.with_embedding || 0);
        $('monVecScopes').textContent = v.scopes || 0;
        $('monVecDim').textContent = v.dimension || '—';
        $('monVecProvider').textContent = v.provider || 'No provider configured';
        const vecPct = v.total_vectors > 0 ? Math.round((v.with_embedding || 0) / v.total_vectors * 100) : 0;
        $('monVecBar').style.width = vecPct + '%';
        $('monVecPct').textContent = vecPct + '% embedded';

        // MCP Servers
        if (d.mcp) {
            const mcpEl = $('monMcpServers');
            const entries = Object.entries(d.mcp).filter(([k]) => k !== 'error');
            if (entries.length > 0) {
                mcpEl.innerHTML = entries.map(([name, info]) => {
                    const up = info.status === 'up' || info.status === 'ok';
                    const statusClass = up ? 'mon-dot-up' : 'mon-dot-down';
                    const port = info.port ? `:${info.port}` : '';
                    let detail = [];
                    if (info.tools) detail.push(info.tools + ' tools');
                    if (info.sessions !== undefined) detail.push(info.sessions + ' sessions');
                    if (info.entries !== undefined) detail.push(fmt(info.entries) + ' entries');
                    if (info.size_mb) detail.push(info.size_mb + ' MB');
                    return `<div class="mon-mcp-item"><span class="mon-dot ${statusClass}"></span><span class="mon-mcp-name">${name}</span><span class="mon-mcp-detail">${port}${detail.length ? ' · ' + detail.join(' · ') : ''}</span></div>`;
                }).join('');
            } else {
                mcpEl.innerHTML = '<div class="mon-empty">No MCP servers detected</div>';
            }
        }

        // HTTP Requests
        const req = d.requests || {};
        $('monReqTotal').textContent = fmt(req.total_requests || 0);
        $('monReqErrors').textContent = fmt(req.total_errors || 0);
        $('monReqAvg').textContent = req.avg_ms ? req.avg_ms.toFixed(1) + 'ms' : '—';
        const reqEndEl = $('monReqEndpoints');
        if (req.top_endpoints && req.top_endpoints.length > 0) {
            reqEndEl.innerHTML = req.top_endpoints.slice(0,8).map(([ep, cnt]) =>
                `<tr><td style="font-size:0.7rem">${ep}</td><td style="text-align:right">${fmt(cnt)}</td></tr>`
            ).join('');
        } else {
            reqEndEl.innerHTML = '<tr><td colspan="2" class="mon-empty">No requests yet</td></tr>';
        }
        const statColors = {'200':'green','201':'green','204':'green','301':'blue','302':'blue','304':'blue','400':'yellow','401':'yellow','403':'yellow','404':'yellow','500':'red','502':'red','503':'red'};
        if (req.by_status && Object.keys(req.by_status).length > 0) {
            $('monReqStatus').innerHTML = Object.entries(req.by_status).map(([code,cnt]) =>
                `<span class="mon-badge ${statColors[code]||'purple'}">${code}: ${cnt}</span>`
            ).join('');
        } else {
            $('monReqStatus').innerHTML = '<span class="mon-empty">—</span>';
        }

        // MCP Tool Calls
        const mcpC = d.mcp_calls || {};
        $('monMcpCallsTotal').textContent = fmt(mcpC.total_calls || 0);
        $('monMcpCallsErrors').textContent = fmt(mcpC.total_errors || 0);
        $('monMcpCallsAvg').textContent = mcpC.avg_ms ? mcpC.avg_ms.toFixed(1) + 'ms' : '—';
        const mcpTb = $('monMcpCallsTable');
        const mcpHealth = (d.mcp && d.mcp.mcp_platform) ? d.mcp.mcp_platform : {};
        const byTool = mcpHealth.by_tool || mcpC.by_tool || {};
        const toolEntries = Object.entries(byTool);
        if (toolEntries.length > 0) {
            mcpTb.innerHTML = toolEntries.map(([tool, info]) => {
                if (typeof info === 'object') {
                    return `<tr><td style="font-size:0.7rem">${tool}</td><td>${info.calls||0}</td><td>${info.errors||0}</td><td>${info.avg_ms ? info.avg_ms.toFixed(0) : '—'}</td></tr>`;
                }
                return `<tr><td style="font-size:0.7rem">${tool}</td><td>${info}</td><td>—</td><td>—</td></tr>`;
            }).join('');
        } else {
            mcpTb.innerHTML = '<tr><td colspan="4" class="mon-empty">No MCP calls yet</td></tr>';
        }

        // LLM Costs (live)
        const costs = d.llm_costs || {};
        $('monCostTotal').textContent = '$' + (costs.total_usd || 0).toFixed(4);
        const costTb = $('monCostByProvider');
        if (costs.by_provider && Object.keys(costs.by_provider).length > 0) {
            costTb.innerHTML = Object.entries(costs.by_provider).map(([prov, info]) =>
                `<tr><td>${prov}</td><td>${info.calls||0}</td><td>${fmt((info.tokens_in||0)+(info.tokens_out||0))}</td><td>$${(info.cost_usd||0).toFixed(4)}</td></tr>`
            ).join('');
        } else {
            costTb.innerHTML = '<tr><td colspan="4" class="mon-empty">No LLM costs yet</td></tr>';
        }

        // Anonymization
        const anon = d.anonymization || {};
        $('monAnonTotal').textContent = fmt(anon.total || 0);
        if (anon.by_type && Object.keys(anon.by_type).length > 0) {
            $('monAnonByType').innerHTML = Object.entries(anon.by_type).map(([t,c]) =>
                `<span class="mon-badge purple">${t}: ${c}</span>`
            ).join('');
        } else {
            $('monAnonByType').innerHTML = '<span class="mon-empty">No anonymization data</span>';
        }
        // RLM Cache scopes from MCP data
        const rlm = d.mcp && d.mcp.rlm_cache;
        if (rlm && rlm.by_scope && Object.keys(rlm.by_scope).length > 0) {
            $('monRlmScopes').innerHTML = Object.entries(rlm.by_scope).map(([s,c]) =>
                `<span class="mon-badge blue">${s}: ${c}</span>`
            ).join('');
        } else {
            $('monRlmScopes').innerHTML = `<span class="mon-empty">${rlm ? fmt(rlm.entries||0) + ' cached' : 'No RLM cache'}</span>`;
        }

        // Incidents
        const inc = d.incidents || {};
        $('monIncOpen').textContent = inc.open || 0;
        $('monIncTotal').textContent = inc.total || 0;
        const incEl = $('monIncBadges');
        if (inc.by_severity_status && inc.by_severity_status.length > 0) {
            const sevColors = {P0:'red',P1:'red',P2:'yellow',P3:'blue',P4:'purple'};
            incEl.innerHTML = inc.by_severity_status.map(r =>
                `<span class="mon-badge ${sevColors[r.severity]||'purple'}">${r.severity} ${r.status}: ${r.cnt}</span>`
            ).join('');
        } else {
            incEl.innerHTML = '<span class="mon-empty">No incidents ✓</span>';
        }
    } catch(e) {
        console.warn('Monitoring refresh error:', e);
    }
}

refresh();
setInterval(refresh, 5000);
</script>
{% endblock %}
