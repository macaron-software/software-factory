{% extends "base.html" %}

{% block topbar_actions %}
{% endblock %}

{% block content %}
<style>
/* ── Ideation Workspace ── */
.idea-layout{display:grid;grid-template-columns:1fr 340px;gap:1rem;height:calc(100vh - 70px);padding:0.5rem 0}
@media(max-width:900px){.idea-layout{grid-template-columns:1fr;grid-template-rows:1fr auto}}

/* Chat area */
.idea-chat{display:flex;flex-direction:column;background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.idea-messages{flex:1;overflow-y:auto;padding:1rem;display:flex;flex-direction:column;gap:0.75rem}

.idea-msg{display:flex;gap:0.6rem;max-width:85%}
.idea-msg.user{align-self:flex-end;flex-direction:row-reverse}
.idea-msg-avatar{width:32px;height:32px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:0.75rem;font-weight:700}
.idea-msg-avatar img{width:32px;height:32px;border-radius:50%;object-fit:cover}
.idea-msg-bubble{padding:0.6rem 0.85rem;border-radius:10px;font-size:0.82rem;line-height:1.5}
.idea-msg.agent .idea-msg-bubble{background:var(--bg-tertiary);border:1px solid var(--border);color:var(--text-primary)}
.idea-msg.user .idea-msg-bubble{background:var(--user-bubble);border:1px solid var(--user-bubble-border);color:var(--text-primary)}
.idea-msg-name{font-size:0.68rem;font-weight:600;margin-bottom:0.2rem;color:var(--text-secondary)}
.idea-msg-content{white-space:pre-wrap;word-break:break-word}
.idea-msg-content strong{color:var(--purple)}
.idea-msg-time{font-size:0.62rem;color:var(--text-secondary);margin-top:0.2rem}

/* Placeholder */
.idea-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--text-secondary);gap:0.75rem;text-align:center;padding:2rem}
.idea-empty svg{width:48px;height:48px;opacity:.25}
.idea-empty-title{font-size:1rem;font-weight:600;color:var(--text-primary)}
.idea-empty-subtitle{font-size:0.82rem;max-width:400px;line-height:1.5}

/* Examples */
.idea-examples{display:flex;gap:0.5rem;flex-wrap:wrap;justify-content:center;margin-top:0.5rem}
.idea-example{padding:0.35rem 0.65rem;border:1px solid var(--border);border-radius:6px;font-size:0.75rem;cursor:pointer;color:var(--text-secondary);transition:all .15s;background:var(--bg-tertiary)}
.idea-example:hover{border-color:var(--purple);color:var(--purple)}

/* Input bar */
.idea-input-bar{display:flex;gap:0.5rem;padding:0.65rem;border-top:1px solid var(--border);background:var(--bg-tertiary)}
.idea-input{flex:1;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;padding:0.55rem 0.75rem;color:var(--text-primary);font-size:0.85rem;outline:none;resize:none;min-height:40px;max-height:120px;font-family:inherit}
.idea-input:focus{border-color:var(--purple)}
.idea-send{width:40px;height:40px;border-radius:8px;border:none;background:var(--purple);color:white;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:opacity .15s;flex-shrink:0}
.idea-send:hover{opacity:.85}
.idea-send:disabled{opacity:.4;cursor:not-allowed}
.idea-send svg{width:18px;height:18px}

/* Right panel — agents + output */
.idea-panel{display:flex;flex-direction:column;gap:0.75rem;overflow-y:auto}

/* Agent roster */
.idea-agents{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);padding:0.6rem}
.idea-agents-title{font-size:0.72rem;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.5px;margin-bottom:0.5rem;display:flex;align-items:center;gap:0.4rem}
.idea-agents-title svg{width:14px;height:14px}
.idea-agent-row{display:flex;align-items:center;gap:0.5rem;padding:0.35rem 0;border-bottom:1px solid rgba(255,255,255,.04)}
.idea-agent-row:last-child{border-bottom:none}
.idea-agent-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.idea-agent-dot.idle{background:#6b7280}
.idea-agent-dot.thinking{background:var(--yellow);animation:pulse 1.5s infinite}
.idea-agent-dot.speaking{background:var(--green)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.idea-agent-label{font-size:0.78rem;flex:1}
.idea-agent-role{font-size:0.68rem;color:var(--text-secondary)}

/* Structured output cards */
.idea-output{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);padding:0.6rem}
.idea-output-title{font-size:0.72rem;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.5px;margin-bottom:0.5rem;display:flex;align-items:center;gap:0.4rem}
.idea-output-title svg{width:14px;height:14px}
.idea-output-empty{font-size:0.78rem;color:var(--text-secondary);font-style:italic;padding:0.5rem 0}

.idea-finding{padding:0.45rem 0.6rem;margin-bottom:0.4rem;border-radius:6px;border:1px solid var(--border);font-size:0.78rem}
.idea-finding-type{font-size:0.65rem;text-transform:uppercase;font-weight:700;letter-spacing:.5px;margin-bottom:0.15rem}
.idea-finding-type.opportunity{color:var(--green)}
.idea-finding-type.risk{color:var(--red)}
.idea-finding-type.question{color:var(--yellow)}
.idea-finding-type.decision{color:var(--purple)}
.idea-finding-type.feature{color:var(--blue)}
.idea-finding-text{color:var(--text-primary);line-height:1.4}

.section-title{font-size:0.82rem;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:1px;margin-bottom:0.75rem;display:flex;align-items:center;gap:0.5rem}
.section-title svg{width:16px;height:16px}
</style>

<div class="idea-layout">

    <!-- Chat area -->
    <div class="idea-chat">
        <div class="idea-messages" id="ideaMessages">
            <div class="idea-empty" id="ideaPlaceholder">
                <svg><use href="#icon-compass"/></svg>
                <div class="idea-empty-title">Atelier Idéation</div>
                <div class="idea-empty-subtitle">
                    Soumettez une idée, un concept produit ou un besoin métier. Les agents vont challenger, enrichir et structurer la proposition.
                </div>
                <div class="idea-examples">
                    <button class="idea-example" onclick="setPrompt(this.textContent)">App de covoiturage pour La Poste</button>
                    <button class="idea-example" onclick="setPrompt(this.textContent)">Plateforme de suivi IoT pour vélos</button>
                    <button class="idea-example" onclick="setPrompt(this.textContent)">Migration Angular 16 vers 19</button>
                    <button class="idea-example" onclick="setPrompt(this.textContent)">Chatbot IA pour le support client</button>
                </div>
            </div>
        </div>

        <div class="idea-input-bar">
            <textarea class="idea-input" id="ideaInput" rows="1"
                placeholder="Décrivez votre idée, concept ou besoin métier..."
                onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendIdea()}"></textarea>
            <button class="idea-send" id="ideaSend" onclick="sendIdea()">
                <svg><use href="#icon-send"/></svg>
            </button>
        </div>
    </div>

    <!-- Right panel -->
    <div class="idea-panel">

        <!-- Agent roster -->
        <div class="idea-agents">
            <div class="idea-agents-title">
                <svg><use href="#icon-users"/></svg> Agents Mobilisés
            </div>
            {% for a in agents %}
            <div class="idea-agent-row" id="agent-{{ a.id }}">
                <span class="idea-agent-dot idle" id="dot-{{ a.id }}"></span>
                <span class="idea-agent-label">{{ a.name }}</span>
                <span class="idea-agent-role">{{ a.short_role }}</span>
            </div>
            {% endfor %}
        </div>

        <!-- Structured findings -->
        <div class="idea-output">
            <div class="idea-output-title">
                <svg><use href="#icon-target"/></svg> Synthèse
            </div>
            <div id="ideaFindings">
                <div class="idea-output-empty">Lancez une idée pour voir les analyses apparaître ici.</div>
            </div>
        </div>

        <!-- Actions -->
        <div class="idea-output">
            <div class="idea-output-title">
                <svg><use href="#icon-lightning"/></svg> Actions
            </div>
            <div id="ideaActions" style="display:flex;flex-direction:column;gap:0.4rem">
                <button class="pm-filter" style="width:100%;text-align:left;opacity:.5;pointer-events:none" id="btnCreateEpic">
                    <svg class="icon icon-xs" style="vertical-align:-2px"><use href="#icon-rocket"/></svg>
                    Créer un Epic depuis cette idée
                </button>
                <button class="pm-filter" style="width:100%;text-align:left;opacity:.5;pointer-events:none" id="btnGenerateTeam">
                    <svg class="icon icon-xs" style="vertical-align:-2px"><use href="#icon-users"/></svg>
                    Générer l'équipe
                </button>
            </div>
        </div>
    </div>
</div>

<script>
const messagesEl = document.getElementById('ideaMessages');
const inputEl = document.getElementById('ideaInput');
const sendBtn = document.getElementById('ideaSend');
const placeholder = document.getElementById('ideaPlaceholder');
const findingsEl = document.getElementById('ideaFindings');
let sessionId = '';

function setPrompt(text) {
    inputEl.value = text;
    inputEl.focus();
}

function addMsg(agent, name, content, color, avatarUrl) {
    if (placeholder) placeholder.style.display = 'none';
    const isUser = agent === 'user';
    const div = document.createElement('div');
    div.className = 'idea-msg ' + (isUser ? 'user' : 'agent');

    const avatarHtml = avatarUrl
        ? `<img src="${avatarUrl}" alt="${name}">`
        : name.charAt(0);
    const bgColor = isUser ? 'var(--user-bubble)' : (color || 'var(--bg-tertiary)');

    div.innerHTML = `
        <div class="idea-msg-avatar" style="background:${bgColor}20;border:2px solid ${bgColor}">${avatarHtml}</div>
        <div>
            <div class="idea-msg-name">${name}</div>
            <div class="idea-msg-bubble ${isUser ? '' : 'agent'}">
                <div class="idea-msg-content">${content}</div>
            </div>
        </div>
    `;
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
}

function addFinding(type, text) {
    const empty = findingsEl.querySelector('.idea-output-empty');
    if (empty) empty.remove();
    const div = document.createElement('div');
    div.className = 'idea-finding';
    div.innerHTML = `<div class="idea-finding-type ${type}">${type}</div><div class="idea-finding-text">${text}</div>`;
    findingsEl.appendChild(div);
}

function setAgentStatus(agentId, status) {
    const dot = document.getElementById('dot-' + agentId);
    if (dot) { dot.className = 'idea-agent-dot ' + status; }
}

async function sendIdea() {
    const text = inputEl.value.trim();
    if (!text) return;
    inputEl.value = '';
    sendBtn.disabled = true;

    addMsg('user', 'Vous', text, '', '');
    originalPrompt = originalPrompt || text;

    try {
        const resp = await fetch('/api/ideation', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({prompt: text, session_id: sessionId}),
        });
        const data = await resp.json();
        if (data.error) {
            addMsg('system', 'Système', data.error, 'var(--red)', '');
        } else {
            sessionId = data.session_id || sessionId;
            for (const msg of (data.messages || [])) {
                addMsg('agent', msg.agent_name, msg.content, msg.color || '', msg.avatar_url || '');
                if (msg.agent_id) setAgentStatus(msg.agent_id, 'speaking');
            }
            for (const f of (data.findings || [])) {
                addFinding(f.type, f.text);
            }
            // Enable action buttons
            document.getElementById('btnCreateEpic').style.opacity = '1';
            document.getElementById('btnCreateEpic').style.pointerEvents = 'auto';
            document.getElementById('btnGenerateTeam').style.opacity = '1';
            document.getElementById('btnGenerateTeam').style.pointerEvents = 'auto';
        }
    } catch (e) {
        addMsg('system', 'Système', 'Erreur de connexion: ' + e.message, 'var(--red)', '');
    }
    sendBtn.disabled = false;
    // Reset agent dots
    document.querySelectorAll('.idea-agent-dot').forEach(d => d.className = 'idea-agent-dot idle');
}

// Collect findings from the panel
function collectFindings() {
    const items = document.querySelectorAll('.idea-finding');
    return Array.from(items).map(el => {
        const type = el.querySelector('.idea-finding-type')?.textContent?.trim() || '';
        const text = el.querySelector('.idea-finding-text')?.textContent?.trim() || '';
        return {type, text};
    });
}

// Collect the original prompt
let originalPrompt = '';

// Create epic from idea
document.getElementById('btnCreateEpic').addEventListener('click', async () => {
    if (!sessionId && !originalPrompt) return;
    addMsg('system', 'Système', 'Création de l\'epic en cours...', 'var(--purple)', '');
    const findings = collectFindings();
    const description = findings.map(f => `[${f.type.toUpperCase()}] ${f.text}`).join('\n');
    try {
        const resp = await fetch('/api/ideation/create-epic', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                session_id: sessionId,
                name: originalPrompt.substring(0, 100) || 'Epic from ideation',
                description: description,
                goal: originalPrompt,
            }),
        });
        const data = await resp.json();
        if (data.mission_id) {
            addMsg('system', 'Système',
                `Epic créé ! Redirection vers <a href="/missions/${data.mission_id}" style="color:var(--purple)">${data.name}</a>...`,
                'var(--green)', '');
            setTimeout(() => { window.location.href = `/missions/${data.mission_id}`; }, 1500);
        }
    } catch(e) {
        addMsg('system', 'Système', 'Erreur: ' + e.message, 'var(--red)', '');
    }
});

// Generate team — pass the prompt as context
document.getElementById('btnGenerateTeam').addEventListener('click', () => {
    const prompt = encodeURIComponent(originalPrompt || '');
    window.location.href = '/generate' + (prompt ? '?prompt=' + prompt : '');
});

// Auto-resize textarea
inputEl.addEventListener('input', () => {
    inputEl.style.height = 'auto';
    inputEl.style.height = Math.min(inputEl.scrollHeight, 120) + 'px';
});
</script>
{% endblock %}
