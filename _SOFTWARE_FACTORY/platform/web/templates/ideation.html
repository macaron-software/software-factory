{% extends "base.html" %}

{% block topbar_actions %}
{% endblock %}

{% block content %}
<style>
/* ── Ideation Workspace ── */
.idea-layout{display:grid;grid-template-columns:1fr 340px;gap:1rem;height:calc(100vh - 70px);padding:0.5rem 0}
@media(max-width:900px){.idea-layout{grid-template-columns:1fr;grid-template-rows:1fr auto}}

/* Chat area */
.idea-chat{display:flex;flex-direction:column;background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.idea-messages{flex:1;overflow-y:auto;padding:1rem;display:flex;flex-direction:column;gap:0.75rem}

.idea-msg{display:flex;gap:0.6rem;max-width:85%}
.idea-msg.user{align-self:flex-end;flex-direction:row-reverse}
.idea-msg-avatar{width:32px;height:32px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:0.75rem;font-weight:700}
.idea-msg-avatar img{width:32px;height:32px;border-radius:50%;object-fit:cover}
.idea-msg-bubble{padding:0.6rem 0.85rem;border-radius:10px;font-size:0.82rem;line-height:1.5}
.idea-msg.agent .idea-msg-bubble{background:var(--bg-tertiary);border:1px solid var(--border);color:var(--text-primary)}
.idea-msg.user .idea-msg-bubble{background:var(--user-bubble);border:1px solid var(--user-bubble-border);color:var(--text-primary)}
.idea-msg-name{font-size:0.68rem;font-weight:600;margin-bottom:0.2rem;color:var(--text-secondary)}
.idea-msg-content{white-space:pre-wrap;word-break:break-word}
.idea-msg-content strong{color:var(--purple)}
.idea-msg-time{font-size:0.62rem;color:var(--text-secondary);margin-top:0.2rem}

/* Placeholder */
.idea-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--text-secondary);gap:0.75rem;text-align:center;padding:2rem}
.idea-empty svg{width:48px;height:48px;opacity:.25}
.idea-empty-title{font-size:1rem;font-weight:600;color:var(--text-primary)}
.idea-empty-subtitle{font-size:0.82rem;max-width:400px;line-height:1.5}

/* Examples */
.idea-examples{display:flex;gap:0.5rem;flex-wrap:wrap;justify-content:center;margin-top:0.5rem}
.idea-example{padding:0.35rem 0.65rem;border:1px solid var(--border);border-radius:6px;font-size:0.75rem;cursor:pointer;color:var(--text-secondary);transition:all .15s;background:var(--bg-tertiary)}
.idea-example:hover{border-color:var(--purple);color:var(--purple)}

/* Input bar */
.idea-input-bar{display:flex;gap:0.5rem;padding:0.65rem;border-top:1px solid var(--border);background:var(--bg-tertiary)}
.idea-input{flex:1;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;padding:0.55rem 0.75rem;color:var(--text-primary);font-size:0.85rem;outline:none;resize:none;min-height:40px;max-height:120px;font-family:inherit}
.idea-input:focus{border-color:var(--purple)}
.idea-send{width:40px;height:40px;border-radius:8px;border:none;background:var(--purple);color:white;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:opacity .15s;flex-shrink:0}
.idea-send:hover{opacity:.85}
.idea-send:disabled{opacity:.4;cursor:not-allowed}
.idea-send svg{width:18px;height:18px}

/* Right panel — agents + output */
.idea-panel{display:flex;flex-direction:column;gap:0.75rem;overflow-y:auto}

/* Agent roster */
.idea-agents{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);padding:0.6rem}
.idea-agents-title{font-size:0.72rem;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.5px;margin-bottom:0.5rem;display:flex;align-items:center;gap:0.4rem}
.idea-agents-title svg{width:14px;height:14px}
.idea-agent-row{display:flex;align-items:center;gap:0.5rem;padding:0.35rem 0;border-bottom:1px solid rgba(255,255,255,.04)}
.idea-agent-row:last-child{border-bottom:none}
.idea-agent-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.idea-agent-dot.idle{background:#6b7280}
.idea-agent-dot.thinking{background:var(--yellow);animation:pulse 1.5s infinite}
.idea-agent-dot.speaking{background:var(--green)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.idea-agent-label{font-size:0.78rem;flex:1}
.idea-agent-role{font-size:0.68rem;color:var(--text-secondary)}

/* Structured output cards */
.idea-output{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);padding:0.6rem}
.idea-output-title{font-size:0.72rem;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.5px;margin-bottom:0.5rem;display:flex;align-items:center;gap:0.4rem}
.idea-output-title svg{width:14px;height:14px}
.idea-output-empty{font-size:0.78rem;color:var(--text-secondary);font-style:italic;padding:0.5rem 0}

.idea-finding{padding:0.45rem 0.6rem;margin-bottom:0.4rem;border-radius:6px;border:1px solid var(--border);font-size:0.78rem}
.idea-finding-type{font-size:0.65rem;text-transform:uppercase;font-weight:700;letter-spacing:.5px;margin-bottom:0.15rem}
.idea-finding-type.opportunity{color:var(--green)}
.idea-finding-type.risk{color:var(--red)}
.idea-finding-type.question{color:var(--yellow)}
.idea-finding-type.decision{color:var(--purple)}
.idea-finding-type.feature{color:var(--blue)}
.idea-finding-text{color:var(--text-primary);line-height:1.4}

.section-title{font-size:0.82rem;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:1px;margin-bottom:0.75rem;display:flex;align-items:center;gap:0.5rem}
.section-title svg{width:16px;height:16px}

/* ── Ideation Graph ── */
.idea-graph{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.idea-graph-header{display:flex;align-items:center;justify-content:space-between;padding:0.5rem 0.6rem;cursor:pointer;user-select:none}
.idea-graph-header:hover{background:var(--bg-tertiary)}
.idea-graph-title{font-size:0.72rem;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.5px;display:flex;align-items:center;gap:0.4rem}
.idea-graph-title svg{width:14px;height:14px}
.idea-graph-toggle{width:16px;height:16px;color:var(--text-secondary);transition:transform .2s}
.idea-graph-toggle.open{transform:rotate(180deg)}
.idea-graph-canvas{height:320px;position:relative;overflow:hidden;cursor:grab;background:var(--bg-primary);border-top:1px solid var(--border)}
.idea-graph-canvas.panning{cursor:grabbing}
.idea-graph-canvas svg{width:100%;height:100%}
.idea-graph-legend{display:flex;gap:0.75rem;padding:0.35rem 0.6rem;border-top:1px solid var(--border);flex-wrap:wrap}
.idea-graph-legend-item{display:flex;align-items:center;gap:0.3rem;font-size:0.65rem;color:var(--text-secondary)}
/* Nodes */
.ig-node{cursor:pointer}
.ig-node:hover .ig-node-bg{filter:brightness(1.15)}
.ig-node-bg{fill:var(--bg-secondary);stroke:var(--border);stroke-width:1;rx:8;ry:8}
.ig-node-bar{stroke-linecap:round}
.ig-node-name{font-size:11px;fill:var(--text-primary);font-weight:600}
.ig-node-role{font-size:9px;fill:var(--text-secondary)}
.ig-node-dot{r:4}
/* Edges */
.ig-edge{fill:none;stroke-width:1.8;opacity:0.6}
.ig-edge.active{opacity:1;stroke-width:2.5;filter:drop-shadow(0 0 4px currentColor)}
.ig-edge-label{font-size:8px;fill:var(--text-secondary);text-anchor:middle}
/* Node active state */
.ig-node.active .ig-node-bg{filter:brightness(1.3);stroke:var(--purple);stroke-width:2}
.ig-node.active .ig-node-dot{r:6;filter:drop-shadow(0 0 6px currentColor)}
@keyframes igPulse{0%,100%{opacity:1}50%{opacity:.3}}
.ig-node.thinking .ig-node-dot{animation:igPulse 1s infinite;fill:var(--yellow) !important}
/* Edge flow animation */
@keyframes igFlowDash{to{stroke-dashoffset:-20}}
.ig-edge.flowing{animation:igFlowDash .8s linear infinite;stroke-dasharray:6 4;opacity:1;stroke-width:2.5}
/* Popover */
.ig-popover-overlay{position:fixed;inset:0;z-index:500;background:rgba(0,0,0,.3);display:none}
.ig-popover-overlay.visible{display:block}
.ig-popover{position:fixed;z-index:501;width:320px;max-height:70vh;background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 12px 40px rgba(0,0,0,.4);overflow-y:auto;display:none}
.ig-popover.visible{display:block}
.ig-popover-header{display:flex;align-items:center;gap:0.6rem;padding:0.75rem;border-bottom:1px solid var(--border)}
.ig-popover-avatar{width:40px;height:40px;border-radius:50%;flex-shrink:0;object-fit:cover}
.ig-popover-avatar-fallback{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1rem;color:#fff;flex-shrink:0}
.ig-popover-info{flex:1;min-width:0}
.ig-popover-name{font-size:0.88rem;font-weight:700;color:var(--text-primary)}
.ig-popover-role{font-size:0.72rem;color:var(--text-secondary)}
.ig-popover-close{background:none;border:none;color:var(--text-secondary);cursor:pointer;padding:0.25rem}
.ig-popover-close:hover{color:var(--text-primary)}
.ig-popover-body{padding:0.6rem 0.75rem;display:flex;flex-direction:column;gap:0.5rem}
.ig-popover-section-title{font-size:0.68rem;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.4px;display:flex;align-items:center;gap:0.3rem;margin-bottom:0.2rem}
.ig-popover-section-title svg{width:12px;height:12px}
.ig-popover-text{font-size:0.78rem;color:var(--text-primary);line-height:1.5;white-space:pre-line}
.ig-popover-tags{display:flex;flex-wrap:wrap;gap:0.3rem}
.ig-popover-tag{font-size:0.68rem;padding:0.15rem 0.4rem;border-radius:4px;background:var(--bg-tertiary);border:1px solid var(--border);color:var(--text-secondary)}
.ig-popover-tag.skill{border-color:rgba(139,92,246,.3);color:#a78bfa}
.ig-popover-tag.tool{border-color:rgba(16,185,129,.3);color:#34d399}
</style>

<div class="idea-layout">

    <!-- Chat area -->
    <div class="idea-chat">
        <div class="idea-messages" id="ideaMessages">
            <div class="idea-empty" id="ideaPlaceholder">
                <svg><use href="#icon-compass"/></svg>
                <div class="idea-empty-title">Atelier Idéation</div>
                <div class="idea-empty-subtitle">
                    Soumettez une idée, un concept produit ou un besoin métier. Les agents vont challenger, enrichir et structurer la proposition.
                </div>
                <div class="idea-examples">
                    <button class="idea-example" onclick="setPrompt(this.textContent)">App de covoiturage pour La Poste</button>
                    <button class="idea-example" onclick="setPrompt(this.textContent)">Plateforme de suivi IoT pour vélos</button>
                    <button class="idea-example" onclick="setPrompt(this.textContent)">Migration Angular 16 vers 19</button>
                    <button class="idea-example" onclick="setPrompt(this.textContent)">Chatbot IA pour le support client</button>
                </div>
            </div>
        </div>

        <div class="idea-input-bar">
            <textarea class="idea-input" id="ideaInput" rows="1"
                placeholder="Décrivez votre idée, concept ou besoin métier..."
                onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendIdea()}"></textarea>
            <button class="idea-send" id="ideaSend" onclick="sendIdea()">
                <svg><use href="#icon-send"/></svg>
            </button>
        </div>
    </div>

    <!-- Right panel -->
    <div class="idea-panel">

        <!-- Agent Graph -->
        <div class="idea-graph">
            <div class="idea-graph-header" onclick="toggleIdeaGraph()">
                <div class="idea-graph-title">
                    <svg><use href="#icon-git-branch"/></svg> Organisation &amp; Flow
                </div>
                <svg class="idea-graph-toggle open" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
            </div>
            <div class="idea-graph-canvas" id="ideaGraphCanvas">
                <svg id="ideaGraphSvg" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <marker id="ig-arrow-network" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
                            <path d="M0,0 L10,5 L0,10 z" fill="#8b5cf6" opacity="0.8"/>
                        </marker>
                        <marker id="ig-arrow-sequential" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
                            <path d="M0,0 L10,5 L0,10 z" fill="#3b82f6" opacity="0.8"/>
                        </marker>
                        <marker id="ig-arrow-report" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
                            <path d="M0,0 L10,5 L0,10 z" fill="#ef4444" opacity="0.8"/>
                        </marker>
                        <marker id="ig-arrow-hierarchical" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
                            <path d="M0,0 L10,5 L0,10 z" fill="#f59e0b" opacity="0.8"/>
                        </marker>
                    </defs>
                    <g id="ideaEdges"></g>
                    <g id="ideaNodes"></g>
                </svg>
            </div>
            <div class="idea-graph-legend" id="ideaGraphLegend"></div>
        </div>

        <!-- Popover overlay -->
        <div class="ig-popover-overlay" id="igOverlay" onclick="closeIgPopover()"></div>
        <div class="ig-popover" id="igPopover">
            <div class="ig-popover-header">
                <div id="igPopAvatar"></div>
                <div class="ig-popover-info">
                    <div class="ig-popover-name" id="igPopName"></div>
                    <div class="ig-popover-role" id="igPopRole"></div>
                </div>
                <button class="ig-popover-close" onclick="closeIgPopover()">
                    <svg class="icon icon-sm"><use href="#icon-x"/></svg>
                </button>
            </div>
            <div class="ig-popover-body" id="igPopBody"></div>
        </div>

        <!-- Agent roster -->
        <div class="idea-agents">
            <div class="idea-agents-title">
                <svg><use href="#icon-users"/></svg> Agents Mobilisés
            </div>
            {% for a in agents %}
            <div class="idea-agent-row" id="agent-{{ a.id }}">
                <span class="idea-agent-dot idle" id="dot-{{ a.id }}"></span>
                <span class="idea-agent-label">{{ a.name }}</span>
                <span class="idea-agent-role">{{ a.short_role }}</span>
            </div>
            {% endfor %}
        </div>

        <!-- Structured findings -->
        <div class="idea-output">
            <div class="idea-output-title">
                <svg><use href="#icon-target"/></svg> Synthèse
            </div>
            <div id="ideaFindings">
                <div class="idea-output-empty">Lancez une idée pour voir les analyses apparaître ici.</div>
            </div>
        </div>

        <!-- Actions -->
        <div class="idea-output">
            <div class="idea-output-title">
                <svg><use href="#icon-lightning"/></svg> Actions
            </div>
            <div id="ideaActions" style="display:flex;flex-direction:column;gap:0.4rem">
                <button class="pm-filter" style="width:100%;text-align:left;opacity:.5;pointer-events:none" id="btnCreateEpic">
                    <svg class="icon icon-xs" style="vertical-align:-2px"><use href="#icon-rocket"/></svg>
                    Créer un Epic depuis cette idée
                </button>
                <button class="pm-filter" style="width:100%;text-align:left;opacity:.5;pointer-events:none" id="btnGenerateTeam">
                    <svg class="icon icon-xs" style="vertical-align:-2px"><use href="#icon-users"/></svg>
                    Générer l'équipe
                </button>
            </div>
        </div>
    </div>
</div>

<script>
/* ── Ideation Graph Data ── */
const igAgents = {{ agents | tojson }};
const IG_NW = 130, IG_NH = 56;

// Graph layout: Product Manager at top (orchestrator), 4 experts below in a network
const igNodes = [
    {id: 'product_manager', x: 130, y: 10, rank: 0},
    {id: 'metier',          x: 10,  y: 110, rank: 1},
    {id: 'architecte',      x: 90,  y: 200, rank: 1},
    {id: 'ux_designer',     x: 180, y: 110, rank: 1},
    {id: 'securite',        x: 260, y: 200, rank: 1},
];
const igEdges = [
    {from: 'product_manager', to: 'metier',      pattern: 'hierarchical', label: 'brief'},
    {from: 'product_manager', to: 'architecte',   pattern: 'hierarchical', label: 'brief'},
    {from: 'product_manager', to: 'ux_designer',  pattern: 'hierarchical', label: 'brief'},
    {from: 'product_manager', to: 'securite',     pattern: 'hierarchical', label: 'brief'},
    {from: 'metier',          to: 'architecte',   pattern: 'network',      label: 'challenge'},
    {from: 'architecte',      to: 'securite',     pattern: 'network',      label: 'review'},
    {from: 'ux_designer',     to: 'metier',       pattern: 'network',      label: 'feedback'},
    {from: 'metier',          to: 'product_manager', pattern: 'report',    label: 'synthèse'},
    {from: 'securite',        to: 'product_manager', pattern: 'report',    label: 'risques'},
];

const IG_PATTERNS = {
    network:      {color:'#8b5cf6', dash:'2 4 8 4', label:'Network'},
    hierarchical: {color:'#f59e0b', dash:'',         label:'Hierarchical'},
    sequential:   {color:'#3b82f6', dash:'',         label:'Sequential'},
    report:       {color:'#ef4444', dash:'3 3',       label:'Report'},
};

function igAgent(id){ return igAgents.find(a=>a.id===id); }
function igEsc(s){ const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }

function renderIdeaGraph(){
    const svg = document.getElementById('ideaGraphSvg');
    const W = 400, H = 280;
    svg.setAttribute('viewBox', `0 0 ${W} ${H}`);

    // Edges
    const edgesG = document.getElementById('ideaEdges');
    edgesG.innerHTML = '';
    const activePatterns = new Set();
    igEdges.forEach(e=>{
        const fn = igNodes.find(n=>n.id===e.from);
        const tn = igNodes.find(n=>n.id===e.to);
        if(!fn||!tn) return;
        const style = IG_PATTERNS[e.pattern] || IG_PATTERNS.network;
        activePatterns.add(e.pattern);

        const x1 = fn.x + IG_NW/2, y1 = fn.y + IG_NH;
        const x2 = tn.x + IG_NW/2, y2 = tn.y;
        const dy = tn.y - fn.y, dx = tn.x - fn.x;

        let d, mx, my;
        if(Math.abs(dy) < IG_NH * 0.8){
            // Horizontal connection
            const lx = dx>0 ? fn.x+IG_NW : fn.x;
            const ly = fn.y+IG_NH/2;
            const rx = dx>0 ? tn.x : tn.x+IG_NW;
            const ry = tn.y+IG_NH/2;
            const mid = Math.min(ly, ry) - 25;
            d = `M${lx},${ly} C${lx},${mid} ${rx},${mid} ${rx},${ry}`;
            mx = (lx+rx)/2; my = (ly+ry)/2 - 8;
        } else if(dy > 0){
            const co = Math.max(20, Math.abs(dy)*0.35);
            d = `M${x1},${y1} C${x1},${y1+co} ${x2},${y2-co} ${x2},${y2}`;
            mx = (x1+x2)/2; my = (y1+y2)/2 - 4;
        } else {
            const co = Math.max(20, Math.abs(dy)*0.35);
            d = `M${x1},${fn.y} C${x1},${fn.y-co} ${x2},${tn.y+IG_NH+co} ${x2},${tn.y+IG_NH}`;
            mx = (x1+x2)/2; my = (fn.y+tn.y+IG_NH)/2 - 4;
        }

        const path = document.createElementNS('http://www.w3.org/2000/svg','path');
        path.setAttribute('d', d);
        path.setAttribute('class','ig-edge');
        path.style.stroke = style.color;
        path.style.markerEnd = `url(#ig-arrow-${e.pattern})`;
        if(style.dash) path.style.strokeDasharray = style.dash;
        edgesG.appendChild(path);

        if(e.label){
            const lbl = document.createElementNS('http://www.w3.org/2000/svg','text');
            lbl.setAttribute('class','ig-edge-label');
            lbl.setAttribute('x', mx); lbl.setAttribute('y', my);
            lbl.style.fill = style.color;
            lbl.textContent = e.label;
            edgesG.appendChild(lbl);
        }
    });

    // Nodes
    const nodesG = document.getElementById('ideaNodes');
    nodesG.innerHTML = '';
    igNodes.forEach(n=>{
        const agent = igAgent(n.id);
        const col = agent ? agent.color : '#7c3aed';
        const name = agent ? agent.name : n.id;
        const role = agent ? agent.short_role : '';
        const avatarUrl = agent ? agent.avatar_url : '';

        const g = document.createElementNS('http://www.w3.org/2000/svg','g');
        g.setAttribute('class','ig-node');
        g.setAttribute('transform',`translate(${n.x},${n.y})`);

        const avatarR = 14, avatarCx = 20, avatarCy = IG_NH/2;
        const avatarSvg = avatarUrl
            ? `<clipPath id="ig-clip-${n.id}"><circle cx="${avatarCx}" cy="${avatarCy}" r="${avatarR}"/></clipPath>
               <image href="${avatarUrl}" x="${avatarCx-avatarR}" y="${avatarCy-avatarR}" width="${avatarR*2}" height="${avatarR*2}" clip-path="url(#ig-clip-${n.id})"/>`
            : `<circle cx="${avatarCx}" cy="${avatarCy}" r="${avatarR}" fill="${col}" opacity="0.25"/>
               <text x="${avatarCx}" y="${avatarCy+4}" text-anchor="middle" style="font-size:10px;fill:${col};font-weight:700">${igEsc(name.substring(0,2))}</text>`;

        g.innerHTML = `
            <rect class="ig-node-bg" width="${IG_NW}" height="${IG_NH}"/>
            <line class="ig-node-bar" x1="0" y1="0" x2="${IG_NW}" y2="0" stroke="${col}" stroke-width="3"/>
            ${avatarSvg}
            <text class="ig-node-name" x="40" y="22">${igEsc(name.length>14?name.substring(0,13)+'…':name)}</text>
            <text class="ig-node-role" x="40" y="36">${igEsc(role)}</text>
            <circle class="ig-node-dot" cx="${IG_NW-12}" cy="14" fill="${col}" opacity="0.6"/>
        `;
        g.addEventListener('click', (ev)=>{ ev.stopPropagation(); showIgPopover(n.id, ev); });
        g.dataset.agent = n.id;
        nodesG.appendChild(g);
    });

    // Legend
    const legendEl = document.getElementById('ideaGraphLegend');
    legendEl.innerHTML = '';
    activePatterns.forEach(p=>{
        const s = IG_PATTERNS[p]; if(!s) return;
        const item = document.createElement('div');
        item.className = 'idea-graph-legend-item';
        item.innerHTML = `
            <svg width="28" height="10"><line x1="0" y1="5" x2="20" y2="5" stroke="${s.color}" stroke-width="2" ${s.dash?`stroke-dasharray="${s.dash}"`:''}/><polygon points="20,1 28,5 20,9" fill="${s.color}" opacity="0.8"/></svg>
            <span>${s.label}</span>`;
        legendEl.appendChild(item);
    });
}

function toggleIdeaGraph(){
    const canvas = document.getElementById('ideaGraphCanvas');
    const legend = document.getElementById('ideaGraphLegend');
    const toggle = document.querySelector('.idea-graph-toggle');
    const hidden = canvas.style.display === 'none';
    canvas.style.display = hidden ? '' : 'none';
    legend.style.display = hidden ? '' : 'none';
    toggle.classList.toggle('open', hidden);
}

function showIgPopover(agentId, ev){
    const agent = igAgent(agentId); if(!agent) return;
    const overlay = document.getElementById('igOverlay');
    const pop = document.getElementById('igPopover');

    // Avatar
    const avatarEl = document.getElementById('igPopAvatar');
    if(agent.avatar_url){
        avatarEl.innerHTML = `<img class="ig-popover-avatar" src="${agent.avatar_url}" alt="${igEsc(agent.name)}">`;
    } else {
        avatarEl.innerHTML = `<div class="ig-popover-avatar-fallback" style="background:${agent.color}">${igEsc(agent.name.substring(0,2))}</div>`;
    }
    document.getElementById('igPopName').textContent = agent.name;
    document.getElementById('igPopRole').textContent = agent.short_role || '';

    // Body
    let html = '';
    if(agent.tagline) html += `<div class="ig-popover-text" style="font-style:italic;font-size:0.75rem;color:var(--text-secondary)">${igEsc(agent.tagline)}</div>`;
    if(agent.persona){
        html += `<div><div class="ig-popover-section-title"><svg><use href="#icon-user"/></svg> Persona</div>
                  <div class="ig-popover-text">${igEsc(agent.persona.substring(0,300))}${agent.persona.length>300?'…':''}</div></div>`;
    }
    if(agent.motivation){
        html += `<div><div class="ig-popover-section-title"><svg><use href="#icon-zap"/></svg> Motivation</div>
                  <div class="ig-popover-text">${igEsc(agent.motivation)}</div></div>`;
    }
    if(agent.skills && agent.skills.length){
        html += `<div><div class="ig-popover-section-title"><svg><use href="#icon-layers"/></svg> Skills (${agent.skills.length})</div>
                  <div class="ig-popover-tags">${agent.skills.map(s=>`<span class="ig-popover-tag skill">${igEsc(s)}</span>`).join('')}</div></div>`;
    }
    if(agent.tools && agent.tools.length){
        html += `<div><div class="ig-popover-section-title"><svg><use href="#icon-settings"/></svg> Tools (${agent.tools.length})</div>
                  <div class="ig-popover-tags">${agent.tools.map(t=>`<span class="ig-popover-tag tool">${igEsc(t)}</span>`).join('')}</div></div>`;
    }
    if(agent.model || agent.provider){
        html += `<div><div class="ig-popover-section-title"><svg><use href="#icon-brain"/></svg> LLM</div>
                  <span class="ig-popover-tag">${igEsc((agent.provider||'')+' '+(agent.model||'default'))}</span></div>`;
    }
    document.getElementById('igPopBody').innerHTML = html;

    // Position near click
    const vw = window.innerWidth, vh = window.innerHeight;
    let left = ev.clientX + 12, top = ev.clientY - 20;
    if(left + 330 > vw) left = vw - 340;
    if(top + 350 > vh) top = Math.max(10, vh - 400);
    pop.style.left = left + 'px'; pop.style.top = top + 'px';

    overlay.classList.add('visible');
    pop.classList.add('visible');
}
function closeIgPopover(){
    document.getElementById('igOverlay').classList.remove('visible');
    document.getElementById('igPopover').classList.remove('visible');
}
document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeIgPopover(); });

// Render on load
document.addEventListener('DOMContentLoaded', renderIdeaGraph);

/* ── Ideation Chat ── */
const messagesEl = document.getElementById('ideaMessages');
const inputEl = document.getElementById('ideaInput');
const sendBtn = document.getElementById('ideaSend');
const placeholder = document.getElementById('ideaPlaceholder');
const findingsEl = document.getElementById('ideaFindings');
let sessionId = '';

function setPrompt(text) {
    inputEl.value = text;
    inputEl.focus();
}

function addMsg(agent, name, content, color, avatarUrl) {
    if (placeholder) placeholder.style.display = 'none';
    const isUser = agent === 'user';
    const div = document.createElement('div');
    div.className = 'idea-msg ' + (isUser ? 'user' : 'agent');

    const avatarHtml = avatarUrl
        ? `<img src="${avatarUrl}" alt="${name}">`
        : name.charAt(0);
    const bgColor = isUser ? 'var(--user-bubble)' : (color || 'var(--bg-tertiary)');

    div.innerHTML = `
        <div class="idea-msg-avatar" style="background:${bgColor}20;border:2px solid ${bgColor}">${avatarHtml}</div>
        <div>
            <div class="idea-msg-name">${name}</div>
            <div class="idea-msg-bubble ${isUser ? '' : 'agent'}">
                <div class="idea-msg-content">${content}</div>
            </div>
        </div>
    `;
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
}

function addFinding(type, text) {
    const empty = findingsEl.querySelector('.idea-output-empty');
    if (empty) empty.remove();
    const div = document.createElement('div');
    div.className = 'idea-finding';
    div.innerHTML = `<div class="idea-finding-type ${type}">${type}</div><div class="idea-finding-text">${text}</div>`;
    findingsEl.appendChild(div);
}

function setAgentStatus(agentId, status) {
    // Roster dot
    const dot = document.getElementById('dot-' + agentId);
    if (dot) { dot.className = 'idea-agent-dot ' + status; }
    // Graph node
    const nodeG = document.querySelector(`.ig-node[data-agent="${agentId}"]`);
    if(nodeG){
        nodeG.classList.remove('active','thinking');
        if(status === 'thinking') nodeG.classList.add('thinking');
        else if(status === 'speaking') nodeG.classList.add('active');
    }
}

function setEdgeActive(fromId, toId, active){
    document.querySelectorAll('#ideaEdges .ig-edge').forEach(p=>{
        if(p.dataset.from===fromId && p.dataset.to===toId){
            p.classList.toggle('flowing', active);
            p.classList.toggle('active', active);
        }
    });
}

function resetGraphState(){
    document.querySelectorAll('.ig-node').forEach(n=> n.classList.remove('active','thinking'));
    document.querySelectorAll('.ig-edge').forEach(e=> e.classList.remove('active','flowing'));
    document.querySelectorAll('.idea-agent-dot').forEach(d => d.className = 'idea-agent-dot idle');
}

// Flow order: PM briefs → experts think in parallel → experts report back → PM synthesizes
const FLOW_SEQUENCE = [
    {phase:'brief', agents:['product_manager'], edges:[
        ['product_manager','metier'],['product_manager','architecte'],
        ['product_manager','ux_designer'],['product_manager','securite']
    ]},
    {phase:'analyze', agents:['metier','architecte','ux_designer','securite'], edges:[
        ['metier','architecte'],['architecte','securite'],['ux_designer','metier']
    ]},
    {phase:'report', agents:['product_manager'], edges:[
        ['metier','product_manager'],['securite','product_manager']
    ]},
];

async function sendIdea() {
    const text = inputEl.value.trim();
    if (!text) return;
    inputEl.value = '';
    sendBtn.disabled = true;

    addMsg('user', 'Vous', text, '', '');
    originalPrompt = originalPrompt || text;

    // Phase 1: PM briefs — all dots thinking
    setAgentStatus('product_manager', 'speaking');
    addMsg('agent', 'Product Manager', 'Je lance le brief auprès de l\'équipe...', '#16a34a',
        igAgent('product_manager')?.avatar_url || '');
    FLOW_SEQUENCE[0].edges.forEach(([f,t])=> setEdgeActive(f,t,true));
    await sleep(600);

    // Phase 2: All experts thinking
    ['metier','architecte','ux_designer','securite'].forEach(id=> setAgentStatus(id, 'thinking'));
    FLOW_SEQUENCE[0].edges.forEach(([f,t])=> setEdgeActive(f,t,false));
    FLOW_SEQUENCE[1].edges.forEach(([f,t])=> setEdgeActive(f,t,true));

    try {
        const resp = await fetch('/api/ideation', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({prompt: text, session_id: sessionId}),
        });
        const data = await resp.json();
        if (data.error) {
            resetGraphState();
            addMsg('system', 'Système', data.error, 'var(--red)', '');
        } else {
            sessionId = data.session_id || sessionId;
            const messages = data.messages || [];

            // Animate messages one by one with graph activation
            FLOW_SEQUENCE[1].edges.forEach(([f,t])=> setEdgeActive(f,t,false));

            for (let i = 0; i < messages.length; i++) {
                const msg = messages[i];
                const agentId = msg.agent_id;
                const agent = igAgent(agentId);

                // Light up edges TO this agent, set thinking→speaking
                setAgentStatus(agentId, 'speaking');
                // Find edges going to this agent and light them
                igEdges.filter(e=> e.to === agentId).forEach(e=> setEdgeActive(e.from, e.to, true));

                addMsg('agent', msg.agent_name, msg.content, msg.color || '',
                    agent?.avatar_url || msg.avatar_url || '');

                await sleep(800);

                // Turn off edges, set to idle (next agent takes over)
                igEdges.filter(e=> e.to === agentId).forEach(e=> setEdgeActive(e.from, e.to, false));
                if(i < messages.length - 1) setAgentStatus(agentId, 'idle');
            }

            // Phase 3: Report edges light up briefly
            FLOW_SEQUENCE[2].edges.forEach(([f,t])=> setEdgeActive(f,t,true));
            await sleep(500);
            FLOW_SEQUENCE[2].edges.forEach(([f,t])=> setEdgeActive(f,t,false));

            for (const f of (data.findings || [])) {
                addFinding(f.type, f.text);
            }

            // Enable action buttons
            document.getElementById('btnCreateEpic').style.opacity = '1';
            document.getElementById('btnCreateEpic').style.pointerEvents = 'auto';
            document.getElementById('btnGenerateTeam').style.opacity = '1';
            document.getElementById('btnGenerateTeam').style.pointerEvents = 'auto';

            // Final: all agents speaking (done)
            igAgents.forEach(a=> setAgentStatus(a.id, 'speaking'));
            await sleep(1500);
            resetGraphState();
        }
    } catch (e) {
        resetGraphState();
        addMsg('system', 'Système', 'Erreur de connexion: ' + e.message, 'var(--red)', '');
    }
    sendBtn.disabled = false;
}

function sleep(ms){ return new Promise(r=> setTimeout(r, ms)); }

// Collect findings from the panel
function collectFindings() {
    const items = document.querySelectorAll('.idea-finding');
    return Array.from(items).map(el => {
        const type = el.querySelector('.idea-finding-type')?.textContent?.trim() || '';
        const text = el.querySelector('.idea-finding-text')?.textContent?.trim() || '';
        return {type, text};
    });
}

// Collect the original prompt
let originalPrompt = '';

// Create epic from idea
document.getElementById('btnCreateEpic').addEventListener('click', async () => {
    if (!sessionId && !originalPrompt) return;
    addMsg('system', 'Système', 'Création de l\'epic en cours...', 'var(--purple)', '');
    const findings = collectFindings();
    const description = findings.map(f => `[${f.type.toUpperCase()}] ${f.text}`).join('\n');
    try {
        const resp = await fetch('/api/ideation/create-epic', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                session_id: sessionId,
                name: originalPrompt.substring(0, 100) || 'Epic from ideation',
                description: description,
                goal: originalPrompt,
            }),
        });
        const data = await resp.json();
        if (data.mission_id) {
            addMsg('system', 'Système',
                `Epic créé ! Redirection vers <a href="/missions/${data.mission_id}" style="color:var(--purple)">${data.name}</a>...`,
                'var(--green)', '');
            setTimeout(() => { window.location.href = `/missions/${data.mission_id}`; }, 1500);
        }
    } catch(e) {
        addMsg('system', 'Système', 'Erreur: ' + e.message, 'var(--red)', '');
    }
});

// Generate team — pass the prompt as context
document.getElementById('btnGenerateTeam').addEventListener('click', () => {
    const prompt = encodeURIComponent(originalPrompt || '');
    window.location.href = '/generate' + (prompt ? '?prompt=' + prompt : '');
});

// Auto-resize textarea
inputEl.addEventListener('input', () => {
    inputEl.style.height = 'auto';
    inputEl.style.height = Math.min(inputEl.scrollHeight, 120) + 'px';
});
</script>
{% endblock %}
