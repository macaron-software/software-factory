{% extends "base.html" %}

{% block topbar_actions %}
<a href="/missions?action=new" class="btn btn-primary">
    <svg class="icon icon-sm"><use href="#icon-plus"/></svg> Nouvel Epic
</a>
{% endblock %}

{% block content %}
<style>
/* ── Product Line Manager ── */
.pl-page{display:grid;grid-template-columns:1fr;gap:1.5rem;padding:0.5rem 0}

/* Header hero */
.pl-hero{display:grid;grid-template-columns:1fr auto;gap:1.5rem;align-items:start;padding:1rem 1.25rem;background:linear-gradient(135deg,rgba(124,58,237,.12) 0%,rgba(59,130,246,.08) 100%);border:1px solid var(--border);border-radius:var(--radius)}
.pl-hero-title{font-size:1.3rem;font-weight:800;color:var(--text-primary);margin:0 0 0.25rem}
.pl-hero-subtitle{font-size:0.82rem;color:var(--text-secondary);margin:0}
.pl-hero-kpis{display:flex;gap:1rem;flex-wrap:wrap}
.pl-kpi{text-align:center;min-width:70px}
.pl-kpi-value{font-size:1.5rem;font-weight:800;color:var(--text-primary)}
.pl-kpi-label{font-size:0.68rem;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.5px}

/* ── DORA strip ── */
.pl-dora{display:grid;grid-template-columns:repeat(4,1fr);gap:0.75rem}
.pl-dora-card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);padding:0.85rem 1rem;text-align:center}
.pl-dora-icon{margin-bottom:0.3rem}
.pl-dora-icon svg{width:24px;height:24px}
.pl-dora-title{font-size:0.7rem;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.5px;margin-bottom:0.35rem;font-weight:600}
.pl-dora-value{font-size:1.3rem;font-weight:700;color:var(--text-primary)}
.pl-dora-detail{font-size:0.72rem;color:var(--text-secondary);margin:0.15rem 0 0.4rem}
.pl-dora-level{display:inline-block;font-size:0.65rem;padding:2px 8px;border-radius:10px;font-weight:600;text-transform:uppercase}
.level-elite{background:#7c3aed22;color:var(--purple)}
.level-high{background:#16a34a22;color:#16a34a}
.level-medium{background:#ea580c22;color:#ea580c}
.level-low{background:#dc262622;color:#dc2626}

/* ── Values ── */
.pl-values{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:0.5rem}
.pl-value-card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);padding:0.65rem 0.85rem;display:flex;align-items:center;gap:0.5rem}
.pl-value-icon{width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.pl-value-icon svg{width:16px;height:16px}
.pl-value-text{flex:1}
.pl-value-label{font-size:0.78rem;font-weight:600;color:var(--text-primary)}
.pl-value-desc{font-size:0.68rem;color:var(--text-secondary);margin-top:1px}

/* ── Product cards ── */
.pl-products{display:grid;gap:0.75rem}
.pl-product{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;transition:border-color .15s}
.pl-product:hover{border-color:var(--purple)}
.pl-product-header{padding:0.85rem 1rem;display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:0.75rem;cursor:pointer}
.pl-product-header:hover{background:var(--bg-tertiary)}
.pl-product-chevron{width:16px;height:16px;color:var(--text-secondary);transition:transform .2s;flex-shrink:0}
.pl-product.open .pl-product-chevron{transform:rotate(90deg)}
.pl-product-info{flex:1}
.pl-product-name{font-size:0.95rem;font-weight:700;color:var(--text-primary)}
.pl-product-desc{font-size:0.72rem;color:var(--text-secondary);margin-top:2px}
.pl-product-stats{display:flex;gap:0.75rem;align-items:center}
.pl-product-stat{font-size:0.72rem;color:var(--text-secondary);display:flex;align-items:center;gap:3px}
.pl-product-stat svg{width:13px;height:13px}
.pl-product-stat .val{font-weight:700;color:var(--text-primary)}
.pl-status-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.pl-status-dot.active{background:var(--green)}
.pl-status-dot.paused{background:var(--yellow)}
.pl-status-dot.archived{background:var(--text-secondary)}

/* ── Roadmap (inside product) ── */
.pl-product-body{border-top:1px solid var(--border);display:none;padding:0.75rem 1rem}
.pl-product.open .pl-product-body{display:block}

.pl-roadmap{margin-bottom:0.75rem}
.pl-roadmap-title{font-size:0.75rem;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.5px;margin-bottom:0.5rem;display:flex;align-items:center;gap:0.4rem}
.pl-roadmap-title svg{width:14px;height:14px}

/* Timeline */
.pl-timeline{position:relative;padding-left:20px}
.pl-timeline::before{content:'';position:absolute;left:6px;top:4px;bottom:4px;width:2px;background:var(--border)}
.pl-milestone{position:relative;padding:0.5rem 0 0.5rem 1rem;display:grid;grid-template-columns:1fr auto auto;align-items:center;gap:0.5rem}
.pl-milestone::before{content:'';position:absolute;left:-14px;top:50%;transform:translateY(-50%);width:10px;height:10px;border-radius:50%;border:2px solid var(--border);background:var(--bg-primary);z-index:1}
.pl-milestone.done::before{background:var(--green);border-color:var(--green)}
.pl-milestone.active::before{background:var(--purple);border-color:var(--purple);box-shadow:0 0 6px rgba(124,58,237,.4)}
.pl-milestone.upcoming::before{background:var(--bg-tertiary);border-color:var(--border)}
.pl-ms-name{font-size:0.82rem;font-weight:600;color:var(--text-primary)}
.pl-ms-name small{font-weight:400;color:var(--text-secondary);margin-left:0.3rem}
.pl-ms-progress{width:80px}
.pl-ms-bar{height:5px;background:var(--bg-tertiary);border-radius:3px;overflow:hidden}
.pl-ms-bar-fill{height:100%;border-radius:3px;transition:width .3s}
.pl-ms-bar-fill.done{background:var(--green)}
.pl-ms-bar-fill.active{background:var(--purple)}
.pl-ms-bar-fill.upcoming{background:var(--text-secondary)}
.pl-ms-pct{font-size:0.72rem;font-weight:700;color:var(--text-secondary);min-width:35px;text-align:right}

/* Epics list */
.pl-epics-title{font-size:0.75rem;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.5px;margin:0.75rem 0 0.5rem;display:flex;align-items:center;gap:0.4rem}
.pl-epics-title svg{width:14px;height:14px}
.pl-epic-row{display:grid;grid-template-columns:auto 1fr auto auto auto;align-items:center;gap:0.6rem;padding:0.45rem 0;border-bottom:1px solid rgba(255,255,255,.04);font-size:0.82rem}
.pl-epic-row:last-child{border-bottom:none}
.pl-epic-row:hover{background:rgba(255,255,255,.02);border-radius:4px}
.pl-epic-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.pl-epic-dot.pending{background:var(--text-secondary)}
.pl-epic-dot.running{background:var(--green);animation:pulse-dot 2s infinite}
.pl-epic-dot.completed{background:var(--blue)}
.pl-epic-dot.failed{background:var(--red)}
.pl-epic-dot.paused{background:var(--yellow)}
.pl-epic-name{color:var(--text-primary);font-weight:500}
.pl-epic-name a{color:inherit;text-decoration:none}
.pl-epic-name a:hover{color:var(--purple)}
.pl-epic-features{font-size:0.7rem;color:var(--text-secondary);background:var(--bg-tertiary);padding:1px 6px;border-radius:4px}
.pl-epic-progress-bar{width:60px;height:4px;background:var(--bg-tertiary);border-radius:2px;overflow:hidden}
.pl-epic-progress-fill{height:100%;background:var(--green);border-radius:2px}
.pl-epic-status{font-size:0.65rem;padding:2px 6px;border-radius:4px;font-weight:600;text-transform:uppercase}
.pl-epic-status.pending{background:rgba(107,114,128,.15);color:#9ca3af}
.pl-epic-status.running{background:rgba(52,211,153,.15);color:#34d399}
.pl-epic-status.completed{background:rgba(96,165,250,.15);color:#60a5fa}
.pl-epic-status.failed{background:rgba(248,113,113,.15);color:#f87171}
.pl-epic-status.paused{background:rgba(251,191,36,.15);color:#fbbf24}

/* Product DORA mini */
.pl-product-dora{display:grid;grid-template-columns:repeat(4,1fr);gap:0.5rem;margin-top:0.75rem;padding-top:0.75rem;border-top:1px solid rgba(255,255,255,.04)}
.pl-pdora{text-align:center;padding:0.4rem;background:var(--bg-tertiary);border-radius:6px}
.pl-pdora-label{font-size:0.62rem;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.3px}
.pl-pdora-value{font-size:0.95rem;font-weight:700;color:var(--text-primary);margin:0.15rem 0}
.pl-pdora-level{font-size:0.6rem;font-weight:600;text-transform:uppercase}

/* Section title */
.pl-section{font-size:0.82rem;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:1px;display:flex;align-items:center;gap:0.5rem}
.pl-section svg{width:16px;height:16px}

@keyframes pulse-dot{0%,100%{opacity:1}50%{opacity:.5}}
@media(max-width:768px){.pl-dora{grid-template-columns:1fr 1fr}.pl-hero{grid-template-columns:1fr}.pl-values{grid-template-columns:1fr 1fr}}
</style>

<div class="pl-page">

    <!-- ── Hero: Product Line KPIs ── -->
    <div class="pl-hero">
        <div>
            <h2 class="pl-hero-title">Ligne de Produit</h2>
            <p class="pl-hero-subtitle">Pilotage des produits, applications, roadmap et qualité (DORA)</p>
        </div>
        <div class="pl-hero-kpis">
            <div class="pl-kpi">
                <div class="pl-kpi-value">{{ products|length }}</div>
                <div class="pl-kpi-label">Produits</div>
            </div>
            <div class="pl-kpi">
                <div class="pl-kpi-value">{{ total_epics }}</div>
                <div class="pl-kpi-label">Epics</div>
            </div>
            <div class="pl-kpi">
                <div class="pl-kpi-value">{{ total_features }}</div>
                <div class="pl-kpi-label">Features</div>
            </div>
            <div class="pl-kpi">
                <div class="pl-kpi-value">{{ total_stories }}</div>
                <div class="pl-kpi-label">Stories</div>
            </div>
            <div class="pl-kpi">
                <div class="pl-kpi-value">{{ overall_done_pct }}%</div>
                <div class="pl-kpi-label">Achevé</div>
            </div>
        </div>
    </div>

    <!-- ── DORA Global ── -->
    <div>
        <div class="pl-section" style="margin-bottom:0.6rem">
            <svg><use href="#icon-chart"/></svg> DORA — Qualité &amp; Time to Market
        </div>
        <div class="pl-dora">
            <div class="pl-dora-card">
                <div class="pl-dora-icon"><svg class="icon" style="color:var(--green)"><use href="#icon-rocket"/></svg></div>
                <div class="pl-dora-title">Deploy Frequency</div>
                <div class="pl-dora-value">{{ dora.deployment_frequency.count }}</div>
                <div class="pl-dora-detail">{{ dora.deployment_frequency.per_day }}/jour</div>
                <span class="pl-dora-level level-{{ dora.deployment_frequency.level }}">{{ dora.deployment_frequency.level }}</span>
            </div>
            <div class="pl-dora-card">
                <div class="pl-dora-icon"><svg class="icon" style="color:var(--blue)"><use href="#icon-clock"/></svg></div>
                <div class="pl-dora-title">Lead Time</div>
                <div class="pl-dora-value">{{ dora.lead_time.median_hours }}h</div>
                <div class="pl-dora-detail">commit → prod (p90: {{ dora.lead_time.p90_hours }}h)</div>
                <span class="pl-dora-level level-{{ dora.lead_time.level }}">{{ dora.lead_time.level }}</span>
            </div>
            <div class="pl-dora-card">
                <div class="pl-dora-icon"><svg class="icon" style="color:var(--yellow)"><use href="#icon-alert-triangle"/></svg></div>
                <div class="pl-dora-title">Change Failure</div>
                <div class="pl-dora-value">{{ dora.change_failure_rate.rate_pct }}%</div>
                <div class="pl-dora-detail">{{ dora.change_failure_rate.failures }}/{{ dora.change_failure_rate.total }} deploys</div>
                <span class="pl-dora-level level-{{ dora.change_failure_rate.level }}">{{ dora.change_failure_rate.level }}</span>
            </div>
            <div class="pl-dora-card">
                <div class="pl-dora-icon"><svg class="icon" style="color:var(--red)"><use href="#icon-wrench"/></svg></div>
                <div class="pl-dora-title">MTTR</div>
                <div class="pl-dora-value">{{ dora.mttr.median_hours }}h</div>
                <div class="pl-dora-detail">temps de résolution</div>
                <span class="pl-dora-level level-{{ dora.mttr.level }}">{{ dora.mttr.level }}</span>
            </div>
        </div>
    </div>

    <!-- ── Values ── -->
    {% if values %}
    <div>
        <div class="pl-section" style="margin-bottom:0.6rem">
            <svg><use href="#icon-target"/></svg> Valeurs de la Ligne de Produit
        </div>
        <div class="pl-values">
            {% set value_icons = {'quality': ('icon-target','#7c3aed22'), 'feedback': ('icon-zap','#3b82f622'), 'no-waste': ('icon-leaf','#16a34a22'), 'respect': ('icon-users','#f59e0b22'), 'kaizen': ('icon-trending-up','#06b6d422'), 'flow': ('icon-activity','#8b5cf622'), 'zero-skip': ('icon-shield','#dc262622'), 'tdd': ('icon-flask','#10b98122'), 'innovation': ('icon-lightbulb','#f97316aa'), 'user-first': ('icon-user','#0ea5e922'), 'security': ('icon-lock','#ef444422'), 'scalability': ('icon-chart','#6366f122')} %}
            {% for v in values %}
            <div class="pl-value-card">
                <div class="pl-value-icon" style="background:{{ value_icons.get(v.id, ('icon-circle','var(--bg-tertiary)'))[1] }}"><svg class="icon icon-sm"><use href="#{{ value_icons.get(v.id, ('icon-circle',''))[0] }}"/></svg></div>
                <div class="pl-value-text">
                    <div class="pl-value-label">{{ v.label }}</div>
                    <div class="pl-value-desc">{{ v.desc }}</div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- ── Products / Applications ── -->
    <div>
        <div class="pl-section" style="margin-bottom:0.6rem">
            <svg><use href="#icon-rocket"/></svg> Produits &amp; Applications
        </div>

        {% if not products %}
        <div style="text-align:center;padding:3rem;color:var(--text-secondary);font-size:0.85rem">
            <svg class="icon" style="width:48px;height:48px;margin-bottom:1rem;opacity:.3"><use href="#icon-layers"/></svg>
            <div>Aucun produit. Créez un projet pour commencer.</div>
        </div>
        {% endif %}

        <div class="pl-products">
            {% for p in products %}
            <div class="pl-product{% if products|length == 1 %} open{% endif %}" id="prod-{{ p.id }}">
                <div class="pl-product-header" onclick="toggleProduct('{{ p.id }}')">
                    <svg class="pl-product-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                    <div class="pl-product-info">
                        <div class="pl-product-name"><span class="pl-status-dot {{ p.status }}"></span> {{ p.name }}</div>
                        {% if p.description %}<div class="pl-product-desc">{{ p.description[:120] }}</div>{% endif %}
                    </div>
                    <div class="pl-product-stats">
                        <span class="pl-product-stat"><svg><use href="#icon-rocket"/></svg> <span class="val">{{ p.epics|length }}</span> epics</span>
                        <span class="pl-product-stat"><svg><use href="#icon-layers"/></svg> <span class="val">{{ p.feature_count }}</span> features</span>
                        <span class="pl-product-stat"><svg><use href="#icon-target"/></svg> <span class="val">{{ p.total_points }}</span> pts</span>
                        {% if p.done_pct > 0 %}
                        <span class="pl-product-stat">
                            <div style="width:50px;height:4px;background:var(--bg-tertiary);border-radius:2px;overflow:hidden">
                                <div style="width:{{ p.done_pct }}%;height:100%;background:var(--green);border-radius:2px"></div>
                            </div>
                            <span class="val">{{ p.done_pct }}%</span>
                        </span>
                        {% endif %}
                    </div>
                </div>

                <div class="pl-product-body">
                    <!-- Roadmap / Milestones -->
                    {% if p.milestones %}
                    <div class="pl-roadmap">
                        <div class="pl-roadmap-title"><svg><use href="#icon-calendar"/></svg> Roadmap — Jalons</div>
                        <div class="pl-timeline">
                            {% for ms in p.milestones %}
                            <div class="pl-milestone {{ ms.state }}">
                                <span class="pl-ms-name">{{ ms.name }}{% if ms.date %}<small>{{ ms.date }}</small>{% endif %}</span>
                                <div class="pl-ms-progress">
                                    <div class="pl-ms-bar"><div class="pl-ms-bar-fill {{ ms.state }}" style="width:{{ ms.pct }}%"></div></div>
                                </div>
                                <span class="pl-ms-pct">{{ ms.pct }}%</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Epics list -->
                    <div class="pl-epics-title"><svg><use href="#icon-rocket"/></svg> Epics</div>
                    {% if not p.epics %}
                    <div style="color:var(--text-secondary);font-size:0.78rem;font-style:italic;padding:0.4rem 0">Aucun epic pour ce produit</div>
                    {% endif %}
                    {% for e in p.epics %}
                    <div class="pl-epic-row">
                        <span class="pl-epic-dot {{ e.status }}"></span>
                        <span class="pl-epic-name"><a href="/missions/{{ e.id }}/control">{{ e.name }}</a></span>
                        <span class="pl-epic-features">{{ e.feature_count }} feat</span>
                        {% if e.story_count > 0 %}
                        <div class="pl-epic-progress-bar">
                            <div class="pl-epic-progress-fill" style="width:{{ e.done_pct }}%"></div>
                        </div>
                        {% endif %}
                        <span class="pl-epic-status {{ e.status }}">{{ e.status }}</span>
                    </div>
                    {% endfor %}

                    <!-- Per-product DORA mini -->
                    {% if p.dora %}
                    <div class="pl-product-dora">
                        <div class="pl-pdora">
                            <div class="pl-pdora-label">Deploy</div>
                            <div class="pl-pdora-value">{{ p.dora.deployment_frequency.count }}</div>
                            <div class="pl-pdora-level level-{{ p.dora.deployment_frequency.level }}">{{ p.dora.deployment_frequency.level }}</div>
                        </div>
                        <div class="pl-pdora">
                            <div class="pl-pdora-label">Lead Time</div>
                            <div class="pl-pdora-value">{{ p.dora.lead_time.median_hours }}h</div>
                            <div class="pl-pdora-level level-{{ p.dora.lead_time.level }}">{{ p.dora.lead_time.level }}</div>
                        </div>
                        <div class="pl-pdora">
                            <div class="pl-pdora-label">Failure</div>
                            <div class="pl-pdora-value">{{ p.dora.change_failure_rate.rate_pct }}%</div>
                            <div class="pl-pdora-level level-{{ p.dora.change_failure_rate.level }}">{{ p.dora.change_failure_rate.level }}</div>
                        </div>
                        <div class="pl-pdora">
                            <div class="pl-pdora-label">MTTR</div>
                            <div class="pl-pdora-value">{{ p.dora.mttr.median_hours }}h</div>
                            <div class="pl-pdora-level level-{{ p.dora.mttr.level }}">{{ p.dora.mttr.level }}</div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

</div>

<script>
function toggleProduct(id) {
    document.getElementById('prod-' + id).classList.toggle('open');
}
</script>
{% endblock %}
