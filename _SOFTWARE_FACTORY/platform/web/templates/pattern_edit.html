{% extends "base.html" %}

{% block topbar_actions %}
<div style="display:flex;gap:8px;">
    <button type="submit" form="pattern-form" class="btn btn-primary">
        <svg class="icon icon-sm"><use href="#icon-save"/></svg> Save
    </button>
    <a href="/patterns" class="btn btn-ghost">{{ _("cancel") }}</a>
</div>
{% endblock %}

{% block content %}
<form id="pattern-form"
      action="/api/patterns{% if pattern.id %}/{{ pattern.id }}{% endif %}"
      method="post"
      class="pattern-editor">

    <!-- Top toolbar -->
    <div class="pe-toolbar">
        <div class="pe-toolbar-left">
            <input type="text" name="name" value="{{ pattern.name }}" placeholder="Pattern name" class="pe-name-input" required>
            <select name="type" id="pattern-type" class="pe-type-select">
                {% for t in pattern_types %}
                <option value="{{ t }}" {% if pattern.type == t %}selected{% endif %}>{{ t }}</option>
                {% endfor %}
            </select>
            <select name="icon" class="pe-icon-select">
                {% for ic in ['workflow','bot','code','building','lock','eye','rocket','briefcase','brain','shield','zap'] %}
                <option value="{{ ic }}" {% if pattern.icon == ic %}selected{% endif %}>{{ ic }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="pe-toolbar-right">
            <button type="button" class="btn btn-sm btn-ghost" onclick="addNode()">
                <svg class="icon icon-sm"><use href="#icon-plus"/></svg> Add Agent
            </button>
            <span class="pe-agent-count" id="agent-count">{{ pattern.agents|length }} agents</span>
        </div>
    </div>

    <!-- Description -->
    <textarea name="description" placeholder="Describe what this pattern does…"
              class="pe-description" rows="2">{{ pattern.description }}</textarea>

    <!-- Hidden fields for canvas data -->
    <input type="hidden" name="agents_json" id="agents-json" value='{{ pattern.agents | tojson }}'>
    <input type="hidden" name="edges_json" id="edges-json" value='{{ pattern.edges | tojson }}'>

    <!-- Canvas + Properties panel -->
    <div class="pe-body">
        <!-- Canvas -->
        <div class="pe-canvas-wrap">
            <svg id="pe-canvas" class="pe-canvas" xmlns="http://www.w3.org/2000/svg">
                <!-- Edges drawn here -->
                <g id="edge-layer"></g>
                <!-- Nodes drawn via JS -->
            </svg>
            <!-- Agent nodes as HTML overlays -->
            <div id="node-layer" class="pe-node-layer"></div>
        </div>

        <!-- Properties panel -->
        <aside class="pe-props" id="props-panel">
            <div class="pe-props-header">
                <strong>{{ _("properties") }}</strong>
                <button type="button" class="btn-icon" id="props-close" onclick="deselectAll()">&times;</button>
            </div>
            <div id="props-content" class="pe-props-body">
                <p class="text-secondary" style="padding:16px;font-size:13px;">
                    Click an agent node to edit its properties.
                </p>
            </div>
        </aside>
    </div>
</form>

<!-- Available agents data -->
<script>
const AVAILABLE_AGENTS = {{ agents | tojson(indent=2) }};
let nodes = JSON.parse(document.getElementById('agents-json').value || '[]');
let edges = JSON.parse(document.getElementById('edges-json').value || '[]');
let selectedNode = null;
let dragNode = null;
let dragOff = {x:0, y:0};

const canvas = document.getElementById('pe-canvas');
const nodeLayer = document.getElementById('node-layer');
const edgeLayer = document.getElementById('edge-layer');

function render() {
    // Render nodes
    nodeLayer.innerHTML = '';
    nodes.forEach((n, i) => {
        const agent = AVAILABLE_AGENTS.find(a => a.id === n.agent_id);
        const color = agent ? agent.color : '#8b949e';
        const icon = agent ? agent.icon : 'bot';
        const name = n.label || (agent ? agent.name : 'Agent');

        const div = document.createElement('div');
        div.className = 'pe-node' + (selectedNode === i ? ' selected' : '');
        div.style.left = n.x + 'px';
        div.style.top = n.y + 'px';
        div.dataset.idx = i;
        div.innerHTML = `
            <div class="pe-node-icon" style="background:${color}20;border-color:${color}">
                <svg class="icon icon-sm" style="color:${color}"><use href="#icon-${icon}"/></svg>
            </div>
            <span class="pe-node-label">${name}</span>
        `;
        div.addEventListener('mousedown', (e) => startDrag(e, i));
        div.addEventListener('click', (e) => { e.stopPropagation(); selectNode(i); });
        nodeLayer.appendChild(div);
    });

    // Render edges as SVG lines
    edgeLayer.innerHTML = '';
    edges.forEach(e => {
        const fromN = nodes.find(n => n.id === e.from);
        const toN = nodes.find(n => n.id === e.to);
        if (!fromN || !toN) return;
        const x1 = fromN.x + 40, y1 = fromN.y + 25;
        const x2 = toN.x + 40, y2 = toN.y + 25;
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', x1);
        line.setAttribute('y1', y1);
        line.setAttribute('x2', x2);
        line.setAttribute('y2', y2);
        line.setAttribute('stroke', e.type === 'conditional' ? '#f0883e' : '#8b949e');
        line.setAttribute('stroke-width', '2');
        line.setAttribute('marker-end', 'url(#arrowhead)');
        edgeLayer.appendChild(line);
    });

    // Update hidden fields
    document.getElementById('agents-json').value = JSON.stringify(nodes);
    document.getElementById('edges-json').value = JSON.stringify(edges);
    document.getElementById('agent-count').textContent = nodes.length + ' agents';
}

function addNode() {
    const id = 'n' + (nodes.length + 1) + '_' + Date.now().toString(36);
    nodes.push({id, agent_id: '', label: 'New Agent', x: 150 + nodes.length * 130, y: 180});
    render();
    selectNode(nodes.length - 1);
}

function removeNode(idx) {
    const nid = nodes[idx].id;
    edges = edges.filter(e => e.from !== nid && e.to !== nid);
    nodes.splice(idx, 1);
    selectedNode = null;
    showEmptyProps();
    render();
}

function selectNode(idx) {
    selectedNode = idx;
    render();
    showNodeProps(idx);
}

function deselectAll() {
    selectedNode = null;
    showEmptyProps();
    render();
}

function showEmptyProps() {
    document.getElementById('props-content').innerHTML =
        '<p class="text-secondary" style="padding:16px;font-size:13px;">Click an agent node to edit.</p>';
}

function showNodeProps(idx) {
    const n = nodes[idx];
    const agentOpts = AVAILABLE_AGENTS.map(a =>
        `<option value="${a.id}" ${a.id === n.agent_id ? 'selected' : ''}>${a.name} (${a.role})</option>`
    ).join('');
    const edgeTargets = nodes.filter((_, i) => i !== idx).map(t =>
        `<option value="${t.id}">${t.label}</option>`
    ).join('');

    const currentEdges = edges.filter(e => e.from === n.id).map(e => {
        const target = nodes.find(nn => nn.id === e.to);
        return `<div class="pe-edge-item">
            → ${target ? target.label : e.to}
            <span class="badge badge-blue">${e.type}</span>
            <button type="button" class="btn-icon btn-xs" onclick="removeEdge('${n.id}','${e.to}')">&times;</button>
        </div>`;
    }).join('');

    document.getElementById('props-content').innerHTML = `
        <div class="pe-prop-group">
            <label>Label</label>
            <input type="text" value="${n.label}" onchange="nodes[${idx}].label=this.value;render()">
        </div>
        <div class="pe-prop-group">
            <label>Agent</label>
            <select onchange="nodes[${idx}].agent_id=this.value;render()">
                <option value="">— Select agent —</option>
                ${agentOpts}
            </select>
        </div>
        <div class="pe-prop-group">
            <label>Connections</label>
            ${currentEdges || '<p class="text-secondary" style="font-size:12px;">No connections</p>'}
            <div style="display:flex;gap:4px;margin-top:8px;">
                <select id="new-edge-target" style="flex:1;">
                    <option value="">— Target —</option>
                    ${edgeTargets}
                </select>
                <select id="new-edge-type" style="width:100px;">
                    <option value="sequential">seq</option>
                    <option value="parallel">parallel</option>
                    <option value="conditional">cond</option>
                    <option value="delegation">deleg</option>
                    <option value="report">report</option>
                    <option value="bidirectional">bidir</option>
                </select>
                <button type="button" class="btn btn-sm btn-primary" onclick="addEdge('${n.id}')">+</button>
            </div>
        </div>
        <div style="margin-top:20px;padding-top:12px;border-top:1px solid var(--border)">
            <button type="button" class="btn btn-sm btn-danger" onclick="removeNode(${idx})">
                <svg class="icon icon-xs"><use href="#icon-trash"/></svg> Remove
            </button>
        </div>
    `;
}

function addEdge(fromId) {
    const target = document.getElementById('new-edge-target').value;
    const type = document.getElementById('new-edge-type').value;
    if (!target) return;
    if (edges.some(e => e.from === fromId && e.to === target)) return;
    edges.push({from: fromId, to: target, type});
    render();
    if (selectedNode !== null) showNodeProps(selectedNode);
}

function removeEdge(fromId, toId) {
    edges = edges.filter(e => !(e.from === fromId && e.to === toId));
    render();
    if (selectedNode !== null) showNodeProps(selectedNode);
}

// Drag nodes
function startDrag(e, idx) {
    dragNode = idx;
    const rect = nodeLayer.getBoundingClientRect();
    dragOff = {x: e.clientX - nodes[idx].x - rect.left, y: e.clientY - nodes[idx].y - rect.top};
    e.preventDefault();
}

document.addEventListener('mousemove', (e) => {
    if (dragNode === null) return;
    const rect = nodeLayer.getBoundingClientRect();
    nodes[dragNode].x = Math.max(0, e.clientX - rect.left - dragOff.x);
    nodes[dragNode].y = Math.max(0, e.clientY - rect.top - dragOff.y);
    render();
});

document.addEventListener('mouseup', () => { dragNode = null; });

// Click on canvas to deselect
canvas.addEventListener('click', deselectAll);

// SVG arrow marker
const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
defs.innerHTML = `<marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
    <polygon points="0 0, 10 3.5, 0 7" fill="#8b949e"/>
</marker>`;
canvas.insertBefore(defs, canvas.firstChild);

// Initial render
render();
</script>
{% endblock %}
