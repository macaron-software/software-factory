{% extends "base.html" %}

{% block topbar_actions %}
<div style="display:flex;align-items:center;gap:12px;">
    <a href="/sessions/{{ session.id }}/live" class="btn btn-sm" style="background:var(--accent-purple);color:#fff;">
        <svg class="icon icon-sm"><use href="#icon-share"/></svg> Live View
    </a>
    <span class="badge {% if session.status == 'active' %}badge-green{% elif session.status == 'completed' %}badge-blue{% elif session.status == 'failed' %}badge-red{% else %}badge-yellow{% endif %}">
        {{ session.status }}
    </span>
    {% if session.status == 'active' %}
    <button class="btn btn-sm btn-danger"
            hx-post="/api/sessions/{{ session.id }}/stop"
            hx-swap="none"
            hx-on::after-request="location.reload()">
        <svg class="icon icon-sm"><use href="#icon-stop"/></svg> Stop
    </button>
    {% elif session.status in ('completed', 'failed', 'interrupted') %}
    <button class="btn btn-sm" style="background:var(--purple);color:#fff;"
            hx-post="/api/sessions/{{ session.id }}/resume"
            hx-swap="none"
            hx-on::after-request="location.reload()">
        <svg class="icon icon-sm"><use href="#icon-play"/></svg> Reprendre
    </button>
    {% endif %}
    <button class="btn btn-sm btn-danger"
            hx-delete="/api/sessions/{{ session.id }}"
            hx-confirm="Delete this session and all messages?"
            hx-on::after-request="window.location='/sessions'">
        <svg class="icon icon-sm"><use href="#icon-trash"/></svg>
    </button>
</div>
{% endblock %}

{% block content %}
<div class="conversation-layout">
    <!-- Main chat area -->
    <div class="conv-main">
        <div class="conv-header">
            <svg class="icon icon-sm"><use href="#icon-activity"/></svg>
            <strong>{{ session.name }}</strong>
        </div>

        <!-- Messages -->
        <div id="message-list" class="conv-messages">
            <div class="conv-date-separator"><span>Today</span></div>
            {% for msg in messages %}
            {% set msg_mode = 'chat' %}
            {% include "partials/msg_unified.html" %}
            {% endfor %}
        </div>

        <!-- Polling for new messages -->
        <div id="message-poll"
             hx-get="/api/sessions/{{ session.id }}/messages{% if messages %}?after={{ messages[-1].id }}{% endif %}"
             hx-trigger="every 2s"
             hx-target="#message-list"
             hx-swap="beforeend"
             hx-on::after-settle="scrollMessages()"></div>

        <!-- Input area -->
        {% if session.status in ('active', 'planning') %}
        {% if session.pattern_id %}
        <!-- Pattern execution bar -->
        <div class="conv-pattern-bar">
            <span class="badge badge-purple" style="margin-right:8px">
                <svg class="icon icon-xs"><use href="#icon-workflow"/></svg>
                {{ pattern_name or session.pattern_id }}
            </span>
            <form style="display:inline;flex:1"
                  hx-post="/api/sessions/{{ session.id }}/run-pattern"
                  hx-target="#message-list"
                  hx-swap="beforeend"
                  hx-on::after-settle="scrollMessages()">
                <input type="hidden" name="pattern_id" value="{{ session.pattern_id }}">
                <input type="text" name="task" value="{{ session.goal }}"
                       placeholder="Describe the task for the pattern…"
                       class="conv-pattern-input">
                <button type="submit" class="btn btn-sm" style="background:var(--purple-primary)">
                    <svg class="icon icon-sm"><use href="#icon-rocket"/></svg> Run
                </button>
            </form>
        </div>
        {% endif %}
        {% if session.config and session.config.get('workflow_id') %}
        <!-- Workflow execution bar -->
        <div class="conv-pattern-bar" style="border-color:var(--purple-primary)40">
            <span class="badge badge-purple" style="margin-right:8px">
                <svg class="icon icon-xs"><use href="#icon-rocket"/></svg>
                {{ workflow_name or session.config.get('workflow_id') }}
            </span>
            <form style="display:inline;flex:1"
                  hx-post="/api/sessions/{{ session.id }}/run-workflow"
                  hx-target="#message-list"
                  hx-swap="beforeend"
                  hx-on::after-settle="scrollMessages()">
                <input type="hidden" name="workflow_id" value="{{ session.config.get('workflow_id') }}">
                <input type="text" name="task" value="{{ session.goal }}"
                       placeholder="Describe the workflow task…"
                       class="conv-pattern-input">
                <button type="submit" class="btn btn-sm" style="background:var(--purple-primary)">
                    <svg class="icon icon-sm"><use href="#icon-rocket"/></svg> Workflow
                </button>
            </form>
        </div>
        {% endif %}
        <form class="conv-input"
              hx-post="/api/sessions/{{ session.id }}/messages"
              hx-target="#message-list"
              hx-swap="beforeend"
              hx-timeout="120000"
              hx-indicator="#msg-loading"
              hx-on::before-request="document.getElementById('msg-input').disabled=true"
              hx-on::after-request="this.reset();document.getElementById('msg-input').disabled=false;scrollMessages()"
              hx-on::after-settle="scrollMessages()">
            <button type="button" class="conv-attach-btn">
                <svg class="icon icon-sm"><use href="#icon-plug"/></svg>
            </button>
            <textarea name="content"
                      id="msg-input"
                      placeholder="Tapez un message…"
                      rows="1"
                      required></textarea>
            <button type="submit" class="conv-send-btn">
                <svg class="icon icon-sm"><use href="#icon-rocket"/></svg>
            </button>
            <div id="msg-loading" class="htmx-indicator msg-loading-indicator">
                <span class="loading-dots"><svg class="icon icon-xs"><use href="#icon-bot"/></svg> Agent réfléchit<span>.</span><span>.</span><span>.</span></span>
            </div>
        </form>
        {% else %}
        <div class="conv-input-disabled">
            Session {{ session.status }} — lecture seule
        </div>
        {% endif %}
    </div>

    <!-- Right panel: Logs & Pensées -->
    <aside class="conv-logs-panel">
        <div class="conv-logs-header">
            <svg class="icon icon-sm"><use href="#icon-activity"/></svg>
            <strong>Logs &amp; Pensées</strong>
            <span class="badge badge-green" style="margin-left:auto">Live</span>
        </div>

        <!-- Agents in session -->
        <div class="conv-logs-agents">
            {% for a in agents %}
            <div class="conv-log-agent-chip" style="border-color:{{ a.color }}">
                <span class="agent-status-dot active"></span>
                <span>{{ a.name }}</span>
            </div>
            {% endfor %}
        </div>

        <!-- Log entries -->
        <div id="log-entries" class="conv-log-entries">
            {% for msg in messages %}
            {% if msg.from_agent != 'user' %}
            <div class="conv-log-entry">
                <span class="conv-log-time">{{ msg.timestamp[11:16] if msg.timestamp|length > 16 else '' }}</span>
                <span class="conv-log-text">
                    <strong>{{ agent_map.get(msg.from_agent, {}).get('name', msg.from_agent) if agent_map is defined else msg.from_agent }}:</strong>
                    {{ msg.content[:80] }}{% if msg.content|length > 80 %}…{% endif %}
                </span>
                <div class="conv-log-tags">
                    {% if msg.message_type == 'veto' %}
                    <span class="log-tag log-tag-red">Veto</span>
                    {% elif msg.message_type == 'approval' %}
                    <span class="log-tag log-tag-green">Approval</span>
                    {% elif msg.message_type == 'delegation' %}
                    <span class="log-tag log-tag-purple">Delegation</span>
                    {% elif msg.message_type == 'code' or msg.message_type == 'artifact' %}
                    <span class="log-tag log-tag-blue">Code</span>
                    {% elif msg.message_type == 'instruction' %}
                    <span class="log-tag log-tag-yellow">Instruction</span>
                    {% else %}
                    <span class="log-tag log-tag-default">Message</span>
                    {% endif %}
                    {% for a_name in [msg.from_agent] %}
                    {% set ag = agent_map.get(a_name, {}) if agent_map is defined else {} %}
                    <span class="log-tag" style="background:{{ ag.get('color','#555') }}30;color:{{ ag.get('color','#999') }}">{{ ag.get('name', a_name)[:12] }}</span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            {% endfor %}
            {% if not messages %}
            <div class="conv-log-empty">En attente de messages…</div>
            {% endif %}
        </div>
    </aside>
</div>

<script>
function scrollMessages() {
    const el = document.getElementById('message-list');
    if (el) el.scrollTop = el.scrollHeight;
}
document.addEventListener('DOMContentLoaded', scrollMessages);

const input = document.getElementById('msg-input');
if (input) {
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            this.closest('form').requestSubmit();
        }
    });
    input.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 150) + 'px';
    });
}

const observer = new MutationObserver(function() {
    const msgs = document.querySelectorAll('#message-list .message-bubble');
    if (msgs.length > 0) {
        const lastId = msgs[msgs.length - 1].dataset.msgId;
        if (lastId) {
            document.getElementById('message-poll')
                .setAttribute('hx-get', '/api/sessions/{{ session.id }}/messages?after=' + lastId);
            htmx.process(document.getElementById('message-poll'));
        }
    }
});
const ml = document.getElementById('message-list');
if (ml) observer.observe(ml, {childList: true});

// SSE live events for this session
(function() {
    const sessionId = '{{ session.id }}';
    const agentMap = {{ agent_map | tojson if agent_map is defined else '{}' }};
    let es = null;

    function connectSSE() {
        es = new EventSource('/api/sessions/' + sessionId + '/sse');
        es.onmessage = function(e) {
            try {
                const data = JSON.parse(e.data);
                if (data.type === 'agent_status') {
                    // Update agent chip
                    const chips = document.querySelectorAll('.conv-log-agent-chip');
                    chips.forEach(chip => {
                        if (chip.textContent.trim().includes(agentMap[data.agent_id]?.name || data.agent_id)) {
                            const dot = chip.querySelector('.agent-status-dot');
                            if (dot) {
                                dot.className = 'agent-status-dot ' +
                                    (data.status === 'thinking' ? 'thinking' : 'active');
                            }
                        }
                    });
                    // Show typing indicator
                    if (data.status === 'thinking') {
                        showTyping(data.agent_id);
                    } else {
                        hideTyping();
                    }
                } else if (data.type === 'pattern_start' || data.type === 'pattern_end') {
                    // Add log entry
                    addLogEntry(data.type === 'pattern_start'
                        ? '> ' + (data.pattern_name || 'Pattern') + ' started'
                        : (data.success ? '<svg class="icon icon-xs"><use href="#icon-check"/></svg> Pattern completed' : '<svg class="icon icon-xs"><use href="#icon-stop"/></svg> Pattern failed'));
                } else if (data.type === 'stream_start') {
                    hideTyping();
                    // Create streaming bubble
                    const name = agentMap[data.agent_id]?.name || data.agent_name || data.agent_id;
                    const color = agentMap[data.agent_id]?.color || '#8b949e';
                    const div = document.createElement('div');
                    div.className = 'mu mu--chat mu--agent';
                    div.id = 'stream-' + data.agent_id;
                    div.innerHTML = '<div class="mu__avatar" style="background:' + color + '20;border-color:' + color + '">' +
                        '<svg class="icon icon-sm" style="color:' + color + '"><use href="#icon-bot"/></svg></div>' +
                        '<div class="mu__bubble mu__bubble--agent"><div class="mu__sender">' +
                        '<span class="mu__name" style="color:' + color + '">' + name + '</span></div>' +
                        '<div class="mu__content md-rendered" id="stream-content-' + data.agent_id + '">●●●</div></div>';
                    document.getElementById('message-list').appendChild(div);
                    scrollMessages();
                } else if (data.type === 'stream_delta' && data.agent_id) {
                    const el = document.getElementById('stream-content-' + data.agent_id);
                    if (el) {
                        if (el.textContent === '●●●') el.textContent = '';
                        el.textContent += data.delta;
                        scrollMessages();
                    }
                } else if (data.type === 'stream_end' && data.agent_id) {
                    hideTyping();
                    const el = document.getElementById('stream-content-' + data.agent_id);
                    if (el && data.content) {
                        el.innerHTML = data.content.replace(/@(\w[\w\s]*?)(?=[\s,.:!?]|$)/g,
                            '<span style="color:var(--purple);font-weight:600">@$1</span>');
                    }
                    scrollMessages();
                }
            } catch(err) {}
        };
        es.onerror = function() {
            es.close();
            setTimeout(connectSSE, 5000);
        };
    }

    function showTyping(agentId) {
        let el = document.getElementById('typing-indicator');
        if (!el) {
            el = document.createElement('div');
            el.id = 'typing-indicator';
            el.className = 'typing-indicator';
            document.getElementById('message-list').appendChild(el);
        }
        const name = agentMap[agentId]?.name || agentId;
        const color = agentMap[agentId]?.color || '#8b949e';
        el.innerHTML = '<span style="color:' + color + '">' + name + '</span> is thinking<span class="typing-dots"><span>.</span><span>.</span><span>.</span></span>';
        el.style.display = 'block';
        scrollMessages();
    }

    function hideTyping() {
        const el = document.getElementById('typing-indicator');
        if (el) el.style.display = 'none';
    }

    function addLogEntry(text) {
        const logs = document.getElementById('log-entries');
        if (!logs) return;
        const d = document.createElement('div');
        d.className = 'conv-log-entry';
        d.innerHTML = '<span class="conv-log-time">' + new Date().toTimeString().slice(0,5) + '</span>' +
                       '<span class="conv-log-text"><strong>System:</strong> ' + text + '</span>';
        logs.appendChild(d);
    }

    if (typeof EventSource !== 'undefined') {
        connectSSE();
    }
})();
</script>
{% endblock %}
