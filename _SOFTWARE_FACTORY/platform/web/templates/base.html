<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
    <script>document.documentElement.setAttribute('data-theme', localStorage.getItem('macaron_theme') || 'dark')</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title }} — Macaron Agent Platform</title>
    <link rel="stylesheet" href="/static/css/main.css?v=20260220b">
    <link rel="stylesheet" href="/static/css/components.css?v=20260220">
    <link rel="stylesheet" href="/static/css/agents.css?v=20260220">
    <link rel="stylesheet" href="/static/css/projects.css?v=20260220">
    <script src="/static/js/htmx.min.js"></script>
    <script src="/static/js/sse.js" defer></script>
</head>
<body>
    {% include "partials/svg_sprites.html" %}
    <div class="layout">
        <!-- Sidebar (icon-only) -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h1 class="logo"><svg class="icon icon-logo"><use href="#icon-macaron"/></svg></h1>
            </div>

            <div class="sidebar-section">
                <ul class="nav-links">
                    <li><a href="/" data-tooltip="Portfolio" data-views="strategy,all" class="{% if page_title in ('Portfolio', 'Projects', 'DSI Board', 'Vue Métier') %}active{% endif %}">
                        <svg class="icon"><use href="#icon-home"/></svg>
                    </a></li>
                    <li><a href="/backlog" data-tooltip="Backlog" data-views="strategy,all" class="{% if page_title in ('Backlog', 'Product', 'Idéation') %}active{% endif %}">
                        <svg class="icon"><use href="#icon-layers"/></svg>
                    </a></li>
                    <li><a href="/product-line" data-tooltip="Ligne de Produit" data-views="strategy,all" class="{% if page_title == 'Ligne de Produit' %}active{% endif %}">
                        <svg class="icon"><use href="#icon-briefcase"/></svg>
                    </a></li>
                    <li><a href="/pi" data-tooltip="PI Board" data-views="strategy,all" class="{% if page_title in ('PI Board', 'Program Increment', 'Epics', 'Epic', 'Epic Control') %}active{% endif %}">
                        <svg class="icon"><use href="#icon-rocket"/></svg>
                    </a></li>
                    <li><a href="/ceremonies" data-tooltip="Ceremonies" data-views="engineering,all" class="{% if page_title in ('Ceremonies', 'Workflows', 'Patterns') %}active{% endif %}">
                        <svg class="icon"><use href="#icon-workflow"/></svg>
                    </a></li>
                    <li><a href="/live" data-tooltip="Live" data-views="engineering,all" class="{% if page_title in ('Live', 'Sessions') %}active{% endif %}">
                        <svg class="icon"><use href="#icon-message-circle"/></svg>
                    </a></li>
                    <li><a href="/art" data-tooltip="ART" data-views="engineering,all" class="{% if page_title in ('ART', 'Agents', 'Organisation SAFe', 'Team Generator') %}active{% endif %}">
                        <svg class="icon"><use href="#icon-users"/></svg>
                    </a></li>
                    <li><a href="/toolbox" data-tooltip="Toolbox" data-views="engineering" class="{% if page_title in ('Toolbox', 'Skills', 'Memory', 'MCPs') %}active{% endif %}">
                        <svg class="icon"><use href="#icon-plug"/></svg>
                    </a></li>
                    <li><a href="/design-system" data-tooltip="Design System" data-views="engineering" class="{% if page_title == 'Design System' %}active{% endif %}">
                        <svg class="icon"><use href="#icon-palette"/></svg>
                    </a></li>
                    <li><a href="/world" data-tooltip="World 3D" data-views="engineering,all" class="{% if page_title == 'World' %}active{% endif %}">
                        <svg class="icon"><use href="#icon-globe"/></svg>
                    </a></li>
                    <li><a href="/metrics" data-tooltip="Metrics" data-views="strategy,all" class="{% if page_title == 'Metrics' %}active{% endif %}">
                        <svg class="icon"><use href="#icon-chart"/></svg>
                    </a></li>
                    <li><a href="/monitoring" data-tooltip="Monitoring" data-views="engineering,all" class="{% if page_title == 'Monitoring' %}active{% endif %}">
                        <svg class="icon"><use href="#icon-activity"/></svg>
                    </a></li>
                </ul>
            </div>

            <div class="sidebar-section" style="margin-top: auto">
                <!-- Theme toggle -->
                <div class="sidebar-view-switch" style="margin-bottom:0.2rem">
                    <button class="view-switch-btn theme-toggle-btn" id="themeToggle" title="Changer le theme">
                        <svg class="icon icon-xs theme-icon-sun"><use href="#icon-sun"/></svg>
                        <svg class="icon icon-xs theme-icon-moon"><use href="#icon-moon"/></svg>
                    </button>
                </div>
                <!-- View mode switcher -->
                <div class="sidebar-view-switch">
                    <button class="view-switch-btn" data-mode="all" title="All">
                        <svg class="icon icon-xs"><use href="#icon-grid"/></svg>
                    </button>
                    <button class="view-switch-btn" data-mode="strategy" title="Strategy">
                        <svg class="icon icon-xs"><use href="#icon-layers"/></svg>
                    </button>
                    <button class="view-switch-btn" data-mode="engineering" title="Engineering">
                        <svg class="icon icon-xs"><use href="#icon-settings"/></svg>
                    </button>
                </div>
                <ul class="nav-links">
                    <li><a href="/settings" data-tooltip="Settings" class="{% if page_title == 'Settings' %}active{% endif %}">
                        <svg class="icon"><use href="#icon-settings"/></svg>
                    </a></li>
                </ul>
            </div>

            <div class="sidebar-footer">
                <span class="status-dot active"></span>
            </div>
        </nav>

        <!-- Main content -->
        <main class="content">
            <header class="topbar">
                <h2>{{ page_title }}</h2>
                <div class="topbar-right">
                    {% block topbar_actions %}{% endblock %}
                    <button class="topbar-bell">
                        <svg class="icon icon-sm"><use href="#icon-activity"/></svg>
                    </button>
                    <div class="topbar-avatar">S</div>
                </div>
            </header>
            <div class="main-area">
                {% block content %}{% endblock %}
            </div>
        </main>
    </div>

    <style>
    .sidebar-view-switch{display:flex;justify-content:center;gap:2px;padding:0.3rem 0.4rem;margin:0 0.3rem 0.3rem;background:var(--bg-tertiary);border-radius:8px}
    .view-switch-btn{background:none;border:none;color:var(--text-secondary);padding:0.3rem;border-radius:6px;cursor:pointer;transition:all .12s;display:flex;align-items:center;justify-content:center}
    .view-switch-btn:hover{color:var(--text-primary);background:var(--bg-secondary)}
    .view-switch-btn.active{color:#fff;background:var(--purple)}
    .nav-links li.view-hidden{display:none}
    /* Theme toggle */
    .theme-toggle-btn{position:relative;width:28px;height:28px;overflow:hidden}
    .theme-icon-sun,.theme-icon-moon{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);transition:opacity .2s,transform .3s}
    [data-theme="dark"] .theme-icon-sun{opacity:1;transform:translate(-50%,-50%) rotate(0deg)}
    [data-theme="dark"] .theme-icon-moon{opacity:0;transform:translate(-50%,-50%) rotate(90deg)}
    [data-theme="light"] .theme-icon-sun{opacity:0;transform:translate(-50%,-50%) rotate(-90deg)}
    [data-theme="light"] .theme-icon-moon{opacity:1;transform:translate(-50%,-50%) rotate(0deg)}
    </style>
    <script>
    /* Theme toggle (light/dark) — persists in localStorage */
    (function(){
      const html = document.documentElement;
      const saved = localStorage.getItem('macaron_theme') || 'dark';
      html.setAttribute('data-theme', saved);

      document.getElementById('themeToggle')?.addEventListener('click', function(){
        const next = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        html.setAttribute('data-theme', next);
        localStorage.setItem('macaron_theme', next);
      });
    })();
    </script>
    <script>
    (function(){
      // Auto-detect view from current page
      const PAGE_VIEW_MAP = {
        'Portfolio': 'strategy',
        'Backlog': 'strategy',
        'PI Board': 'strategy',
        'Metrics': 'strategy',
        'Ceremonies': 'engineering',
        'Live': 'engineering',
        'ART': 'engineering',
        'Toolbox': 'engineering',
      };
      const pageTitle = document.querySelector('.topbar h2')?.textContent?.trim() || '';
      const autoView = PAGE_VIEW_MAP[pageTitle] || null;
      const savedView = localStorage.getItem('sidebar_view') || 'all';
      const currentView = autoView || savedView;

      function applyView(mode){
        localStorage.setItem('sidebar_view', mode);
        // Toggle nav items
        document.querySelectorAll('.nav-links a[data-views]').forEach(a=>{
          const views = a.dataset.views.split(',');
          const show = mode === 'all' || views.includes(mode) || views.includes('all');
          a.closest('li').classList.toggle('view-hidden', !show);
        });
        // Toggle active button
        document.querySelectorAll('.view-switch-btn').forEach(b=>{
          b.classList.toggle('active', b.dataset.mode === mode);
        });
      }

      // Init
      applyView(currentView);

      // Click handlers
      document.querySelectorAll('.view-switch-btn').forEach(btn=>{
        btn.addEventListener('click', ()=> applyView(btn.dataset.mode));
      });
    })();
    </script>

    <script src="/static/js/workspace.js" defer></script>
    {% block scripts %}{% endblock %}
</body>
</html>
