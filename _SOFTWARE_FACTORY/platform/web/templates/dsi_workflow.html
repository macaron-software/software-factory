{% extends "base.html" %}

{% block topbar_actions %}
<a href="/dsi" class="btn btn-ghost"><svg class="icon icon-sm"><use href="#icon-arrow-left"/></svg> DSI Board</a>
{% if session_id %}
<a href="/sessions/{{ session_id }}/live" class="btn btn-primary">
    <svg class="icon icon-sm"><use href="#icon-activity"/></svg> Vue Live
</a>
{% endif %}
{% endblock %}

{% block content %}
<style>
/* â”€â”€ Phase Timeline â”€â”€ */
.wf-phases{display:flex;align-items:flex-start;gap:0;margin-bottom:1.5rem;position:relative;overflow-x:auto}
.wf-phase{flex:1;min-width:200px;position:relative}
.wf-phase-bar{display:flex;align-items:center;gap:0.5rem;padding:0.6rem 1rem;background:var(--bg-secondary);border:1px solid var(--border);cursor:pointer;transition:all .2s}
.wf-phase:first-child .wf-phase-bar{border-radius:var(--radius) 0 0 var(--radius)}
.wf-phase:last-child .wf-phase-bar{border-radius:0 var(--radius) var(--radius) 0}
.wf-phase.active .wf-phase-bar{background:rgba(124,58,237,.12);border-color:var(--purple)}
.wf-phase.done .wf-phase-bar{background:rgba(52,211,153,.08);border-color:var(--green)}
.wf-phase.waiting .wf-phase-bar{opacity:.5}
.wf-phase-num{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.72rem;font-weight:700;flex-shrink:0;border:2px solid var(--border);color:var(--text-secondary);background:var(--bg-tertiary)}
.wf-phase.active .wf-phase-num{border-color:var(--purple);color:var(--purple);background:rgba(124,58,237,.15);animation:pulseDot 2s ease infinite}
.wf-phase.done .wf-phase-num{border-color:var(--green);color:#fff;background:var(--green)}
@keyframes pulseDot{0%,100%{box-shadow:0 0 0 0 rgba(124,58,237,.3)}50%{box-shadow:0 0 0 6px rgba(124,58,237,0)}}
.wf-phase-info{flex:1;min-width:0}
.wf-phase-name{font-size:0.78rem;font-weight:700;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.wf-phase-pattern{font-size:0.62rem;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.5px}
.wf-phase-arrow{position:absolute;right:-8px;top:50%;transform:translateY(-50%);z-index:2;color:var(--border);font-size:1.2rem}
.wf-phase.active .wf-phase-arrow{color:var(--purple)}
.wf-phase.done .wf-phase-arrow{color:var(--green)}

/* â”€â”€ Phase Detail Panel â”€â”€ */
.wf-detail{display:grid;grid-template-columns:1fr 1fr;gap:1.2rem;margin-bottom:1.2rem}
@media(max-width:1000px){.wf-detail{grid-template-columns:1fr}}

.wf-panel{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.wf-panel-header{display:flex;align-items:center;justify-content:space-between;padding:0.7rem 0.9rem;border-bottom:1px solid var(--border)}
.wf-panel-title{font-size:0.82rem;font-weight:700;display:flex;align-items:center;gap:0.4rem}
.wf-panel-title svg{width:15px;height:15px;color:var(--purple)}
.wf-panel-body{padding:0.6rem 0.9rem;max-height:500px;overflow-y:auto}

/* â”€â”€ Agent Cards in Phase â”€â”€ */
.wf-agent-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:0.5rem}
.wf-agent-card{display:flex;align-items:center;gap:0.6rem;padding:0.5rem 0.65rem;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:border-color .15s}
.wf-agent-card:hover{border-color:var(--purple)}
.wf-agent-card.leader{border-left:3px solid var(--purple)}
.wf-agent-photo{width:36px;height:36px;border-radius:50%;object-fit:cover;flex-shrink:0}
.wf-agent-name{font-size:0.78rem;font-weight:600}
.wf-agent-role{font-size:0.65rem;color:var(--text-secondary)}
.wf-agent-status{margin-left:auto;width:8px;height:8px;border-radius:50%;flex-shrink:0}
.wf-agent-status.idle{background:var(--text-muted)}
.wf-agent-status.thinking{background:var(--yellow);animation:pulseDot 1.5s ease infinite}
.wf-agent-status.done{background:var(--green)}

/* â”€â”€ Deliverables â”€â”€ */
.wf-deliverable{display:flex;align-items:center;gap:0.5rem;padding:0.35rem 0;font-size:0.76rem}
.wf-deliverable-check{width:16px;height:16px;border-radius:4px;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.wf-deliverable-check.done{background:var(--green);border-color:var(--green);color:#fff}
.wf-deliverable-check.done::after{content:'âœ“';font-size:0.65rem}

/* â”€â”€ Messages Feed â€” uses unified .mu--compact from components.css â”€â”€ */

/* â”€â”€ Graph SVG â”€â”€ */
.wf-graph-container{position:relative;min-height:540px}
.wf-graph-container svg{width:100%;height:540px}
.wf-graph-phase-label{font-size:11px;fill:var(--text-muted);text-transform:uppercase;letter-spacing:1px;font-weight:600}
.wf-graph-phase-bg{rx:8;ry:8;fill:rgba(124,58,237,.04);stroke:var(--border);stroke-dasharray:4 4}

/* â”€â”€ Start Button â”€â”€ */
.wf-start-bar{display:flex;align-items:center;gap:1rem;padding:0.8rem 1rem;background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:1.2rem}
.wf-start-info{flex:1;font-size:0.78rem;color:var(--text-secondary)}
.wf-start-info strong{color:var(--text-primary)}
</style>

<!-- Start/Status Bar -->
<div class="wf-start-bar">
    <svg class="icon" style="color:var(--purple)"><use href="#icon-workflow"/></svg>
    <div class="wf-start-info">
        <strong>{{ workflow.name }}</strong> â€” {{ workflow.description }}
        {% if session %}
        <br><span style="font-size:0.68rem">Session active: <a href="/sessions/{{ session.id }}/live" style="color:var(--purple)">{{ session.name }}</a> Â· Phase {{ current_phase_idx + 1 }}/{{ phases|length }}</span>
        {% endif %}
    </div>
    {% if not session %}
    <form method="POST" action="/api/dsi/workflow/{{ workflow.id }}/start" style="margin:0">
        <button type="submit" class="btn btn-primary">
            <svg class="icon icon-sm"><use href="#icon-play"/></svg> Lancer Phase 1
        </button>
    </form>
    {% elif current_phase and current_phase.id != phases[-1].id %}
    <form method="POST" action="/api/dsi/workflow/{{ workflow.id }}/next-phase" style="margin:0">
        <input type="hidden" name="session_id" value="{{ session.id }}">
        <button type="submit" class="btn btn-primary">
            <svg class="icon icon-sm"><use href="#icon-skip-forward"/></svg> Phase suivante
        </button>
    </form>
    {% endif %}
</div>

<!-- Phase Timeline -->
<div class="wf-phases">
    {% for p in phases %}
    <div class="wf-phase {{ 'done' if p.status == 'done' else ('active' if p.status == 'active' else 'waiting') }}"
         onclick="selectPhase({{ loop.index0 }})" data-idx="{{ loop.index0 }}">
        <div class="wf-phase-bar">
            <div class="wf-phase-num">
                {% if p.status == 'done' %}âœ“{% else %}{{ loop.index }}{% endif %}
            </div>
            <div class="wf-phase-info">
                <div class="wf-phase-name">{{ p.name }}</div>
                <div class="wf-phase-pattern">{{ p.pattern_id }} Â· {{ p.agents|length }} agents</div>
            </div>
        </div>
        {% if not loop.last %}
        <div class="wf-phase-arrow">â€º</div>
        {% endif %}
    </div>
    {% endfor %}
</div>

<!-- Phase Detail: agents + deliverables | messages feed -->
<div class="wf-detail">
    <!-- Left: Phase Info -->
    <div>
        <!-- Agents in current phase -->
        <div class="wf-panel" style="margin-bottom:1.2rem">
            <div class="wf-panel-header">
                <div class="wf-panel-title">
                    <svg><use href="#icon-users"/></svg>
                    <span id="phaseAgentsTitle">Ã‰quipe Phase {{ current_phase_idx + 1 }}</span>
                </div>
                <span style="font-size:0.65rem;color:var(--text-secondary)" id="phasePatternBadge">{{ current_phase.pattern_id if current_phase else '' }}</span>
            </div>
            <div class="wf-panel-body">
                <div class="wf-agent-grid" id="phaseAgents">
                    {% for a in phase_agents %}
                    <div class="wf-agent-card {{ 'leader' if a.is_leader else '' }}" onclick="showAgentPopover(event, '{{ a.id }}')">
                        {% if a.avatar_url %}
                        <img class="wf-agent-photo" src="{{ a.avatar_url }}" alt="{{ a.name }}">
                        {% else %}
                        <div class="wf-agent-photo" style="background:{{ a.color }}20;display:flex;align-items:center;justify-content:center;border:1px solid {{ a.color }}40">
                            <svg class="icon icon-xs" style="color:{{ a.color }}"><use href="#icon-user"/></svg>
                        </div>
                        {% endif %}
                        <div>
                            <div class="wf-agent-name">{{ a.name }}{% if a.is_leader %} ðŸ‘‘{% endif %}</div>
                            <div class="wf-agent-role">{{ a.role }}</div>
                        </div>
                        <div class="wf-agent-status {{ a.status or 'idle' }}"></div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Deliverables -->
        <div class="wf-panel">
            <div class="wf-panel-header">
                <div class="wf-panel-title"><svg><use href="#icon-check-circle"/></svg> Livrables</div>
            </div>
            <div class="wf-panel-body" id="phaseDeliverables">
                {% for d in deliverables %}
                <div class="wf-deliverable">
                    <div class="wf-deliverable-check {{ 'done' if d.done else '' }}"></div>
                    <span>{{ d.label }}</span>
                </div>
                {% endfor %}
                {% if not deliverables %}
                <div style="text-align:center;color:var(--text-muted);padding:1rem;font-size:0.75rem">
                    Lancez le workflow pour voir les livrables
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Right: Messages Feed -->
    <div class="wf-panel">
        <div class="wf-panel-header">
            <div class="wf-panel-title"><svg><use href="#icon-message-circle"/></svg> Ã‰changes & DÃ©cisions</div>
            <span style="font-size:0.65rem;color:var(--text-secondary)">{{ messages|length }} messages</span>
        </div>
        <div class="wf-panel-body" id="messagesFeed" style="max-height:600px">
            {% set msg_mode = 'compact' %}
            {% for msg in messages %}
            {% include "partials/msg_unified.html" %}
            {% else %}
            <div style="text-align:center;color:var(--text-muted);padding:2rem;font-size:0.78rem">
                <svg class="icon" style="color:var(--purple);margin-bottom:0.5rem;width:32px;height:32px"><use href="#icon-message-circle"/></svg>
                <div>Les Ã©changes entre agents apparaÃ®tront ici</div>
                <div style="font-size:0.68rem;margin-top:0.3rem">Lancez le workflow pour dÃ©marrer la collaboration</div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Full Graph -->
<div class="wf-panel">
    <div class="wf-panel-header">
        <div class="wf-panel-title"><svg><use href="#icon-share"/></svg> Graphe d'Organisation</div>
        <div style="display:flex;gap:0.6rem;font-size:0.62rem;color:var(--text-secondary)">
            <span>ðŸŸ£ Cadrage</span>
            <span>ðŸ”µ Architecture</span>
            <span>ðŸŸ¡ Sprint</span>
            <span>ðŸŸ¢ Delivery</span>
        </div>
    </div>
    <div class="wf-graph-container">
        <svg viewBox="0 0 850 560" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <marker id="arrowP" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
                    <path d="M0,0 L8,3 L0,6" fill="var(--purple)" opacity="0.6"/>
                </marker>
                <marker id="arrowB" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
                    <path d="M0,0 L8,3 L0,6" fill="var(--blue)" opacity="0.6"/>
                </marker>
                <marker id="arrowG" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
                    <path d="M0,0 L8,3 L0,6" fill="var(--green)" opacity="0.6"/>
                </marker>
            </defs>

            <!-- Phase background bands -->
            <rect class="wf-graph-phase-bg" x="10" y="10" width="830" height="85" style="fill:rgba(168,85,247,.04)"/>
            <text class="wf-graph-phase-label" x="20" y="28" style="fill:var(--purple)">Phase 1 Â· Cadrage</text>

            <rect class="wf-graph-phase-bg" x="10" y="105" width="830" height="85" style="fill:rgba(59,130,246,.04)"/>
            <text class="wf-graph-phase-label" x="20" y="123" style="fill:var(--blue)">Phase 2 Â· Architecture</text>

            <rect class="wf-graph-phase-bg" x="10" y="200" width="830" height="85" style="fill:rgba(245,158,11,.04)"/>
            <text class="wf-graph-phase-label" x="20" y="218" style="fill:var(--yellow)">Phase 3 Â· Sprint</text>

            <rect class="wf-graph-phase-bg" x="10" y="295" width="830" height="85" style="fill:rgba(52,211,153,.04)"/>
            <text class="wf-graph-phase-label" x="20" y="313" style="fill:var(--green)">Phase 4 Â· Delivery</text>

            <!-- Edges -->
            {% for e in graph_edges %}
            <line x1="{{ e.x1 }}" y1="{{ e.y1 }}" x2="{{ e.x2 }}" y2="{{ e.y2 }}"
                  stroke="{{ e.color }}" stroke-width="1.5" stroke-opacity="0.35"
                  marker-end="url(#arrow{{ 'P' if '#a8' in e.color or '#8b' in e.color else ('G' if '#34' in e.color else 'B') }})"/>
            {% endfor %}

            <!-- Nodes -->
            {% for n in graph_nodes %}
            <g class="graph-node" data-agent="{{ n.agent_id }}" style="cursor:pointer"
               onclick="showAgentPopover(event, '{{ n.agent_id }}')">
                {% if n.avatar_url %}
                <clipPath id="clip-{{ n.id }}"><circle cx="{{ n.x }}" cy="{{ n.y }}" r="18"/></clipPath>
                <circle cx="{{ n.x }}" cy="{{ n.y }}" r="20" fill="none" stroke="{{ n.phase_color }}" stroke-width="2.5"
                        {% if n.is_active %}stroke-dasharray="4 2" class="node-pulse"{% endif %}/>
                <image href="{{ n.avatar_url }}" x="{{ n.x - 18 }}" y="{{ n.y - 18 }}" width="36" height="36"
                       clip-path="url(#clip-{{ n.id }})"/>
                {% else %}
                <circle cx="{{ n.x }}" cy="{{ n.y }}" r="20" fill="{{ n.phase_color }}15" stroke="{{ n.phase_color }}" stroke-width="2"/>
                <text x="{{ n.x }}" y="{{ n.y + 4 }}" text-anchor="middle" fill="{{ n.phase_color }}" font-size="11" font-weight="600">{{ n.label[:3] }}</text>
                {% endif %}
                <text x="{{ n.x }}" y="{{ n.y + 32 }}" text-anchor="middle" fill="var(--text-secondary)" font-size="10">{{ n.label }}</text>
            </g>
            {% endfor %}

            <style>
                .node-pulse{animation:nodePulse 2s ease infinite}
                @keyframes nodePulse{0%,100%{stroke-opacity:1}50%{stroke-opacity:.4}}
            </style>
        </svg>
    </div>
</div>

<!-- Agent Popover -->
<div class="agent-popover-overlay" id="agentOverlay" onclick="closeAgentPopover()"></div>
<div class="agent-popover" id="agentPopover" style="display:none">
    <button class="agent-popover-close" onclick="closeAgentPopover()" style="position:absolute;top:0.5rem;right:0.5rem;background:none;border:none;color:var(--text-secondary);cursor:pointer;padding:0.3rem">
        <svg class="icon icon-sm"><use href="#icon-x"/></svg>
    </button>
    <div id="popHeader" style="padding:1rem;display:flex;align-items:center;gap:0.8rem;border-bottom:1px solid var(--border)"></div>
    <div id="popBody" style="padding:0.8rem 1rem;font-size:0.76rem;color:var(--text-secondary);line-height:1.5;max-height:320px;overflow-y:auto"></div>
</div>

<style>
.agent-popover-overlay{position:fixed;inset:0;z-index:999;display:none}
.agent-popover-overlay.open{display:block}
.agent-popover{position:fixed;z-index:1000;width:340px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 12px 40px rgba(0,0,0,.45);overflow:hidden;animation:popIn .15s ease}
@keyframes popIn{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}
</style>

<script>
const allAgents = {{ all_agents_json | tojson }};

function esc(s){ const d=document.createElement('div'); d.textContent=s||''; return d.innerHTML; }

function showAgentPopover(ev, agentId) {
    ev.stopPropagation();
    const a = allAgents[agentId];
    if (!a) return;
    const pop = document.getElementById('agentPopover');
    const overlay = document.getElementById('agentOverlay');
    const photo = a.avatar_url
        ? `<img style="width:52px;height:52px;border-radius:50%;object-fit:cover;border:2px solid var(--purple)" src="${a.avatar_url}" alt="${esc(a.name)}">`
        : `<div style="width:52px;height:52px;border-radius:50%;background:${a.color||'#7c3aed'}20;border:2px solid ${a.color||'#7c3aed'};display:flex;align-items:center;justify-content:center"><svg class="icon" style="color:${a.color||'#7c3aed'}"><use href="#icon-user"/></svg></div>`;
    document.getElementById('popHeader').innerHTML = `${photo}<div>
        <div style="font-size:0.95rem;font-weight:700">${esc(a.name)}</div>
        <div style="font-size:0.72rem;color:var(--text-secondary)">${esc(a.role)}</div>
        ${a.tagline ? `<div style="font-size:0.7rem;color:var(--purple);font-style:italic;margin-top:2px">${esc(a.tagline)}</div>` : ''}
    </div>`;
    let html = '';
    if (a.description) html += `<div>${esc(a.description)}</div>`;
    if (a.persona) html += `<div style="margin-top:0.5rem"><div style="font-size:0.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text-secondary);margin-bottom:0.25rem">Persona</div><div style="white-space:pre-line">${esc(a.persona)}</div></div>`;
    if (a.motivation) html += `<div style="margin-top:0.5rem"><div style="font-size:0.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text-secondary);margin-bottom:0.25rem">Motivation</div><div style="white-space:pre-line">${esc(a.motivation)}</div></div>`;
    if (a.skills?.length) html += `<div style="margin-top:0.5rem"><div style="font-size:0.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text-secondary);margin-bottom:0.25rem">Skills</div><div style="display:flex;flex-wrap:wrap;gap:3px">${a.skills.map(s=>`<span style="padding:0.12rem 0.35rem;border-radius:3px;font-size:0.62rem;background:rgba(124,58,237,.12);color:var(--purple)">${esc(s)}</span>`).join('')}</div></div>`;
    if (a.tools?.length) html += `<div style="margin-top:0.5rem"><div style="font-size:0.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text-secondary);margin-bottom:0.25rem">Tools</div><div style="display:flex;flex-wrap:wrap;gap:3px">${a.tools.map(t=>`<span style="padding:0.12rem 0.35rem;border-radius:3px;font-size:0.62rem;background:rgba(59,130,246,.12);color:var(--blue)">${esc(t)}</span>`).join('')}</div></div>`;
    document.getElementById('popBody').innerHTML = html;
    pop.style.display = 'block';
    const rect = ev.currentTarget.getBoundingClientRect ? ev.currentTarget.getBoundingClientRect() : {bottom: ev.clientY, left: ev.clientX, top: ev.clientY};
    let top = rect.bottom + 8, left = rect.left;
    if (top + 350 > window.innerHeight) top = rect.top - 360;
    if (left + 340 > window.innerWidth) left = window.innerWidth - 350;
    pop.style.top = Math.max(10, top) + 'px';
    pop.style.left = Math.max(10, left) + 'px';
    overlay.classList.add('open');
}
function closeAgentPopover() {
    document.getElementById('agentPopover').style.display = 'none';
    document.getElementById('agentOverlay').classList.remove('open');
}
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeAgentPopover(); });

function selectPhase(idx) {
    document.querySelectorAll('.wf-phase').forEach(p => p.classList.remove('selected'));
    document.querySelector(`.wf-phase[data-idx="${idx}"]`)?.classList.add('selected');
}

{% if session_id %}
// SSE for live updates
const es = new EventSource('/sse/session/{{ session_id }}');
es.onmessage = function(e) {
    try {
        const data = JSON.parse(e.data);
        if (data.type === 'message' && data.content) {
            const feed = document.getElementById('messagesFeed');
            const agentInfo = allAgents[data.from_agent] || {};
            const name = agentInfo.name || data.from_agent;
            const color = agentInfo.color || '#8b949e';
            const icon = agentInfo.icon || 'bot';
            const mtype = data.msg_type || data.message_type || 'response';
            const toInfo = allAgents[data.to_agent] || {};
            const toName = toInfo.name || data.to_agent || '';
            const badgeStyles = {delegate:'background:rgba(59,130,246,.15);color:var(--blue)',veto:'background:var(--red);color:#fff',approve:'background:var(--green);color:#fff'};
            const badgeHtml = badgeStyles[mtype] ? `<span class="mu__badge mu__badge--sm" style="${badgeStyles[mtype]}">${mtype.toUpperCase()}</span>` : '';
            const toHtml = toName ? `<span class="mu__arrow">â†’</span><span class="mu__target mu__target--sm" style="color:${toInfo.color||'#6e6e6e'}">${esc(toName)}</span>` : '';
            feed.insertAdjacentHTML('beforeend', `
                <div class="mu mu--compact">
                    <div class="mu__avatar mu__avatar--sm" style="background:${color}20;border-color:${color}">
                        <svg class="icon icon-xs" style="color:${color}"><use href="#icon-${icon}"/></svg>
                    </div>
                    <div class="mu__body">
                        <div class="mu__meta">
                            <span class="mu__name mu__name--sm" style="color:${color}">${esc(name)}</span>
                            ${badgeHtml}${toHtml}
                            <span class="mu__time mu__time--right">now</span>
                        </div>
                        <div class="mu__text mu__text--collapse" onclick="this.classList.toggle('mu__text--collapse')">${esc(data.content)}</div>
                    </div>
                </div>`);
            feed.scrollTop = feed.scrollHeight;
        }
    } catch(err) {}
};
{% endif %}
</script>
{% endblock %}
