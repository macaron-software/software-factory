{% extends "base.html" %}
{% block topbar_actions %}
<button class="btn btn-primary" onclick="document.getElementById('newMissionModal').style.display='flex'">
    <svg class="icon icon-sm"><use href="#icon-plus"/></svg> {{ _('new_mission') }}
</button>
{% endblock %}
{% block content %}
<style>
.mission-list{display:flex;flex-direction:column;gap:0.75rem}
.mission-card{display:grid;grid-template-columns:auto 1fr auto;gap:1rem;align-items:center;background:var(--bg-secondary);border:1px solid var(--border);border-radius:10px;padding:1rem 1.2rem;text-decoration:none;transition:border-color .15s,box-shadow .15s}
.mission-card:hover{border-color:var(--purple-dim);box-shadow:0 2px 12px rgba(124,58,237,.08)}
.mission-card-wrap .mission-card{border-radius:10px 10px 0 0}
.mission-status-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0}
.mission-status-icon.running{background:rgba(124,58,237,.15);color:var(--purple)}
.mission-status-icon.completed{background:rgba(34,197,94,.12);color:var(--green)}
.mission-status-icon.failed{background:rgba(239,68,68,.12);color:var(--red)}
.mission-status-icon.paused,.mission-status-icon.pending{background:var(--bg-tertiary);color:var(--text-secondary)}
.mission-body{min-width:0}
.mission-title{font-size:0.92rem;font-weight:600;color:var(--text-primary);margin-bottom:0.2rem;display:flex;align-items:center;gap:0.5rem}
.mission-brief{font-size:0.8rem;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:500px;margin-bottom:0.45rem}
.mission-progress-row{display:flex;align-items:center;gap:0.6rem}
.mission-progress-bar{flex:1;max-width:220px;height:6px;background:var(--bg-tertiary);border-radius:3px;overflow:hidden}
.mission-progress-fill{height:100%;border-radius:3px;transition:width .3s}
.mission-progress-fill.running{background:var(--purple)}
.mission-progress-fill.completed{background:var(--green)}
.mission-progress-fill.failed{background:var(--red)}
.mission-progress-fill.pending{background:var(--text-secondary)}
.mission-progress-label{font-size:0.72rem;font-weight:600;color:var(--text-secondary);min-width:60px}
.mission-meta{display:flex;flex-direction:column;align-items:flex-end;gap:0.3rem;flex-shrink:0}
.mission-date{font-size:0.72rem;color:var(--text-secondary)}
.mission-badge{font-size:0.68rem;padding:0.15rem 0.5rem;border-radius:4px;font-weight:600;text-transform:uppercase;letter-spacing:0.03em}
.mission-badge.running{background:rgba(124,58,237,.15);color:var(--purple)}
.mission-badge.completed{background:rgba(34,197,94,.12);color:var(--green)}
.mission-badge.failed{background:rgba(239,68,68,.12);color:var(--red)}
.mission-badge.paused,.mission-badge.pending{background:var(--bg-tertiary);color:var(--text-secondary)}
.mission-card-wrap{display:flex;flex-direction:column;gap:0}
.mission-actions{display:flex;gap:0.4rem;padding:0.4rem 1.2rem 0.6rem;background:var(--bg-secondary);border:1px solid var(--border);border-top:0;border-radius:0 0 10px 10px;margin-top:-1px}
.nm-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:100;display:none;align-items:center;justify-content:center}
.nm-form{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);padding:1.5rem;width:90%;max-width:520px}
.nm-form h3{margin:0 0 1rem;color:var(--text-primary)}
.nm-field{margin-bottom:0.85rem}
.nm-field label{display:block;font-size:0.78rem;font-weight:600;color:var(--text-secondary);margin-bottom:0.3rem}
.nm-field select,.nm-field textarea,.nm-field input{width:100%;background:var(--bg-tertiary);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:0.5rem 0.75rem;font-size:0.85rem;font-family:inherit;outline:none}
.nm-field select:focus,.nm-field textarea:focus,.nm-field input:focus{border-color:var(--purple)}
.nm-field textarea{resize:vertical;min-height:80px}
.nm-actions{display:flex;gap:0.5rem;justify-content:flex-end;margin-top:1rem}
.wf-desc{font-size:0.75rem;color:var(--text-secondary);margin-top:0.3rem;padding:0.4rem 0.6rem;background:var(--bg-tertiary);border-radius:6px;display:none}
.wf-grid{display:grid;grid-template-columns:1fr 1fr;gap:0.6rem}
.wf-card{display:flex;gap:0.75rem;align-items:flex-start;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:10px;padding:0.9rem 1rem;cursor:pointer;text-align:left;transition:border-color .15s,box-shadow .15s;color:inherit;font-family:inherit}
.wf-card:hover{border-color:var(--purple-dim);box-shadow:0 2px 12px rgba(124,58,237,.1)}
.wf-card-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.wf-card-body{display:flex;flex-direction:column;gap:0.2rem}
.wf-card-body strong{font-size:0.88rem;color:var(--text-primary)}
.wf-card-body span{font-size:0.75rem;color:var(--text-secondary);line-height:1.3}
.mission-card.stuck{border-color:rgba(245,158,11,.4);background:rgba(245,158,11,.03)}
.mission-status-icon.stuck{background:rgba(245,158,11,.15);color:#f59e0b}
.mission-badge.stuck{background:rgba(245,158,11,.15);color:#f59e0b}
/* Epics */
.epic-section{margin-bottom:2rem}
.epic-section h2{font-size:1rem;font-weight:700;color:var(--text-primary);margin-bottom:0.75rem;display:flex;align-items:center;gap:0.5rem}
.epic-card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:10px;padding:1.2rem;margin-bottom:0.75rem;transition:border-color .15s}
.epic-card:hover{border-color:var(--purple-dim)}
.epic-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:0.6rem}
.epic-title{font-size:0.95rem;font-weight:700;color:var(--text-primary);display:flex;align-items:center;gap:0.5rem}
.epic-project-badge{font-size:0.68rem;font-weight:500;background:var(--bg-tertiary);color:var(--text-secondary);padding:0.15rem 0.5rem;border-radius:4px}
.epic-desc{font-size:0.8rem;color:var(--text-secondary);margin-bottom:0.75rem;line-height:1.4}
.epic-stats{display:flex;gap:1.5rem;align-items:center;margin-bottom:0.6rem}
.epic-stat{font-size:0.75rem;color:var(--text-secondary)}
.epic-stat strong{color:var(--text-primary);font-weight:700}
.epic-progress{height:8px;background:var(--bg-tertiary);border-radius:4px;overflow:hidden;flex:1;max-width:300px}
.epic-progress-fill{height:100%;border-radius:4px;background:var(--green);transition:width .3s}
.epic-features{display:flex;flex-wrap:wrap;gap:0.4rem;margin-top:0.6rem}
.feat-chip{font-size:0.7rem;padding:0.2rem 0.55rem;border-radius:5px;font-weight:500}
.feat-chip.done{background:rgba(34,197,94,.12);color:var(--green)}
.feat-chip.backlog{background:var(--bg-tertiary);color:var(--text-secondary)}
.feat-chip.in_progress{background:rgba(124,58,237,.12);color:var(--purple)}
.feat-chip.active{background:rgba(124,58,237,.12);color:var(--purple)}
.epic-toggle{cursor:pointer;font-size:0.75rem;color:var(--purple);background:none;border:none;font-family:inherit;padding:0.2rem 0.4rem}
/* TMA Tickets */
.tma-list{display:flex;flex-direction:column;gap:0.5rem}
.tma-card{display:grid;grid-template-columns:auto 1fr auto;gap:0.8rem;align-items:center;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;padding:0.8rem 1rem;transition:border-color .15s}
.tma-card:hover{border-color:var(--purple-dim)}
.tma-icon{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0}
.tma-icon.bug{background:rgba(239,68,68,.1)}
.tma-icon.security{background:rgba(245,158,11,.1)}
.tma-icon.debt{background:rgba(99,102,241,.1)}
.tma-body{min-width:0}
.tma-title{font-size:0.88rem;font-weight:600;color:var(--text-primary);display:flex;align-items:center;gap:0.5rem;flex-wrap:wrap}
.tma-desc{font-size:0.78rem;color:var(--text-secondary);margin-top:0.3rem;line-height:1.4}
.tma-goal{font-size:0.75rem;color:var(--text-secondary);margin-top:0.2rem;opacity:0.8}
.tma-meta{display:flex;flex-direction:column;align-items:flex-end;gap:0.3rem;flex-shrink:0}
.tma-type-badge{font-size:0.65rem;padding:0.1rem 0.4rem;border-radius:3px;font-weight:600;text-transform:uppercase}
.tma-type-badge.bug{background:rgba(239,68,68,.12);color:var(--red)}
.tma-type-badge.security{background:rgba(245,158,11,.12);color:#f59e0b}
.tma-type-badge.debt{background:rgba(99,102,241,.12);color:#6366f1}
</style>

<!-- ‚ïê‚ïê‚ïê Epics (SAFe Portfolio) ‚ïê‚ïê‚ïê -->
{% if epics %}
<div class="epic-section">
    <h2><svg class="icon icon-sm"><use href="#icon-layers"/></svg> Epics</h2>
    {% for e in epics %}
    {% set pct = ((e.done_features / e.total_features) * 100)|round|int if e.total_features > 0 else 0 %}
    <div class="epic-card">
        <div class="epic-header">
            <div class="epic-title">
                {% if e.status == 'active' %}üü¢{% elif e.status == 'completed' %}‚úÖ{% else %}‚¨ú{% endif %}
                {{ e.name }}
                <span class="epic-project-badge">{{ e.project_name }}</span>
            </div>
            <div style="display:flex;align-items:center;gap:0.6rem">
                <span class="mission-badge {{ e.status }}">{{ e.status }}</span>
                <button class="epic-toggle" onclick="this.closest('.epic-card').querySelector('.epic-features').classList.toggle('hidden')">
                    ‚ñæ features
                </button>
            </div>
        </div>
        {% if e.description %}<div class="epic-desc">{{ e.description }}</div>{% endif %}
        <div class="epic-stats">
            <div class="epic-progress"><div class="epic-progress-fill" style="width:{{ pct }}%"></div></div>
            <span class="epic-stat"><strong>{{ e.done_features }}/{{ e.total_features }}</strong> features</span>
            <span class="epic-stat"><strong>{{ e.done_sp }}/{{ e.total_sp }}</strong> SP</span>
            <span class="epic-stat" style="font-size:0.7rem;opacity:0.6">{{ pct }}%</span>
        </div>
        <div class="epic-features" id="feats-{{ e.id }}">
            {% for status_key, info in e.features_by_status.items() %}
            <span class="feat-chip {{ status_key }}">{{ status_key }}: {{ info.count }} ({{ info.sp }} SP)</span>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- ‚ïê‚ïê‚ïê TMA / Tickets (Self-Healing) ‚ïê‚ïê‚ïê -->
{% if tma_tickets %}
<div class="epic-section">
    <h2><svg class="icon icon-sm"><use href="#icon-tool"/></svg> TMA ‚Äî Tickets Maintenance
        <span style="font-size:0.72rem;font-weight:400;color:var(--text-secondary);background:var(--bg-tertiary);padding:0.15rem 0.5rem;border-radius:4px">{{ tma_tickets|length }}</span>
    </h2>
    <div class="tma-list">
    {% for t in tma_tickets %}
    <div class="tma-card">
        <div class="tma-icon {{ t.type }}">
            {% if t.type == 'bug' %}üêõ{% elif t.type == 'security' %}üîí{% elif t.type == 'debt' %}üîß{% else %}üìã{% endif %}
        </div>
        <div class="tma-body">
            <div class="tma-title">
                {{ t.name }}
                <span class="epic-project-badge">{{ t.project_name }}</span>
                <span class="tma-type-badge {{ t.type }}">{{ t.type }}</span>
            </div>
            {% if t.description %}<div class="tma-desc">{{ t.description[:200] }}</div>{% endif %}
            {% if t.goal %}<div class="tma-goal">üéØ {{ t.goal[:200] }}</div>{% endif %}
        </div>
        <div class="tma-meta">
            <span class="mission-badge {{ t.status }}">{{ t.status }}</span>
            <span class="mission-date">{{ t.created_at[:10] if t.created_at else '' }}</span>
        </div>
    </div>
    {% endfor %}
    </div>
</div>
{% endif %}

<!-- ‚ïê‚ïê‚ïê Missions (Runs) ‚ïê‚ïê‚ïê -->
{% if runs %}
<div style="margin-bottom:0.75rem"><h2 style="font-size:1rem;font-weight:700;color:var(--text-primary);display:flex;align-items:center;gap:0.5rem">
    <svg class="icon icon-sm"><use href="#icon-rocket"/></svg> Missions en cours
    <span style="font-size:0.72rem;font-weight:400;color:var(--text-secondary);background:var(--bg-tertiary);padding:0.15rem 0.5rem;border-radius:4px">{{ runs|length }}</span>
</h2></div>
{% include "partials/mission_list.html" %}
{% else %}
<div class="empty-state" style="text-align:center;padding:3rem;">
    <p style="margin-bottom:0.5rem"><svg class="icon" style="width:2.5rem;height:2.5rem"><use href="#icon-rocket"/></svg></p>
    <h3 style="color:var(--text-primary);margin-bottom:0.3rem">{{ _('no_mission') }}</h3>
    <p style="color:var(--text-secondary);font-size:0.88rem;margin-bottom:1rem">Lancez une mission pour orchestrer un workflow multi-agents.</p>
    <button class="btn btn-primary" onclick="document.getElementById('newMissionModal').style.display='flex'">
        <svg class="icon icon-sm"><use href="#icon-plus"/></svg> {{ _('new_mission') }}
    </button>
</div>
{% endif %}

<!-- Modal cr√©ation mission ‚Äî √©tape 1 : choix workflow -->
<div id="newMissionModal" class="nm-overlay" onclick="if(event.target===this)this.style.display='none'">
    <div class="nm-form" id="step1" style="max-width:600px">
        <h3><svg class="icon icon-sm" style="vertical-align:middle;margin-right:0.3rem"><use href="#icon-rocket"/></svg> {{ _('new_mission') }}</h3>
        <p style="color:var(--text-secondary);font-size:0.82rem;margin:-0.5rem 0 1rem">Choisissez le type de mission</p>
        <div class="wf-grid">
            <button type="button" class="wf-card" onclick="selectWf('product-lifecycle')">
                <div class="wf-card-icon" style="background:rgba(124,58,237,.15);color:var(--purple)"><svg class="icon"><use href="#icon-git-merge"/></svg></div>
                <div class="wf-card-body">
                    <strong>Cycle Complet</strong>
                    <span>Ideation, architecture, sprints, CI/CD, QA, deploy, TMA ‚Äî pipeline bout en bout</span>
                </div>
            </button>
            <button type="button" class="wf-card" onclick="selectWf('tma-maintenance')">
                <div class="wf-card-icon" style="background:rgba(251,191,36,.12);color:var(--yellow)"><svg class="icon"><use href="#icon-tool"/></svg></div>
                <div class="wf-card-body">
                    <strong>TMA / Ticketing</strong>
                    <span>Maintenance applicative, tickets incidents, routage N1/N2/N3, correctifs</span>
                </div>
            </button>
            <button type="button" class="wf-card" onclick="selectWf('security-hacking')">
                <div class="wf-card-icon" style="background:rgba(239,68,68,.12);color:var(--red)"><svg class="icon"><use href="#icon-shield"/></svg></div>
                <div class="wf-card-body">
                    <strong>Hacking / Securite</strong>
                    <span>Audit OWASP, pentesting, SAST/DAST, hardening, revue secrets et credentials</span>
                </div>
            </button>
            <button type="button" class="wf-card" onclick="selectWf('feature-request')">
                <div class="wf-card-icon" style="background:rgba(34,197,94,.12);color:var(--green)"><svg class="icon"><use href="#icon-plus-circle"/></svg></div>
                <div class="wf-card-body">
                    <strong>{{ _('new_features') }}</strong>
                    <span>Ajout de fonctionnalites sur existant, migration, evolution, amelioration</span>
                </div>
            </button>
        </div>
        <div class="nm-actions" style="margin-top:0.75rem">
            <button type="button" class="btn btn-ghost" onclick="document.getElementById('newMissionModal').style.display='none'">Annuler</button>
        </div>
    </div>
    <!-- √âtape 2 : brief -->
    <form class="nm-form" id="step2" style="display:none">
        <h3 id="step2Title"></h3>
        <input type="hidden" name="project_id" value="software-factory">
        <input type="hidden" name="workflow_id" id="wfInput">
        <div class="nm-field">
            <label>Brief de la mission</label>
            <textarea name="brief" id="briefInput" placeholder="Nom - Description du besoin, contexte, objectifs..." required style="min-height:100px"></textarea>
        </div>
        <div class="nm-actions">
            <button type="button" class="btn btn-ghost" onclick="backToStep1()">{{ _('back') }}</button>
            <button type="submit" class="btn btn-primary">
                <svg class="icon icon-sm"><use href="#icon-play"/></svg> {{ _('launch_mission') }}
            </button>
        </div>
    </form>
</div>

<script>
const WF_NAMES = {
    'product-lifecycle': 'Cycle Complet',
    'tma-maintenance': 'TMA / Ticketing',
    'security-hacking': 'Hacking / Securite',
    'feature-request': _('new_features')
};
function selectWf(id){
    document.getElementById('wfInput').value = id;
    document.getElementById('step2Title').textContent = WF_NAMES[id] || id;
    document.getElementById('step1').style.display = 'none';
    document.getElementById('step2').style.display = 'block';
    document.getElementById('briefInput').focus();
}
function backToStep1(){
    document.getElementById('step2').style.display = 'none';
    document.getElementById('step1').style.display = 'block';
}

document.getElementById('step2').addEventListener('submit', async e => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const btn = e.target.querySelector('[type=submit]');
    btn.disabled = true; btn.textContent = 'Lancement...';
    try {
        const r = await fetch('/api/missions/start', {method:'POST', body: fd});
        const j = await r.json();
        if (j.redirect) location.href = j.redirect;
        else { alert(j.error || _('error_generic')); btn.disabled = false; btn.textContent = _('launch_mission'); }
    } catch(err) { alert(err); btn.disabled = false; btn.textContent = _('launch_mission'); }
});

async function runPhase(runId) {
    try {
        const r = await fetch(`/api/missions/${runId}/run`, {method:'POST'});
        const j = await r.json();
        if (j.status === 'started' || j.status === 'running' || j.redirect) location.href = `/missions/${runId}/control`;
        else alert(j.error || j.message || _('error_generic'));
    } catch(err) { alert(err); }
}

async function deleteRun(runId) {
    if (!confirm(_('delete_confirm_mission'))) return;
    try {
        const r = await fetch(`/api/mission-runs/${runId}`, {method:'DELETE'});
        if (r.ok) location.reload();
        else { const j = await r.json(); alert(j.error || _('error_generic')); }
    } catch(err) { alert(err); }
}
</script>
{% endblock %}
