<div class="mission-list" id="missionList" hx-get="/api/missions/list-partial" hx-trigger="every 15s" hx-swap="outerHTML">
    {% for run in runs %}
    {% set done_count = run.phases|selectattr('status.value','equalto','done')|list|length %}
    {% set total = run.phases|length %}
    {% set pct = ((done_count / total) * 100)|round|int if total > 0 else 0 %}
    {% set st = run.status.value %}
    <div class="mission-card-wrap">
    <a href="/missions/{{ run.id }}/control" class="mission-card">
        <div class="mission-status-icon {{ st }}">
            {% if st == 'running' %}<svg class="icon icon-xs"><use href="#icon-activity"/></svg>{% elif st == 'completed' %}<svg class="icon icon-xs"><use href="#icon-check"/></svg>{% elif st == 'failed' %}<svg class="icon icon-xs"><use href="#icon-x"/></svg>{% else %}<svg class="icon icon-xs"><use href="#icon-pause"/></svg>{% endif %}
        </div>
        <div class="mission-body">
            {% set epic_name = run.brief.split(' - ')[0] if ' - ' in run.brief else run.brief[:50] %}
            <div class="mission-title">
                {{ epic_name }}
                <span style="font-size:0.68rem;font-weight:400;color:var(--text-secondary);background:var(--bg-tertiary);padding:0.1rem 0.4rem;border-radius:4px">{{ run.workflow_name or run.workflow_id }}</span>
            </div>
            <div class="mission-brief">{{ run.brief[epic_name|length + 3:epic_name|length + 143] if ' - ' in run.brief else run.brief[:140] }}</div>
            <div class="mission-progress-row">
                <div class="mission-progress-bar">
                    <div class="mission-progress-fill {{ st }}" style="width:{{ pct }}%"></div>
                </div>
                <span class="mission-progress-label">{{ done_count }}/{{ total }} phases</span>
            </div>
        </div>
        <div class="mission-meta">
            <span class="mission-badge {{ st }}">{{ st }}</span>
            <span class="mission-date">{{ run.created_at[:16].replace('T',' ') if run.created_at is string else run.created_at.strftime('%d/%m %H:%M') }}</span>
        </div>
    </a>
    <div class="mission-actions">
        {% if st == 'running' and done_count < total %}
        <button class="btn btn-sm" onclick="event.stopPropagation();runPhase('{{ run.id }}')" title="Lancer la prochaine phase">
            <svg class="icon icon-xs"><use href="#icon-play"/></svg> Lancer phase {{ done_count + 1 }}
        </button>
        {% endif %}
        <a href="/missions/{{ run.id }}/control" class="btn btn-sm btn-ghost" title="Mission Control">
            <svg class="icon icon-xs"><use href="#icon-monitor"/></svg> Control
        </a>
        <button class="btn btn-sm btn-danger" onclick="event.stopPropagation();deleteRun('{{ run.id }}')" title="Supprimer">
            <svg class="icon icon-xs"><use href="#icon-trash"/></svg>
        </button>
    </div>
    </div>
    {% endfor %}
</div>
