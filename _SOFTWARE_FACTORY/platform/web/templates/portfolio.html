{% extends "base.html" %}

{% block topbar_actions %}
<a href="/missions?action=new" class="btn btn-primary">
    <svg class="icon icon-sm"><use href="#icon-plus"/></svg> Nouvelle Mission
</a>
{% endblock %}

{% block content %}
<style>
/* ── Portfolio Dashboard ── */
.portfolio-grid{display:grid;grid-template-columns:1fr;gap:1.5rem;padding:0.5rem 0}
.portfolio-strategy{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:0.75rem;margin-bottom:1.5rem}
.strat-card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);padding:1rem;display:flex;align-items:center;gap:0.75rem;transition:border-color .15s}
.strat-card:hover{border-color:var(--purple)}
.strat-avatar{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.strat-avatar svg{width:20px;height:20px}
.strat-info{min-width:0}
.strat-name{font-size:0.82rem;font-weight:600;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.strat-role{font-size:0.68rem;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.strat-tagline{font-size:0.65rem;color:var(--text-secondary);opacity:.7;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

.portfolio-metrics{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:0.75rem;margin-bottom:1.5rem}
.metric-card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);padding:1rem;text-align:center}
.metric-value{font-size:1.8rem;font-weight:700;color:var(--purple-light);line-height:1}
.metric-label{font-size:0.72rem;color:var(--text-secondary);margin-top:0.3rem;text-transform:uppercase;letter-spacing:0.5px}

.portfolio-projects{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:1rem}
.project-mission-card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);padding:1.15rem;transition:border-color .15s;text-decoration:none;color:inherit;display:block}
.project-mission-card:hover{border-color:var(--purple);background:var(--bg-tertiary)}
.pmc-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:0.75rem}
.pmc-title{font-size:1rem;font-weight:700;color:var(--text-primary);display:flex;align-items:center;gap:0.5rem}
.pmc-status{font-size:0.68rem;padding:0.15rem 0.5rem;border-radius:8px;font-weight:600}
.pmc-status.active{background:rgba(52,211,153,.15);color:#34d399}
.pmc-status.planning{background:rgba(251,191,36,.15);color:#fbbf24}
.pmc-status.completed{background:rgba(96,165,250,.15);color:#60a5fa}
.pmc-status.blocked{background:rgba(248,113,113,.15);color:#f87171}
.pmc-missions{margin-top:0.5rem}
.pmc-mission{display:flex;align-items:center;gap:0.5rem;padding:0.35rem 0;border-bottom:1px solid var(--border-light, rgba(255,255,255,.05))}
.pmc-mission:last-child{border-bottom:none}
.pmc-mission-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.pmc-mission-dot.active{background:var(--green);box-shadow:0 0 6px var(--green)}
.pmc-mission-dot.planning{background:var(--yellow)}
.pmc-mission-dot.completed{background:var(--blue)}
.pmc-mission-name{font-size:0.82rem;color:var(--text-primary);flex:1}
.pmc-mission-progress{font-size:0.72rem;color:var(--text-secondary)}

.pmc-team{display:flex;gap:0.35rem;margin-top:0.6rem;flex-wrap:wrap}
.pmc-team-agent{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:var(--bg-tertiary);border:1px solid var(--border);cursor:default}
.pmc-team-agent svg{width:14px;height:14px;color:var(--text-secondary)}
.pmc-team-agent[title]:hover{border-color:var(--purple)}
.pmc-team-agent[title]:hover svg{color:var(--purple-light)}

.pmc-progress-bar{height:4px;background:var(--bg-tertiary);border-radius:2px;margin-top:0.6rem;overflow:hidden}
.pmc-progress-fill{height:100%;background:linear-gradient(90deg,var(--purple),var(--purple-light));border-radius:2px;transition:width .3s}

.pmc-no-missions{font-size:0.78rem;color:var(--text-secondary);font-style:italic;padding:0.5rem 0}

.section-title{font-size:0.82rem;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:1px;margin-bottom:0.75rem;display:flex;align-items:center;gap:0.5rem}
.section-title svg{width:16px;height:16px}
</style>

<div class="portfolio-grid">

    <!-- Strategic agents -->
    <div>
        <div class="section-title">
            <svg class="icon icon-sm"><use href="#icon-target"/></svg> Comité Stratégique
        </div>
        <div class="portfolio-strategy">
            {% for a in strategic_agents %}
            <div class="strat-card">
                <div class="strat-avatar" style="background:{{ a.color }}20;border:2px solid {{ a.color }}">
                    <svg style="color:{{ a.color }}"><use href="#icon-{{ a.avatar or a.icon or 'bot' }}"/></svg>
                </div>
                <div class="strat-info">
                    <div class="strat-name">{{ a.name }}</div>
                    <div class="strat-role">{{ a.role }}</div>
                    {% if a.tagline %}<div class="strat-tagline">{{ a.tagline }}</div>{% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Portfolio metrics -->
    <div>
        <div class="section-title">
            <svg class="icon icon-sm"><use href="#icon-chart"/></svg> Portfolio
        </div>
        <div class="portfolio-metrics">
            <div class="metric-card">
                <div class="metric-value">{{ total_missions }}</div>
                <div class="metric-label">Missions</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">{{ active_missions }}</div>
                <div class="metric-label">En cours</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">{{ total_tasks_done }}/{{ total_tasks }}</div>
                <div class="metric-label">Tasks Done</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">{{ total_agents }}</div>
                <div class="metric-label">Agents Actifs</div>
            </div>
        </div>
    </div>

    <!-- Projects with missions -->
    <div>
        <div class="section-title">
            <svg class="icon icon-sm"><use href="#icon-folder"/></svg> Projets
        </div>
        <div class="portfolio-projects">
            {% for p in projects %}
            <a href="/projects/{{ p.id }}" class="project-mission-card">
                <div class="pmc-header">
                    <div class="pmc-title">
                        <span class="project-type-dot {{ p.factory_type }}"></span>
                        {{ p.name }}
                    </div>
                    {% if p.active_mission_count > 0 %}
                    <span class="pmc-status active">{{ p.active_mission_count }} active</span>
                    {% elif p.mission_count > 0 %}
                    <span class="pmc-status planning">{{ p.mission_count }} planned</span>
                    {% endif %}
                </div>

                {% if p.description %}
                <div style="font-size:0.78rem;color:var(--text-secondary);margin-bottom:0.5rem">{{ p.description[:100] }}{% if p.description|length > 100 %}…{% endif %}</div>
                {% endif %}

                <div class="pmc-missions">
                    {% for m in p.missions[:3] %}
                    <div class="pmc-mission">
                        <span class="pmc-mission-dot {{ m.status }}"></span>
                        <span class="pmc-mission-name">{{ m.name }}</span>
                        {% if m.task_progress %}
                        <span class="pmc-mission-progress">{{ m.task_progress }}</span>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="pmc-no-missions">Aucune mission — prête pour la prochaine vision</div>
                    {% endfor %}
                </div>

                {% if p.team_avatars %}
                <div class="pmc-team">
                    {% for avatar in p.team_avatars[:6] %}
                    <span class="pmc-team-agent" title="{{ avatar.name }}">
                        <svg><use href="#icon-{{ avatar.icon or 'bot' }}"/></svg>
                    </span>
                    {% endfor %}
                    {% if p.team_avatars|length > 6 %}
                    <span class="pmc-team-agent">+{{ p.team_avatars|length - 6 }}</span>
                    {% endif %}
                </div>
                {% endif %}

                {% if p.total_tasks > 0 %}
                <div class="pmc-progress-bar">
                    <div class="pmc-progress-fill" style="width:{{ (p.done_tasks / p.total_tasks * 100)|round }}%"></div>
                </div>
                {% endif %}
            </a>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}
