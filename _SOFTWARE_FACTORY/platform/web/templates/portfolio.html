{% extends "base.html" %}

{% block topbar_actions %}
<a href="/missions?action=new" class="btn btn-primary">
    <svg class="icon icon-sm"><use href="#icon-plus"/></svg> Nouvelle Mission
</a>
{% endblock %}

{% block content %}
<style>
/* ── Portfolio Dashboard ── */
.portfolio-grid{display:grid;grid-template-columns:1fr;gap:1.5rem;padding:0.5rem 0}

/* Strategic agent cards — compact, clickable */
.portfolio-strategy{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:0.75rem;margin-bottom:1.5rem;position:relative}
.strat-card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);padding:0.85rem 1rem;display:flex;align-items:center;gap:0.7rem;cursor:pointer;transition:border-color .15s,box-shadow .15s}
.strat-card:hover{border-color:var(--purple);box-shadow:0 4px 16px rgba(124,58,237,.12)}
.strat-card.active{border-color:var(--purple);box-shadow:0 4px 16px rgba(124,58,237,.2)}
.strat-photo{width:42px;height:42px;border-radius:50%;flex-shrink:0;object-fit:cover;border:2px solid var(--border)}
.strat-avatar{width:42px;height:42px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.strat-avatar svg{width:20px;height:20px}
.strat-info{flex:1;min-width:0}
.strat-name{font-size:0.85rem;font-weight:700;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.strat-role{font-size:0.68rem;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* Popover fiche — same design as graph tooltip */
.agent-popover{position:absolute;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:10px;padding:0.75rem 0.85rem;font-size:0.78rem;color:var(--text-primary);width:300px;box-shadow:0 6px 24px rgba(0,0,0,.55);pointer-events:auto;z-index:20;display:none;word-break:break-word}
.agent-popover.visible{display:block}
.agent-popover-close{position:absolute;top:0.35rem;right:0.5rem;background:none;border:none;color:var(--text-secondary);cursor:pointer;font-size:0.85rem;padding:0.2rem}
.agent-popover-close:hover{color:var(--text-primary)}
.ap-header{display:flex;align-items:center;gap:0.6rem;margin-bottom:0.5rem;padding-bottom:0.45rem;border-bottom:1px solid var(--border)}
.ap-photo{width:44px;height:44px;border-radius:50%;flex-shrink:0;object-fit:cover;border:2px solid var(--border)}
.ap-info{flex:1}
.ap-name{font-weight:700;font-size:0.88rem}
.ap-role{font-size:0.72rem;color:var(--text-secondary)}
.ap-tagline{font-size:0.72rem;color:var(--text-secondary);font-style:italic;line-height:1.3;margin-bottom:0.35rem}
.ap-desc{font-size:0.72rem;color:var(--text-secondary);line-height:1.35;margin-top:0.35rem}
.ap-section{margin-top:0.45rem}
.ap-section-title{font-size:0.68rem;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:0.2rem;font-weight:600}
.ap-tags{display:flex;flex-wrap:wrap;gap:0.25rem}
.ap-tag{display:inline-block;padding:0.1rem 0.4rem;border-radius:4px;font-size:0.68rem;background:var(--bg-secondary);border:1px solid var(--border)}
.ap-tag--skill{border-color:rgba(124,58,237,.35);color:var(--purple)}
.ap-tag--tool{border-color:rgba(16,185,129,.3);color:var(--green)}
.ap-tag--mcp{border-color:rgba(245,158,11,.3);color:var(--yellow)}
.ap-model{display:inline-flex;align-items:center;gap:0.3rem;font-size:0.68rem;padding:0.12rem 0.4rem;border-radius:4px;background:var(--bg-secondary);border:1px solid var(--border);color:var(--text-secondary);font-family:var(--font-mono)}

.portfolio-metrics{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:0.75rem;margin-bottom:1.5rem}
.metric-card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);padding:1rem;text-align:center}
.metric-value{font-size:1.8rem;font-weight:700;color:var(--purple-light);line-height:1}
.metric-label{font-size:0.72rem;color:var(--text-secondary);margin-top:0.3rem;text-transform:uppercase;letter-spacing:0.5px}

.portfolio-projects{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:1rem}
.project-mission-card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);padding:1.15rem;transition:border-color .15s;text-decoration:none;color:inherit;display:block}
.project-mission-card:hover{border-color:var(--purple);background:var(--bg-tertiary)}
.pmc-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:0.75rem}
.pmc-title{font-size:1rem;font-weight:700;color:var(--text-primary);display:flex;align-items:center;gap:0.5rem}
.pmc-status{font-size:0.68rem;padding:0.15rem 0.5rem;border-radius:8px;font-weight:600}
.pmc-status.active{background:rgba(52,211,153,.15);color:#34d399}
.pmc-status.planning{background:rgba(251,191,36,.15);color:#fbbf24}
.pmc-status.completed{background:rgba(96,165,250,.15);color:#60a5fa}
.pmc-status.blocked{background:rgba(248,113,113,.15);color:#f87171}
.pmc-missions{margin-top:0.5rem}
.pmc-mission{display:flex;align-items:center;gap:0.5rem;padding:0.35rem 0;border-bottom:1px solid var(--border-light, rgba(255,255,255,.05))}
.pmc-mission:last-child{border-bottom:none}
.pmc-mission-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.pmc-mission-dot.active{background:var(--green);box-shadow:0 0 6px var(--green)}
.pmc-mission-dot.planning{background:var(--yellow)}
.pmc-mission-dot.completed{background:var(--blue)}
.pmc-mission-name{font-size:0.82rem;color:var(--text-primary);flex:1}
.pmc-mission-progress{font-size:0.72rem;color:var(--text-secondary)}

.pmc-team{display:flex;gap:0.35rem;margin-top:0.6rem;flex-wrap:wrap}
.pmc-team-agent{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:var(--bg-tertiary);border:1px solid var(--border);cursor:default}
.pmc-team-agent svg{width:14px;height:14px;color:var(--text-secondary)}
.pmc-team-agent[title]:hover{border-color:var(--purple)}
.pmc-team-agent[title]:hover svg{color:var(--purple-light)}

.pmc-progress-bar{height:4px;background:var(--bg-tertiary);border-radius:2px;margin-top:0.6rem;overflow:hidden}
.pmc-progress-fill{height:100%;background:linear-gradient(90deg,var(--purple),var(--purple-light));border-radius:2px;transition:width .3s}

.pmc-no-missions{font-size:0.78rem;color:var(--text-secondary);font-style:italic;padding:0.5rem 0}

.section-title{font-size:0.82rem;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:1px;margin-bottom:0.75rem;display:flex;align-items:center;gap:0.5rem}
.section-title svg{width:16px;height:16px}
</style>

<div class="portfolio-grid">

    <!-- Strategic agents -->
    <div>
        <div class="section-title">
            <svg class="icon icon-sm"><use href="#icon-target"/></svg> Comité Stratégique
        </div>
        <div class="portfolio-strategy" id="stratContainer">
            {% for a in strategic_agents %}
            <div class="strat-card" data-agent="{{ loop.index0 }}" onclick="togglePopover(this, {{ loop.index0 }})">
                {% if a.avatar_url %}
                <img class="strat-photo" src="{{ a.avatar_url }}" alt="{{ a.name }}">
                {% else %}
                <div class="strat-avatar" style="background:{{ a.color }}20;border:2px solid {{ a.color }}">
                    <svg style="color:{{ a.color }}"><use href="#icon-{{ a.avatar }}"/></svg>
                </div>
                {% endif %}
                <div class="strat-info">
                    <div class="strat-name">{{ a.name }}</div>
                    <div class="strat-role">{{ a.role }}</div>
                </div>
            </div>
            {% endfor %}
            <div class="agent-popover" id="agentPopover"></div>
        </div>
    </div>

    <!-- Portfolio metrics -->
    <div>
        <div class="section-title">
            <svg class="icon icon-sm"><use href="#icon-chart"/></svg> Portfolio
        </div>
        <div class="portfolio-metrics">
            <div class="metric-card">
                <div class="metric-value">{{ total_missions }}</div>
                <div class="metric-label">Missions</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">{{ active_missions }}</div>
                <div class="metric-label">En cours</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">{{ total_tasks_done }}/{{ total_tasks }}</div>
                <div class="metric-label">Tasks Done</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">{{ total_agents }}</div>
                <div class="metric-label">Agents Actifs</div>
            </div>
        </div>
    </div>

    <!-- Projects with missions -->
    <div>
        <div class="section-title">
            <svg class="icon icon-sm"><use href="#icon-folder"/></svg> Projets
        </div>
        <div class="portfolio-projects">
            {% for p in projects %}
            <a href="/projects/{{ p.id }}" class="project-mission-card">
                <div class="pmc-header">
                    <div class="pmc-title">
                        <span class="project-type-dot {{ p.factory_type }}"></span>
                        {{ p.name }}
                    </div>
                    {% if p.active_mission_count > 0 %}
                    <span class="pmc-status active">{{ p.active_mission_count }} active</span>
                    {% elif p.mission_count > 0 %}
                    <span class="pmc-status planning">{{ p.mission_count }} planned</span>
                    {% endif %}
                </div>

                {% if p.description %}
                <div style="font-size:0.78rem;color:var(--text-secondary);margin-bottom:0.5rem">{{ p.description[:100] }}{% if p.description|length > 100 %}…{% endif %}</div>
                {% endif %}

                <div class="pmc-missions">
                    {% for m in p.missions[:3] %}
                    <div class="pmc-mission">
                        <span class="pmc-mission-dot {{ m.status }}"></span>
                        <span class="pmc-mission-name">{{ m.name }}</span>
                        {% if m.task_progress %}
                        <span class="pmc-mission-progress">{{ m.task_progress }}</span>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="pmc-no-missions">Aucune mission — prête pour la prochaine vision</div>
                    {% endfor %}
                </div>

                {% if p.team_avatars %}
                <div class="pmc-team">
                    {% for avatar in p.team_avatars[:6] %}
                    <span class="pmc-team-agent" title="{{ avatar.name }}">
                        <svg><use href="#icon-{{ avatar.icon or 'bot' }}"/></svg>
                    </span>
                    {% endfor %}
                    {% if p.team_avatars|length > 6 %}
                    <span class="pmc-team-agent">+{{ p.team_avatars|length - 6 }}</span>
                    {% endif %}
                </div>
                {% endif %}

                {% if p.total_tasks > 0 %}
                <div class="pmc-progress-bar">
                    <div class="pmc-progress-fill" style="width:{{ (p.done_tasks / p.total_tasks * 100)|round }}%"></div>
                </div>
                {% endif %}
            </a>
            {% endfor %}
        </div>
    </div>
</div>

<script>
const agents = {{ strategic_agents | tojson }};
let activeCard = null;

function esc(s){ const d=document.createElement('div'); d.textContent=s||''; return d.innerHTML; }

function closePopover(){
    document.getElementById('agentPopover').classList.remove('visible');
    if(activeCard){ activeCard.classList.remove('active'); activeCard=null; }
}

function togglePopover(card, idx){
    const pop = document.getElementById('agentPopover');
    if(activeCard === card){ closePopover(); return; }
    if(activeCard) activeCard.classList.remove('active');
    activeCard = card;
    card.classList.add('active');

    const a = agents[idx];
    const photo = a.avatar_url
        ? `<img class="ap-photo" src="${a.avatar_url}" alt="${esc(a.name)}">`
        : `<div class="strat-avatar" style="background:${a.color}20;border:2px solid ${a.color}"><svg style="color:${a.color};width:20px;height:20px"><use href="#icon-${a.avatar}"/></svg></div>`;

    let skillsHtml = '';
    if(a.skills && a.skills.length){
        skillsHtml = `<div class="ap-section">
            <div class="ap-section-title"><svg class="icon icon-xs"><use href="#icon-layers"/></svg> Skills</div>
            <div class="ap-tags">${a.skills.map(s=>`<span class="ap-tag ap-tag--skill">${esc(s)}</span>`).join('')}</div>
        </div>`;
    }
    let toolsHtml = '';
    if(a.tools && a.tools.length){
        toolsHtml = `<div class="ap-section">
            <div class="ap-section-title"><svg class="icon icon-xs"><use href="#icon-settings"/></svg> Tools</div>
            <div class="ap-tags">${a.tools.map(t=>`<span class="ap-tag ap-tag--tool">${esc(t)}</span>`).join('')}</div>
        </div>`;
    }
    let mcpsHtml = '';
    if(a.mcps && a.mcps.length){
        mcpsHtml = `<div class="ap-section">
            <div class="ap-section-title"><svg class="icon icon-xs"><use href="#icon-plug"/></svg> MCPs</div>
            <div class="ap-tags">${a.mcps.map(m=>`<span class="ap-tag ap-tag--mcp">${esc(m)}</span>`).join('')}</div>
        </div>`;
    }
    let modelHtml = '';
    if(a.model || a.provider){
        modelHtml = `<div class="ap-section">
            <div class="ap-section-title"><svg class="icon icon-xs"><use href="#icon-brain"/></svg> LLM</div>
            <span class="ap-model">${esc(a.provider||'')} ${esc(a.model||'default')}</span>
        </div>`;
    }
    let personaHtml = '';
    if(a.persona){
        personaHtml = `<div class="ap-section">
            <div class="ap-section-title"><svg class="icon icon-xs"><use href="#icon-user"/></svg> Persona</div>
            <div class="ap-desc" style="white-space:pre-line">${esc(a.persona)}</div>
        </div>`;
    }
    let descHtml = '';
    if(a.description){
        descHtml = `<div class="ap-desc">${esc(a.description)}</div>`;
    }

    pop.innerHTML = `
        <button class="agent-popover-close" onclick="event.stopPropagation();closePopover()"><svg class="icon icon-xs"><use href="#icon-x"/></svg></button>
        <div class="ap-header">
            ${photo}
            <div class="ap-info">
                <div class="ap-name">${esc(a.name)}</div>
                <div class="ap-role">${esc(a.role)}</div>
            </div>
        </div>
        ${a.tagline ? `<div class="ap-tagline">${esc(a.tagline)}</div>` : ''}
        ${descHtml}
        ${personaHtml}
        ${skillsHtml}
        ${toolsHtml}
        ${mcpsHtml}
        ${modelHtml}
    `;

    // Position popover below the card
    const rect = card.getBoundingClientRect();
    const container = document.getElementById('stratContainer').getBoundingClientRect();
    let left = rect.left - container.left;
    let top = rect.bottom - container.top + 6;
    // Clamp to container width
    if(left + 300 > container.width) left = container.width - 310;
    if(left < 0) left = 0;
    pop.style.left = left + 'px';
    pop.style.top = top + 'px';
    pop.classList.add('visible');
}

// Close on outside click
document.addEventListener('click', function(e){
    if(!e.target.closest('.strat-card') && !e.target.closest('.agent-popover')){
        closePopover();
    }
});
// Close on Escape
document.addEventListener('keydown', function(e){ if(e.key==='Escape') closePopover(); });
</script>
{% endblock %}
