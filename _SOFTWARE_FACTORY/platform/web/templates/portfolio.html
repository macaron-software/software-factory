{% extends "base.html" %}

{% block topbar_actions %}
<a href="/missions?action=new" class="btn btn-primary">
    <svg class="icon icon-sm"><use href="#icon-plus"/></svg> New Epic
</a>
{% endblock %}

{% block content %}
<div class="tabs">
    <button class="tab {% if active_tab == 'overview' %}active{% endif %}" hx-get="/?tab=overview" hx-select="#portfolio-inner" hx-target="#tab-content" hx-swap="innerHTML" hx-push-url="/" onclick="switchTab(this)">{{ _("overview") }}</button>
    <button class="tab {% if active_tab == 'dsi' %}active{% endif %}" hx-get="/dsi" hx-select=".main-area > *" hx-target="#tab-content" hx-swap="innerHTML" hx-push-url="/?tab=dsi" onclick="switchTab(this)">{{ _("dsi") }}</button>
    <button class="tab {% if active_tab == 'metier' %}active{% endif %}" hx-get="/metier" hx-select=".main-area > *" hx-target="#tab-content" hx-swap="innerHTML" hx-push-url="/?tab=metier" onclick="switchTab(this)">{{ _("business") }}</button>
</div>
<div id="tab-content">
<div id="portfolio-inner">
<style>
/* ── Portfolio Dashboard ── */
.portfolio-grid{display:grid;grid-template-columns:1fr;gap:1.5rem;padding:0.5rem 0}

/* Strategic agent cards — compact, clickable */
.portfolio-strategy{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:0.75rem;margin-bottom:1.5rem;position:relative}
.strat-card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);padding:0.85rem 1rem;display:flex;align-items:center;gap:0.7rem;cursor:pointer;transition:border-color .15s,box-shadow .15s}
.strat-card:hover{border-color:var(--purple);box-shadow:0 4px 16px rgba(124,58,237,.12)}
.strat-card.active{border-color:var(--purple);box-shadow:0 4px 16px rgba(124,58,237,.2)}
.strat-photo{width:42px;height:42px;border-radius:50%;flex-shrink:0;object-fit:cover;border:2px solid var(--border)}
.strat-avatar{width:42px;height:42px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.strat-avatar svg{width:20px;height:20px}
.strat-info{flex:1;min-width:0}
.strat-name{font-size:0.85rem;font-weight:700;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.strat-role{font-size:0.68rem;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* Popover fiche — fixed position to avoid container clipping */
.agent-popover{position:fixed;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:10px;padding:0.75rem 0.85rem;font-size:0.78rem;color:var(--text-primary);width:320px;max-height:70vh;overflow-y:auto;box-shadow:0 6px 24px rgba(0,0,0,.55);pointer-events:auto;z-index:1000;display:none;word-break:break-word}
.agent-popover.visible{display:block}
.agent-popover-close{position:absolute;top:0.35rem;right:0.5rem;background:none;border:none;color:var(--text-secondary);cursor:pointer;font-size:0.85rem;padding:0.2rem}
.agent-popover-close:hover{color:var(--text-primary)}
.ap-header{display:flex;align-items:center;gap:0.6rem;margin-bottom:0.5rem;padding-bottom:0.45rem;border-bottom:1px solid var(--border)}
.ap-photo{width:44px;height:44px;border-radius:50%;flex-shrink:0;object-fit:cover;border:2px solid var(--border)}
.ap-info{flex:1}
.ap-name{font-weight:700;font-size:0.88rem}
.ap-role{font-size:0.72rem;color:var(--text-secondary)}
.ap-tagline{font-size:0.72rem;color:var(--text-secondary);font-style:italic;line-height:1.3;margin-bottom:0.35rem}
.ap-desc{font-size:0.72rem;color:var(--text-secondary);line-height:1.35;margin-top:0.35rem}
.ap-section{margin-top:0.45rem}
.ap-section-title{font-size:0.68rem;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:0.2rem;font-weight:600}
.ap-tags{display:flex;flex-wrap:wrap;gap:0.25rem}
.ap-tag{display:inline-block;padding:0.1rem 0.4rem;border-radius:4px;font-size:0.68rem;background:var(--bg-secondary);border:1px solid var(--border)}
.ap-tag--skill{border-color:rgba(124,58,237,.35);color:var(--purple)}
.ap-tag--tool{border-color:rgba(16,185,129,.3);color:var(--green)}
.ap-tag--mcp{border-color:rgba(245,158,11,.3);color:var(--yellow)}
.ap-model{display:inline-flex;align-items:center;gap:0.3rem;font-size:0.68rem;padding:0.12rem 0.4rem;border-radius:4px;background:var(--bg-secondary);border:1px solid var(--border);color:var(--text-secondary);font-family:var(--font-mono)}

/* Strategic graph mini — inline SVG */
.strat-graph-wrap{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);margin-top:0.75rem;margin-bottom:0.5rem;position:relative;overflow:hidden}
.strat-graph-header{display:flex;align-items:center;justify-content:space-between;padding:0.6rem 0.85rem;cursor:pointer;user-select:none}
.strat-graph-header:hover{background:var(--bg-tertiary)}
.strat-graph-title{font-size:0.75rem;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.5px;display:flex;align-items:center;gap:0.4rem}
.strat-graph-title svg{width:14px;height:14px}
.strat-graph-toggle{font-size:0.68rem;color:var(--text-secondary);display:flex;align-items:center;gap:0.3rem}
.strat-graph-toggle svg{width:12px;height:12px;transition:transform .2s}
.strat-graph-toggle.open svg{transform:rotate(180deg)}
.strat-graph-body{padding:0 0.5rem 0.5rem}
.strat-graph-body svg{width:100%;height:auto}
.strat-graph-actions{display:flex;gap:0.5rem;align-items:center}
.strat-graph-btn{font-size:0.68rem;padding:0.2rem 0.6rem;border-radius:6px;border:1px solid var(--border);background:var(--bg-tertiary);color:var(--text-secondary);cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:0.3rem;transition:all .15s}
.strat-graph-btn:hover{border-color:var(--purple);color:var(--purple-light)}
.strat-graph-btn svg{width:12px;height:12px}

.portfolio-metrics{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:0.75rem;margin-bottom:1.5rem}
.metric-card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);padding:1rem;text-align:center}
.metric-value{font-size:1.8rem;font-weight:700;color:var(--purple-light);line-height:1}
.metric-label{font-size:0.72rem;color:var(--text-secondary);margin-top:0.3rem;text-transform:uppercase;letter-spacing:0.5px}

.portfolio-projects{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:1rem}
.project-mission-card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);padding:1.15rem;transition:border-color .15s;text-decoration:none;color:inherit;display:block}
.project-mission-card:hover{border-color:var(--purple);background:var(--bg-tertiary)}
.pmc-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:0.75rem}
.pmc-title{font-size:1rem;font-weight:700;color:var(--text-primary);display:flex;align-items:center;gap:0.5rem}
.pmc-status{font-size:0.68rem;padding:0.15rem 0.5rem;border-radius:8px;font-weight:600}
.pmc-status.active{background:rgba(52,211,153,.15);color:#34d399}
.pmc-status.planning{background:rgba(251,191,36,.15);color:#fbbf24}
.pmc-status.completed{background:rgba(96,165,250,.15);color:#60a5fa}
.pmc-status.blocked{background:rgba(248,113,113,.15);color:#f87171}
.pmc-missions{margin-top:0.5rem}
.pmc-mission{display:flex;align-items:center;gap:0.5rem;padding:0.35rem 0;border-bottom:1px solid var(--border-light, rgba(255,255,255,.05))}
.pmc-mission:last-child{border-bottom:none}
.pmc-mission-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.pmc-mission-dot.active{background:var(--green);box-shadow:0 0 6px var(--green)}
.pmc-mission-dot.planning{background:var(--yellow)}
.pmc-mission-dot.completed{background:var(--blue)}
.pmc-mission-name{font-size:0.82rem;color:var(--text-primary);flex:1}
.pmc-mission-progress{font-size:0.72rem;color:var(--text-secondary)}

.pmc-team{display:flex;gap:0.35rem;margin-top:0.6rem;flex-wrap:wrap}
.pmc-team-agent{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:var(--bg-tertiary);border:1px solid var(--border);cursor:default}
.pmc-team-agent svg{width:14px;height:14px;color:var(--text-secondary)}
.pmc-team-agent[title]:hover{border-color:var(--purple)}
.pmc-team-agent[title]:hover svg{color:var(--purple-light)}

.pmc-progress-bar{height:4px;background:var(--bg-tertiary);border-radius:2px;margin-top:0.6rem;overflow:hidden}
.pmc-progress-fill{height:100%;background:linear-gradient(90deg,var(--purple),var(--purple-light));border-radius:2px;transition:width .3s}

.pmc-no-missions{font-size:0.78rem;color:var(--text-secondary);font-style:italic;padding:0.5rem 0}

.pmc-badges{display:flex;gap:0.3rem;flex-wrap:wrap;margin-top:0.5rem}
.pmc-badge{font-size:0.58rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;padding:0.15rem 0.4rem;border-radius:4px;display:inline-flex;align-items:center;gap:0.2rem;line-height:1}
.pmc-badge svg{width:10px;height:10px}
.pmc-badge.tma{background:rgba(251,146,60,.15);color:#fb923c;border:1px solid rgba(251,146,60,.25)}
.pmc-badge.tma.resolved{background:rgba(34,197,94,.1);color:var(--green);border:1px solid rgba(34,197,94,.2)}
.pmc-badge.secu{background:rgba(239,68,68,.12);color:#f87171;border:1px solid rgba(239,68,68,.2)}
.pmc-badge.cicd{background:rgba(59,130,246,.12);color:#60a5fa;border:1px solid rgba(59,130,246,.2)}
.pmc-badge.running{background:rgba(124,58,237,.12);color:var(--purple-light);border:1px solid rgba(124,58,237,.2)}
.pmc-badge.nr{background:rgba(34,197,94,.1);color:var(--green);border:1px solid rgba(34,197,94,.2)}

.section-title{font-size:0.82rem;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:1px;margin-bottom:0;display:flex;align-items:center;gap:0.5rem;cursor:pointer;user-select:none;padding:0.5rem 0}
.section-title svg{width:16px;height:16px}
.section-title .chevron-s{width:14px;height:14px;color:var(--text-secondary);transition:transform .2s;flex-shrink:0}
.section-title.collapsed .chevron-s{transform:rotate(-90deg)}
.section-body{overflow:hidden;transition:max-height .25s ease;margin-top:0.75rem}
.section-body.collapsed{max-height:0!important;overflow:hidden;margin-top:0}

/* Epics table */
.epics-table{width:100%;border-collapse:collapse;font-size:0.78rem}
.epics-table th{text-align:left;padding:0.5rem 0.6rem;font-size:0.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text-muted);border-bottom:1px solid var(--border)}
.epics-table td{padding:0.45rem 0.6rem;border-bottom:1px solid var(--border-light,rgba(255,255,255,.04))}
.epics-table tr:hover td{background:var(--bg-tertiary)}
.epic-name{font-weight:600;color:var(--text-primary)}
.epic-project{font-size:0.68rem;color:var(--text-secondary)}
.epic-status{font-size:0.62rem;padding:0.1rem 0.4rem;border-radius:4px;font-weight:600}
.epic-status.active{background:rgba(52,211,153,.15);color:var(--green)}
.epic-status.planning{background:rgba(251,191,36,.15);color:var(--yellow)}
.epic-status.completed{background:rgba(96,165,250,.15);color:var(--blue)}
.epic-status.backlog{background:var(--bg-tertiary);color:var(--text-secondary)}
.epic-bar{width:100px;height:6px;background:var(--bg-tertiary);border-radius:3px;overflow:hidden;display:inline-block;vertical-align:middle}
.epic-bar-fill{height:100%;border-radius:3px;background:var(--green);transition:width .3s}

/* Gantt milestones */
.gantt-wrap{overflow-x:auto;padding:0.5rem 0}
.gantt-row{display:flex;align-items:center;gap:0.5rem;margin-bottom:0.3rem}
.gantt-label{width:140px;flex-shrink:0;font-size:0.72rem;font-weight:600;color:var(--text-primary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-align:right;padding-right:0.4rem}
.gantt-track{flex:1;height:18px;background:var(--bg-tertiary);border-radius:3px;position:relative;min-width:300px}
.gantt-bar{position:absolute;height:100%;border-radius:3px;top:0;font-size:0.58rem;display:flex;align-items:center;padding:0 0.3rem;color:#fff;font-weight:600;white-space:nowrap;overflow:hidden}
</style>

<div class="portfolio-grid">

    <!-- Strategic agents -->
    <div id="section-strat">
        <div class="section-title" onclick="togglePortSection('strat')">
            <svg class="chevron-s" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
            <svg class="icon icon-sm"><use href="#icon-target"/></svg> {{ _('strategic_committee') }}
        </div>
        <div class="section-body" id="body-strat">
        <div class="portfolio-strategy" id="stratContainer">
            {% for a in strategic_agents %}
            <div class="strat-card" data-agent="{{ loop.index0 }}" onclick="togglePopover(this, {{ loop.index0 }})">
                {% if a.avatar_url %}
                <img class="strat-photo" src="{{ a.avatar_url }}" alt="{{ a.name }}">
                {% else %}
                <div class="strat-avatar" style="background:{{ a.color }}20;border:2px solid {{ a.color }}">
                    <svg style="color:{{ a.color }}"><use href="#icon-{{ a.avatar }}"/></svg>
                </div>
                {% endif %}
                <div class="strat-info">
                    <div class="strat-name">{{ a.name }}</div>
                    <div class="strat-role">{{ a.role }}</div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Strategic committee graph -->
        {% if strat_graph and strat_graph.nodes %}
        <div class="strat-graph-wrap">
            <div class="strat-graph-header">
                <div class="strat-graph-title">
                    <svg><use href="#icon-git-merge"/></svg> {{ _('governance_flow') }}
                </div>
                <div class="strat-graph-actions">
                    <a href="/workflows/strategic-committee/edit" class="strat-graph-btn" onclick="event.stopPropagation()">
                        <svg><use href="#icon-settings"/></svg> Workflow
                    </a>
                    <button class="strat-graph-btn" onclick="launchStrategicCommittee()" id="btnLaunchComite" style="border-color:var(--purple);color:var(--purple)">
                        <svg><use href="#icon-play"/></svg> {{ _('launch_committee') }}
                    </button>
                </div>
            </div>
            <div class="strat-graph-body" id="stratGraphBody">
                <svg id="stratSvg" viewBox="0 0 820 160" xmlns="http://www.w3.org/2000/svg"></svg>
            </div>
        </div>
        {% endif %}
        </div><!-- /section-body strat -->
    </div>

    <!-- Popover fiche — rendered as fixed overlay -->
    <div class="agent-popover" id="agentPopover"></div>

    <!-- Portfolio metrics -->
    <div id="section-metrics">
        <div class="section-title" onclick="togglePortSection('metrics')">
            <svg class="chevron-s" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
            <svg class="icon icon-sm"><use href="#icon-chart"/></svg> Portfolio
        </div>
        <div class="section-body" id="body-metrics">
        <div class="portfolio-metrics">
            <div class="metric-card">
                <div class="metric-value">{{ total_missions }}</div>
                <div class="metric-label">{{ _("epics") }}</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">{{ active_missions }}</div>
                <div class="metric-label">{{ _("in_progress") }}</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">{{ total_tasks_done }}/{{ total_tasks }}</div>
                <div class="metric-label">{{ _("phases_done") }}</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">{{ total_agents }}</div>
                <div class="metric-label">{{ _("active_agents") }}</div>
            </div>
        </div><!-- /section-body metrics -->
    </div>

    <!-- Projects with missions -->
    <div id="section-projects">
        <div class="section-title" onclick="togglePortSection('projects')">
            <svg class="chevron-s" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
            <svg class="icon icon-sm"><use href="#icon-folder"/></svg> Projets
        </div>
        <div class="section-body" id="body-projects">
        <div class="portfolio-projects">
            {% for p in projects %}
            <a href="/projects/{{ p.id }}" class="project-mission-card">
                <div class="pmc-header">
                    <div class="pmc-title">
                        <span class="project-type-dot {{ p.factory_type }}"></span>
                        {{ p.name }}
                    </div>
                    {% if p.active_mission_count > 0 %}
                    <span class="pmc-status active">{{ p.active_mission_count }} active</span>
                    {% elif p.mission_count > 0 %}
                    <span class="pmc-status planning">{{ p.mission_count }} planned</span>
                    {% endif %}
                </div>

                {% if p.description %}
                <div style="font-size:0.78rem;color:var(--text-secondary);margin-bottom:0.5rem">{{ p.description[:100] }}{% if p.description|length > 100 %}…{% endif %}</div>
                {% endif %}

                <div class="pmc-missions">
                    {% for m in p.missions[:3] %}
                    <div class="pmc-mission">
                        <span class="pmc-mission-dot {{ m.run_status or m.status }}"></span>
                        <span class="pmc-mission-name">{{ m.name }}</span>
                        {% if m.task_progress %}
                        <span class="pmc-mission-progress">{{ m.task_progress }} phases</span>
                        {% endif %}
                        {% if m.current_phase %}
                        <span style="font-size:0.6rem;color:var(--purple-light);margin-left:0.2rem">{{ m.current_phase }}</span>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="pmc-no-missions">{{ _('no_epics_ready') }}</div>
                    {% endfor %}
                </div>

                {% if p.team_avatars %}
                <div class="pmc-team">
                    {% for avatar in p.team_avatars[:6] %}
                    <span class="pmc-team-agent" title="{{ avatar.name }}">
                        <svg><use href="#icon-{{ avatar.icon or 'bot' }}"/></svg>
                    </span>
                    {% endfor %}
                    {% if p.team_avatars|length > 6 %}
                    <span class="pmc-team-agent">+{{ p.team_avatars|length - 6 }}</span>
                    {% endif %}
                </div>
                {% endif %}

                {% if p.total_tasks > 0 %}
                <div class="pmc-progress-bar">
                    <div class="pmc-progress-fill" style="width:{{ (p.done_tasks / p.total_tasks * 100)|round }}%"></div>
                </div>
                {% endif %}

                <div class="pmc-badges">
                    {% if p.running_phases > 0 %}
                    <span class="pmc-badge running"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg> {{ p.running_phases }} phase{{ 's' if p.running_phases > 1 }}</span>
                    {% endif %}
                    {% if p.tma_active > 0 %}
                    <span class="pmc-badge tma"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg> {{ p.tma_active }} TMA</span>
                    {% endif %}
                    {% if p.tma_resolved > 0 %}
                    <span class="pmc-badge tma resolved"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> {{ p.tma_resolved }} fixed</span>
                    {% endif %}
                    {% if p.has_secu %}
                    <span class="pmc-badge secu"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg> Sécu</span>
                    {% endif %}
                    {% if p.has_cicd %}
                    <span class="pmc-badge cicd"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg> CI/CD</span>
                    {% endif %}
                </div>
            </a>
            {% endfor %}
        </div><!-- /section-body projects -->
    </div>

    <!-- Epics Progression -->
    {% if epics %}
    <div id="section-epics">
        <div class="section-title" onclick="togglePortSection('epics')">
            <svg class="chevron-s" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
            <svg class="icon icon-sm"><use href="#icon-rocket"/></svg> Épics & Progression
        </div>
        <div class="section-body" id="body-epics">
        <div style="background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden">
            <table class="epics-table">
                <thead><tr>
                    <th>{{ _("epic") }}</th><th>{{ _("project") }}</th><th>{{ _("status") }}</th><th>{{ _("current_phase") }}</th><th>{{ _("progression") }}</th><th>{{ _("wsjf") }}</th>
                </tr></thead>
                <tbody>
                {% for e in epics %}
                <tr>
                    <td><a href="/missions/{{ e.id }}" class="epic-name" style="text-decoration:none;color:inherit">{{ e.name }}</a></td>
                    <td class="epic-project">{{ e.project_name }}</td>
                    <td><span class="epic-status {{ e.run_status or e.status }}">{{ e.run_status or e.status }}</span></td>
                    <td style="font-size:0.72rem;color:var(--purple-light)">{{ e.current_phase or '—' }}</td>
                    <td>
                        <div class="epic-bar"><div class="epic-bar-fill" style="width:{{ e.pct }}%"></div></div>
                        <span style="font-size:0.65rem;color:var(--text-secondary);margin-left:0.3rem">{{ e.done }}/{{ e.total }} phases</span>
                    </td>
                    <td>{% if e.wsjf > 0 %}<span style="font-size:0.65rem;background:rgba(124,58,237,.15);color:var(--purple);padding:0.1rem 0.3rem;border-radius:3px;font-weight:600">{{ e.wsjf|round(1) }}</span>{% endif %}</td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        </div><!-- /section-body epics -->
    </div>
    {% endif %}

    <!-- Milestones Gantt -->
    {% if epics %}
    <div id="section-milestones">
        <div class="section-title" onclick="togglePortSection('milestones')">
            <svg class="chevron-s" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
            <svg class="icon icon-sm"><use href="#icon-calendar"/></svg> Milestones
        </div>
        <div class="section-body" id="body-milestones">
        <div style="background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);padding:0.8rem 1rem">
            <div class="gantt-wrap">
                {% set colors = ['var(--purple)', 'var(--blue)', 'var(--green)', 'var(--yellow)', '#f472b6', '#06b6d4'] %}
                {% for e in epics[:8] %}
                <div class="gantt-row">
                    <div class="gantt-label" title="{{ e.name }}">{{ e.name[:20] }}{% if e.name|length > 20 %}…{% endif %}</div>
                    <div class="gantt-track">
                        <div class="gantt-bar" style="left:{{ (loop.index0 * 8)|int }}%;width:{{ e.pct|int + 15 }}%;background:{{ colors[loop.index0 % 6] }}">
                            {{ e.pct }}%
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div><!-- /section-body milestones -->
    </div>
    {% endif %}
</div>

<script>
const agents = {{ strategic_agents | tojson }};
let activeCard = null;

function esc(s){ const d=document.createElement('div'); d.textContent=s||''; return d.innerHTML; }

function closePopover(){
    document.getElementById('agentPopover').classList.remove('visible');
    if(activeCard){ activeCard.classList.remove('active'); activeCard=null; }
}

function togglePopover(card, idx){
    const pop = document.getElementById('agentPopover');
    if(activeCard === card){ closePopover(); return; }
    if(activeCard) activeCard.classList.remove('active');
    activeCard = card;
    card.classList.add('active');

    const a = agents[idx];
    const photo = a.avatar_url
        ? `<img class="ap-photo" src="${a.avatar_url}" alt="${esc(a.name)}">`
        : `<div class="strat-avatar" style="background:${a.color}20;border:2px solid ${a.color}"><svg style="color:${a.color};width:20px;height:20px"><use href="#icon-${a.avatar}"/></svg></div>`;

    let skillsHtml = '';
    if(a.skills && a.skills.length){
        skillsHtml = `<div class="ap-section">
            <div class="ap-section-title"><svg class="icon icon-xs"><use href="#icon-layers"/></svg> Skills</div>
            <div class="ap-tags">${a.skills.map(s=>`<span class="ap-tag ap-tag--skill">${esc(s)}</span>`).join('')}</div>
        </div>`;
    }
    let toolsHtml = '';
    if(a.tools && a.tools.length){
        toolsHtml = `<div class="ap-section">
            <div class="ap-section-title"><svg class="icon icon-xs"><use href="#icon-settings"/></svg> Tools</div>
            <div class="ap-tags">${a.tools.map(t=>`<span class="ap-tag ap-tag--tool">${esc(t)}</span>`).join('')}</div>
        </div>`;
    }
    let mcpsHtml = '';
    if(a.mcps && a.mcps.length){
        mcpsHtml = `<div class="ap-section">
            <div class="ap-section-title"><svg class="icon icon-xs"><use href="#icon-plug"/></svg> MCPs</div>
            <div class="ap-tags">${a.mcps.map(m=>`<span class="ap-tag ap-tag--mcp">${esc(m)}</span>`).join('')}</div>
        </div>`;
    }
    let modelHtml = '';
    if(a.model || a.provider){
        modelHtml = `<div class="ap-section">
            <div class="ap-section-title"><svg class="icon icon-xs"><use href="#icon-brain"/></svg> LLM</div>
            <span class="ap-model">${esc(a.provider||'')} ${esc(a.model||'default')}</span>
        </div>`;
    }
    let personaHtml = '';
    if(a.persona){
        personaHtml = `<div class="ap-section">
            <div class="ap-section-title"><svg class="icon icon-xs"><use href="#icon-user"/></svg> Persona</div>
            <div class="ap-desc" style="white-space:pre-line">${esc(a.persona)}</div>
        </div>`;
    }
    let motivHtml = '';
    if(a.motivation){
        motivHtml = `<div class="ap-section">
            <div class="ap-section-title"><svg class="icon icon-xs"><use href="#icon-zap"/></svg> Motivation</div>
            <div class="ap-desc" style="white-space:pre-line">${esc(a.motivation)}</div>
        </div>`;
    }
    let descHtml = '';
    if(a.description){
        descHtml = `<div class="ap-desc">${esc(a.description)}</div>`;
    }

    pop.innerHTML = `
        <button class="agent-popover-close" onclick="event.stopPropagation();closePopover()"><svg class="icon icon-xs"><use href="#icon-x"/></svg></button>
        <div class="ap-header">
            ${photo}
            <div class="ap-info">
                <div class="ap-name">${esc(a.name)}</div>
                <div class="ap-role">${esc(a.role)}</div>
            </div>
        </div>
        ${a.tagline ? `<div class="ap-tagline">${esc(a.tagline)}</div>` : ''}
        ${descHtml}
        ${personaHtml}
        ${motivHtml}
        ${skillsHtml}
        ${toolsHtml}
        ${mcpsHtml}
        ${modelHtml}
    `;

    // Position popover below the card (fixed positioning)
    const rect = card.getBoundingClientRect();
    let left = rect.left;
    let top = rect.bottom + 6;
    // Clamp to viewport
    if(left + 320 > window.innerWidth) left = window.innerWidth - 330;
    if(left < 10) left = 10;
    if(top + 400 > window.innerHeight) top = rect.top - pop.offsetHeight - 6; // flip above
    pop.style.left = left + 'px';
    pop.style.top = top + 'px';
    pop.classList.add('visible');
}

// Close on outside click
document.addEventListener('click', function(e){
    if(!e.target.closest('.strat-card') && !e.target.closest('.agent-popover')){
        closePopover();
    }
});
// Close on Escape
document.addEventListener('keydown', function(e){ if(e.key==='Escape') closePopover(); });

// ── Strategic committee graph — render on load ──
const STRAT_GRAPH = {{ strat_graph | tojson if strat_graph else '{"nodes":[],"edges":[]}' }};

function renderStratGraph(){
    const svg = document.getElementById('stratSvg');
    if(!svg || !STRAT_GRAPH.nodes.length) return;
    const NS = 'http://www.w3.org/2000/svg';
    const nodes = STRAT_GRAPH.nodes;
    const edges = STRAT_GRAPH.edges || [];
    const NR = 16; // node radius — compact

    // Compact Y positions (fit in 160px viewBox)
    const yMap = {20: 10, 140: 50, 280: 95, 330: 95};

    // Build node lookup
    const nodeMap = {};
    nodes.forEach(n => { n._cx = n.x + 65; n._cy = (yMap[n.y] || n.y) + NR; nodeMap[n.id] = n; });

    // Defs: arrowhead + clip paths
    const defs = document.createElementNS(NS, 'defs');
    defs.innerHTML = '<marker id="arrowS" viewBox="0 0 10 7" refX="10" refY="3.5" markerWidth="8" markerHeight="6" orient="auto-start-reverse"><path d="M0,0 L10,3.5 L0,7z" fill="#888" opacity="0.6"/></marker>';
    nodes.forEach(n => {
        if(n.avatar_url){
            const clip = document.createElementNS(NS, 'clipPath');
            clip.setAttribute('id', 'clip-'+n.id);
            const cc = document.createElementNS(NS, 'circle');
            cc.setAttribute('cx', n._cx); cc.setAttribute('cy', n._cy); cc.setAttribute('r', NR-2);
            clip.appendChild(cc);
            defs.appendChild(clip);
        }
    });
    svg.appendChild(defs);

    // Edges (curved)
    const edgeG = document.createElementNS(NS, 'g');
    edges.forEach(e => {
        const fn = nodeMap[e.from], tn = nodeMap[e.to];
        if(!fn || !tn) return;
        const x1 = fn._cx, y1 = fn._cy, x2 = tn._cx, y2 = tn._cy;
        const dx = x2-x1, dy = y2-y1, len = Math.sqrt(dx*dx+dy*dy) || 1;
        const ox = -dy/len * 4, oy = dx/len * 4;
        // Shorten to not overlap circles
        const sx = x1 + dx/len*(NR+4) + ox, sy = y1 + dy/len*(NR+4) + oy;
        const ex = x2 - dx/len*(NR+6) + ox, ey = y2 - dy/len*(NR+6) + oy;
        const mx = (x1+x2)/2 + ox*2, my = (y1+y2)/2 + oy*2;
        const path = document.createElementNS(NS, 'path');
        path.setAttribute('d', `M${sx},${sy} Q${mx},${my} ${ex},${ey}`);
        path.setAttribute('fill', 'none');
        path.setAttribute('stroke', e.color || '#555');
        path.setAttribute('stroke-width', '1.5');
        path.setAttribute('opacity', '0.5');
        path.setAttribute('marker-end', 'url(#arrowS)');
        edgeG.appendChild(path);
        if(e.label){
            const lbl = document.createElementNS(NS, 'text');
            lbl.setAttribute('x', mx); lbl.setAttribute('y', my - 5);
            lbl.setAttribute('text-anchor', 'middle');
            lbl.setAttribute('fill', e.color || '#888');
            lbl.setAttribute('font-size', '8'); lbl.setAttribute('opacity', '0.7');
            lbl.textContent = e.label;
            edgeG.appendChild(lbl);
        }
    });
    svg.appendChild(edgeG);

    // Nodes — circle avatar + name label (like dsi_workflow)
    const nodeG = document.createElementNS(NS, 'g');
    nodes.forEach(n => {
        const g = document.createElementNS(NS, 'g');
        g.style.cursor = 'pointer';
        // Outer ring
        const ring = document.createElementNS(NS, 'circle');
        ring.setAttribute('cx', n._cx); ring.setAttribute('cy', n._cy); ring.setAttribute('r', NR);
        ring.setAttribute('fill', 'none'); ring.setAttribute('stroke', n.color || '#7c3aed');
        ring.setAttribute('stroke-width', '2.5');
        g.appendChild(ring);
        // Avatar photo or fallback circle
        if(n.avatar_url){
            const img = document.createElementNS(NS, 'image');
            img.setAttribute('href', n.avatar_url);
            img.setAttribute('x', n._cx - (NR-2)); img.setAttribute('y', n._cy - (NR-2));
            img.setAttribute('width', (NR-2)*2); img.setAttribute('height', (NR-2)*2);
            img.setAttribute('clip-path', `url(#clip-${n.id})`);
            g.appendChild(img);
        } else {
            const inner = document.createElementNS(NS, 'circle');
            inner.setAttribute('cx', n._cx); inner.setAttribute('cy', n._cy); inner.setAttribute('r', NR-2);
            inner.setAttribute('fill', (n.color||'#7c3aed')+'20');
            g.appendChild(inner);
            const ini = document.createElementNS(NS, 'text');
            ini.setAttribute('x', n._cx); ini.setAttribute('y', n._cy+4);
            ini.setAttribute('text-anchor', 'middle'); ini.setAttribute('fill', n.color||'#7c3aed');
            ini.setAttribute('font-size', '9'); ini.setAttribute('font-weight', '700');
            ini.textContent = n.label.slice(0,3);
            g.appendChild(ini);
        }
        // Name label below
        const txt = document.createElementNS(NS, 'text');
        txt.setAttribute('x', n._cx); txt.setAttribute('y', n._cy + NR + 10);
        txt.setAttribute('text-anchor', 'middle'); txt.setAttribute('fill', '#c4b5fd');
        txt.setAttribute('font-size', '8'); txt.setAttribute('font-weight', '600');
        txt.setAttribute('font-family', "'Inter','SF Pro',sans-serif");
        txt.textContent = n.label;
        g.appendChild(txt);
        // Click → popover
        g.addEventListener('click', () => {
            const idx = agents.findIndex(a => a.id === n.agent_id);
            if(idx >= 0){
                const card = document.querySelector(`[data-agent="${idx}"]`);
                if(card) { card.scrollIntoView({behavior:'smooth', block:'center'}); togglePopover(card, idx); }
            }
        });
        nodeG.appendChild(g);
    });
    svg.appendChild(nodeG);
}

async function launchStrategicCommittee(){
    const btn = document.getElementById('btnLaunchComite');
    btn.disabled = true;
    btn.innerHTML = '<svg style="width:12px;height:12px"><use href="#icon-loader"/></svg> Création...';
    try {
        const resp = await fetch('/api/strategic-committee/launch', {method:'POST', headers:{'Content-Type':'application/json'}});
        const data = await resp.json();
        if(data.session_id){
            window.location.href = `/sessions/${data.session_id}/live`;
        } else {
            alert(data.error || _('error_generic'));
            btn.disabled = false;
            btn.innerHTML = '<svg style="width:12px;height:12px"><use href="#icon-play"/></svg> {{ _('launch_committee') }}';
        }
    } catch(e){
        alert(_('error') + ': ' + e.message);
        btn.disabled = false;
        btn.innerHTML = '<svg style="width:12px;height:12px"><use href="#icon-play"/></svg> {{ _('launch_committee') }}';
    }
}

// Auto-render graph on page load
if(STRAT_GRAPH.nodes && STRAT_GRAPH.nodes.length) renderStratGraph();

// ── Collapsible sections with localStorage ──
function togglePortSection(id){
    const title = document.querySelector('#section-'+id+' .section-title');
    const body = document.getElementById('body-'+id);
    if(!title || !body) return;
    const collapsed = title.classList.toggle('collapsed');
    body.classList.toggle('collapsed', collapsed);
    localStorage.setItem('portfolio_collapse_'+id, collapsed?'1':'0');
}
function restorePortCollapse(){
    ['strat','metrics','projects','epics','milestones'].forEach(id=>{
        if(localStorage.getItem('portfolio_collapse_'+id)==='1'){
            const title = document.querySelector('#section-'+id+' .section-title');
            const body = document.getElementById('body-'+id);
            if(title && body){ title.classList.add('collapsed'); body.classList.add('collapsed'); }
        }
    });
}
restorePortCollapse();
</script>
</div><!-- /portfolio-inner -->
</div><!-- /tab-content -->
<script>
function switchTab(btn){
    document.querySelectorAll('.tabs .tab').forEach(t=>t.classList.remove('active'));
    btn.classList.add('active');
}
</script>
{% endblock %}
