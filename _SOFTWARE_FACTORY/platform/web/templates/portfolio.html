{% extends "base.html" %}

{% block topbar_actions %}
<a href="/missions?action=new" class="btn btn-primary">
    <svg class="icon icon-sm"><use href="#icon-plus"/></svg> Nouvelle Mission
</a>
{% endblock %}

{% block content %}
<style>
/* ── Portfolio Dashboard ── */
.portfolio-grid{display:grid;grid-template-columns:1fr;gap:1.5rem;padding:0.5rem 0}

/* Strategic agent cards — compact, clickable */
.portfolio-strategy{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:0.75rem;margin-bottom:1.5rem;position:relative}
.strat-card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);padding:0.85rem 1rem;display:flex;align-items:center;gap:0.7rem;cursor:pointer;transition:border-color .15s,box-shadow .15s}
.strat-card:hover{border-color:var(--purple);box-shadow:0 4px 16px rgba(124,58,237,.12)}
.strat-card.active{border-color:var(--purple);box-shadow:0 4px 16px rgba(124,58,237,.2)}
.strat-photo{width:42px;height:42px;border-radius:50%;flex-shrink:0;object-fit:cover;border:2px solid var(--border)}
.strat-avatar{width:42px;height:42px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.strat-avatar svg{width:20px;height:20px}
.strat-info{flex:1;min-width:0}
.strat-name{font-size:0.85rem;font-weight:700;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.strat-role{font-size:0.68rem;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* Popover fiche — fixed position to avoid container clipping */
.agent-popover{position:fixed;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:10px;padding:0.75rem 0.85rem;font-size:0.78rem;color:var(--text-primary);width:320px;max-height:70vh;overflow-y:auto;box-shadow:0 6px 24px rgba(0,0,0,.55);pointer-events:auto;z-index:1000;display:none;word-break:break-word}
.agent-popover.visible{display:block}
.agent-popover-close{position:absolute;top:0.35rem;right:0.5rem;background:none;border:none;color:var(--text-secondary);cursor:pointer;font-size:0.85rem;padding:0.2rem}
.agent-popover-close:hover{color:var(--text-primary)}
.ap-header{display:flex;align-items:center;gap:0.6rem;margin-bottom:0.5rem;padding-bottom:0.45rem;border-bottom:1px solid var(--border)}
.ap-photo{width:44px;height:44px;border-radius:50%;flex-shrink:0;object-fit:cover;border:2px solid var(--border)}
.ap-info{flex:1}
.ap-name{font-weight:700;font-size:0.88rem}
.ap-role{font-size:0.72rem;color:var(--text-secondary)}
.ap-tagline{font-size:0.72rem;color:var(--text-secondary);font-style:italic;line-height:1.3;margin-bottom:0.35rem}
.ap-desc{font-size:0.72rem;color:var(--text-secondary);line-height:1.35;margin-top:0.35rem}
.ap-section{margin-top:0.45rem}
.ap-section-title{font-size:0.68rem;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:0.2rem;font-weight:600}
.ap-tags{display:flex;flex-wrap:wrap;gap:0.25rem}
.ap-tag{display:inline-block;padding:0.1rem 0.4rem;border-radius:4px;font-size:0.68rem;background:var(--bg-secondary);border:1px solid var(--border)}
.ap-tag--skill{border-color:rgba(124,58,237,.35);color:var(--purple)}
.ap-tag--tool{border-color:rgba(16,185,129,.3);color:var(--green)}
.ap-tag--mcp{border-color:rgba(245,158,11,.3);color:var(--yellow)}
.ap-model{display:inline-flex;align-items:center;gap:0.3rem;font-size:0.68rem;padding:0.12rem 0.4rem;border-radius:4px;background:var(--bg-secondary);border:1px solid var(--border);color:var(--text-secondary);font-family:var(--font-mono)}

/* Strategic graph mini — inline SVG */
.strat-graph-wrap{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);margin-top:0.75rem;margin-bottom:0.5rem;position:relative;overflow:hidden}
.strat-graph-header{display:flex;align-items:center;justify-content:space-between;padding:0.6rem 0.85rem;cursor:pointer;user-select:none}
.strat-graph-header:hover{background:var(--bg-tertiary)}
.strat-graph-title{font-size:0.75rem;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.5px;display:flex;align-items:center;gap:0.4rem}
.strat-graph-title svg{width:14px;height:14px}
.strat-graph-toggle{font-size:0.68rem;color:var(--text-secondary);display:flex;align-items:center;gap:0.3rem}
.strat-graph-toggle svg{width:12px;height:12px;transition:transform .2s}
.strat-graph-toggle.open svg{transform:rotate(180deg)}
.strat-graph-body{padding:0 0.5rem 0.5rem;display:none}
.strat-graph-body.visible{display:block}
.strat-graph-body svg{width:100%;height:auto}
.strat-graph-actions{display:flex;gap:0.5rem;align-items:center}
.strat-graph-btn{font-size:0.68rem;padding:0.2rem 0.6rem;border-radius:6px;border:1px solid var(--border);background:var(--bg-tertiary);color:var(--text-secondary);cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:0.3rem;transition:all .15s}
.strat-graph-btn:hover{border-color:var(--purple);color:var(--purple-light)}
.strat-graph-btn svg{width:12px;height:12px}

.portfolio-metrics{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:0.75rem;margin-bottom:1.5rem}
.metric-card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);padding:1rem;text-align:center}
.metric-value{font-size:1.8rem;font-weight:700;color:var(--purple-light);line-height:1}
.metric-label{font-size:0.72rem;color:var(--text-secondary);margin-top:0.3rem;text-transform:uppercase;letter-spacing:0.5px}

.portfolio-projects{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:1rem}
.project-mission-card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);padding:1.15rem;transition:border-color .15s;text-decoration:none;color:inherit;display:block}
.project-mission-card:hover{border-color:var(--purple);background:var(--bg-tertiary)}
.pmc-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:0.75rem}
.pmc-title{font-size:1rem;font-weight:700;color:var(--text-primary);display:flex;align-items:center;gap:0.5rem}
.pmc-status{font-size:0.68rem;padding:0.15rem 0.5rem;border-radius:8px;font-weight:600}
.pmc-status.active{background:rgba(52,211,153,.15);color:#34d399}
.pmc-status.planning{background:rgba(251,191,36,.15);color:#fbbf24}
.pmc-status.completed{background:rgba(96,165,250,.15);color:#60a5fa}
.pmc-status.blocked{background:rgba(248,113,113,.15);color:#f87171}
.pmc-missions{margin-top:0.5rem}
.pmc-mission{display:flex;align-items:center;gap:0.5rem;padding:0.35rem 0;border-bottom:1px solid var(--border-light, rgba(255,255,255,.05))}
.pmc-mission:last-child{border-bottom:none}
.pmc-mission-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.pmc-mission-dot.active{background:var(--green);box-shadow:0 0 6px var(--green)}
.pmc-mission-dot.planning{background:var(--yellow)}
.pmc-mission-dot.completed{background:var(--blue)}
.pmc-mission-name{font-size:0.82rem;color:var(--text-primary);flex:1}
.pmc-mission-progress{font-size:0.72rem;color:var(--text-secondary)}

.pmc-team{display:flex;gap:0.35rem;margin-top:0.6rem;flex-wrap:wrap}
.pmc-team-agent{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:var(--bg-tertiary);border:1px solid var(--border);cursor:default}
.pmc-team-agent svg{width:14px;height:14px;color:var(--text-secondary)}
.pmc-team-agent[title]:hover{border-color:var(--purple)}
.pmc-team-agent[title]:hover svg{color:var(--purple-light)}

.pmc-progress-bar{height:4px;background:var(--bg-tertiary);border-radius:2px;margin-top:0.6rem;overflow:hidden}
.pmc-progress-fill{height:100%;background:linear-gradient(90deg,var(--purple),var(--purple-light));border-radius:2px;transition:width .3s}

.pmc-no-missions{font-size:0.78rem;color:var(--text-secondary);font-style:italic;padding:0.5rem 0}

.section-title{font-size:0.82rem;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:1px;margin-bottom:0.75rem;display:flex;align-items:center;gap:0.5rem}
.section-title svg{width:16px;height:16px}
</style>

<div class="portfolio-grid">

    <!-- Strategic agents -->
    <div>
        <div class="section-title">
            <svg class="icon icon-sm"><use href="#icon-target"/></svg> Comité Stratégique
        </div>
        <div class="portfolio-strategy" id="stratContainer">
            {% for a in strategic_agents %}
            <div class="strat-card" data-agent="{{ loop.index0 }}" onclick="togglePopover(this, {{ loop.index0 }})">
                {% if a.avatar_url %}
                <img class="strat-photo" src="{{ a.avatar_url }}" alt="{{ a.name }}">
                {% else %}
                <div class="strat-avatar" style="background:{{ a.color }}20;border:2px solid {{ a.color }}">
                    <svg style="color:{{ a.color }}"><use href="#icon-{{ a.avatar }}"/></svg>
                </div>
                {% endif %}
                <div class="strat-info">
                    <div class="strat-name">{{ a.name }}</div>
                    <div class="strat-role">{{ a.role }}</div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Strategic committee graph -->
        {% if strat_graph and strat_graph.nodes %}
        <div class="strat-graph-wrap">
            <div class="strat-graph-header" onclick="toggleStratGraph()">
                <div class="strat-graph-title">
                    <svg><use href="#icon-share"/></svg> Flux de gouvernance
                </div>
                <div class="strat-graph-actions">
                    <a href="/workflows/strategic-committee/edit" class="strat-graph-btn" onclick="event.stopPropagation()">
                        <svg><use href="#icon-settings"/></svg> Editer
                    </a>
                    <div class="strat-graph-toggle" id="stratGraphToggle">
                        <svg><use href="#icon-chevron-down"/></svg>
                    </div>
                </div>
            </div>
            <div class="strat-graph-body" id="stratGraphBody">
                <svg id="stratSvg" viewBox="0 0 820 400" xmlns="http://www.w3.org/2000/svg"></svg>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Popover fiche — rendered as fixed overlay -->
    <div class="agent-popover" id="agentPopover"></div>

    <!-- Portfolio metrics -->
    <div>
        <div class="section-title">
            <svg class="icon icon-sm"><use href="#icon-chart"/></svg> Portfolio
        </div>
        <div class="portfolio-metrics">
            <div class="metric-card">
                <div class="metric-value">{{ total_missions }}</div>
                <div class="metric-label">Missions</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">{{ active_missions }}</div>
                <div class="metric-label">En cours</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">{{ total_tasks_done }}/{{ total_tasks }}</div>
                <div class="metric-label">Tasks Done</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">{{ total_agents }}</div>
                <div class="metric-label">Agents Actifs</div>
            </div>
        </div>
    </div>

    <!-- Projects with missions -->
    <div>
        <div class="section-title">
            <svg class="icon icon-sm"><use href="#icon-folder"/></svg> Projets
        </div>
        <div class="portfolio-projects">
            {% for p in projects %}
            <a href="/projects/{{ p.id }}" class="project-mission-card">
                <div class="pmc-header">
                    <div class="pmc-title">
                        <span class="project-type-dot {{ p.factory_type }}"></span>
                        {{ p.name }}
                    </div>
                    {% if p.active_mission_count > 0 %}
                    <span class="pmc-status active">{{ p.active_mission_count }} active</span>
                    {% elif p.mission_count > 0 %}
                    <span class="pmc-status planning">{{ p.mission_count }} planned</span>
                    {% endif %}
                </div>

                {% if p.description %}
                <div style="font-size:0.78rem;color:var(--text-secondary);margin-bottom:0.5rem">{{ p.description[:100] }}{% if p.description|length > 100 %}…{% endif %}</div>
                {% endif %}

                <div class="pmc-missions">
                    {% for m in p.missions[:3] %}
                    <div class="pmc-mission">
                        <span class="pmc-mission-dot {{ m.status }}"></span>
                        <span class="pmc-mission-name">{{ m.name }}</span>
                        {% if m.task_progress %}
                        <span class="pmc-mission-progress">{{ m.task_progress }}</span>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="pmc-no-missions">Aucune mission — prête pour la prochaine vision</div>
                    {% endfor %}
                </div>

                {% if p.team_avatars %}
                <div class="pmc-team">
                    {% for avatar in p.team_avatars[:6] %}
                    <span class="pmc-team-agent" title="{{ avatar.name }}">
                        <svg><use href="#icon-{{ avatar.icon or 'bot' }}"/></svg>
                    </span>
                    {% endfor %}
                    {% if p.team_avatars|length > 6 %}
                    <span class="pmc-team-agent">+{{ p.team_avatars|length - 6 }}</span>
                    {% endif %}
                </div>
                {% endif %}

                {% if p.total_tasks > 0 %}
                <div class="pmc-progress-bar">
                    <div class="pmc-progress-fill" style="width:{{ (p.done_tasks / p.total_tasks * 100)|round }}%"></div>
                </div>
                {% endif %}
            </a>
            {% endfor %}
        </div>
    </div>
</div>

<script>
const agents = {{ strategic_agents | tojson }};
let activeCard = null;

function esc(s){ const d=document.createElement('div'); d.textContent=s||''; return d.innerHTML; }

function closePopover(){
    document.getElementById('agentPopover').classList.remove('visible');
    if(activeCard){ activeCard.classList.remove('active'); activeCard=null; }
}

function togglePopover(card, idx){
    const pop = document.getElementById('agentPopover');
    if(activeCard === card){ closePopover(); return; }
    if(activeCard) activeCard.classList.remove('active');
    activeCard = card;
    card.classList.add('active');

    const a = agents[idx];
    const photo = a.avatar_url
        ? `<img class="ap-photo" src="${a.avatar_url}" alt="${esc(a.name)}">`
        : `<div class="strat-avatar" style="background:${a.color}20;border:2px solid ${a.color}"><svg style="color:${a.color};width:20px;height:20px"><use href="#icon-${a.avatar}"/></svg></div>`;

    let skillsHtml = '';
    if(a.skills && a.skills.length){
        skillsHtml = `<div class="ap-section">
            <div class="ap-section-title"><svg class="icon icon-xs"><use href="#icon-layers"/></svg> Skills</div>
            <div class="ap-tags">${a.skills.map(s=>`<span class="ap-tag ap-tag--skill">${esc(s)}</span>`).join('')}</div>
        </div>`;
    }
    let toolsHtml = '';
    if(a.tools && a.tools.length){
        toolsHtml = `<div class="ap-section">
            <div class="ap-section-title"><svg class="icon icon-xs"><use href="#icon-settings"/></svg> Tools</div>
            <div class="ap-tags">${a.tools.map(t=>`<span class="ap-tag ap-tag--tool">${esc(t)}</span>`).join('')}</div>
        </div>`;
    }
    let mcpsHtml = '';
    if(a.mcps && a.mcps.length){
        mcpsHtml = `<div class="ap-section">
            <div class="ap-section-title"><svg class="icon icon-xs"><use href="#icon-plug"/></svg> MCPs</div>
            <div class="ap-tags">${a.mcps.map(m=>`<span class="ap-tag ap-tag--mcp">${esc(m)}</span>`).join('')}</div>
        </div>`;
    }
    let modelHtml = '';
    if(a.model || a.provider){
        modelHtml = `<div class="ap-section">
            <div class="ap-section-title"><svg class="icon icon-xs"><use href="#icon-brain"/></svg> LLM</div>
            <span class="ap-model">${esc(a.provider||'')} ${esc(a.model||'default')}</span>
        </div>`;
    }
    let personaHtml = '';
    if(a.persona){
        personaHtml = `<div class="ap-section">
            <div class="ap-section-title"><svg class="icon icon-xs"><use href="#icon-user"/></svg> Persona</div>
            <div class="ap-desc" style="white-space:pre-line">${esc(a.persona)}</div>
        </div>`;
    }
    let motivHtml = '';
    if(a.motivation){
        motivHtml = `<div class="ap-section">
            <div class="ap-section-title"><svg class="icon icon-xs"><use href="#icon-zap"/></svg> Motivation</div>
            <div class="ap-desc" style="white-space:pre-line">${esc(a.motivation)}</div>
        </div>`;
    }
    let descHtml = '';
    if(a.description){
        descHtml = `<div class="ap-desc">${esc(a.description)}</div>`;
    }

    pop.innerHTML = `
        <button class="agent-popover-close" onclick="event.stopPropagation();closePopover()"><svg class="icon icon-xs"><use href="#icon-x"/></svg></button>
        <div class="ap-header">
            ${photo}
            <div class="ap-info">
                <div class="ap-name">${esc(a.name)}</div>
                <div class="ap-role">${esc(a.role)}</div>
            </div>
        </div>
        ${a.tagline ? `<div class="ap-tagline">${esc(a.tagline)}</div>` : ''}
        ${descHtml}
        ${personaHtml}
        ${motivHtml}
        ${skillsHtml}
        ${toolsHtml}
        ${mcpsHtml}
        ${modelHtml}
    `;

    // Position popover below the card (fixed positioning)
    const rect = card.getBoundingClientRect();
    let left = rect.left;
    let top = rect.bottom + 6;
    // Clamp to viewport
    if(left + 320 > window.innerWidth) left = window.innerWidth - 330;
    if(left < 10) left = 10;
    if(top + 400 > window.innerHeight) top = rect.top - pop.offsetHeight - 6; // flip above
    pop.style.left = left + 'px';
    pop.style.top = top + 'px';
    pop.classList.add('visible');
}

// Close on outside click
document.addEventListener('click', function(e){
    if(!e.target.closest('.strat-card') && !e.target.closest('.agent-popover')){
        closePopover();
    }
});
// Close on Escape
document.addEventListener('keydown', function(e){ if(e.key==='Escape') closePopover(); });

// ── Strategic committee graph ──
const STRAT_GRAPH = {{ strat_graph | tojson if strat_graph else '{"nodes":[],"edges":[]}' }};

function toggleStratGraph(){
    const body = document.getElementById('stratGraphBody');
    const toggle = document.getElementById('stratGraphToggle');
    if(!body) return;
    const open = body.classList.toggle('visible');
    toggle.classList.toggle('open', open);
    if(open && !body.dataset.rendered){
        renderStratGraph();
        body.dataset.rendered = '1';
    }
}

function renderStratGraph(){
    const svg = document.getElementById('stratSvg');
    if(!svg || !STRAT_GRAPH.nodes.length) return;
    const NS = 'http://www.w3.org/2000/svg';
    const nodes = STRAT_GRAPH.nodes;
    const edges = STRAT_GRAPH.edges || [];
    const NW = 130, NH = 48, R = 10;

    // Build node lookup
    const nodeMap = {};
    nodes.forEach(n => { nodeMap[n.id] = n; });

    // Edges
    const edgeG = document.createElementNS(NS, 'g');
    edges.forEach(e => {
        const fn = nodeMap[e.from], tn = nodeMap[e.to];
        if(!fn || !tn) return;
        const x1 = fn.x + NW/2, y1 = fn.y + NH/2;
        const x2 = tn.x + NW/2, y2 = tn.y + NH/2;
        // Offset for bidirectional edges
        const dx = x2-x1, dy = y2-y1, len = Math.sqrt(dx*dx+dy*dy) || 1;
        const ox = -dy/len * 4, oy = dx/len * 4;
        const path = document.createElementNS(NS, 'path');
        const mx = (x1+x2)/2 + ox*2, my = (y1+y2)/2 + oy*2;
        path.setAttribute('d', `M${x1+ox},${y1+oy} Q${mx},${my} ${x2+ox},${y2+oy}`);
        path.setAttribute('fill', 'none');
        path.setAttribute('stroke', e.color || '#555');
        path.setAttribute('stroke-width', '1.5');
        path.setAttribute('opacity', '0.6');
        path.setAttribute('marker-end', 'url(#arrowS)');
        edgeG.appendChild(path);
        // Label
        if(e.label){
            const lbl = document.createElementNS(NS, 'text');
            lbl.setAttribute('x', mx);
            lbl.setAttribute('y', my - 4);
            lbl.setAttribute('text-anchor', 'middle');
            lbl.setAttribute('fill', e.color || '#888');
            lbl.setAttribute('font-size', '9');
            lbl.setAttribute('opacity', '0.8');
            lbl.textContent = e.label;
            edgeG.appendChild(lbl);
        }
    });

    // Arrowhead marker
    const defs = document.createElementNS(NS, 'defs');
    defs.innerHTML = '<marker id="arrowS" viewBox="0 0 10 7" refX="10" refY="3.5" markerWidth="8" markerHeight="6" orient="auto-start-reverse"><path d="M0,0 L10,3.5 L0,7z" fill="#888" opacity="0.6"/></marker>';
    svg.appendChild(defs);
    svg.appendChild(edgeG);

    // Nodes
    const nodeG = document.createElementNS(NS, 'g');
    nodes.forEach(n => {
        const g = document.createElementNS(NS, 'g');
        g.setAttribute('transform', `translate(${n.x},${n.y})`);
        g.style.cursor = 'pointer';
        // Card bg
        const rect = document.createElementNS(NS, 'rect');
        rect.setAttribute('width', NW); rect.setAttribute('height', NH);
        rect.setAttribute('rx', R); rect.setAttribute('fill', '#1a1128');
        rect.setAttribute('stroke', n.color || '#7c3aed');
        rect.setAttribute('stroke-width', '1.5');
        g.appendChild(rect);
        // Avatar circle
        if(n.avatar_url){
            const clipId = 'clip-' + n.id;
            const clip = document.createElementNS(NS, 'clipPath');
            clip.setAttribute('id', clipId);
            const cc = document.createElementNS(NS, 'circle');
            cc.setAttribute('cx', '18'); cc.setAttribute('cy', NH/2);
            cc.setAttribute('r', '14');
            clip.appendChild(cc);
            defs.appendChild(clip);
            const img = document.createElementNS(NS, 'image');
            img.setAttribute('href', n.avatar_url);
            img.setAttribute('x', '4'); img.setAttribute('y', NH/2 - 14);
            img.setAttribute('width', '28'); img.setAttribute('height', '28');
            img.setAttribute('clip-path', `url(#${clipId})`);
            g.appendChild(img);
        } else {
            const circ = document.createElementNS(NS, 'circle');
            circ.setAttribute('cx', '18'); circ.setAttribute('cy', NH/2);
            circ.setAttribute('r', '14'); circ.setAttribute('fill', (n.color || '#7c3aed') + '30');
            circ.setAttribute('stroke', n.color || '#7c3aed');
            g.appendChild(circ);
        }
        // Label
        const txt = document.createElementNS(NS, 'text');
        txt.setAttribute('x', '38'); txt.setAttribute('y', NH/2 + 4);
        txt.setAttribute('fill', '#e2e8f0');
        txt.setAttribute('font-size', '11'); txt.setAttribute('font-weight', '600');
        txt.setAttribute('font-family', "'Inter','SF Pro',sans-serif");
        txt.textContent = n.label;
        g.appendChild(txt);
        // Click → navigate to agent or open popover
        g.addEventListener('click', () => {
            const idx = agents.findIndex(a => a.id === n.agent_id);
            if(idx >= 0){
                const card = document.querySelector(`[data-agent="${idx}"]`);
                if(card) { card.scrollIntoView({behavior:'smooth', block:'center'}); togglePopover(card, idx); }
            }
        });
        nodeG.appendChild(g);
    });
    svg.appendChild(nodeG);
}
</script>
{% endblock %}
