{% extends "base.html" %}

{% block content %}
<style>
.settings-tabs{display:flex;gap:0;border-bottom:1px solid var(--border);margin-bottom:1.5rem}
.settings-tab{padding:0.6rem 1.2rem;font-size:0.82rem;font-weight:600;color:var(--text-secondary);cursor:pointer;border-bottom:2px solid transparent;transition:all .15s;background:none;border-top:none;border-left:none;border-right:none;font-family:inherit}
.settings-tab:hover{color:var(--text-primary)}
.settings-tab.active{color:var(--purple);border-bottom-color:var(--purple)}
.settings-panel{display:none}
.settings-panel.active{display:block}
.integ-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:1rem}
.integ-card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:10px;padding:1.2rem;transition:border-color .15s}
.integ-card:hover{border-color:var(--purple-dim)}
.integ-card.enabled{border-color:rgba(34,197,94,.3)}
.integ-header{display:flex;align-items:center;gap:0.8rem;margin-bottom:0.8rem}
.integ-icon{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:1.3rem}
.integ-icon.jira{background:rgba(0,82,204,.15);color:#0052cc}
.integ-icon.confluence{background:rgba(0,101,255,.15);color:#0065ff}
.integ-icon.xray{background:rgba(101,84,192,.15);color:#6554c0}
.integ-icon.sonarqube{background:rgba(78,154,6,.15);color:#4e9a06}
.integ-icon.gitlab{background:rgba(252,109,38,.15);color:#fc6d26}
.integ-icon.azure-devops{background:rgba(0,120,212,.15);color:#0078d4}
.integ-info{flex:1;min-width:0}
.integ-name{font-size:0.92rem;font-weight:700;color:var(--text-primary)}
.integ-type{font-size:0.72rem;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.3px}
.integ-toggle{position:relative;width:44px;height:24px;flex-shrink:0}
.integ-toggle input{opacity:0;width:0;height:0}
.integ-toggle .slider{position:absolute;inset:0;background:var(--bg-tertiary);border-radius:12px;cursor:pointer;transition:.2s;border:1px solid var(--border)}
.integ-toggle .slider:before{content:"";position:absolute;height:18px;width:18px;left:2px;bottom:2px;background:var(--text-secondary);border-radius:50%;transition:.2s}
.integ-toggle input:checked+.slider{background:var(--purple);border-color:var(--purple)}
.integ-toggle input:checked+.slider:before{transform:translateX(20px);background:#fff}
.integ-body{display:flex;flex-direction:column;gap:0.6rem}
.integ-field{display:flex;flex-direction:column;gap:0.2rem}
.integ-field label{font-size:0.72rem;font-weight:600;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.3px}
.integ-field input,.integ-field select{background:var(--bg-tertiary);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:0.4rem 0.6rem;font-size:0.82rem;font-family:inherit;outline:none}
.integ-field input:focus,.integ-field select:focus{border-color:var(--purple)}
.integ-status{display:flex;align-items:center;gap:0.4rem;margin-top:0.4rem;font-size:0.72rem}
.integ-status-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.integ-status-dot.connected{background:var(--green)}
.integ-status-dot.disconnected{background:var(--text-secondary)}
.integ-status-dot.error{background:var(--red)}
.integ-actions{display:flex;gap:0.4rem;margin-top:0.5rem}
.integ-desc{font-size:0.78rem;color:var(--text-secondary);line-height:1.4;margin-bottom:0.4rem}
</style>

<div class="settings-page">
    <div class="settings-tabs">
        <button class="settings-tab active" onclick="showSettingsTab('general')">
            <svg class="icon icon-sm" style="vertical-align:-2px;margin-right:4px"><use href="#icon-settings"/></svg> General
        </button>
        <button class="settings-tab" onclick="showSettingsTab('integrations')">
            <svg class="icon icon-sm" style="vertical-align:-2px;margin-right:4px"><use href="#icon-plug"/></svg> Integrations
        </button>
        <button class="settings-tab" onclick="showSettingsTab('providers')">
            <svg class="icon icon-sm" style="vertical-align:-2px;margin-right:4px"><use href="#icon-cpu"/></svg> LLM Providers
        </button>
    </div>

    <!-- ═══ General ═══ -->
    <div class="settings-panel active" id="panel-general">
        <section class="settings-section">
            <h3>{{ _("server") }}</h3>
            <div class="form-group">
                <label>{{ _("host") }}</label>
                <input type="text" value="{{ config.server.host }}" readonly>
            </div>
            <div class="form-group">
                <label>{{ _("port") }}</label>
                <input type="number" value="{{ config.server.port }}" readonly>
            </div>
        </section>
        <section class="settings-section">
            <h3>{{ _("orchestrator") }}</h3>
            <div class="form-group">
                <label>{{ _("default_pattern") }}</label>
                <input type="text" value="{{ config.orchestrator.default_pattern }}" readonly>
            </div>
            <div class="form-group">
                <label>{{ _("max_concurrent_sessions") }}</label>
                <input type="number" value="{{ config.orchestrator.max_concurrent_sessions }}" readonly>
            </div>
        </section>
    </div>

    <!-- ═══ Integrations ═══ -->
    <div class="settings-panel" id="panel-integrations">
        <p style="color:var(--text-secondary);font-size:0.85rem;margin-bottom:1.2rem">
            Connect external tools. Macaron replaces Jira &amp; Confluence natively — these connectors enable import/migration and optional sync with legacy systems.
        </p>
        <div class="integ-grid">
        {% for integ in integrations %}
            {% set cfg = integ.config %}
            <div class="integ-card {% if integ.enabled %}enabled{% endif %}" id="integ-{{ integ.id }}">
                <div class="integ-header">
                    <div class="integ-icon {{ integ.id }}">
                        {% if integ.id == 'jira' %}
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M11.53 2c0 2.4 1.97 4.35 4.35 4.35h1.78v1.7c0 2.4 1.94 4.34 4.34 4.35V2.84a.84.84 0 0 0-.84-.84H11.53zM6.77 6.8a4.36 4.36 0 0 0 4.34 4.34h1.8v1.72a4.36 4.36 0 0 0 4.34 4.34V7.63a.84.84 0 0 0-.83-.83H6.77zM2 11.6a4.35 4.35 0 0 0 4.35 4.35h1.78v1.71C8.13 20.06 10.1 22 12.48 22V12.44a.84.84 0 0 0-.84-.84H2z"/></svg>
                        {% elif integ.id == 'confluence' %}
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M2.51 18.23c-.27.45-.56.96-.81 1.38a.53.53 0 0 0 .19.72l3.4 2.09a.53.53 0 0 0 .72-.17c.22-.37.5-.85.81-1.37 2.25-3.8 4.5-3.33 8.57-1.27l3.39 1.72a.53.53 0 0 0 .71-.23l1.8-3.56a.53.53 0 0 0-.23-.71c-.93-.47-2.58-1.31-3.58-1.81-6.28-3.15-11.2-2.8-14.97 3.21z"/><path d="M21.49 5.77c.27-.45.56-.96.81-1.38a.53.53 0 0 0-.19-.72l-3.4-2.09a.53.53 0 0 0-.72.17c-.22.37-.5.85-.81 1.37-2.25 3.8-4.5 3.33-8.57 1.27L5.22 2.67a.53.53 0 0 0-.71.23l-1.8 3.56a.53.53 0 0 0 .23.71c.93.47 2.58 1.31 3.58 1.81 6.28 3.15 11.2 2.8 14.97-3.21z"/></svg>
                        {% elif integ.id == 'xray' %}
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 12l3 3 5-5"/></svg>
                        {% elif integ.id == 'sonarqube' %}
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M15.53 3.59a.75.75 0 0 0-.97-.37.75.75 0 0 0-.37.97C16.22 8.95 16.22 13.1 14.19 17.86a.75.75 0 0 0 1.34.68c2.19-5.14 2.19-9.67.0-14.95zM19.27 1.8a.75.75 0 0 0-1.06-.27.75.75 0 0 0-.27 1.06c3.64 6 3.64 12.82 0 18.82a.75.75 0 0 0 1.33.7C23.18 15.5 23.18 8.5 19.27 1.8zM11.79 5.96a.75.75 0 0 0-.87-.6.75.75 0 0 0-.6.87c.72 4.2-.07 7.56-2.38 10.18a.75.75 0 0 0 1.12 1c2.63-2.98 3.53-6.78 2.73-11.45zM7.82 8.76a.75.75 0 0 0-.73-.77.75.75 0 0 0-.77.73C6.07 13.58 4.56 16.1 2.2 17.54a.75.75 0 0 0 .78 1.28c2.82-1.72 4.55-4.68 4.84-10.06z"/></svg>
                        {% elif integ.id == 'gitlab' %}
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M22.65 14.39L12 22.13 1.35 14.39a.84.84 0 0 1-.3-.94l1.22-3.78 2.44-7.51a.43.43 0 0 1 .82 0l2.44 7.51h8.06l2.44-7.51a.43.43 0 0 1 .82 0l2.44 7.51 1.22 3.78a.84.84 0 0 1-.3.94z"/></svg>
                        {% elif integ.id == 'azure-devops' %}
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M22 5.5v13l-5.5 3.5-8.47-3.08v3.08L3 15.73l14.03 1.1V5.27L22 5.5zM5.03 7.77L11 5.5v14.28l-5.97-2.15V7.77z"/></svg>
                        {% endif %}
                    </div>
                    <div class="integ-info">
                        <div class="integ-name">{{ integ.name }}</div>
                        <div class="integ-type">{{ integ.type|replace('_',' ') }}</div>
                    </div>
                    <label class="integ-toggle">
                        <input type="checkbox" {% if integ.enabled %}checked{% endif %} onchange="toggleInteg('{{ integ.id }}', this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="integ-desc">
                    {% if integ.id == 'jira' %}Import backlogs from existing Jira projects. One-way migration or optional bidirectional sync.
                    {% elif integ.id == 'confluence' %}Import documentation into Memory. Auto-publish ADRs and retrospectives.
                    {% elif integ.id == 'xray' %}Sync test plans and results. Trace requirements to E2E tests for AO compliance.
                    {% elif integ.id == 'sonarqube' %}Pull quality gates, coverage, code smells into adversarial review pipeline.
                    {% elif integ.id == 'gitlab' %}Alternative to GitHub for CI/CD pipelines, MR reviews, and container registry.
                    {% elif integ.id == 'azure-devops' %}Boards and Pipelines sync for Microsoft enterprise environments.
                    {% endif %}
                </div>
                <div class="integ-body">
                    {% if integ.id == 'jira' %}
                    <div class="integ-field">
                        <label>URL</label>
                        <input type="url" placeholder="https://company.atlassian.net" value="{{ cfg.get('url','') }}" data-integ="{{ integ.id }}" data-key="url">
                    </div>
                    <div class="integ-field">
                        <label>Project Key</label>
                        <input type="text" placeholder="LPD" value="{{ cfg.get('project_key','') }}" data-integ="{{ integ.id }}" data-key="project_key">
                    </div>
                    <div class="integ-field">
                        <label>Mode</label>
                        <select data-integ="{{ integ.id }}" data-key="mode">
                            <option value="import" {% if cfg.get('mode')=='import' %}selected{% endif %}>Import only (Jira → Macaron)</option>
                            <option value="bidirectional" {% if cfg.get('mode')=='bidirectional' %}selected{% endif %}>Bidirectional sync</option>
                        </select>
                    </div>
                    {% elif integ.id == 'confluence' %}
                    <div class="integ-field">
                        <label>URL</label>
                        <input type="url" placeholder="https://company.atlassian.net/wiki" value="{{ cfg.get('url','') }}" data-integ="{{ integ.id }}" data-key="url">
                    </div>
                    <div class="integ-field">
                        <label>Space Key</label>
                        <input type="text" placeholder="LPD" value="{{ cfg.get('space_key','') }}" data-integ="{{ integ.id }}" data-key="space_key">
                    </div>
                    {% elif integ.id == 'xray' %}
                    <div class="integ-field">
                        <label>Xray Cloud URL</label>
                        <input type="url" placeholder="https://xray.cloud.getxray.app" value="{{ cfg.get('url','') }}" data-integ="{{ integ.id }}" data-key="url">
                    </div>
                    {% elif integ.id == 'sonarqube' %}
                    <div class="integ-field">
                        <label>URL</label>
                        <input type="url" placeholder="https://sonarqube.company.com" value="{{ cfg.get('url','') }}" data-integ="{{ integ.id }}" data-key="url">
                    </div>
                    <div class="integ-field">
                        <label>Project Key</label>
                        <input type="text" placeholder="my-project" value="{{ cfg.get('project_key','') }}" data-integ="{{ integ.id }}" data-key="project_key">
                    </div>
                    {% elif integ.id == 'gitlab' %}
                    <div class="integ-field">
                        <label>GitLab URL</label>
                        <input type="url" placeholder="https://gitlab.company.com" value="{{ cfg.get('url','') }}" data-integ="{{ integ.id }}" data-key="url">
                    </div>
                    <div class="integ-field">
                        <label>Project ID</label>
                        <input type="text" placeholder="42" value="{{ cfg.get('project_id','') }}" data-integ="{{ integ.id }}" data-key="project_id">
                    </div>
                    {% elif integ.id == 'azure-devops' %}
                    <div class="integ-field">
                        <label>Organization</label>
                        <input type="text" placeholder="myorg" value="{{ cfg.get('org','') }}" data-integ="{{ integ.id }}" data-key="org">
                    </div>
                    <div class="integ-field">
                        <label>Project</label>
                        <input type="text" placeholder="MyProject" value="{{ cfg.get('project','') }}" data-integ="{{ integ.id }}" data-key="project">
                    </div>
                    {% endif %}
                    <div class="integ-field">
                        <label>API Token</label>
                        <input type="password" placeholder="••••••••" value="" data-integ="{{ integ.id }}" data-key="api_token">
                    </div>
                </div>
                <div class="integ-status">
                    <span class="integ-status-dot {{ integ.status }}"></span>
                    <span>{{ integ.status }}</span>
                    {% if integ.last_sync %}<span style="margin-left:auto;opacity:.6">Last sync: {{ integ.last_sync[:16] }}</span>{% endif %}
                </div>
                <div class="integ-actions">
                    <button class="btn btn-ghost btn-sm" onclick="saveInteg('{{ integ.id }}')" style="font-size:0.72rem">
                        <svg class="icon icon-sm" style="width:13px;height:13px"><use href="#icon-save"/></svg> Save
                    </button>
                    <button class="btn btn-ghost btn-sm" onclick="testInteg('{{ integ.id }}')" style="font-size:0.72rem">
                        <svg class="icon icon-sm" style="width:13px;height:13px"><use href="#icon-zap"/></svg> Test
                    </button>
                </div>
            </div>
        {% endfor %}
        </div>
    </div>

    <!-- ═══ LLM Providers ═══ -->
    <div class="settings-panel" id="panel-providers">
        <section class="settings-section">
            <h3>Built-in LLM Providers</h3>
            {% for p in providers %}
            <div class="form-group" style="margin-bottom:12px;">
                <label>{{ p.name }} <span class="badge {% if p.enabled %}badge-green{% else %}badge-red{% endif %}">{% if p.enabled %}active{% else %}no key{% endif %}</span></label>
                <div style="font-size:13px;color:var(--text-secondary);">
                    {{ p.models|length }} models — default: {{ p.default_model }}
                </div>
            </div>
            {% endfor %}
            <p class="settings-note">
                Set environment variables like <code>ANTHROPIC_API_KEY</code>, <code>AZURE_OPENAI_API_KEY</code> to enable providers.
            </p>
        </section>

        <section class="settings-section" style="margin-top:2rem">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
                <h3 style="margin:0">Custom AI Providers</h3>
                <button class="btn btn-primary btn-sm" onclick="showAddProviderModal()">
                    <svg class="icon icon-sm"><use href="#icon-plus"/></svg> Add Provider
                </button>
            </div>
            <div id="custom-providers-list">
                <p style="color:var(--text-secondary);font-size:0.85rem">Loading...</p>
            </div>
        </section>
    </div>
</div>

<!-- Add Provider Modal -->
<div id="add-provider-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:9999;padding:2rem;overflow-y:auto">
    <div style="max-width:520px;margin:auto;background:var(--bg-primary);border-radius:12px;border:1px solid var(--border);padding:1.5rem">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.2rem">
            <h3 style="margin:0">Add Custom AI Provider</h3>
            <button onclick="document.getElementById('add-provider-modal').style.display='none'" style="background:none;border:none;color:var(--text-secondary);font-size:1.5rem;cursor:pointer">&times;</button>
        </div>
        <form id="add-provider-form" onsubmit="saveCustomProvider(event)">
            <div class="form-group">
                <label>Provider Name</label>
                <input type="text" name="name" placeholder="My Custom LLM" required>
            </div>
            <div class="form-group">
                <label>Provider Type</label>
                <select name="provider_type">
                    <option value="openai-compatible">OpenAI Compatible</option>
                    <option value="anthropic">Anthropic</option>
                    <option value="custom">Custom</option>
                </select>
            </div>
            <div class="form-group">
                <label>Base URL</label>
                <input type="url" name="base_url" placeholder="https://api.example.com" required>
            </div>
            <div class="form-group">
                <label>API Key</label>
                <input type="password" name="api_key" placeholder="sk-..." required>
            </div>
            <div class="form-group">
                <label>Default Model</label>
                <input type="text" name="default_model" placeholder="gpt-4" required>
            </div>
            <div style="display:flex;gap:0.5rem;margin-top:1.5rem">
                <button type="submit" class="btn btn-primary" style="flex:1">Save Provider</button>
                <button type="button" class="btn btn-ghost" onclick="document.getElementById('add-provider-modal').style.display='none'">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
function showSettingsTab(id) {
    document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.settings-panel').forEach(p => p.classList.remove('active'));
    document.getElementById('panel-'+id).classList.add('active');
    event.target.closest('.settings-tab').classList.add('active');
    try { localStorage.setItem('settings_tab', id); } catch(e){}
    
    // Load custom providers when switching to providers tab
    if (id === 'providers') {
        loadCustomProviders();
    }
}
// Restore last tab
try {
    const last = localStorage.getItem('settings_tab');
    if (last) showSettingsTab(last);
} catch(e){}

async function toggleInteg(id, enabled) {
    await fetch(`/api/integrations/${id}`, {
        method: 'PATCH',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({enabled})
    });
    document.getElementById('integ-'+id).classList.toggle('enabled', enabled);
}

function _gatherConfig(id) {
    const cfg = {};
    document.querySelectorAll(`[data-integ="${id}"]`).forEach(el => {
        const k = el.dataset.key;
        if (k === 'api_token' && !el.value) return;
        cfg[k] = el.value;
    });
    return cfg;
}

async function saveInteg(id) {
    const cfg = _gatherConfig(id);
    const r = await fetch(`/api/integrations/${id}`, {
        method: 'PATCH',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({config: cfg})
    });
    const j = await r.json();
    if (j.ok) {
        const btn = event.target.closest('button');
        btn.textContent = '[+] Saved'; setTimeout(() => btn.innerHTML = '<svg class="icon icon-sm" style="width:13px;height:13px"><use href="#icon-save"/></svg> Save', 1500);
    }
}

async function testInteg(id) {
    const btn = event.target.closest('button');
    btn.disabled = true; btn.textContent = 'Testing...';
    const r = await fetch(`/api/integrations/${id}/test`, {method: 'POST'});
    const j = await r.json();
    const dot = document.querySelector(`#integ-${id} .integ-status-dot`);
    const label = document.querySelector(`#integ-${id} .integ-status span:last-of-type`);
    dot.className = 'integ-status-dot ' + (j.ok ? 'connected' : 'error');
    if (label) label.textContent = j.ok ? 'connected' : 'error: ' + (j.error || 'failed');
    btn.disabled = false; btn.innerHTML = '<svg class="icon icon-sm" style="width:13px;height:13px"><use href="#icon-zap"/></svg> Test';
}

// Custom AI Providers
async function loadCustomProviders() {
    try {
        const r = await fetch('/api/ai-providers');
        const j = await r.json();
        const list = document.getElementById('custom-providers-list');
        
        if (!j.ok || !j.providers || j.providers.length === 0) {
            list.innerHTML = '<p style="color:var(--text-secondary);font-size:0.85rem">No custom providers configured</p>';
            return;
        }
        
        list.innerHTML = j.providers.map(p => `
            <div class="integ-card ${p.enabled ? 'enabled' : ''}" style="margin-bottom:1rem">
                <div class="integ-header">
                    <div class="integ-icon" style="background:rgba(124,58,237,.15);color:#7c3aed">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6M23 12h-6m-6 0H5"/></svg>
                    </div>
                    <div class="integ-info">
                        <div class="integ-name">${p.name}</div>
                        <div class="integ-type">${p.provider_type}</div>
                    </div>
                    <label class="integ-toggle">
                        <input type="checkbox" ${p.enabled ? 'checked' : ''} onchange="toggleCustomProvider('${p.id}', this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="integ-desc">
                    Base URL: ${p.base_url}<br>
                    Model: ${p.default_model}
                </div>
                <div class="integ-actions">
                    <button class="btn btn-ghost btn-sm" onclick="testCustomProvider('${p.id}')" style="font-size:0.72rem">
                        <svg class="icon icon-sm" style="width:13px;height:13px"><use href="#icon-zap"/></svg> Test
                    </button>
                    <button class="btn btn-ghost btn-sm" onclick="deleteCustomProvider('${p.id}')" style="font-size:0.72rem;color:var(--red)">
                        <svg class="icon icon-sm" style="width:13px;height:13px"><use href="#icon-trash"/></svg> Delete
                    </button>
                </div>
            </div>
        `).join('');
    } catch (e) {
        console.error('Failed to load custom providers:', e);
    }
}

function showAddProviderModal() {
    document.getElementById('add-provider-modal').style.display = 'block';
    document.getElementById('add-provider-form').reset();
}

async function saveCustomProvider(e) {
    e.preventDefault();
    const form = e.target;
    const data = {
        name: form.name.value,
        provider_type: form.provider_type.value,
        base_url: form.base_url.value,
        api_key: form.api_key.value,
        default_model: form.default_model.value
    };
    
    try {
        const r = await fetch('/api/ai-providers', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        const j = await r.json();
        
        if (j.ok) {
            document.getElementById('add-provider-modal').style.display = 'none';
            loadCustomProviders();
        } else {
            alert('Error: ' + (j.error || 'Failed to save provider'));
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

async function toggleCustomProvider(id, enabled) {
    await fetch(`/api/ai-providers/${id}`, {
        method: 'PATCH',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({enabled})
    });
}

async function testCustomProvider(id) {
    const btn = event.target.closest('button');
    btn.disabled = true;
    btn.textContent = 'Testing...';
    
    try {
        const r = await fetch(`/api/ai-providers/${id}/test`, {method: 'POST'});
        const j = await r.json();
        
        if (j.ok) {
            btn.textContent = '[+] Connected';
            setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = '<svg class="icon icon-sm" style="width:13px;height:13px"><use href="#icon-zap"/></svg> Test';
            }, 2000);
        } else {
            alert('Connection failed: ' + (j.error || 'Unknown error'));
            btn.disabled = false;
            btn.innerHTML = '<svg class="icon icon-sm" style="width:13px;height:13px"><use href="#icon-zap"/></svg> Test';
        }
    } catch (e) {
        alert('Error: ' + e.message);
        btn.disabled = false;
        btn.innerHTML = '<svg class="icon icon-sm" style="width:13px;height:13px"><use href="#icon-zap"/></svg> Test';
    }
}

async function deleteCustomProvider(id) {
    if (!confirm('Delete this provider?')) return;
    
    try {
        const r = await fetch(`/api/ai-providers/${id}`, {method: 'DELETE'});
        const j = await r.json();
        
        if (j.ok) {
            loadCustomProviders();
        } else {
            alert('Error: ' + (j.error || 'Failed to delete'));
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}
</script>
{% endblock %}
