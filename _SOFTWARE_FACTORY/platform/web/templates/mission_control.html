{% extends "base.html" %}

{% block topbar_actions %}
<span class="badge" style="background:var(--purple);color:#fff;font-size:0.72rem;padding:0.2rem 0.6rem;border-radius:4px">
    {{ mission.status.value|upper }}
</span>
{% endblock %}

{% block content %}
<style>
.mc-layout{display:grid;grid-template-columns:1fr 340px;gap:0;height:calc(100vh - 80px)}
.mc-main{overflow-y:auto;padding:0 0.75rem 2rem 0}
.mc-sidebar{overflow-y:auto;border-left:1px solid var(--border);background:var(--bg-secondary)}

/* Stats bar */
.mc-stats{display:flex;align-items:center;gap:1rem;margin-bottom:0.75rem;padding:0.5rem 0}
.mc-stat-item{display:flex;align-items:center;gap:0.35rem;font-size:0.78rem;color:var(--text-secondary)}
.mc-stat-item .val{font-weight:700;color:var(--text-primary)}
.mc-progress-bar{flex:1;max-width:200px;height:5px;background:var(--bg-tertiary);border-radius:3px;overflow:hidden}
.mc-progress-fill{height:100%;background:var(--purple);border-radius:3px;transition:width .4s}

/* Timeline pipeline */
.mc-pipeline{display:flex;flex-direction:column;gap:0;position:relative}
.mc-phase{display:flex;align-items:stretch;gap:0;position:relative}
.mc-phase-line{width:32px;display:flex;flex-direction:column;align-items:center;flex-shrink:0}
.mc-phase-dot{width:14px;height:14px;border-radius:50%;border:2px solid var(--border);background:var(--bg-tertiary);z-index:1;flex-shrink:0;margin-top:0.75rem}
.mc-phase-connector{width:2px;flex:1;background:var(--border)}
.mc-phase:last-child .mc-phase-connector{display:none}
.mc-phase[data-status="done"] .mc-phase-dot{background:var(--green);border-color:var(--green)}
.mc-phase[data-status="running"] .mc-phase-dot{background:var(--purple);border-color:var(--purple);animation:pulse-dot 1.5s ease-in-out infinite}
.mc-phase[data-status="failed"] .mc-phase-dot{background:var(--red);border-color:var(--red)}
.mc-phase[data-status="waiting_validation"] .mc-phase-dot{background:var(--yellow);border-color:var(--yellow);animation:pulse-dot 1s ease-in-out infinite}
.mc-phase[data-status="done"] .mc-phase-connector{background:var(--green)}
.mc-phase[data-status="running"] .mc-phase-connector{background:var(--purple)}
@keyframes pulse-dot{0%,100%{transform:scale(1)}50%{transform:scale(1.3)}}

/* Phase card */
.mc-phase-card{flex:1;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;margin-bottom:0.5rem;overflow:hidden;transition:border-color .2s}
.mc-phase[data-status="running"] .mc-phase-card{border-color:var(--purple)}
.mc-phase[data-status="done"] .mc-phase-card{border-color:var(--green)}
.mc-phase[data-status="failed"] .mc-phase-card{border-color:var(--red)}
.mc-phase[data-status="waiting_validation"] .mc-phase-card{border-color:var(--yellow)}

/* Phase header */
.mc-phase-header{display:flex;align-items:center;gap:0.5rem;padding:0.55rem 0.75rem;cursor:pointer;user-select:none;transition:background .15s}
.mc-phase-header:hover{background:var(--bg-tertiary)}
.mc-phase-num{font-size:0.65rem;color:var(--text-secondary);font-weight:700;min-width:1.2rem}
.mc-phase-name{font-size:0.82rem;font-weight:600;color:var(--text-primary);flex:1}
.mc-phase-avatars{display:flex;align-items:center;margin-right:0.2rem}
.mc-phase-avatars img{width:20px;height:20px;border-radius:50%;object-fit:cover;border:1.5px solid var(--bg-secondary)}
.mc-phase-avatars img+img{margin-left:-6px}
.mc-phase-avatars .more{font-size:0.62rem;color:var(--text-secondary);margin-left:0.2rem}
.mc-phase-pattern{font-size:0.62rem;color:var(--purple);background:rgba(124,58,237,.1);padding:0.12rem 0.45rem;border-radius:4px;font-weight:600}
.mc-phase-status-badge{font-size:0.62rem;padding:0.12rem 0.45rem;border-radius:4px;font-weight:600}
.mc-phase-status-badge.pending{color:var(--text-secondary);background:var(--bg-tertiary)}
.mc-phase-status-badge.running{color:var(--purple);background:rgba(124,58,237,.15)}
.mc-phase-status-badge.done{color:var(--green);background:rgba(34,197,94,.12)}
.mc-phase-status-badge.failed{color:var(--red);background:rgba(239,68,68,.12)}
.mc-phase-status-badge.waiting_validation{color:var(--yellow);background:rgba(234,179,8,.12)}
.mc-phase-chevron{font-size:0.65rem;color:var(--text-secondary);transition:transform .2s}
.mc-phase.open .mc-phase-chevron{transform:rotate(90deg)}

/* Phase summary preview ‚Äî visible when collapsed */
.mc-phase-summary{display:none;padding:0.4rem 0.75rem 0.35rem 2.2rem;font-size:0.72rem;color:var(--text-secondary);line-height:1.45;border-top:1px solid var(--border);background:var(--bg-secondary)}
.mc-phase-summary .mc-summary-line{display:flex;gap:0.4rem;align-items:baseline;margin-bottom:0.15rem}
.mc-phase-summary .mc-summary-agent{font-weight:600;color:var(--text-primary);white-space:nowrap;min-width:0;flex-shrink:0}
.mc-phase-summary .mc-summary-text{color:var(--text-secondary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;min-width:0}
.mc-phase:not(.open) .mc-phase-summary{display:block}
.mc-phase.open .mc-phase-summary{display:none}

/* Screenshot thumbnails in phase summary */
.mc-phase-thumbs{display:flex;gap:0.35rem;margin-top:0.35rem;overflow-x:auto;padding-bottom:0.2rem}
.mc-phase-thumb{width:80px;height:48px;border-radius:var(--radius-sm);border:1px solid var(--border-subtle);object-fit:cover;cursor:pointer;flex-shrink:0;transition:transform .15s,border-color .15s}
.mc-phase-thumb:hover{transform:scale(1.15);border-color:var(--purple);z-index:1}

/* Inline screenshot in messages */
.mc-screenshot{margin:0.5rem 0}
.mc-screenshot img{max-width:100%;border-radius:var(--radius-lg);border:1px solid var(--border-subtle);cursor:pointer;transition:transform .15s}
.mc-screenshot img:hover{transform:scale(1.02)}

/* Accordion body: graph row + discussion row */
.mc-phase-body{display:none;border-top:1px solid var(--border)}
.mc-phase.open .mc-phase-body{display:flex;flex-direction:column}

/* Full flow graph (SVG) ‚Äî session_live style */
.mc-phase-graph{background:var(--bg-primary);border-bottom:1px solid var(--border);padding:0.4rem;position:relative;overflow:hidden}
.mc-phase-graph svg{width:100%;height:auto;display:block}
.mc-live-node{cursor:pointer}
.mc-live-node:hover .mc-live-node-bg{filter:brightness(1.15)}
.mc-live-node-bg{rx:10;ry:10;fill:var(--bg-secondary);stroke:var(--border);stroke-width:1.2;transition:stroke .2s,filter .15s}
.mc-live-node-bar{stroke-linecap:round}
.mc-live-node-name{fill:var(--text-primary);font-size:11.5px;font-weight:700;font-family:inherit}
.mc-live-node-role{fill:var(--text-secondary);font-size:8.5px;font-family:inherit}
.mc-live-node-status{fill:var(--text-secondary);font-size:7px;font-family:inherit;text-anchor:middle}
.mc-node-status--idle{fill:#6b7280}
.mc-node-status--thinking{fill:var(--yellow);animation:statusPulse 1.2s ease-in-out infinite}
.mc-node-status--acting{fill:var(--green);animation:statusPulse 2s ease-in-out infinite}
.mc-node-status--done{fill:var(--green)}
.mc-node-status--error{fill:var(--red)}
@keyframes statusPulse{0%,100%{r:5}50%{r:7}}
.mc-pulse-ring{fill:none;stroke-width:2;opacity:0;animation:mcPulseRing 2s ease-out infinite}
@keyframes mcPulseRing{0%{r:14;opacity:.6}100%{r:28;opacity:0}}
.mc-edge-line{fill:none;stroke:var(--purple);stroke-width:1.6;opacity:0.45;transition:stroke-width .2s,opacity .2s}
.mc-edge-count{fill:var(--text-secondary);font-size:8px;font-family:'SF Mono',monospace;text-anchor:middle;pointer-events:none}
.mc-graph-legend{position:absolute;bottom:6px;left:8px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;padding:4px 8px;display:flex;gap:8px;align-items:center;font-size:0.62rem;color:var(--text-secondary)}

/* Discussion ‚Äî uses mu__ classes from components.css */
.mc-phase-discuss{padding:0.75rem;overflow-y:auto;max-height:500px;display:flex;flex-direction:column;gap:0.6rem}
.mc-discuss-empty{font-size:0.72rem;color:var(--text-secondary);font-style:italic;padding:1.5rem 0.8rem;text-align:center}

/* Rendered markdown in discussions */
.md-rendered table{width:100%;border-collapse:collapse;margin:0.5rem 0;font-size:0.75rem}
.md-rendered th,.md-rendered td{border:1px solid rgba(255,255,255,.08);padding:0.3rem 0.5rem;text-align:left}
.md-rendered th{background:rgba(124,58,237,.1);font-weight:600;color:var(--text-primary)}
.md-rendered td{color:var(--text-secondary)}
.md-rendered h2,.md-rendered h3,.md-rendered h4{margin:0.5rem 0 0.3rem;color:var(--text-primary)}
.md-rendered pre{background:rgba(0,0,0,.3);border-radius:6px;padding:0.5rem;overflow-x:auto;font-size:0.7rem;margin:0.4rem 0}
.md-rendered code{background:rgba(124,58,237,.15);padding:0.1rem 0.3rem;border-radius:3px;font-size:0.72rem}
.md-rendered pre code{background:none;padding:0}
.md-rendered ul{margin:0.3rem 0;padding-left:1.2rem}
.md-rendered li{margin:0.15rem 0;color:var(--text-secondary)}
.md-rendered hr{border:none;border-top:1px solid rgba(255,255,255,.08);margin:0.5rem 0}
.md-rendered a{color:var(--purple);text-decoration:underline}

/* Streaming bubble ‚Äî uses mu__ layout */
.mc-streaming .mu__bubble--agent{border-left:2px solid var(--purple);animation:stream-pulse 2s ease-in-out infinite}
@keyframes stream-pulse{0%,100%{border-left-color:var(--purple)}50%{border-left-color:rgba(124,58,237,.3)}}
.mc-stream-content{white-space:pre-wrap;word-break:break-word}
.mc-typing-cursor{color:var(--purple);animation:blink-cursor .7s step-end infinite;font-weight:700}
@keyframes blink-cursor{0%,100%{opacity:1}50%{opacity:0}}
.mc-thinking-badge{font-size:0.58rem;color:var(--purple);font-weight:600;animation:think-pulse 1.5s ease-in-out infinite}
@keyframes think-pulse{0%,100%{opacity:1}50%{opacity:.4}}

/* Checkpoint */
.mc-checkpoint{background:rgba(234,179,8,.08);border-top:1px solid var(--yellow);padding:0.6rem 0.75rem}

/* Agent popover */
.mc-popover-overlay{position:fixed;inset:0;z-index:999;display:none}
.mc-popover-overlay.open{display:block}
.mc-popover{position:fixed;z-index:1000;width:340px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius,10px);box-shadow:0 12px 40px rgba(0,0,0,.45);overflow:hidden;display:none;animation:mcPopIn .15s ease}
.mc-popover.open{display:block}
@keyframes mcPopIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.mc-popover-header{padding:0.85rem;display:flex;align-items:center;gap:0.75rem;border-bottom:1px solid var(--border)}
.mc-popover-photo{width:52px;height:52px;border-radius:50%;object-fit:cover;border:2px solid var(--purple);flex-shrink:0}
.mc-popover-photo-fallback{width:52px;height:52px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1.1rem;color:#fff;flex-shrink:0}
.mc-popover-name{font-size:0.95rem;font-weight:700;color:var(--text-primary)}
.mc-popover-role{font-size:0.72rem;color:var(--text-secondary)}
.mc-popover-tagline{font-size:0.7rem;color:var(--purple);font-style:italic;margin-top:2px}
.mc-popover-body{padding:0.7rem 0.85rem;font-size:0.76rem;color:var(--text-secondary);line-height:1.5;max-height:340px;overflow-y:auto}
.mc-popover-section{margin-top:0.5rem}
.mc-popover-section-title{font-size:0.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text-secondary);margin-bottom:0.25rem}
.mc-popover-text{font-size:0.76rem;color:var(--text-primary);line-height:1.5;white-space:pre-line}
.mc-popover-tags{display:flex;flex-wrap:wrap;gap:3px}
.mc-popover-tag{padding:0.12rem 0.4rem;border-radius:4px;font-size:0.62rem;background:var(--bg-tertiary);color:var(--text-secondary)}
.mc-popover-tag.skill{background:rgba(124,58,237,.12);color:var(--purple)}
.mc-popover-tag.tool{background:rgba(59,130,246,.12);color:var(--blue)}
.mc-popover-model{display:flex;align-items:center;gap:0.4rem;margin-top:0.5rem;padding:0.35rem 0.55rem;background:var(--bg-tertiary);border-radius:6px;font-size:0.68rem;color:var(--text-secondary)}
.mc-popover-close{position:absolute;top:0.4rem;right:0.5rem;background:none;border:none;color:var(--text-secondary);cursor:pointer;padding:0.3rem;font-size:0.9rem;line-height:1}
.mc-popover-close:hover{color:var(--text-primary)}
.mc-checkpoint h4{color:var(--yellow);font-size:0.8rem;margin:0 0 0.4rem}
.mc-checkpoint-actions{display:flex;gap:0.5rem}
.mc-checkpoint-actions button{padding:0.25rem 0.7rem;border-radius:6px;font-size:0.72rem;font-weight:600;cursor:pointer;border:none;transition:opacity .15s}
.mc-checkpoint-actions button:hover{opacity:.85}
.mc-btn-go{background:var(--green);color:#fff}
.mc-btn-nogo{background:var(--red);color:#fff}
.mc-btn-pivot{background:var(--yellow);color:#000}

/* ====== RIGHT SIDEBAR ====== */
.mc-side-section{padding:0.6rem 0.75rem;border-bottom:1px solid var(--border)}
.mc-side-title{font-size:0.68rem;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-secondary);margin-bottom:0.45rem;display:flex;align-items:center;gap:0.3rem}

/* CDP Agent Card */
.mc-cdp-card{padding:0.75rem;border-bottom:1px solid var(--border);background:var(--bg-secondary)}
.mc-cdp-card-inner{background:var(--bg-tertiary);border:1px solid var(--border);border-radius:var(--radius,10px);overflow:hidden}
.mc-cdp-banner{height:56px;background:linear-gradient(135deg,rgba(124,58,237,.3),rgba(59,130,246,.18));position:relative}
.mc-cdp-avatar-wrap{position:absolute;bottom:-32px;left:16px}
.mc-cdp-avatar{width:64px;height:64px;border-radius:50%;object-fit:cover;border:3px solid var(--bg-tertiary);box-shadow:0 4px 12px rgba(0,0,0,.35)}
.mc-cdp-body{padding:2.2rem 0.85rem 0.5rem}
.mc-cdp-name{font-size:0.95rem;font-weight:700;color:var(--text-primary);margin:0;line-height:1.2}
.mc-cdp-role{font-size:0.68rem;color:var(--text-secondary);margin-top:0.1rem}
.mc-cdp-tagline{font-size:0.66rem;color:var(--purple);font-style:italic;margin-top:0.25rem;line-height:1.4}
.mc-cdp-status-row{display:flex;align-items:center;gap:0.5rem;margin-top:0.4rem}
.mc-cdp-status{font-size:0.58rem;padding:0.15rem 0.45rem;border-radius:4px;font-weight:600}
.mc-cdp-status.active{background:rgba(124,58,237,.15);color:var(--purple);animation:pulse-dot 2s ease-in-out infinite}
.mc-cdp-status.idle{background:var(--bg-tertiary);color:var(--text-secondary)}
.mc-cdp-section{margin-top:0.55rem}
.mc-cdp-section-title{font-size:0.56rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text-secondary);margin-bottom:0.2rem}
.mc-cdp-persona{font-size:0.65rem;color:var(--text-secondary);line-height:1.45}
.mc-cdp-motivation{font-size:0.65rem;color:var(--text-primary);line-height:1.45;padding:0.3rem 0.5rem;background:rgba(124,58,237,.06);border-radius:6px;border-left:2px solid var(--purple)}
.mc-cdp-tags{display:flex;flex-wrap:wrap;gap:3px}
.mc-cdp-tag{padding:0.1rem 0.35rem;border-radius:4px;font-size:0.58rem}
.mc-cdp-tag.skill{background:rgba(124,58,237,.1);color:var(--purple)}
.mc-cdp-tag.tool{background:rgba(59,130,246,.1);color:var(--blue,#3b82f6)}
.mc-cdp-actions{display:flex;gap:0.4rem;margin-top:0.6rem}
.mc-cdp-btn{flex:1;padding:0.4rem;border:none;border-radius:6px;font-size:0.72rem;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:0.3rem;transition:opacity .15s}
.mc-cdp-btn:hover{opacity:.85}
.mc-cdp-btn-chat{background:var(--purple);color:#fff}
.mc-cdp-btn-wf{background:transparent;border:1px solid var(--border);color:var(--text-secondary)}
.mc-cdp-btn-wf:hover{border-color:var(--purple);color:var(--purple)}

/* CDP Chat Modal */
.mc-chat-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:1200;display:none;align-items:center;justify-content:center}
.mc-chat-overlay.open{display:flex}
.mc-chat-modal{width:560px;max-width:92vw;height:72vh;max-height:700px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius,10px);display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,.5);animation:mcPopIn .2s ease}
.mc-chat-head{display:flex;align-items:center;gap:0.6rem;padding:0.65rem 0.85rem;border-bottom:1px solid var(--border);flex-shrink:0}
.mc-chat-head-avatar{width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid var(--purple)}
.mc-chat-head-info h3{font-size:0.85rem;margin:0;color:var(--text-primary);font-weight:700}
.mc-chat-head-info small{font-size:0.65rem;color:var(--text-secondary)}
.mc-chat-close{margin-left:auto;background:none;border:none;color:var(--text-secondary);cursor:pointer;padding:0.3rem;font-size:1.1rem;line-height:1;border-radius:4px}
.mc-chat-close:hover{color:var(--text-primary);background:var(--bg-tertiary)}
.mc-chat-msgs{flex:1;overflow-y:auto;padding:0.75rem;display:flex;flex-direction:column;gap:0.6rem}

/* Bubbles ‚Äî reuse DS mu__ patterns */
.mc-chat-msg{display:flex;gap:0.5rem;max-width:88%}
.mc-chat-msg.user{align-self:flex-end;flex-direction:row-reverse}
.mc-chat-msg.agent{align-self:flex-start}
.mc-chat-msg.system{align-self:center;max-width:100%}
.mc-chat-msg-avatar{width:28px;height:28px;border-radius:50%;object-fit:cover;flex-shrink:0;margin-top:2px}
.mc-chat-msg-avatar.user-av{background:var(--purple);display:flex;align-items:center;justify-content:center;font-size:0.65rem;font-weight:700;color:#fff}
.mc-chat-bubble{padding:0.5rem 0.75rem;border-radius:12px;font-size:0.82rem;line-height:1.55;word-break:break-word;overflow:hidden}
.mc-chat-msg.user .mc-chat-bubble{background:var(--purple);color:#fff;border-top-right-radius:4px}
.mc-chat-msg.agent .mc-chat-bubble{background:var(--bg-tertiary);color:var(--text-primary);border:1px solid var(--border);border-top-left-radius:4px}
.mc-chat-msg.system .mc-chat-bubble{background:none;color:var(--text-secondary);font-size:0.7rem;font-style:italic;padding:0.15rem 0;text-align:center}
.mc-chat-bubble .mu__sender{display:flex;gap:0.35rem;align-items:baseline;margin-bottom:0.2rem}
.mc-chat-bubble .mu__name{font-size:0.75rem;font-weight:600;color:var(--purple)}
.mc-chat-bubble .mu__role{font-size:0.6rem;color:var(--text-secondary);font-style:italic}
.mc-chat-bubble .mu__content{font-size:0.82rem;color:var(--text-primary);line-height:1.55}
.mc-chat-bubble .mu__content.mu--streaming::after{content:'‚ñå';animation:mu-blink .8s infinite;color:var(--purple);margin-left:1px}
@keyframes mu-blink{0%,100%{opacity:1}50%{opacity:0}}
.mc-chat-bubble .mu__footer{display:flex;justify-content:flex-end;margin-top:0.15rem}
.mc-chat-bubble .mu__time{font-size:0.6rem;color:var(--text-secondary)}

/* Streaming pulse on bubble border */
.mc-chat-msg.agent .mc-chat-bubble.streaming{border-left:3px solid var(--purple);animation:mc-stream-pulse 1.5s ease-in-out infinite}
@keyframes mc-stream-pulse{0%,100%{border-left-color:var(--purple)}50%{border-left-color:rgba(124,58,237,.3)}}

/* Thinking indicator with animated dots */
.mc-chat-thinking{display:flex;align-items:center;gap:0.4rem;padding:0.4rem 0.6rem;align-self:flex-start}
.mc-chat-thinking-text{font-size:0.75rem;color:var(--purple);font-style:italic}
.mc-chat-dots{display:inline-flex;gap:3px;margin-left:2px}
.mc-chat-dots span{width:5px;height:5px;border-radius:50%;background:var(--purple);animation:mc-dot-pulse 1.4s infinite both}
.mc-chat-dots span:nth-child(2){animation-delay:.2s}
.mc-chat-dots span:nth-child(3){animation-delay:.4s}
@keyframes mc-dot-pulse{0%,80%,100%{opacity:.3;transform:scale(.8)}40%{opacity:1;transform:scale(1)}}

/* Tool pills */
.mc-chat-tools{display:flex;flex-wrap:wrap;gap:3px;margin-top:0.3rem}
.mc-chat-tool-pill{font-size:0.6rem;padding:0.1rem 0.35rem;border-radius:4px;background:rgba(124,58,237,.12);color:var(--purple);display:inline-flex;align-items:center;gap:2px}

/* Markdown in chat */
.mc-chat-bubble .md-rendered{font-size:0.82rem;line-height:1.55}
.mc-chat-bubble .md-rendered p{margin:0.2rem 0}
.mc-chat-bubble .md-rendered ul,.mc-chat-bubble .md-rendered ol{margin:0.2rem 0;padding-left:1.2rem}
.mc-chat-bubble .md-rendered li{margin:0.1rem 0}
.mc-chat-bubble .md-rendered pre{background:rgba(0,0,0,.25);border-radius:6px;padding:0.4rem;overflow-x:auto;font-size:0.72rem;margin:0.3rem 0}
.mc-chat-bubble .md-rendered code{background:rgba(124,58,237,.12);padding:0.08rem 0.25rem;border-radius:3px;font-size:0.74rem}
.mc-chat-bubble .md-rendered pre code{background:none;padding:0}
.mc-chat-bubble .md-rendered h1,.mc-chat-bubble .md-rendered h2,.mc-chat-bubble .md-rendered h3{margin:0.3rem 0 0.15rem;font-size:0.88rem}
.mc-chat-bubble .md-rendered table{width:100%;border-collapse:collapse;margin:0.3rem 0;font-size:0.74rem}
.mc-chat-bubble .md-rendered th,.mc-chat-bubble .md-rendered td{border:1px solid rgba(255,255,255,.08);padding:0.2rem 0.4rem;text-align:left}
.mc-chat-bubble .md-rendered th{background:rgba(124,58,237,.08);font-weight:600}
.mc-chat-bubble .md-rendered a{color:var(--purple);text-decoration:underline}

/* Input row */
.mc-chat-input-row{display:flex;gap:0.4rem;padding:0.6rem 0.75rem;border-top:1px solid var(--border);flex-shrink:0}
.mc-chat-input{flex:1;padding:0.45rem 0.65rem;border:1px solid var(--border);border-radius:8px;background:var(--bg-tertiary);color:var(--text-primary);font-size:0.82rem;font-family:inherit;outline:none;resize:none;min-height:38px;max-height:120px}
.mc-chat-input:focus{border-color:var(--purple)}
.mc-chat-send{padding:0.4rem 0.75rem;border:none;border-radius:8px;background:var(--purple);color:#fff;font-size:0.78rem;font-weight:600;cursor:pointer;transition:opacity .15s;flex-shrink:0}
.mc-chat-send:hover{opacity:.85}
.mc-chat-send:disabled{opacity:.4;cursor:default}

.mc-activity{display:flex;flex-direction:column;gap:0.3rem;padding:0.5rem 0.75rem;max-height:240px;overflow-y:auto}
.mc-msg{background:var(--bg-tertiary);border-radius:6px;padding:0.3rem 0.5rem;font-size:0.7rem;color:var(--text-secondary);line-height:1.3}
.mc-msg.tool{border-left:2px solid var(--purple);font-family:var(--font-mono,monospace);font-size:0.65rem}
.mc-msg.system{border-left:2px solid var(--yellow)}
.mc-msg-time{font-size:0.55rem;color:var(--text-secondary);margin-bottom:0.1rem}
.mc-msg-content{white-space:pre-wrap;word-break:break-word}

/* Memory ‚Äî mini wiki */
.mc-mem-search{width:100%;padding:0.3rem 0.5rem;border:1px solid var(--border);border-radius:6px;background:var(--bg-tertiary);color:var(--text-primary);font-size:0.68rem;margin-bottom:0.4rem;outline:none}
.mc-mem-search:focus{border-color:var(--purple)}
.mc-mem-group{margin-bottom:0.45rem}
.mc-mem-group-title{font-size:0.58rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--purple);cursor:pointer;display:flex;align-items:center;gap:0.3rem;padding:0.15rem 0;user-select:none}
.mc-mem-group-title:hover{color:#a78bfa}
.mc-mem-group-count{font-size:0.52rem;color:var(--text-secondary);font-weight:400}
.mc-mem-group-items{padding-left:0.1rem}
.mc-mem-entry{background:var(--bg-tertiary);border-radius:5px;padding:0.3rem 0.5rem;margin-bottom:0.2rem;font-size:0.7rem;cursor:pointer;transition:background .15s;border-left:2px solid transparent}
.mc-mem-entry:hover{background:rgba(124,58,237,.06);border-left-color:var(--purple)}
.mc-mem-key{font-weight:600;color:var(--text-primary);font-size:0.66rem}
.mc-mem-val{color:var(--text-secondary);font-size:0.62rem;line-height:1.3}
.mc-mem-meta{display:flex;align-items:center;gap:0.3rem;margin-top:0.15rem}
.mc-mem-confidence{height:3px;width:40px;background:var(--bg-tertiary);border-radius:2px;overflow:hidden}
.mc-mem-confidence-bar{height:100%;background:var(--purple);border-radius:2px}
.mc-mem-occurrences{font-size:0.5rem;color:var(--text-secondary)}
.mc-mem-add{width:100%;padding:0.25rem;border:1px dashed var(--border);border-radius:5px;background:transparent;color:var(--text-secondary);font-size:0.65rem;cursor:pointer;margin-top:0.3rem;transition:all .15s}
.mc-mem-add:hover{border-color:var(--purple);color:var(--purple)}
.mc-mem-empty{font-size:0.7rem;color:var(--text-secondary);font-style:italic;padding:0.3rem 0}

/* Git + PRs */
.mc-git-graph{display:grid;grid-template-columns:repeat(14,1fr);gap:2px;margin-bottom:0.5rem}
.mc-git-cell{aspect-ratio:1;border-radius:2px;background:var(--bg-tertiary)}
.mc-git-cell.l1{background:rgba(124,58,237,.2)}
.mc-git-cell.l2{background:rgba(124,58,237,.45)}
.mc-git-cell.l3{background:rgba(124,58,237,.7)}
.mc-git-cell.l4{background:var(--purple)}
.mc-commit{display:flex;align-items:baseline;gap:0.3rem;padding:0.2rem 0;font-size:0.68rem;border-bottom:1px solid var(--border)}
.mc-commit:last-child{border-bottom:none}
.mc-commit-hash{color:var(--purple);font-family:var(--font-mono,monospace);font-size:0.62rem;flex-shrink:0}
.mc-commit-msg{color:var(--text-secondary);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.mc-commit-time{color:var(--text-secondary);font-size:0.58rem;flex-shrink:0;opacity:.7}
.mc-pr{display:flex;align-items:center;gap:0.35rem;padding:0.25rem 0;border-bottom:1px solid var(--border);font-size:0.68rem}
.mc-pr:last-child{border-bottom:none}
.mc-pr-icon{color:#3fb950;flex-shrink:0}
.mc-pr-icon.merged{color:#a371f7}
.mc-pr-icon.closed{color:#f85149}
.mc-pr-title{color:var(--text-primary);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-weight:500}
.mc-pr-status{font-size:0.58rem;padding:0.1rem 0.35rem;border-radius:3px;font-weight:600}
.mc-pr-status.open{background:rgba(63,185,80,.12);color:#3fb950}
.mc-pr-status.merged{background:rgba(163,113,247,.12);color:#a371f7}
.mc-pr-status.closed{background:rgba(248,81,73,.12);color:#f85149}
.mc-pr-empty{font-size:0.7rem;color:var(--text-secondary);font-style:italic;padding:0.3rem 0}
.mc-commit{display:flex;align-items:center;gap:0.4rem;padding:0.2rem 0;font-size:0.68rem;border-bottom:1px solid var(--border)}
.mc-commit:last-child{border-bottom:none}
.mc-commit-hash{color:var(--purple);font-size:0.62rem;background:rgba(124,58,237,.08);padding:0.1rem 0.3rem;border-radius:3px;flex-shrink:0}
.mc-commit-msg{color:var(--text-secondary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.mc-si-item{font-size:0.7rem;padding:0.15rem 0;display:flex;gap:0.3rem}
.mc-si-label{color:var(--text-secondary);min-width:4rem;flex-shrink:0}
.mc-si-value{color:var(--text-primary)}
.mc-si-svc{font-size:0.65rem;padding:0.15rem 0.4rem;background:rgba(124,58,237,.06);border-radius:3px;margin:0.1rem 0}
.mc-lesson{font-size:0.7rem;padding:0.3rem 0.4rem;margin:0.15rem 0;background:rgba(63,185,80,.06);border-left:2px solid rgba(63,185,80,.4);border-radius:0 3px 3px 0}
.mc-lesson-cat{font-size:0.6rem;color:var(--purple);text-transform:uppercase;letter-spacing:0.03em}
.mc-guard{display:inline-flex;align-items:center;gap:0.25rem;font-size:0.6rem;padding:0.1rem 0.35rem;border-radius:3px;margin-left:0.3rem;font-weight:500}
.mc-guard.pass{background:rgba(63,185,80,.1);color:#3fb950}
.mc-guard.fail{background:rgba(248,81,73,.1);color:#f85149}
.mc-guard-detail{font-size:0.62rem;color:var(--text-secondary);margin-top:0.15rem;padding:0.2rem 0.4rem;background:rgba(248,81,73,.04);border-radius:3px;display:none}
.mc-guard-detail.show{display:block}

/* Result banner */
.mc-result-banner{background:var(--bg-tertiary);border:1px solid color-mix(in srgb,var(--green) 30%,var(--border));border-radius:8px;padding:0.6rem 0.85rem;margin-bottom:0.5rem}
.mc-result-header{display:flex;align-items:center;gap:0.6rem;flex-wrap:wrap}
.mc-result-link{font-size:0.78rem;color:var(--green);text-decoration:none;font-weight:600}
.mc-result-link:hover{text-decoration:underline}
.mc-result-cmd{font-size:0.72rem;color:var(--text-primary);background:var(--bg-primary);padding:0.2rem 0.5rem;border-radius:4px;border:1px solid var(--border);cursor:pointer;transition:border-color .2s;font-family:var(--font-mono)}
.mc-result-cmd:hover{border-color:var(--purple)}
.mc-result-shots{display:flex;gap:0.5rem;margin-top:0.5rem;overflow-x:auto;padding-bottom:0.3rem}
.mc-result-shots img{height:120px;border-radius:6px;border:1px solid var(--border);cursor:pointer;transition:transform .2s;object-fit:cover;flex-shrink:0}
.mc-result-shots img:hover{transform:scale(1.05);border-color:var(--purple)}

/* ====== TAB BAR ====== */
.mc-tabs{display:flex;gap:2px;margin-bottom:0.75rem;padding:0}
.mc-tab-btn{display:inline-flex;align-items:center;gap:0.3rem;padding:0.35rem 0.7rem;border:none;border-radius:6px;background:transparent;color:var(--text-secondary);font-size:0.72rem;font-weight:600;cursor:pointer;transition:background .15s,color .15s;font-family:inherit}
.mc-tab-btn:hover{background:var(--bg-tertiary);color:var(--text-primary)}
.mc-tab-btn.active{background:var(--purple);color:#fff}
.mc-tab-btn .icon{width:13px;height:13px}
.mc-tab-panel[data-tab]{display:none}
.mc-tab-panel[data-tab="phases"]{display:block}

/* ====== DEV TAB ====== */
.mc-dev-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem}
.mc-dev-commits,.mc-dev-prs{background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;padding:0.75rem}
.mc-dev-commits h4,.mc-dev-prs h4,.mc-dev-files h4{font-size:0.78rem;color:var(--text-primary);margin:0 0 0.5rem;font-weight:700}
.mc-dev-commit{display:flex;align-items:center;gap:0.5rem;padding:0.3rem 0;position:relative;padding-left:1.2rem;border-left:2px solid var(--border);margin-left:0.35rem}
.mc-dev-commit-dot{position:absolute;left:-5px;top:50%;transform:translateY(-50%);width:8px;height:8px;border-radius:50%;background:var(--purple);border:2px solid var(--bg-secondary)}
.mc-dev-commit-hash{font-size:0.65rem;color:var(--purple);background:rgba(124,58,237,.08);padding:0.1rem 0.3rem;border-radius:3px;flex-shrink:0}
.mc-dev-commit-msg{font-size:0.72rem;color:var(--text-secondary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.mc-dev-pr{display:flex;align-items:center;gap:0.4rem;padding:0.35rem 0.5rem;border-bottom:1px solid var(--border);font-size:0.72rem}
.mc-dev-pr:last-child{border-bottom:none}
.mc-dev-pr-icon{color:#3fb950;flex-shrink:0}
.mc-dev-pr-num{color:var(--text-secondary);font-size:0.65rem;flex-shrink:0}
.mc-dev-pr-title{color:var(--text-primary);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-weight:500}
.mc-dev-pr-status{font-size:0.58rem;padding:0.1rem 0.35rem;border-radius:3px;font-weight:600}
.mc-dev-pr-status.open{background:rgba(63,185,80,.12);color:#3fb950}
.mc-dev-pr-status.merged{background:rgba(163,113,247,.12);color:#a371f7}
.mc-dev-pr-status.closed{background:rgba(248,81,73,.12);color:#f85149}
.mc-dev-empty{font-size:0.72rem;color:var(--text-secondary);font-style:italic;padding:0.5rem 0}
.mc-dev-files{background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;padding:0.75rem}
.mc-dev-file-tree{max-height:300px;overflow-y:auto}
.mc-dev-file{font-size:0.7rem;color:var(--text-secondary);padding:0.15rem 0;display:flex;align-items:center;gap:0.3rem}
.mc-dev-file-icon{flex-shrink:0;font-size:0.75rem}

/* ====== PO TAB (Kanban) ====== */
.mc-kanban{display:flex;gap:0.75rem;min-height:300px}
.mc-kanban-col{flex:1;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;padding:0.5rem;display:flex;flex-direction:column;gap:0.4rem}
.mc-kanban-col-header{display:flex;align-items:center;gap:0.4rem;font-size:0.72rem;font-weight:700;color:var(--text-primary);padding:0.3rem 0.4rem;margin-bottom:0.2rem}
.mc-kanban-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.mc-kanban-dot.backlog{background:var(--text-secondary)}
.mc-kanban-dot.sprint{background:var(--purple)}
.mc-kanban-dot.done{background:var(--green)}
.mc-kanban-count{font-size:0.6rem;color:var(--text-secondary);font-weight:400;margin-left:auto}
.mc-kanban-card{background:var(--bg-tertiary);border:1px solid var(--border);border-radius:6px;padding:0.5rem;border-left:3px solid var(--border)}
.mc-kanban-card.done{opacity:.7}
.mc-kanban-card-title{font-size:0.75rem;font-weight:600;color:var(--text-primary);margin-bottom:0.2rem}
.mc-kanban-card-criteria{font-size:0.65rem;color:var(--text-secondary);line-height:1.4;margin-bottom:0.25rem}
.mc-kanban-card-assignee{font-size:0.62rem;color:var(--purple);margin-bottom:0.2rem}
.mc-kanban-card-meta{display:flex;gap:0.4rem;align-items:center}
.mc-kanban-sp{font-size:0.6rem;color:var(--text-secondary);background:var(--bg-secondary);padding:0.08rem 0.3rem;border-radius:3px}
.mc-kanban-priority{font-size:0.58rem;font-weight:700;padding:0.08rem 0.3rem;border-radius:3px}
.mc-kanban-priority.p0,.mc-kanban-priority.p1{background:rgba(248,81,73,.12);color:#f85149}
.mc-kanban-priority.p2{background:rgba(234,179,8,.12);color:var(--yellow)}
.mc-kanban-priority.p3,.mc-kanban-priority.p4{background:rgba(63,185,80,.12);color:#3fb950}

/* ====== QA TAB ====== */
.mc-qa-section{background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;padding:0.75rem;margin-bottom:0.6rem}
.mc-qa-section h4{font-size:0.78rem;color:var(--text-primary);margin:0 0 0.6rem;font-weight:700}
.mc-qa-empty{font-size:0.72rem;color:var(--text-secondary);font-style:italic;padding:0.5rem 0}
.mc-qa-test-grid{display:flex;flex-direction:column;gap:0.3rem}
.mc-qa-test-file{display:flex;align-items:center;gap:0.5rem;font-size:0.72rem;padding:0.3rem 0.5rem;background:var(--bg-tertiary);border-radius:6px}
.mc-qa-test-path{color:var(--text-primary);font-family:var(--font-mono);font-size:0.68rem}
.mc-qa-test-badge{font-size:0.6rem;font-weight:700;padding:2px 6px;border-radius:4px;text-transform:uppercase;white-space:nowrap}
.mc-qa-badge-unit{background:rgba(139,92,246,.2);color:#a78bfa}
.mc-qa-badge-e2e{background:rgba(59,130,246,.2);color:#60a5fa}
.mc-qa-badge-e2e-ihm{background:rgba(236,72,153,.2);color:#f472b6}
.mc-qa-badge-smoke{background:rgba(245,158,11,.2);color:#fbbf24}
.mc-qa-results{display:flex;flex-direction:column;gap:0.5rem}
.mc-qa-result-card{background:var(--bg-tertiary);border:1px solid var(--border);border-radius:8px;padding:0.6rem;overflow:hidden}
.mc-qa-result-header{display:flex;align-items:center;gap:0.5rem;font-size:0.7rem;margin-bottom:0.4rem;flex-wrap:wrap}
.mc-qa-result-phase{font-weight:600;color:var(--text-primary)}
.mc-qa-result-agent{color:var(--purple-light);font-size:0.65rem}
.mc-qa-result-excerpt{font-size:0.68rem;color:var(--text-secondary);max-height:120px;overflow-y:auto;line-height:1.4}
.mc-qa-result-excerpt p{margin:0.2rem 0}
.mc-qa-screenshots-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:0.6rem}
.mc-qa-shot-card{background:var(--bg-tertiary);border:1px solid var(--border);border-radius:8px;overflow:hidden}
.mc-qa-shot-label{padding:4px 8px;font-size:0.65rem;color:var(--text-secondary)}
.mc-qa-adversarial-details{cursor:pointer}
.mc-qa-adversarial-details summary{list-style:none;user-select:none}
.mc-qa-adversarial-details summary::-webkit-details-marker{display:none}
.mc-qa-adversarial-details summary h4::before{content:'‚ñ∏ ';font-size:0.7rem}
.mc-qa-adversarial-details[open] summary h4::before{content:'‚ñæ '}
.mc-qa-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:0.6rem;margin-bottom:1rem}
.mc-qa-agent-card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;padding:0.6rem}
.mc-qa-agent-name{font-size:0.75rem;font-weight:600;color:var(--text-primary);margin-bottom:0.3rem}
.mc-qa-agent-bar{height:6px;background:var(--bg-tertiary);border-radius:3px;overflow:hidden;margin-bottom:0.3rem}
.mc-qa-bar-fill{height:100%;border-radius:3px;transition:width .4s}
.mc-qa-agent-stats{display:flex;gap:0.5rem;font-size:0.62rem}
.mc-qa-ok{color:var(--green)}
.mc-qa-ko{color:var(--red)}
.mc-qa-total{color:var(--text-secondary)}
.mc-qa-metrics{display:flex;gap:1rem;flex-wrap:wrap}
.mc-qa-metric{background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;padding:0.6rem 1rem;text-align:center;flex:1;min-width:120px}
.mc-qa-metric-val{display:block;font-size:1.4rem;font-weight:700;color:var(--purple)}
.mc-qa-metric-label{display:block;font-size:0.65rem;color:var(--text-secondary);margin-top:0.15rem}

/* ====== ARCHI TAB ====== */
.mc-archi-doc,.mc-archi-decisions,.mc-archi-stack{background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;padding:0.75rem;margin-bottom:0.6rem}
.mc-archi-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem}
.mc-archi-header h4{font-size:0.78rem;color:var(--text-primary);margin:0;font-weight:700}
.mc-archi-updated{font-size:0.6rem;color:var(--text-secondary)}
.mc-archi-body{font-size:0.72rem;color:var(--text-secondary);line-height:1.5;max-height:500px;overflow-y:auto}
.mc-archi-body h1,.mc-archi-body h2,.mc-archi-body h3{color:var(--text-primary);font-size:0.82rem;margin:0.6rem 0 0.3rem}
.mc-archi-body code{background:var(--bg-tertiary);padding:1px 4px;border-radius:3px;font-size:0.68rem}
.mc-archi-body pre{background:var(--bg-primary);padding:0.5rem;border-radius:6px;overflow-x:auto;font-size:0.68rem}
.mc-archi-body table{width:100%;border-collapse:collapse;font-size:0.68rem}
.mc-archi-body td,.mc-archi-body th{border:1px solid var(--border);padding:4px 8px}
.mc-archi-empty,.mc-wiki-empty{text-align:center;padding:2rem;color:var(--text-secondary);font-size:0.75rem}
.mc-archi-hint,.mc-wiki-hint{font-size:0.65rem;font-style:italic;margin-top:0.3rem;opacity:.6}
.mc-archi-decisions h4{font-size:0.78rem;color:var(--text-primary);margin:0 0 0.5rem;font-weight:700}
.mc-archi-decision{background:var(--bg-tertiary);border-radius:6px;padding:0.5rem;margin-bottom:0.4rem}
.mc-archi-decision-phase{font-size:0.62rem;color:var(--purple-light);font-weight:600;margin-bottom:0.2rem}
.mc-archi-decision-text{font-size:0.7rem;color:var(--text-secondary);line-height:1.4}
.mc-archi-decision-text p{margin:0.15rem 0}
.mc-archi-stack h4{font-size:0.78rem;color:var(--text-primary);margin:0 0 0.4rem;font-weight:700}
.mc-archi-stack-tags{display:flex;flex-wrap:wrap;gap:0.3rem}
.mc-archi-tag{font-size:0.65rem;padding:3px 8px;background:rgba(139,92,246,.15);color:#c084fc;border-radius:4px;font-weight:500}

/* ====== WIKI TAB ====== */
.mc-wiki-page{background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;margin-bottom:0.5rem;overflow:hidden}
.mc-wiki-page-title{display:flex;justify-content:space-between;align-items:center;padding:0.6rem 0.75rem;font-size:0.78rem;font-weight:600;color:var(--text-primary);cursor:pointer;user-select:none;list-style:none}
.mc-wiki-page-title::-webkit-details-marker{display:none}
.mc-wiki-page-title::before{content:'‚ñ∏ ';font-size:0.7rem;color:var(--text-secondary)}
.mc-wiki-page[open] .mc-wiki-page-title::before{content:'‚ñæ '}
.mc-wiki-page-date{font-size:0.6rem;color:var(--text-secondary);font-weight:400}
.mc-wiki-page-body{padding:0 0.75rem 0.75rem;font-size:0.72rem;color:var(--text-secondary);line-height:1.5;border-top:1px solid var(--border)}
.mc-wiki-page-body h1,.mc-wiki-page-body h2,.mc-wiki-page-body h3{color:var(--text-primary);font-size:0.8rem;margin:0.5rem 0 0.2rem}
.mc-wiki-page-body code{background:var(--bg-tertiary);padding:1px 4px;border-radius:3px;font-size:0.68rem}
.mc-wiki-page-body pre{background:var(--bg-primary);padding:0.5rem;border-radius:6px;overflow-x:auto;font-size:0.68rem}
.mc-wiki-memories{background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;padding:0.75rem;margin-top:0.5rem}
.mc-wiki-memories h4{font-size:0.78rem;color:var(--text-primary);margin:0 0 0.5rem;font-weight:700}
.mc-wiki-memory{display:flex;gap:0.5rem;align-items:baseline;padding:0.25rem 0;border-bottom:1px solid var(--bg-tertiary);font-size:0.7rem}
.mc-wiki-memory:last-child{border-bottom:none}
.mc-wiki-memory-cat{font-size:0.6rem;font-weight:600;padding:2px 6px;background:rgba(59,130,246,.12);color:#60a5fa;border-radius:3px;white-space:nowrap}
.mc-wiki-memory-text{color:var(--text-secondary);line-height:1.4}

/* ====== PROJET TAB ====== */
.mc-projet-url,.mc-projet-build,.mc-projet-gallery,.mc-projet-files{background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;padding:0.75rem;margin-bottom:0.6rem}
.mc-projet-url h4,.mc-projet-build h4,.mc-projet-gallery h4,.mc-projet-files h4{font-size:0.78rem;color:var(--text-primary);margin:0 0 0.4rem;font-weight:700}
.mc-projet-url a{color:var(--purple);font-size:0.82rem;word-break:break-all}
.mc-projet-build code{display:block;font-size:0.72rem;color:var(--text-primary);background:var(--bg-primary);padding:0.35rem 0.6rem;border-radius:4px;border:1px solid var(--border);margin-bottom:0.3rem;font-family:var(--font-mono)}
.mc-projet-imgs{display:flex;flex-wrap:wrap;gap:0.5rem}
.mc-projet-imgs img{height:140px;border-radius:6px;border:1px solid var(--border);cursor:pointer;transition:transform .2s;object-fit:cover}
.mc-projet-imgs img:hover{transform:scale(1.05);border-color:var(--purple)}
.mc-projet-file-tree{max-height:300px;overflow-y:auto}

@media(max-width:900px){.mc-layout{grid-template-columns:1fr;height:auto}.mc-sidebar{border-left:none;border-top:1px solid var(--border)}.mc-dev-grid{grid-template-columns:1fr}.mc-kanban{flex-direction:column}}
</style>

<!-- SVG defs for pattern-colored arrow markers -->
<svg width="0" height="0" style="position:absolute">
  <defs>
    <marker id="mc-arrow-sequential" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="7" markerHeight="7" orient="auto-start-reverse"><path d="M0,0 L10,5 L0,10 z" fill="#3b82f6" opacity="0.8"/></marker>
    <marker id="mc-arrow-hierarchical" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="7" markerHeight="7" orient="auto-start-reverse"><path d="M0,0 L10,5 L0,10 z" fill="#f59e0b" opacity="0.8"/></marker>
    <marker id="mc-arrow-parallel" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="7" markerHeight="7" orient="auto-start-reverse"><path d="M0,0 L10,5 L0,10 z" fill="#10b981" opacity="0.8"/></marker>
    <marker id="mc-arrow-loop" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="7" markerHeight="7" orient="auto-start-reverse"><path d="M0,0 L10,5 L0,10 z" fill="#ec4899" opacity="0.8"/></marker>
    <marker id="mc-arrow-network" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="7" markerHeight="7" orient="auto-start-reverse"><path d="M0,0 L10,5 L0,10 z" fill="#8b5cf6" opacity="0.8"/></marker>
    <marker id="mc-arrow-router" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="7" markerHeight="7" orient="auto-start-reverse"><path d="M0,0 L10,5 L0,10 z" fill="#06b6d4" opacity="0.8"/></marker>
    <marker id="mc-arrow-default" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="7" markerHeight="7" orient="auto-start-reverse"><path d="M0,0 L10,5 L0,10 z" fill="#6b7280" opacity="0.6"/></marker>
  </defs>
</svg>

<div class="mc-layout">
    <!-- ====== MAIN: Timeline + Accordions ====== -->
    <div class="mc-main">
        {% if mission.brief %}
        <div style="background:var(--bg-tertiary);border:1px solid var(--border);border-radius:8px;padding:0.6rem 0.85rem;margin-bottom:0.5rem;display:flex;align-items:baseline;gap:0.5rem">
            <span style="font-size:0.7rem;color:var(--purple);font-weight:700;white-space:nowrap">DEMANDE</span>
            <span style="font-size:0.82rem;color:var(--text-primary);line-height:1.4">{{ mission.brief }}</span>
        </div>
        {% endif %}

        {# ‚îÄ‚îÄ Result Banner: screenshots + build/run + deploy URL ‚îÄ‚îÄ #}
        {% if result_screenshots or result_build_cmd or result_deploy_url or result_launch_cmd %}
        <div class="mc-result-banner">
            <div class="mc-result-header">
                <span style="font-size:0.7rem;color:var(--green);font-weight:700">R√âSULTAT</span>
                {% if result_project_type %}
                <span style="font-size:0.65rem;background:var(--bg-tertiary);color:var(--purple-light);padding:2px 8px;border-radius:10px;border:1px solid var(--border)">{{ {'macos-native':'üñ•Ô∏è macOS','ios-native':'üì± iOS','android-native':'ü§ñ Android','web-docker':'üê≥ Docker','web-node':'‚¨¢ Node.js','web-static':'üåê Static'}.get(result_project_type, result_project_type) }}</span>
                {% endif %}
                {% if result_deploy_url %}
                <a href="{{ result_deploy_url }}" target="_blank" class="mc-result-link">üåê {{ result_deploy_url }}</a>
                {% endif %}
                {% if result_launch_cmd %}
                <code class="mc-result-cmd mc-exec-btn" data-cmd="{{ result_launch_cmd }}" title="‚ñ∂ Cliquer pour ex√©cuter" style="color:var(--green);border-color:var(--green);cursor:pointer">üöÄ {{ result_launch_cmd }}</code>
                {% endif %}
                {% if result_run_cmd and result_run_cmd != result_launch_cmd %}
                <code class="mc-result-cmd mc-exec-btn" data-cmd="{{ result_run_cmd }}" title="‚ñ∂ Cliquer pour ex√©cuter" style="cursor:pointer">‚ñ∂ {{ result_run_cmd }}</code>
                {% endif %}
                {% if result_build_cmd and result_build_cmd != result_run_cmd %}
                <code class="mc-result-cmd mc-exec-btn" data-cmd="{{ result_build_cmd }}" title="‚ñ∂ Cliquer pour ex√©cuter" style="color:var(--text-secondary);cursor:pointer">üîß {{ result_build_cmd }}</code>
                {% endif %}
            </div>
            <!-- Inline terminal for command output -->
            <div id="mc-terminal" style="display:none;background:#0a0a12;border:1px solid var(--border);border-radius:6px;padding:8px 12px;margin-top:6px;max-height:200px;overflow-y:auto;font-family:var(--font-mono);font-size:0.75rem;line-height:1.5">
                <div id="mc-terminal-header" style="color:var(--text-secondary);margin-bottom:4px">
                    <span id="mc-terminal-cmd" style="color:var(--purple-light)"></span>
                    <span id="mc-terminal-status" style="float:right"></span>
                </div>
                <pre id="mc-terminal-output" style="margin:0;white-space:pre-wrap;color:var(--text-primary)"></pre>
            </div>
            {% if result_screenshots %}
            <div class="mc-result-shots">
                {% for s in result_screenshots %}
                <img src="/workspace/{{ mission.id }}/{{ s }}" alt="{{ s }}" loading="lazy" onclick="window.open(this.src)" onerror="this.style.display='none'">
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% endif %}
        <div class="mc-stats">
            <div class="mc-stat-item"><span class="val" id="mc-done-count">{{ mission.phases|selectattr('status.value','equalto','done')|list|length }}</span>/<span>{{ mission.phases|length }}</span> phases</div>
            <div class="mc-progress-bar"><div class="mc-progress-fill" id="mc-progress-bar" style="width:{{ ((mission.phases|selectattr('status.value','equalto','done')|list|length / mission.phases|length) * 100)|round|int if mission.phases|length > 0 else 0 }}%"></div></div>
            <div class="mc-stat-item"><span class="val" id="mc-progress">{{ ((mission.phases|selectattr('status.value','equalto','done')|list|length / mission.phases|length) * 100)|round|int if mission.phases|length > 0 else 0 }}%</span></div>
        </div>

        <!-- Tab bar -->
        <div class="mc-tabs">
            <button class="mc-tab-btn active" data-tab="phases" onclick="switchTab('phases')"><svg class="icon"><use href="#icon-list"/></svg> Phases</button>
            <button class="mc-tab-btn" data-tab="dev" onclick="switchTab('dev')"><svg class="icon"><use href="#icon-git-branch"/></svg> Dev</button>
            <button class="mc-tab-btn" data-tab="po" onclick="switchTab('po')"><svg class="icon"><use href="#icon-clipboard"/></svg> PO</button>
            <button class="mc-tab-btn" data-tab="qa" onclick="switchTab('qa')"><svg class="icon"><use href="#icon-check"/></svg> QA</button>
            <button class="mc-tab-btn" data-tab="archi" onclick="switchTab('archi')"><svg class="icon"><use href="#icon-layers"/></svg> Archi</button>
            <button class="mc-tab-btn" data-tab="wiki" onclick="switchTab('wiki')"><svg class="icon"><use href="#icon-book-open"/></svg> Wiki</button>
            <button class="mc-tab-btn" data-tab="projet" onclick="switchTab('projet')"><svg class="icon"><use href="#icon-code"/></svg> Projet</button>
        </div>

        <!-- Tab: Phases (default) -->
        <div class="mc-tab-panel" data-tab="phases" style="display:block">
        <div class="mc-pipeline" id="mc-pipeline">
            {% for phase in mission.phases %}
            {% set pa = phase_agents.get(phase.phase_id, []) %}
            <div class="mc-phase{% if phase.status.value == 'running' %} open{% endif %}" data-phase-id="{{ phase.phase_id }}" data-status="{{ phase.status.value }}">
                <div class="mc-phase-line">
                    <div class="mc-phase-dot"></div>
                    <div class="mc-phase-connector"></div>
                </div>
                <div class="mc-phase-card">
                    <div class="mc-phase-header" onclick="togglePhase(this)">
                        <span class="mc-phase-num">{{ loop.index }}</span>
                        <span class="mc-phase-name">{{ phase.phase_name }}</span>
                        <div class="mc-phase-avatars">
                            {% for a in pa[:4] %}
                            <img src="{{ a.avatar_url }}" title="{{ a.name }} ‚Äî {{ a.role }}" onclick="showMcPopover('{{ a.id }}',event);event.stopPropagation()" style="cursor:pointer" onerror="this.style.display='none'">
                            {% endfor %}
                            {% if pa|length > 4 %}<span class="more">+{{ pa|length - 4 }}</span>{% endif %}
                        </div>
                        <span class="mc-phase-pattern">{{ phase.pattern_id }}</span>
                        <span class="mc-phase-status-badge {{ phase.status.value }}">{{ phase.status.value }}</span>
                        <span class="mc-phase-chevron"><svg class="icon icon-xs mc-phase-chevron-icon"><use href="#icon-chevron-right"/></svg></span>
                    </div>
                    <div class="mc-phase-summary" id="summary-{{ phase.phase_id }}">
                        {% if phase.summary %}<div class="mc-summary-line"><span class="mc-summary-text">{{ phase.summary[:300] }}</span></div>{% endif %}
                        {% set shots = phase_screenshots.get(phase.phase_id, []) if phase_screenshots is defined else [] %}
                        {% if shots %}
                        <div class="mc-phase-thumbs">
                            {% for s in shots %}
                            <img class="mc-phase-thumb" src="/workspace/{{ mission.id }}/{{ s }}" alt="Screenshot" loading="lazy" onclick="window.open(this.src)" onerror="this.src='/workspace/{{ s }}'">
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    <div class="mc-phase-body">
                        <!-- Full flow graph -->
                        <div class="mc-phase-graph" id="graph-{{ phase.phase_id }}"></div>
                        <!-- Discussion below graph -->
                        <div class="mc-phase-discuss" id="discuss-{{ phase.phase_id }}">
                            {% set pmsgs = phase_messages.get(phase.phase_id, []) %}
                            {% if pmsgs %}
                                {% for msg in pmsgs %}
                                {% set msg_mode = "chat" %}
                                {% include "partials/msg_unified.html" %}
                                {% endfor %}
                            {% else %}
                                <div class="mc-discuss-empty">En attente d'ex√©cution‚Ä¶</div>
                            {% endif %}
                        </div>
                    </div>
                    {% if phase.status.value == 'waiting_validation' %}
                    <div class="mc-checkpoint">
                        <h4>Checkpoint ‚Äî Validation requise</h4>
                        <div class="mc-checkpoint-actions">
                            <button class="mc-btn-go" onclick="validateMission('GO')">GO</button>
                            <button class="mc-btn-nogo" onclick="validateMission('NOGO')">NOGO</button>
                            <button class="mc-btn-pivot" onclick="validateMission('PIVOT')">PIVOT</button>
                        </div>
                    </div>
                    {% endif %}
                    {% if phase.summary %}
                    <div style="padding:0.35rem 0.75rem;font-size:0.72rem;color:var(--text-secondary);border-top:1px solid var(--border)">{{ phase.summary[:300] }}</div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        </div>{# end tab: phases #}

        <!-- Tab: Dev -->
        <div class="mc-tab-panel" data-tab="dev">
            <div class="mc-dev-grid">
                <div class="mc-dev-commits">
                    <h4>Commits</h4>
                    {% for c in workspace_commits %}
                    <div class="mc-dev-commit">
                        <div class="mc-dev-commit-dot"></div>
                        <code class="mc-dev-commit-hash">{{ c.hash[:7] }}</code>
                        <span class="mc-dev-commit-msg">{{ c.message[:80] }}</span>
                    </div>
                    {% endfor %}
                    {% if not workspace_commits %}<div class="mc-dev-empty">Aucun commit</div>{% endif %}
                </div>
                <div class="mc-dev-prs">
                    <h4>Pull Requests</h4>
                    {% for pr in pull_requests %}
                    <div class="mc-dev-pr {{ pr.status|lower }}">
                        <span class="mc-dev-pr-icon"><svg class="icon icon-xs"><use href="#icon-git-pull-request"/></svg></span>
                        <span class="mc-dev-pr-num">#{{ pr.number }}</span>
                        <span class="mc-dev-pr-title">{{ pr.title[:60] }}</span>
                        <span class="mc-dev-pr-status {{ pr.status|lower }}">{{ pr.status }}</span>
                    </div>
                    {% endfor %}
                    {% if not pull_requests %}<div class="mc-dev-empty">Aucune PR</div>{% endif %}
                </div>
            </div>
            <div class="mc-dev-files">
                <h4>Fichiers ({{ workspace_files|length if workspace_files else 0 }})</h4>
                <div class="mc-dev-file-tree">
                    {% for f in workspace_files or [] %}
                    <div class="mc-dev-file"><span class="mc-dev-file-icon">{{ 'üìÅ' if f.is_dir else 'üìÑ' }}</span>{{ f.path }}</div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Tab: PO -->
        <div class="mc-tab-panel" data-tab="po">
            <div class="mc-kanban">
                <div class="mc-kanban-col" data-col="backlog">
                    <div class="mc-kanban-col-header"><span class="mc-kanban-dot backlog"></span> Backlog <span class="mc-kanban-count">{{ po_backlog|length }}</span></div>
                    {% for f in po_backlog %}
                    <div class="mc-kanban-card">
                        <div class="mc-kanban-card-title">{{ f.name }}</div>
                        {% if f.acceptance_criteria %}<div class="mc-kanban-card-criteria">{{ f.acceptance_criteria[:100] }}</div>{% endif %}
                        {% if f.assigned_to %}<div class="mc-kanban-card-assignee">{{ f.assigned_to }}</div>{% endif %}
                        <div class="mc-kanban-card-meta">
                            {% if f.story_points %}<span class="mc-kanban-sp">{{ f.story_points }} SP</span>{% endif %}
                            <span class="mc-kanban-priority p{{ f.priority }}">P{{ f.priority }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="mc-kanban-col" data-col="sprint">
                    <div class="mc-kanban-col-header"><span class="mc-kanban-dot sprint"></span> En cours <span class="mc-kanban-count">{{ po_sprint|length }}</span></div>
                    {% for f in po_sprint %}
                    <div class="mc-kanban-card">
                        <div class="mc-kanban-card-title">{{ f.name }}</div>
                        {% if f.acceptance_criteria %}<div class="mc-kanban-card-criteria">{{ f.acceptance_criteria[:100] }}</div>{% endif %}
                        {% if f.assigned_to %}<div class="mc-kanban-card-assignee">{{ f.assigned_to }}</div>{% endif %}
                    </div>
                    {% endfor %}
                </div>
                <div class="mc-kanban-col" data-col="done">
                    <div class="mc-kanban-col-header"><span class="mc-kanban-dot done"></span> Termin√© <span class="mc-kanban-count">{{ po_done|length }}</span></div>
                    {% for f in po_done %}
                    <div class="mc-kanban-card done">
                        <div class="mc-kanban-card-title">{{ f.name }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Tab: QA -->
        <div class="mc-tab-panel" data-tab="qa">
            <div class="mc-qa">

                <!-- Section 1: Tests unitaires & E2E trouv√©s dans le workspace -->
                <div class="mc-qa-section">
                    <h4>Tests ‚Äî Fichiers</h4>
                    {% if qa_test_files %}
                    <div class="mc-qa-test-grid">
                        {% for tf in qa_test_files %}
                        <div class="mc-qa-test-file">
                            <span class="mc-qa-test-badge mc-qa-badge-{{ tf.type }}">{{ tf.type }}</span>
                            <span class="mc-qa-test-path">{{ tf.path }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="mc-qa-empty">Aucun fichier de test dans le workspace</div>
                    {% endif %}
                </div>

                <!-- Section 2: R√©sultats d'ex√©cution QA -->
                <div class="mc-qa-section">
                    <h4>R√©sultats d'ex√©cution</h4>
                    {% if qa_phase_results %}
                    <div class="mc-qa-results">
                        {% for r in qa_phase_results %}
                        <div class="mc-qa-result-card">
                            <div class="mc-qa-result-header">
                                <span class="mc-qa-result-phase">{{ r.phase }}</span>
                                <span class="mc-qa-result-agent">{{ r.agent }}</span>
                                <span class="mc-qa-ok">{{ r.passes }} pass</span>
                                <span class="mc-qa-ko">{{ r.fails }} fail</span>
                            </div>
                            <div class="mc-qa-result-excerpt">{{ r.excerpt | markdown | safe }}</div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="mc-qa-empty">Aucun r√©sultat de test</div>
                    {% endif %}
                </div>

                <!-- Section 3: Screenshots parcours utilisateur -->
                {% if result_screenshots %}
                <div class="mc-qa-section">
                    <h4>Parcours utilisateur ‚Äî Screenshots</h4>
                    <div class="mc-qa-screenshots-grid">
                        {% for s in result_screenshots %}
                        <div class="mc-qa-shot-card">
                            <img src="/workspace/{{ mission.id }}/{{ s }}" alt="{{ s }}" loading="lazy" onclick="window.open(this.src)" onerror="this.parentElement.style.display='none'" style="width:100%;cursor:pointer;border-radius:6px">
                            <div class="mc-qa-shot-label">{{ s.split('/')[-1] }}</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Section 4: Adversarial Guard (collapsible) -->
                {% if agent_scores %}
                <details class="mc-qa-section mc-qa-adversarial-details">
                    <summary><h4 style="display:inline">Adversarial Guard ‚Äî Code Review ({{ qa_pass_rate }}% pass)</h4></summary>
                    <div class="mc-qa-grid" style="margin-top:0.5rem">
                        {% for s in agent_scores %}
                        <div class="mc-qa-agent-card">
                            <div class="mc-qa-agent-name">{{ s.agent_id }}</div>
                            <div class="mc-qa-agent-bar">
                                <div class="mc-qa-bar-fill" style="width:{{ (s.accepted / s.iterations * 100)|round if s.iterations > 0 else 0 }}%;background:{{ 'var(--green)' if s.accepted > s.rejected else 'var(--red)' }}"></div>
                            </div>
                            <div class="mc-qa-agent-stats">
                                <span class="mc-qa-ok">{{ s.accepted }}</span>
                                <span class="mc-qa-ko">{{ s.rejected }}</span>
                                <span class="mc-qa-total">{{ s.iterations }} iter</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="mc-qa-metrics" style="margin-top:0.5rem">
                        <div class="mc-qa-metric"><span class="mc-qa-metric-val">{{ qa_total_iterations }}</span><span class="mc-qa-metric-label">Iterations</span></div>
                        <div class="mc-qa-metric"><span class="mc-qa-metric-val">{{ qa_total_accepted }}</span><span class="mc-qa-metric-label">Accepted</span></div>
                        <div class="mc-qa-metric"><span class="mc-qa-metric-val">{{ qa_total_rejected }}</span><span class="mc-qa-metric-label">Rejected</span></div>
                    </div>
                </details>
                {% endif %}
            </div>
        </div>

        <!-- Tab: Architecture -->
        <div class="mc-tab-panel" data-tab="archi">
            <div class="mc-archi">
                {% if archi_content %}
                <div class="mc-archi-doc">
                    <div class="mc-archi-header">
                        <h4>Architecture du projet</h4>
                        <span class="mc-archi-updated">{{ archi_updated or '' }}</span>
                    </div>
                    <div class="mc-archi-body">{{ archi_content | markdown | safe }}</div>
                </div>
                {% else %}
                <div class="mc-archi-empty">
                    <svg class="icon" style="width:32px;height:32px;opacity:.3"><use href="#icon-layers"/></svg>
                    <p>Pas encore d'architecture documentee</p>
                    <p class="mc-archi-hint">L'architecte mettra a jour ce document apres chaque phase technique</p>
                </div>
                {% endif %}
                {% if archi_decisions %}
                <div class="mc-archi-decisions">
                    <h4>Decisions architecturales</h4>
                    {% for d in archi_decisions %}
                    <div class="mc-archi-decision">
                        <div class="mc-archi-decision-phase">{{ d.phase }}</div>
                        <div class="mc-archi-decision-text">{{ d.text | markdown | safe }}</div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                {% if archi_stack %}
                <div class="mc-archi-stack">
                    <h4>Stack technique</h4>
                    <div class="mc-archi-stack-tags">
                        {% for t in archi_stack %}
                        <span class="mc-archi-tag">{{ t }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Tab: Wiki -->
        <div class="mc-tab-panel" data-tab="wiki">
            <div class="mc-wiki">
                {% if wiki_pages %}
                {% for page in wiki_pages %}
                <details class="mc-wiki-page" {% if loop.first %}open{% endif %}>
                    <summary class="mc-wiki-page-title">
                        <span>{{ page.title }}</span>
                        {% if page.updated %}<span class="mc-wiki-page-date">{{ page.updated }}</span>{% endif %}
                    </summary>
                    <div class="mc-wiki-page-body">{{ page.content | markdown | safe }}</div>
                </details>
                {% endfor %}
                {% else %}
                <div class="mc-wiki-empty">
                    <svg class="icon" style="width:32px;height:32px;opacity:.3"><use href="#icon-book-open"/></svg>
                    <p>Pas encore de documentation</p>
                    <p class="mc-wiki-hint">Le tech writer mettra a jour la documentation apres chaque phase</p>
                </div>
                {% endif %}
                {% if wiki_memories %}
                <div class="mc-wiki-memories">
                    <h4>Memoire projet</h4>
                    {% for m in wiki_memories %}
                    <div class="mc-wiki-memory">
                        <span class="mc-wiki-memory-cat">{{ m.category }}</span>
                        <span class="mc-wiki-memory-text">{{ m.value }}</span>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Tab: Projet -->
        <div class="mc-tab-panel" data-tab="projet">
            <div class="mc-projet">
                {% if result_launch_cmd %}
                <div class="mc-projet-url" style="border-color:var(--green)">
                    <h4>üöÄ Lancer l'application</h4>
                    <code class="mc-result-cmd mc-exec-btn" data-cmd="{{ result_launch_cmd }}" style="color:var(--green);border-color:var(--green);font-size:0.85rem;cursor:pointer" title="‚ñ∂ Cliquer pour ex√©cuter">{{ result_launch_cmd }}</code>
                </div>
                {% endif %}
                {% if result_deploy_url %}
                <div class="mc-projet-url">
                    <h4>üåê Application d√©ploy√©e</h4>
                    <a href="{{ result_deploy_url }}" target="_blank">{{ result_deploy_url }}</a>
                </div>
                {% endif %}
                {% if result_build_cmd %}
                <div class="mc-projet-build">
                    <h4>üîß Build & Run</h4>
                    <code class="mc-result-cmd mc-exec-btn" data-cmd="{{ result_build_cmd }}" style="cursor:pointer" title="‚ñ∂ Cliquer pour ex√©cuter">üîß {{ result_build_cmd }}</code>
                    {% if result_run_cmd %}<code class="mc-result-cmd mc-exec-btn" data-cmd="{{ result_run_cmd }}" style="cursor:pointer" title="‚ñ∂ Cliquer pour ex√©cuter">‚ñ∂ {{ result_run_cmd }}</code>{% endif %}
                </div>
                {% endif %}
                {% if result_screenshots %}
                <div class="mc-projet-gallery">
                    <h4>üì∏ Screenshots ({{ result_screenshots|length }})</h4>
                    <div class="mc-projet-imgs">
                        {% for s in result_screenshots %}
                        <div style="text-align:center">
                            <img src="/workspace/{{ mission.id }}/{{ s }}" alt="{{ s }}" loading="lazy" onclick="window.open(this.src)" onerror="this.parentElement.style.display='none'" style="max-width:300px;border-radius:8px;border:1px solid var(--border)">
                            <div style="font-size:0.7rem;color:var(--text-secondary);margin-top:4px">{{ s }}</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                <div class="mc-projet-files">
                    <h4>üìÅ Workspace</h4>
                    <div class="mc-projet-file-tree">
                        {% for f in workspace_files or [] %}
                        <div class="mc-dev-file"><span class="mc-dev-file-icon">{{ 'üìÅ' if f.is_dir else 'üìÑ' }}</span>{{ f.path }}</div>
                        {% endfor %}
                    </div>
                    {% if mission.workspace_path %}
                    <code class="mc-result-cmd" style="margin-top:0.5rem;display:inline-block" onclick="navigator.clipboard.writeText(this.textContent.trim())">cd {{ mission.workspace_path }}</code>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- ====== RIGHT SIDEBAR ====== -->
    <div class="mc-sidebar">
        {% set cdp = agent_map.get('chef_de_programme') %}
        <!-- CDP Agent Card -->
        <div class="mc-cdp-card">
            <div class="mc-cdp-card-inner">
                <div class="mc-cdp-banner">
                    <div class="mc-cdp-avatar-wrap">
                        <img class="mc-cdp-avatar" src="{{ cdp['avatar_url'] if cdp else '' }}" alt=""
                             onerror="this.src='/static/avatars/chef_de_programme.jpg'">
                    </div>
                </div>
                <div class="mc-cdp-body">
                    <h3 class="mc-cdp-name">{{ cdp['name'] if cdp else 'Chef de Programme' }}</h3>
                    <div class="mc-cdp-role">{{ cdp['role'] if cdp else 'Chef de Programme' }}</div>
                    {% if cdp and cdp.get('tagline') %}
                    <div class="mc-cdp-tagline">{{ cdp['tagline'] }}</div>
                    {% endif %}
                    <div class="mc-cdp-status-row">
                        <span class="mc-cdp-status active" id="mc-cdp-status">Pilotage actif</span>
                    </div>

                    {% if cdp and cdp.get('persona') %}
                    <div class="mc-cdp-section">
                        <div class="mc-cdp-section-title">Persona</div>
                        <div class="mc-cdp-persona">{{ cdp['persona'][:250] }}{% if cdp['persona']|length > 250 %}...{% endif %}</div>
                    </div>
                    {% endif %}

                    {% if cdp and cdp.get('motivation') %}
                    <div class="mc-cdp-section">
                        <div class="mc-cdp-section-title">Motivation</div>
                        <div class="mc-cdp-motivation">{{ cdp['motivation'][:200] }}{% if cdp['motivation']|length > 200 %}...{% endif %}</div>
                    </div>
                    {% endif %}

                    {% if cdp and cdp.get('skills') %}
                    <div class="mc-cdp-section">
                        <div class="mc-cdp-section-title">Skills</div>
                        <div class="mc-cdp-tags">
                            {% for s in cdp['skills'][:8] %}
                            <span class="mc-cdp-tag skill">{{ s }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    {% if cdp and cdp.get('tools') %}
                    <div class="mc-cdp-section">
                        <div class="mc-cdp-section-title">Tools</div>
                        <div class="mc-cdp-tags">
                            {% for t in cdp['tools'][:10] %}
                            <span class="mc-cdp-tag tool">{{ t }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <div class="mc-cdp-actions">
                        <button class="mc-cdp-btn mc-cdp-btn-chat" onclick="openCdpChat()">
                            <svg class="icon icon-xs"><use href="#icon-message-square"/></svg> Discuter
                        </button>
                        <button id="mc-run-btn" class="mc-cdp-btn mc-cdp-btn-wf" onclick="startMissionExecution()">
                            <svg class="icon icon-xs"><use href="#icon-play"/></svg> Lancer
                        </button>
                    </div>
                    <div style="text-align:right;margin-top:0.3rem">
                        <button id="mc-reset-btn" onclick="resetMission()" style="background:none;border:none;color:var(--text-secondary);font-size:0.6rem;cursor:pointer;opacity:.6;transition:opacity .15s" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='.6'">Reinitialiser</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity feed -->
        <div class="mc-activity" id="mc-activity">
            <div class="mc-msg system"><div class="mc-msg-content">Epic d√©marr√©e ‚Äî {{ mission.brief[:200] }}</div></div>
            <div class="mc-msg tool"><div class="mc-msg-time">{{ "now" }}</div><div class="mc-msg-content">{{ mission.phases|length }} phases √† orchestrer ‚Ä¢ Pattern: mega-workflow lifecycle</div></div>
            {% if mission.workspace_path %}
            <div class="mc-msg tool"><div class="mc-msg-content">Workspace: <code>{{ mission.workspace_path }}</code></div></div>
            {% endif %}
        </div>

        <!-- Memory ‚Äî Project Wiki -->
        <div class="mc-side-section">
            <div class="mc-side-title">
                <svg class="icon icon-xs"><use href="#icon-book-open"/></svg> Contexte Projet
            </div>
            <input type="text" class="mc-mem-search" id="mc-mem-search" placeholder="Rechercher‚Ä¶" oninput="filterMemory(this.value)">
            <div id="mc-memory">
                {% if memories %}
                    {% set cat_labels = {'phase-summary':'Phases','product':'Produit','architecture':'Architecture','security':'Securite','development':'Developpement','quality':'Qualite','vision':'Vision','convention':'Conventions','team':'Equipe','decisions':'Decisions','infrastructure':'Infrastructure'} %}
                    {% for cat, entries in memory_groups.items() %}
                    <div class="mc-mem-group" data-cat="{{ cat }}">
                        <div class="mc-mem-group-title" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'block':'none'">
                            {{ cat_labels.get(cat, cat) }} <span class="mc-mem-group-count">({{ entries|length }})</span>
                        </div>
                        <div class="mc-mem-group-items">
                            {% for mem in entries %}
                            <div class="mc-mem-entry" data-key="{{ mem.get('key','') }}" title="{{ mem.get('value','') }}">
                                <div class="mc-mem-key">{{ mem.get('key','') }}</div>
                                <div class="mc-mem-val">{{ mem.get('value','')[:200] }}{% if mem.get('value','')|length > 200 %}...{% endif %}</div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="mc-mem-empty">Aucun contexte ‚Äî les agents alimenteront cette base au fil des phases</div>
                {% endif %}
            </div>
            <button class="mc-mem-add" onclick="addMemoryEntry()">+ Ajouter une entree</button>
        </div>

        <!-- SI Blueprint -->
        {% if si_blueprint %}
        <div class="mc-side-section">
            <div class="mc-side-title">
                <svg class="icon icon-xs"><use href="#icon-server"/></svg> SI Blueprint
            </div>
            {% if si_blueprint.cloud %}
            <div class="mc-si-item"><span class="mc-si-label">Cloud</span><span class="mc-si-value">{{ si_blueprint.cloud.provider | default('?') }} / {{ si_blueprint.cloud.region | default('') }}</span></div>
            {% endif %}
            {% if si_blueprint.compute %}
            <div class="mc-si-item"><span class="mc-si-label">Compute</span><span class="mc-si-value">{{ si_blueprint.compute.type | default('?') }} ({{ si_blueprint.compute.size | default('') }})</span></div>
            {% endif %}
            {% if si_blueprint.cicd %}
            <div class="mc-si-item"><span class="mc-si-label">CI/CD</span><span class="mc-si-value">{{ si_blueprint.cicd.provider | default('?') }}</span></div>
            {% endif %}
            {% if si_blueprint.databases %}
            <div class="mc-si-item"><span class="mc-si-label">DBs</span><span class="mc-si-value">{{ si_blueprint.databases | map(attribute='type') | join(', ') }}</span></div>
            {% endif %}
            {% if si_blueprint.existing_services %}
            <div style="margin-top:0.2rem">
                {% for svc in si_blueprint.existing_services[:5] %}
                <div class="mc-si-svc">{{ svc.name }} ‚Äî {{ svc.proto | default('') }} ({{ svc.tech | default('') | truncate(30) }})</div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Lessons from past epics -->
        {% if lessons %}
        <div class="mc-side-section">
            <div class="mc-side-title">
                <svg class="icon icon-xs"><use href="#icon-zap"/></svg> Lessons ({{ lessons|length }})
            </div>
            {% for l in lessons[:8] %}
            <div class="mc-lesson">
                <div class="mc-lesson-cat">{{ l.category | default('lesson') }}</div>
                {{ l.value | default(l.get('key', '')) | truncate(120) }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Features / Deliverables -->
        {% if features %}
        <div class="mc-side-section">
            <div class="mc-side-title">
                <svg class="icon icon-xs"><use href="#icon-check-circle"/></svg> Livrables ({{ features|length }})
            </div>
            {% for f in features[:15] %}
            <div style="display:flex;align-items:flex-start;gap:0.4rem;padding:0.2rem 0;font-size:0.72rem">
                <span style="color:var(--green);flex-shrink:0;margin-top:1px">&#9679;</span>
                <span style="color:var(--text-secondary)">{{ f[:80] }}{% if f|length > 80 %}‚Ä¶{% endif %}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Git + PRs -->
        <div class="mc-side-section">
            <div class="mc-side-title">
                <svg class="icon icon-xs"><use href="#icon-git-branch"/></svg> Git & PRs
            </div>
            <div id="mc-prs">
                {% if pull_requests %}
                    {% for pr in pull_requests %}
                    <div class="mc-pr">
                        <span class="mc-pr-icon {{ pr.status|lower }}"><svg class="icon icon-xs"><use href="#icon-git-pull-request"/></svg></span>
                        <span class="mc-pr-title" title="{{ pr.title }}">#{{ pr.number }} {{ pr.title[:30] }}{% if pr.title|length > 30 %}‚Ä¶{% endif %}</span>
                        <span class="mc-pr-status {{ pr.status|lower }}">{{ pr.status }}</span>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="mc-pr-empty">Aucune PR detectee</div>
                {% endif %}
            </div>
            <div id="mc-commits">
                {% if workspace_commits %}
                    {% for c in workspace_commits[:15] %}
                    <div class="mc-commit">
                        <code class="mc-commit-hash">{{ c.hash[:7] }}</code>
                        <span class="mc-commit-msg">{{ c.message[:60] }}{% if c.message|length > 60 %}‚Ä¶{% endif %}</span>
                    </div>
                    {% endfor %}
                {% else %}
                <div style="font-size:0.7rem;color:var(--text-secondary);font-style:italic;padding:0.3rem 0">Aucun commit detecte</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Agent Popover -->
<div class="mc-popover-overlay" id="mcPopoverOverlay" onclick="closeMcPopover()"></div>
<div class="mc-popover" id="mcPopover">
    <button class="mc-popover-close" onclick="closeMcPopover()">‚úï</button>
    <div class="mc-popover-header" id="mcPopHeader"></div>
    <div class="mc-popover-body" id="mcPopBody"></div>
</div>

<!-- CDP Chat Modal -->
<div class="mc-chat-overlay" id="mcChatOverlay" onclick="if(event.target===this)closeCdpChat()">
    <div class="mc-chat-modal">
        <div class="mc-chat-head">
            <img class="mc-chat-head-avatar" src="{{ cdp['avatar_url'] if cdp else '/static/avatars/chef_de_programme.jpg' }}" alt=""
                 onerror="this.src='/static/avatars/chef_de_programme.jpg'">
            <div class="mc-chat-head-info">
                <h3>{{ cdp['name'] if cdp else 'Chef de Programme' }}</h3>
                <small>{{ cdp['role'] if cdp else 'Chef de Programme' }} &mdash; {{ mission.brief[:60] }}{% if mission.brief|length > 60 %}...{% endif %}</small>
            </div>
            <button class="mc-chat-close" onclick="closeCdpChat()">‚úï</button>
        </div>
        <div class="mc-chat-msgs" id="mcChatMsgs">
            <div class="mc-chat-msg system">
                <div class="mc-chat-bubble">Discutez avec le CDP. Il peut chercher dans le code, les conversations des agents, le git, la memoire, les PRs et les features.</div>
            </div>
        </div>
        <div class="mc-chat-input-row">
            <textarea class="mc-chat-input" id="mcChatInput" placeholder="Posez une question au CDP..." rows="1"
                      onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendCdpMessage()}"></textarea>
            <button class="mc-chat-send" id="mcChatSend" onclick="sendCdpMessage()">Envoyer</button>
        </div>
    </div>
</div>

<script>
const MISSION_ID = "{{ mission.id }}";
const SESSION_ID = "{{ session_id }}";
const PHASE_AGENTS = {{ phase_agents | tojson }};
const PHASE_GRAPHS = {{ phase_graphs | tojson }};

/* ‚îÄ‚îÄ Tab switching ‚îÄ‚îÄ */
function switchTab(tab) {
    document.querySelectorAll('.mc-tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
    document.querySelectorAll('.mc-tab-panel').forEach(p => p.style.display = p.dataset.tab === tab ? '' : 'none');
    // Ensure selected tab is visible (block display)
    const active = document.querySelector(`.mc-tab-panel[data-tab="${tab}"]`);
    if (active) active.style.display = 'block';
}

/* ‚îÄ‚îÄ Execute command in workspace ‚îÄ‚îÄ */
document.querySelectorAll('.mc-exec-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
        // Extract raw command (strip emoji prefix)
        const rawCmd = this.dataset.cmd;
        const term = document.getElementById('mc-terminal');
        const termCmd = document.getElementById('mc-terminal-cmd');
        const termStatus = document.getElementById('mc-terminal-status');
        const termOut = document.getElementById('mc-terminal-output');

        // Show terminal
        term.style.display = 'block';
        termCmd.textContent = '$ ' + rawCmd;
        termStatus.textContent = '‚è≥ Running...';
        termStatus.style.color = 'var(--purple-light)';
        termOut.textContent = '';

        // Highlight active button
        document.querySelectorAll('.mc-exec-btn').forEach(b => b.style.opacity = '0.5');
        this.style.opacity = '1';

        try {
            const resp = await fetch(`/api/missions/${MISSION_ID}/exec`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({command: rawCmd})
            });
            const data = await resp.json();
            if (resp.ok) {
                const output = (data.stdout || '') + (data.stderr ? '\n' + data.stderr : '');
                termOut.textContent = output || '(no output)';
                if (data.returncode === 0) {
                    termStatus.textContent = '‚úÖ Success (exit 0)';
                    termStatus.style.color = 'var(--green)';
                } else {
                    termStatus.textContent = `‚ùå Failed (exit ${data.returncode})`;
                    termStatus.style.color = '#f85149';
                }
            } else {
                termOut.textContent = data.error || 'Error';
                termStatus.textContent = '‚ùå Error';
                termStatus.style.color = '#f85149';
            }
        } catch (e) {
            termOut.textContent = e.message;
            termStatus.textContent = '‚ùå Network error';
            termStatus.style.color = '#f85149';
        }
        document.querySelectorAll('.mc-exec-btn').forEach(b => b.style.opacity = '1');
        // Auto-scroll terminal
        term.scrollTop = term.scrollHeight;
    });
});

/* ‚îÄ‚îÄ Agent name lookup (from phase_agents data) ‚îÄ‚îÄ */
const AGENT_INFO = {};
const AGENT_PHASE = {};  // agent_id ‚Üí phase_id (for routing SSE events)
for (const [pid, agents] of Object.entries(PHASE_AGENTS)) {
    for (const a of agents) {
        if (a.id && !AGENT_INFO[a.id]) {
            AGENT_INFO[a.id] = {
                name: a.name || a.id,
                role: a.role || '',
                avatar: a.avatar_url || `/static/avatars/${a.id}.jpg`,
                color: a.color || '#8b949e',
                tagline: a.tagline || '',
                persona: a.persona || '',
                motivation: a.motivation || '',
                skills: a.skills || [],
                tools: a.tools || [],
                model: a.model || '',
                provider: a.provider || '',
            };
        }
        if (a.id) AGENT_PHASE[a.id] = pid;
    }
}

/* ‚îÄ‚îÄ CDP Chat Modal ‚îÄ‚îÄ */
const CDP_AVATAR = '{{ cdp["avatar_url"] if cdp else "/static/avatars/chef_de_programme.jpg" }}' || '/static/avatars/chef_de_programme.jpg';
const CDP_NAME = '{{ cdp["name"] if cdp else "Chef de Programme" }}';
const CDP_ROLE = '{{ cdp["role"] if cdp else "Chef de Programme" }}';

function miniMarkdown(s) {
    if (!s) return '';
    let h = s
        .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
        .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        .replace(/^### (.+)$/gm, '<h3>$1</h3>')
        .replace(/^## (.+)$/gm, '<h2>$1</h2>')
        .replace(/^# (.+)$/gm, '<h1>$1</h1>')
        .replace(/^\- (.+)$/gm, '<li>$1</li>')
        .replace(/^\d+\. (.+)$/gm, '<li>$1</li>')
        .replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>')
        .replace(/<\/ul>\s*<ul>/g, '')
        .replace(/\n/g, '<br>');
    return h;
}
function openCdpChat() {
    document.getElementById('mcChatOverlay').classList.add('open');
    document.getElementById('mcChatInput').focus();
}
function closeCdpChat() {
    document.getElementById('mcChatOverlay').classList.remove('open');
}

function _chatTime() {
    const d = new Date();
    return d.getHours().toString().padStart(2,'0') + ':' + d.getMinutes().toString().padStart(2,'0');
}

function _addChatMsg(type, content, opts = {}) {
    const msgs = document.getElementById('mcChatMsgs');
    const wrapper = document.createElement('div');
    wrapper.className = `mc-chat-msg ${type}`;

    if (type === 'agent') {
        const av = document.createElement('img');
        av.className = 'mc-chat-msg-avatar';
        av.src = CDP_AVATAR;
        av.onerror = function(){ this.src = '/static/avatars/chef_de_programme.jpg'; };
        wrapper.appendChild(av);
    } else if (type === 'user') {
        const av = document.createElement('div');
        av.className = 'mc-chat-msg-avatar user-av';
        av.textContent = 'S';
        wrapper.appendChild(av);
    }

    const bubble = document.createElement('div');
    bubble.className = 'mc-chat-bubble';

    if (type === 'agent') {
        const sender = document.createElement('div');
        sender.className = 'mu__sender';
        sender.innerHTML = `<span class="mu__name">${CDP_NAME}</span><span class="mu__role">${CDP_ROLE}</span>`;
        bubble.appendChild(sender);
    }

    const contentDiv = document.createElement('div');
    contentDiv.className = 'mu__content';
    if (opts.isMarkdown) {
        contentDiv.classList.add('md-rendered');
        contentDiv.innerHTML = content;
    } else {
        contentDiv.textContent = content;
    }
    bubble.appendChild(contentDiv);

    if (type !== 'system') {
        const footer = document.createElement('div');
        footer.className = 'mu__footer';
        footer.innerHTML = `<span class="mu__time">${_chatTime()}</span>`;
        bubble.appendChild(footer);
    }

    wrapper.appendChild(bubble);
    msgs.appendChild(wrapper);
    msgs.scrollTop = msgs.scrollHeight;
    return { wrapper, bubble, contentDiv };
}

let _cdpChatBusy = false;
async function sendCdpMessage() {
    if (_cdpChatBusy) return;
    const input = document.getElementById('mcChatInput');
    const content = input.value.trim();
    if (!content) return;
    input.value = '';
    input.style.height = 'auto';
    _cdpChatBusy = true;
    document.getElementById('mcChatSend').disabled = true;
    const msgs = document.getElementById('mcChatMsgs');

    // User bubble
    _addChatMsg('user', content);

    // Thinking indicator with animated dots
    const think = document.createElement('div');
    think.className = 'mc-chat-thinking';
    think.innerHTML = `<span class="mc-chat-thinking-text">Analyse en cours</span><span class="mc-chat-dots"><span></span><span></span><span></span></span>`;
    msgs.appendChild(think);
    msgs.scrollTop = msgs.scrollHeight;

    try {
        const fd = new FormData();
        fd.append('content', content);
        fd.append('session_id', SESSION_ID);
        const resp = await fetch(`/api/missions/${MISSION_ID}/chat/stream`, {method:'POST', body:fd});
        if (!resp.ok) throw new Error(resp.statusText);

        const reader = resp.body.getReader();
        const decoder = new TextDecoder();
        let accumulated = '';
        let buf = '';
        let agentMsg = null; // { wrapper, bubble, contentDiv }
        let toolsDiv = null;
        let evtType = null;

        while (true) {
            const {done, value} = await reader.read();
            if (done) break;
            buf += decoder.decode(value, {stream: true});
            const lines = buf.split('\n');
            buf = lines.pop() || '';
            for (const line of lines) {
                if (line.startsWith('event: ')) {
                    evtType = line.slice(7).trim();
                } else if (line.startsWith('data: ') && evtType) {
                    try {
                        const d = JSON.parse(line.slice(6));
                        if (evtType === 'status') {
                            const txt = think.querySelector('.mc-chat-thinking-text');
                            if (txt) txt.textContent = d.label || 'Analyse';
                        } else if (evtType === 'chunk') {
                            // First chunk: replace thinking with agent bubble
                            if (!agentMsg) {
                                think.remove();
                                agentMsg = _addChatMsg('agent', '', { isMarkdown: true });
                                agentMsg.bubble.classList.add('streaming');
                                agentMsg.contentDiv.classList.add('mu--streaming');
                            }
                            accumulated += d.text || '';
                            agentMsg.contentDiv.innerHTML = miniMarkdown(accumulated);
                            agentMsg.contentDiv.classList.add('mu--streaming');
                            msgs.scrollTop = msgs.scrollHeight;
                        } else if (evtType === 'tool') {
                            // Show tool being used
                            if (agentMsg) {
                                if (!toolsDiv) {
                                    toolsDiv = document.createElement('div');
                                    toolsDiv.className = 'mc-chat-tools';
                                    agentMsg.bubble.insertBefore(toolsDiv, agentMsg.bubble.querySelector('.mu__footer'));
                                }
                                toolsDiv.innerHTML += `<span class="mc-chat-tool-pill">${d.label||d.name||''}</span>`;
                            } else {
                                const txt = think.querySelector('.mc-chat-thinking-text');
                                if (txt) txt.textContent = d.label || d.name || 'Outil';
                            }
                        } else if (evtType === 'done') {
                            if (!agentMsg) {
                                think.remove();
                                agentMsg = _addChatMsg('agent', d.html || miniMarkdown(accumulated), { isMarkdown: true });
                            } else {
                                agentMsg.contentDiv.innerHTML = d.html || miniMarkdown(accumulated);
                                agentMsg.contentDiv.classList.remove('mu--streaming');
                                agentMsg.bubble.classList.remove('streaming');
                            }
                        } else if (evtType === 'error') {
                            if (document.contains(think)) think.remove();
                            if (agentMsg) {
                                agentMsg.contentDiv.innerHTML = `<span style="color:var(--red)">${d.message||'Erreur'}</span>`;
                                agentMsg.contentDiv.classList.remove('mu--streaming');
                                agentMsg.bubble.classList.remove('streaming');
                            } else {
                                _addChatMsg('system', d.message || 'Erreur');
                            }
                        }
                    } catch(e){}
                    evtType = null;
                }
            }
        }
        // End of stream: remove streaming classes
        if (agentMsg) {
            agentMsg.contentDiv.classList.remove('mu--streaming');
            agentMsg.bubble.classList.remove('streaming');
            if (!agentMsg.contentDiv.innerHTML.trim()) {
                agentMsg.contentDiv.innerHTML = miniMarkdown(accumulated) || '<span style="color:var(--text-secondary);font-style:italic">Pas de reponse</span>';
            }
        }
        // If we never got a chunk (e.g., empty response)
        if (!agentMsg && think.parentNode) {
            think.remove();
            _addChatMsg('system', 'Pas de reponse');
        }
        msgs.scrollTop = msgs.scrollHeight;
    } catch(err) {
        if (document.contains(think)) think.remove();
        const msg = (err.message || '').toLowerCase().includes('network') || (err.message || '').toLowerCase().includes('fetch')
            ? 'Le serveur ne repond pas. Verifiez qu\'il est en cours d\'execution.'
            : err.message || 'Erreur inconnue';
        _addChatMsg('system', msg);
    }
    _cdpChatBusy = false;
    document.getElementById('mcChatSend').disabled = false;
}
// Auto-resize textarea
document.getElementById('mcChatInput')?.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});

/* ‚îÄ‚îÄ Render session_live style flow graphs per phase ‚îÄ‚îÄ */
const MC_NW = 200, MC_NH = 80;
const MC_PATTERN_STYLES = {
    sequential:   {color:'#3b82f6', dash:'',        icon:'‚Üí'},
    hierarchical: {color:'#f59e0b', dash:'',        icon:'‚¨°'},
    parallel:     {color:'#10b981', dash:'6 3',     icon:'‚áâ'},
    loop:         {color:'#ec4899', dash:'4 4',     icon:'‚Üª'},
    network:      {color:'#8b5cf6', dash:'2 4 8 4', icon:'‚¨°'},
    router:       {color:'#f97316', dash:'',        icon:'‚¨¢'},
    aggregator:   {color:'#06b6d4', dash:'3 3',     icon:'‚óà'},
    'human-in-the-loop': {color:'#eab308', dash:'6 2', icon:'H'},
};
/* Edge color ‚Üí dash style mapping (multi-pattern edges) */
const MC_EDGE_DASHES = {
    '#f59e0b': '',          // hierarchical: solid
    '#8b5cf6': '2 4 8 4',  // network discussion: dot-dash
    '#3b82f6': '',          // sequential: solid
    '#ec4899': '4 4',       // loop/feedback: dashed
    '#10b981': '6 3',       // parallel: long dash
    '#ef4444': '2 2',       // gate/veto: dotted
    '#06b6d4': '3 3',       // aggregation: short dash
    '#f97316': '8 3',       // routing: long dash
};
/* Edge color ‚Üí legend label */
const MC_EDGE_LABELS = {
    '#f59e0b': '‚¨° d√©l√©gation',
    '#8b5cf6': '‚¨° discussion',
    '#3b82f6': '‚Üí s√©quence',
    '#ec4899': '‚Üª feedback',
    '#10b981': '‚áâ parall√®le',
    '#ef4444': '‚äò gate/veto',
    '#06b6d4': '‚óà agr√©gation',
    '#f97316': '‚¨¢ routage',
};

function renderPhaseGraphs() {
    for (const [phaseId, graph] of Object.entries(PHASE_GRAPHS)) {
        const container = document.getElementById(`graph-${phaseId}`);
        if (!container || !graph.nodes.length) continue;
        const nodes = graph.nodes.map(n => ({...n}));
        const edges = graph.edges || [];
        const N = nodes.length;

        // Get phase pattern
        const phaseEl = container.closest('.mc-phase');
        const patternId = phaseEl ? (phaseEl.querySelector('.mc-phase-pattern')?.textContent || '') : '';
        const pStyle = MC_PATTERN_STYLES[patternId.trim()] || MC_PATTERN_STYLES['sequential'];

        // Auto-layout: organize by hierarchy_rank
        const sorted = nodes.slice().sort((a,b)=> (a.hierarchy_rank||50) - (b.hierarchy_rank||50));
        const layerMap = new Map();
        sorted.forEach(n => {
            const rank = n.hierarchy_rank || 50;
            if(!layerMap.has(rank)) layerMap.set(rank, []);
            layerMap.get(rank).push(n);
        });
        const layers = [...layerMap.values()];
        // More gap when many bidirectional edges (multi-pattern)
        const hasBidi = edges.some(e => edges.some(r => r.from===e.to && r.to===e.from));
        const layerGap = hasBidi ? Math.max(MC_NH + 50, 130) : Math.max(MC_NH + 30, 110);
        const maxCols = Math.max(...layers.map(l=>l.length));
        const W = Math.max(maxCols * (MC_NW + 40) + 60, 500);
        const H = layers.length * layerGap + 40;

        layers.forEach((layer, li) => {
            const y = 20 + li * layerGap;
            const gap = Math.min(MC_NW + 50, (W - 40) / (layer.length || 1));
            const startX = Math.max(10, (W - gap*(layer.length-1) - MC_NW) / 2);
            layer.forEach((n, i) => { n.x = startX + i * gap; n.y = y; });
        });

        const nodeById = {};
        nodes.forEach(n => { nodeById[n.id] = n; });

        container.style.minHeight = '0';
        let svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${W} ${H}" style="max-height:${Math.min(H, 600)}px">`;

        // Generate per-color arrow markers
        const edgeColors = new Set(edges.map(e => e.color || pStyle.color));
        edgeColors.forEach(c => {
            const id = c.replace('#','');
            svg += `<defs><marker id="mc-arrow-${id}" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse"><path d="M0,0 L10,5 L0,10 Z" fill="${c}"/></marker></defs>`;
        });

        // Edges with bezier curves
        edges.forEach(e => {
            const fn = nodeById[e.from], tn = nodeById[e.to];
            if (!fn || !tn) return;
            const eColor = e.color || pStyle.color;
            const eDash = MC_EDGE_DASHES[eColor] || '';
            const hasReverse = edges.some(re => re.from===e.to && re.to===e.from);
            const offset = hasReverse ? 10 : 0;
            let x1f, y1f, x2f, y2f, d;
            const dy = tn.y - fn.y, dx = tn.x - fn.x;

            if(Math.abs(dy) < MC_NH * 0.8){
                if(dx > 0){
                    x1f = fn.x + MC_NW; y1f = fn.y + MC_NH/2 - offset;
                    x2f = tn.x;          y2f = tn.y + MC_NH/2 + offset;
                } else {
                    x1f = fn.x;          y1f = fn.y + MC_NH/2 - offset;
                    x2f = tn.x + MC_NW;  y2f = tn.y + MC_NH/2 + offset;
                }
                const midY = Math.min(y1f, y2f) - 30;
                d = `M${x1f},${y1f} C${x1f},${midY} ${x2f},${midY} ${x2f},${y2f}`;
            } else if(dy > 0){
                x1f = fn.x + MC_NW/2 + offset; y1f = fn.y + MC_NH;
                x2f = tn.x + MC_NW/2 - offset; y2f = tn.y;
                const co = Math.max(25, Math.abs(y2f-y1f)*0.3);
                d = `M${x1f},${y1f} C${x1f},${y1f+co} ${x2f},${y2f-co} ${x2f},${y2f}`;
            } else {
                x1f = fn.x + MC_NW/2 - offset; y1f = fn.y;
                x2f = tn.x + MC_NW/2 + offset; y2f = tn.y + MC_NH;
                const co = Math.max(25, Math.abs(y2f-y1f)*0.3);
                d = `M${x1f},${y1f} C${x1f},${y1f-co} ${x2f},${y2f+co} ${x2f},${y2f}`;
            }
            svg += `<path d="${d}" class="mc-edge-line" style="stroke:${eColor};marker-end:url(#mc-arrow-${eColor.replace('#','')})${eDash?`;stroke-dasharray:${eDash}`:''}"/>`;
            if (e.label) {
                const mx = (x1f+x2f)/2, my = (y1f+y2f)/2 - 5;
                svg += `<text x="${mx}" y="${my}" class="mc-edge-count" style="fill:${eColor}">${esc(e.label)}</text>`;
            }
        });

        // Nodes as full cards
        nodes.forEach(n => {
            const aid = n.agent_id || n.id;
            const info = AGENT_INFO[aid] || {};
            const col = pStyle.color;
            const name = info.name || n.label || n.id;
            const role = info.role || n.role || '';
            const avatar = info.avatar || n.avatar || '';
            const status = 'idle';
            const avatarR = 16, avatarCx = 24, avatarCy = 30;
            const textX = avatarCx + avatarR + 10;

            const avatarSvg = avatar
                ? `<clipPath id="mcclip-${phaseId}-${n.id}"><circle cx="${avatarCx}" cy="${avatarCy}" r="${avatarR}"/></clipPath>
                   <image href="${esc(avatar)}" x="${avatarCx-avatarR}" y="${avatarCy-avatarR}" width="${avatarR*2}" height="${avatarR*2}" clip-path="url(#mcclip-${phaseId}-${n.id})" preserveAspectRatio="xMidYMid slice"/>`
                : `<circle cx="${avatarCx}" cy="${avatarCy}" r="${avatarR}" fill="${col}" opacity="0.25"/>
                   <text x="${avatarCx}" y="${avatarCy+4}" text-anchor="middle" style="font-size:13px;fill:${col};font-weight:700">${esc(name.substring(0,2))}</text>`;

            svg += `<g class="mc-live-node" data-agent-id="${esc(n.agent_id||n.id)}" transform="translate(${n.x},${n.y})" style="cursor:pointer">`;
            svg += `<rect class="mc-live-node-bg" width="${MC_NW}" height="${MC_NH}"/>`;
            svg += `<line class="mc-live-node-bar" x1="0" y1="0" x2="${MC_NW}" y2="0" stroke="${col}" stroke-width="3"/>`;
            svg += avatarSvg;
            svg += `<text class="mc-live-node-name" x="${textX}" y="24">${esc(name.length>20?name.substring(0,19)+'‚Ä¶':name)}</text>`;
            svg += `<text class="mc-live-node-role" x="${textX}" y="36">${esc(role.length>25?role.substring(0,24)+'‚Ä¶':role)}</text>`;
            svg += `<circle class="mc-node-status--${status}" cx="${MC_NW-14}" cy="16" r="5"/>`;
            svg += `<text class="mc-live-node-status" x="${MC_NW-14}" y="30">${status}</text>`;
            svg += `</g>`;
        });

        // Legend ‚Äî show all unique edge interaction types
        let legendX = 8;
        svg += `<g transform="translate(0,${H-18})">`;
        edgeColors.forEach(c => {
            const lbl = MC_EDGE_LABELS[c] || c;
            const dash = MC_EDGE_DASHES[c] || '';
            svg += `<line x1="${legendX}" y1="5" x2="${legendX+14}" y2="5" stroke="${c}" stroke-width="2"${dash?` stroke-dasharray="${dash}"`:''}/>`; 
            svg += `<text x="${legendX+18}" y="9" style="font-size:8px;fill:${c}">${esc(lbl)}</text>`;
            legendX += lbl.length * 5 + 30;
        });
        svg += `</g>`;

        svg += `</svg>`;
        container.innerHTML = svg;
    }
}

/* ‚îÄ‚îÄ Git contribution graph cells ‚îÄ‚îÄ */
(function(){
    const g = document.getElementById('mc-git-graph');
    if (!g) return;
    for(let i=0;i<56;i++){
        const c = document.createElement('div');
        c.className = 'mc-git-cell';
        g.appendChild(c);
    }
})();

/* ‚îÄ‚îÄ Accordion toggle ‚îÄ‚îÄ */
function togglePhase(header) {
    const phase = header.closest('.mc-phase');
    phase.classList.toggle('open');
}

/* ‚îÄ‚îÄ SSE ‚îÄ‚îÄ */
if (SESSION_ID) {
    const es = new EventSource(`/sse/session/${SESSION_ID}`);
    es.onmessage = e => { try { handleSSE(JSON.parse(e.data)); } catch(err){} };
}

function handleSSE(d) {
    if (d.type === 'phase_started') {
        updatePhaseStatus(d.phase_id, 'running');
        openPhase(d.phase_id);
        addActivity(`Phase ¬´${d.phase_name}¬ª d√©marr√©e (${d.pattern})`, 'tool');
    }
    else if (d.type === 'phase_completed') {
        updatePhaseStatus(d.phase_id, d.success ? 'done' : 'failed');
        addActivity(`${d.success ? '‚úì' : '‚úó'} Phase termin√©e`, 'tool');
        updateStats();
        generatePhaseSummary(d.phase_id);
    }
    else if (d.type === 'phase_failed') {
        updatePhaseStatus(d.phase_id, 'failed');
        addActivity('Phase √©chou√©e', 'system');
    }
    else if (d.type === 'mission_failed') {
        addActivity('Epic arr√™t√©e ‚Äî phase √©chou√©e', 'system');
        // Disable run button, show reset
        const runBtn = document.querySelector('.mc-run-btn');
        if (runBtn) { runBtn.disabled = true; runBtn.textContent = 'Epic √©chou√©e'; }
    }
    else if (d.type === 'checkpoint') {
        updatePhaseStatus(d.phase_id, 'waiting_validation');
        openPhase(d.phase_id);
        showCheckpoint(d.phase_id, d.question);
        addActivity(`CHECKPOINT: ${d.question}`, 'system');
    }
    else if (d.type === 'message') {
        if (d.from_agent === 'chef_de_programme') addActivity(d.content, '');
        const phaseId = d.phase_id || currentRunningPhase();
        if (phaseId) addDiscussionMsg(phaseId, d);
        if (d.msg_type === 'tool_result') addActivity(d.content?.substring(0, 200), 'tool');
    }
    else if (d.type === 'stream_start') {
        const phaseId = d.phase_id || currentRunningPhase();
        if (phaseId) {
            const container = document.getElementById(`discuss-${phaseId}`);
            if (container) {
                container.querySelector('.mc-discuss-empty')?.remove();
                container.querySelector(`.mc-stream-bubble[data-agent="${d.agent_id}"]`)?.remove();
                const info = AGENT_INFO[d.agent_id] || {};
                const color = info.color || 'var(--purple)';
                const avatar = info.avatar || `/static/avatars/${d.agent_id}.jpg`;
                const name = d.agent_name || info.name || d.agent_id;
                const role = info.role || '';
                const patternType = d.pattern_type || '';
                const toAgent = d.to_agent || 'all';
                let targetHtml = '';
                if (toAgent === 'all' || toAgent === 'session') {
                    targetHtml = '<span class="mu__arrow">‚Üí</span><span class="mu__target">√âquipe</span>';
                } else {
                    const targets = toAgent.split(',').map(t => t.trim()).filter(Boolean);
                    const parts = targets.map(t => {
                        const ti = AGENT_INFO[t];
                        return ti ? `<span class="mu__target" style="color:${ti.color||'var(--text-secondary)'}">@${esc(ti.name)}</span>` : `<span class="mu__target">@${esc(t)}</span>`;
                    });
                    if (parts.length) targetHtml = '<span class="mu__arrow">‚Üí</span>' + parts.join(' ');
                }

                const div = document.createElement('div');
                div.className = 'mu mu--chat mu--agent mc-stream-bubble';
                div.dataset.agent = d.agent_id;
                div.innerHTML = `
                    <div class="mu__avatar" style="background:${color}20;border-color:${color}">
                        <img src="${avatar}" alt="${esc(name)}" style="width:100%;height:100%;border-radius:50%;object-fit:cover" onerror="this.outerHTML='${esc(name.substring(0,2))}'">
                    </div>
                    <div class="mu__bubble mu__bubble--agent mc-streaming">
                        <div class="mu__sender">
                            <span class="mu__name" style="color:${color}">${esc(name)}</span>
                            ${role ? `<span class="mu__role">${esc(role)}</span>` : ''}
                            ${patternType ? `<span class="mu__pattern">(${esc(patternType)})</span>` : ''}
                            ${targetHtml}
                            <span class="mc-thinking-badge">r√©fl√©chit‚Ä¶</span>
                        </div>
                        <div class="mu__content"><span class="mc-stream-content"></span><span class="mc-typing-cursor">‚ñä</span></div>
                    </div>`;
                container.appendChild(div);
                container.scrollTop = container.scrollHeight;
            }
        }
        const info = AGENT_INFO[d.agent_id] || {};
        addActivity(`${d.agent_name || info.name || d.agent_id} r√©fl√©chit‚Ä¶`, 'tool');
    }
    else if (d.type === 'stream_delta') {
        // Streaming text chunk from agent
        const phaseId = d.phase_id || currentRunningPhase();
        if (phaseId) {
            const container = document.getElementById(`discuss-${phaseId}`);
            if (container) {
                const bubble = container.querySelector(`.mc-stream-bubble[data-agent="${d.agent_id}"] .mc-stream-content`);
                if (bubble) {
                    bubble.textContent += d.delta;
                    container.scrollTop = container.scrollHeight;
                    // Update thinking badge to "parle‚Ä¶"
                    const badge = container.querySelector(`.mc-stream-bubble[data-agent="${d.agent_id}"] .mc-thinking-badge`);
                    if (badge && badge.textContent === 'r√©fl√©chit‚Ä¶') badge.textContent = 'parle‚Ä¶';
                }
            }
        }
    }
    else if (d.type === 'stream_end') {
        // Streaming finished ‚Äî remove bubble, final message will arrive via 'message' event
        const phaseId = d.phase_id || currentRunningPhase();
        if (phaseId) {
            const container = document.getElementById(`discuss-${phaseId}`);
            if (container) {
                container.querySelector(`.mc-stream-bubble[data-agent="${d.agent_id}"]`)?.remove();
            }
        }
    }
    else if (d.type === 'stream_thinking') {
        // Agent is in <think> mode ‚Äî pulse the indicator
        const phaseId = d.phase_id || currentRunningPhase();
        if (phaseId) {
            const container = document.getElementById(`discuss-${phaseId}`);
            if (container) {
                const badge = container.querySelector(`.mc-stream-bubble[data-agent="${d.agent_id}"] .mc-thinking-badge`);
                if (badge) badge.textContent = 'r√©fl√©chit‚Ä¶';
            }
        }
    }
    else if (d.type === 'agent_status') {
        const phaseId = d.phase_id || currentRunningPhase();
        if (d.status === 'thinking') {
            addActivity(`${d.agent_id} analyse‚Ä¶`, 'tool');
        }
    }
    else if (d.type === 'adversarial') {
        const icon = d.passed ? '‚úì' : '‚úó';
        const cls = d.passed ? 'pass' : 'fail';
        const label = d.passed ? 'APPROVED' : `REJECTED (${d.score}/10)`;
        const name = d.agent_name || d.agent_id;
        addActivity(`${icon} Guard ${d.level}: ${name} ‚Äî ${label}`, d.passed ? 'info' : 'alert');
        // Append guard badge to the agent's last message bubble
        const phaseId = d.phase_id || currentRunningPhase();
        if (phaseId && !d.passed) {
            const container = document.getElementById(`discuss-${phaseId}`);
            if (container) {
                const bubbles = container.querySelectorAll(`.mc-msg`);
                const lastBubble = bubbles[bubbles.length - 1];
                if (lastBubble) {
                    const detail = document.createElement('div');
                    detail.className = 'mc-guard-detail show';
                    detail.innerHTML = `<span class="mc-guard fail">${icon} ${label}</span> ` +
                        (d.issues || []).map(i => `<br>‚Ä¢ ${i}`).join('');
                    lastBubble.appendChild(detail);
                }
            }
        }
    }
    else if (d.type === 'agent_message' || d.type === 'agent_response') {
        const phaseId = d.phase_id || currentRunningPhase();
        if (phaseId) {
            // Remove streaming bubble for this agent ‚Äî replace with final message
            const container = document.getElementById(`discuss-${phaseId}`);
            if (container) {
                container.querySelector(`.mc-stream-bubble[data-agent="${d.from_agent||d.agent_id}"]`)?.remove();
            }
            addDiscussionMsg(phaseId, d);
        }
    }
    else if (d.type === 'pattern_start') {
        addActivity(`Pattern ¬´${d.pattern_name}¬ª lanc√©`, 'tool');
    }
    else if (d.type === 'pattern_end') {
        addActivity(`${d.success ? '‚úì' : '‚úó'} Pattern termin√©${d.error ? ': '+d.error : ''}`, d.success ? 'tool' : 'system');
    }
    if (d.type === 'commit') addCommit(d);
    if (d.type === 'memory_stored') addMemory(d);
    if (d.type === 'pr' || d.type === 'pull_request') addPR(d);
}

function currentRunningPhase() {
    const el = document.querySelector('.mc-phase[data-status="running"]');
    return el ? el.dataset.phaseId : null;
}

function openPhase(phaseId) {
    document.querySelector(`.mc-phase[data-phase-id="${phaseId}"]`)?.classList.add('open');
}

function updatePhaseStatus(phaseId, status) {
    const el = document.querySelector(`.mc-phase[data-phase-id="${phaseId}"]`);
    if (!el) return;
    el.dataset.status = status;
    const badge = el.querySelector('.mc-phase-status-badge');
    if (badge) { badge.className = `mc-phase-status-badge ${status}`; badge.textContent = status; }
}

function addDiscussionMsg(phaseId, d) {
    const container = document.getElementById(`discuss-${phaseId}`);
    if (!container) return;
    container.querySelector('.mc-discuss-empty')?.remove();
    const aid = d.from_agent || d.agent_id || '';
    container.querySelector(`.mc-stream-bubble[data-agent="${aid}"]`)?.remove();

    const info = AGENT_INFO[aid] || {};
    const color = info.color || 'var(--purple)';
    const avatar = d.from_avatar || info.avatar || `/static/avatars/${aid}.jpg`;
    const name = d.from_name || info.name || aid || '?';
    const role = d.from_role || info.role || '';
    const patternType = d.pattern_type || '';
    const toAgent = d.to_agent || '';

    // Build target(s) ‚Äî can be "all", single agent, or comma-separated
    let targetHtml = '';
    if (toAgent === 'all' || toAgent === 'session') {
        targetHtml = '<span class="mu__arrow">‚Üí</span><span class="mu__target">√âquipe</span>';
    } else if (toAgent) {
        const targets = toAgent.split(',').map(t => t.trim()).filter(Boolean);
        const parts = targets.map(t => {
            const ti = AGENT_INFO[t];
            return ti ? `<span class="mu__target" style="color:${ti.color||'var(--text-secondary)'}">@${esc(ti.name)}</span>` : `<span class="mu__target">@${esc(t)}</span>`;
        });
        if (parts.length) targetHtml = '<span class="mu__arrow">‚Üí</span>' + parts.join(' ');
    }

    // Render markdown content
    const rendered = md(d.content || '');

    const div = document.createElement('div');
    div.className = 'mu mu--chat mu--agent';
    div.innerHTML = `
        <div class="mu__avatar" style="background:${color}20;border-color:${color}">
            <img src="${avatar}" alt="${esc(name)}" style="width:100%;height:100%;border-radius:50%;object-fit:cover" onerror="this.outerHTML='${esc(name.substring(0,2))}'">
        </div>
        <div class="mu__bubble mu__bubble--agent">
            <div class="mu__sender">
                <span class="mu__name" style="color:${color}">${esc(name)}</span>
                ${role ? `<span class="mu__role">${esc(role)}</span>` : ''}
                ${patternType ? `<span class="mu__pattern">(${esc(patternType)})</span>` : ''}
                ${targetHtml}
            </div>
            <div class="mu__content md-rendered">${rendered}</div>
        </div>`;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
}

function addActivity(text, cls) {
    if (!text) return;
    const div = document.createElement('div');
    div.className = `mc-msg ${cls || ''}`;
    const t = new Date().toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});
    div.innerHTML = `<div class="mc-msg-time">${t}</div><div class="mc-msg-content">${esc(text.substring(0,500))}</div>`;
    const act = document.getElementById('mc-activity');
    act.appendChild(div);
    act.scrollTop = act.scrollHeight;
}

function showCheckpoint(phaseId, question) {
    const el = document.querySelector(`.mc-phase[data-phase-id="${phaseId}"] .mc-phase-card`);
    if (!el) return;
    el.querySelector('.mc-checkpoint')?.remove();
    const cp = document.createElement('div');
    cp.className = 'mc-checkpoint';
    cp.innerHTML = `<h4>${esc(question||'Validation requise')}</h4>
        <div class="mc-checkpoint-actions">
            <button class="mc-btn-go" onclick="validateMission('GO')">GO</button>
            <button class="mc-btn-nogo" onclick="validateMission('NOGO')">NOGO</button>
            <button class="mc-btn-pivot" onclick="validateMission('PIVOT')">PIVOT</button>
        </div>`;
    el.appendChild(cp);
}

function addCommit(d) {
    const c = document.getElementById('mc-commits');
    c.querySelector('[style]')?.remove();
    const div = document.createElement('div');
    div.className = 'mc-commit';
    div.innerHTML = `<span class="mc-commit-hash">${(d.sha||'').substring(0,7)}</span>
        <span class="mc-commit-msg">${esc(d.message||'')}</span>
        <span class="mc-commit-time">${new Date().toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})}</span>`;
    c.prepend(div);
    const cells = document.querySelectorAll('.mc-git-cell:not(.l1):not(.l2):not(.l3):not(.l4)');
    if (cells.length) cells[Math.floor(Math.random()*cells.length)].classList.add(['l1','l2','l3','l4'][Math.floor(Math.random()*4)]);
}

function addMemory(d) {
    const m = document.getElementById('mc-memory');
    const cat = d.category || 'general';
    let group = m.querySelector(`.mc-mem-group[data-cat="${cat}"]`);
    if (!group) {
        group = document.createElement('div');
        group.className = 'mc-mem-group';
        group.dataset.cat = cat;
        group.innerHTML = `<div class="mc-mem-group-title" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'block':'none'">‚ñ∏ ${esc(cat)} <span class="mc-mem-group-count">(1)</span></div><div class="mc-mem-group-items"></div>`;
        m.prepend(group);
        m.querySelector('.mc-mem-empty')?.remove();
    } else {
        const cnt = group.querySelector('.mc-mem-group-count');
        cnt.textContent = `(${group.querySelectorAll('.mc-mem-entry').length + 1})`;
    }
    const items = group.querySelector('.mc-mem-group-items');
    const div = document.createElement('div');
    div.className = 'mc-mem-entry';
    div.dataset.key = d.key || '';
    const conf = d.confidence ? `<div class="mc-mem-meta"><div class="mc-mem-confidence"><div class="mc-mem-confidence-bar" style="width:${Math.round((d.confidence||0)*100)}%"></div></div></div>` : '';
    div.innerHTML = `<div class="mc-mem-key">${esc(d.key||'')}</div><div class="mc-mem-val">${esc((d.value||'').substring(0,160))}</div>${conf}`;
    items.prepend(div);
}

function filterMemory(q) {
    const entries = document.querySelectorAll('.mc-mem-entry');
    const groups = document.querySelectorAll('.mc-mem-group');
    const ql = q.toLowerCase();
    entries.forEach(e => {
        const match = !q || (e.dataset.key||'').toLowerCase().includes(ql) || e.textContent.toLowerCase().includes(ql);
        e.style.display = match ? '' : 'none';
    });
    groups.forEach(g => {
        const visible = g.querySelectorAll('.mc-mem-entry:not([style*="display: none"])').length;
        g.style.display = visible ? '' : 'none';
    });
}

async function addMemoryEntry() {
    const cat = prompt('Cat√©gorie (architecture, vision, team, process, backlog):', 'vision');
    if (!cat) return;
    const key = prompt('Cl√©:', '');
    if (!key) return;
    const val = prompt('Valeur:', '');
    if (!val) return;
    try {
        await fetch('/api/memory/global', {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({category: cat, key: key, value: val})
        });
        addMemory({category: cat, key: key, value: val, confidence: 0.8});
    } catch(e) { console.error('Memory add failed', e); }
}

function addPR(d) {
    const c = document.getElementById('mc-prs');
    c.querySelector('.mc-pr-empty')?.remove();
    const div = document.createElement('div');
    div.className = 'mc-pr';
    const status = (d.status||'open').toLowerCase();
    div.innerHTML = `<span class="mc-pr-icon ${status}"><svg class="icon icon-xs"><use href="#icon-git-pull-request"/></svg></span>
        <span class="mc-pr-title" title="${esc(d.title||'')}">#${d.number||'?'} ${esc((d.title||'').substring(0,30))}</span>
        <span class="mc-pr-status ${status}">${esc(d.status||'Open')}</span>`;
    c.prepend(div);
}

function updateStats() {
    const phases = document.querySelectorAll('.mc-phase');
    let done = 0;
    phases.forEach(p => { if (p.dataset.status === 'done') done++; });
    document.getElementById('mc-done-count').textContent = done;
    const pct = Math.round(done / phases.length * 100);
    document.getElementById('mc-progress').textContent = pct + '%';
    document.getElementById('mc-progress-bar').style.width = pct + '%';
}

async function validateMission(decision) {
    const fd = new FormData();
    fd.set('decision', decision);
    try {
        await fetch(`/api/missions/${MISSION_ID}/validate`, {method:'POST', body: fd});
        document.querySelectorAll('.mc-checkpoint').forEach(el => el.remove());
        addActivity(`D√©cision: ${decision}`, 'system');
    } catch(err) { console.error(err); }
}

async function startMissionExecution() {
    const btn = document.getElementById('mc-run-btn');
    btn.disabled = true;
    btn.innerHTML = 'Ex√©cution en cours‚Ä¶';
    btn.style.opacity = '0.6';
    addActivity('Lancement du mega-workflow par le CDP‚Ä¶', 'system');
    try {
        await fetch(`/api/missions/${MISSION_ID}/run`, {method:'POST'});
    } catch(err) { console.error(err); }
}

async function resetMission() {
    if (!confirm('R√©initialiser l\'epic ? Toutes les discussions seront effac√©es.')) return;
    try {
        const resp = await fetch(`/api/missions/${MISSION_ID}/reset`, {method:'POST'});
        if (resp.ok) {
            window.location.reload();
        } else {
            alert('Erreur lors de la r√©initialisation');
        }
    } catch(err) { console.error(err); alert('Erreur r√©seau'); }
}

function esc(t) { return (t||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

/* ‚îÄ‚îÄ Agent Popover ‚îÄ‚îÄ */
function showMcPopover(agentId, ev) {
    ev && ev.stopPropagation();
    const a = AGENT_INFO[agentId];
    if (!a) return;
    const pop = document.getElementById('mcPopover');
    const overlay = document.getElementById('mcPopoverOverlay');
    const photo = a.avatar
        ? `<img class="mc-popover-photo" src="${a.avatar}" alt="${esc(a.name)}" onerror="this.outerHTML='<div class=mc-popover-photo-fallback style=background:${a.color}>${esc(a.name.substring(0,2))}</div>'">`
        : `<div class="mc-popover-photo-fallback" style="background:${a.color}">${esc(a.name.substring(0,2))}</div>`;
    document.getElementById('mcPopHeader').innerHTML = `${photo}<div>
        <div class="mc-popover-name">${esc(a.name)}</div>
        <div class="mc-popover-role">${esc(a.role)}</div>
        ${a.tagline ? `<div class="mc-popover-tagline">${esc(a.tagline)}</div>` : ''}
    </div>`;
    let html = '';
    if (a.persona) html += `<div class="mc-popover-section"><div class="mc-popover-section-title">Persona</div><div class="mc-popover-text">${esc(a.persona.substring(0,400))}${a.persona.length>400?'‚Ä¶':''}</div></div>`;
    if (a.motivation) html += `<div class="mc-popover-section"><div class="mc-popover-section-title">Motivation</div><div class="mc-popover-text">${esc(a.motivation)}</div></div>`;
    if (a.skills?.length) html += `<div class="mc-popover-section"><div class="mc-popover-section-title">Skills (${a.skills.length})</div><div class="mc-popover-tags">${a.skills.map(s=>`<span class="mc-popover-tag skill">${esc(s)}</span>`).join('')}</div></div>`;
    if (a.tools?.length) html += `<div class="mc-popover-section"><div class="mc-popover-section-title">Tools (${a.tools.length})</div><div class="mc-popover-tags">${a.tools.map(t=>`<span class="mc-popover-tag tool">${esc(t)}</span>`).join('')}</div></div>`;
    if (a.model || a.provider) html += `<div class="mc-popover-model">${esc(a.provider||'')} ${esc(a.model||'default')}</div>`;
    document.getElementById('mcPopBody').innerHTML = html;
    // Position near click
    const x = ev ? ev.clientX : window.innerWidth/2;
    const y = ev ? ev.clientY : window.innerHeight/2;
    let top = y + 10, left = x - 170;
    if (top + 380 > window.innerHeight) top = y - 390;
    if (left + 340 > window.innerWidth) left = window.innerWidth - 350;
    if (left < 10) left = 10;
    pop.style.top = Math.max(10, top) + 'px';
    pop.style.left = Math.max(10, left) + 'px';
    pop.classList.add('open');
    overlay.classList.add('open');
}
function closeMcPopover() {
    document.getElementById('mcPopover').classList.remove('open');
    document.getElementById('mcPopoverOverlay').classList.remove('open');
}
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeMcPopover(); });

function cleanLLM(s){
  s = s.replace(/<think>[\s\S]*?<\/think>/g, '');
  s = s.replace(/<think>[\s\S]*$/, '');
  s = s.replace(/\[TOOL_CALL\][\s\S]*?\[\/TOOL_CALL\]/g, '');
  s = s.replace(/\[TOOL_CALL\][\s\S]*$/, '');
  s = s.replace(/\[(DELEGATE|VETO|APPROVE|ASK|ESCALATE)[^\]]*\]/g, '');
  return s.trim();
}
function md(s){
  s = cleanLLM(s);
  if (!s) return '';
  let h = esc(s);
  h = h.replace(/^### (.+)$/gm, '<h4>$1</h4>');
  h = h.replace(/^## (.+)$/gm, '<h3>$1</h3>');
  h = h.replace(/^# (.+)$/gm, '<h2>$1</h2>');
  h = h.replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
  h = h.replace(/`([^`]+)`/g, '<code>$1</code>');
  h = h.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
  h = h.replace(/\*([^*]+)\*/g, '<em>$1</em>');
  h = h.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
  h = h.replace(/^(\|.+\|)\n(\|[-| :]+\|)\n((?:\|.+\|\n?)*)/gm, (m, hdr, sep, body)=>{
    const th = hdr.split('|').filter(c=>c.trim()).map(c=>`<th>${c.trim()}</th>`).join('');
    const rows = body.trim().split('\n').map(r=>{
      const cells = r.split('|').filter(c=>c.trim()).map(c=>`<td>${c.trim()}</td>`).join('');
      return `<tr>${cells}</tr>`;
    }).join('');
    return `<table><thead><tr>${th}</tr></thead><tbody>${rows}</tbody></table>`;
  });
  h = h.replace(/^---$/gm, '<hr>');
  h = h.replace(/^- (.+)$/gm, '<li>$1</li>');
  h = h.replace(/^(\d+)\. (.+)$/gm, '<li>$2</li>');
  h = h.replace(/((?:<li>.*<\/li>\n?)+)/g, '<ul>$1</ul>');
  h = h.replace(/@(\w[\w\s]*?)(?=[\s,.:!?<]|$)/g, '<span style="color:var(--purple);font-weight:600">@$1</span>');
  // Render [SCREENSHOT:path] markers as images
  h = h.replace(/\[SCREENSHOT:([^\]]+)\]/g, (m, path) => {
    const clean = path.replace(/^\.?\//, '');
    // Try mission-scoped workspace first, then generic
    const src = `/workspace/${MISSION_ID}/${clean}`;
    return `<div class="mc-screenshot"><img src="${src}" alt="Screenshot" loading="lazy" onerror="this.src='/workspace/${clean}'" style="max-width:100%;border-radius:var(--radius-lg);margin:0.5rem 0;border:1px solid var(--border-subtle);cursor:pointer" onclick="window.open(this.src)"><div style="font-size:0.65rem;color:var(--text-tertiary);margin-top:2px">${clean}</div></div>`;
  });
  h = h.replace(/\n/g, '<br>');
  return h;
}

function generatePhaseSummary(phaseId) {
    const summaryEl = document.getElementById(`summary-${phaseId}`);
    if (!summaryEl || summaryEl.innerHTML.trim()) return; // DB summary already rendered

    const container = document.getElementById(`discuss-${phaseId}`);
    if (!container) return;
    const msgs = container.querySelectorAll('.mu--chat');
    if (msgs.length === 0) return;

    // Collect all substantive content per agent
    const byAgent = new Map();
    msgs.forEach(msg => {
        const nameEl = msg.querySelector('.mu__name');
        const contentEl = msg.querySelector('.mu__content');
        if (!nameEl || !contentEl) return;
        const name = nameEl.textContent.trim();
        const text = contentEl.textContent.trim();
        if (!text) return;
        if (!byAgent.has(name)) byAgent.set(name, []);
        byAgent.get(name).push(text);
    });

    if (byAgent.size === 0) return;

    // Noise patterns to skip
    const noise = /^(merci|bonjour|ok|d'accord|bien re√ßu|r√©action de|r√©ponse de|lancement phase|workspace:|connected|agent_status)/i;

    let html = '';
    byAgent.forEach((texts, name) => {
        // Merge all messages, extract key sentences
        const all = texts.join(' ');
        const sentences = all.split(/[.!?\n]/)
            .map(s => s.trim())
            .filter(s => s.length > 25 && !noise.test(s));
        if (sentences.length === 0) return;
        // Pick most substantive (longest) sentence as summary
        const best = sentences.reduce((a, b) => b.length > a.length ? b : a, sentences[0]);
        const excerpt = best.length > 200 ? best.substring(0, 197) + '...' : best;
        html += `<div class="mc-summary-line"><span class="mc-summary-agent">${esc(name)}:</span><span class="mc-summary-text">${esc(excerpt)}</span></div>`;
    });
    if (!html) html = `<div class="mc-summary-line"><span class="mc-summary-text" style="font-style:italic">${msgs.length} messages</span></div>`;

    // Collect screenshot images from phase messages
    const screenshots = container.querySelectorAll('.mc-screenshot img');
    if (screenshots.length > 0) {
        html += `<div class="mc-phase-thumbs">`;
        screenshots.forEach((img, i) => {
            if (i < 6) html += `<img class="mc-phase-thumb" src="${img.src}" alt="Screenshot" loading="lazy" onclick="window.open(this.src)">`;
        });
        html += `</div>`;
    }

    summaryEl.innerHTML = html;
}

/* Init */
renderPhaseGraphs();
// Generate summaries for already-completed phases
document.querySelectorAll('.mc-phase[data-status="done"], .mc-phase[data-status="failed"]').forEach(el => {
    generatePhaseSummary(el.dataset.phaseId);
});

/* Event delegation for agent popover clicks on SVG graph nodes */
document.querySelectorAll('.mc-phase-graph').forEach(container => {
    container.addEventListener('click', e => {
        let el = e.target;
        /* Walk up to find mc-live-node group (works in both HTML and SVG namespaces) */
        while (el && el !== container) {
            if (el.classList && el.classList.contains('mc-live-node')) {
                const agentId = el.getAttribute('data-agent-id');
                if (agentId) {
                    e.stopPropagation();
                    showMcPopover(agentId, e);
                }
                return;
            }
            el = el.parentElement || el.parentNode;
        }
    });
});

/* Poll fallback */
setInterval(async () => {
    try {
        const r = await fetch(`/api/missions/${MISSION_ID}`);
        const m = await r.json();
        if (m.phases) { m.phases.forEach(p => updatePhaseStatus(p.phase_id, p.status)); updateStats(); }
    } catch(err){}
}, 10000);
</script>
{% endblock %}
