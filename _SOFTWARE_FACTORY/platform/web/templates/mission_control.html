{% extends "base.html" %}

{% block topbar_actions %}
<span class="badge" style="background:var(--purple);color:#fff;font-size:0.72rem;padding:0.2rem 0.6rem;border-radius:4px">
    {{ mission.status.value|upper }}
</span>
{% endblock %}

{% block content %}
<style>
.mc-layout{display:grid;grid-template-columns:1fr 360px;gap:0;height:calc(100vh - 80px)}
.mc-main{overflow-y:auto;padding:0 0.75rem 1rem 0}
.mc-sidebar{overflow-y:auto;border-left:1px solid var(--border);background:var(--bg-secondary)}

/* Stats bar */
.mc-stats{display:flex;align-items:center;gap:1rem;margin-bottom:0.75rem;padding:0.5rem 0}
.mc-stat-item{display:flex;align-items:center;gap:0.35rem;font-size:0.78rem;color:var(--text-secondary)}
.mc-stat-item .val{font-weight:700;color:var(--text-primary)}
.mc-progress-bar{flex:1;max-width:200px;height:5px;background:var(--bg-tertiary);border-radius:3px;overflow:hidden}
.mc-progress-fill{height:100%;background:var(--purple);border-radius:3px;transition:width .4s}

/* Timeline pipeline */
.mc-pipeline{display:flex;flex-direction:column;gap:0;position:relative}

/* Each phase = timeline row */
.mc-phase{display:flex;align-items:stretch;gap:0;position:relative}

/* Timeline line (left side) */
.mc-phase-line{width:32px;display:flex;flex-direction:column;align-items:center;flex-shrink:0}
.mc-phase-dot{width:14px;height:14px;border-radius:50%;border:2px solid var(--border);background:var(--bg-tertiary);z-index:1;flex-shrink:0;margin-top:0.75rem}
.mc-phase-connector{width:2px;flex:1;background:var(--border)}
.mc-phase:last-child .mc-phase-connector{display:none}

/* Status dot colors */
.mc-phase[data-status="done"] .mc-phase-dot{background:var(--green);border-color:var(--green)}
.mc-phase[data-status="running"] .mc-phase-dot{background:var(--purple);border-color:var(--purple);animation:pulse-dot 1.5s ease-in-out infinite}
.mc-phase[data-status="failed"] .mc-phase-dot{background:var(--red);border-color:var(--red)}
.mc-phase[data-status="waiting_validation"] .mc-phase-dot{background:var(--yellow);border-color:var(--yellow);animation:pulse-dot 1s ease-in-out infinite}
.mc-phase[data-status="done"] .mc-phase-connector{background:var(--green)}
.mc-phase[data-status="running"] .mc-phase-connector{background:var(--purple)}
@keyframes pulse-dot{0%,100%{transform:scale(1)}50%{transform:scale(1.3)}}

/* Phase card (right of timeline) */
.mc-phase-card{flex:1;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;margin-bottom:0.5rem;overflow:hidden;transition:border-color .2s}
.mc-phase[data-status="running"] .mc-phase-card{border-color:var(--purple)}
.mc-phase[data-status="done"] .mc-phase-card{border-color:var(--green)}
.mc-phase[data-status="failed"] .mc-phase-card{border-color:var(--red)}
.mc-phase[data-status="waiting_validation"] .mc-phase-card{border-color:var(--yellow)}

/* Phase header (clickable accordion) */
.mc-phase-header{display:flex;align-items:center;gap:0.5rem;padding:0.55rem 0.75rem;cursor:pointer;user-select:none;transition:background .15s}
.mc-phase-header:hover{background:var(--bg-tertiary)}
.mc-phase-num{font-size:0.65rem;color:var(--text-secondary);font-weight:700;min-width:1.2rem}
.mc-phase-name{font-size:0.82rem;font-weight:600;color:var(--text-primary);flex:1}
.mc-phase-avatars{display:flex;align-items:center;margin-right:0.2rem}
.mc-phase-avatars img{width:20px;height:20px;border-radius:50%;object-fit:cover;border:1.5px solid var(--bg-secondary)}
.mc-phase-avatars img+img{margin-left:-6px}
.mc-phase-avatars .more{font-size:0.62rem;color:var(--text-secondary);margin-left:0.2rem}
.mc-phase-pattern{font-size:0.62rem;color:var(--purple);background:rgba(124,58,237,.1);padding:0.12rem 0.45rem;border-radius:4px;font-weight:600}
.mc-phase-status-badge{font-size:0.62rem;padding:0.12rem 0.45rem;border-radius:4px;font-weight:600}
.mc-phase-status-badge.pending{color:var(--text-secondary);background:var(--bg-tertiary)}
.mc-phase-status-badge.running{color:var(--purple);background:rgba(124,58,237,.15)}
.mc-phase-status-badge.done{color:var(--green);background:rgba(34,197,94,.12)}
.mc-phase-status-badge.failed{color:var(--red);background:rgba(239,68,68,.12)}
.mc-phase-status-badge.waiting_validation{color:var(--yellow);background:rgba(234,179,8,.12)}
.mc-phase-chevron{font-size:0.65rem;color:var(--text-secondary);transition:transform .2s}
.mc-phase.open .mc-phase-chevron{transform:rotate(90deg)}

/* Accordion body (discussion + agents) */
.mc-phase-body{display:none;border-top:1px solid var(--border)}
.mc-phase.open .mc-phase-body{display:grid;grid-template-columns:1fr 170px;min-height:100px}

/* Phase discussions */
.mc-phase-discuss{padding:0.5rem 0.6rem;overflow-y:auto;max-height:280px;display:flex;flex-direction:column;gap:0.35rem}
.mc-discuss-empty{font-size:0.72rem;color:var(--text-secondary);font-style:italic;padding:0.8rem;text-align:center}
.mc-discuss-msg{display:flex;gap:0.35rem;align-items:flex-start}
.mc-discuss-avatar{width:20px;height:20px;border-radius:50%;object-fit:cover;flex-shrink:0;margin-top:0.15rem}
.mc-discuss-bubble{background:var(--bg-tertiary);border-radius:6px;padding:0.3rem 0.5rem;font-size:0.72rem;color:var(--text-secondary);line-height:1.35;min-width:0;flex:1}
.mc-discuss-from{font-size:0.65rem;font-weight:600;color:var(--text-primary)}
.mc-discuss-role{font-size:0.58rem;color:var(--purple);font-weight:500;margin-left:0.3rem}

/* Phase agent list (mini sidebar) */
.mc-phase-agents{border-left:1px solid var(--border);padding:0.4rem;display:flex;flex-direction:column;gap:0.15rem;background:var(--bg-primary);overflow-y:auto}
.mc-mini-agent{display:flex;align-items:center;gap:0.25rem;padding:0.2rem 0.3rem;border-radius:5px;font-size:0.65rem}
.mc-mini-agent:hover{background:var(--bg-tertiary)}
.mc-mini-agent img{width:16px;height:16px;border-radius:50%;object-fit:cover;flex-shrink:0}
.mc-mini-agent .a-name{font-weight:600;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.mc-mini-agent .a-role{font-size:0.58rem;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* Checkpoint */
.mc-checkpoint{background:rgba(234,179,8,.08);border-top:1px solid var(--yellow);padding:0.6rem 0.75rem}
.mc-checkpoint h4{color:var(--yellow);font-size:0.8rem;margin:0 0 0.4rem}
.mc-checkpoint-actions{display:flex;gap:0.5rem}
.mc-checkpoint-actions button{padding:0.25rem 0.7rem;border-radius:6px;font-size:0.72rem;font-weight:600;cursor:pointer;border:none;transition:opacity .15s}
.mc-checkpoint-actions button:hover{opacity:.85}
.mc-btn-go{background:var(--green);color:#fff}
.mc-btn-nogo{background:var(--red);color:#fff}
.mc-btn-pivot{background:var(--yellow);color:#000}

/* ====== RIGHT SIDEBAR ====== */
.mc-side-section{padding:0.6rem 0.75rem;border-bottom:1px solid var(--border)}
.mc-side-title{font-size:0.68rem;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-secondary);margin-bottom:0.45rem;display:flex;align-items:center;gap:0.3rem}

/* CDP activity */
.mc-cdp-header{display:flex;align-items:center;gap:0.5rem;padding:0.5rem 0.75rem;border-bottom:1px solid var(--border);background:var(--bg-tertiary)}
.mc-cdp-avatar{width:26px;height:26px;border-radius:50%;object-fit:cover}
.mc-cdp-info h3{font-size:0.8rem;margin:0;color:var(--text-primary)}
.mc-cdp-info small{font-size:0.62rem;color:var(--text-secondary)}
.mc-activity{display:flex;flex-direction:column;gap:0.3rem;padding:0.5rem 0.75rem;max-height:220px;overflow-y:auto}
.mc-msg{background:var(--bg-tertiary);border-radius:6px;padding:0.3rem 0.5rem;font-size:0.7rem;color:var(--text-secondary);line-height:1.3}
.mc-msg.tool{border-left:2px solid var(--purple);font-family:var(--font-mono,monospace);font-size:0.65rem}
.mc-msg.system{border-left:2px solid var(--yellow)}
.mc-msg-time{font-size:0.55rem;color:var(--text-secondary);margin-bottom:0.1rem}
.mc-msg-content{white-space:pre-wrap;word-break:break-word}

/* Memory */
.mc-mem-entry{background:var(--bg-tertiary);border-radius:5px;padding:0.3rem 0.45rem;margin-bottom:0.25rem;font-size:0.7rem}
.mc-mem-key{font-weight:600;color:var(--text-primary);font-size:0.65rem}
.mc-mem-val{color:var(--text-secondary);font-size:0.62rem;line-height:1.25;max-height:2.2rem;overflow:hidden}
.mc-mem-cat{font-size:0.55rem;color:var(--purple);font-weight:600;text-transform:uppercase}

/* Git */
.mc-git-graph{display:grid;grid-template-columns:repeat(14,1fr);gap:2px;margin-bottom:0.5rem}
.mc-git-cell{aspect-ratio:1;border-radius:2px;background:var(--bg-tertiary)}
.mc-git-cell.l1{background:rgba(124,58,237,.2)}
.mc-git-cell.l2{background:rgba(124,58,237,.45)}
.mc-git-cell.l3{background:rgba(124,58,237,.7)}
.mc-git-cell.l4{background:var(--purple)}
.mc-commit{display:flex;align-items:baseline;gap:0.3rem;padding:0.2rem 0;font-size:0.68rem;border-bottom:1px solid var(--border)}
.mc-commit:last-child{border-bottom:none}
.mc-commit-hash{color:var(--purple);font-family:var(--font-mono,monospace);font-size:0.62rem;flex-shrink:0}
.mc-commit-msg{color:var(--text-secondary);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.mc-commit-time{color:var(--text-secondary);font-size:0.58rem;flex-shrink:0;opacity:.7}

@media(max-width:900px){.mc-layout{grid-template-columns:1fr;height:auto}.mc-sidebar{border-left:none;border-top:1px solid var(--border)}}
</style>

<div class="mc-layout">
    <!-- ====== MAIN: Timeline + Accordions ====== -->
    <div class="mc-main">
        <div class="mc-stats">
            <div class="mc-stat-item"><span class="val" id="mc-done-count">{{ mission.phases|selectattr('status.value','equalto','done')|list|length }}</span>/<span>{{ mission.phases|length }}</span> phases</div>
            <div class="mc-progress-bar"><div class="mc-progress-fill" id="mc-progress-bar" style="width:{{ ((mission.phases|selectattr('status.value','equalto','done')|list|length / mission.phases|length) * 100)|round|int if mission.phases|length > 0 else 0 }}%"></div></div>
            <div class="mc-stat-item"><span class="val" id="mc-progress">{{ ((mission.phases|selectattr('status.value','equalto','done')|list|length / mission.phases|length) * 100)|round|int if mission.phases|length > 0 else 0 }}%</span></div>
        </div>

        <div class="mc-pipeline" id="mc-pipeline">
            {% for phase in mission.phases %}
            {% set pa = phase_agents.get(phase.phase_id, []) %}
            <div class="mc-phase{% if phase.status.value == 'running' %} open{% endif %}" data-phase-id="{{ phase.phase_id }}" data-status="{{ phase.status.value }}">
                <!-- Timeline line -->
                <div class="mc-phase-line">
                    <div class="mc-phase-dot"></div>
                    <div class="mc-phase-connector"></div>
                </div>
                <!-- Card with accordion -->
                <div class="mc-phase-card">
                    <div class="mc-phase-header" onclick="togglePhase(this)">
                        <span class="mc-phase-num">{{ loop.index }}</span>
                        <span class="mc-phase-name">{{ phase.phase_name }}</span>
                        <div class="mc-phase-avatars">
                            {% for a in pa[:4] %}
                            <img src="{{ a.avatar }}" title="{{ a.name }} ‚Äî {{ a.role }}" onerror="this.style.display='none'">
                            {% endfor %}
                            {% if pa|length > 4 %}<span class="more">+{{ pa|length - 4 }}</span>{% endif %}
                        </div>
                        <span class="mc-phase-pattern">{{ phase.pattern_id }}</span>
                        <span class="mc-phase-status-badge {{ phase.status.value }}">{{ phase.status.value }}</span>
                        <span class="mc-phase-chevron">‚ñ∂</span>
                    </div>
                    <!-- Accordion body: discussions + agent list -->
                    <div class="mc-phase-body">
                        <div class="mc-phase-discuss" id="discuss-{{ phase.phase_id }}">
                            <div class="mc-discuss-empty">En attente d'ex√©cution‚Ä¶</div>
                        </div>
                        <div class="mc-phase-agents">
                            {% for a in pa %}
                            <div class="mc-mini-agent">
                                <img src="{{ a.avatar }}" onerror="this.style.display='none'" alt="">
                                <div style="min-width:0">
                                    <div class="a-name">{{ a.name }}</div>
                                    <div class="a-role">{{ a.role }}</div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% if phase.status.value == 'waiting_validation' %}
                    <div class="mc-checkpoint">
                        <h4>üõë Checkpoint ‚Äî Validation requise</h4>
                        <div class="mc-checkpoint-actions">
                            <button class="mc-btn-go" onclick="validateMission('GO')">‚úÖ GO</button>
                            <button class="mc-btn-nogo" onclick="validateMission('NOGO')">‚ùå NOGO</button>
                            <button class="mc-btn-pivot" onclick="validateMission('PIVOT')">üîÑ PIVOT</button>
                        </div>
                    </div>
                    {% endif %}
                    {% if phase.summary %}
                    <div style="padding:0.35rem 0.75rem;font-size:0.72rem;color:var(--text-secondary);border-top:1px solid var(--border)">{{ phase.summary[:300] }}</div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- ====== RIGHT SIDEBAR ====== -->
    <div class="mc-sidebar">
        <!-- CDP Activity -->
        <div class="mc-cdp-header">
            {% set cdp = agent_map.get('chef_de_programme') %}
            {% if cdp %}
            <img class="mc-cdp-avatar" src="{{ cdp['avatar_url'] or '/static/avatars/chef_de_programme.jpg' }}" alt="">
            {% endif %}
            <div class="mc-cdp-info">
                <h3>{{ cdp['name'] if cdp else 'CDP' }}</h3>
                <small>Chef de Programme</small>
            </div>
        </div>
        <div class="mc-activity" id="mc-activity">
            <div class="mc-msg system"><div class="mc-msg-content">üöÄ {{ mission.brief[:200] }}</div></div>
        </div>

        <!-- Memory -->
        <div class="mc-side-section">
            <div class="mc-side-title">üß† M√©moire</div>
            <div id="mc-memory">
                {% if memories %}
                    {% for mem in memories[:8] %}
                    <div class="mc-mem-entry">
                        {% if mem is mapping %}
                        <div class="mc-mem-cat">{{ mem.get('category','') }}</div>
                        <div class="mc-mem-key">{{ mem.get('key','') }}</div>
                        <div class="mc-mem-val">{{ mem.get('value','')[:120] }}</div>
                        {% else %}
                        <div class="mc-mem-val">{{ (mem|string)[:120] }}</div>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                <div style="font-size:0.7rem;color:var(--text-secondary);font-style:italic;padding:0.3rem 0">Aucune m√©moire enregistr√©e</div>
                {% endif %}
            </div>
        </div>

        <!-- Git -->
        <div class="mc-side-section">
            <div class="mc-side-title">
                <svg class="icon icon-xs"><use href="#icon-git-branch"/></svg> Git
            </div>
            <div class="mc-git-graph" id="mc-git-graph"></div>
            <div id="mc-commits">
                <div style="font-size:0.7rem;color:var(--text-secondary);font-style:italic">Commits appara√Ætront ici‚Ä¶</div>
            </div>
        </div>
    </div>
</div>

<script>
const MISSION_ID = "{{ mission.id }}";
const SESSION_ID = "{{ session_id }}";
const PHASE_AGENTS = {{ phase_agents | tojson }};

/* Generate git contribution graph */
(function(){
    const g = document.getElementById('mc-git-graph');
    for(let i=0;i<56;i++){
        const c = document.createElement('div');
        c.className = 'mc-git-cell';
        g.appendChild(c);
    }
})();

/* Accordion toggle */
function togglePhase(header) {
    header.closest('.mc-phase-card').closest('.mc-phase').classList.toggle('open');
}

/* SSE */
if (SESSION_ID) {
    const es = new EventSource(`/sse/session/${SESSION_ID}`);
    es.onmessage = e => { try { handleSSE(JSON.parse(e.data)); } catch(err){} };
}

function handleSSE(d) {
    if (d.type === 'phase_started') {
        updatePhaseStatus(d.phase_id, 'running');
        openPhase(d.phase_id);
        addActivity(`üîÑ Phase ¬´${d.phase_name}¬ª (${d.pattern})`, 'tool');
    }
    else if (d.type === 'phase_completed') {
        updatePhaseStatus(d.phase_id, d.success ? 'done' : 'failed');
        addActivity(`${d.success ? '‚úÖ' : '‚ùå'} Phase termin√©e`, 'tool');
        updateStats();
    }
    else if (d.type === 'phase_failed') {
        updatePhaseStatus(d.phase_id, 'failed');
        addActivity('‚ùå Phase √©chou√©e', 'system');
    }
    else if (d.type === 'checkpoint') {
        updatePhaseStatus(d.phase_id, 'waiting_validation');
        openPhase(d.phase_id);
        showCheckpoint(d.phase_id, d.question);
        addActivity(`üõë CHECKPOINT: ${d.question}`, 'system');
    }
    else if (d.type === 'message') {
        if (d.from_agent === 'chef_de_programme') addActivity(d.content, '');
        const phaseId = d.phase_id || currentRunningPhase();
        if (phaseId) addDiscussionMsg(phaseId, d);
        if (d.msg_type === 'tool_result') addActivity(d.content?.substring(0, 200), 'tool');
    }
    else if (d.type === 'agent_message' || d.type === 'agent_response') {
        const phaseId = d.phase_id || currentRunningPhase();
        if (phaseId) addDiscussionMsg(phaseId, d);
    }
    if (d.type === 'commit') addCommit(d);
    if (d.type === 'memory_stored') addMemory(d);
}

function currentRunningPhase() {
    const el = document.querySelector('.mc-phase[data-status="running"]');
    return el ? el.dataset.phaseId : null;
}

function openPhase(phaseId) {
    document.querySelector(`.mc-phase[data-phase-id="${phaseId}"]`)?.classList.add('open');
}

function updatePhaseStatus(phaseId, status) {
    const el = document.querySelector(`.mc-phase[data-phase-id="${phaseId}"]`);
    if (!el) return;
    el.dataset.status = status;
    const badge = el.querySelector('.mc-phase-status-badge');
    if (badge) { badge.className = `mc-phase-status-badge ${status}`; badge.textContent = status; }
}

function addDiscussionMsg(phaseId, d) {
    const container = document.getElementById(`discuss-${phaseId}`);
    if (!container) return;
    container.querySelector('.mc-discuss-empty')?.remove();
    const div = document.createElement('div');
    div.className = 'mc-discuss-msg';
    const avatar = d.from_avatar || `/static/avatars/${d.from_agent || 'bot'}.jpg`;
    div.innerHTML = `<img class="mc-discuss-avatar" src="${avatar}" onerror="this.style.display='none'" alt="">
        <div class="mc-discuss-bubble">
            <div class="mc-discuss-from">${esc(d.from_name||d.from_agent||'?')}<span class="mc-discuss-role">${esc(d.from_role||'')}</span></div>
            ${esc((d.content||'').substring(0,400))}
        </div>`;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
}

function addActivity(text, cls) {
    if (!text) return;
    const div = document.createElement('div');
    div.className = `mc-msg ${cls || ''}`;
    const t = new Date().toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});
    div.innerHTML = `<div class="mc-msg-time">${t}</div><div class="mc-msg-content">${esc(text.substring(0,500))}</div>`;
    const act = document.getElementById('mc-activity');
    act.appendChild(div);
    act.scrollTop = act.scrollHeight;
}

function showCheckpoint(phaseId, question) {
    const el = document.querySelector(`.mc-phase[data-phase-id="${phaseId}"] .mc-phase-card`);
    if (!el) return;
    el.querySelector('.mc-checkpoint')?.remove();
    const cp = document.createElement('div');
    cp.className = 'mc-checkpoint';
    cp.innerHTML = `<h4>üõë ${esc(question||'Validation requise')}</h4>
        <div class="mc-checkpoint-actions">
            <button class="mc-btn-go" onclick="validateMission('GO')">‚úÖ GO</button>
            <button class="mc-btn-nogo" onclick="validateMission('NOGO')">‚ùå NOGO</button>
            <button class="mc-btn-pivot" onclick="validateMission('PIVOT')">üîÑ PIVOT</button>
        </div>`;
    el.appendChild(cp);
}

function addCommit(d) {
    const c = document.getElementById('mc-commits');
    c.querySelector('[style]')?.remove();
    const div = document.createElement('div');
    div.className = 'mc-commit';
    div.innerHTML = `<span class="mc-commit-hash">${(d.sha||'').substring(0,7)}</span>
        <span class="mc-commit-msg">${esc(d.message||'')}</span>
        <span class="mc-commit-time">${new Date().toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})}</span>`;
    c.prepend(div);
    // Light up a git cell
    const cells = document.querySelectorAll('.mc-git-cell:not(.l1):not(.l2):not(.l3):not(.l4)');
    if (cells.length) cells[Math.floor(Math.random()*cells.length)].classList.add(['l1','l2','l3','l4'][Math.floor(Math.random()*4)]);
}

function addMemory(d) {
    const m = document.getElementById('mc-memory');
    const div = document.createElement('div');
    div.className = 'mc-mem-entry';
    div.innerHTML = `<div class="mc-mem-cat">${esc(d.category||'')}</div>
        <div class="mc-mem-key">${esc(d.key||'')}</div>
        <div class="mc-mem-val">${esc((d.value||'').substring(0,120))}</div>`;
    m.prepend(div);
}

function updateStats() {
    const phases = document.querySelectorAll('.mc-phase');
    let done = 0;
    phases.forEach(p => { if (p.dataset.status === 'done') done++; });
    document.getElementById('mc-done-count').textContent = done;
    const pct = Math.round(done / phases.length * 100);
    document.getElementById('mc-progress').textContent = pct + '%';
    document.getElementById('mc-progress-bar').style.width = pct + '%';
}

async function validateMission(decision) {
    const fd = new FormData();
    fd.set('decision', decision);
    try {
        await fetch(`/api/missions/${MISSION_ID}/validate`, {method:'POST', body: fd});
        document.querySelectorAll('.mc-checkpoint').forEach(el => el.remove());
        addActivity(`üèÅ D√©cision: ${decision}`, 'system');
    } catch(err) { console.error(err); }
}

function esc(t) { return (t||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* Poll fallback */
setInterval(async () => {
    try {
        const r = await fetch(`/api/missions/${MISSION_ID}`);
        const m = await r.json();
        if (m.phases) { m.phases.forEach(p => updatePhaseStatus(p.phase_id, p.status)); updateStats(); }
    } catch(err){}
}, 10000);
</script>
{% endblock %}
