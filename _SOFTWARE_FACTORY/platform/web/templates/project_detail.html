{% extends "base.html" %}

{% block topbar_actions %}
<div class="project-topbar-info">
    {% if project.factory_type == 'sf' %}
    <button class="btn btn-primary btn-sm" title="Run Brain analysis">
        <svg class="icon icon-sm"><use href="#icon-zap"/></svg> Brain
    </button>
    <button class="btn btn-sm" title="Start TDD Cycle">
        <svg class="icon icon-sm"><use href="#icon-play"/></svg> Cycle
    </button>
    {% elif project.factory_type == 'mf' %}
    <button class="btn btn-primary btn-sm" title="Run Migration analysis">
        <svg class="icon icon-sm"><use href="#icon-zap"/></svg> Analyze
    </button>
    <button class="btn btn-sm" title="Start Transform">
        <svg class="icon icon-sm"><use href="#icon-play"/></svg> Transform
    </button>
    {% endif %}
</div>
{% endblock %}

{% block content %}
<div class="project-detail">
    <!-- Project header -->
    <div class="project-hero">
        <div class="project-hero-left">
            <span class="project-type-dot {{ project.factory_type }} dot-lg"></span>
            <div>
                <h3>{{ project.name }}</h3>
                <code class="project-path">{{ project.path }}</code>
            </div>
        </div>
        <div class="project-hero-right">
            <span class="badge badge-{% if project.factory_type == 'sf' %}blue{% elif project.factory_type == 'mf' %}purple{% else %}yellow{% endif %}">
                {% if project.factory_type == 'sf' %}Software Factory
                {% elif project.factory_type == 'mf' %}Migration Factory
                {% else %}Standalone{% endif %}
            </span>
            {% for d in project.domains %}
            <span class="tag">{{ d }}</span>
            {% endfor %}
        </div>
    </div>

    <!-- Vision, Values & Quick Chat -->
    <div class="project-meta-row">
        {% if project.vision %}
        <section class="panel project-panel vision-panel">
            <div class="panel-header">
                <h3><svg class="icon icon-sm"><use href="#icon-eye"/></svg> Vision</h3>
            </div>
            <div class="panel-body">
                <div class="vision-text">{{ project.vision[:500] }}{% if project.vision|length > 500 %}…{% endif %}</div>
            </div>
        </section>
        {% endif %}

        <section class="panel project-panel values-panel">
            <div class="panel-header">
                <h3><svg class="icon icon-sm"><use href="#icon-heart"/></svg> Values & Lead</h3>
            </div>
            <div class="panel-body">
                <div class="values-tags">
                    {% for v in project.values %}
                    <span class="tag tag-value">{{ v }}</span>
                    {% endfor %}
                    {% if not project.values %}
                    <span class="empty-hint">No values defined</span>
                    {% endif %}
                </div>
                {% if project.lead_agent_id %}
                <div class="lead-agent-info" style="margin-top:0.75rem">
                    <span class="label-sm">Lead Agent:</span>
                    <span class="badge badge-purple">{{ project.lead_agent_id }}</span>
                </div>
                {% endif %}
            </div>
        </section>

        <section class="panel project-panel chat-panel">
            <div class="panel-header">
                <h3><svg class="icon icon-sm"><use href="#icon-message-circle"/></svg> Quick Chat</h3>
            </div>
            <div class="panel-body">
                <form hx-post="/api/projects/{{ project.id }}/chat"
                      hx-target="#quick-chat-result"
                      hx-swap="innerHTML"
                      hx-indicator="#chat-spinner">
                    <div class="input-group">
                        <input type="text" name="content" placeholder="Ask the lead agent..."
                               class="input" autocomplete="off">
                        <button type="submit" class="btn btn-primary btn-sm">
                            <svg class="icon icon-sm"><use href="#icon-send"/></svg>
                        </button>
                    </div>
                </form>
                <div id="quick-chat-result" style="margin-top:0.5rem"></div>
                <div id="chat-spinner" class="htmx-indicator" style="text-align:center;padding:0.5rem">
                    <span class="typing-indicator"><span></span><span></span><span></span></span>
                </div>
            </div>
        </section>
    </div>

    <div class="project-grid">
        <!-- Git Panel -->
        <section class="panel project-panel" id="git-panel"
                 hx-get="/api/projects/{{ project.id }}/git"
                 hx-trigger="every 10s"
                 hx-swap="innerHTML">
            {% include "partials/git_panel.html" %}
        </section>

        <!-- Task Panel -->
        <section class="panel project-panel" id="task-panel"
                 hx-get="/api/projects/{{ project.id }}/tasks"
                 hx-trigger="every 10s"
                 hx-swap="innerHTML">
            {% include "partials/task_panel.html" %}
        </section>

        <!-- Workflow Pipeline -->
        <section class="panel project-panel workflow-panel">
            <div class="panel-header">
                <h3><svg class="icon icon-sm"><use href="#icon-activity"/></svg> Workflow Pipeline</h3>
            </div>
            <div class="panel-body">
                {% if project.factory_type == 'sf' %}
                <div class="pipeline">
                    <div class="pipeline-step" data-step="brain">
                        <div class="step-icon"><svg class="icon"><use href="#icon-zap"/></svg></div>
                        <div class="step-label">Brain</div>
                        <div class="step-desc">Analysis & task generation</div>
                    </div>
                    <div class="pipeline-arrow"><svg class="icon icon-sm"><use href="#icon-arrow-right"/></svg></div>
                    <div class="pipeline-step" data-step="tdd">
                        <div class="step-icon"><svg class="icon"><use href="#icon-code"/></svg></div>
                        <div class="step-label">TDD</div>
                        <div class="step-desc">Code + tests</div>
                    </div>
                    <div class="pipeline-arrow"><svg class="icon icon-sm"><use href="#icon-arrow-right"/></svg></div>
                    <div class="pipeline-step" data-step="adversarial">
                        <div class="step-icon"><svg class="icon"><use href="#icon-shield"/></svg></div>
                        <div class="step-label">Review</div>
                        <div class="step-desc">Adversarial critics</div>
                    </div>
                    <div class="pipeline-arrow"><svg class="icon icon-sm"><use href="#icon-arrow-right"/></svg></div>
                    <div class="pipeline-step" data-step="build">
                        <div class="step-icon"><svg class="icon"><use href="#icon-terminal"/></svg></div>
                        <div class="step-label">Build</div>
                        <div class="step-desc">Compile & test</div>
                    </div>
                    <div class="pipeline-arrow"><svg class="icon icon-sm"><use href="#icon-arrow-right"/></svg></div>
                    <div class="pipeline-step" data-step="deploy">
                        <div class="step-icon"><svg class="icon"><use href="#icon-rocket"/></svg></div>
                        <div class="step-label">Deploy</div>
                        <div class="step-desc">Staging → E2E → Prod</div>
                    </div>
                </div>
                {% elif project.factory_type == 'mf' %}
                <div class="pipeline">
                    <div class="pipeline-step" data-step="analyze">
                        <div class="step-icon"><svg class="icon"><use href="#icon-eye"/></svg></div>
                        <div class="step-label">Analyze</div>
                        <div class="step-desc">Breaking changes</div>
                    </div>
                    <div class="pipeline-arrow"><svg class="icon icon-sm"><use href="#icon-arrow-right"/></svg></div>
                    <div class="pipeline-step" data-step="transform">
                        <div class="step-icon"><svg class="icon"><use href="#icon-code"/></svg></div>
                        <div class="step-label">Transform</div>
                        <div class="step-desc">Codemods + LLM</div>
                    </div>
                    <div class="pipeline-arrow"><svg class="icon icon-sm"><use href="#icon-arrow-right"/></svg></div>
                    <div class="pipeline-step" data-step="compare">
                        <div class="step-icon"><svg class="icon"><use href="#icon-shield"/></svg></div>
                        <div class="step-label">Compare</div>
                        <div class="step-desc">ISO 100% validation</div>
                    </div>
                    <div class="pipeline-arrow"><svg class="icon icon-sm"><use href="#icon-arrow-right"/></svg></div>
                    <div class="pipeline-step" data-step="deploy">
                        <div class="step-icon"><svg class="icon"><use href="#icon-rocket"/></svg></div>
                        <div class="step-label">Deploy</div>
                        <div class="step-desc">Canary rollout</div>
                    </div>
                </div>
                {% else %}
                <p class="empty-state">No factory pipeline configured for standalone projects.</p>
                {% endif %}
            </div>
        </section>
    </div>
</div>
{% endblock %}
