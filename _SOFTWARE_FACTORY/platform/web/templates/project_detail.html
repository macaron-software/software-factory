{% extends "base.html" %}

{% block topbar_actions %}
<div class="project-topbar-info">
    <span class="project-type-dot {{ project.factory_type }} dot-lg"></span>
    <span style="font-size:0.8rem;color:var(--text-secondary)">{{ project.path }}</span>
    <button class="btn btn-sm btn-ghost" onclick="document.getElementById('project-sidebar').classList.toggle('open')" title="Project info">
        <svg class="icon icon-sm"><use href="#icon-settings"/></svg> Info
    </button>
    {% if project.factory_type == 'sf' %}
    <button class="btn btn-primary btn-sm" title="Run Brain analysis">
        <svg class="icon icon-sm"><use href="#icon-zap"/></svg> Brain
    </button>
    {% elif project.factory_type == 'mf' %}
    <button class="btn btn-primary btn-sm" title="Run Migration analysis">
        <svg class="icon icon-sm"><use href="#icon-zap"/></svg> Analyze
    </button>
    {% endif %}
</div>
{% endblock %}

{% block content %}
<div class="project-chat-layout">

    <!-- ═══ Main: ChatGPT-style conversation ═══ -->
    <div class="project-chat-main">
        <!-- Conversation header -->
        <div class="chat-header">
            <div class="chat-header-left">
                <button class="btn btn-ghost btn-sm chat-history-btn" onclick="toggleConversationList()" title="Conversation history">
                    <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 8v4l3 3"/><circle cx="12" cy="12" r="10"/></svg>
                </button>
                <span class="chat-header-title" id="chat-conv-title">
                    {% if active_session %}{{ active_session.name }}{% else %}New conversation{% endif %}
                </span>
                {% if messages %}
                <span class="chat-header-count">{{ messages|length }} messages</span>
                {% endif %}
            </div>
            <button class="btn btn-ghost btn-sm" onclick="newConversation()" title="New conversation">
                <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                New
            </button>
        </div>

        <!-- Conversation list (hidden by default) -->
        <div class="chat-conv-list" id="chat-conv-list" style="display:none">
            {% for s in sessions %}
            {% set is_workflow = (s.config or {}).get('workflow_id') %}
            <a class="chat-conv-item {{ 'active' if active_session and s.id == active_session.id }}"
               href="{% if is_workflow %}/sessions/{{ s.id }}/live{% else %}/projects/{{ project.id }}?session={{ s.id }}{% endif %}">
                {% if is_workflow %}<svg class="icon icon-xs" style="flex-shrink:0"><use href="#icon-workflow"/></svg>{% endif %}
                <span class="chat-conv-name">{{ s.name }}</span>
                <span class="chat-conv-date">{{ s.created_at[:16].replace('T', ' ') if s.created_at else '' }}</span>
            </a>
            {% endfor %}
            {% if not sessions %}
            <div class="chat-conv-empty">No conversations yet</div>
            {% endif %}
        </div>

        <div class="chat-messages" id="chat-messages">
            {% if messages %}
                {% for msg in messages %}
                <div class="chat-msg {{ 'chat-msg-user' if msg.from_agent == 'user' else 'chat-msg-agent' }}">
                    {% if msg.from_agent != 'user' %}
                    <div class="chat-msg-avatar agent-avatar-sm">
                        {% if lead_agent and lead_agent.avatar %}
                        <svg class="icon icon-sm" style="color:{{ lead_agent.color }}"><use href="#icon-{{ lead_agent.avatar }}"/></svg>
                        {% else %}
                        <svg class="icon icon-sm"><use href="#icon-bot"/></svg>
                        {% endif %}
                    </div>
                    {% endif %}
                    <div class="chat-msg-body">
                        {% if msg.from_agent != 'user' and msg.from_agent != 'system' %}
                        <div class="chat-msg-sender">
                            {% if lead_agent %}{{ lead_agent.name }}{% else %}{{ project.name }}{% endif %}
                        </div>
                        {% endif %}
                        {% if msg.from_agent == 'user' %}
                        <div class="chat-msg-text">{{ msg.content }}</div>
                        {% else %}
                        <div class="chat-msg-text md-rendered">{{ msg.content | markdown | safe }}</div>
                        {% endif %}
                        {% if msg.metadata and msg.metadata.tool_calls %}
                        <div class="chat-msg-tools">
                            {% for tc in msg.metadata.tool_calls %}
                            <span class="chat-tool-pill"><svg class="icon icon-xs"><use href="#icon-wrench"/></svg> {{ tc.name }}</span>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% if msg.from_agent == 'user' %}
                    <div class="chat-msg-avatar user">S</div>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <div class="chat-welcome">
                    <div class="chat-welcome-icon">
                        {% if lead_agent and lead_agent.avatar %}
                        <svg class="icon" style="width:48px;height:48px;color:{{ lead_agent.color }}"><use href="#icon-{{ lead_agent.avatar }}"/></svg>
                        {% else %}
                        <svg class="icon" style="width:48px;height:48px;color:var(--purple)"><use href="#icon-bot"/></svg>
                        {% endif %}
                    </div>
                    <h3>{% if lead_agent %}{{ lead_agent.name }}{% else %}{{ project.name }}{% endif %}</h3>
                    {% if lead_agent and lead_agent.tagline %}
                    <p style="color:var(--text-secondary);font-style:italic;margin-bottom:0.5rem">{{ lead_agent.tagline }}</p>
                    {% endif %}
                    <p>Ask anything about this project — the agent can browse files, read code, search git history, and more.</p>
                    <div class="chat-suggestions">
                        <button class="chat-suggestion" onclick="document.getElementById('chat-input').value=this.textContent;sendChat()">What is this project about?</button>
                        <button class="chat-suggestion" onclick="document.getElementById('chat-input').value=this.textContent;sendChat()">Show me the project structure</button>
                        <button class="chat-suggestion" onclick="document.getElementById('chat-input').value=this.textContent;sendChat()">What are the recent changes?</button>
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- Input bar -->
        <div class="chat-input-bar">
            <form id="chat-form">
                <div class="chat-input-row">
                    <textarea id="chat-input" name="content" rows="1" placeholder="Message {{ project.name }}…"
                              onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChat()}"
                              oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,120)+'px'"></textarea>
                    <button type="button" class="chat-send-btn" onclick="sendChat()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ═══ Sidebar: Project info (collapsible) ═══ -->
    <aside class="project-sidebar" id="project-sidebar">
        <div class="ps-section">
            <h4>Vision</h4>
            {% if project.vision %}
            <div class="ps-text md-rendered">{{ project.vision[:800] | markdown | safe }}</div>
            {% else %}
            <p class="ps-empty">No vision defined — add a VISION.md to your project</p>
            {% endif %}
        </div>

        <div class="ps-section">
            <h4>Values</h4>
            <div class="ps-tags">
                {% for v in project.values %}
                <span class="item-tag">{{ v }}</span>
                {% endfor %}
                {% if not project.values %}
                <span class="ps-empty">No values</span>
                {% endif %}
            </div>
        </div>

        {% if project.lead_agent_id %}
        <div class="ps-section">
            <h4>Lead Agent</h4>
            <span class="item-badge accent">{{ project.lead_agent_id }}</span>
        </div>
        {% endif %}

        <div class="ps-section">
            <h4>Domains</h4>
            <div class="ps-tags">
                {% for d in project.domains %}
                <span class="item-tag">{{ d }}</span>
                {% endfor %}
            </div>
        </div>

        <!-- Memory files (auto-loaded) -->
        <div class="ps-section">
            <h4><svg class="icon icon-xs" style="vertical-align:middle"><use href="#icon-filetext"/></svg> Memory</h4>
            {% if memory_files %}
            <div class="ps-memory-list">
                {% for mf in memory_files %}
                <details class="ps-memory-file">
                    <summary>
                        <span class="ps-memory-name">{{ mf.path }}</span>
                        <span class="ps-memory-size">{{ (mf.size / 1024) | round(1) }}K</span>
                    </summary>
                    <div class="ps-memory-content md-rendered">{{ mf.content[:800] | markdown | safe }}{% if mf.content|length > 800 %}<p class="ps-empty">… (truncated)</p>{% endif %}</div>
                </details>
                {% endfor %}
            </div>
            {% else %}
            <p class="ps-empty">No memory files found (CLAUDE.md, copilot-instructions.md, etc.)</p>
            {% endif %}
        </div>

        <!-- Git panel -->
        <div class="ps-section" id="git-panel"
             hx-get="/api/projects/{{ project.id }}/git"
             hx-trigger="load, every 30s"
             hx-swap="innerHTML">
            <p class="ps-empty">Loading git…</p>
        </div>

        <!-- Task panel -->
        <div class="ps-section" id="task-panel"
             hx-get="/api/projects/{{ project.id }}/tasks"
             hx-trigger="load, every 30s"
             hx-swap="innerHTML">
            <p class="ps-empty">Loading tasks…</p>
        </div>

        {% if project.factory_type in ('sf', 'mf') %}
        <div class="ps-section">
            <h4>Pipeline</h4>
            <div class="ps-pipeline">
                {% if project.factory_type == 'sf' %}
                    {% for step in ['Brain', 'TDD', 'Review', 'Build', 'Deploy'] %}
                    <span class="ps-pipe-step">{{ step }}</span>{% if not loop.last %}<span class="ps-pipe-arrow">→</span>{% endif %}
                    {% endfor %}
                {% else %}
                    {% for step in ['Analyze', 'Transform', 'Compare', 'Deploy'] %}
                    <span class="ps-pipe-step">{{ step }}</span>{% if not loop.last %}<span class="ps-pipe-arrow">→</span>{% endif %}
                    {% endfor %}
                {% endif %}
            </div>
        </div>
        {% endif %}

        {% if missions %}
        <div class="ps-section">
            <h4><svg class="icon icon-xs" style="vertical-align:middle"><use href="#icon-rocket"/></svg> Missions</h4>
            {% for m in missions %}
            <a href="/missions/{{ m.id }}" class="ps-workflow-card" style="text-decoration:none;display:block">
                <div style="display:flex;align-items:center;gap:0.4rem;margin-bottom:0.25rem">
                    <span class="status-dot {% if m.status == 'active' %}active{% elif m.status == 'completed' %}done{% else %}idle{% endif %}" style="width:7px;height:7px"></span>
                    <span class="ps-workflow-name" style="margin:0">{{ m.name }}</span>
                </div>
                {% if m.goal %}
                <div class="ps-workflow-desc">{{ m.goal[:80] }}{% if m.goal|length > 80 %}…{% endif %}</div>
                {% endif %}
            </a>
            {% endfor %}
            <a href="/missions?project={{ project.id }}&action=new" class="btn btn-sm btn-ghost" style="width:100%;margin-top:0.5rem">
                <svg class="icon icon-xs"><use href="#icon-plus"/></svg> Nouvelle Mission
            </a>
        </div>
        {% else %}
        <div class="ps-section">
            <h4><svg class="icon icon-xs" style="vertical-align:middle"><use href="#icon-rocket"/></svg> Missions</h4>
            <p class="ps-empty">Aucune mission</p>
            <a href="/missions?project={{ project.id }}&action=new" class="btn btn-sm btn-primary" style="width:100%">
                <svg class="icon icon-xs"><use href="#icon-plus"/></svg> Créer une mission
            </a>
        </div>
        {% endif %}

        {% if workflows %}
        <div class="ps-section">
            <h4><svg class="icon icon-xs" style="vertical-align:middle"><use href="#icon-workflow"/></svg> Workflows</h4>
            {% for witem in workflows %}
            <div class="ps-workflow-card">
                <div class="ps-workflow-name">{{ witem.wf.name }}</div>
                <div class="ps-workflow-desc">{{ witem.wf.description[:120] }}{% if witem.wf.description|length > 120 %}…{% endif %}</div>
                <div class="ps-workflow-actions">
                    {% if witem.session %}
                    <a href="/sessions/{{ witem.session.id }}/live" class="btn btn-sm btn-primary" title="Live multi-agent view">
                        <svg class="icon icon-xs"><use href="#icon-share"/></svg> Live
                    </a>
                    {% endif %}
                    <a href="/workflows/{{ witem.wf.id }}/edit" class="btn btn-sm btn-ghost" title="Edit workflow">
                        <svg class="icon icon-xs"><use href="#icon-edit"/></svg> Editor
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </aside>
</div>
{% endblock %}

{% block scripts %}
<script>
const PROJECT_ID = "{{ project.id }}";
const PROJECT_NAME = "{{ project.name }}";
const SESSION_ID = "{{ active_session.id if active_session else '' }}";
const AGENT_AVATAR = "{{ lead_agent.avatar if lead_agent and lead_agent.avatar else '' }}";
const AGENT_COLOR = "{{ lead_agent.color if lead_agent and lead_agent.color else '#bc8cff' }}";
const AGENT_NAME = "{{ lead_agent.name if lead_agent else project.name }}";
let chatBusy = false;

function scrollChat() {
    const el = document.getElementById('chat-messages');
    el.scrollTop = el.scrollHeight;
}

function addUserBubble(text) {
    const esc = text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    document.getElementById('chat-messages').insertAdjacentHTML('beforeend',
        `<div class="chat-msg chat-msg-user"><div class="chat-msg-body"><div class="chat-msg-text">${esc}</div></div><div class="chat-msg-avatar user">S</div></div>`);
    // Remove welcome screen
    const w = document.querySelector('.chat-welcome');
    if (w) w.remove();
    scrollChat();
}

function addStreamingBubble() {
    const id = 'stream-' + Date.now();
    const avatarHtml = AGENT_AVATAR
        ? `<div class="chat-msg-avatar agent-avatar-sm"><svg class="icon icon-sm" style="color:${AGENT_COLOR}"><use href="#icon-${AGENT_AVATAR}"/></svg></div>`
        : `<div class="chat-msg-avatar"><svg class="icon icon-sm"><use href="#icon-bot"/></svg></div>`;
    document.getElementById('chat-messages').insertAdjacentHTML('beforeend',
        `<div class="chat-msg chat-msg-agent" id="${id}">
            ${avatarHtml}
            <div class="chat-msg-body">
                <div class="chat-msg-sender">${AGENT_NAME}</div>
                <div class="chat-stream-status">
                    <div class="stream-dots"><span></span><span></span><span></span></div>
                    <span class="stream-label">Thinking…</span>
                </div>
                <div class="chat-msg-text md-rendered" style="display:none"></div>
                <div class="chat-msg-tools"></div>
            </div>
        </div>`);
    scrollChat();
    return id;
}

function updateStreamStatus(bubbleId, label) {
    const el = document.querySelector(`#${bubbleId} .stream-label`);
    if (el) el.textContent = label;
    scrollChat();
}

function addStreamTool(bubbleId, name) {
    const tools = document.querySelector(`#${bubbleId} .chat-msg-tools`);
    if (tools) {
        const esc = name.replace(/&/g,'&amp;').replace(/</g,'&lt;');
        tools.insertAdjacentHTML('beforeend', `<span class="chat-tool-pill"><svg class="icon icon-xs"><use href="#icon-wrench"/></svg> ${esc}</span>`);
    }
}

function finalizeStream(bubbleId, html) {
    const bubble = document.getElementById(bubbleId);
    if (!bubble) return;
    // Remove status indicator
    const status = bubble.querySelector('.chat-stream-status');
    if (status) status.remove();
    // Show rendered content
    const text = bubble.querySelector('.chat-msg-text');
    if (text) { text.innerHTML = html; text.style.display = ''; }
    scrollChat();
}

function failStream(bubbleId, error) {
    const bubble = document.getElementById(bubbleId);
    if (!bubble) return;
    const status = bubble.querySelector('.chat-stream-status');
    if (status) status.remove();
    const text = bubble.querySelector('.chat-msg-text');
    if (text) {
        text.innerHTML = `<p style="color:var(--text-secondary);opacity:.6">${error || 'Request failed'}</p>`;
        text.style.display = '';
    }
}

function toggleConversationList() {
    const list = document.getElementById('chat-conv-list');
    list.style.display = list.style.display === 'none' ? 'block' : 'none';
}

async function newConversation() {
    const resp = await fetch(`/api/projects/${PROJECT_ID}/conversations`, { method: 'POST' });
    if (resp.ok) {
        const data = await resp.json();
        window.location.href = `/projects/${PROJECT_ID}?session=${data.session_id}`;
    }
}

// Scroll to bottom on page load (existing messages)
document.addEventListener('DOMContentLoaded', () => { scrollChat(); });

async function sendChat() {
    if (chatBusy) return;
    const input = document.getElementById('chat-input');
    const content = input.value.trim();
    if (!content) return;

    chatBusy = true;
    input.value = '';
    input.style.height = 'auto';
    document.querySelector('.chat-send-btn').disabled = true;

    addUserBubble(content);
    const bubbleId = addStreamingBubble();

    try {
        const resp = await fetch(`/api/projects/${PROJECT_ID}/chat/stream`, {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: 'content=' + encodeURIComponent(content) + (SESSION_ID ? '&session_id=' + SESSION_ID : ''),
        });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);

        const reader = resp.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        while (true) {
            const {value, done} = await reader.read();
            if (done) break;
            buffer += decoder.decode(value, {stream: true});

            // Parse SSE lines
            const lines = buffer.split('\n');
            buffer = lines.pop();  // keep incomplete line

            let eventType = 'message';
            for (const line of lines) {
                if (line.startsWith('event: ')) {
                    eventType = line.slice(7).trim();
                } else if (line.startsWith('data: ')) {
                    const raw = line.slice(6);
                    try {
                        const data = JSON.parse(raw);
                        if (eventType === 'status') {
                            updateStreamStatus(bubbleId, data.label || 'Working…');
                        } else if (eventType === 'tool') {
                            addStreamTool(bubbleId, data.name || 'tool');
                            updateStreamStatus(bubbleId, data.label || 'Working…');
                        } else if (eventType === 'done') {
                            finalizeStream(bubbleId, data.html || '');
                        } else if (eventType === 'error') {
                            failStream(bubbleId, data.message || 'Error');
                        }
                    } catch(e) {}
                    eventType = 'message';
                }
            }
        }
        // If stream closed without 'done', check if we got content
        if (document.querySelector(`#${bubbleId} .chat-stream-status`)) {
            failStream(bubbleId, 'Stream ended unexpectedly');
        }
    } catch(e) {
        failStream(bubbleId, e.message || 'Network error');
    } finally {
        chatBusy = false;
        document.querySelector('.chat-send-btn').disabled = false;
        input.focus();
    }
}
</script>
{% endblock %}
