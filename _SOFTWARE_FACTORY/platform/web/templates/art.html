{% extends "base.html" %}

{% block content %}
<style>
.art-dash{display:flex;flex-direction:column;gap:1.2rem}
.art-kpis{display:grid;grid-template-columns:repeat(5,1fr);gap:0.7rem;margin-bottom:0.5rem}
@media(max-width:800px){.art-kpis{grid-template-columns:repeat(2,1fr)}}
.art-kpi{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);padding:0.6rem 0.8rem;text-align:center}
.art-kpi .num{font-size:1.4rem;font-weight:800;color:var(--purple)}
.art-kpi .lbl{font-size:0.62rem;color:var(--text-muted);margin-top:0.1rem;text-transform:uppercase;letter-spacing:0.03em}

.art-portfolio{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.art-portfolio-header{display:flex;align-items:center;justify-content:space-between;padding:0.65rem 1rem;background:rgba(124,58,237,.08);border-bottom:1px solid var(--border)}
.art-portfolio-title{font-size:0.85rem;font-weight:700;display:flex;align-items:center;gap:0.5rem}
.art-portfolio-title svg{width:16px;height:16px;color:var(--purple)}
.art-budget{font-size:0.68rem;display:flex;gap:0.8rem;align-items:center;color:var(--text-muted)}
.art-budget-bar{width:100px;height:5px;background:var(--bg-tertiary);border-radius:3px;overflow:hidden}
.art-budget-fill{height:100%;border-radius:3px}

.art-section{padding:0.6rem 0.8rem}
.art-block{margin-bottom:1rem;padding:0.6rem 0.7rem;background:var(--bg-tertiary);border-radius:8px;border-left:3px solid var(--blue)}
.art-block[data-type="security"]{border-left-color:var(--red)}
.art-block[data-type="rse"]{border-left-color:var(--green)}
.art-block-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:0.5rem}
.art-block-title{font-size:0.8rem;font-weight:700;display:flex;align-items:center;gap:0.4rem}
.art-block-title svg{width:14px;height:14px}
.art-block-meta{font-size:0.6rem;color:var(--text-muted)}
.art-block-lead{font-size:0.6rem;color:var(--text-secondary);margin-top:0.1rem}

.art-teams{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:0.6rem}
.art-team{padding:0.6rem;background:var(--bg-secondary);border-radius:8px;border:1px solid var(--border);transition:border-color .15s}
.art-team:hover{border-color:var(--purple-dim)}
.art-team-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:0.2rem}
.art-team-name{font-size:0.75rem;font-weight:700;color:var(--text-primary)}
.art-team-badges{display:flex;gap:0.3rem;align-items:center}
.art-team-badge{font-size:0.5rem;padding:0.1rem 0.35rem;border-radius:3px;font-weight:600}
.badge-wip{background:rgba(250,204,21,.12);color:#eab308}
.badge-cap{background:rgba(59,130,246,.12);color:var(--blue)}
.art-team-sm{font-size:0.58rem;color:var(--purple-light);margin-bottom:0.4rem}

.art-members{display:flex;flex-direction:column;gap:0.2rem}
.art-member{display:flex;align-items:center;gap:0.45rem;padding:0.2rem 0.35rem;border-radius:5px;transition:background .15s}
.art-member:hover{background:rgba(124,58,237,.06)}
.art-member-avatar{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.55rem;font-weight:700;color:#fff;flex-shrink:0;overflow:hidden}
.art-member-avatar img{width:100%;height:100%;object-fit:cover;border-radius:50%}
.art-member-info{flex:1;min-width:0}
.art-member-name{font-size:0.7rem;font-weight:600;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.art-member-tagline{font-size:0.55rem;color:var(--text-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.art-role{font-size:0.48rem;padding:0.08rem 0.3rem;border-radius:3px;font-weight:700;text-transform:uppercase;letter-spacing:0.03em;flex-shrink:0}
.r-lead{background:rgba(168,85,247,.15);color:var(--purple-light)}
.r-qa{background:rgba(250,204,21,.12);color:#eab308}
.r-devops,.r-sre,.r-cloud,.r-secops{background:rgba(59,130,246,.12);color:var(--blue)}
.r-security,.r-exploit,.r-threat-intel,.r-governance,.r-analyst,.r-review,.r-compliance{background:rgba(239,68,68,.12);color:var(--red)}
.r-data,.r-dba,.r-ml,.r-perf{background:rgba(16,185,129,.12);color:var(--green)}
.r-a11y,.r-docs,.r-ux,.r-social,.r-ethique{background:rgba(244,114,182,.12);color:#f472b6}
.r-legal{background:rgba(168,85,247,.12);color:var(--purple-light)}
.r-default{background:rgba(148,163,184,.1);color:var(--text-secondary)}
</style>

<div class="art-dash">
    <!-- KPIs -->
    <div class="art-kpis">
        <div class="art-kpi"><div class="num">{{ portfolios|length }}</div><div class="lbl">Portfolios</div></div>
        <div class="art-kpi"><div class="num">{{ total_arts }}</div><div class="lbl">ARTs</div></div>
        <div class="art-kpi"><div class="num">{{ total_teams }}</div><div class="lbl">Équipes</div></div>
        <div class="art-kpi"><div class="num">{{ total_members }}</div><div class="lbl">Agents</div></div>
        <div class="art-kpi"><div class="num">{{ total_teams * 10 }}</div><div class="lbl">PI Weeks</div></div>
    </div>

    <!-- Org Tree -->
    {% for p in org_tree %}
    <div class="art-portfolio">
        <div class="art-portfolio-header">
            <div class="art-portfolio-title">
                <svg><use href="#icon-briefcase"/></svg>
                {{ p.name }}
                {% if p.lead %}<span style="font-weight:400;font-size:0.68rem;color:var(--text-muted)">— {{ p.lead }}</span>{% endif %}
            </div>
            <div class="art-budget">
                {% set pct = ((p.budget_consumed / p.budget * 100)|int) if p.budget > 0 else 0 %}
                <span>{{ "%.0f"|format(p.budget_consumed/1000) }}k / {{ "%.0f"|format(p.budget/1000) }}k €</span>
                <div class="art-budget-bar">
                    <div class="art-budget-fill" style="width:{{ pct }}%;background:{% if pct > 80 %}var(--red){% elif pct > 60 %}var(--yellow){% else %}var(--green){% endif %}"></div>
                </div>
            </div>
        </div>
        <div class="art-section">
        {% for art in p.children %}
            {% set art_type = 'security' if 'Security' in art.name else ('rse' if 'RSE' in art.name else 'default') %}
            <div class="art-block" data-type="{{ art_type }}">
                <div class="art-block-header">
                    <div>
                        <div class="art-block-title" style="color:{% if art_type=='security' %}var(--red){% elif art_type=='rse' %}var(--green){% else %}var(--blue){% endif %}">
                            <svg class="icon-sm"><use href="#icon-{% if art_type=='security' %}shield{% elif art_type=='rse' %}heart{% else %}git-branch{% endif %}"/></svg>
                            {{ art.name }}
                        </div>
                        {% if art.lead %}<div class="art-block-lead">Lead: {{ art.lead }}</div>{% endif %}
                    </div>
                    <div class="art-block-meta">PI {{ art.pi_cadence }}w · {{ art.children|length }} teams · {{ art.children|sum(attribute='members'|length) if false else art.children|map(attribute='members')|map('length')|sum }} agents</div>
                </div>
                <div class="art-teams">
                {% for team in art.children %}
                    <div class="art-team">
                        <div class="art-team-header">
                            <div class="art-team-name">{{ team.name }}</div>
                            <div class="art-team-badges">
                                <span class="art-team-badge badge-wip">WIP {{ team.wip_limit }}</span>
                                <span class="art-team-badge badge-cap">{{ team.members|length }}/{{ team.capacity }}</span>
                            </div>
                        </div>
                        {% if team.scrum_master %}<div class="art-team-sm"><svg class="icon-xs"><use href="#icon-user"/></svg> {{ team.scrum_master }}</div>{% endif %}
                        <div class="art-members">
                        {% for m in team.members %}
                        <div class="art-member">
                            {% set bg = m.color if m.color else '#7c3aed' %}
                            <div class="art-member-avatar" style="background:{{ bg }}">
                                {% if m.avatar and '/' in m.avatar %}
                                    <img src="{{ m.avatar }}" alt="{{ m.name }}" loading="lazy">
                                {% else %}
                                    {{ m.avatar if m.avatar else m.name[:1]|upper }}
                                {% endif %}
                            </div>
                            <div class="art-member-info">
                                <div class="art-member-name">{{ m.name }}</div>
                                {% if m.tagline %}<div class="art-member-tagline">{{ m.tagline }}</div>{% endif %}
                            </div>
                            {% set r = m.role %}
                            <span class="art-role r-{% if r in ['lead','tech-lead'] %}lead{% elif r == 'qa' %}qa{% elif r in ['devops','sre','cloud'] %}devops{% elif r in ['security','exploit','threat-intel','governance','analyst','review','compliance'] %}security{% elif r in ['data','dba','ml','perf'] %}data{% elif r in ['a11y','docs','ux','social','ethique'] %}a11y{% elif r == 'legal' %}legal{% elif r in ['secops'] %}secops{% else %}default{% endif %}">{{ r }}</span>
                        </div>
                        {% endfor %}
                        </div>
                    </div>
                {% endfor %}
                </div>
            </div>
        {% endfor %}
        </div>
    </div>
    {% else %}
    <div style="text-align:center;padding:2rem;color:var(--text-muted);font-size:0.8rem">
        Aucune structure organisationnelle définie.
    </div>
    {% endfor %}
</div>
{% endblock %}
