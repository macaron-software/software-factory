{% extends "base.html" %}

{% block content %}
<style>
.art-dash{display:flex;flex-direction:column;gap:1.2rem}
.art-kpis{display:grid;grid-template-columns:repeat(5,1fr);gap:0.7rem;margin-bottom:0.5rem}
@media(max-width:800px){.art-kpis{grid-template-columns:repeat(2,1fr)}}
.art-kpi{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);padding:0.6rem 0.8rem;text-align:center}
.art-kpi .num{font-size:1.4rem;font-weight:800;color:var(--purple)}
.art-kpi .lbl{font-size:0.62rem;color:var(--text-muted);margin-top:0.1rem;text-transform:uppercase;letter-spacing:0.03em}

.art-portfolio{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.art-portfolio-header{display:flex;align-items:center;justify-content:space-between;padding:0.65rem 1rem;background:rgba(124,58,237,.08);border-bottom:1px solid var(--border)}
.art-portfolio-title{font-size:0.85rem;font-weight:700;display:flex;align-items:center;gap:0.5rem}
.art-portfolio-title svg{width:16px;height:16px;color:var(--purple)}
.art-budget{font-size:0.68rem;display:flex;gap:0.8rem;align-items:center;color:var(--text-muted)}
.art-budget-bar{width:100px;height:5px;background:var(--bg-tertiary);border-radius:3px;overflow:hidden}
.art-budget-fill{height:100%;border-radius:3px}

.art-section{padding:0.6rem 0.8rem}
.art-block{margin-bottom:1rem;padding:0.6rem 0.7rem;background:var(--bg-tertiary);border-radius:8px;border-left:3px solid var(--blue)}
.art-block[data-type="security"]{border-left-color:var(--red)}
.art-block[data-type="rse"]{border-left-color:var(--green)}
.art-block-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:0.5rem}
.art-block-title{font-size:0.8rem;font-weight:700;display:flex;align-items:center;gap:0.4rem}
.art-block-title svg{width:14px;height:14px}
.art-block-meta{font-size:0.6rem;color:var(--text-muted)}
.art-block-lead{font-size:0.6rem;color:var(--text-secondary);margin-top:0.1rem}

.art-teams{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:0.6rem}
.art-team{padding:0.6rem;background:var(--bg-secondary);border-radius:8px;border:1px solid var(--border);transition:border-color .15s}
.art-team:hover{border-color:var(--purple-dim)}
.art-team-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:0.2rem}
.art-team-name{font-size:0.75rem;font-weight:700;color:var(--text-primary)}
.art-team-badges{display:flex;gap:0.3rem;align-items:center}
.art-team-badge{font-size:0.5rem;padding:0.1rem 0.35rem;border-radius:3px;font-weight:600}
.badge-wip{background:rgba(250,204,21,.12);color:#eab308}
.badge-cap{background:rgba(59,130,246,.12);color:var(--blue)}
.art-team-sm{font-size:0.58rem;color:var(--purple-light);margin-bottom:0.4rem}

.art-members{display:flex;flex-direction:column;gap:0.2rem}
.art-member{display:flex;align-items:center;gap:0.45rem;padding:0.2rem 0.35rem;border-radius:5px;transition:background .15s}
.art-member:hover{background:rgba(124,58,237,.06)}
.art-member-avatar{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.55rem;font-weight:700;color:#fff;flex-shrink:0;overflow:hidden}
.art-member-avatar img{width:100%;height:100%;object-fit:cover;border-radius:50%}
.art-member-info{flex:1;min-width:0}
.art-member-name{font-size:0.7rem;font-weight:600;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.art-member-tagline{font-size:0.55rem;color:var(--text-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.art-role{font-size:0.48rem;padding:0.08rem 0.3rem;border-radius:3px;font-weight:700;text-transform:uppercase;letter-spacing:0.03em;flex-shrink:0}
.r-lead{background:rgba(168,85,247,.15);color:var(--purple-light)}
.r-qa{background:rgba(250,204,21,.12);color:#eab308}
.r-devops,.r-sre,.r-cloud,.r-secops{background:rgba(59,130,246,.12);color:var(--blue)}
.r-security,.r-exploit,.r-threat-intel,.r-governance,.r-analyst,.r-review,.r-compliance{background:rgba(239,68,68,.12);color:var(--red)}
.r-data,.r-dba,.r-ml,.r-perf{background:rgba(16,185,129,.12);color:var(--green)}
.r-a11y,.r-docs,.r-ux,.r-social,.r-ethique{background:rgba(244,114,182,.12);color:#f472b6}
.r-legal{background:rgba(168,85,247,.12);color:var(--purple-light)}
.r-default{background:rgba(148,163,184,.1);color:var(--text-secondary)}

/* ── Team Modal ── */
.art-team{cursor:pointer}
.art-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:900;opacity:0;pointer-events:none;transition:opacity .2s}
.art-overlay.open{opacity:1;pointer-events:auto}
.art-modal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(.96);z-index:910;background:var(--bg-secondary);border:1px solid var(--border);border-radius:12px;width:min(520px,92vw);max-height:85vh;overflow-y:auto;opacity:0;pointer-events:none;transition:opacity .2s,transform .2s;box-shadow:0 20px 60px rgba(0,0,0,.4)}
.art-modal.open{opacity:1;pointer-events:auto;transform:translate(-50%,-50%) scale(1)}
.art-modal-head{display:flex;align-items:center;justify-content:space-between;padding:0.8rem 1rem;border-bottom:1px solid var(--border);background:rgba(124,58,237,.06)}
.art-modal-head h3{font-size:0.85rem;font-weight:700;margin:0;display:flex;align-items:center;gap:0.4rem}
.art-modal-head h3 svg{width:15px;height:15px;color:var(--purple)}
.art-modal-close{background:none;border:none;color:var(--text-muted);cursor:pointer;padding:0.2rem;border-radius:4px;display:flex}
.art-modal-close:hover{color:var(--text-primary);background:var(--bg-tertiary)}
.art-modal-close svg{width:16px;height:16px}
.art-modal-meta{display:flex;gap:0.6rem;padding:0.5rem 1rem;font-size:0.62rem;color:var(--text-muted);border-bottom:1px solid var(--border)}
.art-modal-meta span{display:flex;align-items:center;gap:0.25rem}
.art-modal-meta svg{width:12px;height:12px}
.art-modal-members{padding:0.5rem 0.7rem}
.art-modal-member{display:flex;align-items:center;gap:0.6rem;padding:0.45rem 0.5rem;border-radius:8px;cursor:pointer;transition:background .15s}
.art-modal-member:hover{background:rgba(124,58,237,.08)}
.art-modal-member-av{width:38px;height:38px;border-radius:50%;flex-shrink:0;overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:0.65rem;font-weight:700;color:#fff}
.art-modal-member-av img{width:100%;height:100%;object-fit:cover}
.art-modal-member-info{flex:1;min-width:0}
.art-modal-member-name{font-size:0.75rem;font-weight:700;color:var(--text-primary)}
.art-modal-member-tag{font-size:0.6rem;color:var(--text-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.art-modal-member-role{font-size:0.5rem;padding:0.1rem 0.35rem;border-radius:3px;font-weight:700;text-transform:uppercase;flex-shrink:0;background:rgba(124,58,237,.12);color:var(--purple-light)}
.art-modal-member-arrow{color:var(--text-muted);flex-shrink:0}
.art-modal-member-arrow svg{width:14px;height:14px}

/* ── Agent Fiche Modal ── */
.fiche-modal{width:min(560px,92vw)}
.fiche-header{display:flex;gap:1rem;padding:1rem;border-bottom:1px solid var(--border)}
.fiche-photo{width:72px;height:72px;border-radius:50%;overflow:hidden;flex-shrink:0;border:3px solid var(--purple);display:flex;align-items:center;justify-content:center;font-size:1.2rem;font-weight:800;color:#fff}
.fiche-photo img{width:100%;height:100%;object-fit:cover}
.fiche-identity{flex:1;min-width:0}
.fiche-name{font-size:1rem;font-weight:800;color:var(--text-primary);margin-bottom:0.1rem}
.fiche-role{font-size:0.65rem;font-weight:700;color:var(--purple-light);text-transform:uppercase;letter-spacing:0.04em}
.fiche-tagline{font-size:0.7rem;color:var(--text-secondary);margin-top:0.2rem}
.fiche-rank{font-size:0.55rem;color:var(--text-muted);margin-top:0.15rem;display:flex;align-items:center;gap:0.3rem}
.fiche-rank svg{width:12px;height:12px}
.fiche-body{padding:0.7rem 1rem;display:flex;flex-direction:column;gap:0.7rem}
.fiche-section{background:var(--bg-tertiary);border-radius:8px;padding:0.55rem 0.7rem}
.fiche-section-title{font-size:0.6rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.04em;margin-bottom:0.3rem;display:flex;align-items:center;gap:0.3rem}
.fiche-section-title svg{width:12px;height:12px;color:var(--purple)}
.fiche-text{font-size:0.7rem;color:var(--text-secondary);line-height:1.5}
.fiche-badges{display:flex;flex-wrap:wrap;gap:0.25rem}
.fiche-badge{font-size:0.58rem;padding:0.15rem 0.4rem;border-radius:4px;font-weight:600;background:rgba(124,58,237,.1);color:var(--purple-light)}
.fiche-badge.tool{background:rgba(59,130,246,.1);color:var(--blue)}
.fiche-badge.tag{background:rgba(16,185,129,.1);color:var(--green)}
.fiche-perms{display:flex;gap:0.5rem;flex-wrap:wrap}
.fiche-perm{font-size:0.6rem;display:flex;align-items:center;gap:0.2rem;padding:0.15rem 0.4rem;border-radius:4px}
.fiche-perm.yes{background:rgba(16,185,129,.12);color:var(--green)}
.fiche-perm.no{background:rgba(148,163,184,.08);color:var(--text-muted)}
.fiche-perm svg{width:11px;height:11px}
.fiche-loading{text-align:center;padding:2rem;color:var(--text-muted);font-size:0.75rem}
</style>

<div class="art-dash">
    <!-- KPIs -->
    <div class="art-kpis">
        <div class="art-kpi"><div class="num">{{ portfolios|length }}</div><div class="lbl">Portfolios</div></div>
        <div class="art-kpi"><div class="num">{{ total_arts }}</div><div class="lbl">ARTs</div></div>
        <div class="art-kpi"><div class="num">{{ total_teams }}</div><div class="lbl">Équipes</div></div>
        <div class="art-kpi"><div class="num">{{ total_members }}</div><div class="lbl">Agents</div></div>
        <div class="art-kpi"><div class="num">{{ total_teams * 10 }}</div><div class="lbl">PI Weeks</div></div>
    </div>

    <!-- Org Tree -->
    {% for p in org_tree %}
    <div class="art-portfolio">
        <div class="art-portfolio-header">
            <div class="art-portfolio-title">
                <svg><use href="#icon-briefcase"/></svg>
                {{ p.name }}
                {% if p.lead %}<span style="font-weight:400;font-size:0.68rem;color:var(--text-muted)">— {{ p.lead }}</span>{% endif %}
            </div>
            <div class="art-budget">
                {% set pct = ((p.budget_consumed / p.budget * 100)|int) if p.budget > 0 else 0 %}
                <span>{{ "%.0f"|format(p.budget_consumed/1000) }}k / {{ "%.0f"|format(p.budget/1000) }}k €</span>
                <div class="art-budget-bar">
                    <div class="art-budget-fill" style="width:{{ pct }}%;background:{% if pct > 80 %}var(--red){% elif pct > 60 %}var(--yellow){% else %}var(--green){% endif %}"></div>
                </div>
            </div>
        </div>
        <div class="art-section">
        {% for art in p.children %}
            {% set art_type = 'security' if 'Security' in art.name else ('rse' if 'RSE' in art.name else 'default') %}
            <div class="art-block" data-type="{{ art_type }}">
                <div class="art-block-header">
                    <div>
                        <div class="art-block-title" style="color:{% if art_type=='security' %}var(--red){% elif art_type=='rse' %}var(--green){% else %}var(--blue){% endif %}">
                            <svg class="icon-sm"><use href="#icon-{% if art_type=='security' %}shield{% elif art_type=='rse' %}heart{% else %}git-branch{% endif %}"/></svg>
                            {{ art.name }}
                        </div>
                        {% if art.lead %}<div class="art-block-lead">Lead: {{ art.lead }}</div>{% endif %}
                    </div>
                    <div class="art-block-meta">PI {{ art.pi_cadence }}w · {{ art.children|length }} teams · {{ art.children|sum(attribute='members'|length) if false else art.children|map(attribute='members')|map('length')|sum }} agents</div>
                </div>
                <div class="art-teams">
                {% for team in art.children %}
                    <div class="art-team">
                        <div class="art-team-header">
                            <div class="art-team-name">{{ team.name }}</div>
                            <div class="art-team-badges">
                                <span class="art-team-badge badge-wip">WIP {{ team.wip_limit }}</span>
                                <span class="art-team-badge badge-cap">{{ team.members|length }}/{{ team.capacity }}</span>
                            </div>
                        </div>
                        {% if team.scrum_master %}<div class="art-team-sm"><svg class="icon-xs"><use href="#icon-user"/></svg> {{ team.scrum_master }}</div>{% endif %}
                        <div class="art-members">
                        {% for m in team.members %}
                        <div class="art-member" data-agent-id="{{ m.agent_id }}">
                            {% set bg = m.color if m.color else '#7c3aed' %}
                            <div class="art-member-avatar" style="background:{{ bg }}">
                                {% if m.avatar and '/' in m.avatar %}
                                    <img src="{{ m.avatar }}" alt="{{ m.name }}" loading="lazy">
                                {% else %}
                                    {{ m.avatar if m.avatar else m.name[:1]|upper }}
                                {% endif %}
                            </div>
                            <div class="art-member-info">
                                <div class="art-member-name">{{ m.name }}</div>
                                {% if m.tagline %}<div class="art-member-tagline">{{ m.tagline }}</div>{% endif %}
                            </div>
                            {% set r = m.role %}
                            <span class="art-role r-{% if r in ['lead','tech-lead'] %}lead{% elif r == 'qa' %}qa{% elif r in ['devops','sre','cloud'] %}devops{% elif r in ['security','exploit','threat-intel','governance','analyst','review','compliance'] %}security{% elif r in ['data','dba','ml','perf'] %}data{% elif r in ['a11y','docs','ux','social','ethique'] %}a11y{% elif r == 'legal' %}legal{% elif r in ['secops'] %}secops{% else %}default{% endif %}">{{ r }}</span>
                        </div>
                        {% endfor %}
                        </div>
                    </div>
                {% endfor %}
                </div>
            </div>
        {% endfor %}
        </div>
    </div>
    {% else %}
    <div style="text-align:center;padding:2rem;color:var(--text-muted);font-size:0.8rem">
        Aucune structure organisationnelle définie.
    </div>
    {% endfor %}
</div>

<!-- Overlay -->
<div class="art-overlay" id="artOverlay" onclick="closeAllModals()"></div>

<!-- Team Detail Modal -->
<div class="art-modal" id="teamModal">
    <div class="art-modal-head">
        <h3><svg><use href="#icon-users"/></svg> <span id="tmName"></span></h3>
        <button class="art-modal-close" onclick="closeAllModals()"><svg><use href="#icon-x"/></svg></button>
    </div>
    <div class="art-modal-meta" id="tmMeta"></div>
    <div class="art-modal-members" id="tmMembers"></div>
</div>

<!-- Agent Fiche Modal -->
<div class="art-modal fiche-modal" id="ficheModal">
    <div class="art-modal-head">
        <h3><svg><use href="#icon-user"/></svg> <span id="fhTitle">Agent</span></h3>
        <button class="art-modal-close" onclick="closeFiche()"><svg><use href="#icon-x"/></svg></button>
    </div>
    <div id="fhContent"><div class="fiche-loading">Chargement...</div></div>
</div>

{% endblock %}

{% block scripts %}
<script>
(function(){
  const overlay = document.getElementById('artOverlay');
  const teamModal = document.getElementById('teamModal');
  const ficheModal = document.getElementById('ficheModal');

  // Attach click on each .art-team card
  document.querySelectorAll('.art-team').forEach(card => {
    card.addEventListener('click', () => {
      const name = card.querySelector('.art-team-name').textContent.trim();
      const sm = card.querySelector('.art-team-sm');
      const badges = card.querySelector('.art-team-badges');
      const members = card.querySelectorAll('.art-member');

      document.getElementById('tmName').textContent = name;

      // Meta bar
      const metaEl = document.getElementById('tmMeta');
      const wipBadge = badges ? badges.querySelector('.badge-wip') : null;
      const capBadge = badges ? badges.querySelector('.badge-cap') : null;
      let metaHTML = '';
      if (wipBadge) metaHTML += `<span><svg><use href="#icon-alert-triangle"/></svg> ${wipBadge.textContent.trim()}</span>`;
      if (capBadge) metaHTML += `<span><svg><use href="#icon-users"/></svg> Capacité ${capBadge.textContent.trim()}</span>`;
      if (sm) metaHTML += `<span><svg><use href="#icon-user"/></svg> SM: ${sm.textContent.trim()}</span>`;
      metaEl.innerHTML = metaHTML;

      // Members list
      const mbEl = document.getElementById('tmMembers');
      let mbHTML = '';
      members.forEach(m => {
        const avatarEl = m.querySelector('.art-member-avatar');
        const img = avatarEl.querySelector('img');
        const bg = avatarEl.style.background || '#7c3aed';
        const initials = img ? '' : avatarEl.textContent.trim();
        const avatarSrc = img ? img.src : '';
        const nameText = m.querySelector('.art-member-name').textContent.trim();
        const tagEl = m.querySelector('.art-member-tagline');
        const tagText = tagEl ? tagEl.textContent.trim() : '';
        const roleEl = m.querySelector('.art-role');
        const roleText = roleEl ? roleEl.textContent.trim() : '';
        // Extract agent_id from the member data
        const agentId = m.dataset.agentId || '';

        mbHTML += `<div class="art-modal-member" onclick="openFiche('${agentId}')" title="Voir la fiche">`;
        if (avatarSrc) {
          mbHTML += `<div class="art-modal-member-av" style="background:${bg}"><img src="${avatarSrc}" alt="${nameText}" loading="lazy"></div>`;
        } else {
          mbHTML += `<div class="art-modal-member-av" style="background:${bg}">${initials}</div>`;
        }
        mbHTML += `<div class="art-modal-member-info"><div class="art-modal-member-name">${nameText}</div>`;
        if (tagText) mbHTML += `<div class="art-modal-member-tag">${tagText}</div>`;
        mbHTML += `</div>`;
        if (roleText) mbHTML += `<span class="art-modal-member-role">${roleText}</span>`;
        mbHTML += `<div class="art-modal-member-arrow"><svg><use href="#icon-chevron-right"/></svg></div></div>`;
      });
      mbEl.innerHTML = mbHTML;

      // Open
      overlay.classList.add('open');
      teamModal.classList.add('open');
      ficheModal.classList.remove('open');
    });
  });

  // Agent fiche
  window.openFiche = async function(agentId) {
    if (!agentId) return;
    const content = document.getElementById('fhContent');
    content.innerHTML = '<div class="fiche-loading">Chargement...</div>';
    ficheModal.classList.add('open');
    teamModal.classList.remove('open');
    document.getElementById('fhTitle').textContent = 'Agent';

    try {
      const resp = await fetch(`/api/agents/${agentId}/details`);
      if (!resp.ok) throw new Error('Not found');
      const a = await resp.json();

      document.getElementById('fhTitle').textContent = a.name;

      const rankLabels = {0:'CEO',10:'VP/Director',15:'Program',20:'Manager',25:'Lead',30:'Senior',35:'Mid',40:'Junior',50:'Intern'};
      const rankLabel = rankLabels[a.hierarchy_rank] || `Niveau ${a.hierarchy_rank}`;

      let html = '<div class="fiche-header">';
      if (a.avatar_url) {
        html += `<div class="fiche-photo" style="background:${a.color}"><img src="${a.avatar_url}" alt="${a.name}"></div>`;
      } else {
        html += `<div class="fiche-photo" style="background:${a.color}">${a.name.charAt(0)}</div>`;
      }
      html += `<div class="fiche-identity">`;
      html += `<div class="fiche-name">${a.name}</div>`;
      html += `<div class="fiche-role">${a.role}</div>`;
      if (a.tagline) html += `<div class="fiche-tagline">${a.tagline}</div>`;
      html += `<div class="fiche-rank"><svg><use href="#icon-bar-chart-2"/></svg> ${rankLabel}</div>`;
      html += `</div></div>`;

      html += '<div class="fiche-body">';

      if (a.persona) {
        html += `<div class="fiche-section"><div class="fiche-section-title"><svg><use href="#icon-user"/></svg> Persona</div><div class="fiche-text">${esc(a.persona)}</div></div>`;
      }
      if (a.motivation) {
        html += `<div class="fiche-section"><div class="fiche-section-title"><svg><use href="#icon-zap"/></svg> Motivation</div><div class="fiche-text">${esc(a.motivation)}</div></div>`;
      }
      if (a.description) {
        html += `<div class="fiche-section"><div class="fiche-section-title"><svg><use href="#icon-file-text"/></svg> Description</div><div class="fiche-text">${esc(a.description)}</div></div>`;
      }
      if (a.skills && a.skills.length) {
        html += `<div class="fiche-section"><div class="fiche-section-title"><svg><use href="#icon-star"/></svg> Skills (${a.skills.length})</div><div class="fiche-badges">`;
        a.skills.forEach(s => { html += `<span class="fiche-badge">${esc(s)}</span>`; });
        html += `</div></div>`;
      }
      if (a.tools && a.tools.length) {
        html += `<div class="fiche-section"><div class="fiche-section-title"><svg><use href="#icon-tool"/></svg> Tools (${a.tools.length})</div><div class="fiche-badges">`;
        a.tools.forEach(t => { html += `<span class="fiche-badge tool">${esc(t)}</span>`; });
        html += `</div></div>`;
      }
      if (a.tags && a.tags.length) {
        html += `<div class="fiche-section"><div class="fiche-section-title"><svg><use href="#icon-tag"/></svg> Tags</div><div class="fiche-badges">`;
        a.tags.forEach(t => { html += `<span class="fiche-badge tag">${esc(t)}</span>`; });
        html += `</div></div>`;
      }
      // Permissions
      const perms = a.permissions || {};
      html += `<div class="fiche-section"><div class="fiche-section-title"><svg><use href="#icon-shield"/></svg> Permissions</div><div class="fiche-perms">`;
      ['can_veto','can_approve','can_delegate'].forEach(p => {
        const yes = !!perms[p];
        const label = p.replace('can_','').charAt(0).toUpperCase() + p.replace('can_','').slice(1);
        html += `<span class="fiche-perm ${yes?'yes':'no'}"><svg><use href="#icon-${yes?'check':'x'}"/></svg> ${label}</span>`;
      });
      html += `</div></div>`;

      if (a.provider || a.model) {
        html += `<div class="fiche-section"><div class="fiche-section-title"><svg><use href="#icon-cpu"/></svg> LLM</div><div class="fiche-text">${esc(a.provider || '')} ${esc(a.model || '')}</div></div>`;
      }

      html += '</div>';
      content.innerHTML = html;
    } catch(e) {
      content.innerHTML = '<div class="fiche-loading">Agent introuvable</div>';
    }
  };

  window.closeFiche = function() {
    ficheModal.classList.remove('open');
    teamModal.classList.add('open');
  };

  window.closeAllModals = function() {
    overlay.classList.remove('open');
    teamModal.classList.remove('open');
    ficheModal.classList.remove('open');
  };

  // ESC key
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
      if (ficheModal.classList.contains('open')) { closeFiche(); }
      else { closeAllModals(); }
    }
  });

  function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
})();
</script>
{% endblock %}
