# Fervenza Project Configuration
# ===============================
# IoT/Embedded project

project:
  name: fervenza
  display_name: "Fervenza IoT Platform"
  root_path: /Users/sylvain/_MACARON-SOFTWARE/Fervenza
  vision_doc: CLAUDE.md

# Project CLI commands
# NOTE: `fervenza` CLI is for BUSINESS operations (weddings), not build/test
# Build/test uses direct commands (cargo, pytest, ruff) from root_path
cli:
  binary: fervenza
  build:
    rust: cargo check --workspace
    python: ruff check .
    all: cargo check --workspace
  test:
    rust: cargo test --workspace
    python: pytest
    e2e: pytest tests/
    all: cargo test --workspace && pytest
  lint:
    rust: cargo clippy --workspace -- -D warnings
    python: ruff check . --fix
    all: cargo clippy --workspace && ruff check .
  deploy:
    staging: fervenza deploy server
    prod: fervenza deploy all
    rollback: fervenza deploy rollback
  e2e:
    smoke: pytest tests/
    journeys: pytest tests/
  status: fervenza version

# Domain configurations
# Direct commands (no fervenza CLI for builds)
domains:
  rust:
    paths:
      - crates/
    extensions:
      - .rs
    build_cmd: cargo check --workspace
    test_cmd: cargo test --workspace
    lint_cmd: cargo clippy --workspace -- -D warnings

  firmware:
    paths:
      - firmware/
    extensions:
      - .c
      - .h
      - .cpp
    # Firmware requires hardware toolchain (PlatformIO / arm-gcc)
    build_cmd: "cd firmware && pio check 2>/dev/null || echo 'SKIP - PlatformIO not installed'"
    test_cmd: "cd firmware && pio test 2>/dev/null || echo 'SKIP - PlatformIO not installed'"
    lint_cmd: "cd firmware && pio check 2>/dev/null || echo 'SKIP - PlatformIO not installed'"

  backend:
    paths:
      - backend/
    extensions:
      - .rs
      - .py
    build_cmd: cargo check --workspace
    test_cmd: cargo test --workspace
    lint_cmd: cargo clippy --workspace

  webapp:
    paths:
      - webapp/
    extensions:
      - .ts
      - .tsx
      - .svelte
    build_cmd: cd webapp && npm run build
    test_cmd: pytest tests/
    lint_cmd: ruff check .

  e2e:
    paths:
      - tests/
    extensions:
      - .spec.ts
    build_cmd: cargo check --workspace
    test_cmd: pytest tests/
    lint_cmd: ruff check tests/

  python:
    paths:
      - fervenza/
      - tests/
    extensions:
      - .py
    build_cmd: ruff check .
    test_cmd: pytest
    lint_cmd: ruff check . --fix

# Deployment configuration
deploy:
  strategy: blue-green
  auto_prod: true       # AUTO deploy enabled
  staging:
    url: https://staging.fervenza.io
    health: /api/health
  prod:
    url: https://fervenza.io
    health: /api/health
  rollback_on_fail: true
  post_deploy:
    e2e_prod:
      enabled: true
      smoke: true
      journeys: false
      rbac: false
      console_check: true
      pages: ["/", "/api/health"]
      console_whitelist: ["chrome-extension://"]
      network_whitelist: []
      timeout_sec: 300
    tmc:
      enabled: false
    chaos:
      enabled: false

# FRACTAL decomposition thresholds
fractal:
  max_files: 5
  max_loc: 400
  max_items: 10
  max_depth: 3

# Adversarial gate configuration
adversarial:
  # Threshold elevated to 20 to account for pre-existing patterns in webapp
  # TypeScript 'any' types exist in legacy code
  threshold: 20
  core_patterns: true
  custom_patterns:
    # Firmware specific
    - pattern: 'malloc\s*\('
      score: 2
      message: "malloc sans free potentiel - vérifier memory leaks"
    - pattern: 'strcpy\s*\('
      score: 5
      message: "strcpy dangereux - utiliser strncpy"
    - pattern: 'sprintf\s*\('
      score: 3
      message: "sprintf dangereux - utiliser snprintf"
    # Security
    - pattern: "password\\s*=\\s*[\"'][^\"']+[\"']"
      score: 5
      message: "Password hardcodée détectée"

# Error Capture Configuration (RLM Feedback Loop)
error_capture:
  enabled: true
  feedback_to_backlog: true
  deduplicate: true

  build:
    enabled: true
    domains: [rust, firmware, backend, webapp, python]

  e2e:
    enabled: true
    playwright:
      report_path: tests/playwright-report/
      fail_on_console_error: true
      capture_grpc: true

  mobile:
    enabled: false  # IoT platform - no mobile apps

  severity:
    create_task_min: medium

# Active analyzers
analyzers:
  - rust
  - typescript
  - security

# Integrator (cross-layer wiring)
integrator:
  enabled: true
  verify_timeout: 300
  max_iterations: 5
  priority_types:
    - bootstrap
    - config
