# Fervenza Project Configuration
# ===============================
# IoT/Embedded project

project:
  name: fervenza
  display_name: "Fervenza IoT Platform"
  root_path: /Users/sylvain/_MACARON-SOFTWARE/Fervenza
  vision_doc: CLAUDE.md

# Project CLI commands
# Uses `fervenza` CLI for all operations
cli:
  binary: fervenza
  # Build commands per domain
  build:
    firmware: fervenza build firmware
    backend: fervenza build backend
    webapp: fervenza build webapp
    all: fervenza build
  # Test commands per domain
  test:
    firmware: fervenza test firmware
    backend: fervenza test backend
    webapp: fervenza test webapp
    integration: fervenza test integration
    all: fervenza test
  # Lint commands
  lint:
    firmware: fervenza lint firmware
    backend: fervenza lint backend
    webapp: fervenza lint webapp
    all: fervenza lint
  # Deploy commands
  deploy:
    staging: fervenza deploy staging
    prod: fervenza deploy prod
    rollback: fervenza deploy rollback
    firmware_ota: fervenza deploy firmware --ota
  # E2E journeys
  e2e:
    smoke: fervenza test e2e --grep @smoke
    journeys: fervenza test e2e
    device: fervenza test device
  # Status/monitoring
  status: fervenza status
  devices: fervenza devices list

# Domain configurations
domains:
  rust:
    paths:
      - src/
      - backend/
    extensions:
      - .rs
    build_cmd: cargo check 2>/dev/null || true
    test_cmd: cargo test 2>/dev/null || true
    lint_cmd: cargo clippy 2>/dev/null || true

  firmware:
    paths:
      - firmware/
    extensions:
      - .c
      - .h
      - .cpp
    build_cmd: cd firmware && make 2>/dev/null || echo "No Makefile"
    test_cmd: echo "Firmware tests require hardware"
    lint_cmd: echo "Firmware lint OK"

  backend:
    paths:
      - backend/
    extensions:
      - .rs
      - .py
    build_cmd: cd backend && (cargo check 2>/dev/null || python3 -m py_compile *.py 2>/dev/null || true)
    test_cmd: cd backend && (cargo test 2>/dev/null || pytest -q 2>/dev/null || true)
    lint_cmd: cd backend && (cargo clippy 2>/dev/null || ruff check . 2>/dev/null || true)

  webapp:
    paths:
      - webapp/
    extensions:
      - .ts
      - .tsx
      - .svelte
    build_cmd: cd webapp && npm run build --if-present 2>/dev/null || npx tsc --noEmit 2>/dev/null || true
    test_cmd: cd webapp && npm test --if-present 2>/dev/null || true
    lint_cmd: cd webapp && npm run lint 2>/dev/null || npx eslint . 2>/dev/null || true

  e2e:
    paths:
      - tests/
    extensions:
      - .spec.ts
    build_cmd: echo "E2E tests ready"
    test_cmd: cd tests && npx playwright test 2>/dev/null || true
    lint_cmd: cd tests && npx eslint . 2>/dev/null || true

  python:
    paths:
      - rlm/
      - tests/
    extensions:
      - .py
    build_cmd: python3 -c "import compileall; compileall.compile_dir('.', force=True, quiet=2)" 2>/dev/null || true
    test_cmd: pytest tests/ -q 2>/dev/null || true
    lint_cmd: ruff check . 2>/dev/null || true

# Deployment configuration
deploy:
  strategy: blue-green
  auto_prod: false
  staging:
    url: https://staging.fervenza.io
    health: /api/health
  prod:
    url: https://fervenza.io
    health: /api/health
  rollback_on_fail: true

# FRACTAL decomposition thresholds
fractal:
  max_files: 5
  max_loc: 400
  max_items: 10
  max_depth: 3

# Adversarial gate configuration
adversarial:
  # Threshold elevated to 20 to account for pre-existing patterns in webapp
  # TypeScript 'any' types exist in legacy code
  threshold: 20
  core_patterns: true
  custom_patterns:
    # Firmware specific
    - pattern: 'malloc\s*\('
      score: 2
      message: "malloc sans free potentiel - vérifier memory leaks"
    - pattern: 'strcpy\s*\('
      score: 5
      message: "strcpy dangereux - utiliser strncpy"
    - pattern: 'sprintf\s*\('
      score: 3
      message: "sprintf dangereux - utiliser snprintf"
    # Security
    - pattern: "password\\s*=\\s*[\"'][^\"']+[\"']"
      score: 5
      message: "Password hardcodée détectée"

# Error Capture Configuration (RLM Feedback Loop)
error_capture:
  enabled: true
  feedback_to_backlog: true
  deduplicate: true

  build:
    enabled: true
    domains: [rust, firmware, backend, webapp, python]

  e2e:
    enabled: true
    playwright:
      report_path: tests/playwright-report/
      fail_on_console_error: true
      capture_grpc: true

  mobile:
    enabled: false  # IoT platform - no mobile apps

  severity:
    create_task_min: medium

# Active analyzers
analyzers:
  - rust
  - typescript
  - security
