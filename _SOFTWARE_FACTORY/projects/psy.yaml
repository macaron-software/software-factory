# PSY (Macaron-Software) Project Configuration
# =============================================
# Platform for psychologists - Multi-brand therapy software

project:
  name: psy
  display_name: "Macaron-Software PSY Platform"
  root_path: /Users/sylvain/_MACARON-SOFTWARE/_PSY
  vision_doc: CLAUDE.md

# Domain configurations
domains:
  rust:
    paths:
      - backend/
    extensions:
      - .rs
    build_cmd: cd backend && cargo check 2>/dev/null || true
    test_cmd: cd backend && cargo test 2>/dev/null || true
    lint_cmd: cd backend && cargo clippy 2>/dev/null || true

  proto:
    paths:
      - backend/proto/
    extensions:
      - .proto
    build_cmd: echo "Proto build via Rust"
    test_cmd: echo "Proto tests via Rust"
    lint_cmd: buf lint backend/proto/ 2>/dev/null || echo "Proto lint OK"

  svelte:
    paths:
      - ms-dashboard/
    extensions:
      - .svelte
      - .ts
    build_cmd: cd ms-dashboard && npm run build --if-present 2>/dev/null || npx svelte-kit sync 2>/dev/null || true
    test_cmd: cd ms-dashboard && npm run test:unit 2>/dev/null || true
    lint_cmd: cd ms-dashboard && npm run lint 2>/dev/null || npx eslint . 2>/dev/null || true

  patient-web:
    paths:
      - patient-web/
    extensions:
      - .ts
      - .tsx
    build_cmd: cd patient-web && npm run build --if-present 2>/dev/null || npx tsc --noEmit 2>/dev/null || true
    test_cmd: cd patient-web && npm test --if-present 2>/dev/null || true
    lint_cmd: cd patient-web && npm run lint 2>/dev/null || npx eslint . 2>/dev/null || true

  admin:
    paths:
      - admin-dashboard/
    extensions:
      - .ts
      - .tsx
    build_cmd: cd admin-dashboard && npm run build --if-present 2>/dev/null || npx tsc --noEmit 2>/dev/null || true
    test_cmd: cd admin-dashboard && npm test --if-present 2>/dev/null || true
    lint_cmd: cd admin-dashboard && npm run lint 2>/dev/null || npx eslint . 2>/dev/null || true

  website:
    paths:
      - website/
    extensions:
      - .ts
    build_cmd: cd website && npm run build --if-present 2>/dev/null || npx wrangler deploy --dry-run 2>/dev/null || true
    test_cmd: cd website && npm test --if-present 2>/dev/null || true
    lint_cmd: cd website && npm run lint 2>/dev/null || npx eslint . 2>/dev/null || true

  e2e:
    paths:
      - ms-dashboard/tests/
    extensions:
      - .spec.ts
    build_cmd: echo "E2E tests ready"
    test_cmd: cd ms-dashboard && npx playwright test 2>/dev/null || true
    lint_cmd: cd ms-dashboard/tests && npx eslint . 2>/dev/null || true

  swift:
    paths:
      - ios/Macaron/
      - ios/LiactTests/
      - ios/LiactUITests/
    extensions:
      - .swift
    # Real Xcode build with error capture
    build_cmd: cd ios && xcodebuild -project LiACTApp.xcodeproj -scheme LiACTApp -destination 'platform=iOS Simulator,name=iPhone 15' -configuration Debug build 2>&1 | tee /tmp/psy_ios_build.log || cat /tmp/psy_ios_build.log
    test_cmd: cd ios && xcodebuild -project LiACTApp.xcodeproj -scheme LiACTApp -destination 'platform=iOS Simulator,name=iPhone 15' test 2>&1 | tee /tmp/psy_ios_test.log || cat /tmp/psy_ios_test.log
    lint_cmd: cd ios && swiftlint 2>&1 || true

  kotlin:
    paths:
      - android/app/
      - android/wear/
    extensions:
      - .kt
    # Real Gradle build with error capture
    build_cmd: cd android && ./gradlew assembleDebug 2>&1 | tee /tmp/psy_android_build.log || cat /tmp/psy_android_build.log
    test_cmd: cd android && ./gradlew test 2>&1 | tee /tmp/psy_android_test.log || cat /tmp/psy_android_test.log
    lint_cmd: cd android && ./gradlew lint 2>&1 || true

# Deployment configuration
deploy:
  strategy: blue-green
  auto_prod: false
  staging:
    url: https://staging.macaron-software.com
    health: /api/health
  prod:
    url: https://macaron-software.com
    health: /api/health
  rollback_on_fail: true

# FRACTAL decomposition thresholds
fractal:
  max_files: 5
  max_loc: 400
  max_items: 10
  max_depth: 3

# Adversarial gate configuration
adversarial:
  # Threshold set to 25 to account for existing codebase patterns
  threshold: 25
  core_patterns: true
  custom_patterns:
    # Rust safety
    - pattern: '\.unwrap\(\)'
      score: 1
      message: "unwrap() usage - consider error handling"
      max_occurrences: 5
    - pattern: 'panic!'
      score: 3
      message: "panic! usage - avoid in production code"
    # Security (medical data)
    - pattern: "patient.*password|password.*patient"
      score: 5
      message: "Potential patient credential exposure"
    - pattern: "api_key\\s*=\\s*[\"'][^\"']+[\"']"
      score: 5
      message: "Hardcoded API key detected"
    # Therapy data
    - pattern: "therapy_session.*export|dump.*session"
      score: 3
      message: "Therapy session data export - ensure GDPR compliance"

# Error Capture Configuration (RLM Feedback Loop)
error_capture:
  enabled: true
  feedback_to_backlog: true
  deduplicate: true

  build:
    enabled: true
    domains: [rust, proto, svelte, patient-web, admin, website, swift, kotlin]

  e2e:
    enabled: true
    playwright:
      report_path: ms-dashboard/playwright-report/
      fail_on_console_error: true
      capture_grpc: true  # Capture gRPC errors like INVALID_ARGUMENT

  mobile:
    enabled: true
    ios:
      bundle_id: com.macaron.liact
      capture_duration: 15
    android:
      package_name: com.macaron.liact
      capture_duration: 15

  severity:
    create_task_min: medium

# Active analyzers
analyzers:
  - rust
  - typescript
  - playwright
  - security
