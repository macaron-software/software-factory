# PSY (Macaron-Software) Project Configuration
# =============================================
# Platform for psychologists - Multi-brand therapy software

project:
  name: psy
  display_name: "Macaron-Software PSY Platform"
  root_path: /Users/sylvain/_MACARON-SOFTWARE/_PSY
  vision_doc: CLAUDE.md

# Domain configurations
domains:
  rust:
    paths:
      - backend/
    extensions:
      - .rs
    # psy CLI has test but not build/lint
    build_cmd: cd backend && SQLX_OFFLINE=true cargo check
    test_cmd: psy test unit
    lint_cmd: cd backend && SQLX_OFFLINE=true cargo clippy

  proto:
    paths:
      - backend/proto/
    extensions:
      - .proto
    build_cmd: cd backend && SQLX_OFFLINE=true cargo check
    test_cmd: psy test unit
    lint_cmd: buf lint backend/proto/

  svelte:
    paths:
      - ms-dashboard/
    extensions:
      - .svelte
      - .ts
    build_cmd: cd ms-dashboard && npm run build
    test_cmd: cd ms-dashboard && npm run test:unit
    lint_cmd: cd ms-dashboard && npm run lint
    conventions:
      - name: "NO test.skip"
        rule: "NEVER use test.skip(), describe.skip(), it.skip() - ALL tests MUST run"
        fix: "Remove .skip() and fix the test, or delete it if obsolete"
        example: |
          // WRONG: test.skip('should work', () => {})
          // CORRECT: test('should work', () => { expect(true).toBe(true) })
      - name: "NO as any"
        rule: "NEVER use 'as any' - it defeats TypeScript type safety"
        fix: "Use proper types, generics, or type guards instead"
        example: |
          // WRONG: (window as any).myProp
          // CORRECT: declare global { interface Window { myProp: string } }
          // CORRECT: if ('myProp' in window) { window.myProp }
      - name: "NO @ts-ignore"
        rule: "NEVER use @ts-ignore or @ts-expect-error without justification"
        fix: "Fix the type error properly or use proper type narrowing"
      - name: "SvelteKit file names"
        rule: "NEVER create test files with + prefix (reserved for routing)"
        fix: "Test files go in __tests__/ subfolder"
        example: |
          // WRONG: routes/admin/+page.test.ts
          // CORRECT: routes/admin/__tests__/page.test.ts
      - name: "Proper error handling"
        rule: "NEVER empty catch blocks, NEVER swallow errors silently"
        fix: "Log errors or rethrow with context"
        example: |
          // WRONG: catch (e) {}
          // CORRECT: catch (e) { console.error('Context:', e); throw e; }

  patient-web:
    paths:
      - patient-web/
    extensions:
      - .ts
      - .tsx
    build_cmd: cd patient-web && npm run build
    test_cmd: cd patient-web && npm test
    lint_cmd: cd patient-web && npm run lint

  admin:
    paths:
      - admin-dashboard/
    extensions:
      - .ts
      - .tsx
    build_cmd: cd admin-dashboard && npm run build
    test_cmd: cd admin-dashboard && npm test
    lint_cmd: cd admin-dashboard && npm run lint

  website:
    paths:
      - website/
    extensions:
      - .ts
    build_cmd: cd website && npm run build
    test_cmd: cd website && npm test
    lint_cmd: cd website && npm run lint

  e2e:
    paths:
      - ms-dashboard/tests/
    extensions:
      - .spec.ts
    build_cmd: cd ms-dashboard && npm run build
    test_cmd: psy test e2e
    lint_cmd: cd ms-dashboard/tests && npx eslint .

  swift:
    paths:
      - ios/Macaron/
      - ios/LiactTests/
      - ios/LiactUITests/
    extensions:
      - .swift
    # Real Xcode build with error capture
    build_cmd: cd ios && xcodebuild -project LiACTApp.xcodeproj -scheme LiACTApp -destination 'platform=iOS Simulator,name=iPhone 15' -configuration Debug build 2>&1 | tee /tmp/psy_ios_build.log || cat /tmp/psy_ios_build.log
    test_cmd: cd ios && xcodebuild -project LiACTApp.xcodeproj -scheme LiACTApp -destination 'platform=iOS Simulator,name=iPhone 15' test 2>&1 | tee /tmp/psy_ios_test.log || cat /tmp/psy_ios_test.log
    lint_cmd: cd ios && swiftlint 2>&1

  kotlin:
    paths:
      - android/app/
      - android/wear/
    extensions:
      - .kt
    # Real Gradle build with error capture
    build_cmd: cd android && ./gradlew assembleDebug 2>&1 | tee /tmp/psy_android_build.log || cat /tmp/psy_android_build.log
    test_cmd: cd android && ./gradlew test 2>&1 | tee /tmp/psy_android_test.log || cat /tmp/psy_android_test.log
    lint_cmd: cd android && ./gradlew lint 2>&1

# Deployment configuration
deploy:
  strategy: blue-green
  auto_prod: false
  staging:
    url: https://staging.macaron-software.com
    health: /api/health
  prod:
    url: https://macaron-software.com
    health: /api/health
  rollback_on_fail: true
  post_deploy:
    e2e_prod:
      enabled: true
      seed_cmd: "psy test seed"
      smoke: true
      journeys: true
      rbac: true
      console_check: true
      pages: ["/", "/login", "/dashboard", "/patients"]
      console_whitelist: ["chrome-extension://", "matomo", "analytics"]
      network_whitelist: ["/api/analytics/", "matomo.js"]
      timeout_sec: 600
    tmc:
      enabled: false
    chaos:
      enabled: false

# CLI commands for deployment (use psy CLI)
cli:
  binary: psy
  # Deploy commands (git promotion triggers CI/CD)
  deploy:
    staging: psy git promote-staging
    prod: psy git promote-prod
    rollback: echo "PSY rollback - manual git revert"
  # Test commands
  test:
    unit: psy test unit
    e2e: psy test all
  # E2E journeys (real tests)
  e2e:
    smoke: psy test e2e --smoke
    journeys: psy test all

# FRACTAL decomposition thresholds
fractal:
  max_files: 5
  max_loc: 400
  max_items: 10
  max_depth: 3

# Adversarial gate configuration
adversarial:
  # Threshold set to 25 to account for existing codebase patterns
  threshold: 25
  core_patterns: true
  custom_patterns:
    # Rust safety
    - pattern: '\.unwrap\(\)'
      score: 1
      message: "unwrap() usage - consider error handling"
      max_occurrences: 5
    - pattern: 'panic!'
      score: 3
      message: "panic! usage - avoid in production code"
    # Security (medical data)
    - pattern: "patient.*password|password.*patient"
      score: 5
      message: "Potential patient credential exposure"
    - pattern: "api_key\\s*=\\s*[\"'][^\"']+[\"']"
      score: 5
      message: "Hardcoded API key detected"
    # Therapy data
    - pattern: "therapy_session.*export|dump.*session"
      score: 3
      message: "Therapy session data export - ensure GDPR compliance"

# Error Capture Configuration (RLM Feedback Loop)
error_capture:
  enabled: true
  feedback_to_backlog: true
  deduplicate: true

  build:
    enabled: true
    domains: [rust, proto, svelte, patient-web, admin, website, swift, kotlin]

  e2e:
    enabled: true
    playwright:
      report_path: ms-dashboard/playwright-report/
      fail_on_console_error: true
      capture_grpc: true  # Capture gRPC errors like INVALID_ARGUMENT

  mobile:
    enabled: true
    ios:
      bundle_id: com.macaron.liact
      capture_duration: 15
    android:
      package_name: com.macaron.liact
      capture_duration: 15

  severity:
    create_task_min: medium

# Active analyzers
analyzers:
  - rust
  - typescript
  - playwright
  - security

# Integrator (cross-layer wiring)
integrator:
  enabled: true
  verify_timeout: 300
  max_iterations: 5
  priority_types:
    - bootstrap
    - migration
    - api_connection
    - config
