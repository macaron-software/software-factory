# PPZ (Popinz) Project Configuration
# ====================================
# SaaS platform with Rust backend and TypeScript frontend

project:
  name: popinz
  display_name: "Popinz SaaS"
  root_path: /Users/sylvain/_POPINZ/popinz-dev
  vision_doc: PLATFORM_FEATURES.md  # Real product features, not tech doc
  # Global exclusions (third-party dependencies, build artifacts)
  exclusions:
    - ".build/"
    - "checkouts/"
    - "node_modules/"
    - "target/"
    - ".git/"
    - "dist/"
    - "vendor/"
    - "Pods/"
    - "DerivedData/"

# Brain phase cycle (features → fixes → refactor)
brain:
  current_phase: features  # START with features, business value first
  phase_gate: deployed
  feature_docs:
    - PLATFORM_FEATURES.md      # Feature matrix
    - product/features/*.md     # 31 detailed feature specs
    - PROJECT_ROADMAP_2025_V2.md

# Project CLI commands
# Uses `ppz` CLI for operations that exist
# Build/lint use direct commands (no ppz build/lint exists)
cli:
  binary: ppz
  # Test commands per domain (ppz test exists)
  test:
    e2e: ppz test e2e
    all: ppz test
  # Deploy commands (real CI/CD pipeline)
  deploy:
    staging: ppz deploy staging
    prod: ppz deploy prod
    rollback: ppz deploy rollback
  # E2E journeys (real tests)
  e2e:
    smoke: ppz test e2e --smoke
    journeys: ppz test e2e
  # Status/monitoring
  status: ppz status

# Domain configurations
domains:
  rust:
    paths:
      - popinz-v2-rust/
    extensions:
      - .rs
    # ppz CLI has test but not build/lint — use direct cargo commands
    build_cmd: cd popinz-v2-rust && cargo check --workspace
    test_cmd: ppz test unit
    lint_cmd: cd popinz-v2-rust && cargo clippy --workspace -- -D warnings
    # Stack versions (CRITICAL for correct code generation)
    stack:
      axum: "0.7"
      axum-extra: "0.9"
      sqlx: "0.7"
      tokio: "1.0"
    # Axum 0.7 conventions (MUST follow)
    conventions:
      - name: "Extractor order"
        rule: "Body-consuming extractors (Json, Form, Bytes) MUST be LAST parameter"
        example: |
          // CORRECT: State/headers/Extension before Json
          async fn handler(
              State(state): State<AppState>,
              Extension(auth): Extension<AuthContext>,
              Json(body): Json<MyInput>,  // Json LAST
          ) -> impl IntoResponse
      - name: "Request + Json incompatible"
        rule: "Cannot use Request<Body> AND Json<T> together - both consume body"
        fix: "Use Extension<AuthContext> (set by middleware) instead of Request<Body>"
      - name: "sqlx FromRow"
        rule: "Structs used with query_as!() MUST derive sqlx::FromRow"
        example: |
          #[derive(Debug, Serialize, Deserialize, sqlx::FromRow)]
          pub struct User { ... }
      - name: "WebSocket Message"
        rule: "axum::extract::ws::Message has NO is_text()/is_binary() methods"
        fix: "Use matches!(msg, Message::Text(_) | Message::Binary(_))"
      - name: "FromStr trait"
        rule: "To call Type::from_str(), trait must be in scope"
        fix: "Add 'use std::str::FromStr;' at file top"

  typescript:
    paths:
      - popinz-saas/js/grpc-client/
    extensions:
      - .ts
      - .tsx
    build_cmd: cd popinz-saas/js/grpc-client && npm run build 2>&1
    test_cmd: cd popinz-saas/js/grpc-client && npx vitest run 2>&1
    lint_cmd: npm run lint:js 2>/dev/null
    conventions:
      - name: "NO test.skip"
        rule: "NEVER use test.skip(), describe.skip(), it.skip() - ALL tests MUST run"
        fix: "Remove .skip() and fix the test, or delete it if obsolete"
      - name: "NO as any"
        rule: "NEVER use 'as any' - it defeats TypeScript type safety"
        fix: "Use proper types, generics, unknown + type guards instead"
      - name: "NO @ts-ignore"
        rule: "NEVER use @ts-ignore or @ts-expect-error"
        fix: "Fix the type error properly"
      - name: "Strict null checks"
        rule: "Always handle null/undefined - no optional chaining abuse"
        fix: "Use explicit checks: if (x !== null) or type guards"
      - name: "Error handling"
        rule: "NEVER empty catch blocks"
        fix: "Log or rethrow with context"

  e2e:
    paths:
      - popinz-tests/
    extensions:
      - .spec.ts
    test_cmd: ppz test e2e
    conventions:
      - name: "NO test.skip in E2E"
        rule: "NEVER use test.skip() - all E2E tests MUST run"
        fix: "Fix flaky test or remove if obsolete"
      - name: "Explicit waits"
        rule: "Use explicit waits, not arbitrary timeouts"
        fix: "Use await page.waitForSelector() not page.waitForTimeout()"

  proto:
    paths:
      - popinz-v2-rust/proto/
    extensions:
      - .proto

  sql:
    paths:
      - docker/migrations/
    extensions:
      - .sql

  swift:
    paths:
      - ios/popinz/
    extensions:
      - .swift
    # Use ppz CLI for iOS build/test (handles Xcode setup properly)
    build_cmd: ppz test native-unit --ios
    test_cmd: ppz test ios
    lint_cmd: cd ios/popinz && swiftlint 2>&1

  kotlin:
    paths:
      - android/
    extensions:
      - .kt
    # Use ppz CLI for Android build/test (handles Gradle setup properly)
    build_cmd: ppz test native-unit --android
    test_cmd: ppz test android
    lint_cmd: cd android && ./gradlew lint 2>&1

# Deployment configuration
deploy:
  strategy: blue-green
  auto_prod: true
  staging:
    url: https://test-staging.popi.nz
    health: /health
  prod:
    url: https://test.popi.nz
    health: /health
  rollback_on_fail: true
  validation_cmd: npx playwright test --grep @smoke
  post_deploy:
    e2e_prod:
      enabled: true
      seed_cmd: "ppz test seed"
      smoke: true
      journeys: true
      rbac: true
      console_check: true
      pages: ["/", "/login", "/dashboard", "/events"]
      console_whitelist: ["chrome-extension://", "matomo", "analytics"]
      network_whitelist: ["/api/analytics/", "matomo.js"]
      timeout_sec: 600
    tmc:
      enabled: true
      tool: k6
      thresholds:
        p95_latency_ms: 500
        error_rate_pct: 1
        min_throughput_rps: 100
      scenarios:
        - baseline
        - ramp_10x
      duration_sec: 120
    chaos:
      enabled: true
      scenarios:
        - kill_backend
        - network_latency_200ms
        - db_connection_kill
      recovery_timeout_sec: 30
      rollback_on_fail: true
    feedback:
      create_perf_tasks: true
      revert_if_worse: true
      tolerance_pct: 15

# FRACTAL decomposition thresholds
fractal:
  max_files: 5
  max_loc: 400
  max_items: 10
  max_depth: 3

# Adversarial gate configuration
# MODE: 100% LLM (regex patterns disabled for testing)
adversarial:
  # Threshold elevated to 15 to avoid false positives (cargo check is valid)
  threshold: 15
  core_patterns: false      # DISABLED - no regex patterns
  security_check: false     # DISABLED - LLM will catch these
  custom_patterns: []       # EMPTY - 100% LLM mode

# Error Capture Configuration (RLM Feedback Loop)
error_capture:
  enabled: true
  feedback_to_backlog: true
  deduplicate: true

  build:
    enabled: true
    domains: [rust, typescript, proto, swift, kotlin]

  e2e:
    enabled: true
    playwright:
      report_path: popinz-tests/playwright-report/
      fail_on_console_error: true
      capture_grpc: true  # Capture gRPC errors

  # Mobile error capture for Popinz iOS/Android apps
  mobile:
    enabled: true
    ios:
      bundle_id: com.popinz.app
      capture_duration: 15
    android:
      package_name: com.popinz.app
      capture_duration: 15

  severity:
    create_task_min: medium

# Active analyzers
analyzers:
  - rust
  - typescript
  - playwright
  - security

# Integrator (cross-layer wiring)
integrator:
  enabled: true
  verify_timeout: 300
  max_iterations: 5
  priority_types:
    - bootstrap
    - migration
    - proto_gen
    - api_connection
    - proxy
    - config
