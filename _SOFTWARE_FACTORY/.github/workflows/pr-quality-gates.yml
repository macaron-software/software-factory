name: Pull Request Quality Gates

on:
  pull_request:
    branches: [main, master, develop]
    types: [opened, synchronize, reopened]

# Cancel in-progress runs when a new commit is pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      python: ${{ steps.filter.outputs.python }}
      javascript: ${{ steps.filter.outputs.javascript }}
      docs: ${{ steps.filter.outputs.docs }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            python:
              - 'platform/**/*.py'
              - 'cli/**/*.py'
              - 'skills_injection/**/*.py'
              - 'tests/**/*.py'
            javascript:
              - '**/*.js'
              - '**/*.ts'
              - '**/*.tsx'
              - 'package*.json'
            docs:
              - '**.md'
              - 'docs/**'

  python-lint:
    name: Python Linting (Blocking)
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.python == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install Ruff
        run: pip install ruff
      
      - name: Ruff lint (fail on error)
        run: ruff check platform/ cli/ skills_injection/ tests/ --output-format=github
      
      - name: Ruff format check
        run: ruff format --check platform/ cli/ skills_injection/ tests/

  javascript-lint:
    name: JavaScript Linting (Blocking)
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.javascript == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: ESLint (fail on error)
        run: npm run lint
      
      - name: Prettier check
        run: npm run format:check

  security-critical:
    name: Security Check (Blocking)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Bandit (Python security)
        run: |
          pip install bandit
          bandit -r platform/ cli/ skills_injection/ -ll -f json -o bandit-report.json
          # Fail if high severity issues found
          python3 -c "import json; data=json.load(open('bandit-report.json')); exit(1 if any(i['issue_severity'] == 'HIGH' for i in data.get('results', [])) else 0)"
      
      - name: Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}
          extra_args: --only-verified --fail

  tests-required:
    name: Required Tests
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.python == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install pytest pytest-cov
          pip install -r requirements-dev.txt || true
      
      - name: Run tests with minimum coverage
        run: |
          pytest tests/ --cov=platform --cov=cli --cov=skills_injection \
            --cov-report=xml --cov-report=term \
            --cov-fail-under=70 -v
      
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: pr-${{ github.event.pull_request.number }}
          token: ${{ secrets.CODECOV_TOKEN }}

  pr-quality-summary:
    name: PR Quality Gate
    runs-on: ubuntu-latest
    needs: [changes, python-lint, javascript-lint, security-critical, tests-required]
    if: always()
    steps:
      - name: Check all gates passed
        run: |
          echo "ğŸ” PR Quality Gate Results:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Changes Detected: ${{ needs.changes.result }}"
          echo "Python Linting: ${{ needs.python-lint.result }}"
          echo "JavaScript Linting: ${{ needs.javascript-lint.result }}"
          echo "Security Check: ${{ needs.security-critical.result }}"
          echo "Required Tests: ${{ needs.tests-required.result }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Fail if any required job failed (skip if skipped)
          if [[ "${{ needs.python-lint.result }}" == "failure" ]] || \
             [[ "${{ needs.javascript-lint.result }}" == "failure" ]] || \
             [[ "${{ needs.security-critical.result }}" == "failure" ]] || \
             [[ "${{ needs.tests-required.result }}" == "failure" ]]; then
            echo "âŒ Quality gate FAILED - PR cannot be merged"
            exit 1
          fi
          
          echo "âœ… Quality gate PASSED - PR ready for review"
