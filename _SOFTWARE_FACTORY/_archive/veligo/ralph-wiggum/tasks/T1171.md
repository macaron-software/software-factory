# Task T1171: Refactor PaymentService to use factory pattern and inject de

**Priority**: P1
**WSJF Score**: 8.0
**Queue**: TDD
**Parent**: T1055
**Generated by**: Fractal LLM Delegation

## Description
Refactor PaymentService to use factory pattern and inject dependencies

## Reason for Delegation
Task requires refactoring and verification of test isolation across 8 files in backend/src/payment, involving dependency injection, factory pattern, and multiple test suites. Touches StripeProcessor, PaymentAdapterFactory, and related test files across 4+ files with >400 LOC and complex interactions.

## Success Criteria
- [ ] Task completed
- [ ] Tests pass
- [ ] No stubs or TODOs

## Ralph Status Block
---RALPH_STATUS---
STATUS: FAILED
COMPLEXITY: medium
PARENT_TASK: T1055
---END_RALPH_STATUS---

## Last Failure (Wed Jan 14 20:34:12 CET 2026)
```
- No dependency injection - the service can't be tested with mocks
- Tight coupling between components

## Required Refactoring:
1. Make `PaymentService` accept a factory/adapter as a dependency (dependency injection)
2. Use the factory pattern properly - inject the factory or the adapter
3. Make it testable

Let me check how PaymentService is used in the grpc service:
</think>

<read>veligo-platform/backend/src/grpc/services/payment.rs</read>

=== LLM Response ===
<think>
Let me read the payment.rs file in the root src directory and the grpc services payment.rs file to understand the current implementation.
</think>

<read>veligo-platform/backend/src/payment.rs</read>
<read>veligo-platform/backend/src/grpc/services/payment.rs</read>
```

## Last Failure (Wed Jan 14 20:35:22 CET 2026)
```
---
bash: OK
      27

---
bash: OK
use async_trait::async_trait;
use serde::{Deserialize, Serialize};
use std::sync::Arc;
use crate::payment::{PaymentAdapter, PaymentError, PaymentRequest, PaymentResponse, PaymentResult, PaymentProvider, PaymentStatus, RefundRequest, RefundResponse};

/// Stripe-specific configuration
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct StripeProcessorConfig {
    pub secret_key: String,
    pub webhook_secret: Option<String>,
}

impl Default for StripeProcessorConfig {
    fn default() -> 
```

## Last Failure (Wed Jan 14 20:37:27 CET 2026)
```

package `libsqlite3-sys` links to the native library `sqlite3`, but it conflicts with a previous package w

=== LLM Response ===
<think>
There's a dependency conflict in the workspace. Let me check if I can run tests for just the payment module specifically. Let me try to compile just the payment crate or check if there's a way to isolate it.
</think>

<bash>
cd veligo-platform/backend && cargo check -p payment 2>&1 | head -50</bash>

=== Action Results ===
bash: OK
    Blocking waiting for file lock on package cache
    Updating crates.io index
error: failed to select a version for `libsqlite3-sys`.
    ... required by package `sqlx-sqlite v0.8.0`
    ... which satisfies dependency `sqlx-sqlite = "=0.8.0"` of package `sqlx v0.8.0`
    ... which satisfies dependency `sqlx = "^0.8"` of package `veligo-auth-service v0.1.0 (/Users/sylvain/_LAPOSTE/_VELIGO2/veligo-platform/services/veligo-auth-service)`
versions that meet the requirements `^0.28.0` are: 0.28.0
```
