# Task T204: Implement ReserveBike gRPC method

**Priority**: P1
**Queue**: TDD
**Type**: implementation

## File
veligo-platform/backend/src/grpc/services/bike.rs

## Description
Implement ReserveBike to create a reservation with expiration time

## Success Criteria
- [ ] Implementation complete
- [ ] cargo check passes
- [ ] Unit tests added
- [ ] No new warnings

## Ralph Status Block
---RALPH_STATUS---
STATUS: COMPLETED
COMPLEXITY: medium
WSJF: 8
---END_RALPH_STATUS---

## Last Failure (Tue Jan 13 23:51:59 CET 2026)
```
  string bike_id = 2;
  string tenant_id = 3;
  MaintenanceType type = 4;
  string description = 5;
  string technician_id = 6;
  string technician_name = 7;
  google.protobuf.Timestamp scheduled_at = 8;
  google

=== LLM Response ===
```bash
grep -n "reservations\|CREATE TABLE.*reservation" veligo-platform/backend/migrations/*.sql 2>/dev/null || grep -rn "reservations" veligo-platform/backend/src/ | head -10
```

=== Action Results ===
bash: OK
veligo-platform/backend/migrations/014_stations.sql:130:CREATE TABLE IF NOT EXISTS station_reservations (
veligo-platform/backend/migrations/014_stations.sql:207:CREATE INDEX IF NOT EXISTS idx_station_reservations_station ON station_reservations(station_id);
veligo-platform/backend/migrations/014_stations.sql:208:CREATE INDEX IF NOT EXISTS idx_station_reservations_user ON station_reservations(user_id);
veligo-platform/backend/migrations/014_stations.sql:209:CREATE INDEX IF NOT EXISTS idx_station
```

## Last Failure (Tue Jan 13 23:52:51 CET 2026)
```
        &self,
        _request: Re

=== LLM Response ===
<think>
Now I need to:
1. Look at the proto definition for ReserveBikeRequest and Reservation response
2. Look at the reservations database schema
3. Look at existing similar implementations for reference

Let me explore more.
</think>

Now let me look at the protobuf definitions and database schema:
```bash
find veligo-platform/backend -name "*.proto" -exec grep -l "ReserveBike" {} \;
```

=== Action Results ===
bash: OK
```

## Last Failure (Tue Jan 13 23:52:54 CET 2026)
```

```bash
find veligo-platform/backend -name "*.proto" | xargs ls -la 2>/dev/null
```

=== Action Results ===
bash: OK


=== LLM Response ===
<think>
Let me try a different approach to find proto files.
</think>

```bash
find veligo-platform/backend -type f -name "*.proto" 2>/dev/null
```

=== Action Results ===
bash: OK
```

## Last Failure (Tue Jan 13 23:53:52 CET 2026)
```
156:    async fn get_bike(
218:    async fn list_bikes(
416:    async fn get_bikes_by_station(
1035:    async fn get_bike_status(
1115:    async fn create_bike(
1122:    async fn update_bike(
1129:    async fn delete_bike(
1136:    async fn update_bike_status(
1145:    async fn reserve_bike(
1147:        _request: Reque
---
bash: OK
                // Check tenant isolation if tenant_id is provided
                if !req.tenant_id.is_empty() {
                    let tenant_uuid = self.resolve_tenant_id(&req.tenant_id).await?;
                    let bike_tenant_id: Uuid = row
                        .try_get("tenant_id")
                        .map_err(|e| Status::internal(format!("Failed to get tenant_id: {}", e)))?;
                    if bike_tenant_id != tenant_uuid {
                        return Err(Status::not_fo
```

## Last Failure (Tue Jan 13 23:57:27 CET 2026)
```
3. It currently just returns `Err(Status::unimplemented(...))`

Let me first add the imports, then update the reserve_bike function. Let me do this step by step.
</think>

Now I can see the file is restored. Let me add the necessary imports first:
<edit file="veligo-platform/backend/src/grpc/services/bike.rs" old="use sqlx::{PgPool, Row};
use std::sync::Arc;
use tonic::{Request, Response, Status};
use uuid::Uuid;" new="use chrono::{DateTime, Duration, Utc};
use nanoid::nanoid;
use prost_types;
use sqlx::{PgPool, Row};
use std::sync::Arc;
use tonic::{Request, Response, Status};
use uuid::Uuid;"/>

=== Action Results ===
edit: OK
Edit applied
```

## Last Failure (Tue Jan 13 23:58:15 CET 2026)
```
    }

    async fn cancel_reservation(
        &self,
        _request: Request<crate::proto::bike::v1::CancelReservationRequest>,
    ) -> Result<Response<crate::proto::bike:

=== LLM Response ===
<think>
Now I understand the task. I need to implement the `reserve_bike` function. Let me also check:
1. The ReserveBikeRequest structure
2. The Reservation response structure
3. The database schema for reservations

Let me look at the proto definitions and database schema.
</think>

Now let me check the proto definitions and database schema:
```bash
grep -rn "ReserveBikeRequest\|Reservation" veligo-platform/backend/src/proto/ 2>/dev/null | head -30</bash_command>
```
