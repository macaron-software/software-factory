# Task T139: Create E2E Journey - subscription-upgrade

**Priority**: P1
**Queue**: TDD
**AO_REF**: AO-IDFM-SUB-3.3
**Tenant**: idfm

## Description
Missing E2E journey: subscription-upgrade - User upgrades subscription plan

Journey: User upgrades subscription plan

## File to Create
tests/e2e/journeys/idfm-subscription-upgrade.spec.ts

## Test Template
```typescript
import { test, expect } from '@playwright/test';
import { users } from '../fixtures/users.json';
import { stations } from '../fixtures/stations.json';

const BASE_URL = process.env.IDFM_URL || 'https://idfm.veligo.app';

test.describe('[AO-IDFM-SUB-3.3] subscription-upgrade', () => {

  test('Complete subscription-upgrade journey', async ({ page }) => {
    // Step 1: Navigate to starting point
    await page.goto(`${BASE_URL}/`);

    // Step 2: User actions
    // TODO: Implement User upgrades subscription plan

    // Step 3: Verify success
    await expect(page.locator('[data-testid="success-message"]')).toBeVisible();
  });

});

```

## Required Selectors
- Navigation: `[data-testid="nav-*"]`
- Forms: `[data-testid="form-*"]`
- Buttons: `[data-testid="btn-*"]`
- Status: `[data-testid="status-*"]`

## Success Criteria
- [ ] Test file created with proper structure
- [ ] All user steps implemented
- [ ] Selectors use data-testid
- [ ] Test runs without skip
- [ ] AO compliance verified

## Ralph Status Block
---RALPH_STATUS---
STATUS: COMPLETED
COMPLEXITY: medium
WSJF: 8
---END_RALPH_STATUS---

## Last Failure (Tue Jan 13 18:57:02 CET 2026)
```
-rw-r--r--    1 sylvain  staff   3

=== LLM Response ===
<think>
Now I see the structure. The journeys folder exists and has existing journey spec files. Let me look at an existing journey to understand the pattern better.
</think>

<bash>
ls -la ./tests/e2e/journeys/</bash>

=== Action Results ===
bash: OK
total 2144
drwxr-xr-x  143 sylvain  staff   4576 Dec 24 11:50 .
drwxr-xr-x   52 sylvain  staff   1664 Jan 13 18:50 ..
-rw-r--r--    1 sylvain  staff  23141 Dec 24 11:50 01-auth-journeys-ao-enhanced-v2.spec.ts
-rw-r--r--    1 sylvain  staff  13660 Dec 24 11:50 01-auth-journeys-ao-enhanced.spec.ts
-rw-r--r--    1 sylvain  staff   4265 Dec 24 11:50 01-auth-journeys.spec.ts
-rw-r--r--    1 sylvain  staff   6452 Dec 24 11:50 01-subscription-creation-complete.spec.ts
-rw-r--r--    1 sylvain  staff   3
```

## Last Failure (Tue Jan 13 19:03:45 CET 2026)
```

    // Navigate to subscription management
    await page.locator('[data-testid="nav-subscription"]').click();
    await page.waitForURL(`${BASE_URL}/subscription`);

    // Click upgrade button
    await page.locator('[data-testid="btn-upgrade-subscription"]').click();

    // Select new plan (assuming we have a plan selector)
    await page.locator('[data-testid="form-plan-select"]').selectOption('premium');

    // Confirm upgrade
    await page.locator('[data-testid="btn-confirm-upgrade"]').click();

    // Wait for payment form
    await page.waitForSelector('[data-testid="form-payment"]');

    // Fill payment details (using test card)
    await page.locator('[data-testid="form-card-number"]').fill('4242424242424242');
    await page.locator('[data-testid="fo
```

## Last Failure (Tue Jan 13 19:04:22 CET 2026)
```
Let me get the full test to understand the pattern better.
</think>

<bash>
sed -n '429,500p' ./tests/e2e/02-subscription.spec.ts</bash>

=== Action Results ===
bash: OK
  test('[RED] User can upgrade subscription plan', async ({ page }) => {
    await page.goto('https://idfm.veligo.app/subscription');

    // Click upgrade
    await page.click('button:has-text("Changer de forfait")');

    // Plan selection modal
    await expect(page.locator('[data-testid="plan-modal"]')).toBeVisible();
    await expect(page.locator('[data-testid="current-plan-badge"]')).toContainText('Actuel');

    // Select premium plan
    await page.click('[data-testid="plan-annual_premiu
```

## Last Failure (Wed Jan 14 08:28:16 CET 2026)
```
    await expect(page.locator('[data-testid="plan-modal"]')).toBeVisible();
    await expect(page.locator('[data-testid="current-plan-badge"]')).toContainText('Actuel');

    // Select premium plan
    await page.click('[data-testid="plan-annual_premiu

=== LLM Response ===
<think>
The output is getting cut off. Let me try to get the complete test for the upgrade subscription. Let me use a different approach.
</think>

<bash>
grep -n "upgrade" ./tests/e2e/02-subscription.spec.ts</bash>

=== Action Results ===
bash: OK
429:  test('[RED] User can upgrade subscription plan', async ({ page }) => {
432:    // Click upgrade
443:    await expect(page.locator('[data-testid="upgrade-confirmation"]')).toBeVisible();
447:    // Confirm upgrade
```
