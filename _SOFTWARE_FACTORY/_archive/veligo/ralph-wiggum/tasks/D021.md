# Task D021: Impl√©menter calculs MaintenanceMetrics

**Priority**: P2
**Time Estimate**: 3h
**WSJF Score**: 5.5
**Complexity**: simple
**Queue**: BACKEND

## Description
Remplacer les TODO dans report_routes.rs pour avg_repair_time_hours et batteries_replaced par de vrais calculs depuis les maintenance logs.

## Success Criteria
- [ ] avg_repair_time_hours calcul√© depuis maintenance logs
- [ ] batteries_replaced compt√© depuis maintenance items
- [ ] Tests unitaires pour les calculs

## Actions
1. Cr√©er requ√™te SQL pour avg_repair_time_hours
2. Cr√©er requ√™te SQL pour batteries_replaced
3. Impl√©menter fonctions de calcul
4. Remplacer TODO dans report_routes.rs
5. Cr√©er tests unitaires

## Files to Create/Modify
- [ ] veligo-platform/backend/src/services/reporting/report_routes.rs (MODIFY)
- [ ] veligo-platform/backend/tests/unit/maintenance_metrics_tests.rs (CREATE)

## Ralph Status Block
---RALPH_STATUS---
STATUS: COMPLETE
COMPLEXITY: simple
MODEL_TIER: TIER1
WSJF: 5.5
---END_RALPH_STATUS---

## Last Failure (Wed Jan 14 17:42:42 CET 2026)
```
- **Scope**:  
  - Replace `TODO` in `avg_repair_time_hours` and `batteries_replaced` with real SQL queries and logic.
  - Extract data from `maintenance_logs` and `maintenance_items` tables.
  - Write unit tests for the metrics.

**No signs of complexity >400 LOC or touching >5 files.**  
‚úÖ **Not delegatable via fractal_delegate**.

---

## üõ†Ô∏è Step-by-Step Plan

1. **Understand the current structure of `report_routes.rs`**
   - Locate the `avg_repair_time_hours` and `batteries_replaced` functions.
   - Identify the expected return type and input (likely `&Database`).

2. **Design SQL queries**:
   - `avg

ERROR: LLM call failed
```

## Last Failure (Wed Jan 14 17:42:51 CET 2026)
```
[0;32m[AGENT] Real Agent starting[0m
[0;34m[AGENT] Task: /Users/sylvain/_LAPOSTE/_VELIGO2/tools/ralph-wiggum/tasks/D021.md[0m
[0;34m[AGENT] Queue: deploy[0m
[0;34m[AGENT] Backend: auto[0m
[0;32m[AGENT] Starting task: D021[0m
[0;34m[AGENT] Iteration 1/10[0m
[0;33m[AGENT] No actions found in response[0m
[0;34m[AGENT] Iteration 2/10[0m

============================================================
RESULT: FAILED
============================================================
=== LLM Response ===
<plan>
1. **Understand current state of `report_routes.rs`**  
   - Locate the `avg_repair_time_hours` and `batteries_replaced` functions.


ERROR: LLM call failed
```

## Last Failure (Wed Jan 14 17:42:57 CET 2026)
```
[0;32m[AGENT] Real Agent starting[0m
[0;34m[AGENT] Task: /Users/sylvain/_LAPOSTE/_VELIGO2/tools/ralph-wiggum/tasks/D021.md[0m
[0;34m[AGENT] Queue: deploy[0m
[0;34m[AGENT] Backend: auto[0m
[0;32m[AGENT] Starting task: D021[0m
[0;34m[AGENT] Iteration 1/10[0m

============================================================
RESULT: FAILED
============================================================
ERROR: LLM call failed
```
