# Task T1037: Ensure test isolation and proper mocking using mockall or si

**Priority**: P1
**WSJF Score**: 8.0
**Queue**: TDD
**Parent**: T1025
**Generated by**: Fractal LLM Delegation

## Description
Ensure test isolation and proper mocking using mockall or similar in tests

## Reason for Delegation
Task requires unit tests for PayPalProcessor, StripeProcessor, PaymentAdapterFactory across 4+ files with dependency injection and test isolation, touching backend/src/payment directory and associated test files. Involves complex interactions, factory pattern, and mocking of dependencies across multiple domains. Estimated LOC >400, files >5.

## Success Criteria
- [ ] Task completed
- [ ] Tests pass
- [ ] No stubs or TODOs

## Ralph Status Block
---RALPH_STATUS---
STATUS: FAILED
COMPLEXITY: medium
PARENT_TASK: T1025
---END_RALPH_STATUS---

## Last Failure (Wed Jan 14 19:35:26 CET 2026)
```

=== LLM Response ===
<think>
I see there are payment-related files in `./tenant/backend/src/payments/`. Let me explore that directory more specifically.
</think>

<bash>
find . -path ./target -prune -o -path ./.sqlx -prune -o -type f -name "*.rs" -print 2>/dev/null</bash>

=== Action Results ===
bash: OK
./tenant/backend/target/debug/build/serde_core-f5f518288db96107/out/private.rs
./tenant/backend/target/debug/build/serde-003736f7f5663e40/out/private.rs
./tenant/backend/target/debug/build/typenum-c437f339ad9d214e/out/tests.rs
./tenant/backend/src/payments/factory.rs
./tenant/backend/src/main.rs
./tenant/backend/src/api/mod.rs
./tenant/backend/src/api/modules.rs
./veligo-templates/generators/target/debug/build/serde_core-31854cc0b0498b36/out/private.rs
./veligo-templates/generators/target/debug/
```

## Last Failure (Wed Jan 14 19:36:04 CET 2026)
```
   - Unit tests for `PaymentAdapterFactory` (verifying factory logic)
3. Run tests to verify they pass

Let me implement this:
<edit>
<path>./tenant/backend/Cargo.toml</path>
<old">[dependencies]
reqwest = { version = "0.11", features = ["json"] }
tokio = { version = "1", features = ["full"] }
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"
anyhow = "1.0"
thiserror = "1.0"
stripe = { git = "https://github.com/alex/rust-stripe", branch = "master" }

[dev-dependencies]
test-case = "2.2"</old>
<new>[dependencies]
reqwest = { version = "0.11", features = ["json"] }
tokio = { version = "1", fea
```

## Last Failure (Wed Jan 14 19:36:32 CET 2026)
```
cat ./tenant/backend/src/payments/factory.rs | tail -100
```

=== Action Results ===
bash: OK

    /// Create a Stripe adapter.
    async fn create_stripe_adapter(&self) -> Result<Arc<dyn PaymentAdapter>, PaymentError> {
        use super::stripe::StripeAdapter;

        let provider_config = &self.config.payments.stripe;

        if !provider_config.enabled {
            return Err(PaymentError::ConfigurationError {
                message: "Stripe payment provider is not enabled".to_string(),
            });
        }

        let adapter = StripeAdapter::new(
            provider_conf
```
