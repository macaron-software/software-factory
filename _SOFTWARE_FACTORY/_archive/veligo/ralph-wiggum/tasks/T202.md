# Task T202: Implement DeleteBike gRPC method

**Priority**: P0
**Queue**: TDD
**Type**: implementation

## File
veligo-platform/backend/src/grpc/services/bike.rs

## Description
Implement DeleteBike with soft delete (set deleted_at timestamp)

## Success Criteria
- [ ] Implementation complete
- [ ] cargo check passes
- [ ] Unit tests added
- [ ] No new warnings

## Ralph Status Block
---RALPH_STATUS---
STATUS: COMPLETED
COMPLEXITY: medium
WSJF: 12
---END_RALPH_STATUS---

## Last Failure (Tue Jan 13 23:52:18 CET 2026)
```
            .ok_or_else(|| Status::invalid_argument("Bike ID is required"))?;

        let bike = sqlx::query_as!(
            Bike

=== LLM Response ===
<think>
The user keeps saying I made no file changes. Let me verify what's happening. I need to actually see if the file was changed. Let me check the current state of the file and make sure my writes are working properly.

Let me try a different approach - I'll read the file first to see what's there, then make targeted edits.
</think>

Let me verify the current state of the file first:
<bash command="cat veligo-platform/backend/src/grpc/services/bike.rs 2>&1 | head -50"/>
<bash command="wc -l veligo-platform/backend/src/grpc/services/bike.rs"/>
<bash command="grep -n "delete_bike" veligo-platform/backend/src/grpc/services/bike.rs"/>
<edit file="veligo-platform/backend/src/grpc/services/bike.rs" old="    async fn delete_bike(
        &self,
        request: DeleteBikeRequest,
    ) -> Result<DeleteBikeResponse, Status>;
}" new="    async fn delete_bike(
        &self,
        request: DeleteBikeRequest,
    ) -> Result<DeleteBikeResponse, Status>;
}

#[tonic::async_trait]
impl BikeService for BikeServiceServerImpl {
    async fn delete_bike(
        &self,
        request: DeleteBikeRequest,
    ) -> Result<DeleteBikeResponse, Status> {
        let pool = &self.pool;

        let bike_id = request
            .id
            .ok_or_else(|| Status::invalid_argument(\"Bike ID is required\"))?;

        // Soft delete: set deleted_at timestamp
        let now = Utc::now().naive_utc();

        let result = sqlx::query!(
            r#\"
            UPDATE bikes
            SET deleted_at = $1
            WHERE id = $2 AND deleted_at IS NULL
            \"#,
            now,
            bike_id
        )
        .execute(pool)
        .await
        .map_err(|e| {
            tonic::Status::internal(format!(\"Failed to delete bike: {}\", e))
        })?;

        if result.rows_affected() == 0 {
            return Err(Status::not_found(\"Bike not found or already deleted\"));
        }

        Ok(DeleteBikeResponse {
         
```

## Last Failure (Tue Jan 13 23:54:00 CET 2026)
```
        &self,
        request: CreateBikeRequest,
    ) -> Result<CreateBikeResponse, Status> {
        let pool = &self.pool;

        let bike = request.bike.ok_or_else(|| Status::invalid_argument("Bike data is required"))?;
        
        let station_id = if bike.station_id == 0 { None } else { Some(bike.station_id as i32) };
        let battery_level = if bike.battery_level == 0 { None } else { Some(bike.battery_level as i32) };
        let latitude = if bike.latitude == 0.0 { None } else { Some(bike.latitude) };
        let longitude = if bike.longitude == 0.0 { None } else { Some(bike.longitude) };

        let result = sqlx::query_as!(
            Bike,
            r#"
            INSERT INTO bikes (model, status, station_id, battery_level, latitude, longitude, created_at, updated_at)
            VALUES ($1, $2, $3, $4, $5, $6, NOW(), NOW())
            RETURNING id, model, status as "status: i32", station_id as "station_id: i32", 
                      battery_level as "battery_level: i32", latitude, longitude, 
                      crea
```

## Last Failure (Tue Jan 13 23:55:24 CET 2026)
```
  bool success = 1;
  string message = 2;
}

message UpdateBikeStatusRequest {
  string bike_id = 1;
  string tenant_id = 2;
  BikeStatus status = 3;
  optional string reason = 4;
}

message GetBikesByStationRequest {
  string station_id = 1;
  string tenant_id = 2;
  optional BikeStatus status = 3;
}

message ListByStationRequest {
  string station_id = 1;
  optional BikeStatus status = 2;
```
