# Task T1154: Refactor PaymentAdapterFactory to support dependency injecti

**Priority**: P1
**WSJF Score**: 8.0
**Queue**: TDD
**Parent**: T1052
**Generated by**: Fractal LLM Delegation

## Description
Refactor PaymentAdapterFactory to support dependency injection with test-friendly constructors

## Reason for Delegation
Task requires test isolation and proper dependency injection across multiple files (StripeProcessor, PaymentAdapterFactory, and related test files), involving complex interactions, factory pattern, and dependency injection. Touches 4+ files in backend/src/payment directory and associated test files, exceeding 400 LOC and involving multiple domains.

## Success Criteria
- [ ] Task completed
- [ ] Tests pass
- [ ] No stubs or TODOs

## Ralph Status Block
---RALPH_STATUS---
STATUS: FAILED
COMPLEXITY: medium
PARENT_TASK: T1052
---END_RALPH_STATUS---

## Last Failure (Wed Jan 14 20:36:58 CET 2026)
```
use async_trait::async_trait;
use thiserror::Error;

use crate::domain::payment::payment_port::{PaymentMethod, PaymentResult, PaymentPort};
use crate::infrastructure::config::Config;
use crate::infrastructure::http::HttpClient;

#[derive(Debug)]
pub struct PayPalProcessor {
    config: Config,
    http_client: HttpClient,
}

#[derive(Debug, Error)]
pub enum PayPalError {
    #[error("Payment failed: {0}")]
    PaymentFailed(String),
    #[error("Invalid amount")]
    InvalidAmount,
    #[error("
```

## Last Failure (Wed Jan 14 20:37:45 CET 2026)
```
</think>

Now I have a complete picture of the codebase. Let me create a plan:

## Analysis & Plan

### Current State:
- `StripeProcessor` and `PayPalProcessor` use `Config::global()` and `HttpClient::global()` - makes testing hard
- `StripeAdapter` and `PayPalAdapter` are simple structs wrapping processors
- `PaymentAdapterFactory` creates adapters using `new()` constructors

### Refactoring Plan:
1. Add test-friendly constructors to `StripeProcessor` and `PayPalProcessor` that accept `Config` and `HttpClient` as parameters
2. Update `StripeAdapter` and `PayPalAdapter` to pass these dependencies through
3. Add `PaymentAdapterFactory::with_adapters()` method for dependency injection in tests
4. Keep existing `ne

=== Action Results ===
write: OK
File written
```

## Last Failure (Wed Jan 14 20:38:18 CET 2026)
```
[0;32m[AGENT] Real Agent starting[0m
[0;34m[AGENT] Task: /Users/sylvain/_LAPOSTE/_VELIGO2/tools/ralph-wiggum/tasks/T1154.md[0m
[0;34m[AGENT] Queue: tdd[0m
[0;34m[AGENT] Backend: auto[0m
[0;32m[AGENT] Starting task: T1154[0m
[0;34m[AGENT] Iteration 1/10[0m

============================================================
RESULT: FAILED
============================================================
ERROR: LLM call failed
```
