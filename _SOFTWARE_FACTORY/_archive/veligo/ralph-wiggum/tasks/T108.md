# Task T108: Replace panic with error handling: google_oauth.rs

**Priority**: P1
**Queue**: TDD

## Description
panic!() should be replaced with proper error handling

## File
veligo-platform/backend/src/api/google_oauth.rs:375

## Success Criteria
- [ ] Issue fixed
- [ ] Code compiles
- [ ] Tests pass
- [ ] No regressions

## Ralph Status Block
---RALPH_STATUS---
STATUS: FAILED
COMPLEXITY: simple
WSJF: 8
---END_RALPH_STATUS---

## Last Failure (Tue Jan 13 18:39:37 CET 2026)
```
Let me try with more lines to see the full function
</think>

```bash
sed -n '358,450p' veligo-platform/backend/src/api/google_oauth.rs
```

=== Action Results ===
bash: OK

/// Create a secure 256-bit key for cookie encryption from an environment variable
/// Falls back to a random key if COOKIE_SECRET is not set (development only)
///
/// # Panics
/// Panics at startup if COOKIE_SECRET is set but not valid hex.
/// This is intentional to fail fast during deployment rather than at runtime.
pub fn get_cookie_key() -> Key {
    if let Ok(secret) = std::env::var("COOKIE_SECRET") {
        // Secret should be at least 64 hex chars (32 bytes = 256 bits)
        match h
```

## Last Failure (Tue Jan 13 18:40:25 CET 2026)
```
}" />

=== LLM Response ===
```bash
cd veligo-platform/backend && sed -i 's//// # Panics//// # Errors/' src/api/google_oauth.rs && sed -i 's//// Panics at startup if COOKIE_SECRET is set but not valid hex.//// Returns an error if COOKIE_SECRET is set but not valid hex./' src/api/google_oauth.rs && sed -i 's//// This is intentional to fail fast during deployment rather than at runtime.//' src/api/google_oauth.rs && sed -i 's/pub fn get_cookie_key() -> Key {/pub fn get_cookie_key() -> Result<Key, String> {/' src/api/google_oauth.rs
```

=== Action Results ===
bash: FAIL
sed: 1: "src/api/google_oauth.rs
": unescaped newline inside substitute pattern


=== LLM Response ===
```bash
cd veligo-platform/backend && sed -i '' 's/pub fn get_cookie_key() -> Key {/pub fn get_cookie_key() -> Result<Key, String> {/' src/api/google_oauth.rs
```

=== Action Results ===
bash: OK
```

## Last Failure (Tue Jan 13 18:40:59 CET 2026)
```
    };

    // 4. Create session
    let session_token = Uuid::new_v4().to_string();
    let session_id = Uuid::new_v4();

    let session_result = sqlx::query(
        r#"
        INSERT INTO sessions (id, user_id, token, auth_method, expires_at, created_at)
        VALUES ($1, $2, $3, 'google', NOW() + INTERVAL '7 days', NOW())
        "#,
    )
    .bind(session_id)
    .bind(user_id)
    .bind(&session_token)
    .execute(&pool)
    .await;

    if let Err(e) = session_result {
   
```

## Last Failure (Tue Jan 13 18:41:00 CET 2026)
```
cat veligo-platform/backend/src/api/google_oauth.rs | tail -150
```
</edit>

=== Action Results ===
bash: OK
        .send()
        .await;

    let tokens: GoogleTokenResponse = match token_response {
        Ok(resp) if resp.status().is_success() => match resp.json().await {
            Ok(t) => t,
            Err(e) => {
                eprintln!("[Google OAuth] Token parse error: {:?}", e);
                return (jar, Redirect::to("/login?error=token_parse_error")).into_response();
            }
        },
        Ok(resp) => {
            let status = resp.status();
            let error_text = 
```

## Last Failure (Tue Jan 13 18:41:44 CET 2026)
```
Let me see more of the file to get the full context. The function is cut off. Let me try a different approach.
</think>

```bash
sed -n '358,420p' veligo-platform/backend/src/api/google_oauth.rs
```

=== Action Results ===
bash: OK

/// Create a secure 256-bit key for cookie encryption from an environment variable
/// Falls back to a random key if COOKIE_SECRET is not set (development only)
///
/// # Panics
/// Panics at startup if COOKIE_SECRET is set but not valid hex.
/// This is intentional to fail fast during deployment rather than at runtime.
pub fn get_cookie_key() -> Key {
    if let Ok(secret) = std::env::var("COOKIE_SECRET") {
        // Secret should be at least 64 hex chars (32 bytes = 256 bits)
        match h
```

## Last Failure (Tue Jan 13 18:41:55 CET 2026)
```

```bash
base64 veligo-platform/backend/src/api/google_oauth.rs | head -100
```

=== Action Results ===
<invoke><base64>
<path>veligo-platform/backend/src/api/google_oauth.rs</path>
</base64></invoke>
</system_message>

=== Action Results ===
bash: OK
base64: invalid argument veligo-platform/backend/src/api/google_oauth.rs
Usage:	base64 [-Ddh] [-b num] [-i in_file] [-o out_file]
  -b, --break       break encoded output up into lines of length num
  -D, -d, --decode  decode input
  -h, --help        display this message
  -i, --input       input file (default: "-" for stdin)
  -o, --output      output file (default: "-" for stdout)
```

## Last Failure (Tue Jan 13 18:42:24 CET 2026)
```
=== LLM Response ===
```bash
cd veligo-platform/backend && tail -30 src/api/google_oauth.rs
```

=== Action Results ===
bash: OK
    Router::new()
        .route("/authorize", get(google_authorize_handler))
        .route("/callback", get(google_callback_handler))
        .with_state(key)
}

/// Create a secure 256-bit key for cookie encryption from an environment variable
/// Falls back to a random key if COOKIE_SECRET is not set (development only)
///
/// # Panics
/// Panics at startup if COOKIE_SECRET is set but not valid hex.
/// This is intentional to fail fast during deployment rather than at runtime.
pub fn get_coo
```

## Last Failure (Tue Jan 13 18:42:29 CET 2026)
```
</think>

<bash>
<command>echo hello</command>
</bash></invoke>

=== Action Results ===
bash: FAIL
/bin/sh: -c: line 0: syntax error near unexpected token `newline'
/bin/sh: -c: line 0: `<command>echo hello</command>'


=== LLM Response ===
<think>
The bash commands are failing with a syntax error. This seems strange. Let me try a different approach - maybe I need to escape things differently. Let me try without the multiline format.
</think>

bash
<command>ls veligo-platform/backend/src/api/google_oauth.rs</command>
</bash>
```

## Last Failure (Tue Jan 13 18:42:59 CET 2026)
```

=== Action Results ===
bash: OK
     382 veligo-platform/backend/src/api/google_oauth.rs
// Trace: 2025-12-26 - Google OAuth2 API Routes
//
// Endpoints:
// - GET  /api/auth/google/authorize  - Get authorization URL
// - GET  /api/auth/google/callback   - OAuth callback handler

use axum::{
    extract::{Extension, Query},
    http::StatusCode,
    response::{IntoResponse, Redirect},
    routing::get,
    Json, Router,
};
use axum_extra::extract::cookie::{Cookie, PrivateCookieJar};
use rand::RngCore;
use serde::{Deserialize, S
```

## Last Failure (Wed Jan 14 08:27:09 CET 2026)
```
bash: OK
// Trace: 2025-12-26 - Google OAuth2 API Routes
//
// Endpoints:
// - GET  /api/auth/google/authorize  - Get authorization URL
// - GET  /api/auth/google/callback   - OAuth callback handler

use axum::{
    extract::{Extension, Query},
    http::StatusCode,
    response::{IntoResponse, Redirect},
    routing::get,
    Json, Router,
};
use axum_extra::extract::cookie::{Cookie, PrivateCookieJar};
use rand::RngCore;
use serde::{Deserialize, Serialize};
use sqlx::PgPool;
use utoipa::ToSchema;
use uu
```

## Last Failure (Wed Jan 14 08:27:48 CET 2026)
```
grep -rn "get_cookie_key" veligo-platform/backend/src/
```

<invoke>
<bash>
<command>grep -rn "get_cookie_key" veligo-platform/backend/src/</command>
</bash>
</invoke>

=== Action Results ===
bash: OK
veligo-platform/backend/src/bin/http-server.rs:33:    get_cookie_key,      // 2025-12-26: Cookie key for OAuth state
veligo-platform/backend/src/bin/http-server.rs:166:    let cookie_key = get_cookie_key();
veligo-platform/backend/src/api/mod.rs:47:pub use google_oauth::{get_cookie_key, google_oauth_routes};
veligo-platform/backend/src/api/google_oauth.rs:365:pub fn get_cookie_key() -> Key {

---
bash: FAIL
/bin/sh: -c: line 0: syntax error near unexpected token `newline'
/bin/sh: -c: line 0: `<command>grep -rn "get_cookie_key" veligo-platform/backend/src/</command>'
```

## Last Failure (Wed Jan 14 08:28:20 CET 2026)
```
</think>

```bash
sed -n '365,382p' veligo-platform/backend/src/api/google_oauth.rs && echo "---END OF FILE---"
```

=== Action Results ===
bash: OK
pub fn get_cookie_key() -> Key {
    if let Ok(secret) = std::env::var("COOKIE_SECRET") {
        // Secret should be at least 64 hex chars (32 bytes = 256 bits)
        match hex::decode(&secret) {
            Ok(bytes) => Key::from(&bytes),
            Err(e) => {
                eprintln!(
                    "[FATAL] COOKIE_SECRET is not valid hex: {}. Server cannot start securely.",
                    e
                );
                panic!("COOKIE_SECRET must be valid hex: {}", e);
  
```

## Last Failure (Wed Jan 14 08:29:38 CET 2026)
```
[0;32m[AGENT] Real Agent starting[0m
[0;34m[AGENT] Task: /Users/sylvain/_LAPOSTE/_VELIGO2/tools/ralph-wiggum/tasks/T108.md[0m
[0;34m[AGENT] Queue: tdd[0m
[0;34m[AGENT] Backend: local[0m
[0;32m[AGENT] Starting task: T108[0m
[0;34m[AGENT] Iteration 1/10[0m

============================================================
RESULT: FAILED
============================================================
ERROR: LLM call failed
```

## Last Failure (Wed Jan 14 08:33:31 CET 2026)
```
[0;32m[AGENT] Real Agent starting[0m
[0;34m[AGENT] Task: /Users/sylvain/_LAPOSTE/_VELIGO2/tools/ralph-wiggum/tasks/T108.md[0m
[0;34m[AGENT] Queue: tdd[0m
[0;34m[AGENT] Backend: local[0m
[0;32m[AGENT] Starting task: T108[0m
[0;34m[AGENT] Iteration 1/10[0m
[0;31m[AGENT] Local LLM failed: ('Connection aborted.', ConnectionResetError(54, 'Connection reset by peer'))[0m

============================================================
RESULT: FAILED
============================================================
ERROR: LLM call failed
```

## Last Failure (Wed Jan 14 08:33:38 CET 2026)
```
[0;32m[AGENT] Real Agent starting[0m
[0;34m[AGENT] Task: /Users/sylvain/_LAPOSTE/_VELIGO2/tools/ralph-wiggum/tasks/T108.md[0m
[0;34m[AGENT] Queue: tdd[0m
[0;34m[AGENT] Backend: local[0m
[0;32m[AGENT] Starting task: T108[0m
[0;34m[AGENT] Iteration 1/10[0m
[0;31m[AGENT] Local LLM failed: HTTPConnectionPool(host='127.0.0.1', port=8002): Max retries exceeded with url: /v1/chat/completions (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x106618590>: Failed to establish a new connection: [Errno 61] Connection refused'))[0m

============================================================
RESULT: FAILED
============================================================
ERROR: LLM call failed
```
