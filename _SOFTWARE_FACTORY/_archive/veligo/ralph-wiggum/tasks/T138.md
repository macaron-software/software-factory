# Task T138: Create E2E Journey - franceconnect-login

**Priority**: P1
**Queue**: TDD
**AO_REF**: AO-IDFM-AUTH-3.1.3
**Tenant**: idfm

## Description
Missing E2E journey: franceconnect-login - User logs in via FranceConnect SSO

Journey: User logs in via FranceConnect SSO

## File to Create
tests/e2e/journeys/idfm-franceconnect-login.spec.ts

## Test Template
```typescript
import { test, expect } from '@playwright/test';
import { users } from '../fixtures/users.json';
import { stations } from '../fixtures/stations.json';

const BASE_URL = process.env.IDFM_URL || 'https://idfm.veligo.app';

test.describe('[AO-IDFM-AUTH-3.1.3] franceconnect-login', () => {

  test('Complete franceconnect-login journey', async ({ page }) => {
    // Step 1: Navigate to starting point
    await page.goto(`${BASE_URL}/`);

    // Step 2: User actions
    // TODO: Implement User logs in via FranceConnect SSO

    // Step 3: Verify success
    await expect(page.locator('[data-testid="success-message"]')).toBeVisible();
  });

});

```

## Required Selectors
- Navigation: `[data-testid="nav-*"]`
- Forms: `[data-testid="form-*"]`
- Buttons: `[data-testid="btn-*"]`
- Status: `[data-testid="status-*"]`

## Success Criteria
- [ ] Test file created with proper structure
- [ ] All user steps implemented
- [ ] Selectors use data-testid
- [ ] Test runs without skip
- [ ] AO compliance verified

## Ralph Status Block
---RALPH_STATUS---
STATUS: COMPLETED
COMPLEXITY: medium
WSJF: 8
---END_RALPH_STATUS---

## Last Failure (Tue Jan 13 18:54:47 CET 2026)
```
 *
 * Tests:
 * - Login with email/password
 * - Logout flow
 * - SSO buttons (FranceConnect, Google, Microsoft)
 * - Session management
 * - Protected routes
 * - Token refresh
 *
 * Run with: npx playwright test tests/e2e/auth.spec.ts
 */

import { test, expect, type Page } from '@playwright/test';

const BASE_URL = process.env.BASE_URL || 'http://localhost:5173';

// Test credentials
const validCredentials = {
  email: 'user@example.com',
  password:
```

## Last Failure (Tue Jan 13 18:55:15 CET 2026)
```
=== LLM Response ===
<think>
There are already existing FranceConnect tests! Let me look at the specific IDFM FranceConnect tests to understand the patterns better.
</think>

<bash>
cd /Users/sylvain/_LAPOSTE/_VELIGO2 && cat tests/e2e/ao-compliance/idfm/franceconnect-sso.spec.ts</bash>

=== Action Results ===
bash: OK
// ============================================================================
// üîê AO-IDFM-¬ß3.1.3 - FRANCECONNECT SSO (SIMPLIFIED)
// ============================================================================
// **AO Ref:** IDFM Cyclonova T1 p.24 ¬ß3.1.3
// **Tests:** 4 critical tests - Simplified without helper dependencies
// ============================================================================

import { test, expect } from '@playwright/test';

const IDFM_BASE_URL = process.env.IDFM_
```

## Last Failure (Tue Jan 13 18:56:20 CET 2026)
```
=== LLM Response ===
<think>
The file is only 156 lines but the output seems truncated. Let me get the full file content.
</think>

<bash>
cd /Users/sylvain/_LAPOSTE/_VELIGO2 && cat tests/e2e/ao-compliance/idfm/franceconnect-sso.spec.ts 2>/dev/null | head -200</bash>

=== Action Results ===
bash: OK
// ============================================================================
// üîê AO-IDFM-¬ß3.1.3 - FRANCECONNECT SSO (SIMPLIFIED)
// ============================================================================
// **AO Ref:** IDFM Cyclonova T1 p.24 ¬ß3.1.3
// **Tests:** 4 critical tests - Simplified without helper dependencies
// ============================================================================

import { test, expect } from '@playwright/test';

const IDFM_BASE_URL = process.env.IDFM_
```

## Last Failure (Wed Jan 14 08:33:31 CET 2026)
```
import { users } from '../fixtures/users.json';
import { stations } from '../fixtures/stations.json';

const BASE_URL = process.env.IDFM_URL || 'https://idfm.veligo.app';

test.describe('[AO-IDFM-AUTH-3.1.3] franceconnect-login', () => {

  test('Complete franceconnect-login journey', async ({ page }) => {
    // Step 1: Navigate to starting point
    await page.goto(`${BASE_URL}/`);

    // Step 2: User actions - Click FranceConnect login button
    await page.click('[data-testid="btn-franceconnect-login"]');

    // Wait for FranceConnect authentication page to load
    await page.waitForURL(/.*franceconnect.fr.*/);

    // Simulate FranceConnect login with 

ERROR: LLM call failed
```

## Last Failure (Wed Jan 14 08:33:38 CET 2026)
```
[0;32m[AGENT] Real Agent starting[0m
[0;34m[AGENT] Task: /Users/sylvain/_LAPOSTE/_VELIGO2/tools/ralph-wiggum/tasks/T138.md[0m
[0;34m[AGENT] Queue: tdd[0m
[0;34m[AGENT] Backend: local[0m
[0;32m[AGENT] Starting task: T138[0m
[0;34m[AGENT] Iteration 1/10[0m
[0;31m[AGENT] Local LLM failed: HTTPConnectionPool(host='127.0.0.1', port=8002): Max retries exceeded with url: /v1/chat/completions (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x10aa30590>: Failed to establish a new connection: [Errno 61] Connection refused'))[0m

============================================================
RESULT: FAILED
============================================================
ERROR: LLM call failed
```

## Last Failure (Wed Jan 14 08:33:44 CET 2026)
```
[0;32m[AGENT] Real Agent starting[0m
[0;34m[AGENT] Task: /Users/sylvain/_LAPOSTE/_VELIGO2/tools/ralph-wiggum/tasks/T138.md[0m
[0;34m[AGENT] Queue: tdd[0m
[0;34m[AGENT] Backend: local[0m
[0;32m[AGENT] Starting task: T138[0m
[0;34m[AGENT] Iteration 1/10[0m
[0;31m[AGENT] Local LLM failed: HTTPConnectionPool(host='127.0.0.1', port=8002): Max retries exceeded with url: /v1/chat/completions (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x108c5c590>: Failed to establish a new connection: [Errno 61] Connection refused'))[0m

============================================================
RESULT: FAILED
============================================================
ERROR: LLM call failed
```
