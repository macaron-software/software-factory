# Task T137: Create E2E Journey - booking-flow

**Priority**: P1
**Queue**: TDD
**AO_REF**: AO-IDFM-BOOKING-3.2
**Tenant**: idfm

## Description
Missing E2E journey: booking-flow - User searches station, books bike, rides, returns

Journey: User searches station, books bike, rides, returns

## File to Create
tests/e2e/journeys/idfm-booking-flow.spec.ts

## Test Template
```typescript
import { test, expect } from '@playwright/test';
import { users } from '../fixtures/users.json';
import { stations } from '../fixtures/stations.json';

const BASE_URL = process.env.IDFM_URL || 'https://idfm.veligo.app';

test.describe('[AO-IDFM-BOOKING-3.2] booking-flow', () => {

  test('Complete booking-flow journey', async ({ page }) => {
    // Step 1: Navigate to starting point
    await page.goto(`${BASE_URL}/`);

    // Step 2: User actions
    // TODO: Implement User searches station, books bike, rides, returns

    // Step 3: Verify success
    await expect(page.locator('[data-testid="success-message"]')).toBeVisible();
  });

});

```

## Required Selectors
- Navigation: `[data-testid="nav-*"]`
- Forms: `[data-testid="form-*"]`
- Buttons: `[data-testid="btn-*"]`
- Status: `[data-testid="status-*"]`

## Success Criteria
- [ ] Test file created with proper structure
- [ ] All user steps implemented
- [ ] Selectors use data-testid
- [ ] Test runs without skip
- [ ] AO compliance verified

## Ralph Status Block
---RALPH_STATUS---
STATUS: COMPLETED
COMPLEXITY: medium
WSJF: 8
---END_RALPH_STATUS---

## Last Failure (Tue Jan 13 18:54:50 CET 2026)
```
---
bash: OK
/**
 * User Dashboard Journey E2E Tests
 * TDD Red Phase - Tests for user dashboard and bookings history
 *
 * PR-009: User Dashboard - Bookings History
 *
 * User Story:
 * As a logged-in user, I want to see my dashboard with:
 * - Active/upcoming bookings
 * - Recent booking history
 * - Quick actions (new booking, return bike)
 * - Subscription status
 *
 * Run with: npx playwright test journeys/03-user-dashboard.spec.ts
 */

import { test, expect, type Page } from "@playwright/test";
import 
```

## Last Failure (Tue Jan 13 18:56:57 CET 2026)
```
    // Step 6: Fi

=== LLM Response ===
It seems the write tag isn't working. Let me try a different approach - checking if there's an existing file structure first:

```bash
ls -la veligo-platform/tests/e2e/journeys/ && cat veligo-platform/tests/e2e/journeys/*.spec.ts 2>/dev/null | head -20
```

=== Action Results ===
bash: OK
total 1080
drwxr-xr-x  30 sylvain  staff    960 Jan  9 09:12 .
drwxr-xr-x  53 sylvain  staff   1696 Jan 13 16:11 ..
-rw-------   1 sylvain  staff  30363 Jan  5 08:08 01-registration.spec.ts
-rw-r--r--   1 sylvain  staff  16402 Jan  5 08:08 02-landing-catalog.spec.ts
-rw-r--r--   1 sylvain  staff  21275 Jan  5 08:08 03-user-dashboard.spec.ts
-rw-------   1 sylvain  staff  17812 Jan  5 08:08 04-admin-dashboard.spec.ts
-rw-------   1 sylvain  staff  30247 Jan  5 08:08 05-rgpd.spec.ts
-rw-------   1
```

## Last Failure (Tue Jan 13 18:58:11 CET 2026)
```
=== Action Results ===
bash: OK
/**
 * E2E Journey Tests - Booking Complete
 * TDD Red Phase - Real selectors, real fixtures, real API calls
 *
 * Personas tested:
 * - USER_IDFM: User with active subscription, can book bikes
 * - USER_NANTES: User with Naolib integration
 * - USER_LYON: User with TCL multimodal integration
 *
 * Journeys covered:
 * 1. Browse stations (map + list)
 * 2. Select station
 * 3. Select bike
 * 4. Choose time slot
 * 5. Confirm booking
 * 6. Pickup instructions
 * 7. Cancel booking
 * 8. Booking hi
```

## Last Failure (Wed Jan 14 08:33:32 CET 2026)
```

    // 6. Follow pickup instructions (e.g., confirm pickup)
    const pickupConfirmBtn = page.locator('[data-testid="btn-pickup-confirm"]');
    await pickupConfirmBtn.click();

    // 7. Simulate ride (wait 5 minutes)
    await page.waitForTimeout(5000);

    // 8. Return bike at station
    const returnBikeBtn = page.locator('[data-testid="btn-return-bike"]');
    await returnBikeBtn.click();

    // 9. Confirm return
    const returnConfirmBtn = page.locator('[data-testid="btn-return-confirm"]');
    await returnConfirmBtn.click();

    // Step 3: Verify success
    await expect(page.locator('[dat

ERROR: LLM call failed
```

## Last Failure (Wed Jan 14 08:33:38 CET 2026)
```
[0;32m[AGENT] Real Agent starting[0m
[0;34m[AGENT] Task: /Users/sylvain/_LAPOSTE/_VELIGO2/tools/ralph-wiggum/tasks/T137.md[0m
[0;34m[AGENT] Queue: tdd[0m
[0;34m[AGENT] Backend: local[0m
[0;32m[AGENT] Starting task: T137[0m
[0;34m[AGENT] Iteration 1/10[0m
[0;31m[AGENT] Local LLM failed: HTTPConnectionPool(host='127.0.0.1', port=8002): Max retries exceeded with url: /v1/chat/completions (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x108eb4590>: Failed to establish a new connection: [Errno 61] Connection refused'))[0m

============================================================
RESULT: FAILED
============================================================
ERROR: LLM call failed
```

## Last Failure (Wed Jan 14 08:33:44 CET 2026)
```
[0;32m[AGENT] Real Agent starting[0m
[0;34m[AGENT] Task: /Users/sylvain/_LAPOSTE/_VELIGO2/tools/ralph-wiggum/tasks/T137.md[0m
[0;34m[AGENT] Queue: tdd[0m
[0;34m[AGENT] Backend: local[0m
[0;32m[AGENT] Starting task: T137[0m
[0;34m[AGENT] Iteration 1/10[0m
[0;31m[AGENT] Local LLM failed: HTTPConnectionPool(host='127.0.0.1', port=8002): Max retries exceeded with url: /v1/chat/completions (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x10b0a0590>: Failed to establish a new connection: [Errno 61] Connection refused'))[0m

============================================================
RESULT: FAILED
============================================================
ERROR: LLM call failed
```
