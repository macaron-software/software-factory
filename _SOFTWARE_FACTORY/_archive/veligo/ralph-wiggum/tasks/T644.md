# Task T644: Implement PaymentAdapterFactory with factory pattern

**Priority**: P1
**WSJF Score**: 8.0
**Queue**: TDD
**Parent**: T623
**Generated by**: Fractal LLM Delegation

## Description
Implement PaymentAdapterFactory with factory pattern

## Reason for Delegation
Task requires implementation of two payment adapters (Paynum + Stripe), factory pattern, and integration tests across multiple files, touching backend infrastructure and testing layers. This spans more than 5 files and involves HTTP clients, API integrations, and test mocking.

## Success Criteria
- [ ] Task completed
- [ ] Tests pass
- [ ] No stubs or TODOs

## Ralph Status Block
---RALPH_STATUS---
STATUS: FAILED
COMPLEXITY: medium
PARENT_TASK: T623
---END_RALPH_STATUS---

## Last Failure (Wed Jan 14 17:54:14 CET 2026)
```
```

=== Action Results ===
bash: OK
// Trace: Sprint 004 - 2025-12-11T12:46:10Z - Payment Domain Types

use serde::{Deserialize, Serialize};

/// Payment status following standard payment flow
#[derive(Debug, Clone, PartialEq, Eq, Serialize, Deserialize)]
pub enum PaymentStatus {
    /// Payment initiated, awaiting user action
    Pending,
    /// Payment processing by provider
    Processing,
    /// Payment successful
    Succeeded,
    /// Payment failed (insufficient funds, declined, etc.)
    Failed,
    /// Payment cancelled
```

## Last Failure (Wed Jan 14 17:54:51 CET 2026)
```
use super::{build_test_app_with_user, TestClient};

/// Helper to create test context with user/tenant
fn test_context(pool: PgPool) -> 
---
bash: OK
// Trace: 2025-12-27 - Payment API Integration Tests
// Reference: Stripe payment flow testing with sqlx::test
// Purpose: Test payment methods CRUD, invoices, and Stripe integration

use axum::http::StatusCode;
use sqlx::PgPool;
use uuid::Uuid;

use super::{build_test_app_with_user, AddPaymentMethodPayload, TestClient, TestUser};

/// Helper to create test context with user/tenant
fn test_context(pool: PgPool) -> (TestClient, Uuid, Uuid) {
    let user_id = Uuid::new_v4();
    let tenant_id = U
```

## Last Failure (Wed Jan 14 17:55:19 CET 2026)
```
use std::fmt::Debug;

/// Supported payment provider types
#[derive(Debug, Clone, PartialEq)]
pub enum PaymentProvider {
    Stripe,
    Paynum,
}

/// Factory for creating payment adapters
#[derive(Debug)]
pub struct PaymentAdapterFactory;

impl PaymentAdapterFactory {
    /// Create a payment adapter for the given provide
---
bash: OK
pub mod adapter;
pub mod adapters;
pub mod factory;
```

## Last Failure (Wed Jan 14 17:55:25 CET 2026)
```
=== Action Results ===
bash: OK
// Trace: Sprint 004 - 2025-12-11T12:46:10Z - Payment Aggregate (DDD)

use chrono::{DateTime, Utc};
use serde::{Deserialize, Serialize};
use uuid::Uuid;

use super::types::{
    Money, PaymentError, PaymentMetadata, PaymentMethod, PaymentProvider, PaymentStatus,
};

/// Payment Aggregate Root (DDD)
///
/// Represents a payment transaction in the system.
/// Invariants:
/// - Amount must be > 0
/// - Status transitions follow allowed flow
/// - Cannot refund more than paid amount
#[derive(Debug, 
```

## Last Failure (Wed Jan 14 17:55:49 CET 2026)
```
Let me try to use the file system directly to explore the project structure without relying on bash first. I'll try writing files to see if that works.
</think>

<invoke><bash>
<command>ls /</command>
 <timeout></timeout>
</bash></invoke>

=== Action Results ===
bash: FAIL
/bin/sh: -c: line 0: syntax error near unexpected token `newline'
/bin/sh: -c: line 0: `<command>ls /</command>'


=== LLM Response ===
<think>
Something is wrong with the bash command format. Let me try without the XML tags.
</think>

ls /
```

## Last Failure (Wed Jan 14 17:56:23 CET 2026)
```


=== LLM Response ===
<think>
The backend directory seems to exist but has limited content. Let me check the overall structure better.
</think>

```bash
ls -la /Users/sylvain/_LAPOSTE/_VELIGO2/backend/.sqlx
```

=== Action Results ===
bash: OK
total 232
drwxr-xr-x  31 sylvain  staff   992 Dec 26 00:34 .
drwxr-xr-x@  3 sylvain  staff    96 Dec 26 00:34 ..
-rw-r--r--@  1 sylvain  staff   365 Dec 26 00:33 query-1247ce3095dd3e62ff5eb8c24312e7377f5a1a7b31fa9c290a0557e6d752b064.json
-rw-r--r--@  1 sylvain  staff   411 Dec 26 00:33 query-1cd16168a2615d8e538efa98a254c7a241dfb05bb9453f3ccc4869c3b62cd1fe.json
-rw-r--r--@  1 sylvain  staff   648 Dec 26 00:33 query-20bb5f5aaac4c6fa58b87c297687f44b7a1da2c4afec7ae1b270b4973f5a931f.json
-rw-r--r--@ 
```
