# Task T401: Attribution aide IDFM (50%)

**Priority**: P1
**WSJF Score**: 8.5
**Queue**: TDD
**Category**: AO_COMPLIANCE
**Original ID**: AO-IDFM-002
**Phase**: üéØ PHASE 2: COMPLIANCE AO (Priority P1)
**Section**: 2.1 IDFM - FranceConnect

## Description
Attribution aide IDFM (50%)

## Test File
`ao/idfm-subsidy.spec.ts`

## Estimated Files
3 fichier(s) √† modifier

## Success Criteria
- [ ] Test E2E cr√©√©/modifi√©: `ao/idfm-subsidy.spec.ts`
- [ ] Test passe en local
- [ ] Pas de test.skip() sans condition
- [ ] Code review adversarial pass√©
- [ ] Pas de stubs ou TODOs

## Definition of Done (DoD)
- [ ] Feature compl√®tement impl√©ment√©e
- [ ] Tests E2E verts
- [ ] Conformit√© AO v√©rifi√©e (si applicable)
- [ ] Documentation mise √† jour

## Ralph Status Block


## Fractal Decomposition
**Status**: DECOMPOSED
**Sub-tasks**: T508, T508, T508
**Timestamp**: 2026-01-14T13:30:48.049298

This task was too large and has been decomposed into smaller sub-tasks.

---RALPH_STATUS---
STATUS: DECOMPOSED
COMPLEXITY: medium
WSJF: 8.5
CATEGORY: AO_COMPLIANCE
ORIGINAL_ID: AO-IDFM-002
---END_RALPH_STATUS---

## Last Failure (Wed Jan 14 13:27:21 CET 2026)
```

<bash>
sed -n '1,200p' ./tools/ralph-wiggum/tasks/tests/ao/idfm-franceconnect-v2.spec.ts</bash>

=== Action Results ===
bash: OK
import { test, expect } from '@playwright/test';

test.describe('AO-IDFM-001: Authentification FranceConnect v2', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/login');
  });

  test('DEV-001: Bouton FranceConnect sur page login', async ({ page }) => {
    await expect(page.locator('[data-testid="franceconnect-btn"]')).toBeVisible();
  });

  test('DEV-002: Redirect vers FranceConnect', async ({ page }) => {
    await page.click('[data-testid="franceconnect-btn"]');
    
```

## Last Failure (Wed Jan 14 13:28:59 CET 2026)
```
cat ./veligo-platform/backend/src/services/pricing/subsidy_calculator.rs | head -300</bash>

=== Action Results ===
bash: OK
//! AOM Subsidy Calculator
//!
//! Calculates subsidies (aides AOM) for bike subscriptions based on tenant-specific rules.
//!
//! AO Requirements:
//! - IDFM (V√©ligo): 50% du loyer mensuel, plafond 600‚Ç¨/an
//! - Nantes (Naolib): Forfait 100‚Ç¨ √† la souscription
//! - Lyon (TCL): 25% du loyer, plafond 150‚Ç¨/an
//!
//! Subsidies must be displayed in the cart BEFORE payment (AO requirement).

use axum::{
    extract::{Path, Query, State},
    http::StatusCode,
    middleware,
    routing::{get, post}
```

## Last Failure (Wed Jan 14 13:29:48 CET 2026)
```
     657 ./veligo-platform/backend/src/services/pricing/subsidy_calculator.rs

---
bash: OK
            billing_period,
        )
        .await
    {
        Ok(calc) => Ok(Json(ApiResponse::ok(calc))),
        Err(e) => Ok(Json(ApiResponse::err(e.message))),
    }
}

/// POST /api/pricing/subsidy/calculate
/// Calculate subsidy for authenticated user
async fn calculate_subsidy(
    State(state): State<SubsidyState>,
    Json(req): Json<CalculateSubsidyRequest>,
) -> Result<Json<ApiResponse<SubsidyCalculation>>, StatusCode> {
    let calculator = SubsidyCalculator::new(state.pool.clon
```

## Last Failure (Wed Jan 14 13:30:09 CET 2026)
```
sed -n '1,100p' veligo-platform/backend/src/services/pricing/subsidy_calculator.rs</bash>

=== Action Results ===
bash: OK
//! AOM Subsidy Calculator
//!
//! Calculates subsidies (aides AOM) for bike subscriptions based on tenant-specific rules.
//!
//! AO Requirements:
//! - IDFM (V√©ligo): 50% du loyer mensuel, plafond 600‚Ç¨/an
//! - Nantes (Naolib): Forfait 100‚Ç¨ √† la souscription
//! - Lyon (TCL): 25% du loyer, plafond 150‚Ç¨/an
//!
//! Subsidies must be displayed in the cart BEFORE payment (AO requirement).

use axum::{
    extract::{Path, Query, State},
    http::StatusCode,
    middleware,
    routing::{get, post}
```

## Last Failure (Wed Jan 14 13:30:42 CET 2026)
```
<bash>
find ./veligo-platform/frontend -name "cart*" -o -name "*cart*.svelte" 2>/dev/null | head -10</bash>

=== Action Results ===
bash: OK
total 584
drwxr-xr-x  17 sylvain  staff    544 Jan  2 00:05 .
drwxr-xr-x   8 sylvain  staff    256 Dec 31 10:35 ..
-rw-r--r--   1 sylvain  staff  29907 Dec 30 15:25 admin.spec.ts
-rw-r--r--   1 sylvain  staff  25762 Dec 30 15:25 auth.spec.ts
-rw-r--r--   1 sylvain  staff  27844 Dec 30 15:25 booking.spec.ts
-rw-r--r--   1 sylvain  staff  15677 Dec 30 15:25 catalog.spec.ts
-rw-------   1 sylvain  staff  14906 Dec 30 14:39 first-booking.spec.ts
drwxr-xr-x   6 sylvain  staff    192 Dec 30 20:08 fixt
---
bash: OK

---
bash: OK
./veligo-platform/frontend/node_modules/lucide-svelte/dist/icons/shopping-cart.svelte
```
