# Task T1052: Ensure test isolation and proper dependency injection in tes

**Priority**: P1
**WSJF Score**: 8.0
**Queue**: TDD
**Parent**: T1026
**Generated by**: Fractal LLM Delegation

## Description
Ensure test isolation and proper dependency injection in test setup

## Reason for Delegation
Task requires unit tests for StripeProcessor across multiple files (StripeProcessor, PaymentAdapterFactory, and related test files) with complex interactions involving dependency injection, factory pattern, and test isolation. Touches 4+ files in backend/src/payment directory and associated test files, exceeding 400 LOC and involving multiple domains.

## Success Criteria
- [ ] Task completed
- [ ] Tests pass
- [ ] No stubs or TODOs

## Ralph Status Block
---RALPH_STATUS---
STATUS: FAILED
COMPLEXITY: medium
PARENT_TASK: T1026
---END_RALPH_STATUS---

## Last Failure (Wed Jan 14 20:24:15 CET 2026)
```
tower = { version = "0.4", features = ["util", "filter"] }

# Configuration
config = "0.13"

# Database
sqlx = { ver

=== LLM Response ===
<think>
There's a syntax error in Cargo.toml at line 49. Let me fix it and then run the tests.
</think>

<bash>
cat veligo-platform/backend/Cargo.toml | grep -n "serde_json"</bash>

=== Action Results ===
bash: OK
37:serde_json = "1.0"
49:serde_json = "1.0"-e 
```

## Last Failure (Wed Jan 14 20:24:54 CET 2026)
```
sed -n '100,200p' veligo-platform/backend/tests/integration/payment_tests.rs
```

=== Action Results ===
bash: OK
#[sqlx::test]
async fn test_add_payment_method_as_default(pool: PgPool) {
    let (client, _, _) = test_context(pool);

    let payload = AddPaymentMethodPayload {
        payment_method_id: "pm_test_card_mastercard".to_string(),
        set_as_default: Some(true),
    };

    let response = client.post("/api/payment/methods", &payload).await;

    response.assert_status(StatusCode::CREATED);

    let body: serde_json::Value = response.json();
    assert_eq!(body["data"]["is_default"], true, "Sh
```

## Last Failure (Wed Jan 14 20:25:26 CET 2026)
```
</edit>

=== Action Results ===
bash: OK
        currency: &str,
        customer_id: Option<&str>,
    ) -> Result<String, String>;
    
    /// Captures a previously created payment intent
    async fn capture_payment_intent(&self, payment_intent_id: &str) -> Result<String, String>;
    
    /// Creates a refund for a payment intent
    async fn refund_payment_intent(
        &self,
        payment_intent_id: &str,
        amount: Option<&str>,
    ) -> Result<String, String>;
    
    /// Creates a customer in Stripe
    async fn cr
```
