#!/bin/bash
# Pre-commit hook - Linters + Auto-fix + Security
# Blocks commit if critical errors found, auto-fixes style issues

set -e

echo "üîç Running pre-commit checks..."

# Detect staged files
CHANGED_PY=$(git diff --cached --name-only --diff-filter=ACMR | grep '\.py$' || true)
CHANGED_JS=$(git diff --cached --name-only --diff-filter=ACMR | grep '\.\(js\|ts\|jsx\|tsx\)$' || true)
CHANGED_MD=$(git diff --cached --name-only --diff-filter=ACMR | grep '\.md$' || true)

HAS_ERRORS=0

# ============================================================================
# Python: Ruff + Bandit
# ============================================================================
if [ -n "$CHANGED_PY" ]; then
  echo "üêç Linting Python files..."
  
  # Ruff check + auto-fix
  if command -v ruff &> /dev/null; then
    if ! ruff check $CHANGED_PY --fix; then
      echo "‚ùå Ruff found errors that couldn't be auto-fixed"
      HAS_ERRORS=1
    fi
    
    # Ruff format (auto-fix style)
    ruff format $CHANGED_PY
    
    # Re-stage auto-fixed files
    git add $CHANGED_PY
  else
    echo "‚ö†Ô∏è  Ruff not installed (run: make install-hooks)"
  fi
  
  # Bandit security check
  if command -v bandit &> /dev/null; then
    if ! bandit -ll -f txt $CHANGED_PY 2>&1 | grep -v "No issues identified"; then
      echo "‚ö†Ô∏è  Bandit found security issues (warnings only)"
    fi
  fi
fi

# ============================================================================
# JavaScript/TypeScript: ESLint + Prettier
# ============================================================================
if [ -n "$CHANGED_JS" ]; then
  echo "üì¶ Linting JavaScript/TypeScript files..."
  
  # ESLint check + auto-fix
  if command -v eslint &> /dev/null; then
    if ! eslint $CHANGED_JS --fix --quiet; then
      echo "‚ùå ESLint found errors"
      HAS_ERRORS=1
    fi
  else
    echo "‚ö†Ô∏è  ESLint not installed (run: make install-hooks)"
  fi
  
  # Prettier format
  if command -v prettier &> /dev/null; then
    prettier --write $CHANGED_JS
  fi
  
  # Re-stage auto-fixed files
  git add $CHANGED_JS
fi

# ============================================================================
# Secrets Detection
# ============================================================================
echo "üîí Checking for secrets..."
if command -v detect-secrets &> /dev/null; then
  if ! detect-secrets scan --baseline .secrets.baseline 2>&1 | grep -q "0 new secrets"; then
    echo "‚ùå Potential secrets detected!"
    echo "Run: detect-secrets audit .secrets.baseline"
    HAS_ERRORS=1
  fi
else
  echo "‚ö†Ô∏è  detect-secrets not installed (optional)"
fi

# ============================================================================
# Final Result
# ============================================================================
if [ $HAS_ERRORS -ne 0 ]; then
  echo ""
  echo "‚ùå Pre-commit checks failed!"
  echo "Fix errors above or use: git commit --no-verify (not recommended)"
  exit 1
fi

echo "‚úÖ Pre-commit checks passed!"
exit 0
