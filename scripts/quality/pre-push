#!/bin/bash
# Pre-push hook - Full tests + Coverage + Security scan
# Blocks push if tests fail or coverage < thresholds

set -e

echo "üöÄ Running pre-push checks..."

HAS_ERRORS=0

# ============================================================================
# Python Tests + Coverage (‚â•80%)
# ============================================================================
echo "üß™ Running Python tests with coverage..."
if command -v pytest &> /dev/null; then
  if ! pytest --cov=platform --cov=skills_injection --cov-report=term --cov-fail-under=80 -x -q 2>&1 | tee /tmp/pytest-output.txt; then
    echo "‚ùå Python tests failed or coverage <80%"
    HAS_ERRORS=1
  else
    echo "‚úÖ Python tests passed with ‚â•80% coverage"
  fi
else
  echo "‚ö†Ô∏è  Pytest not installed, skipping Python tests"
fi

# ============================================================================
# JavaScript Tests + Coverage (‚â•75%) - if exists
# ============================================================================
if [ -f "package.json" ]; then
  echo "üß™ Running JavaScript tests with coverage..."
  if command -v jest &> /dev/null; then
    if ! jest --coverage --coverageThreshold='{"global":{"lines":75}}' --silent 2>&1; then
      echo "‚ùå Jest tests failed or coverage <75%"
      HAS_ERRORS=1
    else
      echo "‚úÖ JavaScript tests passed with ‚â•75% coverage"
    fi
  else
    echo "‚ö†Ô∏è  Jest not installed, skipping JS tests"
  fi
fi

# ============================================================================
# Security Scans
# ============================================================================
echo "üîí Running security scans..."

# Safety: Python dependencies
if command -v safety &> /dev/null; then
  if ! safety check --bare 2>&1 | grep -q "No known security vulnerabilities found"; then
    echo "‚ö†Ô∏è  Python dependencies have known vulnerabilities (warning only)"
  fi
else
  echo "‚ö†Ô∏è  Safety not installed"
fi

# npm audit: JavaScript dependencies
if [ -f "package.json" ]; then
  if command -v npm &> /dev/null; then
    if ! npm audit --audit-level=high 2>&1 | grep -q "0 vulnerabilities"; then
      echo "‚ö†Ô∏è  npm packages have high/critical vulnerabilities (warning only)"
    fi
  fi
fi

# Trivy: Container and code scan (if installed)
if command -v trivy &> /dev/null; then
  echo "üîç Running Trivy security scan..."
  if ! trivy fs --severity HIGH,CRITICAL --exit-code 0 . 2>&1 | grep -q "Total: 0"; then
    echo "‚ö†Ô∏è  Trivy found security issues (warning only)"
  fi
else
  echo "‚ö†Ô∏è  Trivy not installed (optional)"
fi

# ============================================================================
# Final Result
# ============================================================================
if [ $HAS_ERRORS -ne 0 ]; then
  echo ""
  echo "‚ùå Pre-push checks failed!"
  echo "Fix issues above or use: git push --no-verify (not recommended)"
  exit 1
fi

echo "‚úÖ Pre-push checks passed! Pushing..."
exit 0
