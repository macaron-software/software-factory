server {
    listen 80;
    server_name _;

    # Security headers
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()";
    add_header X-Permitted-Cross-Domain-Policies "none";

    # Custom error pages — show retry instead of raw 502/503/504
    proxy_intercept_errors on;
    error_page 502 503 504 @maintenance;
    location @maintenance {
        add_header Content-Type text/html;
        add_header Retry-After 10;
        return 503 '<!DOCTYPE html><html lang="fr"><head><meta charset="utf-8"><meta http-equiv="refresh" content="8;url=/"><meta name="viewport" content="width=device-width"><title>Software Factory — Mise a jour</title><style>*{box-sizing:border-box;margin:0;padding:0}body{background:#0f0a1a;color:#c084fc;font-family:JetBrains Mono,Consolas,monospace;display:flex;align-items:center;justify-content:center;min-height:100vh}.box{text-align:center;padding:2rem}.logo{font-size:1.4rem;font-weight:700;color:#a855f7;letter-spacing:2px;margin-bottom:2rem}.title{font-size:1.1rem;color:#e2d9f3;margin-bottom:1rem}.sub{color:#6b5b8d;font-size:.85rem;margin-bottom:2rem}.bar{width:200px;height:3px;background:#1a1128;border-radius:2px;margin:1.5rem auto;overflow:hidden}.fill{height:100%;background:linear-gradient(90deg,#a855f7,#f78166);border-radius:2px;animation:progress 8s linear forwards}@keyframes progress{from{width:0}to{width:100%}}.retry{color:#4a3a6a;font-size:.75rem;margin-top:1.5rem}</style></head><body><div class="box"><div class="logo">SOFTWARE FACTORY</div><div class="title">Mise a jour en cours...</div><div class="sub">Le serveur redemarre, patientez.</div><div class="bar"><div class="fill"></div></div><div class="retry">Redirection automatique dans 8s</div></div></body></html>';
    }

    # SSE: disable buffering for all SSE endpoints
    location /sse/ {
        proxy_pass http://platform:8090;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 86400s;
        proxy_connect_timeout 5s;
    }

    location ~ /api/sessions/.*/sse$ {
        proxy_pass http://platform:8090;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 86400s;
        proxy_connect_timeout 5s;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # No browser caching for HTML
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Pragma "no-cache";

    location / {
        proxy_pass http://platform:8090;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 5s;
        proxy_read_timeout 120s;
    }
}
