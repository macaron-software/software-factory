{% extends "base.html" %}

{% block content %}
<style>
.art-dash{display:flex;flex-direction:column;gap:1.2rem}
.art-kpis{display:grid;grid-template-columns:repeat(5,1fr);gap:0.7rem;margin-bottom:0.5rem}
@media(max-width:800px){.art-kpis{grid-template-columns:repeat(2,1fr)}}
.art-kpi{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);padding:0.6rem 0.8rem;text-align:center}
.art-kpi .num{font-size:1.4rem;font-weight:800;color:var(--purple)}
.art-kpi .lbl{font-size:0.62rem;color:var(--text-muted);margin-top:0.1rem;text-transform:uppercase;letter-spacing:0.03em}

.art-portfolio{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.art-portfolio-header{display:flex;align-items:center;justify-content:space-between;padding:0.65rem 1rem;background:rgba(124,58,237,.08);border-bottom:1px solid var(--border)}
.art-portfolio-title{font-size:0.85rem;font-weight:700;display:flex;align-items:center;gap:0.5rem}
.art-portfolio-title svg{width:16px;height:16px;color:var(--purple)}
.art-budget{font-size:0.68rem;display:flex;gap:0.8rem;align-items:center;color:var(--text-muted)}
.art-budget-bar{width:100px;height:5px;background:var(--bg-tertiary);border-radius:3px;overflow:hidden}
.art-budget-fill{height:100%;border-radius:3px}

.art-section{padding:0.6rem 0.8rem}
.art-block{margin-bottom:1rem;padding:0.6rem 0.7rem;background:var(--bg-tertiary);border-radius:8px;border-left:3px solid var(--blue)}
.art-block[data-type="security"]{border-left-color:var(--red)}
.art-block[data-type="rse"]{border-left-color:var(--green)}
.art-block-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:0.5rem}
.art-block-title{font-size:0.8rem;font-weight:700;display:flex;align-items:center;gap:0.4rem}
.art-block-title svg{width:14px;height:14px}
.art-block-meta{font-size:0.6rem;color:var(--text-muted)}
.art-block-lead{font-size:0.6rem;color:var(--text-secondary);margin-top:0.1rem}

.art-teams{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:0.6rem}
.art-team{padding:0.6rem;background:var(--bg-secondary);border-radius:8px;border:1px solid var(--border);transition:border-color .15s}
.art-team:hover{border-color:var(--purple-dim)}
.art-team-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:0.2rem}
.art-team-name{font-size:0.75rem;font-weight:700;color:var(--text-primary)}
.art-team-badges{display:flex;gap:0.3rem;align-items:center}
.art-team-badge{font-size:0.5rem;padding:0.1rem 0.35rem;border-radius:3px;font-weight:600}
.badge-wip{background:rgba(250,204,21,.12);color:#eab308}
.badge-cap{background:rgba(59,130,246,.12);color:var(--blue)}
.art-team-sm{font-size:0.58rem;color:var(--purple-light);margin-bottom:0.4rem}

.art-members{display:flex;flex-direction:column;gap:0.2rem}
.art-member{display:flex;align-items:center;gap:0.45rem;padding:0.2rem 0.35rem;border-radius:5px;transition:background .15s}
.art-member:hover{background:rgba(124,58,237,.06)}
.art-member-avatar{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.55rem;font-weight:700;color:#fff;flex-shrink:0;overflow:hidden}
.art-member-avatar img{width:100%;height:100%;object-fit:cover;border-radius:50%}
.art-member-info{flex:1;min-width:0}
.art-member-name{font-size:0.7rem;font-weight:600;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.art-member-tagline{font-size:0.55rem;color:var(--text-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.art-role{font-size:0.48rem;padding:0.08rem 0.3rem;border-radius:3px;font-weight:700;text-transform:uppercase;letter-spacing:0.03em;flex-shrink:0}
.r-lead{background:rgba(168,85,247,.15);color:var(--purple-light)}
.r-qa{background:rgba(250,204,21,.12);color:#eab308}
.r-devops,.r-sre,.r-cloud,.r-secops{background:rgba(59,130,246,.12);color:var(--blue)}
.r-security,.r-exploit,.r-threat-intel,.r-governance,.r-analyst,.r-review,.r-compliance{background:rgba(239,68,68,.12);color:var(--red)}
.r-data,.r-dba,.r-ml,.r-perf{background:rgba(16,185,129,.12);color:var(--green)}
.r-a11y,.r-docs,.r-ux,.r-social,.r-ethique{background:rgba(244,114,182,.12);color:#f472b6}
.r-legal{background:rgba(168,85,247,.12);color:var(--purple-light)}
.r-default{background:rgba(148,163,184,.1);color:var(--text-secondary)}

/* ── Team Modal ── */
.art-team{cursor:pointer}
.art-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:900;opacity:0;pointer-events:none;transition:opacity .2s}
.art-overlay.open{opacity:1;pointer-events:auto}
.art-modal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(.96);z-index:910;background:var(--bg-secondary);border:1px solid var(--border);border-radius:12px;width:min(520px,92vw);max-height:85vh;overflow-y:auto;opacity:0;pointer-events:none;transition:opacity .2s,transform .2s;box-shadow:0 20px 60px rgba(0,0,0,.4)}
.art-modal.open{opacity:1;pointer-events:auto;transform:translate(-50%,-50%) scale(1)}
.art-modal-head{display:flex;align-items:center;justify-content:space-between;padding:0.8rem 1rem;border-bottom:1px solid var(--border);background:rgba(124,58,237,.06)}
.art-modal-head h3{font-size:0.85rem;font-weight:700;margin:0;display:flex;align-items:center;gap:0.4rem}
.art-modal-head h3 svg{width:15px;height:15px;color:var(--purple)}
.art-modal-close{background:none;border:none;color:var(--text-muted);cursor:pointer;padding:0.2rem;border-radius:4px;display:flex}
.art-modal-close:hover{color:var(--text-primary);background:var(--bg-tertiary)}
.art-modal-close svg{width:16px;height:16px}
.art-modal-meta{display:flex;gap:0.6rem;padding:0.5rem 1rem;font-size:0.62rem;color:var(--text-muted);border-bottom:1px solid var(--border)}
.art-modal-meta span{display:flex;align-items:center;gap:0.25rem}
.art-modal-meta svg{width:12px;height:12px}
.art-modal-members{padding:0.5rem 0.7rem}
.art-modal-member{display:flex;align-items:center;gap:0.6rem;padding:0.45rem 0.5rem;border-radius:8px;cursor:pointer;transition:background .15s}
.art-modal-member:hover{background:rgba(124,58,237,.08)}
.art-modal-member-av{width:38px;height:38px;border-radius:50%;flex-shrink:0;overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:0.65rem;font-weight:700;color:#fff}
.art-modal-member-av img{width:100%;height:100%;object-fit:cover}
.art-modal-member-info{flex:1;min-width:0}
.art-modal-member-name{font-size:0.75rem;font-weight:700;color:var(--text-primary)}
.art-modal-member-tag{font-size:0.6rem;color:var(--text-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.art-modal-member-role{font-size:0.5rem;padding:0.1rem 0.35rem;border-radius:3px;font-weight:700;text-transform:uppercase;flex-shrink:0;background:rgba(124,58,237,.12);color:var(--purple-light)}
.art-modal-member-arrow{color:var(--text-muted);flex-shrink:0}
.art-modal-member-arrow svg{width:14px;height:14px}

/* ── Agent Fiche Modal ── */
.fiche-modal{width:min(560px,92vw)}
.fiche-header{display:flex;gap:1rem;padding:1rem;border-bottom:1px solid var(--border)}
.fiche-photo{width:72px;height:72px;border-radius:50%;overflow:hidden;flex-shrink:0;border:3px solid var(--purple);display:flex;align-items:center;justify-content:center;font-size:1.2rem;font-weight:800;color:#fff}
.fiche-photo img{width:100%;height:100%;object-fit:cover}
.fiche-identity{flex:1;min-width:0}
.fiche-name{font-size:1rem;font-weight:800;color:var(--text-primary);margin-bottom:0.1rem}
.fiche-role{font-size:0.65rem;font-weight:700;color:var(--purple-light);text-transform:uppercase;letter-spacing:0.04em}
.fiche-tagline{font-size:0.7rem;color:var(--text-secondary);margin-top:0.2rem}
.fiche-rank{font-size:0.55rem;color:var(--text-muted);margin-top:0.15rem;display:flex;align-items:center;gap:0.3rem}
.fiche-rank svg{width:12px;height:12px}
.fiche-body{padding:0.7rem 1rem;display:flex;flex-direction:column;gap:0.7rem}
.fiche-section{background:var(--bg-tertiary);border-radius:8px;padding:0.55rem 0.7rem}
.fiche-section-title{font-size:0.6rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.04em;margin-bottom:0.3rem;display:flex;align-items:center;gap:0.3rem}
.fiche-section-title svg{width:12px;height:12px;color:var(--purple)}
.fiche-text{font-size:0.7rem;color:var(--text-secondary);line-height:1.5}
.fiche-badges{display:flex;flex-wrap:wrap;gap:0.25rem}
.fiche-badge{font-size:0.58rem;padding:0.15rem 0.4rem;border-radius:4px;font-weight:600;background:rgba(124,58,237,.1);color:var(--purple-light)}
.fiche-badge.tool{background:rgba(59,130,246,.1);color:var(--blue)}
.fiche-badge.tag{background:rgba(16,185,129,.1);color:var(--green)}
.fiche-perms{display:flex;gap:0.5rem;flex-wrap:wrap}
.fiche-perm{font-size:0.6rem;display:flex;align-items:center;gap:0.2rem;padding:0.15rem 0.4rem;border-radius:4px}
.fiche-perm.yes{background:rgba(16,185,129,.12);color:var(--green)}
.fiche-perm.no{background:rgba(148,163,184,.08);color:var(--text-muted)}
.fiche-perm svg{width:11px;height:11px}
.fiche-loading{text-align:center;padding:2rem;color:var(--text-muted);font-size:0.75rem}
</style>

<div class="tabs" style="margin-bottom:1rem">
    <button class="tab active" onclick="artSwitchTab(this, 'art-org')">Organisation</button>
    <button class="tab" onclick="artSwitchTab(this, 'art-mercato')" hx-get="/mercato/roster-partial" hx-target="#art-mercato-content" hx-swap="innerHTML" hx-trigger="click once">Mercato</button>
    <button class="tab" onclick="artSwitchTab(this, 'art-thompson')" id="tab-thompson">Thompson Sampling</button>
</div>
<div id="art-org">
<div class="art-dash">
    <!-- KPIs -->
    <div class="art-kpis">
        <div class="art-kpi"><div class="num">{{ portfolios|length }}</div><div class="lbl">{{ _("portfolios") }}</div></div>
        <div class="art-kpi"><div class="num">{{ total_arts }}</div><div class="lbl">{{ _("arts") }}</div></div>
        <div class="art-kpi"><div class="num">{{ total_teams }}</div><div class="lbl">{{ _('teams') }}</div></div>
        <div class="art-kpi"><div class="num">{{ total_members }}</div><div class="lbl">{{ _("agents") }}</div></div>
        <div class="art-kpi"><div class="num">{{ total_teams * 10 }}</div><div class="lbl">{{ _("pi_weeks") }}</div></div>
    </div>

    <!-- Org Tree -->
    {% for p in org_tree %}
    <div class="art-portfolio">
        <div class="art-portfolio-header">
            <div class="art-portfolio-title">
                <svg><use href="#icon-briefcase"/></svg>
                {{ p.name }}
                {% if p.lead %}<span style="font-weight:400;font-size:0.68rem;color:var(--text-muted)">— {{ p.lead }}</span>{% endif %}
            </div>
            <div class="art-budget">
                {% set pct = ((p.budget_consumed / p.budget * 100)|int) if p.budget > 0 else 0 %}
                <span>{{ "%.0f"|format(p.budget_consumed/1000) }}k / {{ "%.0f"|format(p.budget/1000) }}k €</span>
                <div class="art-budget-bar">
                    <div class="art-budget-fill" style="width:{{ pct }}%;background:{% if pct > 80 %}var(--red){% elif pct > 60 %}var(--yellow){% else %}var(--green){% endif %}"></div>
                </div>
            </div>
        </div>
        <div class="art-section">
        {% for art in p.children %}
            {% set art_type = 'security' if 'Security' in art.name else ('rse' if 'RSE' in art.name else 'default') %}
            <div class="art-block" data-type="{{ art_type }}">
                <div class="art-block-header">
                    <div>
                        <div class="art-block-title" style="color:{% if art_type=='security' %}var(--red){% elif art_type=='rse' %}var(--green){% else %}var(--blue){% endif %}">
                            <svg class="icon-sm"><use href="#icon-{% if art_type=='security' %}shield{% elif art_type=='rse' %}heart{% else %}git-branch{% endif %}"/></svg>
                            {{ art.name }}
                        </div>
                        {% if art.lead %}<div class="art-block-lead">Lead: {{ art.lead }}</div>{% endif %}
                    </div>
                    <div class="art-block-meta">PI {{ art.pi_cadence }}w · {{ art.children|length }} teams · {{ art.children|sum(attribute='members'|length) if false else art.children|map(attribute='members')|map('length')|sum }} agents</div>
                </div>
                <div class="art-teams">
                {% for team in art.children %}
                    <div class="art-team">
                        <div class="art-team-header">
                            <div class="art-team-name">{{ team.name }}</div>
                            <div class="art-team-badges">
                                <span class="art-team-badge badge-wip">WIP {{ team.wip_limit }}</span>
                                <span class="art-team-badge badge-cap">{{ team.members|length }}/{{ team.capacity }}</span>
                            </div>
                        </div>
                        {% if team.scrum_master %}<div class="art-team-sm"><svg class="icon-xs"><use href="#icon-user"/></svg> {{ team.scrum_master }}</div>{% endif %}
                        <div class="art-members">
                        {% for m in team.members %}
                        <div class="art-member" data-agent-id="{{ m.agent_id }}">
                            {% set bg = m.color if m.color else '#7c3aed' %}
                            <div class="art-member-avatar" style="background:{{ bg }}">
                                {% if m.avatar and '/' in m.avatar %}
                                    <img src="{{ m.avatar }}" alt="{{ m.name }}" loading="lazy">
                                {% else %}
                                    {{ m.avatar if m.avatar else m.name[:1]|upper }}
                                {% endif %}
                            </div>
                            <div class="art-member-info">
                                <div class="art-member-name">{{ m.name }}</div>
                                {% if m.tagline %}<div class="art-member-tagline">{{ m.tagline }}</div>{% endif %}
                            </div>
                            {% set r = m.role %}
                            <span class="art-role r-{% if r in ['lead','tech-lead'] %}lead{% elif r == 'qa' %}qa{% elif r in ['devops','sre','cloud'] %}devops{% elif r in ['security','exploit','threat-intel','governance','analyst','review','compliance'] %}security{% elif r in ['data','dba','ml','perf'] %}data{% elif r in ['a11y','docs','ux','social','ethique'] %}a11y{% elif r == 'legal' %}legal{% elif r in ['secops'] %}secops{% else %}default{% endif %}">{{ r }}</span>
                        </div>
                        {% endfor %}
                        </div>
                    </div>
                {% endfor %}
                </div>
            </div>
        {% endfor %}
        </div>
    </div>
    {% else %}
    <div style="text-align:center;padding:2rem;color:var(--text-muted);font-size:0.8rem">
        {{ _('no_org') }}
    </div>
    {% endfor %}
</div>

<!-- Overlay -->
<div class="art-overlay" id="artOverlay" onclick="closeAllModals()"></div>

<!-- Team Detail Modal -->
<div class="art-modal" id="teamModal">
    <div class="art-modal-head">
        <h3><svg><use href="#icon-users"/></svg> <span id="tmName"></span></h3>
        <button class="art-modal-close" onclick="closeAllModals()"><svg><use href="#icon-x"/></svg></button>
    </div>
    <div class="art-modal-meta" id="tmMeta"></div>
    <div class="art-modal-members" id="tmMembers"></div>
</div>

<!-- Agent Fiche Modal -->
<div class="art-modal fiche-modal" id="ficheModal">
    <div class="art-modal-head">
        <h3><svg><use href="#icon-user"/></svg> <span id="fhTitle">{{ _("agent") }}</span></h3>
        <button class="art-modal-close" onclick="closeFiche()"><svg><use href="#icon-x"/></svg></button>
    </div>
    <div id="fhContent"><div class="fiche-loading">{{ _('loading') }}</div></div>
</div>
</div><!-- /art-org -->

<!-- Mercato tab panel (hidden by default) -->
<div id="art-mercato" style="display:none">
    <div id="art-mercato-content">
        <p style="color:var(--text-secondary);padding:2rem;text-align:center">Loading Mercato...</p>
    </div>
    <div style="text-align:center;margin-top:1rem">
        <a href="/mercato" style="color:var(--purple-light);font-size:0.8rem">Open full Mercato page</a>
    </div>
</div>

<!-- Thompson Sampling tab panel (hidden by default) -->
<div id="art-thompson" style="display:none">
    <!-- KPI cards -->
    <div class="stats-grid" style="margin-bottom:1.5rem" id="ts-art-stats">
        <div class="stat-card">
            <h3>Agents actifs</h3>
            <p class="stat-value" id="ts-art-total">—</p>
            <p class="stat-label">avec données LLM</p>
        </div>
        <div class="stat-card">
            <h3>Appels LLM totaux</h3>
            <p class="stat-value" id="ts-art-accepted">—</p>
            <p class="stat-label">toutes traces</p>
        </div>
        <div class="stat-card">
            <h3>Erreurs LLM</h3>
            <p class="stat-value" id="ts-art-rejected" style="color:#f59e0b">—</p>
            <p class="stat-label">total tous agents</p>
        </div>
        <div class="stat-card">
            <h3>Darwin Fitness</h3>
            <p class="stat-value" id="ts-art-hirej" style="color:#a78bfa">—</p>
            <p class="stat-label">scores accumulés</p>
        </div>
    </div>

    <!-- A/B provider comparison -->
    <div style="margin-bottom:0.5rem;font-size:0.75rem;font-weight:600;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.05em">Comparaison Providers (Thompson A/B)</div>
    <div id="ts-ab-grid" style="display:grid;gap:0.6rem;margin-bottom:1.5rem"></div>

    <!-- Agent performance table from llm_traces -->
    <div style="margin-bottom:0.5rem;font-size:0.75rem;font-weight:600;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.05em">Performance par Agent × Modèle</div>
    <div style="overflow-x:auto">
        <table style="width:100%;font-size:0.85rem;border-collapse:collapse" id="ts-art-table">
            <thead>
                <tr style="background:var(--bg-secondary,#1e293b)">
                    <th style="text-align:left;padding:9px 12px;border-bottom:1px solid var(--border)">Agent</th>
                    <th style="text-align:left;padding:9px 12px;border-bottom:1px solid var(--border)">Provider / Modèle</th>
                    <th style="text-align:right;padding:9px 12px;border-bottom:1px solid var(--border)">Appels</th>
                    <th style="text-align:right;padding:9px 12px;border-bottom:1px solid var(--border)">Erreurs</th>
                    <th style="text-align:right;padding:9px 12px;border-bottom:1px solid var(--border)">Succès</th>
                    <th style="text-align:right;padding:9px 12px;border-bottom:1px solid var(--border)">Durée moy.</th>
                    <th style="text-align:right;padding:9px 12px;border-bottom:1px solid var(--border)">Tokens</th>
                    <th style="text-align:left;padding:9px 12px;border-bottom:1px solid var(--border);min-width:90px">Score</th>
                </tr>
            </thead>
            <tbody id="ts-art-tbody">
                <tr><td colspan="8" style="text-align:center;padding:3rem;color:var(--text-tertiary)">Chargement…</td></tr>
            </tbody>
        </table>
    </div>

    <!-- Darwin fitness section -->
    <div id="ts-darwin-section" style="margin-top:1.5rem;display:none">
        <div style="margin-bottom:0.5rem;font-size:0.75rem;font-weight:600;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.05em">Darwin Team Fitness (Thompson Sampling par contexte)</div>
        <div style="overflow-x:auto">
            <table style="width:100%;font-size:0.85rem;border-collapse:collapse">
                <thead>
                    <tr style="background:var(--bg-secondary,#1e293b)">
                        <th style="text-align:left;padding:9px 12px;border-bottom:1px solid var(--border)">Agent</th>
                        <th style="text-align:left;padding:9px 12px;border-bottom:1px solid var(--border)">Pattern</th>
                        <th style="text-align:left;padding:9px 12px;border-bottom:1px solid var(--border)">Tech</th>
                        <th style="text-align:left;padding:9px 12px;border-bottom:1px solid var(--border)">Phase</th>
                        <th style="text-align:right;padding:9px 12px;border-bottom:1px solid var(--border)">Wins</th>
                        <th style="text-align:right;padding:9px 12px;border-bottom:1px solid var(--border)">Losses</th>
                        <th style="text-align:left;padding:9px 12px;border-bottom:1px solid var(--border);min-width:100px">Fitness</th>
                    </tr>
                </thead>
                <tbody id="ts-darwin-tbody"></tbody>
            </table>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
(function(){
  const overlay = document.getElementById('artOverlay');
  const teamModal = document.getElementById('teamModal');
  const ficheModal = document.getElementById('ficheModal');

  // Attach click on each .art-team card
  document.querySelectorAll('.art-team').forEach(card => {
    card.addEventListener('click', () => {
      const name = card.querySelector('.art-team-name').textContent.trim();
      const sm = card.querySelector('.art-team-sm');
      const badges = card.querySelector('.art-team-badges');
      const members = card.querySelectorAll('.art-member');

      document.getElementById('tmName').textContent = name;

      // Meta bar
      const metaEl = document.getElementById('tmMeta');
      const wipBadge = badges ? badges.querySelector('.badge-wip') : null;
      const capBadge = badges ? badges.querySelector('.badge-cap') : null;
      let metaHTML = '';
      if (wipBadge) metaHTML += `<span><svg><use href="#icon-alert-triangle"/></svg> ${wipBadge.textContent.trim()}</span>`;
      if (capBadge) metaHTML += `<span><svg><use href="#icon-users"/></svg> Capacité ${capBadge.textContent.trim()}</span>`;
      if (sm) metaHTML += `<span><svg><use href="#icon-user"/></svg> SM: ${sm.textContent.trim()}</span>`;
      metaEl.innerHTML = metaHTML;

      // Members list
      const mbEl = document.getElementById('tmMembers');
      let mbHTML = '';
      members.forEach(m => {
        const avatarEl = m.querySelector('.art-member-avatar');
        const img = avatarEl.querySelector('img');
        const bg = avatarEl.style.background || '#7c3aed';
        const initials = img ? '' : avatarEl.textContent.trim();
        const avatarSrc = img ? img.src : '';
        const nameText = m.querySelector('.art-member-name').textContent.trim();
        const tagEl = m.querySelector('.art-member-tagline');
        const tagText = tagEl ? tagEl.textContent.trim() : '';
        const roleEl = m.querySelector('.art-role');
        const roleText = roleEl ? roleEl.textContent.trim() : '';
        // Extract agent_id from the member data
        const agentId = m.dataset.agentId || '';

        mbHTML += `<div class="art-modal-member" onclick="openFiche('${agentId}')" title="{{ _('view_card') }}">`;
        if (avatarSrc) {
          mbHTML += `<div class="art-modal-member-av" style="background:${bg}"><img src="${avatarSrc}" alt="${nameText}" loading="lazy"></div>`;
        } else {
          mbHTML += `<div class="art-modal-member-av" style="background:${bg}">${initials}</div>`;
        }
        mbHTML += `<div class="art-modal-member-info"><div class="art-modal-member-name">${nameText}</div>`;
        if (tagText) mbHTML += `<div class="art-modal-member-tag">${tagText}</div>`;
        mbHTML += `</div>`;
        if (roleText) mbHTML += `<span class="art-modal-member-role">${roleText}</span>`;
        mbHTML += `<div class="art-modal-member-arrow"><svg><use href="#icon-chevron-right"/></svg></div></div>`;
      });
      mbEl.innerHTML = mbHTML;

      // Open
      overlay.classList.add('open');
      teamModal.classList.add('open');
      ficheModal.classList.remove('open');
    });
  });

  // Agent fiche
  window.openFiche = async function(agentId) {
    if (!agentId) return;
    const content = document.getElementById('fhContent');
    content.innerHTML = '<div class="fiche-loading">{{ _('loading') }}</div>';
    ficheModal.classList.add('open');
    teamModal.classList.remove('open');
    document.getElementById('fhTitle').textContent = 'Agent';

    try {
      const resp = await fetch(`/api/agents/${agentId}/details`);
      if (!resp.ok) throw new Error('Not found');
      const a = await resp.json();

      document.getElementById('fhTitle').textContent = a.name;

      const rankLabels = {0:'CEO',10:'VP/Director',15:'Program',20:'Manager',25:'Lead',30:'Senior',35:'Mid',40:'Junior',50:'Intern'};
      const rankLabel = rankLabels[a.hierarchy_rank] || `Niveau ${a.hierarchy_rank}`;

      let html = '<div class="fiche-header">';
      if (a.avatar_url) {
        html += `<div class="fiche-photo" style="background:${a.color}"><img src="${a.avatar_url}" alt="${a.name}"></div>`;
      } else {
        html += `<div class="fiche-photo" style="background:${a.color}">${a.name.charAt(0)}</div>`;
      }
      html += `<div class="fiche-identity">`;
      html += `<div class="fiche-name">${a.name}</div>`;
      html += `<div class="fiche-role">${a.role}</div>`;
      if (a.tagline) html += `<div class="fiche-tagline">${a.tagline}</div>`;
      html += `<div class="fiche-rank"><svg><use href="#icon-bar-chart-2"/></svg> ${rankLabel}</div>`;
      html += `</div></div>`;

      html += '<div class="fiche-body">';

      if (a.persona) {
        html += `<div class="fiche-section"><div class="fiche-section-title"><svg><use href="#icon-user"/></svg> Persona</div><div class="fiche-text">${esc(a.persona)}</div></div>`;
      }
      if (a.motivation) {
        html += `<div class="fiche-section"><div class="fiche-section-title"><svg><use href="#icon-zap"/></svg> Motivation</div><div class="fiche-text">${esc(a.motivation)}</div></div>`;
      }
      if (a.description) {
        html += `<div class="fiche-section"><div class="fiche-section-title"><svg><use href="#icon-file-text"/></svg> Description</div><div class="fiche-text">${esc(a.description)}</div></div>`;
      }
      if (a.skills && a.skills.length) {
        html += `<div class="fiche-section"><div class="fiche-section-title"><svg><use href="#icon-star"/></svg> Skills (${a.skills.length})</div><div class="fiche-badges">`;
        a.skills.forEach(s => { html += `<span class="fiche-badge">${esc(s)}</span>`; });
        html += `</div></div>`;
      }
      if (a.tools && a.tools.length) {
        html += `<div class="fiche-section"><div class="fiche-section-title"><svg><use href="#icon-tool"/></svg> Tools (${a.tools.length})</div><div class="fiche-badges">`;
        a.tools.forEach(t => { html += `<span class="fiche-badge tool">${esc(t)}</span>`; });
        html += `</div></div>`;
      }
      if (a.tags && a.tags.length) {
        html += `<div class="fiche-section"><div class="fiche-section-title"><svg><use href="#icon-tag"/></svg> Tags</div><div class="fiche-badges">`;
        a.tags.forEach(t => { html += `<span class="fiche-badge tag">${esc(t)}</span>`; });
        html += `</div></div>`;
      }
      // Permissions
      const perms = a.permissions || {};
      html += `<div class="fiche-section"><div class="fiche-section-title"><svg><use href="#icon-shield"/></svg> Permissions</div><div class="fiche-perms">`;
      ['can_veto','can_approve','can_delegate'].forEach(p => {
        const yes = !!perms[p];
        const label = p.replace('can_','').charAt(0).toUpperCase() + p.replace('can_','').slice(1);
        html += `<span class="fiche-perm ${yes?'yes':'no'}"><svg><use href="#icon-${yes?'check':'x'}"/></svg> ${label}</span>`;
      });
      html += `</div></div>`;

      if (a.provider || a.model) {
        html += `<div class="fiche-section"><div class="fiche-section-title"><svg><use href="#icon-cpu"/></svg> LLM</div><div class="fiche-text">${esc(a.provider || '')} ${esc(a.model || '')}</div></div>`;
      }

      html += '</div>';
      content.innerHTML = html;
    } catch(e) {
      content.innerHTML = '<div class="fiche-loading">Agent introuvable</div>';
    }
  };

  window.closeFiche = function() {
    ficheModal.classList.remove('open');
    teamModal.classList.add('open');
  };

  window.closeAllModals = function() {
    overlay.classList.remove('open');
    teamModal.classList.remove('open');
    ficheModal.classList.remove('open');
  };

  // ESC key
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
      if (ficheModal.classList.contains('open')) { closeFiche(); }
      else { closeAllModals(); }
    }
  });

  function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
})();

function artSwitchTab(btn, panelId) {
    document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('art-org').style.display = panelId === 'art-org' ? '' : 'none';
    document.getElementById('art-mercato').style.display = panelId === 'art-mercato' ? '' : 'none';
    document.getElementById('art-thompson').style.display = panelId === 'art-thompson' ? '' : 'none';
    if (panelId === 'art-thompson') loadThompsonTab();
}

async function loadThompsonTab() {
    const tbody = document.getElementById('ts-art-tbody');
    if (tbody.dataset.loaded) return;
    try {
        const d = await fetch('/api/analytics/agents/scores').then(r => r.json());
        if (!d.success) { tbody.innerHTML = `<tr><td colspan="8" style="padding:2rem;text-align:center;color:#ef4444">Erreur: ${d.error}</td></tr>`; return; }
        const s = d.summary;
        document.getElementById('ts-art-total').textContent = s.total_agents;
        document.getElementById('ts-art-accepted').textContent = (s.total_calls || s.total_accepted || 0).toLocaleString();
        document.getElementById('ts-art-rejected').textContent = s.total_rejected.toLocaleString();
        document.getElementById('ts-art-hirej').textContent = (d.fitness || []).length;

        // Provider A/B breakdown (dynamic cards)
        const abGrid = document.getElementById('ts-ab-grid');
        const provColors = ['#6366f1','#0ea5e9','#10b981','#f59e0b','#f87171'];
        const labels = ['A','B','C','D','E'];
        if (d.providers && d.providers.length) {
            const cols = Math.min(d.providers.length, 4);
            abGrid.style.gridTemplateColumns = `repeat(${cols},1fr)`;
            abGrid.innerHTML = d.providers.map((p, i) => {
                const col = provColors[i % provColors.length];
                const lbl = labels[i] || String(i+1);
                const calls = (p.accepted||0) + (p.rejected||0);
                const pct = calls > 0 ? Math.round(100*(p.accepted||0)/calls) + '%' : '—';
                const ms = p.avg_duration_ms ? Math.round(p.avg_duration_ms).toLocaleString() + 'ms' : '—';
                return `<div class="stat-card" style="border:1px solid ${col};border-radius:8px;padding:0.8rem">
                    <div style="display:flex;align-items:center;gap:6px;margin-bottom:0.6rem">
                        <span style="background:${col};color:#fff;border-radius:3px;padding:1px 7px;font-size:0.72rem;font-weight:700">${lbl}</span>
                        <span style="color:var(--text-secondary);font-size:0.8rem;font-weight:600">${p.provider}</span>
                        <span style="color:var(--text-tertiary);font-size:0.72rem">${p.model || ''}</span>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:0.4rem;text-align:center">
                        <div><p style="font-size:1.2rem;font-weight:700;color:${col}">${(p.calls||calls).toLocaleString()}</p><p style="font-size:0.68rem;color:var(--text-tertiary)">appels</p></div>
                        <div><p style="font-size:1.2rem;font-weight:700;color:#10b981">${pct}</p><p style="font-size:0.68rem;color:var(--text-tertiary)">succès</p></div>
                        <div><p style="font-size:1.2rem;font-weight:700;color:#f59e0b">${p.rejected||0}</p><p style="font-size:0.68rem;color:var(--text-tertiary)">erreurs</p></div>
                        <div><p style="font-size:1.2rem;font-weight:700;color:var(--text-secondary)">${ms}</p><p style="font-size:0.68rem;color:var(--text-tertiary)">moy.</p></div>
                    </div>
                </div>`;
            }).join('');
        } else {
            abGrid.innerHTML = '<p style="color:var(--text-tertiary);font-size:0.82rem">Aucun fournisseur LLM actif</p>';
        }

        // Agent performance table
        if (!d.agents || !d.agents.length) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:2rem;color:var(--text-tertiary)">Aucune donnée — les scores s\'accumulent en cours de mission</td></tr>';
        } else {
            tbody.innerHTML = d.agents.map(a => {
                const pct = a.success_pct ?? 0;
                const color = pct >= 90 ? '#10b981' : pct >= 70 ? '#f59e0b' : '#ef4444';
                const badge = a.rejection_pct > 40
                    ? ' <span style="font-size:0.7rem;background:#ef4444;color:#fff;border-radius:3px;padding:1px 5px">⚠</span>' : '';
                const provColor = (a.provider||'').includes('minimax') ? '#6366f1' : '#0ea5e9';
                const ms = a.avg_duration_ms ? Math.round(a.avg_duration_ms/1000).toFixed(1)+'s' : '—';
                const tok = a.total_tokens ? (a.total_tokens/1000).toFixed(0)+'k' : '—';
                return `<tr style="${a.rejection_pct > 40 ? 'background:rgba(239,68,68,0.07)' : ''}">
                    <td style="padding:7px 12px">${a.agent_name}${badge}</td>
                    <td style="padding:7px 12px;font-size:0.8rem">
                        <span style="background:${provColor}22;color:${provColor};border-radius:3px;padding:1px 6px">${a.provider}</span>
                        <span style="color:var(--text-tertiary);font-size:0.75rem;margin-left:4px">${a.model||''}</span>
                    </td>
                    <td style="padding:7px 12px;text-align:right">${a.iterations}</td>
                    <td style="padding:7px 12px;text-align:right;color:#f87171">${a.rejected}</td>
                    <td style="padding:7px 12px;text-align:right;font-weight:600;color:${color}">${pct}%</td>
                    <td style="padding:7px 12px;text-align:right;color:var(--text-secondary)">${ms}</td>
                    <td style="padding:7px 12px;text-align:right;color:var(--text-tertiary)">${tok}</td>
                    <td style="padding:7px 12px">
                        <div style="background:var(--border);border-radius:3px;height:7px">
                            <div style="background:${color};border-radius:3px;height:7px;width:${pct}%"></div>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }
        tbody.dataset.loaded = '1';

        // Darwin fitness section
        if (d.fitness && d.fitness.length) {
            document.getElementById('ts-darwin-section').style.display = '';
            const dfbody = document.getElementById('ts-darwin-tbody');
            dfbody.innerHTML = d.fitness.map(f => {
                const sc = f.fitness_score || 0;
                const col = sc >= 70 ? '#10b981' : sc >= 40 ? '#f59e0b' : '#ef4444';
                return `<tr>
                    <td style="padding:7px 12px">${f.agent_name}</td>
                    <td style="padding:7px 12px;color:var(--text-secondary);font-size:0.82rem">${f.pattern_id||'—'}</td>
                    <td style="padding:7px 12px;color:var(--text-tertiary);font-size:0.8rem">${f.technology||'generic'}</td>
                    <td style="padding:7px 12px;color:var(--text-tertiary);font-size:0.8rem">${f.phase_type||'—'}</td>
                    <td style="padding:7px 12px;text-align:right;color:#10b981">${f.wins}</td>
                    <td style="padding:7px 12px;text-align:right;color:#f87171">${f.losses}</td>
                    <td style="padding:7px 12px">
                        <div style="display:flex;align-items:center;gap:6px">
                            <div style="background:var(--border);border-radius:3px;height:7px;flex:1">
                                <div style="background:${col};border-radius:3px;height:7px;width:${sc}%"></div>
                            </div>
                            <span style="font-size:0.78rem;font-weight:600;color:${col};min-width:32px">${sc}</span>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }
    } catch(e) { tbody.innerHTML = `<tr><td colspan="8" style="padding:2rem;text-align:center;color:#ef4444">Erreur réseau: ${e.message}</td></tr>`; }
}
</script>
{% endblock %}
