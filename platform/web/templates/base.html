<!DOCTYPE html>
<html lang="{{ request.state.lang|default('en') }}" data-theme="dark">
<head>
    <script>document.documentElement.setAttribute('data-theme', localStorage.getItem('macaron_theme') || 'dark')</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>{{ page_title }} — Software Factory</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#6c63ff">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SF Platform">
    <link rel="stylesheet" href="/static/css/main.css?v=20260225a">
    <link rel="stylesheet" href="/static/css/components.css?v=20260225a">
    <link rel="stylesheet" href="/static/css/agents.css?v=20260225a">
    <link rel="stylesheet" href="/static/css/projects.css?v=20260225a">
    <script src="/static/js/htmx.min.js"></script>
    <script src="/static/js/sortable.min.js"></script>
    <script src="/static/js/sse.js" defer></script>
    <script>
    /* JS i18n — mirrors server-side _() */
    window.__i18n = {{ i18n_catalog | tojson }};
    function _(key) { return window.__i18n[key] || key; }

    /* Global error handler → auto-create TMA ticket */
    (function() {
        const _reported = new Set();
        const _throttle = 60000; /* 1 ticket per unique error per minute */
        window.addEventListener('error', function(e) {
            const sig = (e.message || '') + ':' + (e.filename || '') + ':' + (e.lineno || 0);
            if (_reported.has(sig)) return;
            _reported.add(sig);
            setTimeout(() => _reported.delete(sig), _throttle);
            try {
                fetch('/api/tma/js-error', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        message: e.message || 'Unknown error',
                        source: e.filename || location.pathname,
                        line: e.lineno || 0,
                        col: e.colno || 0,
                        url: location.href,
                        ua: navigator.userAgent.slice(0, 120)
                    })
                });
            } catch(_) {}
        });
        window.addEventListener('unhandledrejection', function(e) {
            const msg = (e.reason && e.reason.message) || String(e.reason || 'Unhandled promise rejection');
            const sig = 'promise:' + msg;
            if (_reported.has(sig)) return;
            _reported.add(sig);
            setTimeout(() => _reported.delete(sig), _throttle);
            try {
                fetch('/api/tma/js-error', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ message: msg, source: 'promise', url: location.href })
                });
            } catch(_) {}
        });
    })();
    </script>
    <!-- Umami Analytics -->
    <script async src="https://analytics.macaron-software.com/script.js" data-website-id="fddc91d3-a7fe-4544-85df-46b16597e143"></script>
</head>
<body>
    {% include "partials/svg_sprites.html" %}
    <div class="layout">
        <!-- Sidebar (icon-only) -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h1 class="logo"><svg class="icon icon-logo"><use href="#icon-macaron"/></svg></h1>
            </div>

            {% set p = request.state.perspective|default('admin') %}
            <div class="sidebar-section">
                <ul class="nav-links">
                    <li><a href="/" data-tooltip="Dashboard" class="{% if page_title in ('Dashboard', 'Portfolio', 'Projects', 'DSI Board', 'Vue Métier') %}active{% endif %}">
                        <svg class="icon"><use href="#icon-home"/></svg>
                    </a></li>
                    {% set _full = ('admin', 'overview', 'dsi') %}
                    {% if p in _full + ('portfolio_manager', 'product_owner', 'architect', 'business_owner') %}
                    <li><a href="/backlog" data-tooltip="Backlog" class="{% if page_title in ('Backlog', 'Product', 'Idéation') %}active{% endif %}">
                        <svg class="icon"><use href="#icon-layers"/></svg>
                    </a></li>
                    {% endif %}
                    {% if p in _full + ('portfolio_manager', 'rte', 'product_owner', 'scrum_master', 'architect', 'business_owner') %}
                    <li><a href="/pi" data-tooltip="PI Board" class="{% if page_title in ('PI Board', 'Program Increment', 'Epics', 'Epic', 'Epic Control') %}active{% endif %}">
                        <svg class="icon"><use href="#icon-rocket"/></svg>
                    </a></li>
                    {% endif %}
                    {% if p in _full + ('rte', 'scrum_master', 'qa_security') %}
                    <li><a href="/workflows" data-tooltip="Workflows" class="{% if page_title in ('Workflows', 'Patterns') %}active{% endif %}">
                        <svg class="icon"><use href="#icon-workflow"/></svg>
                    </a></li>
                    {% endif %}
                    {% if p in _full + ('product_owner', 'developer', 'architect', 'qa_security') %}
                    <li><a href="/projects" data-tooltip="Projects" class="{% if page_title in ('Projects', 'Project') %}active{% endif %}">
                        <svg class="icon"><use href="#icon-folder"/></svg>
                    </a></li>
                    {% endif %}
                    {% if p in _full + ('rte', 'product_owner', 'scrum_master', 'developer', 'qa_security') %}
                    <li><a href="/sessions" data-tooltip="Sessions" class="{% if page_title in ('Live', 'Sessions', 'Session') %}active{% endif %}">
                        <svg class="icon"><use href="#icon-message-circle"/></svg>
                    </a></li>
                    {% endif %}
                    {% if p in _full + ('rte', 'scrum_master', 'developer') %}
                    <li><a href="/art" data-tooltip="Teams" class="{% if page_title in ('ART', 'Agents', 'Organisation SAFe', 'Team Generator', 'Mercato') %}active{% endif %}">
                        <svg class="icon"><use href="#icon-users"/></svg>
                    </a></li>
                    {% endif %}
                    {% if p in _full + ('developer', 'architect') %}
                    <li><a href="/toolbox" data-tooltip="Toolbox" class="{% if page_title in ('Toolbox', 'Skills', 'Memory', 'MCPs', 'Design System', 'Wiki') %}active{% endif %}">
                        <svg class="icon"><use href="#icon-plug"/></svg>
                    </a></li>
                    <li><a href="/tool-builder" data-tooltip="Tool Builder" class="{% if page_title == 'Tool Builder' %}active{% endif %}">
                        <svg class="icon"><use href="#icon-zap"/></svg>
                    </a></li>
                    {% endif %}
                    <li><a href="/metrics" data-tooltip="Metrics" class="{% if page_title == 'Metrics' %}active{% endif %}">
                        <svg class="icon"><use href="#icon-chart"/></svg>
                    </a></li>
                    <li><a href="/ops" data-tooltip="Ops" class="{% if page_title == 'Ops' %}active{% endif %}">
                        <svg class="icon"><use href="#icon-activity"/></svg>
                    </a></li>
                    {% if request.state.user and request.state.user.role == 'admin' %}
                    <li><a href="/rbac" data-tooltip="Users & Roles" class="{% if page_title in ('RBAC', 'Users & Roles') %}active{% endif %}">
                        <svg class="icon"><use href="#icon-shield"/></svg>
                    </a></li>
                    {% endif %}
                </ul>
            </div>

            <div class="sidebar-section" style="margin-top: auto">
                <!-- Language selector -->
                <div class="sidebar-view-switch" style="margin-bottom:0.2rem">
                    <select id="langSelect" title="{{ _("tt_language") }}" style="background:var(--bg-secondary);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:2px 4px;font-size:0.7rem;width:100%;cursor:pointer;text-align:center">
                        <option value="en" {% if request.state.lang|default('en') == 'en' %}selected{% endif %}>{{ _("en") }}</option>
                        <option value="fr" {% if request.state.lang|default('en') == 'fr' %}selected{% endif %}>{{ _("fr") }}</option>
                        <option value="zh" {% if request.state.lang|default('en') == 'zh' %}selected{% endif %}>中文</option>
                        <option value="es" {% if request.state.lang|default('en') == 'es' %}selected{% endif %}>{{ _("es") }}</option>
                        <option value="ja" {% if request.state.lang|default('en') == 'ja' %}selected{% endif %}>日本</option>
                        <option value="pt" {% if request.state.lang|default('en') == 'pt' %}selected{% endif %}>{{ _("pt") }}</option>
                        <option value="de" {% if request.state.lang|default('en') == 'de' %}selected{% endif %}>{{ _("de") }}</option>
                        <option value="ko" {% if request.state.lang|default('en') == 'ko' %}selected{% endif %}>한국</option>
                    </select>
                </div>
                <!-- Theme toggle -->
                <div class="sidebar-view-switch" style="margin-bottom:0.2rem">
                    <button class="view-switch-btn theme-toggle-btn" id="themeToggle" title="Changer le theme">
                        <svg class="icon icon-xs theme-icon-sun"><use href="#icon-sun"/></svg>
                        <svg class="icon icon-xs theme-icon-moon"><use href="#icon-moon"/></svg>
                    </button>
                </div>
                <ul class="nav-links">
                    <li><a href="/settings" data-tooltip="Settings" class="{% if page_title == 'Settings' %}active{% endif %}">
                        <svg class="icon"><use href="#icon-settings"/></svg>
                    </a></li>
                </ul>
            </div>

            <div class="sidebar-footer"></div>
        </nav>

        <!-- Main content -->
        <main class="content">
            <header class="topbar">
                <h2>{{ page_title }}</h2>
                <div class="topbar-right">
                    {% block topbar_actions %}{% endblock %}
                    <!-- SAFe Perspective Selector -->
                    <div class="perspective-wrapper" style="position:relative">
                        <button class="perspective-btn" id="perspectiveBtn" onclick="document.getElementById('perspectiveDropdown').classList.toggle('show')" title="SAFe Perspective">
                            <svg class="icon icon-sm"><use href="#icon-shield"/></svg>
                            <span class="perspective-label">{% if p == 'overview' %}OVW{% elif p == 'dsi' %}DSI{% elif p == 'portfolio_manager' %}PM{% elif p == 'rte' %}RTE{% elif p == 'product_owner' %}PO{% elif p == 'scrum_master' %}SM{% elif p == 'developer' %}Dev{% elif p == 'architect' %}Arch{% elif p == 'qa_security' %}QA{% elif p == 'business_owner' %}BO{% else %}All{% endif %}</span>
                        </button>
                        <div class="perspective-dropdown" id="perspectiveDropdown">
                            <div class="perspective-dropdown-title">SAFe Perspective</div>
                            <a class="perspective-item {% if p == 'overview' %}active{% endif %}" onclick="setPerspective('overview')">Overview</a>
                            <a class="perspective-item {% if p == 'dsi' %}active{% endif %}" onclick="setPerspective('dsi')">DSI</a>
                            <hr style="border:0;border-top:1px solid var(--border);margin:4px 0">
                            <a class="perspective-item {% if p == 'portfolio_manager' %}active{% endif %}" onclick="setPerspective('portfolio_manager')">Portfolio Manager</a>
                            <a class="perspective-item {% if p == 'rte' %}active{% endif %}" onclick="setPerspective('rte')">RTE</a>
                            <a class="perspective-item {% if p == 'product_owner' %}active{% endif %}" onclick="setPerspective('product_owner')">Product Owner</a>
                            <a class="perspective-item {% if p == 'scrum_master' %}active{% endif %}" onclick="setPerspective('scrum_master')">Scrum Master</a>
                            <a class="perspective-item {% if p == 'developer' %}active{% endif %}" onclick="setPerspective('developer')">Developer</a>
                            <a class="perspective-item {% if p == 'architect' %}active{% endif %}" onclick="setPerspective('architect')">Architect</a>
                            <a class="perspective-item {% if p == 'qa_security' %}active{% endif %}" onclick="setPerspective('qa_security')">QA / Security</a>
                            <a class="perspective-item {% if p == 'business_owner' %}active{% endif %}" onclick="setPerspective('business_owner')">Business Owner</a>
                            <hr style="border:0;border-top:1px solid var(--border);margin:4px 0">
                            <a class="perspective-item {% if p == 'admin' %}active{% endif %}" onclick="setPerspective('admin')">Admin (all)</a>
                        </div>
                    </div>
                    <div class="tma-heartbeat-wrapper" id="tmaHeartbeat"
                         hx-get="/api/autoheal/heartbeat"
                         hx-trigger="load, every 30s"
                         hx-swap="innerHTML">
                    </div>
                    <div class="notif-wrapper" id="notifWrapper">
                        <button class="topbar-bell" id="notifBell" aria-label="Notifications">
                            <svg class="icon icon-sm"><use href="#icon-bell"/></svg>
                            <span id="notifBadge"
                                  hx-get="/api/notifications/badge"
                                  hx-trigger="load, every 30s"
                                  hx-swap="innerHTML"></span>
                        </button>
                        <div class="notif-dropdown" id="notifDropdown"
                             hx-get="/api/notifications/dropdown"
                             hx-trigger="notif-open"
                             hx-swap="innerHTML"></div>
                    </div>
                    <div class="user-menu-wrapper" style="position:relative">
                        <button class="topbar-avatar" id="userMenuBtn" onclick="document.getElementById('userDropdown').classList.toggle('show')" title="{{ request.state.user.display_name if request.state.user else 'User' }}">
                            {{ (request.state.user.display_name[:1] if request.state.user else 'U') | upper }}
                        </button>
                        <div class="user-dropdown" id="userDropdown">
                            {% if request.state.user %}
                            <div class="user-dropdown-header">
                                <strong>{{ request.state.user.display_name }}</strong>
                                <small>{{ request.state.user.email }}</small>
                                <span class="user-role-badge">{{ request.state.user.role }}</span>
                            </div>
                            <hr style="border:0;border-top:1px solid var(--border);margin:0">
                            {% if request.state.user.role == 'admin' %}
                            <a href="/admin/users" class="user-dropdown-item">Manage Users</a>
                            {% endif %}
                            <a href="#" class="user-dropdown-item" onclick="doLogout()">Sign out</a>
                            {% else %}
                            <a href="/login" class="user-dropdown-item">Sign in</a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </header>
            <div class="main-area">
                {% block content %}{% endblock %}
            </div>
        </main>
    </div>

    <style>
    /* SAFe Perspective selector */
    .perspective-btn{display:flex;align-items:center;gap:4px;background:var(--bg-tertiary,#21262d);border:1px solid var(--border);border-radius:6px;padding:4px 10px;color:var(--text-primary);cursor:pointer;font-size:0.75rem;font-weight:600;white-space:nowrap}
    .perspective-btn:hover{border-color:var(--purple)}
    .perspective-label{color:var(--purple-light,#c084fc)}
    .perspective-dropdown{display:none;position:absolute;top:calc(100% + 8px);right:0;width:200px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 8px 32px rgba(0,0,0,.4);z-index:999;overflow:hidden;padding:4px 0}
    .perspective-dropdown.show{display:block}
    .perspective-dropdown-title{padding:6px 12px;font-size:10px;text-transform:uppercase;letter-spacing:.08em;color:var(--text-secondary);font-weight:600}
    .perspective-item{display:block;padding:6px 12px;color:var(--text-primary);text-decoration:none;font-size:0.8125rem;cursor:pointer;border-radius:0}
    .perspective-item:hover{background:var(--bg-tertiary,#21262d)}
    .perspective-item.active{color:var(--purple-light);font-weight:600}
    .perspective-item.active::before{content:"";display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--purple);margin-right:6px}

    /* User dropdown menu */
    .topbar-avatar{cursor:pointer;border:none;background:var(--accent);color:#fff;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.875rem}
    .user-dropdown{display:none;position:absolute;top:calc(100% + 8px);right:0;width:220px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 8px 32px rgba(0,0,0,.4);z-index:999;overflow:hidden}
    .user-dropdown.show{display:block}
    .user-dropdown-header{padding:0.75rem 1rem}
    .user-dropdown-header strong{display:block;color:var(--text-primary);font-size:0.875rem}
    .user-dropdown-header small{color:var(--text-secondary);font-size:0.75rem}
    .user-role-badge{display:inline-block;margin-top:0.25rem;padding:0.125rem 0.5rem;border-radius:9999px;background:var(--bg-tertiary,#21262d);color:var(--text-secondary);font-size:0.6875rem;text-transform:uppercase;letter-spacing:0.05em}
    .user-dropdown-item{display:block;padding:0.5rem 1rem;color:var(--text-primary);text-decoration:none;font-size:0.8125rem}
    .user-dropdown-item:hover{background:var(--bg-tertiary,#21262d)}

    /* Notification bell + dropdown */
    .notif-wrapper{position:relative}
    .topbar-bell{position:relative}
    #notifBadge .notif-badge{position:absolute;top:-4px;right:-4px;min-width:16px;height:16px;padding:0 4px;border-radius:8px;background:var(--accent);color:#fff;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;line-height:1;pointer-events:none}
    .notif-dropdown{display:none;position:absolute;top:calc(100% + 8px);right:0;width:360px;max-height:480px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 8px 32px rgba(0,0,0,.4);z-index:999;overflow:hidden}
    .notif-dropdown.open{display:flex;flex-direction:column}
    .notif-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border)}
    .notif-header h4{margin:0;font-size:var(--text-sm);color:var(--text-primary)}
    .notif-mark-all{background:none;border:none;color:var(--purple-light);font-size:11px;cursor:pointer;padding:2px 6px;border-radius:4px}
    .notif-mark-all:hover{background:var(--bg-tertiary)}
    .notif-list{overflow-y:auto;flex:1;max-height:380px}
    .notif-item{display:flex;gap:10px;padding:10px 16px;border-bottom:1px solid var(--border-subtle, rgba(255,255,255,.05));cursor:pointer;transition:background .1s}
    .notif-item:hover{background:var(--bg-tertiary)}
    .notif-item.unread{background:rgba(168,85,247,.06)}
    .notif-item.unread .notif-dot{display:block}
    .notif-dot{display:none;width:8px;height:8px;border-radius:50%;background:var(--purple);flex-shrink:0;margin-top:5px}
    .notif-body{flex:1;min-width:0}
    .notif-title{font-size:12px;color:var(--text-primary);font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .notif-msg{font-size:11px;color:var(--text-secondary);margin-top:2px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .notif-time{font-size:10px;color:var(--text-muted, var(--text-secondary));margin-top:3px}
    .notif-sev{width:3px;border-radius:2px;flex-shrink:0}
    .notif-sev.info{background:var(--blue, #3b82f6)}
    .notif-sev.warning{background:#f59e0b}
    .notif-sev.critical{background:#ef4444}
    .notif-footer{padding:8px 16px;border-top:1px solid var(--border);text-align:center}
    .notif-footer a{color:var(--purple-light);font-size:11px;text-decoration:none}
    .notif-footer a:hover{text-decoration:underline}
    .notif-empty{padding:24px;text-align:center;color:var(--text-secondary);font-size:12px}
    /* TMA heartbeat — animated ECG icon in topbar */
    .tma-heartbeat-wrapper{position:relative;display:flex;align-items:center}
    .tma-hb{width:28px;height:28px;display:flex;align-items:center;justify-content:center;border-radius:var(--radius-full);cursor:help;transition:background .15s}
    .tma-hb:hover{background:var(--bg-tertiary)}
    .tma-hb svg{width:16px;height:16px;color:var(--tma-color)}
    .tma-hb.alive svg{animation:hb-beat 1.2s ease-in-out infinite}
    .tma-hb.healing svg{animation:hb-beat .6s ease-in-out infinite}
    .tma-hb.starting svg{opacity:.6;animation:hb-fade 2s ease-in-out infinite}
    .tma-hb.stale svg{opacity:.4;animation:none}
    @keyframes hb-fade{0%,100%{opacity:.3}50%{opacity:.8}}
    @keyframes hb-beat{0%,100%{transform:scale(1);opacity:1}15%{transform:scale(1.25);opacity:1}30%{transform:scale(1);opacity:.7}45%{transform:scale(1.15);opacity:1}60%{transform:scale(1);opacity:1}}
    /* TMA hover popover */
    .tma-tip{display:none;position:absolute;top:calc(100% + 8px);right:0;width:220px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 8px 24px rgba(0,0,0,.4);z-index:999;padding:10px 12px;pointer-events:none}
    .tma-hb:hover .tma-tip{display:block}
    .tma-tip-title{font-size:11px;font-weight:700;margin-bottom:8px;letter-spacing:.3px}
    .tma-tip-grid{display:flex;flex-direction:column;gap:3px}
    .tma-tip-row{display:flex;justify-content:space-between;font-size:11px;color:var(--text-secondary)}
    .tma-tip-row span:last-child{font-weight:600;color:var(--text-primary);font-variant-numeric:tabular-nums}
    .tma-tip-sep{height:1px;background:var(--border);margin:4px 0}
    .tma-tip-footer{font-size:9px;color:var(--text-secondary);margin-top:8px;opacity:.7}
    .sidebar-view-switch{display:flex;justify-content:center;gap:2px;padding:0.3rem 0.4rem;margin:0 0.3rem 0.3rem;background:var(--bg-tertiary);border-radius:8px}
    .view-switch-btn{background:none;border:none;color:var(--text-secondary);padding:0.3rem;border-radius:6px;cursor:pointer;transition:all .12s;display:flex;align-items:center;justify-content:center}
    .view-switch-btn:hover{color:var(--text-primary);background:var(--bg-secondary)}
    .view-switch-btn.active{color:#fff;background:var(--purple)}
    .nav-links li.view-hidden{display:none}
    /* Theme toggle */
    .theme-toggle-btn{position:relative;width:28px;height:28px;overflow:hidden}
    .theme-icon-sun,.theme-icon-moon{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);transition:opacity .2s,transform .3s}
    [data-theme="dark"] .theme-icon-sun{opacity:1;transform:translate(-50%,-50%) rotate(0deg)}
    [data-theme="dark"] .theme-icon-moon{opacity:0;transform:translate(-50%,-50%) rotate(90deg)}
    [data-theme="light"] .theme-icon-sun{opacity:0;transform:translate(-50%,-50%) rotate(-90deg)}
    [data-theme="light"] .theme-icon-moon{opacity:1;transform:translate(-50%,-50%) rotate(0deg)}
    </style>
    <script>
    /* Theme toggle (light/dark) — persists in localStorage */
    (function(){
      const html = document.documentElement;
      const saved = localStorage.getItem('macaron_theme') || 'dark';
      html.setAttribute('data-theme', saved);

      document.getElementById('themeToggle')?.addEventListener('click', function(){
        const next = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        html.setAttribute('data-theme', next);
        localStorage.setItem('macaron_theme', next);
      });
    })();
    </script>
    <script>
    /* Notification bell toggle */
    (function(){
      const bell = document.getElementById('notifBell');
      const dd = document.getElementById('notifDropdown');
      if (!bell || !dd) return;
      bell.addEventListener('click', function(e){
        e.stopPropagation();
        const isOpen = dd.classList.toggle('open');
        if (isOpen) htmx.trigger(dd, 'notif-open');
      });
      document.addEventListener('click', function(e){
        if (!dd.contains(e.target) && !bell.contains(e.target)) dd.classList.remove('open');
      });
      document.addEventListener('keydown', function(e){
        if (e.key === 'Escape') dd.classList.remove('open');
      });
    })();
    </script>
    <script>
    /* Language selector */
    document.getElementById('langSelect')?.addEventListener('change', function(){
      fetch('/api/set-lang/' + this.value).then(function(){ location.reload(); });
    });
    </script>
    <script>
    (function(){
      // Force "all" view mode permanently
      const currentView = 'all';

      function applyView(mode){
        // Always show all nav items
        document.querySelectorAll('.nav-links a[data-views]').forEach(a=>{
          a.closest('li').classList.remove('view-hidden');
        });
      }

      // Init
      applyView(currentView);
    })();
    </script>

    <script src="/static/js/workspace.js" defer></script>
    {% block scripts %}{% endblock %}

<!-- DigitalOcean-style Delete Confirmation Modal -->
<div id="deleteConfirmModal" style="display:none;position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,.65);align-items:center;justify-content:center">
  <div style="background:var(--bg-secondary);border:1px solid var(--border);border-radius:12px;max-width:460px;width:90%;padding:1.5rem;box-shadow:0 20px 60px rgba(0,0,0,.5)">
    <div style="display:flex;align-items:center;gap:0.6rem;margin-bottom:1rem">
      <div style="width:36px;height:36px;border-radius:8px;background:rgba(239,68,68,.12);color:var(--red);display:flex;align-items:center;justify-content:center;flex-shrink:0">
        <svg style="width:20px;height:20px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
      </div>
      <div>
        <h3 id="dcm-title" style="margin:0;font-size:1rem;color:var(--text-primary)">Supprimer</h3>
        <p id="dcm-subtitle" style="margin:0;font-size:0.78rem;color:var(--text-secondary)">Cette action est irréversible</p>
      </div>
    </div>
    <p id="dcm-warning" style="font-size:0.82rem;color:var(--text-secondary);margin-bottom:1rem;line-height:1.5"></p>
    <label style="font-size:0.78rem;color:var(--text-secondary);display:block;margin-bottom:0.4rem">
      Tapez <strong id="dcm-expected" style="color:var(--red)"></strong> pour confirmer
    </label>
    <input id="dcm-input" type="text" autocomplete="off" spellcheck="false"
      style="width:100%;padding:0.5rem 0.7rem;border:1px solid var(--border);border-radius:6px;background:var(--bg-primary);color:var(--text-primary);font-size:0.85rem;font-family:var(--font-mono);box-sizing:border-box"
      oninput="document.getElementById('dcm-confirm-btn').disabled=(this.value!==this.dataset.expected)">
    <div style="display:flex;gap:0.6rem;margin-top:1rem;justify-content:flex-end">
      <button onclick="closeDeleteModal()" style="padding:0.45rem 1rem;border-radius:6px;border:1px solid var(--border);background:var(--bg-tertiary);color:var(--text-primary);cursor:pointer;font-size:0.82rem">Annuler</button>
      <button id="dcm-confirm-btn" disabled onclick="executeDelete()"
        style="padding:0.45rem 1rem;border-radius:6px;border:1px solid var(--red);background:rgba(239,68,68,.15);color:var(--red);cursor:pointer;font-size:0.82rem;font-weight:600;transition:all .15s">
        Supprimer
      </button>
    </div>
  </div>
</div>
<script>
let _dcmCallback = null;
function openDeleteModal({title, subtitle, warning, expectedName, onConfirm}) {
    document.getElementById('dcm-title').textContent = title || 'Supprimer';
    document.getElementById('dcm-subtitle').textContent = subtitle || 'Cette action est irréversible';
    document.getElementById('dcm-warning').innerHTML = warning || '';
    document.getElementById('dcm-expected').textContent = expectedName;
    const input = document.getElementById('dcm-input');
    input.value = '';
    input.dataset.expected = expectedName;
    document.getElementById('dcm-confirm-btn').disabled = true;
    _dcmCallback = onConfirm;
    document.getElementById('deleteConfirmModal').style.display = 'flex';
    setTimeout(() => input.focus(), 100);
}
function closeDeleteModal() {
    document.getElementById('deleteConfirmModal').style.display = 'none';
    _dcmCallback = null;
}
async function executeDelete() {
    if (_dcmCallback) {
        const btn = document.getElementById('dcm-confirm-btn');
        btn.disabled = true;
        btn.textContent = 'Suppression...';
        try { await _dcmCallback(); }
        catch(e) { alert(e); }
        finally { btn.textContent = 'Supprimer'; closeDeleteModal(); }
    }
}
document.getElementById('deleteConfirmModal').addEventListener('click', function(e) {
    if (e.target === this) closeDeleteModal();
});
/* User menu — close on outside click + logout */
document.addEventListener('click', function(e) {
    const dd = document.getElementById('userDropdown');
    const btn = document.getElementById('userMenuBtn');
    if (dd && btn && !btn.contains(e.target) && !dd.contains(e.target)) {
        dd.classList.remove('show');
    }
    const pd = document.getElementById('perspectiveDropdown');
    const pb = document.getElementById('perspectiveBtn');
    if (pd && pb && !pb.contains(e.target) && !pd.contains(e.target)) {
        pd.classList.remove('show');
    }
});
async function doLogout() {
    await fetch('/api/auth/logout', {method:'POST'});
    location.href = '/login';
}
async function setPerspective(p) {
    await fetch('/api/perspective', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({perspective:p})});
    location.reload();
}
</script>
</body>
</html>
