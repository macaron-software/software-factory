{% extends "base.html" %}
{% block topbar_actions %}
<div style="display:flex;gap:0.5rem;align-items:center">
    <div style="position:relative">
        <input type="text" id="piSearch" placeholder="Search epics, features, tickets..." style="background:var(--bg-tertiary);border:1px solid var(--border);border-radius:6px;padding:0.35rem 0.7rem 0.35rem 2rem;font-size:0.78rem;color:var(--text-primary);width:240px;outline:none;font-family:inherit" oninput="debounceSearch(this.value)" onfocus="this.style.borderColor='var(--purple)'" onblur="setTimeout(()=>{this.style.borderColor='var(--border)';document.getElementById('searchResults').style.display='none'},200)">
        <svg style="position:absolute;left:0.6rem;top:50%;transform:translateY(-50%);width:14px;height:14px;color:var(--text-secondary)" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <div id="searchResults" style="display:none;position:absolute;top:100%;left:0;right:0;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;margin-top:4px;max-height:360px;overflow-y:auto;z-index:50;box-shadow:0 8px 32px rgba(0,0,0,.3)"></div>
    </div>
    <a href="/api/export/epics" class="btn btn-ghost btn-sm" title="Export CSV" style="font-size:0.72rem">
        <svg class="icon icon-sm" style="width:14px;height:14px"><use href="#icon-download"/></svg>
    </a>
    <button class="btn btn-primary" onclick="document.getElementById('newMissionModal').style.display='flex'">
        <svg class="icon icon-sm"><use href="#icon-plus"/></svg> {{ _('new_mission') }}
    </button>
</div>
{% endblock %}
{% block content %}
<style>
.mission-list{display:flex;flex-direction:column;gap:0.75rem}
.mission-card{display:grid;grid-template-columns:auto 1fr auto;gap:1rem;align-items:center;background:var(--bg-secondary);border:1px solid var(--border);border-radius:10px;padding:1rem 1.2rem;text-decoration:none;transition:border-color .15s,box-shadow .15s}
.mission-card:hover{border-color:var(--purple-dim);box-shadow:0 2px 12px rgba(124,58,237,.08)}
.mission-card-wrap .mission-card{border-radius:10px 10px 0 0}
.mission-status-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0}
.mission-status-icon.running{background:rgba(124,58,237,.15);color:var(--purple)}
.mission-status-icon.completed{background:rgba(34,197,94,.12);color:var(--green)}
.mission-status-icon.failed{background:rgba(239,68,68,.12);color:var(--red)}
.mission-status-icon.paused,.mission-status-icon.pending{background:var(--bg-tertiary);color:var(--text-secondary)}
.mission-body{min-width:0}
.mission-title{font-size:0.92rem;font-weight:600;color:var(--text-primary);margin-bottom:0.2rem;display:flex;align-items:center;gap:0.5rem}
.mission-brief{font-size:0.8rem;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:500px;margin-bottom:0.45rem}
.mission-progress-row{display:flex;align-items:center;gap:0.6rem}
.mission-progress-bar{flex:1;max-width:220px;height:6px;background:var(--bg-tertiary);border-radius:3px;overflow:hidden}
.mission-progress-fill{height:100%;border-radius:3px;transition:width .3s}
.mission-progress-fill.running{background:var(--purple)}
.mission-progress-fill.completed{background:var(--green)}
.mission-progress-fill.failed{background:var(--red)}
.mission-progress-fill.pending{background:var(--text-secondary)}
.mission-progress-label{font-size:0.72rem;font-weight:600;color:var(--text-secondary);min-width:60px}
.mission-meta{display:flex;flex-direction:column;align-items:flex-end;gap:0.3rem;flex-shrink:0}
.mission-date{font-size:0.72rem;color:var(--text-secondary)}
.mission-badge{font-size:0.68rem;padding:0.15rem 0.5rem;border-radius:4px;font-weight:600;text-transform:uppercase;letter-spacing:0.03em}
.mission-badge.running{background:rgba(124,58,237,.15);color:var(--purple)}
.mission-badge.completed{background:rgba(34,197,94,.12);color:var(--green)}
.mission-badge.failed{background:rgba(239,68,68,.12);color:var(--red)}
.mission-badge.paused,.mission-badge.pending{background:var(--bg-tertiary);color:var(--text-secondary)}
.mission-badge.resolved{background:rgba(34,197,94,.12);color:var(--green)}
.mission-badge.active{background:rgba(124,58,237,.15);color:var(--purple)}
.mission-card-wrap{display:flex;flex-direction:column;gap:0}
.mission-actions{display:flex;gap:0.4rem;padding:0.4rem 1.2rem 0.6rem;background:var(--bg-secondary);border:1px solid var(--border);border-top:0;border-radius:0 0 10px 10px;margin-top:-1px}
.nm-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:100;display:none;align-items:center;justify-content:center}
.nm-form{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);padding:1.5rem;width:90%;max-width:520px}
.nm-form h3{margin:0 0 1rem;color:var(--text-primary)}
.nm-field{margin-bottom:0.85rem}
.nm-field label{display:block;font-size:0.78rem;font-weight:600;color:var(--text-secondary);margin-bottom:0.3rem}
.nm-field select,.nm-field textarea,.nm-field input{width:100%;background:var(--bg-tertiary);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:0.5rem 0.75rem;font-size:0.85rem;font-family:inherit;outline:none}
.nm-field select:focus,.nm-field textarea:focus,.nm-field input:focus{border-color:var(--purple)}
.nm-field textarea{resize:vertical;min-height:80px}
.nm-actions{display:flex;gap:0.5rem;justify-content:flex-end;margin-top:1rem}
.wf-desc{font-size:0.75rem;color:var(--text-secondary);margin-top:0.3rem;padding:0.4rem 0.6rem;background:var(--bg-tertiary);border-radius:6px;display:none}
.wf-grid{display:grid;grid-template-columns:1fr 1fr;gap:0.6rem}
.wf-card{display:flex;gap:0.75rem;align-items:flex-start;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:10px;padding:0.9rem 1rem;cursor:pointer;text-align:left;transition:border-color .15s,box-shadow .15s;color:inherit;font-family:inherit}
.wf-card:hover{border-color:var(--purple-dim);box-shadow:0 2px 12px rgba(124,58,237,.1)}
.wf-card-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.wf-card-body{display:flex;flex-direction:column;gap:0.2rem}
.wf-card-body strong{font-size:0.88rem;color:var(--text-primary)}
.wf-card-body span{font-size:0.75rem;color:var(--text-secondary);line-height:1.3}
.mission-card.stuck{border-color:rgba(245,158,11,.4);background:rgba(245,158,11,.03)}
.mission-status-icon.stuck{background:rgba(245,158,11,.15);color:#f59e0b}
.mission-badge.stuck{background:rgba(245,158,11,.15);color:#f59e0b}
/* Collapsible sections */
.pi-section{margin-bottom:1.5rem}
.pi-section-header{display:flex;align-items:center;gap:0.5rem;cursor:pointer;user-select:none;padding:0.4rem 0;margin-bottom:0.75rem}
.pi-section-header h2{font-size:1rem;font-weight:700;color:var(--text-primary);margin:0;display:flex;align-items:center;gap:0.5rem}
.pi-section-header .chevron{width:16px;height:16px;color:var(--text-secondary);transition:transform .2s;flex-shrink:0}
.pi-section-header.collapsed .chevron{transform:rotate(-90deg)}
.pi-section-body{overflow:hidden;transition:max-height .25s ease}
.pi-section-body.collapsed{max-height:0!important;overflow:hidden}
.pi-count{font-size:0.72rem;font-weight:400;color:var(--text-secondary);background:var(--bg-tertiary);padding:0.15rem 0.5rem;border-radius:4px}
/* Epics */
.epic-card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:10px;padding:1.2rem;margin-bottom:0.75rem;transition:border-color .15s}
.epic-card:hover{border-color:var(--purple-dim)}
.epic-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:0.6rem}
.epic-title{font-size:0.95rem;font-weight:700;color:var(--text-primary);display:flex;align-items:center;gap:0.5rem}
.epic-status-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.epic-status-dot.active{background:var(--green)}
.epic-status-dot.completed{background:var(--green)}
.epic-status-dot.planning,.epic-status-dot.pending{background:var(--text-secondary)}
.epic-project-badge{font-size:0.68rem;font-weight:500;background:var(--bg-tertiary);color:var(--text-secondary);padding:0.15rem 0.5rem;border-radius:4px}
.epic-desc{font-size:0.8rem;color:var(--text-secondary);margin-bottom:0.75rem;line-height:1.4}
.epic-stats{display:flex;gap:1.5rem;align-items:center;margin-bottom:0.6rem}
.epic-stat{font-size:0.75rem;color:var(--text-secondary)}
.epic-stat strong{color:var(--text-primary);font-weight:700}
.epic-progress{height:8px;background:var(--bg-tertiary);border-radius:4px;overflow:hidden;flex:1;max-width:300px}
.epic-progress-fill{height:100%;border-radius:4px;background:var(--green);transition:width .3s}
.epic-features{display:flex;flex-wrap:wrap;gap:0.4rem;margin-top:0.6rem}
.feat-chip{font-size:0.7rem;padding:0.2rem 0.55rem;border-radius:5px;font-weight:500}
.feat-chip.done{background:rgba(34,197,94,.12);color:var(--green)}
.feat-chip.backlog{background:var(--bg-tertiary);color:var(--text-secondary)}
.feat-chip.in_progress{background:rgba(124,58,237,.12);color:var(--purple)}
.feat-chip.active{background:rgba(124,58,237,.12);color:var(--purple)}
.epic-toggle{cursor:pointer;font-size:0.75rem;color:var(--purple);background:none;border:none;font-family:inherit;padding:0.2rem 0.4rem;display:flex;align-items:center;gap:0.3rem}
/* TMA 3-column board */
.tma-board{display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem}
@media(max-width:900px){.tma-board{grid-template-columns:1fr}}
.tma-col{display:flex;flex-direction:column;gap:0}
.tma-col-header{font-size:0.78rem;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.04em;padding:0.4rem 0.6rem;margin-bottom:0.5rem;display:flex;align-items:center;gap:0.4rem;border-bottom:2px solid var(--border)}
.tma-col-header.active-col{border-bottom-color:var(--purple)}
.tma-col-header.wip-col{border-bottom-color:#f59e0b}
.tma-col-header.resolved-col{border-bottom-color:var(--green)}
.tma-col-body{display:flex;flex-direction:column;gap:0.5rem;min-height:60px}
.tma-card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;padding:0.8rem 1rem;transition:border-color .15s}
.tma-card:hover{border-color:var(--purple-dim)}
.tma-card-header{display:flex;align-items:center;gap:0.5rem;margin-bottom:0.4rem}
.tma-type-icon{width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.tma-type-icon.bug{background:rgba(239,68,68,.1);color:var(--red)}
.tma-type-icon.security{background:rgba(245,158,11,.1);color:#f59e0b}
.tma-type-icon.debt{background:rgba(99,102,241,.1);color:#6366f1}
.tma-card-title{font-size:0.82rem;font-weight:600;color:var(--text-primary);flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.tma-type-badge{font-size:0.65rem;padding:0.1rem 0.4rem;border-radius:3px;font-weight:600;text-transform:uppercase;flex-shrink:0}
.tma-type-badge.bug{background:rgba(239,68,68,.12);color:var(--red)}
.tma-type-badge.security{background:rgba(245,158,11,.12);color:#f59e0b}
.tma-type-badge.debt{background:rgba(99,102,241,.12);color:#6366f1}
.tma-card-desc{font-size:0.75rem;color:var(--text-secondary);line-height:1.4;margin-bottom:0.3rem}
.tma-card-footer{display:flex;align-items:center;justify-content:space-between;gap:0.4rem}
.tma-card-project{font-size:0.68rem;font-weight:500;background:var(--bg-tertiary);color:var(--text-secondary);padding:0.1rem 0.4rem;border-radius:3px}
.tma-card-date{font-size:0.68rem;color:var(--text-secondary)}
.tma-status-dot{display:none;width:8px;height:8px;border-radius:50%;flex-shrink:0}
.tma-status-dot.s-active{background:var(--purple)}
.tma-status-dot.s-wip{background:#f59e0b}
.tma-status-dot.s-resolved{background:var(--green)}
.pi-section-body.view-list .tma-status-dot,.pi-section-body.view-compact .tma-status-dot{display:block}
.tma-empty{font-size:0.78rem;color:var(--text-secondary);text-align:center;padding:1.5rem 0;opacity:0.6}
/* View mode toggle buttons */
.view-toggle{display:flex;gap:2px;margin-left:auto;flex-shrink:0}
.view-toggle button{background:none;border:1px solid transparent;border-radius:4px;padding:3px 5px;cursor:pointer;color:var(--text-secondary);display:flex;align-items:center;justify-content:center;transition:all .15s}
.view-toggle button:hover{color:var(--text-primary);background:var(--bg-tertiary)}
.view-toggle button.active{color:var(--purple);background:rgba(124,58,237,.1);border-color:rgba(124,58,237,.2)}
.view-toggle button svg{width:14px;height:14px}
/* ── List view ── */
.pi-section-body.view-list .epic-card{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:0.8rem;padding:0.6rem 1rem;border-radius:6px;margin-bottom:0.35rem}
.pi-section-body.view-list .epic-header{margin-bottom:0}
.pi-section-body.view-list .epic-desc,.pi-section-body.view-list .epic-features{display:none}
.pi-section-body.view-list .epic-stats{margin:0;gap:0.8rem}
.pi-section-body.view-list .epic-progress{max-width:160px}
.pi-section-body.view-list .tma-board{display:grid!important;grid-template-columns:1fr 1fr 1fr!important;gap:1rem}
.pi-section-body.view-list .tma-col-header{display:flex!important;align-items:center;gap:0.4rem}
.pi-section-body.view-list .tma-col{display:flex!important;flex-direction:column}
.pi-section-body.view-list .tma-col-body{display:flex!important;flex-direction:column;gap:0.5rem}
.pi-section-body.view-list .tma-card{display:grid;grid-template-columns:auto 1fr auto auto;align-items:center;gap:0.6rem;padding:0.5rem 0.8rem;border-radius:6px;width:100%;margin-bottom:0.35rem}
.pi-section-body.view-list .tma-card-desc{display:none}
.pi-section-body.view-list .tma-card-header{margin-bottom:0}
.pi-section-body.view-list .tma-card-footer{margin:0}
.pi-section-body.view-list .mission-card{padding:0.6rem 1rem;border-radius:6px}
.pi-section-body.view-list .mission-brief{display:none}
.pi-section-body.view-list .mission-card-wrap .mission-card{border-radius:6px 6px 0 0}
.pi-section-body.view-list .mission-actions{padding:0.25rem 1rem 0.4rem}
/* ── Compact view ── */
.pi-section-body.view-compact .epic-card{display:flex;align-items:center;gap:0.6rem;padding:0.35rem 0.8rem;border-radius:4px;margin-bottom:2px;border:none;background:transparent;border-bottom:1px solid var(--border)}
.pi-section-body.view-compact .epic-card:hover{background:var(--bg-secondary)}
.pi-section-body.view-compact .epic-header{margin-bottom:0;flex:1;min-width:0}
.pi-section-body.view-compact .epic-title{font-size:0.82rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.pi-section-body.view-compact .epic-desc,.pi-section-body.view-compact .epic-features,.pi-section-body.view-compact .epic-toggle,.pi-section-body.view-compact .epic-stats{display:none}
.pi-section-body.view-compact .epic-header>div:last-child{flex-shrink:0}
.pi-section-body.view-compact .tma-board{display:grid!important;grid-template-columns:1fr 1fr 1fr!important;gap:1rem}
.pi-section-body.view-compact .tma-col-header{display:flex!important;align-items:center;gap:0.4rem;font-size:0.75rem}
.pi-section-body.view-compact .tma-col{display:flex!important;flex-direction:column}
.pi-section-body.view-compact .tma-col-body{display:flex!important;flex-direction:column;gap:0.35rem}
.pi-section-body.view-compact .tma-card{display:flex;align-items:center;gap:0.5rem;padding:0.3rem 0.8rem;border-radius:0;border:none;border-bottom:1px solid var(--border);background:transparent}
.pi-section-body.view-compact .tma-card:hover{background:var(--bg-secondary)}
.pi-section-body.view-compact .tma-card-desc,.pi-section-body.view-compact .tma-card-footer{display:none}
.pi-section-body.view-compact .tma-card-header{margin-bottom:0;flex:1;min-width:0}
.pi-section-body.view-compact .tma-card-title{font-size:0.78rem}
.pi-section-body.view-compact .tma-type-icon{width:22px;height:22px;border-radius:4px}
.pi-section-body.view-compact .mission-list{gap:0}
.pi-section-body.view-compact .mission-card{padding:0.35rem 0.8rem;border-radius:0;border:none;border-bottom:1px solid var(--border);background:transparent}
.pi-section-body.view-compact .mission-card:hover{background:var(--bg-secondary)}
.pi-section-body.view-compact .mission-brief{display:none}
.pi-section-body.view-compact .mission-status-icon{width:28px;height:28px;border-radius:6px;font-size:0.85rem}
.pi-section-body.view-compact .mission-title{font-size:0.82rem}
.pi-section-body.view-compact .mission-card-wrap .mission-card{border-radius:0}
.pi-section-body.view-compact .mission-card-wrap{border-bottom:1px solid var(--border)}
.pi-section-body.view-compact .mission-actions{display:none}
</style>

<!-- ═══ Epics (SAFe Portfolio) ═══ -->
{% if epics %}
<div class="pi-section" id="section-epics">
    <div class="pi-section-header" onclick="toggleSection('epics')">
        <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
        <h2><svg class="icon icon-sm"><use href="#icon-layers"/></svg> Epics
            <span class="pi-count">{{ epics|length }}</span>
        </h2>
        <div class="view-toggle" onclick="event.stopPropagation()">
            <button title="Cards" onclick="setViewMode('epics','card')" data-mode="card"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg></button>
            <button title="List" onclick="setViewMode('epics','list')" data-mode="list"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg></button>
            <button title="Compact" onclick="setViewMode('epics','compact')" data-mode="compact"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><line x1="3" y1="14" x2="21" y2="14"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button>
        </div>
    </div>
    <div class="pi-section-body" id="body-epics">
    {% for e in epics %}
    {% set pct = ((e.done_features / e.total_features) * 100)|round|int if e.total_features > 0 else 0 %}
    <div class="epic-card">
        <div class="epic-header">
            <div class="epic-title">
                <span class="epic-status-dot {{ e.status }}"></span>
                {{ e.name }}
                <span class="epic-project-badge">{{ e.project_name }}</span>
            </div>
            <div style="display:flex;align-items:center;gap:0.6rem">
                <span class="mission-badge {{ e.status }}">{{ e.status }}</span>
                <button class="epic-toggle" onclick="event.stopPropagation();this.closest('.epic-card').querySelector('.epic-features').classList.toggle('hidden')">
                    <svg class="icon icon-sm" style="width:14px;height:14px"><use href="#icon-chevron-down"/></svg> features
                </button>
                <button class="btn btn-sm btn-danger" style="padding:2px 6px" onclick="event.stopPropagation();deleteMission('{{ e.id }}','{{ e.name[:30]|replace("'","&#39;") }}')" title="Supprimer cette epic">
                    <svg style="width:12px;height:12px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                </button>
            </div>
        </div>
        {% if e.description %}<div class="epic-desc">{{ e.description }}</div>{% endif %}
        <div class="epic-stats">
            <div class="epic-progress"><div class="epic-progress-fill" style="width:{{ pct }}%"></div></div>
            <span class="epic-stat"><strong>{{ e.done_features }}/{{ e.total_features }}</strong> features</span>
            <span class="epic-stat"><strong>{{ e.done_sp }}/{{ e.total_sp }}</strong> SP</span>
            <span class="epic-stat" style="font-size:0.7rem;opacity:0.6">{{ pct }}%</span>
        </div>
        <div class="epic-features" id="feats-{{ e.id }}">
            {% for status_key, info in e.features_by_status.items() %}
            <span class="feat-chip {{ status_key }}">{{ status_key }}: {{ info.count }} ({{ info.sp }} SP)</span>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
    </div>
</div>
{% endif %}

<!-- ═══ TMA / Tickets — 3 columns: Active / WIP / Resolved ═══ -->
{% if tma_tickets %}
{% set tma_active = tma_tickets|selectattr('status','equalto','active')|list %}
{% set tma_wip = tma_tickets|selectattr('status','in',['in_progress','planning'])|list %}
{% set tma_resolved = tma_tickets|selectattr('status','in',['resolved','completed','done'])|list %}
<div class="pi-section" id="section-tma">
    <div class="pi-section-header" onclick="toggleSection('tma')">
        <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
        <h2><svg class="icon icon-sm"><use href="#icon-tool"/></svg> TMA — Tickets Maintenance
            <span class="pi-count">{{ tma_tickets|length }}</span>
        </h2>
        <div class="view-toggle" onclick="event.stopPropagation()">
            <button title="Cards" onclick="setViewMode('tma','card')" data-mode="card"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg></button>
            <button title="List" onclick="setViewMode('tma','list')" data-mode="list"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg></button>
            <button title="Compact" onclick="setViewMode('tma','compact')" data-mode="compact"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><line x1="3" y1="14" x2="21" y2="14"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button>
        </div>
    </div>
    <div class="pi-section-body" id="body-tma">
    <div class="tma-board">
        <div class="tma-col">
            <div class="tma-col-header active-col">
                <svg class="icon icon-sm" style="width:14px;height:14px"><use href="#icon-alert-circle"/></svg>
                Active <span class="pi-count">{{ tma_active|length }}</span>
            </div>
            <div class="tma-col-body">
            {% for t in tma_active %}
            <div class="tma-card" style="cursor:pointer" onclick="openTMAModal('{{ t.id }}')" data-name="{{ t.name }}" data-type="{{ t.type }}" data-status="{{ t.status }}" data-project="{{ t.project_name }}" data-desc="{{ t.description }}" data-goal="{{ t.goal }}">
                <div class="tma-card-header">
                    <span class="tma-status-dot s-active" title="Active"></span>
                    <div class="tma-type-icon {{ t.type }}">
                        {% if t.type == 'bug' %}<svg class="icon icon-sm" style="width:14px;height:14px"><use href="#icon-alert-triangle"/></svg>
                        {% elif t.type == 'security' %}<svg class="icon icon-sm" style="width:14px;height:14px"><use href="#icon-shield"/></svg>
                        {% elif t.type == 'debt' %}<svg class="icon icon-sm" style="width:14px;height:14px"><use href="#icon-tool"/></svg>
                        {% else %}<svg class="icon icon-sm" style="width:14px;height:14px"><use href="#icon-file-text"/></svg>{% endif %}
                    </div>
                    <span class="tma-card-title" title="{{ t.name }}">{{ t.name }}</span>
                    <span class="tma-type-badge {{ t.type }}">{{ t.type }}</span>
                </div>
                {% if t.description %}<div class="tma-card-desc">{{ t.description[:120] }}</div>{% endif %}
                {% if t.goal %}<div class="tma-card-desc" style="opacity:0.7"><svg class="icon icon-sm" style="width:12px;height:12px;vertical-align:-2px"><use href="#icon-target"/></svg> {{ t.goal[:120] }}</div>{% endif %}
                <div class="tma-card-footer">
                    <span class="tma-card-project">{{ t.project_name }}</span>
                    <span class="tma-card-date">{{ t.created_at | ts('date') }}</span>
                </div>
            </div>
            {% endfor %}
            {% if not tma_active %}<div class="tma-empty">{{ _("aucun_ticket_actif") }}</div>{% endif %}
            </div>
        </div>
        <div class="tma-col">
            <div class="tma-col-header wip-col">
                <svg class="icon icon-sm" style="width:14px;height:14px"><use href="#icon-loader"/></svg>
                En cours <span class="pi-count">{{ tma_wip|length }}</span>
            </div>
            <div class="tma-col-body">
            {% for t in tma_wip %}
            <div class="tma-card" style="cursor:pointer" onclick="openTMAModal('{{ t.id }}')" data-name="{{ t.name }}" data-type="{{ t.type }}" data-status="{{ t.status }}" data-project="{{ t.project_name }}" data-desc="{{ t.description }}" data-goal="{{ t.goal }}">
                <div class="tma-card-header">
                    <span class="tma-status-dot s-wip" title="En cours"></span>
                    <div class="tma-type-icon {{ t.type }}">
                        {% if t.type == 'bug' %}<svg class="icon icon-sm" style="width:14px;height:14px"><use href="#icon-alert-triangle"/></svg>
                        {% elif t.type == 'security' %}<svg class="icon icon-sm" style="width:14px;height:14px"><use href="#icon-shield"/></svg>
                        {% elif t.type == 'debt' %}<svg class="icon icon-sm" style="width:14px;height:14px"><use href="#icon-tool"/></svg>
                        {% else %}<svg class="icon icon-sm" style="width:14px;height:14px"><use href="#icon-file-text"/></svg>{% endif %}
                    </div>
                    <span class="tma-card-title" title="{{ t.name }}">{{ t.name }}</span>
                    <span class="tma-type-badge {{ t.type }}">{{ t.type }}</span>
                </div>
                {% if t.description %}<div class="tma-card-desc">{{ t.description[:120] }}</div>{% endif %}
                {% if t.goal %}<div class="tma-card-desc" style="opacity:0.7"><svg class="icon icon-sm" style="width:12px;height:12px;vertical-align:-2px"><use href="#icon-target"/></svg> {{ t.goal[:120] }}</div>{% endif %}
                <div class="tma-card-footer">
                    <span class="tma-card-project">{{ t.project_name }}</span>
                    <span class="tma-card-date">{{ t.created_at | ts('date') }}</span>
                </div>
            </div>
            {% endfor %}
            {% if not tma_wip %}<div class="tma-empty">{{ _("aucun_ticket_en_cours") }}</div>{% endif %}
            </div>
        </div>
        <div class="tma-col">
            <div class="tma-col-header resolved-col">
                <svg class="icon icon-sm" style="width:14px;height:14px"><use href="#icon-check-circle"/></svg>
                Resolved <span class="pi-count">{{ tma_resolved|length }}</span>
            </div>
            <div class="tma-col-body">
            {% for t in tma_resolved %}
            <div class="tma-card" style="cursor:pointer" onclick="openTMAModal('{{ t.id }}')" data-name="{{ t.name }}" data-type="{{ t.type }}" data-status="{{ t.status }}" data-project="{{ t.project_name }}" data-desc="{{ t.description }}" data-goal="{{ t.goal }}">
                <div class="tma-card-header">
                    <span class="tma-status-dot s-resolved" title="Resolved"></span>
                    <div class="tma-type-icon {{ t.type }}">
                        {% if t.type == 'bug' %}<svg class="icon icon-sm" style="width:14px;height:14px"><use href="#icon-alert-triangle"/></svg>
                        {% elif t.type == 'security' %}<svg class="icon icon-sm" style="width:14px;height:14px"><use href="#icon-shield"/></svg>
                        {% elif t.type == 'debt' %}<svg class="icon icon-sm" style="width:14px;height:14px"><use href="#icon-tool"/></svg>
                        {% else %}<svg class="icon icon-sm" style="width:14px;height:14px"><use href="#icon-file-text"/></svg>{% endif %}
                    </div>
                    <span class="tma-card-title" title="{{ t.name }}">{{ t.name }}</span>
                    <span class="tma-type-badge {{ t.type }}">{{ t.type }}</span>
                </div>
                {% if t.goal %}<div class="tma-card-desc" style="opacity:0.7"><svg class="icon icon-sm" style="width:12px;height:12px;vertical-align:-2px"><use href="#icon-target"/></svg> {{ t.goal[:120] }}</div>{% endif %}
                <div class="tma-card-footer">
                    <span class="tma-card-project">{{ t.project_name }}</span>
                    <span class="tma-card-date">{{ t.created_at | ts('date') }}</span>
                </div>
            </div>
            {% endfor %}
            {% if not tma_resolved %}<div class="tma-empty">{{ _("aucun_ticket_resolu") }}</div>{% endif %}
            </div>
        </div>
    </div>
    </div>
</div>
{% endif %}

<!-- ═══ Missions (Runs) ═══ -->
<div class="pi-section" id="section-missions">
    <div class="pi-section-header" onclick="toggleSection('missions')">
        <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
        <h2><svg class="icon icon-sm"><use href="#icon-zap"/></svg> Missions en cours
            <span class="pi-count">{{ runs|length }}</span>
        </h2>
        <div class="view-toggle" onclick="event.stopPropagation()">
            <button title="Cards" onclick="setViewMode('missions','card')" data-mode="card"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg></button>
            <button title="List" onclick="setViewMode('missions','list')" data-mode="list"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg></button>
            <button title="Compact" onclick="setViewMode('missions','compact')" data-mode="compact"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><line x1="3" y1="14" x2="21" y2="14"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button>
        </div>
    </div>
    <div class="pi-section-body" id="body-missions">
{% if runs %}
{% include "partials/mission_list.html" %}
{% else %}
<div class="empty-state" style="text-align:center;padding:3rem;">
    <p style="margin-bottom:0.5rem"><svg class="icon" style="width:2.5rem;height:2.5rem"><use href="#icon-zap"/></svg></p>
    <h3 style="color:var(--text-primary);margin-bottom:0.3rem">{{ _('no_mission') }}</h3>
    <p style="color:var(--text-secondary);font-size:0.88rem;margin-bottom:1rem">{{ _("lancez_une_mission_pour_orchestrer_un") }}</p>
    <button class="btn btn-primary" onclick="document.getElementById('newMissionModal').style.display='flex'">
        <svg class="icon icon-sm"><use href="#icon-plus"/></svg> {{ _('new_mission') }}
    </button>
</div>
{% endif %}
    </div>
</div>

<!-- Release Notes Section -->
<div class="pi-section" id="section-releases">
    <div class="pi-section-header" onclick="toggleSection('releases')">
        <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
        <h2><svg class="icon icon-sm"><use href="#icon-package"/></svg> Release Notes
            <span class="pi-count" id="releaseCount">0</span>
        </h2>
    </div>
    <div class="pi-section-body" id="body-releases">
        <div id="releaseNotesPI" style="font-size:0.82rem;color:var(--text-secondary)">
            <p style="font-style:italic;color:var(--text-muted)">Loading release data...</p>
        </div>
    </div>
</div>

<!-- Modal creation mission -->
<div id="newMissionModal" class="nm-overlay" onclick="if(event.target===this)this.style.display='none'">
    <div class="nm-form" id="step1" style="max-width:600px">
        <h3><svg class="icon icon-sm" style="vertical-align:middle;margin-right:0.3rem"><use href="#icon-zap"/></svg> {{ _('new_mission') }}</h3>
        <p style="color:var(--text-secondary);font-size:0.82rem;margin:-0.5rem 0 1rem">{{ _("choisissez_le_type_de_mission") }}</p>
        <div class="wf-grid">
            <button type="button" class="wf-card" onclick="selectWf('product-lifecycle')">
                <div class="wf-card-icon" style="background:rgba(124,58,237,.15);color:var(--purple)"><svg class="icon"><use href="#icon-git-merge"/></svg></div>
                <div class="wf-card-body">
                    <strong>{{ _("full_cycle") }}</strong>
                    <span>{{ _("ideation_architecture_sprints_ci_cd_qa") }}</span>
                </div>
            </button>
            <button type="button" class="wf-card" onclick="selectWf('tma-maintenance')">
                <div class="wf-card-icon" style="background:rgba(251,191,36,.12);color:var(--yellow)"><svg class="icon"><use href="#icon-tool"/></svg></div>
                <div class="wf-card-body">
                    <strong>{{ _("tma_ticketing") }}</strong>
                    <span>{{ _("application_maintenance_incident_tickets_n1_n2") }}</span>
                </div>
            </button>
            <button type="button" class="wf-card" onclick="selectWf('security-hacking')">
                <div class="wf-card-icon" style="background:rgba(239,68,68,.12);color:var(--red)"><svg class="icon"><use href="#icon-shield"/></svg></div>
                <div class="wf-card-body">
                    <strong>{{ _("hacking_security") }}</strong>
                    <span>{{ _("owasp_audit_pentesting_sast_dast_hardening") }}</span>
                </div>
            </button>
            <button type="button" class="wf-card" onclick="selectWf('feature-request')">
                <div class="wf-card-icon" style="background:rgba(34,197,94,.12);color:var(--green)"><svg class="icon"><use href="#icon-plus-circle"/></svg></div>
                <div class="wf-card-body">
                    <strong>{{ _('new_features') }}</strong>
                    <span>{{ _("adding_features_to_existing_migration_evolution") }}</span>
                </div>
            </button>
            <button type="button" class="wf-card" onclick="selectWf('pi-planning')">
                <div class="wf-card-icon" style="background:rgba(59,130,246,.12);color:var(--blue)"><svg class="icon"><use href="#icon-calendar"/></svg></div>
                <div class="wf-card-body">
                    <strong>PI Planning</strong>
                    <span>{{ _("pi_planning_safe_program_increment") }}</span>
                </div>
            </button>
            <button type="button" class="wf-card" onclick="selectWf('tech-debt-reduction')">
                <div class="wf-card-icon" style="background:rgba(245,158,11,.12);color:var(--yellow)"><svg class="icon"><use href="#icon-alert-triangle"/></svg></div>
                <div class="wf-card-body">
                    <strong>{{ _("dette_technique") }}</strong>
                    <span>{{ _("tech_debt_audit_wsjf_sprint_fix") }}</span>
                </div>
            </button>
        </div>
        <div class="nm-actions" style="margin-top:0.75rem">
            <button type="button" class="btn btn-ghost" onclick="document.getElementById('newMissionModal').style.display='none'">{{ _("cancel") }}</button>
        </div>
    </div>
    <form class="nm-form" id="step2" style="display:none">
        <h3 id="step2Title"></h3>
        <input type="hidden" name="project_id" value="software-factory">
        <input type="hidden" name="workflow_id" id="wfInput">
        <div class="nm-field">
            <label>{{ _("mission_brief") }}</label>
            <textarea name="brief" id="briefInput" placeholder="Nom - Description du besoin, contexte, objectifs..." required style="min-height:100px"></textarea>
        </div>
        <div class="nm-actions">
            <button type="button" class="btn btn-ghost" onclick="backToStep1()">{{ _('back') }}</button>
            <button type="submit" class="btn btn-primary">
                <svg class="icon icon-sm"><use href="#icon-play"/></svg> {{ _('launch_mission') }}
            </button>
        </div>
    </form>
</div>

<script>
/* Collapsible sections with localStorage persistence */
function toggleSection(id) {
    const header = document.querySelector(`#section-${id} .pi-section-header`);
    const body = document.getElementById(`body-${id}`);
    const collapsed = !header.classList.contains('collapsed');
    header.classList.toggle('collapsed', collapsed);
    body.classList.toggle('collapsed', collapsed);
    try { localStorage.setItem(`pi_collapse_${id}`, collapsed ? '1' : '0'); } catch(e){}
}

/* View mode switching (card/list/compact) with localStorage */
function setViewMode(section, mode) {
    const body = document.getElementById(`body-${section}`);
    if (!body) return;
    body.classList.remove('view-list', 'view-compact');
    if (mode === 'list') body.classList.add('view-list');
    else if (mode === 'compact') body.classList.add('view-compact');
    // Update active button
    const toggles = document.querySelector(`#section-${section} .view-toggle`);
    if (toggles) toggles.querySelectorAll('button').forEach(b => b.classList.toggle('active', b.dataset.mode === mode));
    try { localStorage.setItem(`pi_view_${section}`, mode); } catch(e){}
}

function restoreCollapseState() {
    ['epics','tma','missions','releases'].forEach(id => {
        try {
            if (localStorage.getItem(`pi_collapse_${id}`) === '1') {
                const header = document.querySelector(`#section-${id} .pi-section-header`);
                const body = document.getElementById(`body-${id}`);
                if (header && body) { header.classList.add('collapsed'); body.classList.add('collapsed'); }
            }
            const vm = localStorage.getItem(`pi_view_${id}`) || 'card';
            setViewMode(id, vm);
        } catch(e){}
    });
}
restoreCollapseState();

const WF_NAMES = {
    'product-lifecycle': 'Cycle Complet',
    'tma-maintenance': 'TMA / Ticketing',
    'security-hacking': 'Hacking / Securite',
    'feature-request': 'Nouvelle Feature',
    'pi-planning': 'PI Planning — SAFe',
    'tech-debt-reduction': 'Dette Technique'
};
function selectWf(id){
    document.getElementById('wfInput').value = id;
    document.getElementById('step2Title').textContent = WF_NAMES[id] || id;
    document.getElementById('step1').style.display = 'none';
    document.getElementById('step2').style.display = 'block';
    document.getElementById('briefInput').focus();
}
function backToStep1(){
    document.getElementById('step2').style.display = 'none';
    document.getElementById('step1').style.display = 'block';
}

document.getElementById('step2').addEventListener('submit', async e => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const btn = e.target.querySelector('[type=submit]');
    btn.disabled = true; btn.textContent = 'Lancement...';
    try {
        const r = await fetch('/api/missions/start', {method:'POST', body: fd});
        const j = await r.json();
        if (j.redirect) location.href = j.redirect;
        else { alert(j.error || 'Erreur'); btn.disabled = false; btn.textContent = 'Lancer'; }
    } catch(err) { alert(err); btn.disabled = false; btn.textContent = 'Lancer'; }
});

async function runPhase(runId) {
    try {
        const r = await fetch(`/api/missions/${runId}/run`, {method:'POST'});
        const j = await r.json();
        if (j.status === 'started' || j.status === 'running' || j.redirect) location.href = `/missions/${runId}/control`;
        else alert(j.error || j.message || 'Erreur');
    } catch(err) { alert(err); }
}

async function deleteRun(runId, runName) {
    openDeleteModal({
        title: 'Supprimer cette mission',
        subtitle: 'Supprime la mission et toutes les données associées',
        warning: 'Sprints, tâches, sessions, messages, traces LLM et artefacts seront définitivement supprimés.',
        expectedName: runName || runId.slice(0,8),
        onConfirm: async () => {
            const r = await fetch(`/api/mission-runs/${runId}`, {method:'DELETE'});
            if (r.ok) location.reload();
            else { const j = await r.json(); throw j.error || 'Erreur'; }
        }
    });
}

async function deleteMission(missionId, missionName) {
    openDeleteModal({
        title: 'Supprimer cette epic',
        subtitle: 'Supprime l\'epic et toutes ses missions, features et données',
        warning: 'Toutes les missions (runs), features, user stories, sprints, tâches et sessions associées seront définitivement supprimées.',
        expectedName: missionName || missionId.slice(0,8),
        onConfirm: async () => {
            const r = await fetch(`/api/missions/${missionId}`, {method:'DELETE'});
            if (r.ok) location.reload();
            else { const j = await r.json(); throw j.error || 'Erreur'; }
        }
    });
}

let _searchTimer;
function debounceSearch(q) {
    clearTimeout(_searchTimer);
    const box = document.getElementById('searchResults');
    if (q.length < 2) { box.style.display='none'; return; }
    _searchTimer = setTimeout(async()=>{
        const r = await fetch(`/api/search?q=${encodeURIComponent(q)}`);
        const j = await r.json();
        if (!j.results.length) { box.innerHTML='<div style="padding:0.8rem;color:var(--text-secondary);font-size:0.8rem">No results</div>'; box.style.display='block'; return; }
        const icons = {epic:'<use href="#icon-rocket"/>',feature:'<use href="#icon-star"/>',ticket:'<use href="#icon-alert-triangle"/>',memory:'<use href="#icon-database"/>'};
        const colors = {epic:'var(--purple)',feature:'var(--blue)',ticket:'var(--yellow)',memory:'var(--green)'};
        box.innerHTML = j.results.map(r => `<a href="${r.type==='epic'?'/missions/'+r.id+'/control':r.type==='feature'?'#':'#'}" style="display:flex;align-items:center;gap:0.6rem;padding:0.5rem 0.8rem;text-decoration:none;border-bottom:1px solid var(--border);transition:background .1s" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='transparent'"><svg class="icon icon-sm" style="width:15px;height:15px;color:${colors[r.type]||'var(--text-secondary)'};flex-shrink:0">${icons[r.type]||'<use href="#icon-file-text"/>'}</svg><div style="min-width:0;flex:1"><div style="font-size:0.8rem;font-weight:500;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${r.name}</div><div style="font-size:0.68rem;color:var(--text-secondary)">${r.type} · ${r.status||''} ${r.project?'· '+r.project:''}</div></div></a>`).join('');
        box.style.display='block';
    }, 300);
}

// Load release notes
(async () => {
    try {
        const projects = {{ projects | map(attribute='id') | list | tojson if projects else '[]' }};
        const projectId = projects.length > 0 ? projects[0] : '';
        if (!projectId) return;
        const resp = await fetch(`/api/releases/${projectId}`);
        const data = await resp.json();
        const el = document.getElementById('releaseNotesPI');
        const countEl = document.getElementById('releaseCount');
        if (!data.releases || data.releases.length === 0) {
            el.innerHTML = '<p style="text-align:center;color:var(--text-muted)">No releases yet</p>';
            return;
        }
        countEl.textContent = data.releases.length;
        let html = '';
        for (const r of data.releases) {
            const date = r.completed_at ? r.completed_at.slice(0, 10) : 'In progress';
            const pct = r.progress_pct !== undefined ? ` — ${r.progress_pct}%` : '';
            html += `<div style="margin-bottom:1rem;padding:0.75rem;background:var(--bg-secondary);border-radius:8px;border:1px solid var(--border)">`;
            html += `<div style="font-weight:600;color:var(--text-primary);font-size:0.88rem;margin-bottom:0.3rem">${r.epic_name}</div>`;
            html += `<div style="font-size:0.72rem;color:var(--text-muted);margin-bottom:0.5rem">${date}${pct} &middot; ${r.feature_count} features &middot; ${r.total_sp} SP</div>`;
            for (const f of r.features) {
                const icon = f.status === 'done' ? '&#10003;' : '&#9679;';
                const clr = f.status === 'done' ? 'var(--green)' : 'var(--text-muted)';
                html += `<div style="padding:0.15rem 0 0.15rem 0.5rem;font-size:0.78rem"><span style="color:${clr}">${icon}</span> ${f.name}${f.sp ? ' ('+f.sp+' SP)' : ''}</div>`;
            }
            html += `</div>`;
        }
        el.innerHTML = html;
    } catch(e) { console.error('Release notes error:', e); }
})();
</script>

<script>
// TMA Ticket Modal Functions - EDITABLE VERSION
let currentEditingTicket = null;

async function openTMAModal(ticketId) {
    const card = event.currentTarget;
    const name = card.dataset.name || 'Ticket';
    const type = card.dataset.type || 'unknown';
    const status = card.dataset.status || 'active';
    const project = card.dataset.project || '';
    const desc = card.dataset.desc || '';
    const goal = card.dataset.goal || '';
    
    currentEditingTicket = { id: ticketId, name, type, status, project, desc, goal };
    
    const modal = document.createElement('div');
    modal.id = 'tmaModal';
    modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10000;padding:1rem';
    
    const typeColors = {'bug':'#ef4444','security':'#f59e0b','debt':'#8b5cf6','performance':'#06b6d4'};
    const typeColor = typeColors[type] || '#6b7280';
    
    modal.innerHTML = `
    <div style="background:var(--bg-primary);border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,0.5);width:100%;max-width:700px;max-height:90vh;overflow-y:auto">
        <div style="padding:1.5rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between">
            <h3 style="margin:0;display:flex;align-items:center;gap:0.8rem">
                <span style="width:12px;height:12px;border-radius:50%;background:${typeColor}"></span>
                <span style="font-size:1.1rem;font-weight:600">${name}</span>
            </h3>
            <button onclick="closeTMAModal()" style="background:none;border:none;font-size:2rem;color:var(--text-secondary);cursor:pointer;padding:0;width:32px;height:32px">&times;</button>
        </div>
        <form id="tmaEditForm" style="padding:1.5rem">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1.5rem">
                <div>
                    <label style="font-size:0.7rem;font-weight:600;color:var(--text-secondary);text-transform:uppercase;margin-bottom:0.3rem;display:block">Type</label>
                    <select name="type" style="width:100%;padding:0.5rem;background:var(--bg-secondary);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-size:0.85rem">
                        <option value="bug" ${type === 'bug' ? 'selected' : ''}>Bug</option>
                        <option value="security" ${type === 'security' ? 'selected' : ''}>Security</option>
                        <option value="debt" ${type === 'debt' ? 'selected' : ''}>Debt</option>
                        <option value="performance" ${type === 'performance' ? 'selected' : ''}>Performance</option>
                    </select>
                </div>
                <div>
                    <label style="font-size:0.7rem;font-weight:600;color:var(--text-secondary);text-transform:uppercase;margin-bottom:0.3rem;display:block">Statut</label>
                    <select name="status" style="width:100%;padding:0.5rem;background:var(--bg-secondary);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-size:0.85rem">
                        <option value="open" ${status === 'open' ? 'selected' : ''}>Active</option>
                        <option value="in_progress" ${status === 'in_progress' ? 'selected' : ''}>En cours</option>
                        <option value="resolved" ${status === 'resolved' ? 'selected' : ''}>Résolu</option>
                        <option value="closed" ${status === 'closed' ? 'selected' : ''}>Closed</option>
                    </select>
                </div>
            </div>
            
            <div style="margin-bottom:1.5rem">
                <label style="font-size:0.7rem;font-weight:600;color:var(--text-secondary);text-transform:uppercase;margin-bottom:0.3rem;display:block">Nom du ticket</label>
                <input type="text" name="name" value="${name || ''}" style="width:100%;padding:0.8rem;background:var(--bg-secondary);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-size:0.85rem" required>
            </div>
            
            ${project ? `<div style="margin-bottom:1.5rem">
                <label style="font-size:0.7rem;font-weight:600;color:var(--text-secondary);text-transform:uppercase;margin-bottom:0.3rem;display:block">Projet</label>
                <div style="padding:0.5rem;background:var(--bg-secondary);border-radius:6px;font-size:0.85rem;color:var(--text-secondary)">${project}</div>
            </div>` : ''}
            
            <div style="margin-bottom:1.5rem">
                <label style="font-size:0.7rem;font-weight:600;color:var(--text-secondary);text-transform:uppercase;margin-bottom:0.3rem;display:block">Description</label>
                <textarea name="description" rows="4" style="width:100%;padding:0.8rem;background:var(--bg-secondary);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-size:0.85rem;resize:vertical">${desc || ''}</textarea>
            </div>
            
            <div style="margin-bottom:1.5rem">
                <label style="font-size:0.7rem;font-weight:600;color:var(--text-secondary);text-transform:uppercase;margin-bottom:0.3rem;display:block">Objectif</label>
                <textarea name="goal" rows="3" style="width:100%;padding:0.8rem;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:6px;border-left:3px solid var(--purple);color:var(--text-primary);font-size:0.85rem;resize:vertical">${goal || ''}</textarea>
            </div>
            
            <div style="background:var(--bg-tertiary);padding:1rem;border-radius:8px;font-size:0.75rem;color:var(--text-secondary)">
                <strong>ID:</strong> ${ticketId}
            </div>
        </form>
        
        <div style="padding:1rem 1.5rem;border-top:1px solid var(--border);background:var(--bg-secondary);display:flex;gap:0.5rem;justify-content:space-between">
            <button onclick="deleteTicket('${ticketId}')" style="background:#ef4444;color:white;border:none;padding:0.6rem 1.2rem;border-radius:6px;cursor:pointer;font-size:0.85rem;font-weight:600;transition:all 0.2s" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'"><svg class="icon icon-sm" style="vertical-align:middle;margin-right:4px"><use href="#icon-trash"/></svg>Supprimer</button>
            <div style="display:flex;gap:0.5rem">
                <button onclick="closeTMAModal()" style="background:var(--bg-tertiary);color:var(--text-primary);border:1px solid var(--border);padding:0.6rem 1.2rem;border-radius:6px;cursor:pointer;font-size:0.85rem;font-weight:600">Annuler</button>
                <button onclick="saveTicket()" style="background:var(--purple);color:white;border:none;padding:0.6rem 1.5rem;border-radius:6px;cursor:pointer;font-size:0.85rem;font-weight:600;transition:all 0.2s" onmouseover="this.style.background='#7c3aed'" onmouseout="this.style.background='var(--purple)'"><svg class="icon icon-sm" style="vertical-align:middle;margin-right:4px"><use href="#icon-save"/></svg>Enregistrer</button>
            </div>
        </div>
    </div>`;
    
    document.body.appendChild(modal);
    modal.addEventListener('click', (e) => { if (e.target === modal) closeTMAModal(); });
}

async function saveTicket() {
    const form = document.getElementById('tmaEditForm');
    const formData = new FormData(form);
    
    const payload = {
        name: formData.get('name'),
        description: formData.get('description'),
        goal: formData.get('goal'),
        status: formData.get('status'),
        type: formData.get('type')
    };
    
    try {
        const response = await fetch(`/api/tma/tickets/${currentEditingTicket.id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        if (response.ok) {
            showToast('Ticket mis à jour avec succès', 'success');
            closeTMAModal();
            setTimeout(() => window.location.reload(), 800);
        } else {
            const error = await response.json();
            showToast('Erreur: ' + (error.detail || 'Update failed'), 'error');
        }
    } catch (error) {
        showToast('Erreur réseau: ' + error.message, 'error');
    }
}

async function deleteTicket(ticketId) {
    if (!confirm('Êtes-vous sûr de vouloir supprimer ce ticket ?')) return;
    
    try {
        const response = await fetch(`/api/tma/tickets/${ticketId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showToast('Ticket supprimé', 'success');
            closeTMAModal();
            setTimeout(() => window.location.reload(), 800);
        } else {
            const error = await response.json();
            showToast('Erreur: ' + (error.detail || 'Delete failed'), 'error');
        }
    } catch (error) {
        showToast('Erreur réseau: ' + error.message, 'error');
    }
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.style.cssText = `position:fixed;top:20px;right:20px;padding:1rem 1.5rem;background:${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#6b7280'};color:white;border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,0.3);z-index:10001;font-size:0.9rem;font-weight:600;animation:slideIn 0.3s ease`;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function closeTMAModal() { 
    const modal = document.getElementById('tmaModal'); 
    if (modal) modal.remove();
    currentEditingTicket = null;
}
</script>

<style>
@keyframes slideIn {
    from { transform: translateX(400px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(400px); opacity: 0; }
}
</style>
{% endblock %}
