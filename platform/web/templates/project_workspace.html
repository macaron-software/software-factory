{% extends "base.html" %}
{% block extra_head %}
<script src="/static/js/codemirror6.min.js"></script>
<link rel="stylesheet" href="/static/css/project_workspace.css?v=10">
<style>
html,body{height:100%;overflow:hidden}
.layout{display:grid!important;grid-template-columns:56px 1fr;height:100vh!important;overflow:hidden!important}
.content{display:flex!important;flex-direction:column!important;height:100%!important;overflow:hidden!important;min-height:0!important}
.main-area{padding:0!important;overflow:hidden!important;flex:1 1 0%!important;min-height:0!important;display:flex!important;flex-direction:column!important}
.ws-layout{display:flex!important;flex-direction:row!important;height:100%!important;overflow:hidden!important;background:var(--bg)}
.ws-center{flex:1 1 0%!important;display:flex!important;flex-direction:column!important;overflow:hidden!important;min-width:0}
.ws-infobar{flex-shrink:0!important}
/* File tree: only visible in code view */
.ws-filetree{display:none!important}
.ws-layout[data-view="code"] .ws-filetree{display:flex!important;width:200px!important;min-width:160px!important;flex-shrink:0!important;flex-direction:column!important;overflow:hidden!important;background:var(--bg-secondary);border-right:1px solid var(--border)}
/* View panels */
.ws-view-container{flex:1 1 0%!important;display:flex!important;flex-direction:column!important;overflow:hidden!important;min-height:0}
.ws-view-panel{display:none!important}
.ws-view-panel.active{display:flex!important;flex:1 1 0%!important;overflow:hidden!important;min-height:0}
/* Bottom */
.ws-bottom-panel{height:200px!important;flex-shrink:0!important;display:flex!important;flex-direction:column!important;overflow:hidden!important;border-top:1px solid var(--border);transition:height .15s ease}
.ws-bottom-panel.ws-collapsed{height:28px!important}
.ws-bottom-panel.ws-collapsed .ws-pane-content{display:none!important}
/* Pane helpers */
.ws-pane-content{flex:1 1 0%!important;overflow:hidden!important;display:flex!important;flex-direction:column!important;min-height:0}
.ws-tab-content{display:none!important}
.ws-tab-content.active{display:flex!important;flex:1 1 0%!important;flex-direction:column!important;overflow:hidden!important;min-height:0}
/* Timeline */
.ws-tl-item{display:flex;gap:.8rem;padding:.5rem 0;border-left:2px solid var(--border);margin-left:.5rem;padding-left:1rem;position:relative}
.ws-tl-item::before{content:'';position:absolute;left:-.45rem;top:.7rem;width:.7rem;height:.7rem;border-radius:50%;background:var(--border);flex-shrink:0}
.ws-tl-item.commit::before{background:#3b82f6}
.ws-tl-item.mission::before{background:#7c3aed}
.ws-tl-item.deploy::before{background:#22c55e}
.ws-tl-item.error::before{background:#ef4444}
.ws-tl-meta{min-width:0;flex:1}
.ws-tl-title{font-size:.78rem;font-weight:600;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ws-tl-desc{font-size:.72rem;color:var(--text-secondary);margin-top:.15rem;line-height:1.4}
.ws-tl-time{font-size:.68rem;color:var(--text-secondary);white-space:nowrap;flex-shrink:0;margin-top:.1rem}
.ws-tl-badge{display:inline-block;padding:.1rem .4rem;border-radius:.25rem;font-size:.65rem;font-weight:600;text-transform:uppercase;letter-spacing:.04em;margin-right:.3rem}
.ws-tl-badge.commit{background:rgba(59,130,246,.15);color:#3b82f6}
.ws-tl-badge.mission{background:rgba(124,58,237,.15);color:#7c3aed}
.ws-tl-badge.deploy{background:rgba(34,197,94,.15);color:#22c55e}
.ws-tl-badge.error{background:rgba(239,68,68,.15);color:#ef4444}
/* Search results */
.ws-search-file{font-size:.73rem;font-weight:600;color:var(--text-primary);padding:.4rem .2rem .1rem;border-top:1px solid var(--border);margin-top:.3rem;display:flex;align-items:center;gap:.35rem;cursor:pointer}
.ws-search-file:first-child{border-top:none;margin-top:0}
.ws-search-match{font-size:.72rem;font-family:monospace;padding:.15rem .6rem;color:var(--text-secondary);cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;border-radius:2px}
.ws-search-match:hover{background:var(--bg-hover);color:var(--text-primary)}
.ws-search-match em{color:#fbbf24;font-style:normal;font-weight:700}
.ws-search-lnum{color:var(--text-muted);min-width:3ch;display:inline-block;text-align:right;margin-right:.4rem}
/* File icons colors */
.ws-icon-js{color:#f7df1e}.ws-icon-ts{color:#3178c6}.ws-icon-py{color:#3572a5}
.ws-icon-html{color:#e34c26}.ws-icon-css{color:#563d7c}.ws-icon-json{color:#cbcb41}
.ws-icon-md{color:#083fa1}.ws-icon-sh{color:#22c55e}.ws-icon-sql{color:#e38c00}
.ws-icon-rust{color:#dea584}.ws-icon-go{color:#00add8}.ws-icon-yaml{color:#cb171e}
.ws-icon-default{color:var(--text-secondary)}
</style>
{% endblock %}

{% block topbar_actions %}
<a href="/projects/{{ project.id }}" class="btn btn-sm btn-ghost">
  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
  {{ project.name }}
</a>
<span class="badge badge-purple" style="font-size:.68rem;">Workspace</span>
{% endblock %}

{% block content %}
<div class="ws-layout" id="wsLayout" data-view="code">

  <!-- ‚îÄ‚îÄ Activity Bar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="ws-activity-bar">
    <button class="ws-activity-btn active" data-view="code" onclick="wsSetView('code')" title="Code">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>
    </button>
    <button class="ws-activity-btn" data-view="git" onclick="wsSetView('git')" title="Git">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="18" cy="18" r="3"/><circle cx="6" cy="6" r="3"/><path d="M13 6h3a2 2 0 0 1 2 2v7M6 9v12"/></svg>
    </button>
    <button class="ws-activity-btn" data-view="docker" onclick="wsSetView('docker')" title="Docker">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>
    </button>
    <button class="ws-activity-btn" data-view="preview" onclick="wsSetView('preview')" title="Preview">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
    </button>
    <button class="ws-activity-btn" data-view="agents" onclick="wsSetView('agents')" title="Agents">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>
    </button>
    <button class="ws-activity-btn" data-view="backlog" onclick="wsSetView('backlog')" title="Backlog">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 0 2-2h2a2 2 0 0 0 2 2m-3 7h3m-3 4h3m-7-4h.01M9 16h.01"/></svg>
    </button>
    <button class="ws-activity-btn" data-view="db" onclick="wsSetView('db')" title="Database">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>
    </button>
    <button class="ws-activity-btn" data-view="secrets" onclick="wsSetView('secrets')" title="Secrets / .env">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
    </button>
    <button class="ws-activity-btn" data-view="timeline" onclick="wsSetView('timeline')" title="Timeline">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
    </button>
    <button class="ws-activity-btn" data-view="search" onclick="wsSetView('search')" title="Recherche dans les fichiers">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
    </button>
    <button class="ws-activity-btn" data-view="live" onclick="wsSetView('live')" title="Live Activity Feed" id="wsLiveBtn">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
    </button>
  </div>

  <!-- ‚îÄ‚îÄ File Tree (only in code view via CSS) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="ws-filetree" id="wsFiletree">
    <div class="ws-filetree-header">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
      <span>{{ project.name }}</span>
    </div>
    <div class="ws-filetree-body" id="wsTreeBody">
      <div class="ws-tree-item" style="color:var(--text-secondary);font-size:.72rem;cursor:default;padding:.75rem;">Chargement‚Ä¶</div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ Center column ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="ws-center">

    <!-- Info bar -->
    <div class="ws-infobar">
      <div class="ws-infobar-left">
        <span class="ws-infobar-name">{{ project.name }}</span>
        {% if project.path %}
        <span class="ws-badge ws-badge-path">
          <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>
          {{ project.path }}
        </span>
        {% endif %}
        <span class="ws-badge ws-badge-git" id="wsGitBranch" style="display:none">
          <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="18" r="3"/><circle cx="6" cy="6" r="3"/><path d="M13 6h3a2 2 0 0 1 2 2v7M6 9v12"/></svg>
          <span id="wsGitBranchName"></span>
        </span>
      </div>
      <div class="ws-infobar-right">
        <span class="ws-badge ws-badge-status ws-badge-idle" id="wsStatus">Pr√™t</span>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ Live metrics bar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="ws-metrics-bar" id="wsMetricsBar">
      <span class="ws-live-badge" id="wsLiveBadge">
        <span class="ws-live-dot"></span> LIVE
      </span>
      <span class="ws-metric-sep">|</span>
      <span class="ws-metric-item"><strong id="wsMetricAgents">‚Äì</strong> agents</span>
      <span class="ws-metric-sep">¬∑</span>
      <span class="ws-metric-item"><strong id="wsMetricCalls">‚Äì</strong> calls/h</span>
      <span class="ws-metric-sep">¬∑</span>
      <span class="ws-metric-item"><strong id="wsMetricFiles">‚Äì</strong> fichiers</span>
      <span class="ws-metric-sep">¬∑</span>
      <span class="ws-metric-item"><strong id="wsMetricMissions">‚Äì</strong> missions</span>
      <span class="ws-metric-sep" id="wsMetricCommitSep" style="display:none">¬∑</span>
      <span class="ws-metric-item" id="wsMetricCommit" style="display:none">
        üîÄ <strong id="wsMetricCommitHash"></strong> <span id="wsMetricCommitMsg" style="max-width:200px;overflow:hidden;text-overflow:ellipsis;display:inline-block;vertical-align:bottom"></span>
      </span>
    </div>

    <!-- ‚îÄ‚îÄ View Container ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="ws-view-container">

      <!-- ‚îÄ‚îÄ VIEW: Code ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div class="ws-view-panel active" id="ws-view-code">
        <div class="ws-code-editor" id="wsFilesViewer">
          <div class="ws-file-empty">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>
            <span>S√©lectionnez un fichier dans l'arbre</span>
          </div>
        </div>
        <div class="ws-code-side" id="wsCodeSide">
          <div class="ws-pane-tabs" id="wsCodeSideTabs">
            <button class="ws-tab active" onclick="wsCodeSideTab(this,'toolcalls')" data-tab="toolcalls">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
              Tool Calls
            </button>
            <button class="ws-tab" onclick="wsCodeSideTab(this,'progress')" data-tab="progress">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 0 2-2h2a2 2 0 0 0 2 2"/></svg>
              Progress
            </button>
            <button class="ws-pane-collapse" onclick="wsToggleCodeSide()" title="R√©duire">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
            </button>
          </div>
          <div class="ws-pane-content">
            <div class="ws-tab-content active" id="ws-code-toolcalls">
              <div class="ws-toolcalls" id="wsToolcallsBody">
                <div class="ws-empty-state"><span>Chargement‚Ä¶</span></div>
              </div>
            </div>
            <div class="ws-tab-content" id="ws-code-progress">
              <div class="ws-empty-state"><span>Chargement PROGRESS.md‚Ä¶</span></div>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ VIEW: Git ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div class="ws-view-panel" id="ws-view-git">
        <div class="ws-git-left">
          <div class="ws-pane-tabs">
            <span class="ws-tab" style="cursor:default;color:var(--text-secondary);font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em">Modifications</span>
          </div>
          <div class="ws-pane-content">
            <div class="ws-git" id="wsGitBody" style="overflow-y:auto">
              <div class="ws-empty-state"><span>Chargement‚Ä¶</span></div>
            </div>
          </div>
        </div>
        <div class="ws-git-main">
          <div class="ws-pane-tabs" id="wsGitMainTabs">
            <button class="ws-tab active" onclick="wsGitMainTab(this,'log')" data-tab="log">
              Historique
            </button>
            <button class="ws-tab" onclick="wsGitMainTab(this,'diff')" data-tab="diff">
              Diff
            </button>
          </div>
          <div class="ws-pane-content">
            <div class="ws-tab-content active" id="ws-git-log">
              <div class="ws-git-log-area" id="wsGitLogArea">
                <div class="ws-empty-state"><span>Chargement‚Ä¶</span></div>
              </div>
            </div>
            <div class="ws-tab-content" id="ws-git-diff">
              <div class="ws-git-diff-area" id="wsGitDiffArea">S√©lectionnez un fichier modifi√© pour voir le diff</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ VIEW: Docker ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div class="ws-view-panel" id="ws-view-docker" style="flex-direction:column">
        <div class="ws-pane-tabs" id="wsDockerTabs">
          <button class="ws-tab active" onclick="wsDockerTab(this,'containers')">Containers</button>
          <button class="ws-tab" onclick="wsDockerTab(this,'portainer')">
            <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>
            Portainer
          </button>
        </div>
        <div class="ws-pane-content">
          <div class="ws-tab-content active" id="ws-docker-containers">
            <div class="ws-docker" id="wsDockerBody">
              <div class="ws-empty-state">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>
                <span>Chargement‚Ä¶</span>
              </div>
            </div>
          </div>
          <div class="ws-tab-content" id="ws-docker-portainer">
            <div class="ws-tool-launcher">
              <div class="ws-tool-logo">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>
              </div>
              <div class="ws-tool-info">
                <h3>Portainer CE</h3>
                <p>Gestion compl√®te des containers Docker ‚Äî images, volumes, r√©seaux, logs.</p>
                <div class="ws-tool-stats" id="wsPortainerStats">
                  <span class="ws-badge">Chargement‚Ä¶</span>
                </div>
              </div>
              <div class="ws-tool-actions">
                <a href="https://sf.macaron-software.com/portainer/" target="_blank" class="ws-btn-launch">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                  Ouvrir Portainer
                </a>
                <span class="ws-tool-hint">S'ouvre dans un nouvel onglet</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ VIEW: Preview ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div class="ws-view-panel" id="ws-view-preview">
        <div class="ws-preview" id="wsPreviewPanel">
          <div class="ws-preview-bar">
            <input class="ws-preview-url" id="wsPreviewUrl" type="text" value="{{ preview_url or '' }}" placeholder="http://localhost:3000">
            <button class="ws-preview-btn" onclick="wsPreviewLoad()">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
              Charger
            </button>
            <button class="ws-preview-btn ws-preview-btn-icon" onclick="wsPreviewToggleMobile()" id="wsPreviewMobileBtn" title="Mobile">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg>
            </button>
            <button class="ws-preview-btn ws-preview-btn-icon" onclick="window.open(document.getElementById('wsPreviewUrl').value,'_blank')" title="Ouvrir">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
            </button>
          </div>
          <div class="ws-preview-empty" id="wsPreviewEmpty">
            <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
            <span>Aucun port d√©tect√©</span>
            <span class="ws-empty-hint">Saisissez une URL ou lancez un serveur dans Output</span>
          </div>
          <iframe class="ws-preview-frame" id="wsPreviewFrame"
            {% if preview_url %}src="{{ preview_url }}"{% endif %}
            style="{{ '' if preview_url else 'display:none' }}"
            sandbox="allow-scripts allow-forms allow-popups allow-same-origin"></iframe>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ VIEW: Agents ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div class="ws-view-panel" id="ws-view-agents">
        <div class="ws-agents-left">
          <div class="ws-pane-tabs">
            <span class="ws-tab" style="cursor:default;color:var(--text-secondary);font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em">Agents actifs</span>
            <button class="ws-term-run" style="margin-left:auto;padding:.2rem .55rem;font-size:.7rem;display:flex;align-items:center;gap:.3rem" onclick="wsShowLaunchMission()">
              <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="5 3 19 12 5 21 5 3"/></svg> Mission
            </button>
          </div>
          <div class="ws-pane-content" style="flex-direction:column">
            <!-- Launch mission panel (hidden by default) -->
            <div id="wsLaunchMissionPanel" style="display:none;flex-direction:column;gap:.5rem;padding:.75rem;border-bottom:1px solid var(--border);background:var(--bg-secondary)">
              <div style="font-size:.75rem;font-weight:600;color:var(--text-primary)">‚ö° Lancer une mission</div>
              <select id="wsLaunchWorkflow" style="width:100%;padding:.3rem .5rem;font-size:.75rem;background:var(--bg-primary);color:var(--text-primary);border:1px solid var(--border);border-radius:4px">
                <option value="">Choisir un workflow‚Ä¶</option>
                <option value="feature-sprint">Feature Sprint (TDD)</option>
                <option value="feature-request">Feature Request</option>
                <option value="ideation-to-prod">Ideation ‚Üí Prod</option>
                <option value="cicd-pipeline">CI/CD Pipeline</option>
                <option value="documentation-pipeline">Documentation</option>
                <option value="quality-improvement">Am√©lioration Qualit√©</option>
                <option value="tech-debt-reduction">R√©duction Dette Technique</option>
              </select>
              <textarea id="wsLaunchBrief" rows="2" placeholder="D√©crivez la t√¢che √† r√©aliser‚Ä¶" style="width:100%;padding:.3rem .5rem;font-size:.75rem;font-family:inherit;background:var(--bg-primary);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;resize:vertical;box-sizing:border-box"></textarea>
              <div style="display:flex;gap:.4rem">
                <button class="ws-term-run" style="flex:1;font-size:.73rem;padding:.3rem" onclick="wsLaunchMission()">‚ö° Lancer</button>
                <button class="ws-secret-btn" style="font-size:.73rem;padding:.3rem .55rem" onclick="document.getElementById('wsLaunchMissionPanel').style.display='none'">‚úï</button>
              </div>
              <div id="wsLaunchMissionStatus" style="font-size:.72rem;color:var(--text-secondary)"></div>
            </div>
            <div class="ws-agents" id="wsAgentsBody" style="flex:1;overflow-y:auto">
              <div class="ws-empty-state"><span>Chargement‚Ä¶</span></div>
            </div>
          </div>
        </div>
        <div class="ws-agents-main">
          <div class="ws-pane-tabs">
            <span class="ws-tab" style="cursor:default;color:var(--text-secondary);font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em">Tool Calls r√©cents</span>
          </div>
          <div class="ws-pane-content">
            <div class="ws-toolcalls" id="wsAgentsToolcalls">
              <div class="ws-empty-state"><span>Chargement‚Ä¶</span></div>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ VIEW: Backlog ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div class="ws-view-panel" id="ws-view-backlog">
        <div class="ws-backlog" id="wsBacklogBody">
          <div class="ws-empty-state">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 0 2-2h2a2 2 0 0 0 2 2"/></svg>
            <span>Chargement‚Ä¶</span>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ VIEW: Database ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div class="ws-view-panel" id="ws-view-db">
        <div class="ws-db-left">
          <div class="ws-pane-tabs">
            <span class="ws-tab" style="cursor:default;color:var(--text-secondary);font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em">Base de donn√©es</span>
          </div>
          <div class="ws-pane-content">
            <div class="ws-filetree-body" id="wsDbFiles">
              <div class="ws-tree-item" style="color:var(--text-secondary);font-size:.72rem;cursor:default;padding:.75rem;">Scan‚Ä¶</div>
            </div>
          </div>
        </div>
        <div class="ws-db-main">
          <div class="ws-pane-tabs" id="wsDbMainTabs">
            <button class="ws-tab" onclick="wsDbMainTab(this,'sql')">SQLite / SQL</button>
            <button class="ws-tab active" onclick="wsDbMainTab(this,'dbgate')">
              <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>
              DbGate
            </button>
            <span style="flex:1"></span>
            <span style="font-size:.68rem;color:var(--text-secondary);padding:0 .5rem" id="wsDbStatus"></span>
          </div>
          <div class="ws-pane-content">
            <div class="ws-tab-content" id="ws-db-sql">
              <span style="font-size:.76rem;font-weight:600;color:var(--text-primary);padding:.3rem .5rem;display:block" id="wsDbTableLabel">SQL</span>
              <div class="ws-db-editor">
                <textarea class="ws-db-query" id="wsDbQuery" rows="3" placeholder="SELECT * FROM table LIMIT 100;"></textarea>
                <div style="display:flex;gap:.4rem;margin-top:.4rem;align-items:center">
                  <button class="ws-term-run" style="padding:.25rem .55rem;font-size:.72rem" onclick="wsDbRun()">
                    <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                    Run
                  </button>
                  <span style="font-size:.7rem;color:var(--text-secondary)">Ctrl+Enter</span>
                </div>
              </div>
              <div class="ws-db-results" id="wsDbResults">
                <div class="ws-empty-state">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>
                  <span>S√©lectionnez une table ou √©crivez une requ√™te</span>
                </div>
              </div>
            </div>
            <div class="ws-tab-content active" id="ws-db-dbgate" style="flex-direction:column">
              <div class="ws-dbgate-header">
                <div style="flex:1">
                  <strong style="font-size:.8rem">DbGate</strong>
                  <span style="font-size:.72rem;color:var(--text-secondary);margin-left:.4rem">multi-DB (Postgres, MySQL, SQLite, MongoDB‚Ä¶)</span>
                </div>
                <a href="https://sf.macaron-software.com/dbgate/" target="_blank" class="ws-preview-btn" style="text-decoration:none">
                  <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                  Ouvrir en plein √©cran
                </a>
              </div>
              <div class="ws-dbgate-connections" id="wsDbGateConnections">
                <div style="padding:.5rem .75rem;font-size:.72rem;color:var(--text-secondary)">Scan des connexions‚Ä¶</div>
              </div>
              <iframe src="about:blank" id="wsDbGateFrame" style="flex:1;border:none;min-height:0" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals allow-downloads"></iframe>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ VIEW: Secrets / Vault ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div class="ws-view-panel" id="ws-view-secrets">
        <div class="ws-secrets-left">
          <div class="ws-pane-tabs">
            <span class="ws-tab" style="cursor:default;color:var(--text-secondary);font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em">Fichiers .env</span>
          </div>
          <div class="ws-pane-content">
            <div class="ws-filetree-body" id="wsSecretsFiles">
              <div class="ws-tree-item" style="color:var(--text-secondary);font-size:.72rem;cursor:default;padding:.75rem;">Scan‚Ä¶</div>
            </div>
          </div>
          <div style="padding:.5rem;border-top:1px solid var(--border)">
            <button class="ws-term-run" style="width:100%;justify-content:center;padding:.3rem;font-size:.72rem" onclick="wsSecretsNewFile()">
              <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Cr√©er .env
            </button>
          </div>
        </div>
        <div class="ws-secrets-main">
          <div class="ws-pane-tabs" id="wsSecretsToolbar">
            <span style="font-size:.76rem;font-weight:600;color:var(--text-primary)" id="wsSecretsFileName">‚Äî</span>
            <span style="flex:1"></span>
            <button class="ws-preview-btn" onclick="wsSecretsToggleAll()" id="wsSecretsShowAllBtn" style="font-size:.7rem;padding:.2rem .4rem;margin-right:.3rem">
              <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
              Afficher
            </button>
            <button class="ws-preview-btn" onclick="wsSecretsSave()" id="wsSecretsSaveBtn" style="font-size:.7rem;padding:.2rem .4rem" disabled>
              <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
              Sauvegarder
            </button>
          </div>
          <div class="ws-pane-content" style="overflow-y:auto">
            <div id="wsSecretsList" style="padding:.5rem">
              <div class="ws-empty-state" id="wsSecretsEmpty">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                <span>S√©lectionnez un fichier .env</span>
                <span class="ws-empty-hint">G√©rez vos variables d'environnement et secrets</span>
              </div>
            </div>
          </div>
          <div style="padding:.5rem;border-top:1px solid var(--border);display:flex;gap:.4rem" id="wsSecretsAddRow" style="display:none">
            <input type="text" id="wsSecretsNewKey" placeholder="NOM_VARIABLE" style="flex:1;min-width:0;padding:.3rem .5rem;font-size:.75rem;font-family:monospace;background:var(--bg-secondary);border:1px solid var(--border);border-radius:.25rem;color:var(--text-primary)">
            <input type="text" id="wsSecretsNewVal" placeholder="valeur" style="flex:2;min-width:0;padding:.3rem .5rem;font-size:.75rem;font-family:monospace;background:var(--bg-secondary);border:1px solid var(--border);border-radius:.25rem;color:var(--text-primary)">
            <button class="ws-term-run" style="padding:.3rem .55rem;font-size:.72rem;white-space:nowrap" onclick="wsSecretsAdd()">Ajouter</button>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ Timeline view ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div class="ws-view-panel" id="ws-view-timeline" style="flex-direction:column;overflow-y:auto;padding:1rem 1.5rem;gap:0">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;flex-shrink:0">
          <div style="font-size:.82rem;font-weight:700;color:var(--text-primary)">‚è± Timeline</div>
          <div style="display:flex;gap:.4rem">
            <select id="wsTimelineFilter" onchange="wsLoadTimeline()" style="background:var(--bg-secondary);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:2px 6px;font-size:.73rem">
              <option value="all">Tout</option>
              <option value="commit">Git commits</option>
              <option value="mission">Missions</option>
              <option value="deploy">D√©ploiements</option>
            </select>
            <button class="ws-term-run" style="padding:.2rem .6rem;font-size:.72rem" onclick="wsLoadTimeline()">‚Üª</button>
          </div>
        </div>
        <div id="wsTimelineBody" style="display:flex;flex-direction:column;gap:0;flex:1"></div>
      </div>

      <!-- ‚îÄ‚îÄ Search view ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div class="ws-view-panel" id="ws-view-search" style="flex-direction:column;padding:1rem 1.2rem;gap:.6rem;overflow-y:auto">
        <div style="font-size:.82rem;font-weight:700;color:var(--text-primary);flex-shrink:0">üîç Recherche dans les fichiers</div>
        <div style="display:flex;gap:.4rem;flex-shrink:0">
          <input id="wsSearchQuery" type="text" placeholder="Texte √† chercher‚Ä¶" style="flex:1;padding:.35rem .6rem;font-size:.78rem;font-family:monospace;background:var(--bg-secondary);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);min-width:0" onkeydown="if(event.key==='Enter')wsRunSearch()">
          <input id="wsSearchGlob" type="text" placeholder="*.py" style="width:70px;padding:.35rem .5rem;font-size:.75rem;font-family:monospace;background:var(--bg-secondary);border:1px solid var(--border);border-radius:4px;color:var(--text-secondary)">
          <button class="ws-term-run" style="padding:.3rem .65rem;font-size:.72rem" onclick="wsRunSearch()">‚Üµ</button>
        </div>
        <div style="display:flex;gap:.6rem;flex-shrink:0">
          <label style="font-size:.72rem;color:var(--text-secondary);display:flex;align-items:center;gap:.3rem;cursor:pointer"><input type="checkbox" id="wsSearchCase"> Casse</label>
          <label style="font-size:.72rem;color:var(--text-secondary);display:flex;align-items:center;gap:.3rem;cursor:pointer"><input type="checkbox" id="wsSearchRegex"> Regex</label>
          <span id="wsSearchCount" style="font-size:.71rem;color:var(--text-secondary);margin-left:auto"></span>
        </div>
        <div id="wsSearchResults" style="flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:0"></div>
      </div>

      <!-- ‚îÄ‚îÄ VIEW: Live Activity Feed ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div class="ws-view-panel" id="ws-view-live" style="flex-direction:column">
        <div style="display:flex;align-items:center;justify-content:space-between;padding:.4rem .75rem;border-bottom:1px solid var(--border);flex-shrink:0">
          <div style="font-size:.78rem;font-weight:700;color:var(--text-primary);display:flex;align-items:center;gap:.4rem">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
            Live Activity
          </div>
          <div class="ws-live-filters" style="padding:0;border:none">
            <button class="ws-live-filter-btn active" data-lf="all" onclick="wsLiveFilter(this,'all')">All</button>
            <button class="ws-live-filter-btn" data-lf="tool_call" onclick="wsLiveFilter(this,'tool_call')">‚ö° Tools</button>
            <button class="ws-live-filter-btn" data-lf="file_write" onclick="wsLiveFilter(this,'file_write')">üìÅ Files</button>
            <button class="ws-live-filter-btn" data-lf="message" onclick="wsLiveFilter(this,'message')">üí¨ Msgs</button>
            <button class="ws-live-filter-btn" data-lf="git_commit" onclick="wsLiveFilter(this,'git_commit')">üîÄ Git</button>
            <button class="ws-live-filter-btn" data-lf="agent_status" onclick="wsLiveFilter(this,'agent_status')">üë§ Agents</button>
          </div>
          <button class="ws-term-run" style="padding:.15rem .5rem;font-size:.7rem" onclick="wsLiveClear()">Clear</button>
        </div>
        <div class="ws-live-feed" id="wsLiveFeed">
          <div class="ws-empty-state"><span>En attente d'√©v√©nements‚Ä¶</span><span class="ws-empty-hint">Les tool calls, fichiers, commits et messages apparaissent ici en temps r√©el</span></div>
        </div>
      </div>

    </div><!-- end ws-view-container -->

    <!-- ‚îÄ‚îÄ Bottom Panel: Shell + Output ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="ws-bottom-panel" id="wsBottomPanel">
      <div class="ws-pane-tabs">
        <button class="ws-tab active" onclick="wsBottomTab(this,'shell')" data-btab="shell">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>
          Shell
        </button>
        <button class="ws-tab" onclick="wsBottomTab(this,'output')" data-btab="output">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
          Output
        </button>
        <span id="wsPortBadge" style="display:none;margin-left:.3rem"></span>
        <button class="ws-pane-collapse" onclick="wsToggleBottomPanel()" id="wsBottomCollapseBtn">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="wsBottomCollapseIcon"><polyline points="18 15 12 9 6 15"/></svg>
        </button>
      </div>
      <div class="ws-pane-content" id="wsBottomContent">
        <!-- Shell tab -->
        <div class="ws-tab-content active" id="ws-bottom-shell">
          <div class="ws-terminal">
            <div class="ws-term-history" id="wsTermHistory"></div>
            <div class="ws-term-input-row">
              <span class="ws-term-prompt">$</span>
              <input class="ws-term-input" id="wsTermInput" type="text" placeholder="ls -la  /  git status  /  npm run dev ‚Ä¶" autocomplete="off" spellcheck="false">
              <button class="ws-term-run" id="wsTermRun" onclick="wsRunCmd()">
                <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                Run
              </button>
            </div>
          </div>
        </div>
        <!-- Output tab -->
        <div class="ws-tab-content" id="ws-bottom-output">
          <div class="ws-terminal" style="overflow:hidden">
            <div class="ws-output-panel" id="wsOutputPanel">
              <div class="ws-term-hint">Lancez un serveur ou une commande avec les boutons ci-dessous</div>
            </div>
            <div class="ws-term-input-row" style="gap:.4rem;flex-wrap:wrap">
              <span style="color:#484f58;font-size:.72rem;font-weight:600">Quick:</span>
              <button class="ws-output-quickbtn" onclick="wsRunOutput('npm run dev')">npm dev</button>
              <button class="ws-output-quickbtn" onclick="wsRunOutput('npm install')">npm install</button>
              <button class="ws-output-quickbtn" onclick="wsRunOutput('python main.py 2>&1 || python app.py 2>&1')">python run</button>
              <button class="ws-output-quickbtn" onclick="wsRunOutput('docker compose up')">docker up</button>
              <button class="ws-output-quickbtn" onclick="wsRunOutput('docker compose down')">docker down</button>
              <button class="ws-output-quickbtn" id="wsOutputStop" onclick="wsStopOutput()" style="display:none;border-color:#f85149;color:#f85149">
                <svg width="9" height="9" viewBox="0 0 24 24" fill="currentColor"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
                Stop
              </button>
            </div>
          </div>
        </div>
      </div>
    </div><!-- end ws-bottom-panel -->

  </div><!-- end ws-center -->
</div><!-- end ws-layout -->

<script>
var _wsProjectId = {{ project.id | tojson }};
var _wsPreviewMobile = false;
var _wsOutputEs = null;
var _wsDetectedPort = null;
var _wsDbFiles = [];
var _wsDbCurrentFile = null;
var _wsCurrentFilePath = null;
var _wsLiveEs = null;
var _wsLiveFilter = 'all';
var _wsLiveBuf = [];
var _wsNotifCounts = {};
var _wsCurrentView = 'code';

function wsFetch(url, opts) {
  opts = opts || {};
  opts.credentials = 'same-origin';
  return fetch(url, opts);
}

// ‚îÄ‚îÄ View switching ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function wsSetView(name) {
  _wsCurrentView = name;
  document.getElementById('wsLayout').setAttribute('data-view', name);
  document.querySelectorAll('.ws-activity-btn').forEach(function(b) {
    b.classList.toggle('active', b.getAttribute('data-view') === name);
  });
  document.querySelectorAll('.ws-view-panel').forEach(function(p) { p.classList.remove('active'); });
  var panel = document.getElementById('ws-view-' + name);
  if (panel) panel.classList.add('active');
  localStorage.setItem('ws_view_' + _wsProjectId, name);
  // Clear notification badge for this view
  wsNotifClear(name);
  if (name === 'code') { wsLoadToolcalls(); }
  if (name === 'git') { wsLoadGit(); }
  if (name === 'docker') { wsLoadDocker(); wsLoadPortainerStats(); }
  if (name === 'agents') { wsLoadAgents(); wsLoadAgentsToolcalls(); }
  if (name === 'backlog') { wsLoadBacklog(); }
  if (name === 'db') { wsLoadDatabase(); wsDbGateAutoLogin(); }
  if (name === 'secrets') { wsLoadSecrets(); }
  if (name === 'timeline') { wsLoadTimeline(); }
  if (name === 'search') { setTimeout(function(){ var q=document.getElementById('wsSearchQuery'); if(q)q.focus(); },50); }
  if (name === 'live') { wsLiveRenderAll(); }
}

function wsNotifAdd(view) {
  if (view === _wsCurrentView) return;
  _wsNotifCounts[view] = (_wsNotifCounts[view] || 0) + 1;
  var btn = document.querySelector('.ws-activity-btn[data-view="'+view+'"]');
  if (!btn) return;
  var badge = btn.querySelector('.ws-notif-badge');
  if (!badge) {
    badge = document.createElement('span');
    badge.className = 'ws-notif-badge';
    btn.appendChild(badge);
  }
  var n = _wsNotifCounts[view];
  badge.textContent = n > 9 ? '9+' : n;
}

function wsNotifClear(view) {
  _wsNotifCounts[view] = 0;
  var btn = document.querySelector('.ws-activity-btn[data-view="'+view+'"]');
  if (btn) { var b = btn.querySelector('.ws-notif-badge'); if (b) b.remove(); }
}

function wsBottomTab(btn, name) {
  document.querySelectorAll('.ws-pane-tabs [data-btab]').forEach(function(b) { b.classList.remove('active'); });
  document.querySelectorAll('#wsBottomContent .ws-tab-content').forEach(function(c) { c.classList.remove('active'); });
  btn.classList.add('active');
  var el = document.getElementById('ws-bottom-' + name);
  if (el) el.classList.add('active');
}

function wsCodeSideTab(btn, name) {
  document.querySelectorAll('#wsCodeSideTabs .ws-tab[data-tab]').forEach(function(b) { b.classList.remove('active'); });
  document.querySelectorAll('#ws-view-code .ws-code-side .ws-tab-content').forEach(function(c) { c.classList.remove('active'); });
  btn.classList.add('active');
  var el = document.getElementById('ws-code-' + name);
  if (el) el.classList.add('active');
  if (name === 'progress') wsLoadProgress();
}

function wsDockerTab(btn, name) {
  document.querySelectorAll('#wsDockerTabs .ws-tab').forEach(function(b){ b.classList.remove('active'); });
  document.querySelectorAll('#ws-view-docker .ws-tab-content').forEach(function(c){ c.classList.remove('active'); });
  btn.classList.add('active');
  var el = document.getElementById('ws-docker-' + name);
  if (el) el.classList.add('active');
}

function wsDbMainTab(btn, name) {
  document.querySelectorAll('#wsDbMainTabs .ws-tab').forEach(function(b){ b.classList.remove('active'); });
  document.querySelectorAll('#ws-view-db .ws-db-main .ws-tab-content').forEach(function(c){ c.classList.remove('active'); });
  btn.classList.add('active');
  var el = document.getElementById('ws-db-' + name);
  if (el) el.classList.add('active');
  if (name === 'dbgate') wsLoadDbGateConnections();
}

function wsGitMainTab(btn, name) {
  document.querySelectorAll('#wsGitMainTabs .ws-tab').forEach(function(b) { b.classList.remove('active'); });
  document.querySelectorAll('.ws-git-main .ws-tab-content').forEach(function(c) { c.classList.remove('active'); });
  btn.classList.add('active');
  var el = document.getElementById('ws-git-' + name);
  if (el) el.classList.add('active');
}

function wsToggleCodeSide() {
  var side = document.getElementById('wsCodeSide');
  if (!side) return;
  side.style.display = side.style.display === 'none' ? '' : 'none';
}

function wsToggleBottomPanel() {
  var panel = document.getElementById('wsBottomPanel');
  var icon = document.getElementById('wsBottomCollapseIcon');
  var collapsed = panel.classList.toggle('ws-collapsed');
  if (icon) icon.setAttribute('points', collapsed ? '6 9 12 15 18 9' : '18 15 12 9 6 15');
  localStorage.setItem('ws_bottom_collapsed', collapsed ? '1' : '');
}

// ‚îÄ‚îÄ Terminal Shell ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function wsRunCmd() {
  var inp = document.getElementById('wsTermInput');
  var cmd = inp.value.trim();
  if (!cmd) return;
  inp.value = '';
  var h = document.getElementById('wsTermHistory');
  var entry = document.createElement('div'); entry.className = 'ws-term-entry';
  var outDiv = document.createElement('div'); outDiv.className = 'ws-term-output';
  entry.innerHTML = '<div class="ws-term-cmd"><span style="color:#3fb950">$</span> <span class="ws-term-args">' + wsEsc(cmd) + '</span></div>';
  entry.appendChild(outDiv);
  var hr = document.createElement('hr'); hr.className = 'ws-term-divider';
  entry.appendChild(hr);
  h.appendChild(entry);
  h.scrollTop = h.scrollHeight;
  document.getElementById('wsTermRun').disabled = true;
  wsSetStatus('En cours‚Ä¶', 'running');
  var es = new EventSource('/api/projects/' + encodeURIComponent(_wsProjectId) + '/workspace/run?cmd=' + encodeURIComponent(cmd));
  var out = '';
  es.onmessage = function(e) {
    if (e.data === '[DONE]') { es.close(); document.getElementById('wsTermRun').disabled = false; wsSetStatus('Pr√™t', 'idle'); return; }
    out += e.data + '\n'; outDiv.textContent = out; h.scrollTop = h.scrollHeight;
  };
  es.onerror = function() { es.close(); document.getElementById('wsTermRun').disabled = false; wsSetStatus('Pr√™t', 'idle'); outDiv.classList.add('error'); };
}
document.getElementById('wsTermInput').addEventListener('keydown', function(e) { if (e.key==='Enter') wsRunCmd(); });

// ‚îÄ‚îÄ Output Streaming ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function wsRunOutput(cmd) {
  wsStopOutput();
  _wsDetectedPort = null;
  document.getElementById('wsPortBadge').style.display = 'none';
  var panel = document.getElementById('wsOutputPanel');
  panel.innerHTML = '';
  var cmdLine = document.createElement('div');
  cmdLine.style.cssText = 'color:#484f58;font-size:.72rem;margin-bottom:.3rem';
  cmdLine.textContent = '$ ' + cmd;
  panel.appendChild(cmdLine);
  var outDiv = document.createElement('div');
  outDiv.style.whiteSpace = 'pre-wrap';
  outDiv.style.wordBreak = 'break-all';
  panel.appendChild(outDiv);
  document.getElementById('wsOutputStop').style.display = '';
  wsSetStatus('En cours‚Ä¶', 'running');
  // Switch to output tab
  var btn = document.querySelector('[data-btab="output"]');
  if (btn) wsBottomTab(btn, 'output');
  // Open bottom if collapsed
  var bp = document.getElementById('wsBottomPanel');
  if (bp.classList.contains('ws-collapsed')) wsToggleBottomPanel();
  _wsOutputEs = new EventSource('/api/projects/' + encodeURIComponent(_wsProjectId) + '/workspace/run?cmd=' + encodeURIComponent(cmd));
  var out = '';
  _wsOutputEs.onmessage = function(e) {
    if (e.data === '[DONE]') { wsStopOutput(); wsSetStatus('Pr√™t', 'idle'); return; }
    out += e.data + '\n';
    outDiv.textContent = out;
    panel.scrollTop = panel.scrollHeight;
    // Port detection
    if (!_wsDetectedPort) {
      var m = e.data.match(/localhost:(\d{4,5})/i) || e.data.match(/port\s+(\d{4,5})/i) || e.data.match(/:\s*(\d{4,5})\b/) || e.data.match(/on\s+http[^ ]*:(\d{4,5})/i);
      if (m) { _wsDetectedPort = m[1]; wsShowPortBadge(m[1]); }
    }
  };
  _wsOutputEs.onerror = function() { wsStopOutput(); wsSetStatus('Pr√™t', 'idle'); };
}

function wsStopOutput() {
  if (_wsOutputEs) { _wsOutputEs.close(); _wsOutputEs = null; }
  var btn = document.getElementById('wsOutputStop');
  if (btn) btn.style.display = 'none';
}

function wsShowPortBadge(port) {
  var badge = document.getElementById('wsPortBadge');
  if (!badge) return;
  badge.innerHTML = '<a href="#" class="ws-port-badge" onclick="wsOpenPreviewPort(' + port + ');return false">' +
    '<svg width="9" height="9" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/></svg>' +
    ':' + port + '</a>';
  badge.style.display = '';
}

function wsOpenPreviewPort(port) {
  var url = window.location.protocol + '//' + window.location.hostname + ':' + port;
  document.getElementById('wsPreviewUrl').value = url;
  wsSetView('preview');
  setTimeout(function() { wsPreviewLoad(url); }, 200);
}

// ‚îÄ‚îÄ File Tree ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function wsLoadFilesTree(path) {
  var tree = document.getElementById('wsTreeBody');
  if (!tree) return;
  wsFetch('/api/projects/' + encodeURIComponent(_wsProjectId) + '/workspace/files?path=' + encodeURIComponent(path))
    .then(function(r){ return r.json(); })
    .then(function(data) {
      var items = data.items || [];
      var parent = path.includes('/') ? path.substring(0, path.lastIndexOf('/')) : '.';
      var backBtn = path !== '.' ? '<div class="ws-tree-item" onclick="wsLoadFilesTree(\'' + wsEsc(parent) + '\')"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg> ..</div>' : '';
      if (!items.length) { tree.innerHTML = backBtn + '<div style="padding:.5rem .75rem;color:var(--text-secondary);font-size:.72rem;text-align:center;">Dossier vide</div>'; return; }
      var html = backBtn;
      items.filter(function(i){ return i.type==='dir'; }).forEach(function(i) {
        html += '<div class="ws-tree-item ws-tree-dir" onclick="wsLoadFilesTree(\'' + wsEsc(i.path) + '\')">' +
          '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>' + wsEsc(i.name) + '/</div>';
      });
      items.filter(function(i){ return i.type==='file'; }).forEach(function(i) {
        var sz = i.size > 1024 ? (i.size/1024).toFixed(1)+'KB' : i.size+'B';
        html += '<div class="ws-tree-item" onclick="wsOpenFile(\'' + wsEsc(i.path) + '\')">' +
          wsFileIcon(i.name) + wsEsc(i.name) + '<span class="ws-tree-size">' + sz + '</span></div>';
      });
      tree.innerHTML = html;
    });
}
function wsLoadLeftTree() { wsLoadFilesTree('.'); }

function wsOpenFile(path) {
  _wsCurrentFilePath = path;
  wsSetView('code');
  var viewer = document.getElementById('wsFilesViewer');
  if (!viewer) return;
  viewer.innerHTML = '<div class="ws-file-empty"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="ws-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg></div>';
  wsFetch('/api/projects/' + encodeURIComponent(_wsProjectId) + '/workspace/file?path=' + encodeURIComponent(path))
    .then(function(r){ return r.json(); })
    .then(function(data) {
      if (data.error) { viewer.innerHTML = '<div class="ws-file-empty"><span style="color:var(--red)">' + wsEsc(data.error) + '</span></div>'; return; }
      var ext = path.split('.').pop().toLowerCase();
      var lm = {js:'javascript',ts:'typescript',tsx:'typescript',jsx:'javascript',py:'python',html:'html',css:'css',json:'json',yml:'yaml',yaml:'yaml',sh:'shell',bash:'shell',md:'markdown',sql:'sql',rs:'rust',go:'go',java:'java',php:'php',rb:'ruby',cpp:'cpp',c:'c',h:'c',toml:'ini',xml:'xml',dockerfile:'dockerfile',env:'ini',gitignore:'ini'};
      var lang = lm[ext] || 'plaintext';
      var isBin = ['jpg','jpeg','png','gif','svg','ico','woff','woff2','ttf','eot','zip','tar','gz','pdf'].includes(ext);
      var saveIcon = '<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>';
      var saveBtn = !isBin ? '<button class="ws-preview-btn" id="wsFileSaveBtn" onclick="wsMonacoSave()" style="margin-left:.4rem;padding:.2rem .45rem;font-size:.7rem">' + saveIcon + ' Save</button>' : '';
      viewer.innerHTML = '<div class="ws-file-bar"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg> ' + wsEsc(path) + saveBtn + '<span class="ws-badge" style="margin-left:auto">' + lang + '</span></div>';
      var editorDiv = document.createElement('div');
      editorDiv.id = 'wsMonacoContainer';
      editorDiv.style.cssText = 'flex:1;min-height:0;overflow:auto';
      viewer.appendChild(editorDiv);
      if (window._wsMonacoEditor) { try { window._wsMonacoEditor.destroy(); } catch(e){} window._wsMonacoEditor = null; }
      if (!isBin && window.CodeMirrorEditor) {
        var CM = window.CodeMirrorEditor;
        var langExt = CM.langMap[lang] ? CM.langMap[lang]() : [];
        var extensions = [CM.basicSetup, CM.oneDark, CM.keymap.of([CM.indentWithTab])];
        if (Array.isArray(langExt)) { extensions = extensions.concat(langExt); } else { extensions.push(langExt); }
        var view = new CM.EditorView({
          state: CM.EditorState.create({ doc: data.content || '', extensions: extensions }),
          parent: editorDiv
        });
        // Ctrl+S / Cmd+S ‚Üí save
        editorDiv.addEventListener('keydown', function(e) {
          if ((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); wsMonacoSave(); }
        });
        window._wsMonacoEditor = { getValue: function(){ return view.state.doc.toString(); }, destroy: function(){ view.destroy(); } };
      } else if (isBin) {
        editorDiv.innerHTML = '<div style="padding:2rem;color:var(--text-muted);text-align:center">Binary file ‚Äî preview not available</div>';
      } else {
        // Fallback textarea (CodeMirror not available)
        var ta = document.createElement('textarea');
        ta.value = data.content || '';
        ta.style.cssText = 'width:100%;height:100%;background:#1e1e1e;color:#d4d4d4;border:none;padding:.75rem;font-family:"SF Mono","Fira Code","Monaco","Courier New",monospace;font-size:13px;resize:none;outline:none;box-sizing:border-box;tab-size:2';
        ta.spellcheck = false;
        editorDiv.style.cssText = 'flex:1;min-height:0;overflow:hidden;display:flex;flex-direction:column';
        editorDiv.appendChild(ta);
        window._wsMonacoEditor = { getValue: function(){ return ta.value; }, destroy: function(){} };
      }
    })
    .catch(function(e) { if (viewer) viewer.innerHTML = '<div class="ws-file-empty"><span style="color:var(--red)">Erreur: ' + wsEsc(String(e)) + '</span></div>'; });
}

function wsMonacoSave() {
  if (!window._wsMonacoEditor || !_wsCurrentFilePath) return;
  var content = window._wsMonacoEditor.getValue();
  var btn = document.getElementById('wsFileSaveBtn');
  if (btn) { btn.disabled = true; btn.textContent = '‚Ä¶'; }
  wsFetch('/api/projects/' + encodeURIComponent(_wsProjectId) + '/workspace/file/save', {
    method: 'POST', headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({path: _wsCurrentFilePath, content: content})
  }).then(function(r){ return r.json(); })
    .then(function(d) {
      if (btn) { btn.disabled = false; btn.innerHTML = '<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg> Save'; }
      wsSetStatus(d.ok ? 'Sauvegard√© ‚úì' : 'Erreur: '+(d.error||''), d.ok ? 'ok' : 'running');
      setTimeout(function(){ wsSetStatus('Pr√™t','idle'); }, 2000);
    }).catch(function(){ if (btn) { btn.disabled = false; } wsSetStatus('Erreur save','running'); });
}

// ‚îÄ‚îÄ Tool Calls ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function wsLoadToolcalls() {
  var body = document.getElementById('wsToolcallsBody');
  wsFetch('/api/projects/' + encodeURIComponent(_wsProjectId) + '/workspace/tool-calls')
    .then(function(r){ return r.json(); })
    .then(function(data) {
      var items = data.items || [];
      if (!items.length) { body.innerHTML = '<div class="ws-empty-state"><span>Aucun tool call</span><span class="ws-empty-hint">Lancez une mission pour voir les tool calls</span></div>'; return; }
      var html = '<table class="ws-table"><thead><tr><th>Outil</th><th>Param√®tres</th><th>Statut</th><th>Dur√©e</th></tr></thead><tbody>';
      items.forEach(function(tc) {
        var params = ''; try { var p=JSON.parse(tc.parameters_json||'{}'); params=JSON.stringify(p).substring(0,80); } catch(e){}
        html += '<tr class="ws-table-row"><td><span class="ws-tc-tool">' + wsEsc(tc.tool_name) + '</span></td><td class="ws-tc-params" title="' + wsEsc(params) + '">' + wsEsc(params) + '</td><td><span class="' + (tc.success?'ws-badge ws-badge-ok':'ws-badge ws-badge-err') + '">' + (tc.success?'OK':'Err') + '</span></td><td class="ws-tc-dur">' + (tc.duration_ms||0) + 'ms</td></tr>';
      });
      html += '</tbody></table>'; body.innerHTML = html;
    }).catch(function(){});
}

function wsLoadAgentsToolcalls() {
  var body = document.getElementById('wsAgentsToolcalls');
  if (!body) return;
  wsFetch('/api/projects/' + encodeURIComponent(_wsProjectId) + '/workspace/tool-calls')
    .then(function(r){ return r.json(); })
    .then(function(data) {
      var items = data.items || [];
      if (!items.length) { body.innerHTML = '<div class="ws-empty-state"><span>Aucun tool call</span></div>'; return; }
      var html = '<table class="ws-table"><thead><tr><th>Outil</th><th>Statut</th><th>Date</th></tr></thead><tbody>';
      items.slice(0,30).forEach(function(tc) {
        html += '<tr class="ws-table-row"><td><span class="ws-tc-tool">' + wsEsc(tc.tool_name) + '</span></td><td><span class="' + (tc.success?'ws-badge ws-badge-ok':'ws-badge ws-badge-err') + '">' + (tc.success?'OK':'Err') + '</span></td><td class="ws-tc-ts">' + wsEsc((tc.timestamp||'').substring(0,16)) + '</td></tr>';
      });
      html += '</tbody></table>'; body.innerHTML = html;
    }).catch(function(){});
}

// ‚îÄ‚îÄ Docker ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function wsLoadDocker() {
  var body = document.getElementById('wsDockerBody');
  wsFetch('/api/projects/' + encodeURIComponent(_wsProjectId) + '/workspace/docker')
    .then(function(r){ return r.json(); })
    .then(function(data) {
      var containers = data.containers || [], dockerFiles = data.docker_files || [];
      var html = '';
      if (containers.length) {
        html += containers.map(function(c) {
          var up = c.status && c.status.toLowerCase().startsWith('up');
          return '<div class="ws-docker-container"><div class="ws-docker-header"><div class="ws-docker-status ' + (up?'up':'down') + '"></div><span class="ws-docker-name">' + wsEsc(c.name) + '</span><span class="ws-docker-image">' + wsEsc(c.image||'') + '</span><span style="margin-left:auto;font-size:.7rem;color:var(--text-secondary)">' + wsEsc(c.status||'') + '</span>' + (c.ports?'<span class="ws-docker-port" onclick="wsDockPreview(\''+wsEsc(c.ports)+'\')">'+wsEsc(c.ports)+'</span>':'') + '</div><div class="ws-docker-actions"><button class="ws-docker-btn" onclick="wsDockAction(\''+wsEsc(c.name)+'\',\'start\')"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>Start</button><button class="ws-docker-btn" onclick="wsDockAction(\''+wsEsc(c.name)+'\',\'stop\')"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>Stop</button></div><pre class="ws-docker-logs">' + wsEsc(c.logs||'‚Äî Aucun log ‚Äî') + '</pre></div>';
        }).join('');
      } else {
        html += '<div class="ws-empty-state"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg><span>Aucun container en cours</span>' + (dockerFiles.length ? '<span class="ws-empty-hint">Fichiers Docker: ' + dockerFiles.map(function(f){return f.name;}).join(', ') + '</span><button class="ws-docker-compose-up-btn" onclick="wsDockComposeUp(this)"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg> docker compose up</button>' : '<span class="ws-empty-hint">Aucun Dockerfile trouv√©</span>') + '</div>';
      }
      if (dockerFiles.length) {
        html += '<div style="margin-top:.75rem;">' + dockerFiles.map(function(f) {
          return '<details style="margin-bottom:.5rem;"><summary style="cursor:pointer;font-size:.72rem;font-weight:600;color:var(--text-secondary);padding:.35rem .5rem;background:var(--bg-secondary);border-radius:4px;">' + wsEsc(f.name) + '</summary><pre style="background:var(--bg-secondary);padding:.5rem;font-size:.68rem;overflow:auto;max-height:200px;border-radius:0 0 4px 4px;margin:0">' + wsEsc(f.content) + '</pre></details>';
        }).join('') + '</div>';
      }
      body.innerHTML = html;
    });
}

function wsDockAction(name, action) {
  wsFetch('/api/projects/' + encodeURIComponent(_wsProjectId) + '/workspace/docker/' + encodeURIComponent(action), {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({container:name})})
    .then(function(){ setTimeout(wsLoadDocker, 1500); });
}

function wsDockComposeUp(btn) {
  // Run in Output panel which streams logs in real time
  wsSetView('code');
  wsRunOutput('docker compose up --build -d');
}

function wsDockPreview(ports) {
  var m = ports.match(/(\d{4,5})->/)||ports.match(/0\.0\.0\.0:(\d+)/);
  if (m) { var url=window.location.protocol+'//'+window.location.hostname+':'+m[1]; document.getElementById('wsPreviewUrl').value=url; wsSetView('preview'); setTimeout(function(){wsPreviewLoad(url);},100); }
}

// ‚îÄ‚îÄ Agents ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function wsShowLaunchMission() {
  var panel = document.getElementById('wsLaunchMissionPanel');
  if (!panel) return;
  panel.style.display = panel.style.display === 'none' ? 'flex' : 'none';
  if (panel.style.display === 'flex') {
    // Load available workflows
    fetch('/api/workflows').then(function(r){ return r.json(); }).then(function(d) {
      var sel = document.getElementById('wsLaunchWorkflow');
      if (!sel) return;
      var wfs = (d.workflows || d.items || d || []).filter(function(w){ return w.id && w.name; });
      if (!wfs.length) return;
      sel.innerHTML = '<option value="">Choisir un workflow‚Ä¶</option>';
      wfs.forEach(function(w) {
        sel.innerHTML += '<option value="' + wsEsc(w.id) + '">' + wsEsc(w.name || w.id) + '</option>';
      });
    }).catch(function(){});
  }
}

function wsLaunchMission() {
  var wfId = document.getElementById('wsLaunchWorkflow')?.value;
  var brief = document.getElementById('wsLaunchBrief')?.value?.trim();
  var status = document.getElementById('wsLaunchMissionStatus');
  if (!wfId || !brief) { if (status) status.textContent = '‚ö† Workflow et brief requis'; return; }
  if (status) status.textContent = '‚è≥ Lancement‚Ä¶';
  fetch('/api/missions/start', {
    method: 'POST', headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ workflow_id: wfId, brief: brief, project_id: _wsProjectId })
  }).then(function(r){ return r.json(); })
    .then(function(d) {
      if (d.error) { if (status) status.textContent = '‚úó ' + d.error; return; }
      if (status) status.textContent = '‚úÖ Mission ' + (d.mission_id||'') + ' lanc√©e !';
      document.getElementById('wsLaunchBrief').value = '';
      setTimeout(function(){
        var p = document.getElementById('wsLaunchMissionPanel');
        if (p) p.style.display = 'none';
        if (status) status.textContent = '';
        wsLoadAgents();
      }, 3000);
    }).catch(function(e){ if (status) status.textContent = '‚úó Erreur: ' + e.message; });
}

function wsLoadAgents() {
  var body = document.getElementById('wsAgentsBody');
  wsFetch('/api/projects/' + encodeURIComponent(_wsProjectId) + '/workspace/agents')
    .then(function(r){ return r.json(); })
    .then(function(data) {
      var items = data.items || [];
      if (!items.length) { body.innerHTML = '<div class="ws-empty-state"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg><span>Aucun agent actif</span></div>'; return; }
      body.innerHTML = items.map(function(a) {
        var pct = a.progress || 0;
        return '<div class="ws-agent-row">' + (a.avatar?'<img class="ws-agent-avatar" src="'+wsEsc(a.avatar)+'" alt="">':'<div class="ws-agent-avatar ws-agent-avatar-placeholder">' + wsEsc((a.agent_name||'?')[0]) + '</div>') + '<div class="ws-agent-info"><div class="ws-agent-name">' + wsEsc(a.agent_name||a.agent_id) + '</div><div class="ws-agent-mission">' + wsEsc(a.mission_title||a.session_id) + '</div>' + (a.phase?'<div class="ws-agent-phase">'+wsEsc(a.phase)+'</div>':'') + '<div class="ws-progress-bar"><div class="ws-progress-fill" style="width:'+pct+'%"></div></div></div><span class="ws-badge '+(a.status==='active'?'ws-badge-ok':'ws-badge-idle')+'">'+wsEsc(a.status||'')+'</span></div>';
      }).join('');
    });
}

// ‚îÄ‚îÄ Git ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function wsLoadGit() {
  wsFetch('/api/projects/' + encodeURIComponent(_wsProjectId) + '/workspace/git')
    .then(function(r){ return r.json(); })
    .then(function(data) {
      var commits = data.commits||[], changes = data.changes||[], branch = data.branch||'';
      if (branch) { var el=document.getElementById('wsGitBranchName'); if(el){el.textContent=branch; document.getElementById('wsGitBranch').style.display='';} }
      // Left panel: changes + commit form
      var leftHtml = '';
      if (changes.length) {
        leftHtml += '<div class="ws-git-section-title">Modifications ('+changes.length+')</div><div class="ws-git-changes">';
        changes.forEach(function(f){ var color=f.status==='M'?'#f0883e':f.status==='A'?'#3fb950':'#f85149'; leftHtml+='<div class="ws-git-change-row" onclick="wsGitDiff(\''+wsEsc(f.path||f.file||'')+'\')"><span style="color:'+color+';font-family:monospace;font-weight:700;width:16px;flex-shrink:0">'+wsEsc(f.status||'M')+'</span><span class="ws-git-change-path">'+wsEsc(f.path||f.file||'')+'</span></div>'; });
        leftHtml += '</div>';
      }
      leftHtml += '<div class="ws-git-form"><div class="ws-git-form-title">Commit rapide</div><textarea id="wsGitMsg" placeholder="feat: ‚Ä¶" rows="2"></textarea><div class="ws-git-form-row"><label style="font-size:.72rem;display:flex;align-items:center;gap:.35rem;"><input type="checkbox" id="wsGitPush"> Push</label><button class="btn btn-sm btn-primary" onclick="wsGitCommit()" style="margin-left:auto">Commit</button></div></div>';
      document.getElementById('wsGitBody').innerHTML = leftHtml;
      // Right panel: log
      var logHtml = '';
      if (commits.length) {
        logHtml += '<div class="ws-git-section-title" style="margin-bottom:.5rem">Historique ('+commits.length+')</div><div class="ws-git-log">';
        commits.forEach(function(c){ logHtml+='<div class="ws-git-commit"><span class="ws-git-sha">'+wsEsc((c.hash||'').substring(0,7))+'</span><span class="ws-git-msg">'+wsEsc(c.message||'')+'</span><span class="ws-git-meta">'+wsEsc(c.author||'')+' ¬∑ '+wsEsc((c.date||'').substring(0,10))+'</span></div>'; });
        logHtml += '</div>';
      } else {
        logHtml = '<div class="ws-empty-state"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="18" cy="18" r="3"/><circle cx="6" cy="6" r="3"/><path d="M13 6h3a2 2 0 0 1 2 2v7M6 9v12"/></svg><span>Pas de d√©p√¥t Git ou vide</span></div>';
      }
      document.getElementById('wsGitLogArea').innerHTML = logHtml;
    });
}

function wsGitDiff(path) {
  wsGitMainTab(document.querySelector('[data-tab="diff"]'), 'diff');
  var area = document.getElementById('wsGitDiffArea');
  area.textContent = 'Chargement diff ' + path + '‚Ä¶';
  wsFetch('/api/projects/' + encodeURIComponent(_wsProjectId) + '/workspace/git/diff?file=' + encodeURIComponent(path))
    .then(function(r){ return r.json(); })
    .then(function(d){ area.textContent = d.diff || '(aucun diff)'; })
    .catch(function(){ area.textContent = '(erreur)'; });
}

function wsGitCommit() {
  var msg = document.getElementById('wsGitMsg').value.trim(); if(!msg){alert('Message requis');return;}
  var push = document.getElementById('wsGitPush').checked;
  wsSetStatus('Commit‚Ä¶','running');
  wsFetch('/api/projects/' + encodeURIComponent(_wsProjectId) + '/workspace/git/commit', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:msg,push:push})})
    .then(function(r){return r.json();})
    .then(function(d){wsSetStatus('Pr√™t','idle');if(d.ok){wsLoadGit();}else{alert(d.error||'Erreur');}});
}

// ‚îÄ‚îÄ Preview ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function wsLoadPreview() { var url=document.getElementById('wsPreviewUrl').value.trim(); if(url) wsPreviewLoad(url); }
function wsPreviewLoad(url) {
  if(!url) url=document.getElementById('wsPreviewUrl').value.trim(); if(!url) return;
  document.getElementById('wsPreviewEmpty').style.display='none';
  var f=document.getElementById('wsPreviewFrame'); f.style.display=''; f.src=url;
}
function wsPreviewToggleMobile() {
  _wsPreviewMobile=!_wsPreviewMobile;
  var f=document.getElementById('wsPreviewFrame'); var btn=document.getElementById('wsPreviewMobileBtn');
  if(f) f.classList.toggle('mobile',_wsPreviewMobile);
  if(btn) btn.style.color=_wsPreviewMobile?'var(--purple)':'';
}

// ‚îÄ‚îÄ Backlog ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function wsLoadBacklog() {
  var body = document.getElementById('wsBacklogBody');
  wsFetch('/api/projects/' + encodeURIComponent(_wsProjectId) + '/workspace/backlog')
    .then(function(r){ return r.json(); })
    .then(function(data) {
      var missions = data.missions || [];
      if (!missions.length) { body.innerHTML = '<div class="ws-empty-state"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 0 2-2h2a2 2 0 0 0 2 2"/></svg><span>Aucune mission pour ce projet</span><span class="ws-empty-hint">Cr√©ez une mission depuis la page projet</span></div>'; return; }
      var html = '';
      missions.forEach(function(m) {
        var sc = m.status==='active'?'ws-badge-ok':m.status==='planning'?'ws-badge-idle':'ws-badge-err';
        var typeIcon = {'architecture':'üèó','feature':'‚ö°','security':'üîí','tma':'üîß','debt':'‚öô','maintenance':'üî©'}[m.type] || 'üìã';
        html += '<div class="ws-docker-container">';
        html += '<div class="ws-docker-header">';
        html += '<div class="ws-docker-status '+(m.status==='active'?'up':'down')+'"></div>';
        html += '<span class="ws-docker-name">'+typeIcon+' '+wsEsc(m.title||m.id)+'</span>';
        if (m.type) html += '<span class="ws-badge ws-badge-idle" style="margin-left:.4rem;font-size:.65rem">'+wsEsc(m.type)+'</span>';
        html += '<span class="ws-badge '+sc+'" style="margin-left:auto">'+wsEsc(m.status||'')+'</span>';
        html += '</div>';
        if (m.goal) html += '<div style="padding:.25rem .75rem .4rem;font-size:.72rem;color:var(--text-secondary);font-style:italic">'+wsEsc(m.goal.substring(0,120))+'</div>';
        if (m.tasks && m.tasks.length) {
          html += '<table class="ws-table"><thead><tr><th>T√¢che</th><th>Type</th><th>Statut</th><th>Assign√©</th></tr></thead><tbody>';
          m.tasks.forEach(function(t){ html+='<tr class="ws-table-row"><td>'+wsEsc(t.title||t.id)+'</td><td style="color:var(--text-secondary);font-size:.7rem">'+wsEsc(t.type||'')+'</td><td><span class="ws-badge '+(t.status==='done'?'ws-badge-ok':t.status==='active'||t.status==='in_progress'?'ws-badge-running':'ws-badge-idle')+'">'+wsEsc(t.status||'')+'</span></td><td style="font-size:.72rem;color:var(--text-secondary)">'+wsEsc(t.agent||'')+'</td></tr>'; });
          html += '</tbody></table>';
        }
        html += '</div>';
      });
      body.innerHTML = html;
    }).catch(function(){ body.innerHTML = '<div class="ws-empty-state"><span>Erreur de chargement</span></div>'; });
}

// ‚îÄ‚îÄ Database ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function wsLoadDatabase() {
  var panel = document.getElementById('wsDbFiles');
  panel.innerHTML = '<div class="ws-tree-item" style="color:var(--text-secondary);font-size:.72rem;cursor:default;padding:.75rem;">Scan‚Ä¶</div>';
  wsFetch('/api/projects/' + encodeURIComponent(_wsProjectId) + '/workspace/db')
    .then(function(r){ return r.json(); })
    .then(function(data) {
      _wsDbFiles = data.files || [];
      if (!_wsDbFiles.length) {
        panel.innerHTML = '<div style="padding:.75rem;color:var(--text-secondary);font-size:.72rem;text-align:center;line-height:1.6">Aucune base SQLite d√©tect√©e<br><span style="font-size:.68rem">Pour Postgres/MySQL/MongoDB,<br>utilisez l\'onglet <strong>DbGate</strong> ‚Üí</span></div>';
        return;
      }
      var html = '';
      _wsDbFiles.forEach(function(f) {
        html += '<div class="ws-db-file-label" style="padding:.4rem .75rem .2rem;font-size:.68rem;font-weight:700;text-transform:uppercase;color:var(--text-secondary);letter-spacing:.05em">' + wsEsc(f.name) + '</div>';
        (f.tables || []).forEach(function(t) {
          html += '<div class="ws-db-table-item" onclick="wsDbSelectTable(' + JSON.stringify(f.file) + ',' + JSON.stringify(t.name) + ')">' +
            '<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M3 3h18v18H3z"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/></svg>' +
            wsEsc(t.name) + '<span style="margin-left:auto;font-size:.65rem;color:var(--text-secondary)">' + (t.row_count||0) + '</span></div>';
        });
      });
      panel.innerHTML = html;
      if (_wsDbFiles.length && _wsDbFiles[0].tables && _wsDbFiles[0].tables.length) {
        _wsDbCurrentFile = _wsDbFiles[0].file;
      }
    }).catch(function(){ panel.innerHTML = '<div style="padding:.75rem;color:var(--text-secondary);font-size:.72rem">Erreur</div>'; });
}

function wsDbSelectTable(file, table) {
  _wsDbCurrentFile = file;
  document.getElementById('wsDbTableLabel').textContent = table;
  document.getElementById('wsDbQuery').value = 'SELECT * FROM "' + table + '" LIMIT 100;';
  wsDbRun();
}

function wsDbRun() {
  var sql = document.getElementById('wsDbQuery').value.trim();
  if (!sql) return;
  if (!_wsDbCurrentFile) { document.getElementById('wsDbStatus').textContent = 'S√©lectionnez un fichier'; return; }
  document.getElementById('wsDbStatus').textContent = '‚Ä¶';
  document.getElementById('wsDbResults').innerHTML = '<div class="ws-empty-state"><span>Ex√©cution‚Ä¶</span></div>';
  wsFetch('/api/projects/' + encodeURIComponent(_wsProjectId) + '/workspace/db/query', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({file:_wsDbCurrentFile,sql:sql})})
    .then(function(r){ return r.json(); })
    .then(function(data) {
      if (data.error) { document.getElementById('wsDbStatus').textContent='Erreur'; document.getElementById('wsDbResults').innerHTML='<div style="padding:.75rem;color:#f85149;font-size:.78rem;font-family:monospace">'+wsEsc(data.error)+'</div>'; return; }
      var cols=data.columns||[], rows=data.rows||[];
      document.getElementById('wsDbStatus').textContent = rows.length + ' ligne(s)';
      if (!cols.length) { document.getElementById('wsDbResults').innerHTML='<div class="ws-empty-state"><span>Aucun r√©sultat</span></div>'; return; }
      var html='<table class="ws-db-table"><thead><tr>'+cols.map(function(c){return '<th>'+wsEsc(c)+'</th>';}).join('')+'</tr></thead><tbody>';
      rows.forEach(function(row){ html+='<tr>'+row.map(function(v){return '<td title="'+wsEsc(String(v===null?'NULL':v))+'">'+wsEsc(String(v===null?'NULL':v))+'</td>';}).join('')+'</tr>'; });
      html+='</tbody></table>';
      document.getElementById('wsDbResults').innerHTML=html;
    })
    .catch(function(e){ document.getElementById('wsDbStatus').textContent='Erreur'; document.getElementById('wsDbResults').innerHTML='<div style="padding:.75rem;color:#f85149;font-size:.78rem">'+wsEsc(String(e))+'</div>'; });
}
document.getElementById('wsDbQuery').addEventListener('keydown', function(e){ if(e.ctrlKey&&e.key==='Enter') wsDbRun(); });

// ‚îÄ‚îÄ Portainer Stats ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function wsLoadPortainerStats() {
  var el = document.getElementById('wsPortainerStats');
  if (!el) return;
  wsFetch('/api/docker/stats')
    .then(function(r){ return r.json(); })
    .then(function(d) {
      el.innerHTML = '<span class="ws-badge ws-badge-ok">' + (d.running||0) + ' running</span> <span class="ws-badge">' + (d.total||0) + ' total</span>';
    }).catch(function(){ el.innerHTML = '<span class="ws-badge">‚Äî</span>'; });
}

var _wsDbGateToken = null;
var _wsDbGateReady = false;

function wsDbGateAutoLogin(callback) {
  if (_wsDbGateReady) { if (callback) callback(); return; }
  var frame = document.getElementById('wsDbGateFrame');
  wsFetch('/api/dbgate/token')
    .then(function(r){ return r.json(); })
    .then(function(d) {
      if (!d.token || !frame) {
        if (frame && frame.src === 'about:blank') frame.src = '/dbgate/';
        _wsDbGateReady = true;
        if (callback) callback();
        return;
      }
      _wsDbGateToken = d.token;
      // Use URL-based token (avoids cross-origin localStorage restrictions)
      var url = '/dbgate/?accessToken=' + encodeURIComponent(_wsDbGateToken);
      frame.onload = function() { _wsDbGateReady = true; frame.onload = null; if (callback) callback(); };
      frame.src = url;
    }).catch(function(){
      if (frame && frame.src === 'about:blank') frame.src = '/dbgate/';
      if (callback) callback();
    });
}

function wsLoadDbGateConnections() {
  var el = document.getElementById('wsDbGateConnections');
  if (!el) return;
  el.innerHTML = '<div style="padding:.35rem .75rem;font-size:.72rem;color:var(--text-secondary)">Connexion √† DbGate‚Ä¶</div>';
  // Auto-login first
  wsDbGateAutoLogin(function() {
    // Then configure connections
    wsFetch('/api/projects/' + encodeURIComponent(_wsProjectId) + '/workspace/dbgate/configure', {method:'POST'})
      .then(function(r){ return r.json(); })
      .then(function(d) {
        if (d.configured > 0) {
          el.innerHTML = '<div style="padding:.35rem .75rem;font-size:.72rem;color:var(--text-secondary)">' +
            '<span class="ws-badge ws-badge-ok">‚úì ' + d.configured + ' connexion(s) auto-configur√©e(s)</span> ' +
            '<button class="ws-secret-btn" onclick="var f=document.getElementById(\'wsDbGateFrame\');f.src=f.src" title="Recharger">‚Ü∫ Recharger</button></div>';
        } else {
          el.innerHTML = '<div style="padding:.35rem .75rem;font-size:.72rem;color:var(--text-secondary)">Ajoutez vos connexions dans DbGate ci-dessous</div>';
        }
      }).catch(function(){
        el.innerHTML = '<div style="padding:.35rem .75rem;font-size:.72rem;color:var(--text-secondary)">Ajoutez vos connexions dans DbGate</div>';
      });
  });
}

// ‚îÄ‚îÄ Secrets / Vault ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var _wsSecretsCurrentFile = null;
var _wsSecretsData = {};
var _wsSecretsShowAll = false;

function wsLoadSecrets() {
  var panel = document.getElementById('wsSecretsFiles');
  panel.innerHTML = '<div class="ws-tree-item" style="color:var(--text-secondary);font-size:.72rem;cursor:default;padding:.75rem;">Scan‚Ä¶</div>';
  wsFetch('/api/projects/' + encodeURIComponent(_wsProjectId) + '/workspace/secrets')
    .then(function(r){ return r.json(); })
    .then(function(data) {
      _wsSecretsData = {};
      var files = data.files || [];
      (data.env_info || []).forEach(function(ei) { /* extra info */ });
      if (!files.length) {
        panel.innerHTML = '<div style="padding:.75rem;color:var(--text-secondary);font-size:.72rem;text-align:center;">Aucun fichier .env</div>';
        return;
      }
      var html = '';
      files.forEach(function(f) {
        _wsSecretsData[f.path] = f.vars || [];
        var badge = f.vars.length + ' var' + (f.vars.length > 1 ? 's' : '');
        html += '<div class="ws-tree-item" onclick="wsSecretsSelect(\'' + wsEsc(f.path) + '\')">' +
          '<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>' +
          wsEsc(f.name) + '<span class="ws-tree-size">' + badge + '</span></div>';
      });
      panel.innerHTML = html;
      if (files.length) wsSecretsSelect(files[0].path);
    }).catch(function(){ panel.innerHTML = '<div style="padding:.75rem;color:#f85149;font-size:.72rem">Erreur</div>'; });
}

function wsSecretsSelect(path) {
  _wsSecretsCurrentFile = path;
  document.getElementById('wsSecretsFileName').textContent = path;
  document.getElementById('wsSecretsSaveBtn').disabled = false;
  document.getElementById('wsSecretsAddRow').style.display = 'flex';
  wsSecretsRender();
  // Highlight active file
  document.querySelectorAll('#wsSecretsFiles .ws-tree-item').forEach(function(el) {
    el.classList.toggle('active', el.textContent.trim().startsWith(path.replace(/^\./,'')));
  });
}

function wsSecretsRender() {
  if (!_wsSecretsCurrentFile) return;
  var vars = _wsSecretsData[_wsSecretsCurrentFile] || [];
  var list = document.getElementById('wsSecretsList');
  if (!vars.length) {
    list.innerHTML = '<div style="padding:.5rem;color:var(--text-secondary);font-size:.75rem;text-align:center">Aucune variable ‚Äî ajoutez-en ci-dessous</div>';
    return;
  }
  var html = '';
  vars.forEach(function(v, i) {
    var masked = _wsSecretsShowAll ? wsEsc(v.value) : (v.value ? '‚Ä¢'.repeat(Math.min(v.value.length, 12)) : '‚Äî');
    html += '<div class="ws-secret-row" data-idx="' + i + '">' +
      '<span class="ws-secret-key">' + wsEsc(v.key) + '</span>' +
      '<span class="ws-secret-val" data-idx="' + i + '">' + masked + '</span>' +
      '<input class="ws-secret-input" type="text" value="' + wsEsc(v.value) + '" data-idx="' + i + '" onchange="wsSecretsEdit(' + i + ',this.value)" style="display:none">' +
      '<button class="ws-secret-btn" onclick="wsSecretsToggleEdit(' + i + ')" title="Modifier">‚úé</button>' +
      '<button class="ws-secret-btn ws-secret-del" onclick="wsSecretsDelete(' + i + ')" title="Supprimer">‚úï</button>' +
      '</div>';
  });
  list.innerHTML = html;
}

function wsSecretsToggleEdit(idx) {
  var span = document.querySelector('.ws-secret-val[data-idx="' + idx + '"]');
  var inp = document.querySelector('.ws-secret-input[data-idx="' + idx + '"]');
  if (span && inp) {
    var editing = inp.style.display !== 'none';
    span.style.display = editing ? '' : 'none';
    inp.style.display = editing ? 'none' : '';
    if (!editing) inp.focus();
  }
}

function wsSecretsEdit(idx, val) {
  if (!_wsSecretsCurrentFile) return;
  var vars = _wsSecretsData[_wsSecretsCurrentFile];
  if (vars && vars[idx]) vars[idx].value = val;
  wsSecretsRender();
}

function wsSecretsDelete(idx) {
  if (!_wsSecretsCurrentFile) return;
  _wsSecretsData[_wsSecretsCurrentFile].splice(idx, 1);
  wsSecretsRender();
}

function wsSecretsAdd() {
  var key = document.getElementById('wsSecretsNewKey').value.trim().toUpperCase().replace(/[^A-Z0-9_]/g,'_');
  var val = document.getElementById('wsSecretsNewVal').value;
  if (!key || !_wsSecretsCurrentFile) return;
  if (!_wsSecretsData[_wsSecretsCurrentFile]) _wsSecretsData[_wsSecretsCurrentFile] = [];
  // Update if exists
  var existing = _wsSecretsData[_wsSecretsCurrentFile].find(function(v){ return v.key === key; });
  if (existing) { existing.value = val; } else { _wsSecretsData[_wsSecretsCurrentFile].push({key:key, value:val}); }
  document.getElementById('wsSecretsNewKey').value = '';
  document.getElementById('wsSecretsNewVal').value = '';
  wsSecretsRender();
}

function wsSecretsToggleAll() {
  _wsSecretsShowAll = !_wsSecretsShowAll;
  var btn = document.getElementById('wsSecretsShowAllBtn');
  if (btn) btn.style.color = _wsSecretsShowAll ? 'var(--purple)' : '';
  wsSecretsRender();
}

function wsSecretsSave() {
  if (!_wsSecretsCurrentFile) return;
  var vars = _wsSecretsData[_wsSecretsCurrentFile] || [];
  var btn = document.getElementById('wsSecretsSaveBtn');
  if (btn) { btn.disabled = true; btn.textContent = '‚Ä¶'; }
  wsFetch('/api/projects/' + encodeURIComponent(_wsProjectId) + '/workspace/secrets/save', {
    method: 'POST', headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({path: _wsSecretsCurrentFile, vars: vars})
  }).then(function(r){ return r.json(); })
    .then(function(d) {
      if (btn) { btn.disabled = false; btn.innerHTML = '<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg> Sauvegarder'; }
      wsSetStatus(d.ok ? 'Secrets sauvegard√©s ‚úì' : 'Erreur: '+(d.error||''), d.ok ? 'ok' : 'running');
      setTimeout(function(){ wsSetStatus('Pr√™t','idle'); }, 2500);
    }).catch(function(){ if(btn){ btn.disabled=false; } wsSetStatus('Erreur save','running'); });
}

function wsSecretsNewFile() {
  var name = prompt('Nom du fichier (.env, .env.local, .env.production‚Ä¶)', '.env');
  if (!name || !name.startsWith('.env')) return;
  _wsSecretsData[name] = [];
  _wsSecretsCurrentFile = name;
  // Add to UI
  var panel = document.getElementById('wsSecretsFiles');
  var existing = panel.querySelector('[data-file="' + name + '"]');
  if (!existing) {
    panel.insertAdjacentHTML('beforeend', '<div class="ws-tree-item" onclick="wsSecretsSelect(\'' + wsEsc(name) + '\')">' +
      '<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>' + wsEsc(name) + '<span class="ws-tree-size">0 var</span></div>');
  }
  wsSecretsSelect(name);
  // Auto-save to create the file
  wsSecretsSave();
}


function wsSetStatus(text, state) { var el=document.getElementById('wsStatus'); if(!el)return; el.textContent=text; el.className='ws-badge ws-badge-status ws-badge-'+state; }
function wsEsc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

// ‚îÄ‚îÄ File icons by extension ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var _wsIconMap = {
  js:'js',jsx:'js',mjs:'js', ts:'ts',tsx:'ts',
  py:'py',pyw:'py', html:'html',htm:'html', css:'css',scss:'css',less:'css',
  json:'json',jsonc:'json', md:'md',mdx:'md', sh:'sh',bash:'sh',zsh:'sh',
  sql:'sql', rs:'rust', go:'go', yaml:'yaml',yml:'yaml',
};
var _wsIconSVGs = {
  js:   '<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><rect x="2" y="2" width="20" height="20" rx="2"/><text x="5" y="17" style="font-size:10px;font-weight:700;fill:#1e1e1e">JS</text></svg>',
  ts:   '<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><rect x="2" y="2" width="20" height="20" rx="2"/><text x="4" y="17" style="font-size:10px;font-weight:700;fill:#fff">TS</text></svg>',
  py:   '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2C8 2 7 4 7 6v2h10V6c0-2-1-4-5-4z"/><path d="M7 8v8c0 2 1 4 5 4s5-2 5-4V8"/></svg>',
  html: '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>',
  css:  '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>',
  json: '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>',
  md:   '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>',
  sh:   '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>',
  sql:  '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>',
  rust: '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="4"/><line x1="1.05" y1="12" x2="7" y2="12"/><line x1="17.01" y1="12" x2="22.96" y2="12"/></svg>',
  go:   '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14"/><path d="M12 5l7 7-7 7"/></svg>',
  yaml: '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/></svg>',
  default: '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>',
};
function wsFileIcon(name) {
  var ext = (name.split('.').pop() || '').toLowerCase();
  var type = _wsIconMap[ext] || 'default';
  var cls = 'ws-icon-' + (type === 'default' ? 'default' : type);
  return '<span class="' + cls + '" style="display:inline-flex;align-items:center;flex-shrink:0">' + (_wsIconSVGs[type] || _wsIconSVGs.default) + '</span>';
}

// ‚îÄ‚îÄ Search across files ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function wsRunSearch() {
  var q = document.getElementById('wsSearchQuery')?.value?.trim();
  var glob = document.getElementById('wsSearchGlob')?.value?.trim() || '';
  var caseSens = document.getElementById('wsSearchCase')?.checked || false;
  var isRegex = document.getElementById('wsSearchRegex')?.checked || false;
  var res = document.getElementById('wsSearchResults');
  var cnt = document.getElementById('wsSearchCount');
  if (!q || !res) return;
  res.innerHTML = '<div style="color:var(--text-secondary);font-size:.75rem;padding:.3rem">Recherche‚Ä¶</div>';
  if (cnt) cnt.textContent = '';
  fetch('/api/projects/' + _wsProjectId + '/workspace/search?q=' + encodeURIComponent(q) +
        '&glob=' + encodeURIComponent(glob) + '&case=' + caseSens + '&regex=' + isRegex)
    .then(function(r){ return r.json(); })
    .then(function(d) {
      var matches = d.matches || [];
      if (!matches.length) { res.innerHTML = '<div style="color:var(--text-secondary);font-size:.75rem;padding:.3rem">Aucun r√©sultat.</div>'; return; }
      if (cnt) cnt.textContent = d.total_matches + ' r√©sultats dans ' + matches.length + ' fichiers';
      var html = '';
      matches.forEach(function(f) {
        html += '<div class="ws-search-file" onclick="wsOpenFile(\'' + wsEsc(f.file) + '\')">' +
          wsFileIcon(f.file) + ' ' + wsEsc(f.file) +
          '<span style="margin-left:auto;font-size:.65rem;color:var(--text-muted)">' + f.lines.length + ' √ó</span></div>';
        f.lines.forEach(function(l) {
          var highlighted = wsEsc(l.text).replace(new RegExp('(' + wsEsc(q) + ')', 'gi'), '<em>$1</em>');
          html += '<div class="ws-search-match" onclick="wsOpenFile(\'' + wsEsc(f.file) + '\')">' +
            '<span class="ws-search-lnum">' + l.line + '</span>' + highlighted + '</div>';
        });
      });
      res.innerHTML = html;
    })
    .catch(function(e) { res.innerHTML = '<div style="color:#ef4444;font-size:.75rem">Erreur: ' + e.message + '</div>'; });
}

// ‚îÄ‚îÄ Timeline ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function wsLoadTimeline() {
  var body = document.getElementById('wsTimelineBody');
  var filter = document.getElementById('wsTimelineFilter')?.value || 'all';
  if (!body) return;
  body.innerHTML = '<div style="color:var(--text-secondary);font-size:.75rem;padding:.5rem">Chargement‚Ä¶</div>';
  fetch('/api/projects/' + _wsProjectId + '/workspace/timeline?filter=' + filter)
    .then(function(r) { return r.json(); })
    .then(function(d) {
      var items = d.events || [];
      if (!items.length) { body.innerHTML = '<div style="color:var(--text-secondary);font-size:.78rem;padding:.5rem">Aucun √©v√©nement trouv√©.</div>'; return; }
      var html = '';
      items.forEach(function(ev) {
        var t = ev.type || 'commit';
        var ts = ev.ts ? new Date(ev.ts).toLocaleString('fr-FR', {day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'}) : '';
        html += '<div class="ws-tl-item ' + wsEsc(t) + '">';
        html += '<div class="ws-tl-meta">';
        html += '<div class="ws-tl-title"><span class="ws-tl-badge ' + wsEsc(t) + '">' + wsEsc(t) + '</span>' + wsEsc(ev.title || ev.message || '') + '</div>';
        if (ev.description) html += '<div class="ws-tl-desc">' + wsEsc(ev.description) + '</div>';
        if (ev.author) html += '<div class="ws-tl-desc" style="color:var(--purple-light)">üë§ ' + wsEsc(ev.author) + '</div>';
        html += '</div>';
        html += '<div class="ws-tl-time">' + wsEsc(ts) + '</div>';
        html += '</div>';
      });
      body.innerHTML = html;
    })
    .catch(function(e) { body.innerHTML = '<div style="color:#ef4444;font-size:.75rem">Erreur: ' + e.message + '</div>'; });
}

// ‚îÄ‚îÄ Live metrics ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function wsLoadMetrics() {
  wsFetch('/api/projects/' + encodeURIComponent(_wsProjectId) + '/workspace/metrics')
    .then(function(r){ return r.json(); })
    .then(function(d) {
      var el = function(id){ return document.getElementById(id); };
      if (el('wsMetricAgents')) el('wsMetricAgents').textContent = d.active_agents || 0;
      if (el('wsMetricCalls')) el('wsMetricCalls').textContent = d.tool_calls_last_hour || 0;
      if (el('wsMetricFiles')) el('wsMetricFiles').textContent = d.files_written || 0;
      if (el('wsMetricMissions')) el('wsMetricMissions').textContent = d.mission_runs_active || 0;
      if (d.last_commit_hash && el('wsMetricCommit')) {
        el('wsMetricCommit').style.display = '';
        el('wsMetricCommitSep').style.display = '';
        el('wsMetricCommitHash').textContent = d.last_commit_hash;
        el('wsMetricCommitMsg').textContent = d.last_commit_msg || '';
      }
    }).catch(function(){});
}

// ‚îÄ‚îÄ PROGRESS.md ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function wsLoadProgress() {
  var el = document.getElementById('ws-code-progress');
  if (!el) return;
  wsFetch('/api/projects/' + encodeURIComponent(_wsProjectId) + '/workspace/progress')
    .then(function(r){ return r.json(); })
    .then(function(d) {
      if (!d.exists || !d.content) {
        el.innerHTML = '<div class="ws-empty-state"><span>Pas de PROGRESS.md</span><span class="ws-empty-hint">Sera cr√©√© par les agents lors d\'une mission</span></div>';
        return;
      }
      // Simple markdown ‚Üí HTML (headings, bold, code blocks, lists)
      var html = wsMarkdownLite(d.content);
      el.innerHTML = html;
      if (d.mtime) {
        el.insertAdjacentHTML('afterbegin', '<div style="font-size:.68rem;color:var(--text-secondary);margin-bottom:.5rem">Mis √† jour: ' + wsEsc(new Date(d.mtime).toLocaleString('fr-FR')) + '</div>');
      }
    }).catch(function(){ el.innerHTML = '<div class="ws-empty-state"><span>Erreur chargement PROGRESS.md</span></div>'; });
}

function wsMarkdownLite(text) {
  if (!text) return '';
  var lines = text.split('\n');
  var html = ''; var inCode = false;
  lines.forEach(function(line) {
    if (line.startsWith('```')) { inCode = !inCode; html += inCode ? '<pre>' : '</pre>'; return; }
    if (inCode) { html += wsEsc(line) + '\n'; return; }
    if (line.startsWith('# ')) { html += '<h1>' + wsEsc(line.slice(2)) + '</h1>'; return; }
    if (line.startsWith('## ')) { html += '<h2>' + wsEsc(line.slice(3)) + '</h2>'; return; }
    if (line.startsWith('### ')) { html += '<h3>' + wsEsc(line.slice(4)) + '</h3>'; return; }
    if (line.startsWith('- ') || line.startsWith('* ')) { html += '<li>' + wsEsc(line.slice(2)).replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>') + '</li>'; return; }
    if (line.trim() === '') { html += '<br>'; return; }
    html += '<p>' + wsEsc(line).replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>').replace(/`(.+?)`/g, '<code style="background:var(--bg-secondary);padding:0 3px;border-radius:2px;font-family:monospace">$1</code>') + '</p>';
  });
  return html;
}

// ‚îÄ‚îÄ Live Feed (view) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var _wsLiveEv_icons = {
  tool_call: '‚ö°', file_write: 'üìÅ', message: 'üí¨', git_commit: 'üîÄ',
  agent_status: 'üë§', mission_phase: 'üöÄ'
};

function wsLivePush(type, data) {
  // Add to buffer
  _wsLiveBuf.unshift({type: type, data: data, ts: data.ts || new Date().toISOString()});
  if (_wsLiveBuf.length > 200) _wsLiveBuf.pop();
  // Notify badge on live btn if not active
  wsNotifAdd('live');
  // Render if live view is active
  if (_wsCurrentView === 'live') wsLiveRenderAll();
}

function wsLiveFilter(btn, f) {
  _wsLiveFilter = f;
  document.querySelectorAll('.ws-live-filter-btn').forEach(function(b){ b.classList.remove('active'); });
  btn.classList.add('active');
  wsLiveRenderAll();
}

function wsLiveClear() { _wsLiveBuf = []; wsLiveRenderAll(); }

function wsLiveRenderAll() {
  var feed = document.getElementById('wsLiveFeed');
  if (!feed) return;
  var items = _wsLiveFilter === 'all' ? _wsLiveBuf : _wsLiveBuf.filter(function(e){ return e.type === _wsLiveFilter; });
  if (!items.length) {
    feed.innerHTML = '<div class="ws-empty-state"><span>En attente d\'√©v√©nements‚Ä¶</span><span class="ws-empty-hint">Les tool calls, fichiers, commits et messages apparaissent ici en temps r√©el</span></div>';
    return;
  }
  var html = '';
  items.slice(0, 100).forEach(function(ev) {
    var icon = _wsLiveEv_icons[ev.type] || '‚Ä¢';
    var d = ev.data || {};
    var agent = wsEsc(d.agent_id || d.from_agent || '');
    var tsStr = d.ts ? d.ts.substring(11, 19) : '';
    var body = '';
    if (ev.type === 'tool_call') {
      body = '<span class="ws-tc-tool">' + wsEsc(d.tool_name||'') + '</span>';
      if (d.file) body += ' <span class="ws-live-event-file">' + wsEsc(d.file) + '</span>';
      if (d.success === false) body += ' <span class="ws-badge ws-badge-err" style="font-size:.65rem">Err</span>';
    } else if (ev.type === 'file_write') {
      body = '<span class="ws-live-event-file">' + wsEsc(d.path||'') + '</span>';
    } else if (ev.type === 'message') {
      body = wsEsc((d.preview||'').substring(0,100));
    } else if (ev.type === 'git_commit') {
      body = '<span style="font-family:monospace;color:#79c0ff">' + wsEsc((d.hash||'').substring(0,8)) + '</span> ' + wsEsc(d.message||'');
    } else if (ev.type === 'agent_status') {
      body = wsEsc(d.status||'') + (d.phase?' ‚Üí '+wsEsc(d.phase):'') + (d.mission?' ('+wsEsc(d.mission.substring(0,30))+')':'');
    } else if (ev.type === 'mission_phase') {
      body = wsEsc(d.workflow||'') + ' ‚Üí ' + wsEsc(d.phase||d.status||'');
    }
    html += '<div class="ws-live-event">';
    html += '<span class="ws-live-event-icon">' + icon + '</span>';
    html += '<span class="ws-live-event-agent">' + agent + '</span>';
    html += '<span class="ws-live-event-body">' + body + '</span>';
    html += '<span class="ws-live-event-ts">' + wsEsc(tsStr) + '</span>';
    html += '</div>';
  });
  feed.innerHTML = html;
}

// ‚îÄ‚îÄ SSE Live stream ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function wsStartLiveStream() {
  if (_wsLiveEs) { try { _wsLiveEs.close(); } catch(e){} }
  var url = '/api/projects/' + encodeURIComponent(_wsProjectId) + '/workspace/live';
  _wsLiveEs = new EventSource(url);

  function handleEv(type) {
    return function(e) {
      try {
        var data = JSON.parse(e.data);
        // Update badge
        document.getElementById('wsLiveBadge').classList.add('connected');
        // Push to live feed buffer
        wsLivePush(type, data);
        // Side effects per type
        if (type === 'tool_call') {
          wsToolCallPrepend(data);
          wsNotifAdd('code');
          wsNotifAdd('agents');
        }
        if (type === 'agent_status') {
          wsNotifAdd('agents');
        }
        if (type === 'file_write') {
          wsFileTreeHighlight(data.path);
        }
        if (type === 'git_commit') {
          if (_wsCurrentView === 'git') wsLoadGit();
          wsNotifAdd('git');
          // Update metrics commit
          var hel = document.getElementById('wsMetricCommitHash');
          var mel = document.getElementById('wsMetricCommitMsg');
          var cel = document.getElementById('wsMetricCommit');
          var sep = document.getElementById('wsMetricCommitSep');
          if (hel) hel.textContent = (data.hash||'').substring(0,8);
          if (mel) mel.textContent = data.message||'';
          if (cel) cel.style.display = '';
          if (sep) sep.style.display = '';
        }
        if (type === 'mission_phase') {
          wsNotifAdd('agents');
        }
      } catch(ex) {}
    };
  }

  _wsLiveEs.addEventListener('tool_call', handleEv('tool_call'));
  _wsLiveEs.addEventListener('agent_status', handleEv('agent_status'));
  _wsLiveEs.addEventListener('file_write', handleEv('file_write'));
  _wsLiveEs.addEventListener('git_commit', handleEv('git_commit'));
  _wsLiveEs.addEventListener('message', handleEv('message'));
  _wsLiveEs.addEventListener('mission_phase', handleEv('mission_phase'));

  _wsLiveEs.onerror = function() {
    document.getElementById('wsLiveBadge').classList.remove('connected');
    // Auto-reconnect after 5s
    setTimeout(wsStartLiveStream, 5000);
  };
  _wsLiveEs.onopen = function() {
    document.getElementById('wsLiveBadge').classList.add('connected');
  };
}

function wsToolCallPrepend(data) {
  var body = document.getElementById('wsToolcallsBody');
  if (!body) return;
  var params = '';
  try { params = JSON.stringify(JSON.parse('{}' )).substring(0,80); } catch(e){}
  if (data.file) params = data.file;
  var row = document.createElement('tr');
  row.className = 'ws-table-row ws-new-row';
  row.innerHTML = '<td><span class="ws-tc-tool">' + wsEsc(data.tool_name||'') + '</span></td>' +
    '<td class="ws-tc-params" title="' + wsEsc(params) + '">' + wsEsc(params) + '</td>' +
    '<td><span class="' + (data.success!==false?'ws-badge ws-badge-ok':'ws-badge ws-badge-err') + '">' + (data.success!==false?'OK':'Err') + '</span></td>' +
    '<td class="ws-tc-ts">' + wsEsc((data.ts||'').substring(11,19)) + '</td>';
  var existing = body.querySelector('table tbody');
  if (existing) {
    existing.insertBefore(row, existing.firstChild);
    // Remove if > 50 rows
    var rows = existing.querySelectorAll('tr');
    if (rows.length > 50) rows[rows.length-1].remove();
  } else {
    // Replace empty state with table
    body.innerHTML = '<table class="ws-table"><thead><tr><th>Outil</th><th>Fichier/Params</th><th>Statut</th><th>Heure</th></tr></thead><tbody></tbody></table>';
    body.querySelector('tbody').appendChild(row);
  }
  // Remove highlight after 3s
  setTimeout(function(){ row.classList.remove('ws-new-row'); }, 3000);
}

function wsFileTreeHighlight(path) {
  if (!path) return;
  var fname = path.split('/').pop();
  document.querySelectorAll('.ws-tree-item').forEach(function(el) {
    if (el.textContent.trim().indexOf(fname) >= 0) {
      el.classList.add('ws-just-written');
      setTimeout(function(){ el.classList.remove('ws-just-written'); }, 5000);
    }
  });
  // Also refresh tree if code view is active
  if (_wsCurrentView === 'code') {
    // Just highlight, don't reload (too expensive)
  }
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function() {
  var view = localStorage.getItem('ws_view_' + _wsProjectId) || 'code';
  wsSetView(view);
  wsLoadLeftTree();
  wsLoadGit();
  // Load metrics
  wsLoadMetrics();
  setInterval(wsLoadMetrics, 30000);
  // Restore bottom collapse
  if (localStorage.getItem('ws_bottom_collapsed')) {
    document.getElementById('wsBottomPanel').classList.add('ws-collapsed');
    var icon = document.getElementById('wsBottomCollapseIcon');
    if (icon) icon.setAttribute('points', '6 9 12 15 18 9');
  }
  // Start SSE live stream (replaces polling setIntervals)
  wsStartLiveStream();
  // Fallback polling for agents only if SSE unavailable (degraded)
  setInterval(function() {
    if (!_wsLiveEs || _wsLiveEs.readyState === 2) {
      if (document.getElementById('ws-view-agents').classList.contains('active')) { wsLoadAgents(); }
    }
  }, 30000);
})();
</script>
{% endblock %}
