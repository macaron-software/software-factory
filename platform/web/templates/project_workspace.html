{% extends "base.html" %}
{% block extra_head %}
<link rel="stylesheet" href="/static/css/project_workspace.css?v=5">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" defer></script>
<style>
/* ── Critical layout rules — inlined to ensure they always apply ── */
html,body{height:100%;overflow:hidden}
.layout{display:grid!important;grid-template-columns:56px 1fr;height:100vh!important;overflow:hidden!important}
.content{display:flex!important;flex-direction:column!important;height:100%!important;overflow:hidden!important;min-height:0!important}
.main-area{padding:0!important;overflow:hidden!important;flex:1 1 0%!important;min-height:0!important;display:flex!important;flex-direction:column!important}
/* Workspace layout */
.ws-layout{display:flex!important;flex-direction:row!important;height:100%!important;overflow:hidden!important;min-height:0!important;background:var(--bg)}
.ws-filetree{width:220px!important;min-width:160px!important;max-width:320px!important;flex-shrink:0!important;display:flex!important;flex-direction:column!important;overflow:hidden!important;background:var(--bg-secondary);border-right:1px solid var(--border)}
.ws-main{flex:1 1 0%!important;display:flex!important;flex-direction:column!important;overflow:hidden!important;min-width:0!important;min-height:0!important}
.ws-infobar{flex-shrink:0!important}
.ws-tabs{flex-shrink:0!important}
.ws-tab-content{display:none!important;flex:1 1 0%!important;min-height:0!important;overflow:hidden!important}
.ws-tab-content.active{display:flex!important;flex-direction:column!important}
</style>
{% endblock %}

{% block topbar_actions %}
<a href="/projects/{{ project.id }}" class="btn btn-sm btn-ghost">
  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
  {{ project.name }}
</a>
<span class="badge badge-purple" style="font-size:.68rem;">Workspace</span>
{% endblock %}

{% block content %}
<div class="ws-layout">

  <!-- Left: file tree -->
  <div class="ws-filetree" id="wsFiletree">
    <div class="ws-filetree-header">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
      <span>{{ project.name }}</span>
    </div>
    <div class="ws-filetree-body" id="wsTreeBody">
      <div class="ws-tree-item" style="color:var(--text-secondary);font-size:.72rem;cursor:default;padding:.75rem;">Chargement…</div>
    </div>
  </div>

  <!-- Right: main panel -->
  <div class="ws-main">

    <!-- Project info bar -->
    <div class="ws-infobar">
      <div class="ws-infobar-left">
        <span class="ws-infobar-name">{{ project.name }}</span>
        {% if project.factory_type and project.factory_type != "standalone" %}
        <span class="ws-badge ws-badge-type">{{ project.factory_type|upper }}</span>
        {% endif %}
        {% if project.path %}
        <span class="ws-badge ws-badge-path">
          <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>
          {{ project.path }}
        </span>
        {% endif %}
        <span class="ws-badge ws-badge-git" id="wsGitBranch" style="display:none">
          <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="18" r="3"/><circle cx="6" cy="6" r="3"/><path d="M13 6h3a2 2 0 0 1 2 2v7M6 9v12"/></svg>
          <span id="wsGitBranchName"></span>
        </span>
      </div>
      <div class="ws-infobar-right">
        <span class="ws-badge ws-badge-status ws-badge-idle" id="wsStatus">Prêt</span>
      </div>
    </div>

    <!-- Tabs bar -->
    <div class="ws-tabs">
      <button class="ws-tab active" onclick="wsTab(this,'terminal')" data-tab="terminal">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>
        Terminal
      </button>
      <button class="ws-tab" onclick="wsTab(this,'toolcalls')" data-tab="toolcalls">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
        Tool Calls
      </button>
      <button class="ws-tab" onclick="wsTab(this,'files')" data-tab="files">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>
        Fichiers
      </button>
      <button class="ws-tab" onclick="wsTab(this,'docker')" data-tab="docker">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>
        Docker
      </button>
      <button class="ws-tab" onclick="wsTab(this,'agents')" data-tab="agents">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        Agents
      </button>
      <button class="ws-tab" onclick="wsTab(this,'git')" data-tab="git">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="18" r="3"/><circle cx="6" cy="6" r="3"/><path d="M13 6h3a2 2 0 0 1 2 2v7M6 9v12"/></svg>
        Git
      </button>
      <button class="ws-tab" onclick="wsTab(this,'preview')" data-tab="preview">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
        Preview
      </button>
    </div>

    <!-- Terminal -->
    <div class="ws-tab-content active" id="ws-terminal">
      <div class="ws-terminal">
        <div class="ws-term-history" id="wsTermHistory"></div>
        <div class="ws-term-input-row">
          <span class="ws-term-prompt">$</span>
          <input class="ws-term-input" id="wsTermInput" type="text" placeholder="ls -la  /  git status  /  npm run dev …" autocomplete="off" spellcheck="false">
          <button class="ws-term-run" id="wsTermRun" onclick="wsRunCmd()">
            <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="5 3 19 12 5 21 5 3"/></svg>
            Run
          </button>
        </div>
      </div>
    </div>

    <!-- Tool Calls -->
    <div class="ws-tab-content" id="ws-toolcalls">
      <div class="ws-toolcalls" id="wsToolcallsBody">
        <div class="ws-empty-state"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg><span>Chargement…</span></div>
      </div>
    </div>

    <!-- Fichiers -->
    <div class="ws-tab-content" id="ws-files">
      <div class="ws-files-layout">
        <div class="ws-files-tree" id="wsFilesTree"><div class="ws-empty-state" style="font-size:.7rem;padding:.75rem">Chargement…</div></div>
        <div class="ws-files-viewer" id="wsFilesViewer">
          <div class="ws-file-empty"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg><span>Sélectionnez un fichier</span></div>
        </div>
      </div>
    </div>

    <!-- Docker -->
    <div class="ws-tab-content" id="ws-docker">
      <div class="ws-docker" id="wsDockerBody">
        <div class="ws-empty-state"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg><span>Chargement…</span></div>
      </div>
    </div>

    <!-- Agents -->
    <div class="ws-tab-content" id="ws-agents">
      <div class="ws-agents" id="wsAgentsBody">
        <div class="ws-empty-state"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg><span>Chargement…</span></div>
      </div>
    </div>

    <!-- Git -->
    <div class="ws-tab-content" id="ws-git">
      <div class="ws-git" id="wsGitBody">
        <div class="ws-empty-state"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="18" cy="18" r="3"/><circle cx="6" cy="6" r="3"/><path d="M13 6h3a2 2 0 0 1 2 2v7M6 9v12"/></svg><span>Chargement…</span></div>
      </div>
    </div>

    <!-- Preview -->
    <div class="ws-tab-content" id="ws-preview">
      <div class="ws-preview" id="wsPreviewPanel">
        <div class="ws-preview-bar">
          <input class="ws-preview-url" id="wsPreviewUrl" type="text" value="{{ preview_url or '' }}" placeholder="http://localhost:3000">
          <button class="ws-preview-btn" onclick="wsPreviewLoad()">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
            Charger
          </button>
          <button class="ws-preview-btn ws-preview-btn-icon" onclick="wsPreviewToggleMobile()" id="wsPreviewMobileBtn" title="Mobile">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg>
          </button>
          <button class="ws-preview-btn ws-preview-btn-icon" onclick="window.open(document.getElementById('wsPreviewUrl').value,'_blank')" title="Ouvrir">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
          </button>
        </div>
        <div class="ws-preview-empty" id="wsPreviewEmpty">
          <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
          <span>Aucun port détecté automatiquement</span>
          <span class="ws-empty-hint">Saisissez une URL ci-dessus et cliquez sur Charger</span>
        </div>
        <iframe class="ws-preview-frame" id="wsPreviewFrame"
          {% if preview_url %}src="{{ preview_url }}"{% endif %}
          style="{{ '' if preview_url else 'display:none' }}"
          sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>
      </div>
    </div>

  </div>
</div>

<script>
var _wsProjectId = {{ project.id | tojson }};
var _wsPreviewMobile = false;

// All API calls use same-origin credentials so session cookies are sent
function wsFetch(url, opts) {
  opts = opts || {};
  opts.credentials = 'same-origin';
  return fetch(url, opts);
}

function wsTab(btn, name) {
  document.querySelectorAll('.ws-tab').forEach(function(b){ b.classList.remove('active'); });
  document.querySelectorAll('.ws-tab-content').forEach(function(c){ c.classList.remove('active'); });
  btn.classList.add('active');
  document.getElementById('ws-' + name).classList.add('active');
  localStorage.setItem('ws_tab_' + _wsProjectId, name);
  if (name === 'toolcalls') wsLoadToolcalls();
  if (name === 'files') wsLoadFilesTree('.');
  if (name === 'docker') wsLoadDocker();
  if (name === 'agents') wsLoadAgents();
  if (name === 'git') wsLoadGit();
  if (name === 'preview') wsLoadPreview();
}

function wsLoadTermHistory() {
  wsFetch('/api/projects/' + _wsProjectId + '/workspace/tool-calls')
    
    .then(function(r){ return r.json(); })
    .then(function(data) {
      var h = document.getElementById('wsTermHistory');
      h.innerHTML = '<div class="ws-term-header-line"><span style="color:#3fb950">✓</span> <span style="color:#58a6ff">{{ project.name }}</span> <span style="color:#484f58"> — prêt</span></div>';
      var entries = data.items || [];
      if (!entries.length) {
        h.innerHTML += '<div class="ws-term-hint">Aucun tool call pour ce projet. Lancez une mission ou tapez une commande ci-dessous.</div>';
        return;
      }
      entries.forEach(function(tc) {
        var ok = tc.success;
        var entry = document.createElement('div');
        entry.className = 'ws-term-entry';
        var params = '';
        try { var p = JSON.parse(tc.parameters_json||'{}'); params = Object.values(p).slice(0,2).join(' '); } catch(e){}
        entry.innerHTML =
          '<div class="ws-term-cmd"><span class="ws-term-tool">' + wsEsc(tc.tool_name) + '</span> <span class="ws-term-args">' + wsEsc((params||'').substring(0,80)) + '</span><span class="ws-term-ts">' + wsEsc((tc.timestamp||'').substring(0,16)) + '</span></div>' +
          (tc.output ? '<div class="ws-term-output' + (ok?'':' error') + '">' + wsEsc(tc.output.substring(0,300)) + '</div>' : '') +
          '<hr class="ws-term-divider">';
        h.appendChild(entry);
      });
      h.scrollTop = h.scrollHeight;
    }).catch(function(){});
}

function wsRunCmd() {
  var inp = document.getElementById('wsTermInput');
  var cmd = inp.value.trim();
  if (!cmd) return;
  inp.value = '';
  var h = document.getElementById('wsTermHistory');
  var entry = document.createElement('div');
  entry.className = 'ws-term-entry';
  var outDiv = document.createElement('div');
  outDiv.className = 'ws-term-output';
  entry.innerHTML = '<div class="ws-term-cmd"><span style="color:#3fb950">$</span> <span class="ws-term-args">' + wsEsc(cmd) + '</span></div>';
  entry.appendChild(outDiv);
  var hr = document.createElement('hr'); hr.className = 'ws-term-divider';
  entry.appendChild(hr);
  h.appendChild(entry);
  h.scrollTop = h.scrollHeight;
  document.getElementById('wsTermRun').disabled = true;
  wsSetStatus('En cours…', 'running');
  var es = new EventSource('/api/projects/' + _wsProjectId + '/workspace/run?cmd=' + encodeURIComponent(cmd));
  var output = '';
  es.onmessage = function(e) {
    if (e.data === '[DONE]') { es.close(); document.getElementById('wsTermRun').disabled = false; wsSetStatus('Prêt', 'idle'); return; }
    output += e.data + '\n';
    outDiv.textContent = output;
    h.scrollTop = h.scrollHeight;
  };
  es.onerror = function() { es.close(); document.getElementById('wsTermRun').disabled = false; wsSetStatus('Prêt', 'idle'); outDiv.classList.add('error'); };
}

document.getElementById('wsTermInput').addEventListener('keydown', function(e) { if (e.key==='Enter') wsRunCmd(); });

function wsLoadToolcalls() {
  var body = document.getElementById('wsToolcallsBody');
  wsFetch('/api/projects/' + _wsProjectId + '/workspace/tool-calls')
    
    .then(function(r){ return r.json(); })
    .then(function(data) {
      var items = data.items || [];
      if (!items.length) {
        body.innerHTML = '<div class="ws-empty-state"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg><span>Aucun tool call enregistré pour ce projet</span><span class="ws-empty-hint">Les tool calls apparaissent quand des agents exécutent des missions</span></div>';
        return;
      }
      var html = '<table class="ws-table"><thead><tr><th>Outil</th><th>Paramètres</th><th>Statut</th><th>Durée</th><th>Date</th></tr></thead><tbody>';
      items.forEach(function(tc) {
        var params = '';
        try { var p = JSON.parse(tc.parameters_json||'{}'); params = JSON.stringify(p).substring(0,100); } catch(e){}
        html += '<tr class="ws-table-row"><td><span class="ws-tc-tool">' + wsEsc(tc.tool_name) + '</span></td><td class="ws-tc-params" title="' + wsEsc(params) + '">' + wsEsc(params) + '</td><td><span class="' + (tc.success?'ws-badge ws-badge-ok':'ws-badge ws-badge-err') + '">' + (tc.success?'OK':'Err') + '</span></td><td class="ws-tc-dur">' + (tc.duration_ms||0) + 'ms</td><td class="ws-tc-ts">' + wsEsc((tc.timestamp||'').substring(0,16)) + '</td></tr>';
      });
      html += '</tbody></table>';
      body.innerHTML = html;
    });
}

function wsLoadFilesTree(path) {
  var tree = document.getElementById('wsFilesTree');
  wsFetch('/api/projects/' + _wsProjectId + '/workspace/files?path=' + encodeURIComponent(path))
    
    .then(function(r){ return r.json(); })
    .then(function(data) {
      var items = data.items || [];
      if (!items.length) { tree.innerHTML = '<div style="padding:.75rem;color:var(--text-secondary);font-size:.72rem;text-align:center;">Dossier vide</div>'; return; }
      var html = path !== '.' ? '<div class="ws-tree-item" onclick="wsLoadFilesTree(\'.\')"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>..</div>' : '';
      items.filter(function(i){ return i.type==='dir'; }).forEach(function(i) {
        html += '<div class="ws-tree-item ws-tree-dir" onclick="wsLoadFilesTree(\'' + wsEsc(i.path) + '\')">' +
          '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>' + wsEsc(i.name) + '/</div>';
      });
      items.filter(function(i){ return i.type==='file'; }).forEach(function(i) {
        var sz = i.size > 1024 ? (i.size/1024).toFixed(1)+'KB' : i.size+'B';
        html += '<div class="ws-tree-item" onclick="wsOpenFile(\'' + wsEsc(i.path) + '\')">' +
          '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>' + wsEsc(i.name) + '<span class="ws-tree-size">' + sz + '</span></div>';
      });
      tree.innerHTML = html;
    });
}

function wsOpenFile(path) {
  var viewer = document.getElementById('wsFilesViewer');
  viewer.innerHTML = '<div class="ws-file-empty"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg></div>';
  wsFetch('/api/projects/' + _wsProjectId + '/workspace/file?path=' + encodeURIComponent(path))
    
    .then(function(r){ return r.json(); })
    .then(function(data) {
      if (data.error) { viewer.innerHTML = '<div class="ws-file-empty"><span style="color:var(--red)">' + wsEsc(data.error) + '</span></div>'; return; }
      var ext = path.split('.').pop().toLowerCase();
      var lm = {js:'javascript',ts:'typescript',py:'python',html:'html',css:'css',json:'json',yml:'yaml',yaml:'yaml',sh:'bash',md:'markdown',sql:'sql',rs:'rust',go:'go',java:'java'};
      var lang = lm[ext] || 'plaintext';
      viewer.innerHTML = '<div class="ws-file-bar"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg> ' + wsEsc(path) + '<span class="ws-badge" style="margin-left:auto">' + lang + '</span></div>';
      var pre = document.createElement('pre'); pre.className = 'ws-file-pre';
      var code = document.createElement('code'); code.className = 'language-' + lang;
      code.textContent = data.content || '';
      pre.appendChild(code); viewer.appendChild(pre);
      if (window.hljs) hljs.highlightElement(code);
    });
}

function wsLoadDocker() {
  var body = document.getElementById('wsDockerBody');
  wsFetch('/api/projects/' + _wsProjectId + '/workspace/docker')
    
    .then(function(r){ return r.json(); })
    .then(function(data) {
      var containers = data.containers || [];
      if (!containers.length) { body.innerHTML = '<div class="ws-empty-state"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg><span>Aucun container Docker pour ce projet</span><span class="ws-empty-hint">Les containers dont le nom contient l'ID du projet apparaissent ici</span></div>'; return; }
      body.innerHTML = containers.map(function(c) {
        var up = c.status && c.status.toLowerCase().startsWith('up');
        return '<div class="ws-docker-container">' +
          '<div class="ws-docker-header"><div class="ws-docker-status ' + (up?'up':'down') + '"></div>' +
          '<span class="ws-docker-name">' + wsEsc(c.name) + '</span>' +
          '<span class="ws-docker-image">' + wsEsc(c.image||'') + '</span>' +
          '<span style="margin-left:auto;font-size:.7rem;color:var(--text-secondary);">' + wsEsc(c.status||'') + '</span>' +
          (c.ports ? '<span class="ws-docker-port" onclick="wsDockPreview(\'' + wsEsc(c.ports) + '\')">' + wsEsc(c.ports) + '</span>' : '') + '</div>' +
          '<div class="ws-docker-actions">' +
          '<button class="ws-docker-btn" onclick="wsDockAction(\'' + wsEsc(c.name) + '\',\'start\')"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>Start</button>' +
          '<button class="ws-docker-btn" onclick="wsDockAction(\'' + wsEsc(c.name) + '\',\'stop\')"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>Stop</button>' +
          '<button class="ws-docker-btn" onclick="wsDockAction(\'' + wsEsc(c.name) + '\',\'rebuild\')"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>Rebuild</button>' +
          '</div><pre class="ws-docker-logs">' + wsEsc(c.logs||'— Aucun log —') + '</pre></div>';
      }).join('');
    });
}

function wsDockAction(name, action) {
  wsFetch('/api/projects/' + _wsProjectId + '/workspace/docker/' + encodeURIComponent(action), {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({container:name})})
    .then(function(){ setTimeout(wsLoadDocker, 1500); });
}

function wsDockPreview(ports) {
  var m = ports.match(/(\d{4,5})->/); if (!m) m = ports.match(/0\.0\.0\.0:(\d+)/);
  if (m) { var url='http://localhost:'+m[1]; document.getElementById('wsPreviewUrl').value=url; wsTab(document.querySelector('[data-tab="preview"]'),'preview'); setTimeout(function(){wsPreviewLoad(url);},100); }
}

function wsLoadAgents() {
  var body = document.getElementById('wsAgentsBody');
  wsFetch('/api/projects/' + _wsProjectId + '/workspace/agents')
    
    .then(function(r){ return r.json(); })
    .then(function(data) {
      var items = data.items || [];
      if (!items.length) { body.innerHTML = '<div class="ws-empty-state"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg><span>Aucun agent actif sur ce projet</span><span class="ws-empty-hint">Les agents apparaissent ici quand une mission est en cours</span></div>'; return; }
      body.innerHTML = items.map(function(a) {
        var pct = a.progress || 0;
        return '<div class="ws-agent-row">' +
          (a.avatar ? '<img class="ws-agent-avatar" src="' + wsEsc(a.avatar) + '" alt="">' : '<div class="ws-agent-avatar ws-agent-avatar-placeholder">' + wsEsc((a.agent_name||'?')[0]||'?') + '</div>') +
          '<div class="ws-agent-info"><div class="ws-agent-name">' + wsEsc(a.agent_name||a.agent_id) + '</div><div class="ws-agent-mission">' + wsEsc(a.mission_title||a.session_id) + '</div>' +
          (a.phase ? '<div class="ws-agent-phase">' + wsEsc(a.phase) + '</div>' : '') +
          '<div class="ws-progress-bar"><div class="ws-progress-fill" style="width:' + pct + '%"></div></div></div>' +
          '<span class="ws-badge ' + (a.status==='active'?'ws-badge-ok':'ws-badge-idle') + '">' + wsEsc(a.status||'') + '</span></div>';
      }).join('');
    });
}

function wsLoadGit() {
  var body = document.getElementById('wsGitBody');
  wsFetch('/api/projects/' + _wsProjectId + '/workspace/git')
    
    .then(function(r){ return r.json(); })
    .then(function(data) {
      var commits = data.commits || [], changes = data.changes || [], branch = data.branch || '';
      if (branch) { var el=document.getElementById('wsGitBranchName'); if(el){el.textContent=branch; document.getElementById('wsGitBranch').style.display='';} }
      var html = '';
      if (changes.length) {
        html += '<div class="ws-git-section-title">Modifications (' + changes.length + ')</div><div class="ws-git-changes">';
        changes.forEach(function(f){ var color=f.status==='M'?'#f0883e':f.status==='A'?'#3fb950':'#f85149'; html+='<div class="ws-git-change-row"><span style="color:'+color+';font-family:monospace;font-weight:700;width:16px;flex-shrink:0">'+wsEsc(f.status||'M')+'</span><span class="ws-git-change-path">'+wsEsc(f.path||f.file||'')+'</span></div>'; });
        html += '</div>';
      }
      html += '<div class="ws-git-form"><div class="ws-git-form-title">Commit rapide</div><textarea id="wsGitMsg" placeholder="feat: …" rows="2"></textarea><div class="ws-git-form-row"><label style="font-size:.72rem;display:flex;align-items:center;gap:.35rem;"><input type="checkbox" id="wsGitPush"> Push après commit</label><button class="btn btn-sm btn-primary" onclick="wsGitCommit()" style="margin-left:auto">Commit</button></div></div>';
      if (commits.length) {
        html += '<div class="ws-git-section-title">Historique</div><div class="ws-git-log">';
        commits.forEach(function(c){ html+='<div class="ws-git-commit"><span class="ws-git-sha">'+wsEsc((c.hash||'').substring(0,7))+'</span><span class="ws-git-msg">'+wsEsc(c.message||'')+'</span><span class="ws-git-meta">'+wsEsc(c.author||'')+' · '+wsEsc((c.date||'').substring(0,10))+'</span></div>'; });
        html += '</div>';
      }
      body.innerHTML = html || '<div class="ws-empty-state"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="18" cy="18" r="3"/><circle cx="6" cy="6" r="3"/><path d="M13 6h3a2 2 0 0 1 2 2v7M6 9v12"/></svg><span>Pas de dépôt Git ou dépôt vide</span></div>';
    });
}

function wsGitCommit() {
  var msg = document.getElementById('wsGitMsg').value.trim(); if (!msg) { alert('Message requis'); return; }
  var push = document.getElementById('wsGitPush').checked;
  wsSetStatus('Commit…', 'running');
  wsFetch('/api/projects/' + _wsProjectId + '/workspace/git/commit', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:msg,push:push})})
    
    .then(function(r){ return r.json(); })
    .then(function(d){ wsSetStatus('Prêt','idle'); if(d.ok){wsLoadGit();}else{alert(d.error||'Erreur');} });
}

function wsLoadPreview() { var url=document.getElementById('wsPreviewUrl').value.trim(); if(url) wsPreviewLoad(url); }

function wsPreviewLoad(url) {
  if (!url) url = document.getElementById('wsPreviewUrl').value.trim(); if (!url) return;
  document.getElementById('wsPreviewEmpty').style.display = 'none';
  var f = document.getElementById('wsPreviewFrame'); f.style.display = ''; f.src = url;
}

function wsPreviewToggleMobile() {
  _wsPreviewMobile = !_wsPreviewMobile;
  var f=document.getElementById('wsPreviewFrame'); var btn=document.getElementById('wsPreviewMobileBtn');
  if(f) f.classList.toggle('mobile',_wsPreviewMobile);
  if(btn) btn.style.color=_wsPreviewMobile?'var(--purple)':'';
}

function wsLoadLeftTree() {
  wsFetch('/api/projects/' + _wsProjectId + '/workspace/files?path=.')
    
    .then(function(r){ return r.json(); })
    .then(function(data) {
      var body = document.getElementById('wsTreeBody');
      var items = data.items || [];
      if (!items.length) { body.innerHTML = '<div style="padding:.75rem;color:var(--text-secondary);font-size:.72rem;text-align:center;">Chemin non accessible</div>'; return; }
      var html = '';
      items.slice(0,40).forEach(function(i) {
        var isDir = i.type==='dir';
        html += '<div class="ws-tree-item' + (isDir?' ws-tree-dir':'') + '" onclick="wsTab(document.querySelector(\'[data-tab=files]\'),\'files\');setTimeout(function(){' + (isDir?'wsLoadFilesTree':'wsOpenFile') + '(\'' + wsEsc(i.path) + '\')},50)">' +
          '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
          (isDir?'<path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>':'<path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/>')+
          '</svg>' + wsEsc(i.name) + '</div>';
      });
      body.innerHTML = html;
    }).catch(function(){ document.getElementById('wsTreeBody').innerHTML = '<div style="padding:.75rem;color:var(--text-secondary);font-size:.72rem;">Chemin non accessible</div>'; });
}

function wsSetStatus(text, state) { var el=document.getElementById('wsStatus'); if(!el) return; el.textContent=text; el.className='ws-badge ws-badge-status ws-badge-'+state; }

function wsEsc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

(function() {
  var saved = localStorage.getItem('ws_tab_' + _wsProjectId) || 'terminal';
  var btn = document.querySelector('[data-tab="' + saved + '"]');
  if (btn && saved !== 'terminal') wsTab(btn, saved);
  wsLoadTermHistory();
  wsLoadLeftTree();
  setInterval(function() { if(document.getElementById('ws-agents').classList.contains('active')) wsLoadAgents(); }, 10000);
})();
</script>
{% endblock %}
