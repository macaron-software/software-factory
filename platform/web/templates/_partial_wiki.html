<div class="wiki-container">
<style>
.wiki-container { display: flex; gap: 0; min-height: calc(100vh - 200px); }

/* Sidebar TOC */
.wiki-sidebar {
    width: 260px; min-width: 260px;
    border-right: 1px solid var(--border);
    padding: 1rem 0;
    overflow-y: auto;
    background: var(--bg-secondary);
    border-radius: var(--radius-xl, 12px) 0 0 var(--radius-xl, 12px);
}
.wiki-sidebar-header {
    padding: 0 1rem 0.75rem;
    display: flex; align-items: center; justify-content: space-between;
    border-bottom: 1px solid var(--border);
    margin-bottom: 0.5rem;
}
.wiki-sidebar-header h3 { margin: 0; font-size: 0.95rem; font-weight: 700; }
.wiki-search {
    width: calc(100% - 2rem); margin: 0.5rem 1rem 0.75rem;
    padding: 0.4rem 0.6rem; border-radius: 6px;
    background: var(--bg-primary); color: var(--text-primary);
    border: 1px solid var(--border); font-size: 0.8rem;
}
.wiki-search:focus { outline: none; border-color: var(--purple); }

.wiki-cat {
    padding: 0.3rem 1rem 0.2rem;
    font-size: 0.65rem; font-weight: 700; text-transform: uppercase;
    letter-spacing: 0.5px; color: var(--text-muted);
    margin-top: 0.5rem;
}
.wiki-link {
    display: flex; align-items: center; gap: 0.4rem;
    padding: 0.35rem 1rem 0.35rem 1.2rem;
    font-size: 0.82rem; color: var(--text-secondary);
    text-decoration: none; cursor: pointer;
    transition: all 0.15s; border-left: 2px solid transparent;
}
.wiki-link:hover { background: var(--bg-tertiary); color: var(--text-primary); }
.wiki-link.active {
    color: var(--purple-light, #a78bfa);
    border-left-color: var(--purple-light, #a78bfa);
    background: rgba(167,139,250,0.06);
    font-weight: 600;
}
.wiki-link-icon { font-size: 0.9rem; width: 1.2rem; text-align: center; }
.wiki-link-child { padding-left: 2rem; font-size: 0.78rem; }

/* Main content area */
.wiki-main {
    flex: 1; padding: 1.5rem 2rem;
    overflow-y: auto; max-height: calc(100vh - 200px);
}
.wiki-page-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 1.5rem; padding-bottom: 1rem;
    border-bottom: 1px solid var(--border);
}
.wiki-page-header h1 {
    margin: 0; font-size: 1.6rem; font-weight: 700;
    display: flex; align-items: center; gap: 0.5rem;
}
.wiki-page-header .wiki-actions { display: flex; gap: 0.5rem; }

.wiki-btn {
    padding: 0.35rem 0.8rem; border-radius: 6px;
    font-size: 0.8rem; font-weight: 500; cursor: pointer;
    border: 1px solid var(--border); background: var(--bg-secondary);
    color: var(--text-primary); transition: all 0.2s;
}
.wiki-btn:hover { border-color: var(--purple); background: var(--bg-tertiary); }
.wiki-btn-primary {
    background: var(--purple, #8b5cf6); color: #fff; border-color: transparent;
}
.wiki-btn-primary:hover { background: var(--purple-hover, #7c3aed); }

/* Markdown rendered content */
.wiki-content { line-height: 1.7; color: var(--text-primary); }
.wiki-content h1 { font-size: 1.5rem; font-weight: 700; margin: 2rem 0 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; }
.wiki-content h2 { font-size: 1.25rem; font-weight: 600; margin: 1.5rem 0 0.75rem; }
.wiki-content h3 { font-size: 1.1rem; font-weight: 600; margin: 1.2rem 0 0.5rem; }
.wiki-content p { margin: 0.5rem 0; }
.wiki-content code {
    background: var(--bg-tertiary); padding: 0.15rem 0.4rem;
    border-radius: 4px; font-size: 0.85em; font-family: 'SF Mono', 'Consolas', monospace;
}
.wiki-content pre {
    background: var(--bg-tertiary); padding: 1rem;
    border-radius: 8px; overflow-x: auto;
    border: 1px solid var(--border); margin: 1rem 0;
}
.wiki-content pre code { background: none; padding: 0; }
.wiki-content table {
    width: 100%; border-collapse: collapse; margin: 1rem 0;
    font-size: 0.85rem;
}
.wiki-content th, .wiki-content td {
    padding: 0.5rem 0.75rem; text-align: left;
    border: 1px solid var(--border);
}
.wiki-content th { background: var(--bg-tertiary); font-weight: 600; }
.wiki-content blockquote {
    margin: 1rem 0; padding: 0.5rem 1rem;
    border-left: 3px solid var(--purple, #8b5cf6);
    background: rgba(139, 92, 246, 0.05);
    color: var(--text-secondary);
}
.wiki-content ul, .wiki-content ol { padding-left: 1.5rem; }
.wiki-content li { margin: 0.25rem 0; }
.wiki-content img { max-width: 100%; border-radius: 8px; }
.wiki-content a { color: var(--purple-light, #a78bfa); }
.wiki-content hr { border: none; border-top: 1px solid var(--border); margin: 1.5rem 0; }

/* Editor */
.wiki-editor {
    width: 100%; min-height: 500px;
    background: var(--bg-primary); color: var(--text-primary);
    border: 1px solid var(--border); border-radius: 8px;
    padding: 1rem; font-family: 'SF Mono', 'Consolas', monospace;
    font-size: 0.85rem; line-height: 1.6; resize: vertical;
}
.wiki-editor:focus { outline: none; border-color: var(--purple); }

/* Empty state */
.wiki-empty {
    text-align: center; padding: 4rem 2rem; color: var(--text-muted);
}
.wiki-empty svg { width: 64px; height: 64px; margin-bottom: 1rem; opacity: 0.3; }
.wiki-empty h2 { font-size: 1.2rem; margin-bottom: 0.5rem; }

/* Print friendly */
@media print { .wiki-sidebar { display: none; } .wiki-main { padding: 0; } }
</style>

<!-- Sidebar -->
<div class="wiki-sidebar" id="wikiSidebar">
    <div class="wiki-sidebar-header">
        <h3><svg class="icon icon-xs" style="vertical-align:-2px"><use href="#icon-book-open"/></svg> Wiki</h3>
        <button class="wiki-btn wiki-btn-primary" style="font-size:0.7rem;padding:0.2rem 0.5rem" onclick="wikiNewPage()">+ New</button>
    </div>
    <input type="text" class="wiki-search" id="wikiSearch" placeholder="Search pages..." oninput="wikiFilter(this.value)">

    <div id="wikiTOC">
    {% set current_cat = namespace(val='') %}
    {% for p in pages %}
        {% if p.category != current_cat.val %}
            {% set current_cat.val = p.category %}
            <div class="wiki-cat">{{ p.category }}</div>
        {% endif %}
        <a class="wiki-link {% if page and page.slug == p.slug %}active{% endif %} {% if p.parent_slug %}wiki-link-child{% endif %}"
           hx-get="/wiki/{{ p.slug }}" hx-target="#wikiMain" hx-swap="innerHTML"
           data-title="{{ p.title|lower }}">
            {{ p.title }}
        </a>
    {% endfor %}
    </div>
</div>

<!-- Main content -->
<div class="wiki-main" id="wikiMain">
{% if page %}
    <div class="wiki-page-header">
        <h1>{{ page.title }}</h1>
        <div class="wiki-actions">
            <button class="wiki-btn" onclick="wikiToggleEdit('{{ page.slug }}')">
                <svg class="icon icon-xs" style="vertical-align:-1px"><use href="#icon-edit-2"/></svg> Edit
            </button>
            <button class="wiki-btn" onclick="window.print()">
                <svg class="icon icon-xs" style="vertical-align:-1px"><use href="#icon-printer"/></svg>
            </button>
        </div>
    </div>
    <div class="wiki-content" id="wikiContent"></div>
    <textarea class="wiki-editor" id="wikiEditor" style="display:none">{{ page.content }}</textarea>
    <div id="wikiEditActions" style="display:none;margin-top:1rem;display:flex;gap:0.5rem">
        <button class="wiki-btn wiki-btn-primary" onclick="wikiSave('{{ page.slug }}')">Save</button>
        <button class="wiki-btn" onclick="wikiCancelEdit()">Cancel</button>
    </div>

    <script>
    // Render markdown via marked.js (loaded from CDN if needed)
    (function() {
        const raw = document.getElementById('wikiEditor').value;
        if (!window.marked) {
            const s = document.createElement('script');
            s.src = 'https://cdn.jsdelivr.net/npm/marked@12/marked.min.js';
            s.onload = () => {
                document.getElementById('wikiContent').innerHTML = marked.parse(raw);
            };
            document.head.appendChild(s);
        } else {
            document.getElementById('wikiContent').innerHTML = marked.parse(raw);
        }
    })();
    </script>
{% else %}
    {% if pages|length > 0 %}
    <script>
    // Auto-load getting-started if pages exist but none selected
    (function() {
        const firstSlug = '{{ pages[0].slug }}';
        const target = document.getElementById('wikiMain');
        const preferred = ['getting-started', firstSlug];
        for (const slug of preferred) {
            const link = document.querySelector('.wiki-link[href="/wiki/' + slug + '"]');
            if (link) { link.click(); break; }
        }
    })();
    </script>
    {% else %}
    <div class="wiki-empty">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
            <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
        </svg>
        <h2>Software Factory Wiki</h2>
        <p>No pages found. Seed the wiki to get started.</p>
        <button class="wiki-btn wiki-btn-primary" style="margin-top:1rem" onclick="wikiSeed()">
            Initialize Wiki
        </button>
    </div>
    {% endif %}
{% endif %}
</div>

<script>
function wikiFilter(q) {
    q = q.toLowerCase();
    document.querySelectorAll('#wikiTOC .wiki-link').forEach(a => {
        a.style.display = a.dataset.title.includes(q) ? '' : 'none';
    });
    document.querySelectorAll('#wikiTOC .wiki-cat').forEach(c => {
        const next = [];
        let sib = c.nextElementSibling;
        while (sib && !sib.classList.contains('wiki-cat')) {
            next.push(sib); sib = sib.nextElementSibling;
        }
        c.style.display = next.some(n => n.style.display !== 'none') ? '' : 'none';
    });
}

let _editing = false;
function wikiToggleEdit(slug) {
    _editing = !_editing;
    document.getElementById('wikiContent').style.display = _editing ? 'none' : '';
    document.getElementById('wikiEditor').style.display = _editing ? '' : 'none';
    document.getElementById('wikiEditActions').style.display = _editing ? 'flex' : 'none';
}

function wikiCancelEdit() {
    _editing = false;
    document.getElementById('wikiContent').style.display = '';
    document.getElementById('wikiEditor').style.display = 'none';
    document.getElementById('wikiEditActions').style.display = 'none';
}

async function wikiSave(slug) {
    const content = document.getElementById('wikiEditor').value;
    const title = document.querySelector('.wiki-page-header h1')?.textContent?.trim() || slug;
    await fetch('/api/wiki/' + slug, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({content, title})
    });
    document.getElementById('wikiContent').innerHTML = marked.parse(content);
    wikiCancelEdit();
}

function wikiNewPage() {
    const title = prompt('Page title:');
    if (!title) return;
    const slug = title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
    fetch('/api/wiki', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({slug, title, content: '# ' + title + '\n\nNew page content.'})
    }).then(() => {
        htmx.ajax('GET', '/wiki/' + slug, {target: '#tab-content', swap: 'innerHTML'});
    });
}

async function wikiSeed() {
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = 'Initializing...';
    try {
        const res = await fetch('/api/wiki/seed', {method: 'POST'});
        const data = await res.json();
        if (data.success) {
            htmx.ajax('GET', '/wiki', {target: '#tab-content', swap: 'innerHTML'});
        }
    } catch(e) { alert('Error: ' + e.message); }
}

// Active link tracking after HTMX swap
document.body.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.detail.target.id === 'wikiMain') {
        document.querySelectorAll('.wiki-link').forEach(a => a.classList.remove('active'));
        if (evt.detail.requestConfig?.path) {
            const slug = evt.detail.requestConfig.path.replace('/wiki/', '');
            const link = document.querySelector(`.wiki-link[hx-get="/wiki/${slug}"]`);
            if (link) link.classList.add('active');
        }
    }
});
</script>
</div>
