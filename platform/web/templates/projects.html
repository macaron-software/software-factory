{% extends "base.html" %}

{% block topbar_actions %}
{% include "partials/view_switcher.html" %}
<a href="/sessions/new" class="btn btn-primary">
    <svg class="icon icon-sm"><use href="#icon-plus"/></svg> New
</a>
{% endblock %}

{% block content %}
{% set persp = request.state.perspective|default('admin') %}

{% if persp == 'developer' %}
<div style="display:flex;align-items:center;gap:0.75rem;padding:0.5rem 1rem;margin-bottom:1rem;font-size:0.82rem">
    <svg class="icon icon-sm" style="color:var(--purple-light)"><use href="#icon-folder"/></svg>
    <span style="font-weight:600">My Projects</span>
    <label style="margin-left:auto;display:flex;align-items:center;gap:0.4rem;cursor:pointer;color:var(--text-secondary);font-size:0.78rem">
        <input type="checkbox" id="filterMyProjects" onchange="filterProjects()" style="accent-color:var(--purple)"> Show only assigned
    </label>
</div>
{% endif %}

<div class="item-grid" data-view-grid data-view="card">
    {% for proj in projects %}
    <a href="/projects/{{ proj.info.id }}" class="item-card" data-lead="{{ proj.info.lead_agent_id or '' }}">
        <div class="item-icon">
            <span class="project-type-dot {{ proj.info.factory_type }}"></span>
        </div>
        <div class="item-main">
            <div class="item-title">{{ proj.info.name }}</div>
            <div class="item-subtitle">{{ proj.info.factory_type | upper }}{% if proj.info.domains %} · {{ proj.info.domains[:2] | join(', ') }}{% endif %}</div>
            <div class="item-detail">
                {% if proj.info.vision %}
                <p class="item-desc">{{ proj.info.vision[:140] }}{% if proj.info.vision|length > 140 %}…{% endif %}</p>
                {% elif proj.info.description %}
                <p class="item-desc">{{ proj.info.description[:140] }}{% if proj.info.description|length > 140 %}…{% endif %}</p>
                {% endif %}
                {% if proj.info.values %}
                <div class="item-tags">
                    {% for v in proj.info.values[:3] %}
                    <span class="item-tag">{{ v }}</span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
        <div class="item-meta">
            <span hx-get="/api/dashboard/quality-badge?project_id={{ proj.info.id }}" hx-trigger="load" hx-swap="innerHTML"></span>
            {% if proj.info.has_git %}
            <span class="item-badge" hx-get="/api/projects/{{ proj.info.id }}/git-status" hx-trigger="load" hx-swap="innerHTML">…</span>
            {% endif %}
            {% if proj.info.lead_agent_id %}
            <span class="item-badge accent">{{ proj.info.lead_agent_id }}</span>
            {% endif %}
        </div>
    </a>
    {% endfor %}
    {% if not projects %}
    <div class="empty-state">
        <p>{{ _("no_projects_found") }}</p>
    </div>
    {% endif %}
</div>
{% if persp == 'developer' %}
<script>
function filterProjects() {
    const show = document.getElementById('filterMyProjects').checked;
    document.querySelectorAll('.item-card').forEach(card => {
        const lead = card.dataset.lead || '';
        card.style.display = (show && !lead) ? 'none' : '';
    });
}
</script>
{% endif %}
{% endblock %}
