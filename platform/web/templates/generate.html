{% extends "base.html" %}

{% block content %}
<style>
.gen-container { max-width: 720px; margin: 0 auto; padding: 2rem 1rem; }
.gen-title { font-size: 1.5rem; font-weight: 600; margin-bottom: 0.5rem; }
.gen-subtitle { color: var(--text-secondary); margin-bottom: 2rem; font-size: 0.9rem; }
.gen-form { display: flex; flex-direction: column; gap: 1rem; }
.gen-textarea {
    width: 100%; min-height: 140px; padding: 1rem;
    background: var(--bg-secondary); color: var(--text-primary);
    border: 1px solid var(--border); border-radius: 8px;
    font-size: 0.95rem; font-family: inherit; resize: vertical;
}
.gen-textarea:focus { outline: none; border-color: var(--accent); }
.gen-textarea::placeholder { color: var(--text-muted); }
.gen-btn {
    padding: 0.75rem 1.5rem; border: none; border-radius: 8px;
    background: var(--accent); color: #fff; font-weight: 600;
    font-size: 1rem; cursor: pointer; align-self: flex-end;
    display: flex; align-items: center; gap: 0.5rem;
    transition: opacity 0.2s;
}
.gen-btn:hover { opacity: 0.9; }
.gen-btn:disabled { opacity: 0.5; cursor: wait; }
.gen-result {
    margin-top: 1.5rem; padding: 1rem;
    background: var(--bg-secondary); border-radius: 8px;
    border: 1px solid var(--border); display: none;
}
.gen-result.show { display: block; }
.gen-result h3 { margin: 0 0 0.5rem 0; font-size: 1.1rem; }
.gen-team-list { list-style: none; padding: 0; margin: 0.5rem 0; }
.gen-team-list li { padding: 0.25rem 0; display: flex; align-items: center; gap: 0.5rem; }
.gen-badge {
    display: inline-block; padding: 2px 8px; border-radius: 4px;
    font-size: 0.75rem; font-weight: 600;
}
.gen-badge--ok { background: #16a34a22; color: #16a34a; }
.gen-badge--err { background: #dc262622; color: #dc2626; }
.gen-spinner { display: none; }
.gen-spinner.active { display: inline-block; animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.gen-examples {
    margin-top: 1.5rem; padding: 1rem;
    background: var(--bg-secondary); border-radius: 8px;
    border: 1px solid var(--border);
}
.gen-examples h4 { margin: 0 0 0.75rem 0; font-size: 0.85rem; color: var(--text-secondary); }
.gen-example-btn {
    display: block; width: 100%; text-align: left;
    padding: 0.5rem 0.75rem; margin-bottom: 0.5rem;
    background: var(--bg-primary); border: 1px solid var(--border);
    border-radius: 6px; color: var(--text-primary);
    cursor: pointer; font-size: 0.85rem;
    transition: border-color 0.2s;
}
.gen-example-btn:hover { border-color: var(--accent); }
</style>

<div class="gen-container">
    <div class="gen-title"><svg class="icon icon-sm" style="vertical-align:-2px"><use href="#icon-lightning"/></svg> Team & Workflow Generator</div>
    <div class="gen-subtitle">
        {{ _('gen_subtitle') }}
    </div>

    <form class="gen-form" id="genForm">
        <textarea class="gen-textarea" id="genPrompt" name="prompt"
            placeholder="{{ _('gen_placeholder') }}"></textarea>
        <button type="submit" class="gen-btn" id="genBtn">
            <span class="gen-spinner" id="genSpinner"><svg class="icon icon-sm spin"><use href="#icon-loader"/></svg></span>
            <svg class="icon icon-sm"><use href="#icon-lightning"/></svg>
            {{ _('generate_launch') }}
        </button>
    </form>

    <div class="gen-result" id="genResult">
        <h3 id="genResultTitle"></h3>
        <ul class="gen-team-list" id="genTeamList"></ul>
        <p id="genResultMsg" style="margin: 0.5rem 0 0; font-size: 0.85rem; color: var(--text-secondary);"></p>
    </div>

    <div class="gen-examples">
        <h4>{{ _("exemples_de_prompts") }}</h4>
        <button class="gen-example-btn" onclick="fillPrompt(this)">{{ _("angular_16_17_migration_with_3") }}</button>
        <button class="gen-example-btn" onclick="fillPrompt(this)">{{ _("develop_a_rust_rest_api_with") }}</button>
        <button class="gen-example-btn" onclick="fillPrompt(this)">{{ _("node_js_microservices_refactoring_4_fullstack") }}</button>
        <button class="gen-example-btn" onclick="fillPrompt(this)">{{ _("application_mobile_ios_android_2_devs") }}</button>
        <button class="gen-example-btn" onclick="fillPrompt(this)">{{ _("full_security_audit_1_security_engineer") }}</button>
    </div>
</div>

<script>
function fillPrompt(btn) {
    document.getElementById('genPrompt').value = btn.textContent.trim();
}

document.getElementById('genForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('genBtn');
    const spinner = document.getElementById('genSpinner');
    const result = document.getElementById('genResult');
    const prompt = document.getElementById('genPrompt').value.trim();
    if (!prompt) return;

    btn.disabled = true;
    spinner.classList.add('active');
    result.classList.remove('show');

    try {
        const formData = new FormData();
        formData.append('prompt', prompt);
        const resp = await fetch('/api/generate-team', { method: 'POST', body: formData });
        const data = await resp.json();

        if (data.error) {
            document.getElementById('genResultTitle').textContent = _('error');
            document.getElementById('genTeamList').innerHTML = '';
            document.getElementById('genResultMsg').textContent = data.error;
            result.classList.add('show');
        } else {
            document.getElementById('genResultTitle').textContent = `Équipe de ${data.team_size} agents générée`;
            const list = document.getElementById('genTeamList');
            list.innerHTML = data.agents.map(a =>
                `<li><span class="gen-badge gen-badge--ok">ok</span> ${a}</li>`
            ).join('');
            document.getElementById('genResultMsg').textContent = 'Redirection vers la session live...';
            result.classList.add('show');
            setTimeout(() => { window.location.href = data.redirect; }, 1500);
        }
    } catch (err) {
        document.getElementById('genResultTitle').textContent = _('error_network');
        document.getElementById('genResultMsg').textContent = err.message;
        result.classList.add('show');
    } finally {
        btn.disabled = false;
        spinner.classList.remove('active');
    }
});
</script>
{% endblock %}
