{# CTO Chat Panel ‚Äî htmx partial loaded in Portfolio tab #}
<style>
/* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.cto-shell{display:flex;height:calc(100vh - 120px);min-height:420px;background:var(--bg-secondary);border-radius:10px;overflow:hidden;border:1px solid var(--border)}

/* ‚îÄ‚îÄ Left Sidebar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.cto-sidebar{width:220px;min-width:180px;max-width:260px;display:flex;flex-direction:column;border-right:1px solid var(--border);background:var(--bg-primary);flex-shrink:0}
.cto-sidebar-top{padding:.75rem .65rem .5rem;border-bottom:1px solid var(--border)}
.cto-new-btn{width:100%;display:flex;align-items:center;gap:.5rem;background:var(--accent,#6366f1);color:#fff;border:none;border-radius:7px;padding:.5rem .75rem;font-size:.78rem;font-weight:600;cursor:pointer;transition:opacity .15s}
.cto-new-btn:hover{opacity:.85}
.cto-new-btn svg{flex-shrink:0}
.cto-search-wrap{padding:.45rem .65rem .3rem;position:relative}
.cto-search-input{width:100%;box-sizing:border-box;background:var(--bg-secondary);border:1px solid var(--border);border-radius:6px;padding:.32rem .55rem .32rem 1.6rem;font-size:.72rem;color:var(--text);outline:none;transition:border-color .15s}
.cto-search-input:focus{border-color:var(--accent,#6366f1)}
.cto-search-input::placeholder{color:var(--text-muted)}
.cto-search-icon{position:absolute;left:1rem;top:50%;transform:translateY(-50%);color:var(--text-muted);pointer-events:none;opacity:.65}
.cto-sidebar-label{font-size:.62rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.06em;padding:.6rem .75rem .3rem}
.cto-conv-list{flex:1;overflow-y:auto;padding:.2rem .4rem .5rem}
.cto-conv-item{display:flex;align-items:center;gap:.4rem;padding:.45rem .55rem;border-radius:6px;cursor:pointer;border:1px solid transparent;transition:background .12s;position:relative;group:true}
.cto-conv-item:hover{background:var(--bg-tertiary)}
.cto-conv-item.active{background:var(--accent-subtle,rgba(99,102,241,.12));border-color:var(--accent,#6366f1)}
.cto-conv-icon{color:var(--text-muted);flex-shrink:0;opacity:.6}
.cto-conv-item.active .cto-conv-icon{opacity:1;color:var(--accent,#6366f1)}
.cto-conv-text{flex:1;min-width:0}
.cto-conv-title{font-size:.75rem;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.3}
.cto-conv-item.active .cto-conv-title{color:var(--accent,#6366f1);font-weight:600}
.cto-conv-date{font-size:.62rem;color:var(--text-muted);margin-top:1px}
.cto-conv-snippet{font-size:.62rem;color:var(--text-muted);margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-style:italic}
.cto-sidebar-footer{padding:.6rem .65rem;border-top:1px solid var(--border);display:flex;align-items:center;gap:.5rem}
.cto-agent-mini-avatar{width:28px;height:28px;border-radius:50%;object-fit:cover;border:1.5px solid var(--border);flex-shrink:0}
.cto-agent-mini-name{font-size:.72rem;font-weight:600;color:var(--text)}
.cto-agent-mini-dot{width:6px;height:6px;border-radius:50%;background:var(--success);flex-shrink:0;margin-left:auto}

/* ‚îÄ‚îÄ Chat area ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.cto-main{flex:1;display:flex;flex-direction:column;min-width:0}
.cto-header{display:flex;align-items:center;gap:.75rem;padding:.75rem 1.1rem .65rem;border-bottom:1px solid var(--border);background:var(--bg-secondary)}
.cto-header-avatar{width:38px;height:38px;border-radius:50%;object-fit:cover;border:2px solid var(--border);flex-shrink:0}
.cto-header-info{flex:1;min-width:0}
.cto-header-name{font-weight:700;font-size:.9rem;color:var(--text)}
.cto-header-role{font-size:.68rem;color:var(--text-muted);margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cto-header-status{display:flex;align-items:center;gap:.35rem;font-size:.68rem;color:var(--success);flex-shrink:0}
.cto-header-dot{width:6px;height:6px;border-radius:50%;background:var(--success);animation:pulse-dot 2s infinite}
@keyframes pulse-dot{0%,100%{opacity:1}50%{opacity:.4}}

/* chips */
.cto-chips{display:flex;flex-wrap:wrap;gap:.35rem;padding:.5rem 1.1rem;border-bottom:1px solid var(--border)}
.cto-chip{display:inline-flex;align-items:center;gap:.28rem;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:20px;padding:.22rem .65rem;font-size:.7rem;cursor:pointer;color:var(--text-muted);transition:all .15s;white-space:nowrap}
.cto-chip:hover{background:var(--accent-subtle,rgba(99,102,241,.1));border-color:var(--accent,#6366f1);color:var(--text)}
.cto-chip-project{background:rgba(99,102,241,.07);border-color:rgba(99,102,241,.3);color:var(--accent,#6366f1)}
.cto-chip-project:hover{background:rgba(99,102,241,.18);border-color:var(--accent,#6366f1);color:var(--text)}
.cto-chip-debt{background:rgba(245,158,11,.07);border-color:rgba(245,158,11,.3);color:#d97706}
.cto-chip-debt:hover{background:rgba(245,158,11,.18);border-color:#d97706;color:var(--text)}
.cto-messages{flex:1;overflow-y:auto;padding:.9rem 1.1rem;display:flex;flex-direction:column;gap:.7rem}
.cto-messages:empty::after{content:"Posez une question √† Karim‚Ä¶";color:var(--text-muted);font-size:.82rem;margin:auto;display:block;text-align:center;padding-top:2.5rem}
.cto-messages .chat-msg{max-width:80%;animation:fadeUp .18s ease}
.cto-messages .chat-msg-user{margin-left:auto}
.cto-messages .chat-msg-agent{margin-right:auto;display:flex;gap:.5rem;align-items:flex-start}
.cto-avatar{width:30px;height:30px;border-radius:50%;background:url('/static/avatars/strat-cto.jpg') center/cover;flex-shrink:0;border:1.5px solid var(--border)}
.cto-messages .chat-msg-body{background:var(--bg-tertiary);border:1px solid var(--border);border-radius:12px;padding:.6rem .8rem;max-width:100%}
.cto-messages .chat-msg-user .chat-msg-body{background:var(--accent-subtle,rgba(99,102,241,.12));border-color:var(--accent,#6366f1)}
.cto-messages .chat-msg-sender{font-size:.65rem;font-weight:700;color:var(--accent,#6366f1);margin-bottom:.2rem}
.cto-messages .chat-msg-text{font-size:.83rem;color:var(--text);line-height:1.5}
.cto-messages .chat-msg-text.md-rendered p{margin:0 0 .25rem}
.cto-messages .chat-msg-text.md-rendered p:last-child{margin-bottom:0}
.cto-messages .chat-msg-text.md-rendered ul,.cto-messages .chat-msg-text.md-rendered ol{margin:.2rem 0 .25rem 1.2rem;padding:0}
.cto-messages .chat-msg-text.md-rendered li{margin-bottom:.1rem}
.cto-messages .chat-msg-text.md-rendered h1,.cto-messages .chat-msg-text.md-rendered h2,.cto-messages .chat-msg-text.md-rendered h3,.cto-messages .chat-msg-text.md-rendered h4{margin:.35rem 0 .15rem;font-size:.88rem}
.cto-messages .chat-msg-text.md-rendered br{display:none}
.cto-drop-overlay{display:none;position:absolute;inset:0;z-index:20;background:rgba(99,102,241,.08);border:2px dashed var(--accent,#6366f1);border-radius:10px;align-items:center;justify-content:center;flex-direction:column;gap:.5rem;font-size:.85rem;color:var(--accent,#6366f1);font-weight:600;pointer-events:none}
.cto-drop-overlay.active{display:flex!important}
/* guardrail confirmation modal */
.cto-confirm-overlay{display:none;position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.45);align-items:center;justify-content:center}
.cto-confirm-overlay.active{display:flex}
.cto-confirm-box{background:var(--bg-secondary);border:1px solid var(--border);border-radius:12px;padding:1.4rem 1.6rem;max-width:420px;width:90%;box-shadow:0 8px 32px rgba(0,0,0,.3)}
.cto-confirm-title{font-size:.92rem;font-weight:700;color:var(--text);margin-bottom:.5rem}
.cto-confirm-sub{font-size:.78rem;color:var(--text-muted);margin-bottom:1.1rem;line-height:1.5}
.cto-confirm-preview{background:var(--bg-tertiary);border:1px solid var(--border);border-radius:6px;padding:.55rem .7rem;font-size:.72rem;color:var(--text-muted);margin-bottom:1rem;max-height:80px;overflow:hidden;text-overflow:ellipsis;white-space:pre-wrap;word-break:break-word}
.cto-confirm-actions{display:flex;gap:.5rem;justify-content:flex-end}
.cto-confirm-btn-cancel{background:var(--bg-tertiary);border:1px solid var(--border);border-radius:7px;padding:.4rem 1rem;font-size:.78rem;cursor:pointer;color:var(--text-muted)}
.cto-confirm-btn-ok{background:var(--accent,#6366f1);border:none;border-radius:7px;padding:.4rem 1rem;font-size:.78rem;cursor:pointer;color:#fff;font-weight:600}
.cto-confirm-btn-cancel:hover{background:var(--bg-primary)}
.cto-confirm-btn-ok:hover{opacity:.85}
.cto-messages .chat-msg-text.md-rendered code{background:var(--bg-primary);padding:.1em .3em;border-radius:3px;font-size:.78em}
.cto-messages .chat-msg-text.md-rendered pre{background:var(--bg-primary);border-radius:6px;padding:.7rem;overflow-x:auto;font-size:.76rem;margin:.35rem 0}
.cto-messages .chat-msg-tools{display:flex;flex-wrap:wrap;gap:.25rem;margin-top:.35rem}
.cto-creation-card{display:flex;align-items:center;gap:.6rem;padding:.5rem .75rem;margin-top:.5rem;background:var(--bg-tertiary);border:1px solid var(--border);border-left:3px solid var(--accent,#6366f1);border-radius:8px}
.cto-creation-project{align-items:flex-start}
.cto-creation-icon{font-size:1.1rem;flex-shrink:0;padding-top:.1rem}
.cto-creation-info{flex:1;min-width:0}
.cto-creation-title{font-weight:600;font-size:.82rem;color:var(--text);display:flex;align-items:center;gap:.4rem}
.cto-creation-sub{font-size:.73rem;color:var(--text-muted);margin-top:.1rem}
.cto-creation-badge{font-size:.68rem;background:rgba(16,185,129,.15);color:#10b981;border-radius:4px;padding:.1rem .35rem}
.cto-creation-missions{display:flex;flex-wrap:wrap;gap:.3rem;margin-top:.4rem}
.cto-mission-chip{font-size:.72rem;padding:.2rem .5rem;background:var(--bg-secondary);border:1px solid var(--border);border-radius:20px;color:var(--text-muted);text-decoration:none;white-space:nowrap}
.cto-mission-chip:hover{border-color:var(--accent,#6366f1);color:var(--accent,#6366f1)}
.cto-creation-link{font-size:.75rem;font-weight:500;color:var(--accent,#6366f1);white-space:nowrap;text-decoration:none;flex-shrink:0}
.cto-creation-link:hover{text-decoration:underline}
.cto-thinking{display:flex;align-items:center;gap:.5rem;font-size:.75rem;color:var(--text-muted);padding:.3rem 0 .3rem 1.1rem}
.cto-thinking-dots{display:flex;gap:4px;padding:4px 0}
.cto-thinking-dots span{width:6px;height:6px;border-radius:50%;background:var(--accent,#6366f1);animation:dotPulse 1.4s ease-in-out infinite}
.cto-thinking-dots span:nth-child(2){animation-delay:.2s}
.cto-thinking-dots span:nth-child(3){animation-delay:.4s}

/* input */
.cto-input-area{display:flex;flex-direction:column;gap:.3rem;padding:.65rem 1.1rem;border-top:1px solid var(--border);background:var(--bg-secondary)}
.cto-input-row{display:flex;gap:.45rem;align-items:flex-end}
.cto-input{flex:1;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:8px;padding:.5rem .8rem;font-size:.83rem;color:var(--text);resize:none;line-height:1.4;max-height:110px;transition:border-color .15s}
.cto-input:focus{outline:none;border-color:var(--accent,#6366f1)}
.cto-send{background:var(--accent,#6366f1);color:#fff;border:none;border-radius:8px;padding:.5rem .9rem;cursor:pointer;font-size:.8rem;font-weight:600;transition:opacity .15s;white-space:nowrap;display:flex;align-items:center;gap:.35rem}
.cto-send:hover{opacity:.85}
.cto-send.loading{opacity:.5;pointer-events:none}
/* file button */
.cto-file-btn{background:var(--bg-tertiary);border:1px solid var(--border);border-radius:8px;padding:.5rem .6rem;cursor:pointer;color:var(--text-muted);transition:all .15s;display:flex;align-items:center;flex-shrink:0}
.cto-file-btn:hover{border-color:var(--accent,#6366f1);color:var(--accent,#6366f1)}
/* attachment bar */
.cto-attach-bar{display:none;align-items:center;gap:.5rem;padding:.25rem 0}
.cto-attach-bar.visible{display:flex}
.cto-attach-pill{display:flex;align-items:center;gap:.35rem;background:rgba(99,102,241,.1);border:1px solid rgba(99,102,241,.35);border-radius:20px;padding:.18rem .6rem;font-size:.72rem;color:var(--accent,#6366f1);max-width:260px}
.cto-attach-pill span{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:200px}
.cto-attach-clear{cursor:pointer;opacity:.6;flex-shrink:0;line-height:1}
.cto-attach-clear:hover{opacity:1}
.cto-attach-hint{font-size:.68rem;color:var(--text-muted)}
/* @ mention */
.cto-mention-popup{position:absolute;bottom:calc(100% + 4px);left:0;right:0;background:var(--bg-primary);border:1px solid var(--border);border-radius:8px;box-shadow:0 4px 18px rgba(0,0,0,.14);z-index:50;max-height:220px;overflow-y:auto;display:none}
.cto-mention-popup.open{display:block}
.cto-mention-item{display:flex;align-items:center;gap:.55rem;padding:.48rem .8rem;font-size:.8rem;cursor:pointer;color:var(--text);transition:background .1s}
.cto-mention-item:hover,.cto-mention-item.active{background:var(--accent-subtle,rgba(99,102,241,.1));color:var(--accent,#6366f1)}
.cto-mention-item svg{flex-shrink:0;opacity:.55}
.cto-mention-item .mi-name{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
.cto-mention-item .mi-stack{font-size:.66rem;color:var(--text-muted);white-space:nowrap}
.cto-mention-item.mi-empty .mi-name{opacity:.7}
.cto-mention-item.mi-empty .mi-stack{color:#f0883e}
.mi-badge-agent{font-size:.58rem;background:rgba(99,102,241,.15);color:var(--accent,#6366f1);border-radius:3px;padding:1px 5px;margin-right:.3rem;flex-shrink:0}
/* @project / #agent badges in chat bubbles */
.mention-badge-project{display:inline-flex;align-items:center;background:rgba(59,130,246,.15);color:#3b82f6;border:1px solid rgba(59,130,246,.3);border-radius:12px;padding:0 8px;font-size:.78rem;font-weight:600;white-space:nowrap;vertical-align:middle;line-height:1.6;margin:0 1px}
.mention-badge-agent{display:inline-flex;align-items:center;background:rgba(139,92,246,.15);color:#8b5cf6;border:1px solid rgba(139,92,246,.3);border-radius:12px;padding:0 8px;font-size:.78rem;font-weight:600;white-space:nowrap;vertical-align:middle;line-height:1.6;margin:0 1px}
/* Invited agent bubble ‚Äî visually distinct from CTO */
.chat-msg-invited{position:relative}
.chat-msg-invited .chat-msg-body{
  background:rgba(16,185,129,.06)!important;
  border:1px solid rgba(16,185,129,.25)!important;
  border-radius:12px;
  padding:.55rem .8rem;
}
.chat-msg-invited .chat-msg-sender{color:#10b981!important;font-size:.65rem;font-weight:700;margin-bottom:.25rem}
.invited-avatar-img{width:30px;height:30px;border-radius:50%;object-fit:cover;border:1.5px solid rgba(16,185,129,.4);flex-shrink:0}
.invited-avatar,.invited-avatar-initials{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#10b981,#059669)!important;color:#fff!important;font-size:.6rem!important;font-weight:700;flex-shrink:0}
.invited-divider{display:flex;align-items:center;gap:.5rem;margin:.4rem 0 .3rem;font-size:.65rem;color:var(--text-muted);opacity:.6}
.invited-divider::before,.invited-divider::after{content:'';flex:1;height:1px;background:rgba(16,185,129,.25)}

@keyframes dotPulse{0%,80%,100%{opacity:.25;transform:scale(.8)}40%{opacity:1;transform:scale(1)}}
@keyframes fadeUp{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}
/* retry */
.cto-retry-bar{display:flex;align-items:center;gap:.55rem;padding:.45rem .8rem;background:rgba(239,68,68,.07);border-radius:8px;font-size:.78rem;color:var(--danger,#ef4444);margin:.2rem 0}
.cto-retry-bar .retry-msg{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:.75rem}
.cto-retry-btn{background:none;border:1px solid currentColor;border-radius:6px;padding:.22rem .6rem;font-size:.72rem;cursor:pointer;color:inherit;transition:all .12s;white-space:nowrap}
.cto-retry-btn:hover{background:rgba(239,68,68,.12)}
.cto-retry-btn.edit{color:var(--text-muted);border-color:var(--border)}
.cto-retry-btn.edit:hover{background:var(--bg-tertiary)}
.cto-retry-bar{display:flex;align-items:center;gap:.55rem;padding:.45rem .8rem;background:rgba(239,68,68,.07);border-radius:8px;font-size:.78rem;color:var(--danger,#ef4444);margin:.2rem 0}
.cto-retry-bar svg{flex-shrink:0;opacity:.75}
.cto-retry-bar .retry-msg{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.cto-retry-btn{background:none;border:1px solid currentColor;border-radius:6px;padding:.22rem .6rem;font-size:.72rem;cursor:pointer;color:inherit;transition:all .12s;white-space:nowrap}
.cto-retry-btn:hover{background:rgba(239,68,68,.12)}
.cto-retry-btn.edit{color:var(--text-muted);border-color:var(--border)}

/* Responsive: hide sidebar on small screens */
@media(max-width:640px){.cto-sidebar{display:none}}
</style>

<div class="cto-shell">

  {# ‚îÄ‚îÄ Left Sidebar ‚îÄ‚îÄ #}
  <div class="cto-sidebar">
    <div class="cto-sidebar-top">
      <button class="cto-new-btn" onclick="ctoNewConversation()">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Nouvelle conversation
      </button>
    </div>

    <div class="cto-search-wrap">
      <svg class="cto-search-icon" width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <input class="cto-search-input" id="cto-search-input" type="text" placeholder="Rechercher‚Ä¶" autocomplete="off" oninput="ctoSearchConvs(this.value)">
    </div>

    <div class="cto-sidebar-label" id="cto-hist-label">Historique</div>

    <div class="cto-conv-list" id="cto-conv-list">
      {% for item in sidebar_items %}
      <div class="cto-conv-item {% if item.active %}active{% endif %}"
           id="conv-{{ item.id }}"
           onclick="ctoLoadConv('{{ item.id }}', this)"
           title="{{ item.title }}">
        <svg class="cto-conv-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
        <div class="cto-conv-text">
          <div class="cto-conv-title">{{ item.title }}</div>
          <div class="cto-conv-date">{{ item.ts }}</div>
        </div>
      </div>
      {% endfor %}
    </div>

    <div class="cto-sidebar-footer">
      <img class="cto-agent-mini-avatar" src="/static/avatars/strat-cto.jpg" alt="Karim">
      <span class="cto-agent-mini-name">Karim Benali</span>
      <span class="cto-agent-mini-dot"></span>
    </div>
  </div>

  {# ‚îÄ‚îÄ Main chat area ‚îÄ‚îÄ #}
  <div class="cto-main">
    <div class="cto-header">
      <img class="cto-header-avatar" src="/static/avatars/strat-cto.jpg" alt="Karim Benali">
      <div class="cto-header-info">
        <div class="cto-header-name">Karim Benali</div>
        <div class="cto-header-role" id="cto-conv-title">Chief Technology Officer ¬∑ Software Factory</div>
      </div>
      <div class="cto-header-status">
        <span class="cto-header-dot"></span>
        disponible
      </div>
    </div>

    <div class="cto-chips" id="cto-chips">
      {# Static chips always visible #}
      <button class="cto-chip" data-prompt="Donne-moi les m√©triques du portfolio : missions, projets, agents, co√ªts LLM" onclick="ctoChipClick(this)"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>Stats portfolio</button>
      <button class="cto-chip" data-prompt="Liste les missions en cours et leur √©tat" onclick="ctoChipClick(this)"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>Missions en cours</button>
      <button class="cto-chip" data-prompt="Monte-moi une √©quipe optimale pour un projet de s√©curit√©" onclick="ctoChipClick(this)"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>Monter une √©quipe</button>
      <button class="cto-chip" data-prompt="Cherche sur GitHub les derni√®res pratiques pour notre stack" onclick="ctoChipClick(this)"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>GitHub</button>
      <button class="cto-chip cto-chip-project" data-prompt="Cr√©e un projet complet pour r√©pondre √† un AO Veligo (v√©los partag√©s Paris) : p√©rim√®tre, √©quipe, missions et meta workflow de d√©veloppement" onclick="ctoChipClick(this)"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>AO Veligo</button>
      <button class="cto-chip cto-chip-project" data-prompt="Lance un projet de migration Angular 16‚Üí17 pour Sharelook : analyse du code source GitHub microsoft/SharePoint-Connect (comme exemple), cr√©e le projet, les missions de migration et le meta workflow avec les √©quipes front, back et QA" onclick="ctoChipClick(this)"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="16 12 12 8 8 12"/><line x1="12" y1="16" x2="12" y2="8"/></svg>Migration Angular 16‚Üí17</button>
      <button class="cto-chip cto-chip-debt" data-prompt="Analyse la dette technique, s√©curit√© (OWASP), accessibilit√© (WCAG 2.1 AA) et conformit√© RGPD sur le projet GitHub public facebook/react : g√©n√®re un rapport complet et cr√©e les missions correctives" onclick="ctoChipClick(this)"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>Dette tech ¬∑ s√©cu ¬∑ a11y ¬∑ RGPD</button>
      <button class="cto-chip cto-chip-debt" data-prompt="Fais un git status et git log des 5 derniers commits du projet actif, propose un commit de nettoyage et cr√©e une PR" onclick="ctoChipClick(this)"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="18" r="3"/><circle cx="6" cy="6" r="3"/><path d="M13 6h3a2 2 0 0 1 2 2v7"/><line x1="6" y1="9" x2="6" y2="21"/></svg>Git commit &amp; PR</button>
      <button class="cto-chip cto-chip-project" data-prompt="Lance les tests E2E Playwright sur le projet actif, prends des screenshots des pages principales et g√©n√®re un rapport de qualit√©" onclick="ctoChipClick(this)"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>E2E + Screenshots</button>
      <button class="cto-chip cto-chip-debt" data-prompt="Synchronise le Jira du projet actif : cr√©e les tickets pour les missions en cours et mets √† jour le statut des stories existantes" onclick="ctoChipClick(this)"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>Sync Jira</button>
      <button class="cto-chip cto-chip-project" data-prompt="Mets √† jour le wiki GitHub du projet actif avec un r√©sum√© de l&#x27;architecture, les d√©cisions techniques r√©centes et le statut des missions en cours" onclick="ctoChipClick(this)"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>Mise √† jour Wiki</button>
      {# Dynamic contextual chips injected by JS on load #}
    </div>

    <div class="cto-messages" id="cto-msgs" style="position:relative">
      <div class="cto-drop-overlay" id="cto-drop-overlay" style="display:none">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        D√©poser le fichier ici
      </div>
      {{ history_html | safe }}
    </div>

    <div id="cto-thinking" class="cto-thinking" style="display:none">
      <div class="cto-avatar" style="width:22px;height:22px"></div>
      <div class="cto-thinking-dots"><span></span><span></span><span></span></div>
      <span>Karim r√©fl√©chit‚Ä¶</span>
    </div>

    <div class="cto-input-area">
      <div class="cto-attach-bar" id="cto-attach-bar">
        <div class="cto-attach-pill" id="cto-attach-pill">
          <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
          <span id="cto-attach-name">fichier.pdf</span>
          <span class="cto-attach-clear" onclick="ctoClearAttach()" title="Retirer">‚úï</span>
        </div>
        <span class="cto-attach-hint" id="cto-attach-hint"></span>
      </div>
      <div class="cto-input-row" style="position:relative">
        <div class="cto-mention-popup" id="cto-mention-popup"></div>
        <input type="file" id="cto-file-input" style="display:none" accept=".txt,.md,.pdf,.docx,.json,.yaml,.yml,.py,.js,.ts,.jsx,.tsx,.html,.css,.csv,.xml,.sql" onchange="ctoHandleFileInput(this)">
        <button class="cto-file-btn" onclick="document.getElementById('cto-file-input').click()" title="Joindre un fichier (PDF, code, AO‚Ä¶)">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
        </button>
        <textarea
          id="cto-input"
          class="cto-input"
          placeholder="@ projet   # agent   ou glissez un fichier‚Ä¶"
          rows="1"
          onkeydown="ctoInputKeydown(event)"
          oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,110)+'px';ctoInputChange(this)"
        ></textarea>
        <button id="cto-send-btn" class="cto-send" onclick="ctoSend()">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          Envoyer
        </button>
      </div>
    </div>
  </div>
</div>

{# Guardrail confirmation modal #}
<div class="cto-confirm-overlay" id="cto-confirm-overlay" onclick="if(event.target===this)_ctoConfirmCancel()">
  <div class="cto-confirm-box">
    <div class="cto-confirm-title">‚ö†Ô∏è Action √† fort impact</div>
    <div class="cto-confirm-sub" id="cto-confirm-sub">Cette action va cr√©er ou modifier des donn√©es de fa√ßon permanente. Confirmer ?</div>
    <div class="cto-confirm-preview" id="cto-confirm-preview"></div>
    <div class="cto-confirm-actions">
      <button class="cto-confirm-btn-cancel" onclick="_ctoConfirmCancel()">Annuler</button>
      <button class="cto-confirm-btn-ok" onclick="_ctoConfirmOk()">Confirmer</button>
    </div>
  </div>
</div>

<script>
(function(){
  var _sessionId = '{{ session_id }}';
  var _attachment = null; // {name, text, chars, truncated}
  var _lastMsg = null;    // {content, display} ‚Äî for retry

  /* Restore _lastMsg from retry bar data attribute (interrupted conversation) */
  function _restoreLastMsgFromRetryBar(container){
    var bar = (container || document).querySelector('.cto-retry-bar[data-msg]');
    if(bar && !_lastMsg){
      var raw = bar.getAttribute('data-msg') || '';
      _lastMsg = {content: raw, display: raw};
    }
  }
  // Check on initial page load
  document.addEventListener('DOMContentLoaded', function(){ _restoreLastMsgFromRetryBar(null); });

  /* ‚îÄ‚îÄ Attachment ‚îÄ‚îÄ */
  function ctoHandleFileInput(input){
    var file = input.files && input.files[0];
    if(file){ _processFile(file); }
    input.value = '';
  }

  function _processFile(file){
    var textExts = /\.(txt|md|rst|csv|json|yaml|yml|py|js|ts|jsx|tsx|html|css|scss|java|kt|go|rs|rb|php|sh|xml|sql|toml|ini|cfg|env)$/i;
    if(textExts.test(file.name)){
      var reader = new FileReader();
      reader.onload = function(e){
        _setAttachment({name: file.name, text: e.target.result, chars: e.target.result.length, truncated: false});
      };
      reader.readAsText(file);
    } else {
      // PDF / DOCX ‚Üí backend
      var fd = new FormData();
      fd.append('file', file);
      var hint = document.getElementById('cto-attach-hint');
      if(hint) hint.textContent = 'Extraction en cours‚Ä¶';
      _showAttachBar(file.name, '');
      fetch('/api/cto/upload', {method:'POST', body: fd})
      .then(function(r){ return r.json(); })
      .then(function(d){
        if(d.ok){ _setAttachment({name: d.name, text: d.text, chars: d.chars, truncated: d.truncated}); }
        else { _clearAttachBar(); alert('Impossible de lire ce fichier : ' + (d.error||'erreur')); }
      })
      .catch(function(){ _clearAttachBar(); alert('Erreur lors de l\'envoi du fichier.'); });
    }
  }

  function _setAttachment(att){
    _attachment = att;
    var kb = Math.round(att.chars / 1024 * 10) / 10;
    var hint = att.truncated ? ' (tronqu√© √† 40k car.)' : (' ¬∑ ' + kb + ' ko');
    _showAttachBar(att.name, hint);
  }

  function _showAttachBar(name, hint){
    var bar = document.getElementById('cto-attach-bar');
    var nameEl = document.getElementById('cto-attach-name');
    var hintEl = document.getElementById('cto-attach-hint');
    if(bar) bar.classList.add('visible');
    if(nameEl) nameEl.textContent = name;
    if(hintEl) hintEl.textContent = hint;
  }

  function _clearAttachBar(){
    var bar = document.getElementById('cto-attach-bar');
    if(bar) bar.classList.remove('visible');
  }

  function ctoClearAttach(){
    _attachment = null;
    _clearAttachBar();
  }

  /* ‚îÄ‚îÄ Drag & Drop ‚îÄ‚îÄ */
  var _dragCounter = 0;
  document.addEventListener('dragenter', function(e){
    if(e.dataTransfer && e.dataTransfer.types && Array.from(e.dataTransfer.types).includes('Files')){
      _dragCounter++;
      var ov = document.getElementById('cto-drop-overlay');
      if(ov) ov.classList.add('active');
    }
  });
  document.addEventListener('dragleave', function(e){
    _dragCounter = Math.max(0, _dragCounter - 1);
    if(_dragCounter === 0){
      var ov = document.getElementById('cto-drop-overlay');
      if(ov) ov.classList.remove('active');
    }
  });
  document.addEventListener('dragover', function(e){ e.preventDefault(); });
  document.addEventListener('drop', function(e){
    e.preventDefault();
    _dragCounter = 0;
    var ov = document.getElementById('cto-drop-overlay');
    if(ov) ov.classList.remove('active');
    var files = e.dataTransfer && e.dataTransfer.files;
    if(files && files.length > 0){ _processFile(files[0]); }
  });

  /* ‚îÄ‚îÄ @ Projects  /  # Agents ‚îÄ‚îÄ */
  var _mentionCache = {project: null, agent: null};
  var _mentionActive = false;
  var _mentionTrigger = '@';   // current trigger char
  var _mentionIdx = 0;
  var _invitedStreams = {};  // agent_id ‚Üí {text}

  function _loadMentionItems(type, cb){
    if(_mentionCache[type]){ cb(_mentionCache[type]); return; }
    fetch('/api/cto/mention-list?type='+type).then(function(r){ return r.json(); }).then(function(d){
      _mentionCache[type] = Array.isArray(d) ? d : [];
      cb(_mentionCache[type]);
    }).catch(function(){ _mentionCache[type] = []; cb([]); });
  }

  function ctoInputChange(inp){
    var val = inp.value, cur = inp.selectionStart;
    var atIdx  = val.lastIndexOf('@', cur - 1);
    var hashIdx = val.lastIndexOf('#', cur - 1);
    var triggerIdx = -1, trigger = '@';
    if(atIdx >= 0 && atIdx > hashIdx){ triggerIdx = atIdx; trigger = '@'; }
    else if(hashIdx >= 0){ triggerIdx = hashIdx; trigger = '#'; }
    if(triggerIdx === -1 || (triggerIdx > 0 && !/[\s,]/.test(val[triggerIdx-1]))){ _closeMention(); return; }
    var query = val.slice(triggerIdx + 1, cur).toLowerCase();
    _mentionTrigger = trigger;
    var type = trigger === '#' ? 'agent' : 'project';
    _loadMentionItems(type, function(items){
      var filtered = items.filter(function(p){
        return p.name.toLowerCase().includes(query) || (p.sub||'').toLowerCase().includes(query);
      });
      _renderMention(filtered, trigger);
    });
  }

  function _renderMention(items, trigger){
    var popup = document.getElementById('cto-mention-popup');
    if(!popup) return;
    if(!items.length){ _closeMention(); return; }
    _mentionActive = true; _mentionIdx = 0;
    popup.innerHTML = items.map(function(p, i){
      var isAgent = trigger === '#';
      var icon = isAgent
        ? '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/></svg>'
        : '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>';
      return '<div class="cto-mention-item'+(i===0?' active':'')+(p.empty?' mi-empty':'')+'" onclick="ctoPickMention(\''+_mesc(p.name)+'\',\''+trigger+'\')">' +
        icon +
        '<span class="mi-name">'+_mesc(p.name)+'</span>' +
        '<span class="mi-stack">'+_mesc(p.sub||'')+'</span>' +
        '</div>';
    }).join('');
    popup.classList.add('open');
  }

  function _closeMention(){
    _mentionActive = false;
    var popup = document.getElementById('cto-mention-popup');
    if(popup){ popup.classList.remove('open'); popup.innerHTML = ''; }
  }

  function ctoPickMention(name, trigger){
    var inp = document.getElementById('cto-input');
    var val = inp.value, cur = inp.selectionStart;
    var tchar = trigger || '@';
    var idx = val.lastIndexOf(tchar, cur - 1);
    if(idx === -1) return;
    inp.value = val.slice(0, idx) + tchar + name + ' ' + val.slice(cur);
    inp.selectionStart = inp.selectionEnd = idx + name.length + 2;
    _closeMention(); inp.focus();
  }

  function ctoInputKeydown(event){
    if(_mentionActive){
      var popup = document.getElementById('cto-mention-popup');
      var items = popup ? popup.querySelectorAll('.cto-mention-item') : [];
      if(event.key==='ArrowDown'){event.preventDefault();_mentionIdx=Math.min(_mentionIdx+1,items.length-1);_updateMentionActive(items);return;}
      if(event.key==='ArrowUp'){event.preventDefault();_mentionIdx=Math.max(_mentionIdx-1,0);_updateMentionActive(items);return;}
      if(event.key==='Enter'||event.key==='Tab'){event.preventDefault();if(items[_mentionIdx])items[_mentionIdx].click();return;}
      if(event.key==='Escape'){_closeMention();return;}
    }
    if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();ctoSend();}
  }

  function _updateMentionActive(items){
    items.forEach(function(el,i){el.classList.toggle('active',i===_mentionIdx);});
    if(items[_mentionIdx]) items[_mentionIdx].scrollIntoView({block:'nearest'});
  }

  function _mesc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#x27;'); }

  /* ‚îÄ‚îÄ Send ‚îÄ‚îÄ */
  function ctoSend(){
    var inp = document.getElementById('cto-input');
    var msg = inp.value.trim();
    if(!msg && !_attachment) return;
    var fullMsg = msg;
    if(_attachment){
      var header = 'üìé **' + _attachment.name + '**' + (_attachment.truncated ? ' *(extrait)*' : '') + '\n\n';
      fullMsg = (msg ? msg + '\n\n' : 'Analyse ce document :\n\n') + header + '```\n' + _attachment.text + '\n```';
    }
    inp.value = '';
    inp.style.height = 'auto';
    ctoClearAttach();
    _ctoGuardrailCheck(fullMsg, msg || ('üìé ' + (_attachment ? _attachment.name : '')));
  }

  /* ‚îÄ‚îÄ Guardrail: confirm high-impact actions ‚îÄ‚îÄ */
  var _pendingDispatch = null;
  var _HIGH_IMPACT = /\b(cr√©e?\s+(le\s+)?projet|cr[e√©]ation\s+de\s+projet|d√©ploie?|deploy|git\s+commit\s+sur\s+main|supprime?|delete|drop\s+table|lance\s+la\s+mission|cr√©e?\s+(une?\s+)?mission)\b/i;

  function _ctoGuardrailCheck(msg, displayMsg){
    if(_HIGH_IMPACT.test(msg)){
      _pendingDispatch = {msg: msg, displayMsg: displayMsg};
      var sub = document.getElementById('cto-confirm-sub');
      var preview = document.getElementById('cto-confirm-preview');
      var action = msg.match(_HIGH_IMPACT);
      if(sub) sub.textContent = 'Jarvis va ex√©cuter une action √† fort impact : "' + (action ? action[0] : 'action critique') + '". Impossible d\'annuler apr√®s ex√©cution.';
      if(preview) preview.textContent = msg.slice(0, 200) + (msg.length > 200 ? '‚Ä¶' : '');
      var overlay = document.getElementById('cto-confirm-overlay');
      if(overlay) overlay.classList.add('active');
    } else {
      _ctoDispatch(msg, displayMsg);
    }
  }

  function _ctoConfirmOk(){
    var overlay = document.getElementById('cto-confirm-overlay');
    if(overlay) overlay.classList.remove('active');
    if(_pendingDispatch){
      _ctoDispatch(_pendingDispatch.msg, _pendingDispatch.displayMsg);
      _pendingDispatch = null;
    }
  }

  function _ctoConfirmCancel(){
    var overlay = document.getElementById('cto-confirm-overlay');
    if(overlay) overlay.classList.remove('active');
    _pendingDispatch = null;
  }

  function ctoSendChip(text){ _ctoGuardrailCheck(text, text); }

  function ctoChipClick(btn){
    var prompt = btn.getAttribute('data-prompt') || btn.textContent.trim();
    var label = btn.textContent.trim();
    _ctoGuardrailCheck(prompt, label);
  }

  function _ctoDispatch(msg, displayMsg){
    var msgs = document.getElementById('cto-msgs');
    var thinking = document.getElementById('cto-thinking');
    var btn = document.getElementById('cto-send-btn');
    btn.classList.add('loading');
    thinking.style.display = 'flex';
    msgs.scrollTop = msgs.scrollHeight;
    _lastMsg = {content: msg, display: displayMsg || msg};

    // Remove any previous retry bar
    var prevRetry = msgs.querySelector('.cto-retry-bar');
    if(prevRetry) prevRetry.remove();

    // Streaming bubble placeholder
    var streamBubble = null;
    var streamText = '';

    fetch('/api/cto/message', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({content: msg, display: displayMsg || msg, session_id: _sessionId})
    })
    .then(function(r){
      // Handle HTTP errors (4xx/5xx) immediately
      if(!r.ok){
        thinking.style.display = 'none';
        btn.classList.remove('loading');
        _ctoShowRetry(msgs, 'Erreur serveur (' + r.status + ')');
        return;
      }
      var reader = r.body.getReader();
      var decoder = new TextDecoder();
      var buf = '';
      var receivedDone = false;

      function processChunk(value){
        buf += decoder.decode(value || new Uint8Array(), {stream: !!value});
        var parts = buf.split('\n\n');
        buf = parts.pop();
        parts.forEach(function(part){
          var lines = part.split('\n');
          var eventName = 'message', dataStr = '';
          lines.forEach(function(l){
            if(l.startsWith('event: ')) eventName = l.slice(7).trim();
            else if(l.startsWith('data: ')) dataStr = l.slice(6).trim();
          });
          if(!dataStr) return;
          try { var d = JSON.parse(dataStr); } catch(e){ return; }

          if(eventName === 'user_html'){
            msgs.insertAdjacentHTML('beforeend', d.html);
            if(d.session_id) _sessionId = d.session_id;
            msgs.scrollTop = msgs.scrollHeight;
          } else if(eventName === 'chunk'){
            if(!streamBubble){
              msgs.insertAdjacentHTML('beforeend',
                '<div class="chat-msg chat-msg-agent" id="cto-stream-bubble">' +
                '<div class="chat-msg-avatar cto-avatar"></div>' +
                '<div class="chat-msg-body">' +
                '<div class="chat-msg-sender">Karim Benali ‚Äî CTO</div>' +
                '<div class="chat-msg-text" id="cto-stream-text"></div>' +
                '</div></div>'
              );
              streamBubble = document.getElementById('cto-stream-bubble');
            }
            streamText += d.text;
            var el = document.getElementById('cto-stream-text');
            if(el) el.textContent = streamText;
            msgs.scrollTop = msgs.scrollHeight;
          } else if(eventName === 'done'){
            receivedDone = true;
            if(streamBubble){ streamBubble.remove(); streamBubble = null; streamText = ''; }
            msgs.insertAdjacentHTML('beforeend', d.html);
            thinking.style.display = 'none';
            btn.classList.remove('loading');
            if(d.session_id) _sessionId = d.session_id;
            if(d.title_hint) _updateConvTitle(_sessionId, d.title_hint);
            msgs.scrollTop = msgs.scrollHeight;
          } else if(eventName === 'agent_thinking'){
            // Show thinking indicator for invited agent
            var aid = d.agent_id;
            if(!_invitedStreams[aid]){
              var initials = d.agent_name.split(' ').slice(0,2).map(function(w){return w[0]||'';}).join('').toUpperCase();
              var avHtml = d.avatar_url
                ? '<img class="invited-avatar-img" src="'+_mesc(d.avatar_url)+'" alt="'+_mesc(d.agent_name)+'">'
                : '<div class="invited-avatar invited-avatar-initials">'+_mesc(initials)+'</div>';
              msgs.insertAdjacentHTML('beforeend',
                '<div class="invited-divider">'+_mesc(d.agent_name)+' a rejoint</div>' +
                '<div class="chat-msg chat-msg-invited" id="inv-bubble-'+aid+'">' +
                avHtml +
                '<div class="chat-msg-body">' +
                '<div class="chat-msg-sender">'+_mesc(d.agent_name)+' ‚Äî '+_mesc(d.agent_role||'')+'</div>' +
                '<div class="chat-msg-text" id="inv-text-'+aid+'"><span class="thinking-dots"><span></span><span></span><span></span></span></div>' +
                '</div></div>'
              );
              _invitedStreams[aid] = {text: ''};
              msgs.scrollTop = msgs.scrollHeight;
            }
          } else if(eventName === 'agent_chunk'){
            var aid = d.agent_id;
            if(_invitedStreams[aid] !== undefined){
              _invitedStreams[aid].text += d.text;
              var el = document.getElementById('inv-text-'+aid);
              if(el) el.textContent = _invitedStreams[aid].text;
              msgs.scrollTop = msgs.scrollHeight;
            }
          } else if(eventName === 'agent_done'){
            var aid = d.agent_id;
            var old = document.getElementById('inv-bubble-'+aid);
            if(old) old.remove();
            delete _invitedStreams[aid];
            msgs.insertAdjacentHTML('beforeend', d.html);
            msgs.scrollTop = msgs.scrollHeight;
          } else if(eventName === 'error'){
            thinking.style.display = 'none';
            btn.classList.remove('loading');
            _ctoShowRetry(msgs, d.message || 'Erreur');
          }
        });
      }

      function pump(){
        return reader.read().then(function(result){
          if(result.done){
            processChunk(null);
            // Stream ended without a 'done' event ‚Üí show retry
            if(!receivedDone){
              thinking.style.display = 'none';
              btn.classList.remove('loading');
              _ctoShowRetry(msgs, 'Connexion interrompue');
            }
            return;
          }
          processChunk(result.value);
          return pump();
        });
      }
      return pump();
    })
    .catch(function(){
      thinking.style.display = 'none';
      btn.classList.remove('loading');
      _ctoShowRetry(msgs, 'Erreur de communication.');
    });
  }

  function _ctoShowRetry(msgs, errMsg){
    var shortMsg = _lastMsg ? (_lastMsg.display.length > 60 ? _lastMsg.display.slice(0,60)+'‚Ä¶' : _lastMsg.display) : '';
    var safeErr = errMsg.replace(/</g,'&lt;');
    var safeShort = shortMsg.replace(/</g,'&lt;');
    msgs.insertAdjacentHTML('beforeend',
      '<div class="cto-retry-bar">' +
        '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>' +
        '<span class="retry-msg" title="' + safeErr + '">' + safeErr + (safeShort ? ' ‚Äî ¬´' + safeShort + '¬ª' : '') + '</span>' +
        '<button class="cto-retry-btn edit" onclick="ctoRetryEdit()">Modifier</button>' +
        '<button class="cto-retry-btn" onclick="ctoRetryResend()">Relancer</button>' +
      '</div>'
    );
    msgs.scrollTop = msgs.scrollHeight;
  }

  function ctoRetryEdit(){
    if(!_lastMsg) return;
    var inp = document.getElementById('cto-input');
    if(inp){ inp.value = _lastMsg.content; inp.focus(); inp.style.height = 'auto'; inp.style.height = Math.min(inp.scrollHeight, 110) + 'px'; }
    var bar = document.querySelector('.cto-retry-bar');
    if(bar) bar.remove();
  }

  function ctoRetryResend(){
    if(!_lastMsg) return;
    var bar = document.querySelector('.cto-retry-bar');
    if(bar) bar.remove();
    _ctoDispatch(_lastMsg.content, _lastMsg.display);
  }

  /* ‚îÄ‚îÄ New conversation ‚îÄ‚îÄ */
  function ctoNewConversation(){
    // Clear search on new conversation
    var si = document.getElementById('cto-search-input');
    if(si){ si.value = ''; ctoSearchConvs(''); }
    fetch('/api/cto/sessions/new', {method:'POST'})
    .then(function(r){ return r.json(); })
    .then(function(d){
      _sessionId = d.session_id;
      // Clear messages
      var msgs = document.getElementById('cto-msgs');
      msgs.innerHTML = '';
      // Add to sidebar
      var list = document.getElementById('cto-conv-list');
      var item = document.createElement('div');
      item.className = 'cto-conv-item active';
      item.id = 'conv-' + d.session_id;
      item.setAttribute('onclick', "ctoLoadConv('"+d.session_id+"', this)");
      item.innerHTML = '<svg class="cto-conv-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>'
        + '<div class="cto-conv-text"><div class="cto-conv-title">Nouvelle conversation</div><div class="cto-conv-date">maintenant</div></div>';
      // Deactivate others
      list.querySelectorAll('.cto-conv-item').forEach(function(el){ el.classList.remove('active'); });
      list.insertBefore(item, list.firstChild);
      // Update header
      document.getElementById('cto-conv-title').textContent = 'Chief Technology Officer ¬∑ Software Factory';
      // Focus input
      document.getElementById('cto-input').focus();
    });
  }

  /* ‚îÄ‚îÄ Search conversations ‚îÄ‚îÄ */
  var _searchTimer = null;
  var _allConvItems = null; // cache of original sidebar items HTML

  function ctoSearchConvs(q){
    q = (q || '').trim();
    var label = document.getElementById('cto-hist-label');
    if(!q){
      // Restore original list
      if(_allConvItems !== null){
        var list = document.getElementById('cto-conv-list');
        list.innerHTML = _allConvItems;
        _allConvItems = null;
      }
      if(label) label.textContent = 'Historique';
      return;
    }
    // Save original items once
    if(_allConvItems === null){
      _allConvItems = document.getElementById('cto-conv-list').innerHTML;
    }
    if(label) label.textContent = 'R√©sultats';
    clearTimeout(_searchTimer);
    _searchTimer = setTimeout(function(){
      var qLow = q.toLowerCase();
      // Fast client-side filter first (titles only)
      var list = document.getElementById('cto-conv-list');
      var tmp = document.createElement('div');
      tmp.innerHTML = _allConvItems;
      var items = tmp.querySelectorAll('.cto-conv-item');
      var anyVisible = false;
      items.forEach(function(el){
        var title = (el.querySelector('.cto-conv-title') || {}).textContent || '';
        if(title.toLowerCase().includes(qLow)){
          el.style.display = '';
          anyVisible = true;
        } else {
          el.style.display = 'none';
        }
      });
      list.innerHTML = tmp.innerHTML;
      // Then do server-side content search (async)
      fetch('/api/cto/search?q=' + encodeURIComponent(q))
      .then(function(r){ return r.json(); })
      .then(function(results){
        if(!results.length && !anyVisible){
          list.innerHTML = '<div style="padding:.6rem .75rem;font-size:.72rem;color:var(--text-muted)">Aucun r√©sultat</div>';
          return;
        }
        // Rebuild list with search results (content matches)
        var html = '';
        var seen = new Set();
        results.forEach(function(item){
          seen.add(item.id);
          var snippet = item.snippet ? '<div class="cto-conv-snippet">' + item.snippet.replace(/</g,'&lt;') + '</div>' : '';
          html += '<div class="cto-conv-item" id="conv-' + item.id + '" onclick="ctoLoadConv(\'' + item.id + '\',this)" title="' + item.title.replace(/"/g,'&quot;') + '">'
            + '<svg class="cto-conv-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>'
            + '<div class="cto-conv-text"><div class="cto-conv-title">' + item.title.replace(/</g,'&lt;') + '</div>'
            + '<div class="cto-conv-date">' + item.ts + '</div>'
            + snippet
            + '</div></div>';
        });
        list.innerHTML = html || '<div style="padding:.6rem .75rem;font-size:.72rem;color:var(--text-muted)">Aucun r√©sultat</div>';
      })
      .catch(function(){});
    }, 280);
  }

  /* ‚îÄ‚îÄ Load existing conversation ‚îÄ‚îÄ */
  function ctoLoadConv(sessionId, el){
    if(_sessionId === sessionId) return;
    _sessionId = sessionId;
    // Update active state in sidebar
    document.querySelectorAll('.cto-conv-item').forEach(function(e){ e.classList.remove('active'); });
    el.classList.add('active');
    // Update header title
    var title = el.querySelector('.cto-conv-title');
    if(title) document.getElementById('cto-conv-title').textContent = title.textContent;
    // Load messages
    var msgs = document.getElementById('cto-msgs');
    msgs.innerHTML = '<div style="text-align:center;padding:1.5rem;font-size:.75rem;color:var(--text-muted)">Chargement‚Ä¶</div>';
    fetch('/api/cto/sessions/' + sessionId + '/messages')
    .then(function(r){ return r.text(); })
    .then(function(html){
      _lastMsg = null;  // reset before loading new session
      msgs.innerHTML = html || '';
      _restoreLastMsgFromRetryBar(msgs);
      msgs.scrollTop = msgs.scrollHeight;
    });
  }

  /* ‚îÄ‚îÄ Update sidebar title after first message ‚îÄ‚îÄ */
  function _updateConvTitle(sessionId, title){
    var item = document.getElementById('conv-' + sessionId);
    if(item){
      var t = item.querySelector('.cto-conv-title');
      if(t && t.textContent === 'Nouvelle conversation') t.textContent = title;
    }
    // Also update header if it's the current conv
    var hdr = document.getElementById('cto-conv-title');
    if(hdr && hdr.textContent === 'Nouvelle conversation') hdr.textContent = title;
  }

  /* Expose globals */
  window.ctoSend = ctoSend;
  window.ctoSendChip = ctoSendChip;
  window.ctoChipClick = ctoChipClick;
  window.ctoNewConversation = ctoNewConversation;
  window.ctoLoadConv = ctoLoadConv;
  window.ctoClearAttach = ctoClearAttach;
  window.ctoHandleFileInput = ctoHandleFileInput;
  window.ctoPickMention = ctoPickMention;
  window.ctoInputChange = ctoInputChange;
  window.ctoInputKeydown = ctoInputKeydown;
  window.ctoRetryEdit = ctoRetryEdit;
  window.ctoRetryResend = ctoRetryResend;
  window.ctoSearchConvs = ctoSearchConvs;
  window._ctoConfirmOk = _ctoConfirmOk;
  window._ctoConfirmCancel = _ctoConfirmCancel;

  // Scroll to bottom on load
  var msgs = document.getElementById('cto-msgs');
  if(msgs) msgs.scrollTop = msgs.scrollHeight;
  // Focus input
  setTimeout(function(){ var inp=document.getElementById('cto-input'); if(inp) inp.focus(); }, 100);
  // Load dynamic contextual chips
  fetch('/api/cto/chips').then(function(r){ return r.json(); }).then(function(chips){
    if(!chips || !chips.length) return;
    var container = document.getElementById('cto-chips');
    if(!container) return;
    chips.forEach(function(c){
      var btn = document.createElement('button');
      btn.className = 'cto-chip' + (c.cls ? ' ' + c.cls : '');
      btn.setAttribute('data-prompt', c.prompt);
      btn.setAttribute('onclick', 'ctoChipClick(this)');
      btn.textContent = c.label;
      container.appendChild(btn);
    });
  }).catch(function(){});
})();
</script>

