        {# ══════ SECURITY TABS ══════ #}

        <!-- Tab: Vulnerabilites -->
        <div class="mc-tab-panel" data-tab="vulns">
            {% set vulns_agent = (tab_profile|selectattr('id','equalto','vulns')|first).agent %}
            {% if vulns_agent %}
            <div class="mc-tab-agent">
                <img class="mc-tab-agent-avatar" src="{{ vulns_agent.get('avatar_url','') }}" alt="" onerror="this.style.display='none'">
                <div class="mc-tab-agent-info">
                    <div class="mc-tab-agent-name">{{ vulns_agent.get('name','') }}</div>
                    <div class="mc-tab-agent-role">{{ vulns_agent.get('role','') }}</div>
                    {% if vulns_agent.get('tagline') %}<div class="mc-tab-agent-tagline">{{ vulns_agent['tagline'] }}</div>{% endif %}
                </div>
                <button class="mc-tab-agent-chat" onclick="openAgentChat('{{ vulns_agent.get('id','') }}','{{ vulns_agent.get('name','') }}','{{ vulns_agent.get('role','') }}','{{ vulns_agent.get('avatar_url','') }}')">
                    <svg class="icon"><use href="#icon-send"/></svg> Discuter
                </button>
            </div>
            {% endif %}

            <div class="mc-sec-kpis">
                <div class="mc-sec-kpi critical"><div class="val" id="sec-critical">--</div><div class="lbl">{{ _("critiques") }}</div></div>
                <div class="mc-sec-kpi high"><div class="val" id="sec-high">--</div><div class="lbl">{{ _("hautes") }}</div></div>
                <div class="mc-sec-kpi fixed"><div class="val" id="sec-fixed">--</div><div class="lbl">{{ _("corrigees") }}</div></div>
                <div class="mc-sec-kpi pending"><div class="val" id="sec-pending">--</div><div class="lbl">{{ _("en_attente") }}</div></div>
            </div>

            {% set vuln_phases = ['recon', 'threat-model', 'exploitation', 'vuln-report'] %}
            {% for pid in vuln_phases %}
            {% set pmsgs = phase_messages.get(pid, []) %}
            {% if pmsgs %}
            <div class="mc-sec-section">
                <h4><svg><use href="#icon-alert-triangle"/></svg> {{ pid | replace('-', ' ') | title }}</h4>
                <div class="mc-sec-phase-content">
                    {% for msg in pmsgs[-3:] %}
                    <div style="margin-bottom:0.4rem;padding-bottom:0.4rem;border-bottom:1px solid var(--bg-tertiary)">
                        <div style="font-size:0.6rem;color:var(--purple-light);margin-bottom:0.15rem">{{ msg.agent_name or msg.agent_id or '' }}</div>
                        <div>{{ msg.content[:500] | markdown | safe if msg.content else '' }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            {% endfor %}

            {% if not phase_messages.get('recon') and not phase_messages.get('exploitation') and not phase_messages.get('vuln-report') %}
            <div class="mc-sec-empty"><svg class="icon" style="width:28px;height:28px;opacity:.3;display:block;margin:0 auto 0.3rem"><use href="#icon-alert-triangle"/></svg>{{ _("en_attente_des_resultats_de_reconnaissance") }}</div>
            {% endif %}
        </div>

        <!-- Tab: Remediation -->
        <div class="mc-tab-panel" data-tab="remediation">
            {% set remed_agent = (tab_profile|selectattr('id','equalto','remediation')|first).agent %}
            {% if remed_agent %}
            <div class="mc-tab-agent">
                <img class="mc-tab-agent-avatar" src="{{ remed_agent.get('avatar_url','') }}" alt="" onerror="this.style.display='none'">
                <div class="mc-tab-agent-info">
                    <div class="mc-tab-agent-name">{{ remed_agent.get('name','') }}</div>
                    <div class="mc-tab-agent-role">{{ remed_agent.get('role','') }}</div>
                    {% if remed_agent.get('tagline') %}<div class="mc-tab-agent-tagline">{{ remed_agent['tagline'] }}</div>{% endif %}
                </div>
                <button class="mc-tab-agent-chat" onclick="openAgentChat('{{ remed_agent.get('id','') }}','{{ remed_agent.get('name','') }}','{{ remed_agent.get('role','') }}','{{ remed_agent.get('avatar_url','') }}')">
                    <svg class="icon"><use href="#icon-send"/></svg> Discuter
                </button>
            </div>
            {% endif %}

            {% set remed_msgs = phase_messages.get('remediation', []) %}
            {% if remed_msgs %}
            <div class="mc-sec-section">
                <h4><svg><use href="#icon-git-pull-request"/></svg> Correctifs TDD</h4>
                <div class="mc-sec-phase-content">
                    {% for msg in remed_msgs %}
                    <div style="margin-bottom:0.5rem;padding-bottom:0.5rem;border-bottom:1px solid var(--bg-tertiary)">
                        <div style="font-size:0.6rem;color:var(--purple-light);margin-bottom:0.15rem">{{ msg.agent_name or msg.agent_id or '' }}</div>
                        <div>{{ msg.content[:600] | markdown | safe if msg.content else '' }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {% if pull_requests %}
            <div class="mc-sec-section">
                <h4><svg><use href="#icon-git-branch"/></svg> Pull Requests</h4>
                {% for pr in pull_requests %}
                <div class="mc-dev-pr {{ pr.status|lower }}" style="margin-bottom:0.3rem">
                    <span class="mc-dev-pr-icon"><svg class="icon icon-xs"><use href="#icon-git-pull-request"/></svg></span>
                    <span class="mc-dev-pr-num">#{{ pr.number }}</span>
                    <span class="mc-dev-pr-title">{{ pr.title[:60] }}</span>
                    <span class="mc-dev-pr-status {{ pr.status|lower }}">{{ pr.status }}</span>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            {% if not remed_msgs and not pull_requests %}
            <div class="mc-sec-empty"><svg class="icon" style="width:28px;height:28px;opacity:.3;display:block;margin:0 auto 0.3rem"><use href="#icon-tool"/></svg>{{ _("phase_de_remediation_non_demarree") }}</div>
            {% endif %}
        </div>

        <!-- Tab: Compliance -->
        <div class="mc-tab-panel" data-tab="compliance">
            {% set comp_agent = (tab_profile|selectattr('id','equalto','compliance')|first).agent %}
            {% if comp_agent %}
            <div class="mc-tab-agent">
                <img class="mc-tab-agent-avatar" src="{{ comp_agent.get('avatar_url','') }}" alt="" onerror="this.style.display='none'">
                <div class="mc-tab-agent-info">
                    <div class="mc-tab-agent-name">{{ comp_agent.get('name','') }}</div>
                    <div class="mc-tab-agent-role">{{ comp_agent.get('role','') }}</div>
                    {% if comp_agent.get('tagline') %}<div class="mc-tab-agent-tagline">{{ comp_agent['tagline'] }}</div>{% endif %}
                </div>
                <button class="mc-tab-agent-chat" onclick="openAgentChat('{{ comp_agent.get('id','') }}','{{ comp_agent.get('name','') }}','{{ comp_agent.get('role','') }}','{{ comp_agent.get('avatar_url','') }}')">
                    <svg class="icon"><use href="#icon-send"/></svg> Discuter
                </button>
            </div>
            {% endif %}

            {% set review_msgs = phase_messages.get('security-review', []) %}
            {% set verif_msgs = phase_messages.get('verification', []) %}
            {% if review_msgs or verif_msgs %}
            <div class="mc-sec-section">
                <h4><svg><use href="#icon-clipboard"/></svg> Revue de conformite</h4>
                <div class="mc-sec-phase-content">
                    {% for msg in (review_msgs + verif_msgs) %}
                    <div style="margin-bottom:0.4rem;padding-bottom:0.4rem;border-bottom:1px solid var(--bg-tertiary)">
                        <div style="font-size:0.6rem;color:var(--purple-light);margin-bottom:0.15rem">{{ msg.agent_name or msg.agent_id or '' }}</div>
                        <div>{{ msg.content[:500] | markdown | safe if msg.content else '' }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% else %}
            <div class="mc-sec-empty"><svg class="icon" style="width:28px;height:28px;opacity:.3;display:block;margin:0 auto 0.3rem"><use href="#icon-clipboard"/></svg>{{ _("revue_de_compliance_en_attente") }}</div>
            {% endif %}
        </div>

        <!-- Tab: CISO Dashboard -->
        <div class="mc-tab-panel" data-tab="ciso">
            {% set ciso_agent = (tab_profile|selectattr('id','equalto','ciso')|first).agent %}
            {% if ciso_agent %}
            <div class="mc-tab-agent">
                <img class="mc-tab-agent-avatar" src="{{ ciso_agent.get('avatar_url','') }}" alt="" onerror="this.style.display='none'">
                <div class="mc-tab-agent-info">
                    <div class="mc-tab-agent-name">{{ ciso_agent.get('name','') }}</div>
                    <div class="mc-tab-agent-role">{{ ciso_agent.get('role','') }}</div>
                    {% if ciso_agent.get('tagline') %}<div class="mc-tab-agent-tagline">{{ ciso_agent['tagline'] }}</div>{% endif %}
                </div>
                <button class="mc-tab-agent-chat" onclick="openAgentChat('{{ ciso_agent.get('id','') }}','{{ ciso_agent.get('name','') }}','{{ ciso_agent.get('role','') }}','{{ ciso_agent.get('avatar_url','') }}')">
                    <svg class="icon"><use href="#icon-send"/></svg> Discuter
                </button>
            </div>
            {% endif %}

            <div class="mc-sec-section">
                <h4><svg><use href="#icon-shield"/></svg> Vue d'ensemble securite</h4>
                <div class="mc-sec-phase-content">
                    {% set all_sec_phases = ['recon','threat-model','exploitation','vuln-report','security-review','remediation','verification','deploy-secure'] %}
                    {% set has_content = false %}
                    {% for pid in all_sec_phases %}
                    {% set pmsgs = phase_messages.get(pid, []) %}
                    {% if pmsgs %}
                    {% set has_content = true %}
                    <details {% if loop.last %}open{% endif %} style="margin-bottom:0.4rem">
                        <summary style="cursor:pointer;font-size:0.72rem;font-weight:600;color:var(--text-primary);padding:0.25rem 0">{{ pid | replace('-', ' ') | title }} ({{ pmsgs|length }} messages)</summary>
                        {% for msg in pmsgs[-2:] %}
                        <div style="margin:0.3rem 0 0.3rem 0.8rem;padding-bottom:0.3rem;border-bottom:1px solid var(--bg-tertiary)">
                            <div style="font-size:0.58rem;color:var(--purple-light)">{{ msg.agent_name or msg.agent_id or '' }}</div>
                            <div style="font-size:0.7rem;color:var(--text-secondary)">{{ msg.content[:300] | markdown | safe if msg.content else '' }}</div>
                        </div>
                        {% endfor %}
                    </details>
                    {% endif %}
                    {% endfor %}
                    {% if not phase_messages %}
                    <div class="mc-sec-empty">{{ _('no_report') }}</div>
                    {% endif %}
                </div>
            </div>

            {% if agent_scores %}
            <div class="mc-sec-section">
                <h4><svg><use href="#icon-activity"/></svg> Adversarial Guard</h4>
                <div class="mc-qa-grid">
                    {% for s in agent_scores %}
                    <div class="mc-qa-agent-card">
                        <div class="mc-qa-agent-name">{{ s.agent_id }}</div>
                        <div class="mc-qa-agent-bar">
                            <div class="mc-qa-bar-fill" style="width:{{ (s.accepted / s.iterations * 100)|round if s.iterations > 0 else 0 }}%;background:{{ 'var(--green)' if s.accepted > s.rejected else 'var(--red)' }}"></div>
                        </div>
                        <div class="mc-qa-agent-stats">
                            <span class="mc-qa-ok">{{ s.accepted }}</span> <span class="mc-qa-ko">{{ s.rejected }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Tab: Rapport (wiki reuse for security) -->
        <div class="mc-tab-panel" data-tab="wiki">
            {% set wiki_agent = (tab_profile|selectattr('id','equalto','wiki')|first).agent %}
            {% if wiki_agent %}
            <div class="mc-tab-agent">
                <img class="mc-tab-agent-avatar" src="{{ wiki_agent.get('avatar_url','') }}" alt="" onerror="this.style.display='none'">
                <div class="mc-tab-agent-info">
                    <div class="mc-tab-agent-name">{{ wiki_agent.get('name','') }}</div>
                    <div class="mc-tab-agent-role">{{ wiki_agent.get('role','') }}</div>
                    {% if wiki_agent.get('tagline') %}<div class="mc-tab-agent-tagline">{{ wiki_agent['tagline'] }}</div>{% endif %}
                </div>
                <button class="mc-tab-agent-chat" onclick="openAgentChat('{{ wiki_agent.get('id','') }}','{{ wiki_agent.get('name','') }}','{{ wiki_agent.get('role','') }}','{{ wiki_agent.get('avatar_url','') }}')">
                    <svg class="icon"><use href="#icon-send"/></svg> Discuter
                </button>
            </div>
            {% endif %}
            <div class="mc-wiki">
                {% if wiki_pages %}
                {% for page in wiki_pages %}
                <details class="mc-wiki-page" {% if loop.first %}open{% endif %}>
                    <summary class="mc-wiki-page-title"><span>{{ page.title }}</span></summary>
                    <div class="mc-wiki-page-body">{{ page.content | markdown | safe }}</div>
                </details>
                {% endfor %}
                {% else %}
                <div class="mc-wiki-empty"><svg class="icon" style="width:28px;height:28px;opacity:.3;display:block;margin:0 auto 0.3rem"><use href="#icon-book-open"/></svg>{{ _("rapport_final_en_cours_de_redaction") }}</div>
                {% endif %}
                {% if wiki_memories %}
                <div class="mc-wiki-memories"><h4>{{ _("memoire_securite") }}</h4>
                    {% for m in wiki_memories %}
                    <div class="mc-wiki-memory"><span class="mc-wiki-memory-cat">{{ m.category }}</span><span class="mc-wiki-memory-text">{{ m.value }}</span></div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>

{% include "partials/mc_tab_workflow_graph.html" %}
