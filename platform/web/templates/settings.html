{% extends "base.html" %}

{% block content %}
<style>
.settings-tabs{display:flex;gap:0;border-bottom:1px solid var(--border);margin-bottom:1.5rem}
.settings-tab{padding:0.6rem 1.2rem;font-size:0.82rem;font-weight:600;color:var(--text-secondary);cursor:pointer;border-bottom:2px solid transparent;transition:all .15s;background:none;border-top:none;border-left:none;border-right:none;font-family:inherit}
.settings-tab:hover{color:var(--text-primary)}
.settings-tab.active{color:var(--purple);border-bottom-color:var(--purple)}
.settings-panel{display:none}
.settings-panel.active{display:block}
.integ-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:1rem}
.integ-card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:10px;padding:1.2rem;transition:border-color .15s}
.integ-card:hover{border-color:var(--purple-dim)}
.integ-card.enabled{border-color:rgba(34,197,94,.3)}
.integ-header{display:flex;align-items:center;gap:0.8rem;margin-bottom:0.8rem}
.integ-icon{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:1.3rem}
.integ-icon.jira{background:rgba(0,82,204,.15);color:#0052cc}
.integ-icon.confluence{background:rgba(0,101,255,.15);color:#0065ff}
.integ-icon.xray{background:rgba(101,84,192,.15);color:#6554c0}
.integ-icon.sonarqube{background:rgba(78,154,6,.15);color:#4e9a06}
.integ-icon.gitlab{background:rgba(252,109,38,.15);color:#fc6d26}
.integ-icon.azure-devops{background:rgba(0,120,212,.15);color:#0078d4}
.integ-info{flex:1;min-width:0}
.integ-name{font-size:0.92rem;font-weight:700;color:var(--text-primary)}
.integ-type{font-size:0.72rem;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.3px}
.integ-toggle{position:relative;width:44px;height:24px;flex-shrink:0}
.integ-toggle input{opacity:0;width:0;height:0}
.integ-toggle .slider{position:absolute;inset:0;background:var(--bg-tertiary);border-radius:12px;cursor:pointer;transition:.2s;border:1px solid var(--border)}
.integ-toggle .slider:before{content:"";position:absolute;height:18px;width:18px;left:2px;bottom:2px;background:var(--text-secondary);border-radius:50%;transition:.2s}
.integ-toggle input:checked+.slider{background:var(--purple);border-color:var(--purple)}
.integ-toggle input:checked+.slider:before{transform:translateX(20px);background:#fff}
.integ-body{display:flex;flex-direction:column;gap:0.6rem}
.integ-field{display:flex;flex-direction:column;gap:0.2rem}
.integ-field label{font-size:0.72rem;font-weight:600;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.3px}
.integ-field input,.integ-field select{background:var(--bg-tertiary);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:0.4rem 0.6rem;font-size:0.82rem;font-family:inherit;outline:none}
.integ-field input:focus,.integ-field select:focus{border-color:var(--purple)}
.integ-status{display:flex;align-items:center;gap:0.4rem;margin-top:0.4rem;font-size:0.72rem}
.integ-status-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.integ-status-dot.connected{background:var(--green)}
.integ-status-dot.disconnected{background:var(--text-secondary)}
.integ-status-dot.error{background:var(--red)}
.integ-actions{display:flex;gap:0.4rem;margin-top:0.5rem}
.integ-desc{font-size:0.78rem;color:var(--text-secondary);line-height:1.4;margin-bottom:0.4rem}
/* LLM tab */
.llm-provider-card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:10px;padding:1rem 1.2rem}
.llm-provider-card.active{border-color:rgba(34,197,94,.4)}
.llm-provider-card.inactive{opacity:.65}
.llm-prov-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:0.5rem}
.llm-prov-name{font-weight:700;font-size:0.9rem;color:var(--text-primary)}
.llm-prov-models{font-size:0.73rem;color:var(--text-secondary);margin-top:2px}
.routing-select{background:var(--bg-tertiary);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:0.35rem 0.6rem;font-size:0.81rem;font-family:inherit;outline:none;min-width:200px}
.routing-select:focus{border-color:var(--purple)}
.routing-row td{padding:0.55rem 0.8rem;border-bottom:1px solid rgba(255,255,255,0.04)}
.routing-category{font-weight:600;font-size:0.83rem;color:var(--text-primary)}
.routing-category small{display:block;font-weight:400;font-size:0.71rem;color:var(--text-secondary);margin-top:1px}
.llm-ab-row{display:flex;align-items:center;gap:0.8rem;padding:0.6rem 0.8rem;background:var(--bg-secondary);border-radius:8px;margin-bottom:0.5rem;font-size:0.81rem}
.llm-ab-badge{padding:2px 8px;border-radius:12px;font-size:0.68rem;font-weight:700;text-transform:uppercase}
.llm-ab-badge.pending{background:rgba(234,179,8,.15);color:#eab308}
.llm-ab-badge.won-a{background:rgba(34,197,94,.15);color:#22c55e}
.llm-ab-badge.won-b{background:rgba(168,85,247,.15);color:#a855f7}
</style>

<div class="settings-page">
    <div class="settings-tabs">
        <button class="settings-tab active" onclick="showSettingsTab('general')">
            <svg class="icon icon-sm" style="vertical-align:-2px;margin-right:4px"><use href="#icon-settings"/></svg> General
        </button>
        <button class="settings-tab" onclick="showSettingsTab('orchestrator')">
            <svg class="icon icon-sm" style="vertical-align:-2px;margin-right:4px"><use href="#icon-activity"/></svg> Orchestrator
        </button>
        <button class="settings-tab" onclick="showSettingsTab('integrations')">
            <svg class="icon icon-sm" style="vertical-align:-2px;margin-right:4px"><use href="#icon-plug"/></svg> Integrations
        </button>
        <button class="settings-tab" onclick="showSettingsTab('llm')">
            <svg class="icon icon-sm" style="vertical-align:-2px;margin-right:4px"><use href="#icon-cpu"/></svg> LLM
        </button>
    </div>

    <!-- ═══ General ═══ -->
    <div class="settings-panel active" id="panel-general">
        <section class="settings-section">
            <h3>{{ _("server") }}</h3>
            <div class="form-group">
                <label>{{ _("host") }}</label>
                <input type="text" value="{{ config.server.host }}" readonly>
            </div>
            <div class="form-group">
                <label>{{ _("port") }}</label>
                <input type="number" value="{{ config.server.port }}" readonly>
            </div>
        </section>
        <section class="settings-section">
            <h3>{{ _("orchestrator") }}</h3>
            <div class="form-group">
                <label>{{ _("default_pattern") }}</label>
                <input type="text" value="{{ config.orchestrator.default_pattern }}" readonly>
            </div>
            <div class="form-group">
                <label>{{ _("max_concurrent_sessions") }}</label>
                <input type="number" value="{{ config.orchestrator.max_parallel_agents }}" readonly>
            </div>
            <hr style="border-color:var(--border);margin:1.2rem 0">
        </section>
    </div>

    <!-- ═══ Orchestrator ═══ -->
    <div class="settings-panel" id="panel-orchestrator">
        <section class="settings-section">
            <h3>Mission Queue</h3>
            <p style="color:var(--text-secondary);font-size:0.85rem;margin-bottom:1.2rem">
                Control how missions are scheduled, throttled, and distributed across nodes.
                Changes are applied live without restart.
            </p>
            <form id="orch-concurrency-form" style="display:flex;flex-direction:column;gap:1rem">

              <!-- Concurrency -->
              <div style="color:var(--text-secondary);font-size:0.78rem;text-transform:uppercase;letter-spacing:1px;font-weight:600">Concurrency</div>
              <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:0.8rem">
                <div class="form-group">
                  <label>Max concurrent missions</label>
                  <input type="number" id="oc-semaphore" name="mission_semaphore"
                    value="{{ config.orchestrator.mission_semaphore }}" min="1" max="10" step="1" style="width:80px">
                  <span style="color:var(--text-secondary);font-size:0.75rem;margin-left:0.4rem">running in parallel</span>
                </div>
                <div class="form-group">
                  <label>Startup batch max</label>
                  <input type="number" name="resume_batch_startup"
                    value="{{ config.orchestrator.resume_batch_startup }}" min="1" max="20" step="1" style="width:80px">
                  <span style="color:var(--text-secondary);font-size:0.75rem;margin-left:0.4rem">missions per boot pass</span>
                </div>
                <div class="form-group">
                  <label>Startup stagger (s)</label>
                  <input type="number" name="resume_stagger_startup"
                    value="{{ config.orchestrator.resume_stagger_startup }}" min="1" max="300" step="1" style="width:80px">
                  <span style="color:var(--text-secondary);font-size:0.75rem;margin-left:0.4rem">delay between launches on boot</span>
                </div>
                <div class="form-group">
                  <label>Watchdog stagger (s)</label>
                  <input type="number" name="resume_stagger_watchdog"
                    value="{{ config.orchestrator.resume_stagger_watchdog }}" min="1" max="60" step="1" style="width:80px">
                  <span style="color:var(--text-secondary);font-size:0.75rem;margin-left:0.4rem">delay per watchdog cycle</span>
                </div>
              </div>

              <hr style="border-color:var(--border);margin:0.2rem 0">

              <!-- Project Slots -->
              <div style="color:var(--text-secondary);font-size:0.78rem;text-transform:uppercase;letter-spacing:1px;font-weight:600">Deployed App Containers</div>
              <div style="color:var(--text-secondary);font-size:0.8rem;margin-top:-0.4rem">
                Deployed apps run as Docker containers (<code>macaron-app-*</code>). Limit active slots to avoid RAM saturation.
                The watchdog stops the oldest containers beyond the slot limit, and stops any container older than the TTL.
              </div>
              <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:0.8rem">
                <div class="form-group">
                  <label>Max active project slots</label>
                  <input type="number" name="max_active_projects"
                    value="{{ config.orchestrator.max_active_projects }}" min="0" max="20" step="1" style="width:80px">
                  <span style="color:var(--text-secondary);font-size:0.75rem;margin-left:0.4rem">0 = unlimited</span>
                </div>
                <div class="form-group">
                  <label>Container TTL (hours)</label>
                  <input type="number" name="deployed_container_ttl_hours"
                    value="{{ config.orchestrator.deployed_container_ttl_hours }}" min="0" max="168" step="0.5" style="width:80px">
                  <span style="color:var(--text-secondary);font-size:0.75rem;margin-left:0.4rem">0 = no auto-stop</span>
                </div>
              </div>

              <hr style="border-color:var(--border);margin:0.2rem 0">

              <!-- Backpressure -->
              <div style="color:var(--text-secondary);font-size:0.78rem;text-transform:uppercase;letter-spacing:1px;font-weight:600">CPU / RAM Backpressure</div>
              <div style="color:var(--text-secondary);font-size:0.8rem;margin-top:-0.4rem">
                Before each launch, the watchdog checks system load and adapts automatically.
              </div>
              <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:0.8rem">
                <div class="form-group">
                  <label style="display:flex;align-items:center;gap:0.4rem">
                    <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#4ade80"></span> CPU green (%)
                  </label>
                  <input type="number" name="cpu_green"
                    value="{{ config.orchestrator.cpu_green }}" min="10" max="60" step="5" style="width:80px">
                  <span style="color:var(--text-secondary);font-size:0.75rem;margin-left:0.3rem">launch freely</span>
                </div>
                <div class="form-group">
                  <label style="display:flex;align-items:center;gap:0.4rem">
                    <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#facc15"></span> CPU yellow (%)
                  </label>
                  <input type="number" name="cpu_yellow"
                    value="{{ config.orchestrator.cpu_yellow }}" min="30" max="80" step="5" style="width:80px">
                  <span style="color:var(--text-secondary);font-size:0.75rem;margin-left:0.3rem">2× stagger</span>
                </div>
                <div class="form-group">
                  <label style="display:flex;align-items:center;gap:0.4rem">
                    <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#f87171"></span> CPU red (%)
                  </label>
                  <input type="number" name="cpu_red"
                    value="{{ config.orchestrator.cpu_red }}" min="50" max="95" step="5" style="width:80px">
                  <span style="color:var(--text-secondary);font-size:0.75rem;margin-left:0.3rem">skip cycle</span>
                </div>
                <div class="form-group">
                  <label style="display:flex;align-items:center;gap:0.4rem">
                    <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#f87171"></span> RAM red (%)
                  </label>
                  <input type="number" name="ram_red"
                    value="{{ config.orchestrator.ram_red }}" min="50" max="95" step="5" style="width:80px">
                  <span style="color:var(--text-secondary);font-size:0.75rem;margin-left:0.3rem">skip cycle</span>
                </div>
              </div>

              <!-- Live load indicator -->
              <div id="load-indicator" style="display:flex;gap:1.5rem;padding:0.8rem 1rem;background:var(--bg-tertiary);border-radius:8px;font-size:0.82rem;border:1px solid var(--border)">
                <span style="color:var(--text-secondary)">Live load:</span>
                <span>CPU <strong id="li-cpu">—</strong></span>
                <span>RAM <strong id="li-ram">—</strong></span>
                <span>Active missions <strong id="li-missions">—</strong></span>
                <span>Score <strong id="li-score">—</strong></span>
                <button type="button" onclick="refreshLoad()" style="margin-left:auto;background:none;border:1px solid var(--border);color:var(--text-secondary);padding:0.2rem 0.6rem;border-radius:4px;cursor:pointer;font-size:0.78rem">Refresh</button>
              </div>

              <hr style="border-color:var(--border);margin:0.2rem 0">

              <!-- Worker nodes -->
              <div style="color:var(--text-secondary);font-size:0.78rem;text-transform:uppercase;letter-spacing:1px;font-weight:600">Worker Nodes</div>
              <div style="color:var(--text-secondary);font-size:0.8rem;margin-top:-0.4rem">
                Missions are dispatched to the least-loaded node. Each node must expose <code>/api/metrics/load</code>.
                Leave empty to run everything locally.
              </div>
              <div class="form-group">
                <label>Node URLs (one per line)</label>
                <textarea name="worker_nodes" rows="4"
                  style="width:100%;max-width:520px;background:var(--bg-tertiary);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:0.6rem;font-family:var(--font-mono);font-size:0.82rem;resize:vertical"
                  placeholder="https://sf.macaron-software.com&#10;https://worker2.example.com">{{ config.orchestrator.worker_nodes | join('\n') }}</textarea>
              </div>

              <div id="worker-status" style="display:none;padding:0.6rem 1rem;background:var(--bg-tertiary);border-radius:8px;font-size:0.8rem;border:1px solid var(--border)"></div>

              <div style="display:flex;align-items:center;gap:1rem;margin-top:0.4rem">
                <button type="button" onclick="saveOrchSettings()"
                  style="background:var(--purple);color:#fff;border:none;padding:0.5rem 1.4rem;border-radius:6px;cursor:pointer;font-size:0.9rem;font-weight:600">
                  Save
                </button>
                <button type="button" onclick="pingWorkers()"
                  style="background:none;border:1px solid var(--border);color:var(--text-secondary);padding:0.5rem 1rem;border-radius:6px;cursor:pointer;font-size:0.85rem">
                  Ping workers
                </button>
                <span id="orch-save-status" style="font-size:0.82rem;color:var(--text-secondary)"></span>
              </div>
            </form>
        </section>
    </div>

    <!-- ═══ Integrations ═══ -->
    <div class="settings-panel" id="panel-integrations">
        <p style="color:var(--text-secondary);font-size:0.85rem;margin-bottom:1.2rem">
            Connect external tools. Macaron replaces Jira &amp; Confluence natively — these connectors enable import/migration and optional sync with legacy systems.
        </p>
        <div class="integ-grid">
        {% for integ in integrations %}
            {% set cfg = integ.config %}
            <div class="integ-card {% if integ.enabled %}enabled{% endif %}" id="integ-{{ integ.id }}">
                <div class="integ-header">
                    <div class="integ-icon {{ integ.id }}">
                        {% if integ.id == 'jira' %}
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M11.53 2c0 2.4 1.97 4.35 4.35 4.35h1.78v1.7c0 2.4 1.94 4.34 4.34 4.35V2.84a.84.84 0 0 0-.84-.84H11.53zM6.77 6.8a4.36 4.36 0 0 0 4.34 4.34h1.8v1.72a4.36 4.36 0 0 0 4.34 4.34V7.63a.84.84 0 0 0-.83-.83H6.77zM2 11.6a4.35 4.35 0 0 0 4.35 4.35h1.78v1.71C8.13 20.06 10.1 22 12.48 22V12.44a.84.84 0 0 0-.84-.84H2z"/></svg>
                        {% elif integ.id == 'confluence' %}
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M2.51 18.23c-.27.45-.56.96-.81 1.38a.53.53 0 0 0 .19.72l3.4 2.09a.53.53 0 0 0 .72-.17c.22-.37.5-.85.81-1.37 2.25-3.8 4.5-3.33 8.57-1.27l3.39 1.72a.53.53 0 0 0 .71-.23l1.8-3.56a.53.53 0 0 0-.23-.71c-.93-.47-2.58-1.31-3.58-1.81-6.28-3.15-11.2-2.8-14.97 3.21z"/><path d="M21.49 5.77c.27-.45.56-.96.81-1.38a.53.53 0 0 0-.19-.72l-3.4-2.09a.53.53 0 0 0-.72.17c-.22.37-.5.85-.81 1.37-2.25 3.8-4.5 3.33-8.57 1.27L5.22 2.67a.53.53 0 0 0-.71.23l-1.8 3.56a.53.53 0 0 0 .23.71c.93.47 2.58 1.31 3.58 1.81 6.28 3.15 11.2 2.8 14.97-3.21z"/></svg>
                        {% elif integ.id == 'xray' %}
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 12l3 3 5-5"/></svg>
                        {% elif integ.id == 'sonarqube' %}
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M15.53 3.59a.75.75 0 0 0-.97-.37.75.75 0 0 0-.37.97C16.22 8.95 16.22 13.1 14.19 17.86a.75.75 0 0 0 1.34.68c2.19-5.14 2.19-9.67.0-14.95zM19.27 1.8a.75.75 0 0 0-1.06-.27.75.75 0 0 0-.27 1.06c3.64 6 3.64 12.82 0 18.82a.75.75 0 0 0 1.33.7C23.18 15.5 23.18 8.5 19.27 1.8zM11.79 5.96a.75.75 0 0 0-.87-.6.75.75 0 0 0-.6.87c.72 4.2-.07 7.56-2.38 10.18a.75.75 0 0 0 1.12 1c2.63-2.98 3.53-6.78 2.73-11.45zM7.82 8.76a.75.75 0 0 0-.73-.77.75.75 0 0 0-.77.73C6.07 13.58 4.56 16.1 2.2 17.54a.75.75 0 0 0 .78 1.28c2.82-1.72 4.55-4.68 4.84-10.06z"/></svg>
                        {% elif integ.id == 'gitlab' %}
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M22.65 14.39L12 22.13 1.35 14.39a.84.84 0 0 1-.3-.94l1.22-3.78 2.44-7.51a.43.43 0 0 1 .82 0l2.44 7.51h8.06l2.44-7.51a.43.43 0 0 1 .82 0l2.44 7.51 1.22 3.78a.84.84 0 0 1-.3.94z"/></svg>
                        {% elif integ.id == 'azure-devops' %}
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M22 5.5v13l-5.5 3.5-8.47-3.08v3.08L3 15.73l14.03 1.1V5.27L22 5.5zM5.03 7.77L11 5.5v14.28l-5.97-2.15V7.77z"/></svg>
                        {% endif %}
                    </div>
                    <div class="integ-info">
                        <div class="integ-name">{{ integ.name }}</div>
                        <div class="integ-type">{{ integ.type|replace('_',' ') }}</div>
                    </div>
                    <label class="integ-toggle">
                        <input type="checkbox" {% if integ.enabled %}checked{% endif %} onchange="toggleInteg('{{ integ.id }}', this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="integ-desc">
                    {% if integ.id == 'jira' %}Import backlogs from existing Jira projects. One-way migration or optional bidirectional sync.
                    {% elif integ.id == 'confluence' %}Import documentation into Memory. Auto-publish ADRs and retrospectives.
                    {% elif integ.id == 'xray' %}Sync test plans and results. Trace requirements to E2E tests for AO compliance.
                    {% elif integ.id == 'sonarqube' %}Pull quality gates, coverage, code smells into adversarial review pipeline.
                    {% elif integ.id == 'gitlab' %}Alternative to GitHub for CI/CD pipelines, MR reviews, and container registry.
                    {% elif integ.id == 'azure-devops' %}Boards and Pipelines sync for Microsoft enterprise environments.
                    {% endif %}
                </div>
                <div class="integ-body">
                    {% if integ.id == 'jira' %}
                    <div class="integ-field">
                        <label>URL</label>
                        <input type="url" placeholder="https://company.atlassian.net" value="{{ cfg.get('url','') }}" data-integ="{{ integ.id }}" data-key="url">
                    </div>
                    <div class="integ-field">
                        <label>Project Key</label>
                        <input type="text" placeholder="LPD" value="{{ cfg.get('project_key','') }}" data-integ="{{ integ.id }}" data-key="project_key">
                    </div>
                    <div class="integ-field">
                        <label>Mode</label>
                        <select data-integ="{{ integ.id }}" data-key="mode">
                            <option value="import" {% if cfg.get('mode')=='import' %}selected{% endif %}>Import only (Jira → Macaron)</option>
                            <option value="bidirectional" {% if cfg.get('mode')=='bidirectional' %}selected{% endif %}>Bidirectional sync</option>
                        </select>
                    </div>
                    {% elif integ.id == 'confluence' %}
                    <div class="integ-field">
                        <label>URL</label>
                        <input type="url" placeholder="https://company.atlassian.net/wiki" value="{{ cfg.get('url','') }}" data-integ="{{ integ.id }}" data-key="url">
                    </div>
                    <div class="integ-field">
                        <label>Space Key</label>
                        <input type="text" placeholder="LPD" value="{{ cfg.get('space_key','') }}" data-integ="{{ integ.id }}" data-key="space_key">
                    </div>
                    {% elif integ.id == 'xray' %}
                    <div class="integ-field">
                        <label>Xray Cloud URL</label>
                        <input type="url" placeholder="https://xray.cloud.getxray.app" value="{{ cfg.get('url','') }}" data-integ="{{ integ.id }}" data-key="url">
                    </div>
                    {% elif integ.id == 'sonarqube' %}
                    <div class="integ-field">
                        <label>URL</label>
                        <input type="url" placeholder="https://sonarqube.company.com" value="{{ cfg.get('url','') }}" data-integ="{{ integ.id }}" data-key="url">
                    </div>
                    <div class="integ-field">
                        <label>Project Key</label>
                        <input type="text" placeholder="my-project" value="{{ cfg.get('project_key','') }}" data-integ="{{ integ.id }}" data-key="project_key">
                    </div>
                    {% elif integ.id == 'gitlab' %}
                    <div class="integ-field">
                        <label>GitLab URL</label>
                        <input type="url" placeholder="https://gitlab.company.com" value="{{ cfg.get('url','') }}" data-integ="{{ integ.id }}" data-key="url">
                    </div>
                    <div class="integ-field">
                        <label>Project ID</label>
                        <input type="text" placeholder="42" value="{{ cfg.get('project_id','') }}" data-integ="{{ integ.id }}" data-key="project_id">
                    </div>
                    {% elif integ.id == 'azure-devops' %}
                    <div class="integ-field">
                        <label>Organization</label>
                        <input type="text" placeholder="myorg" value="{{ cfg.get('org','') }}" data-integ="{{ integ.id }}" data-key="org">
                    </div>
                    <div class="integ-field">
                        <label>Project</label>
                        <input type="text" placeholder="MyProject" value="{{ cfg.get('project','') }}" data-integ="{{ integ.id }}" data-key="project">
                    </div>
                    {% endif %}
                    <div class="integ-field">
                        <label>API Token</label>
                        <input type="password" placeholder="••••••••" value="" data-integ="{{ integ.id }}" data-key="api_token">
                    </div>
                </div>
                <div class="integ-status">
                    <span class="integ-status-dot {{ integ.status }}"></span>
                    <span>{{ integ.status }}</span>
                    {% if integ.last_sync %}<span style="margin-left:auto;opacity:.6">Last sync: {{ integ.last_sync | ts }}</span>{% endif %}
                </div>
                <div class="integ-actions">
                    <button class="btn btn-ghost btn-sm" onclick="saveInteg('{{ integ.id }}')" style="font-size:0.72rem">
                        <svg class="icon icon-sm" style="width:13px;height:13px"><use href="#icon-save"/></svg> Save
                    </button>
                    <button class="btn btn-ghost btn-sm" onclick="testInteg('{{ integ.id }}')" style="font-size:0.72rem">
                        <svg class="icon icon-sm" style="width:13px;height:13px"><use href="#icon-zap"/></svg> Test
                    </button>
                </div>
            </div>
        {% endfor %}
        </div>
    </div>

    <!-- ═══ LLM ═══ -->
    <div class="settings-panel" id="panel-llm">

        <!-- Providers -->
        <section class="settings-section">
            <h3>Providers</h3>
            <div id="llm-providers-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1rem;margin-top:1rem">
                <p style="color:var(--text-secondary);font-size:0.85rem">Loading...</p>
            </div>
        </section>

        <!-- Routing assignment matrix -->
        <section class="settings-section" style="margin-top:2rem">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
                <div>
                    <h3 style="margin:0">Routing</h3>
                    <p style="font-size:0.78rem;color:var(--text-secondary);margin:4px 0 0">Assign LLM models per task category. Darwin Thompson Sampling will learn which model performs best for each team × category.</p>
                </div>
                <button class="btn btn-primary btn-sm" onclick="saveLLMRouting()" id="routing-save-btn">
                    <svg class="icon icon-sm"><use href="#icon-save"/></svg> Save
                </button>
            </div>
            <div style="overflow-x:auto">
            <table style="width:100%;border-collapse:collapse;font-size:0.83rem" id="routing-table">
                <thead>
                    <tr style="border-bottom:1px solid var(--border)">
                        <th style="text-align:left;padding:0.5rem 0.8rem;color:var(--text-secondary);font-weight:600;font-size:0.72rem;text-transform:uppercase;letter-spacing:.3px">Category</th>
                        <th style="text-align:left;padding:0.5rem 0.8rem;color:var(--text-secondary);font-weight:600;font-size:0.72rem;text-transform:uppercase;letter-spacing:.3px">Lourd (heavy)</th>
                        <th style="text-align:left;padding:0.5rem 0.8rem;color:var(--text-secondary);font-weight:600;font-size:0.72rem;text-transform:uppercase;letter-spacing:.3px">Léger (light)</th>
                    </tr>
                </thead>
                <tbody id="routing-tbody">
                    <tr><td colspan="3" style="padding:1rem;color:var(--text-secondary)">Loading...</td></tr>
                </tbody>
            </table>
            </div>
        </section>

        <!-- Darwin LLM Thompson Sampling -->
        <section class="settings-section" style="margin-top:2rem">
            <h3>Darwin LLM A/B</h3>
            <p style="font-size:0.78rem;color:var(--text-secondary);margin-bottom:1rem">Thompson Sampling comparing the same team (agent+pattern) across different LLM models. Winners emerge from real mission outcomes.</p>
            <div id="llm-ab-list">
                <p style="color:var(--text-secondary);font-size:0.85rem">Loading...</p>
            </div>
            <div style="margin-top:1rem">
                <a href="/teams" style="font-size:0.78rem;color:var(--purple)">View full LLM leaderboard on Teams tab →</a>
            </div>
        </section>

    </div>
</div>

<script>
function showSettingsTab(id) {
    document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.settings-panel').forEach(p => p.classList.remove('active'));
    document.getElementById('panel-'+id).classList.add('active');
    event.target.closest('.settings-tab').classList.add('active');
    try { localStorage.setItem('settings_tab', id); } catch(e){}
    if (id === 'llm') loadLLMTab();
    if (id === 'orchestrator') refreshLoad();
}
// Restore last tab
try {
    const last = localStorage.getItem('settings_tab');
    if (last) showSettingsTab(last);
} catch(e){}

async function saveOrchSettings() {
  const form = document.getElementById('orch-concurrency-form');
  const data = {};
  form.querySelectorAll('input[name]').forEach(el => {
    data[el.name] = el.type === 'number' ? Number(el.value) : el.value;
  });
  const ta = form.querySelector('textarea[name="worker_nodes"]');
  if (ta) data['worker_nodes'] = ta.value;
  const st = document.getElementById('orch-save-status');
  st.textContent = 'Saving…';
  try {
    const r = await fetch('/api/settings/orchestrator', {
      method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data)
    });
    const j = await r.json();
    if (j.ok) {
      st.style.color = 'var(--green, #4ade80)';
      st.textContent = 'Saved — applied live';
      setTimeout(() => { st.textContent = ''; }, 3000);
    } else {
      st.style.color = 'var(--accent)';
      st.textContent = 'Error: ' + JSON.stringify(j);
    }
  } catch(e) {
    st.style.color = 'var(--accent)';
    st.textContent = 'Error: ' + e.message;
  }
}

async function refreshLoad() {
  try {
    const r = await fetch('/api/metrics/load');
    if (!r.ok) return;
    const d = await r.json();
    const cpu = d.cpu_percent ?? '—';
    const ram = d.ram_percent ?? '—';
    const score = d.load_score ?? '—';
    const missions = d.active_missions ?? '—';
    document.getElementById('li-cpu').textContent = cpu + '%';
    document.getElementById('li-ram').textContent = ram + '%';
    document.getElementById('li-missions').textContent = missions;
    document.getElementById('li-score').textContent = score;
    const li = document.getElementById('load-indicator');
    const color = cpu >= 85 ? '#f87171' : cpu >= 70 ? '#facc15' : '#4ade80';
    li.style.borderColor = color;
  } catch(e) {}
}

async function pingWorkers() {
  const ta = document.querySelector('textarea[name="worker_nodes"]');
  const urls = (ta?.value || '').split('\n').map(s => s.trim()).filter(Boolean);
  const box = document.getElementById('worker-status');
  if (!urls.length) { box.style.display='none'; return; }
  box.style.display = 'block';
  box.innerHTML = 'Pinging…';
  const results = await Promise.all(urls.map(async url => {
    try {
      const r = await fetch(url.replace(/\/$/, '') + '/api/metrics/load', {signal: AbortSignal.timeout(4000)});
      if (!r.ok) return `<span style="color:#f87171">${url} — HTTP ${r.status}</span>`;
      const d = await r.json();
      const color = d.load_score >= 85 ? '#f87171' : d.load_score >= 70 ? '#facc15' : '#4ade80';
      return `<span style="color:${color}">${url} — CPU ${d.cpu_percent}% RAM ${d.ram_percent}% score ${d.load_score} (${d.active_missions} missions)</span>`;
    } catch(e) {
      return `<span style="color:#f87171">${url} — unreachable: ${e.message}</span>`;
    }
  }));
  box.innerHTML = results.join('<br>');
}

async function toggleInteg(id, enabled) {
    await fetch(`/api/integrations/${id}`, {
        method: 'PATCH',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({enabled})
    });
    document.getElementById('integ-'+id).classList.toggle('enabled', enabled);
}

function _gatherConfig(id) {
    const cfg = {};
    document.querySelectorAll(`[data-integ="${id}"]`).forEach(el => {
        const k = el.dataset.key;
        if (k === 'api_token' && !el.value) return;
        cfg[k] = el.value;
    });
    return cfg;
}

async function saveInteg(id) {
    const cfg = _gatherConfig(id);
    const r = await fetch(`/api/integrations/${id}`, {
        method: 'PATCH',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({config: cfg})
    });
    const j = await r.json();
    if (j.ok) {
        const btn = event.target.closest('button');
        btn.textContent = '[+] Saved'; setTimeout(() => btn.innerHTML = '<svg class="icon icon-sm" style="width:13px;height:13px"><use href="#icon-save"/></svg> Save', 1500);
    }
}

async function testInteg(id) {
    const btn = event.target.closest('button');
    btn.disabled = true; btn.textContent = 'Testing...';
    const r = await fetch(`/api/integrations/${id}/test`, {method: 'POST'});
    const j = await r.json();
    const dot = document.querySelector(`#integ-${id} .integ-status-dot`);
    const label = document.querySelector(`#integ-${id} .integ-status span:last-of-type`);
    dot.className = 'integ-status-dot ' + (j.ok ? 'connected' : 'error');
    if (label) label.textContent = j.ok ? 'connected' : 'error: ' + (j.error || 'failed');
    btn.disabled = false; btn.innerHTML = '<svg class="icon icon-sm" style="width:13px;height:13px"><use href="#icon-zap"/></svg> Test';
}

// Custom AI Providers
async function loadCustomProviders() {
    try {
        const r = await fetch('/api/ai-providers');
        const j = await r.json();
        const list = document.getElementById('custom-providers-list');
        
        if (!j.ok || !j.providers || j.providers.length === 0) {
            list.innerHTML = '<p style="color:var(--text-secondary);font-size:0.85rem">No custom providers configured</p>';
            return;
        }
        
        list.innerHTML = j.providers.map(p => `
            <div class="integ-card ${p.enabled ? 'enabled' : ''}" style="margin-bottom:1rem">
                <div class="integ-header">
                    <div class="integ-icon" style="background:rgba(124,58,237,.15);color:#7c3aed">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6M23 12h-6m-6 0H5"/></svg>
                    </div>
                    <div class="integ-info">
                        <div class="integ-name">${p.name}</div>
                        <div class="integ-type">${p.provider_type}</div>
                    </div>
                    <label class="integ-toggle">
                        <input type="checkbox" ${p.enabled ? 'checked' : ''} onchange="toggleCustomProvider('${p.id}', this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="integ-desc">
                    Base URL: ${p.base_url}<br>
                    Model: ${p.default_model}
                </div>
                <div class="integ-actions">
                    <button class="btn btn-ghost btn-sm" onclick="testCustomProvider('${p.id}')" style="font-size:0.72rem">
                        <svg class="icon icon-sm" style="width:13px;height:13px"><use href="#icon-zap"/></svg> Test
                    </button>
                    <button class="btn btn-ghost btn-sm" onclick="deleteCustomProvider('${p.id}')" style="font-size:0.72rem;color:var(--red)">
                        <svg class="icon icon-sm" style="width:13px;height:13px"><use href="#icon-trash"/></svg> Delete
                    </button>
                </div>
            </div>
        `).join('');
    } catch (e) {
        console.error('Failed to load custom providers:', e);
    }
}

function showAddProviderModal() {
    document.getElementById('add-provider-modal').style.display = 'block';
    document.getElementById('add-provider-form').reset();
}

async function saveCustomProvider(e) {
    e.preventDefault();
    const form = e.target;
    const data = {
        name: form.name.value,
        provider_type: form.provider_type.value,
        base_url: form.base_url.value,
        api_key: form.api_key.value,
        default_model: form.default_model.value
    };
    
    try {
        const r = await fetch('/api/ai-providers', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        const j = await r.json();
        
        if (j.ok) {
            document.getElementById('add-provider-modal').style.display = 'none';
            loadCustomProviders();
        } else {
            alert('Error: ' + (j.error || 'Failed to save provider'));
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

async function toggleCustomProvider(id, enabled) {
    await fetch(`/api/ai-providers/${id}`, {
        method: 'PATCH',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({enabled})
    });
}

async function testCustomProvider(id) {
    const btn = event.target.closest('button');
    btn.disabled = true;
    btn.textContent = 'Testing...';
    
    try {
        const r = await fetch(`/api/ai-providers/${id}/test`, {method: 'POST'});
        const j = await r.json();
        
        if (j.ok) {
            btn.textContent = '[+] Connected';
            setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = '<svg class="icon icon-sm" style="width:13px;height:13px"><use href="#icon-zap"/></svg> Test';
            }, 2000);
        } else {
            alert('Connection failed: ' + (j.error || 'Unknown error'));
            btn.disabled = false;
            btn.innerHTML = '<svg class="icon icon-sm" style="width:13px;height:13px"><use href="#icon-zap"/></svg> Test';
        }
    } catch (e) {
        alert('Error: ' + e.message);
        btn.disabled = false;
        btn.innerHTML = '<svg class="icon icon-sm" style="width:13px;height:13px"><use href="#icon-zap"/></svg> Test';
    }
}

async function deleteCustomProvider(id) {
    if (!confirm('Delete this provider?')) return;
    
    try {
        const r = await fetch(`/api/ai-providers/${id}`, {method: 'DELETE'});
        const j = await r.json();
        
        if (j.ok) {
            loadCustomProviders();
        } else {
            alert('Error: ' + (j.error || 'Failed to delete'));
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

// ── LLM Tab ──────────────────────────────────────────────────────────────

let _llmModels = [];
const _ROUTING_ROWS = [
    {key_heavy:'reasoning_heavy', key_light:'reasoning_light', label:'Reasoning', sub:'Architecture, planning, strategy'},
    {key_heavy:'production_heavy', key_light:'production_light', label:'Production / Code', sub:'Developer, tester, security'},
    {key_heavy:'tasks_heavy',  key_light:'tasks_light',  label:'Tasks', sub:'Generic agent work, tools'},
    {key_heavy:'redaction_heavy', key_light:'redaction_light', label:'Redaction', sub:'Docs, summaries, reports'},
];

async function loadLLMTab() {
    try {
        const r = await fetch('/api/llm/routing');
        const d = await r.json();
        _llmModels = d.models || [];
        renderProviders(d.providers || []);
        renderRoutingTable(d.routing || {});
        loadLLMABTests();
    } catch(e) {
        document.getElementById('llm-providers-grid').innerHTML = '<p style="color:var(--red)">Failed to load: ' + e.message + '</p>';
    }
}

function renderProviders(providers) {
    const grid = document.getElementById('llm-providers-grid');
    if (!providers.length) { grid.innerHTML = '<p style="color:var(--text-secondary)">No providers configured</p>'; return; }
    const colors = {'azure-ai':'rgba(0,120,212,.15)','azure-openai':'rgba(0,120,212,.12)','minimax':'rgba(34,197,94,.12)','nvidia':'rgba(118,185,0,.12)'};
    const textColors = {'azure-ai':'#0078d4','azure-openai':'#0065b3','minimax':'#22c55e','nvidia':'#76b900'};
    grid.innerHTML = providers.map(p => {
        const canToggle = p.has_key;
        const statusLabel = !p.has_key ? 'no key' : (p.manually_disabled ? 'disabled' : 'active');
        const statusClass = !p.has_key ? 'badge-red' : (p.manually_disabled ? 'badge-yellow' : 'badge-green');
        const toggleChecked = p.enabled ? 'checked' : '';
        const toggleDisabled = !p.has_key ? 'disabled' : '';
        const toggleTitle = !p.has_key ? `Set ${p.id.toUpperCase().replace(/-/g,'_')}_API_KEY to enable` : (p.enabled ? 'Click to disable' : 'Click to enable');
        return `
        <div class="llm-provider-card ${p.enabled ? 'active' : 'inactive'}" id="prov-card-${p.id}">
            <div class="llm-prov-header">
                <div style="display:flex;align-items:center;gap:0.6rem">
                    <div style="width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;background:${colors[p.id]||'rgba(124,58,237,.12)'};color:${textColors[p.id]||'#7c3aed'};font-size:0.75rem;font-weight:800">${p.id.split('-').map(w=>w[0].toUpperCase()).join('')}</div>
                    <div>
                        <div class="llm-prov-name">${p.name}</div>
                        <div class="llm-prov-models">${p.models.join(' · ')}</div>
                    </div>
                </div>
                <div style="display:flex;align-items:center;gap:0.7rem">
                    <span class="badge ${statusClass}" style="font-size:0.68rem" id="prov-badge-${p.id}">${statusLabel}</span>
                    <label title="${toggleTitle}" style="cursor:${canToggle?'pointer':'not-allowed'};display:flex;align-items:center;gap:0;margin:0" onclick="toggleProvider(event,'${p.id}')">
                        <input type="checkbox" ${toggleChecked} ${toggleDisabled}
                            style="display:none"
                            id="prov-toggle-${p.id}">
                        <span style="
                            display:inline-block;width:34px;height:18px;border-radius:9px;position:relative;
                            background:${p.enabled?'var(--purple)':'var(--border)'};
                            transition:background .2s;
                            opacity:${canToggle?'1':'.45'}
                        " id="prov-track-${p.id}">
                            <span style="
                                position:absolute;top:2px;left:${p.enabled?'16px':'2px'};
                                width:14px;height:14px;border-radius:50%;background:#fff;
                                transition:left .2s;
                            " id="prov-thumb-${p.id}"></span>
                        </span>
                    </label>
                </div>
            </div>
            ${!p.has_key ? `<p style="font-size:0.72rem;color:var(--text-secondary);margin:0.4rem 0 0">Set <code>${p.id.toUpperCase().replace(/-/g,'_')}_API_KEY</code> env var to enable</p>` : ''}
        </div>`;
    }).join('');
}

async function toggleProvider(event, providerId) {
    event.preventDefault();
    const card = document.getElementById('prov-card-' + providerId);
    const track = document.getElementById('prov-track-' + providerId);
    const thumb = document.getElementById('prov-thumb-' + providerId);
    const badge = document.getElementById('prov-badge-' + providerId);
    const input = document.getElementById('prov-toggle-' + providerId);
    if (input.disabled) return;
    try {
        const r = await fetch('/api/llm/providers/' + providerId + '/toggle', {method:'POST'});
        const d = await r.json();
        if (!d.ok) { console.error('toggle failed', d); return; }
        const enabled = d.enabled;
        input.checked = enabled;
        card.classList.toggle('active', enabled);
        card.classList.toggle('inactive', !enabled);
        track.style.background = enabled ? 'var(--purple)' : 'var(--border)';
        thumb.style.left = enabled ? '16px' : '2px';
        badge.textContent = enabled ? 'active' : 'disabled';
        badge.className = 'badge ' + (enabled ? 'badge-green' : 'badge-yellow');
        badge.style.fontSize = '0.68rem';
    } catch(e) { console.error(e); }
}

function _modelSelect(key, currentVal) {
    const opts = _llmModels.map(m => {
        const val = m.provider + '::' + m.model;
        const cur = currentVal ? (currentVal.provider + '::' + currentVal.model) : '';
        const disabled = !m.enabled ? ' style="color:var(--text-secondary)"' : '';
        return `<option value="${val}" ${val===cur?'selected':''}${disabled}>${m.label}</option>`;
    }).join('');
    return `<select class="routing-select" data-routing-key="${key}">${opts}</select>`;
}

function renderRoutingTable(routing) {
    const tbody = document.getElementById('routing-tbody');
    tbody.innerHTML = _ROUTING_ROWS.map(row => `
        <tr class="routing-row">
            <td><span class="routing-category">${row.label}<small>${row.sub}</small></span></td>
            <td>${_modelSelect(row.key_heavy, routing[row.key_heavy])}</td>
            <td>${_modelSelect(row.key_light, routing[row.key_light])}</td>
        </tr>
    `).join('');
}

async function saveLLMRouting() {
    const btn = document.getElementById('routing-save-btn');
    btn.disabled = true; btn.textContent = 'Saving...';
    const routing = {};
    document.querySelectorAll('[data-routing-key]').forEach(sel => {
        const [provider, model] = sel.value.split('::');
        routing[sel.dataset.routingKey] = {provider, model};
    });
    try {
        const r = await fetch('/api/llm/routing', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({routing})
        });
        const j = await r.json();
        if (j.ok) {
            btn.innerHTML = '<svg class="icon icon-sm"><use href="#icon-check"/></svg> Saved';
            setTimeout(() => { btn.disabled=false; btn.innerHTML='<svg class="icon icon-sm"><use href="#icon-save"/></svg> Save'; }, 2000);
        } else {
            alert('Error: ' + (j.error || 'failed'));
            btn.disabled=false; btn.innerHTML='<svg class="icon icon-sm"><use href="#icon-save"/></svg> Save';
        }
    } catch(e) {
        alert(e.message); btn.disabled=false; btn.innerHTML='<svg class="icon icon-sm"><use href="#icon-save"/></svg> Save';
    }
}

async function loadLLMABTests() {
    try {
        const r = await fetch('/api/teams/llm-ab-tests?limit=10');
        const d = await r.json();
        const el = document.getElementById('llm-ab-list');
        if (!d.data || !d.data.length) {
            el.innerHTML = '<p style="color:var(--text-secondary);font-size:0.82rem">No LLM A/B tests yet. They start automatically once missions accumulate fitness data for multiple models per team.</p>';
            return;
        }
        el.innerHTML = d.data.map(t => {
            const badge = t.winner_llm ? (t.winner_llm === t.llm_a ? 'won-a' : 'won-b') : 'pending';
            const winner = t.winner_llm || 'pending';
            return `
            <div class="llm-ab-row">
                <div style="flex:1;min-width:0">
                    <div style="font-weight:600;font-size:0.81rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${t.agent_id} · ${t.pattern_id}</div>
                    <div style="font-size:0.72rem;color:var(--text-secondary)">${t.technology}/${t.phase_type}</div>
                </div>
                <div style="display:flex;align-items:center;gap:0.5rem;font-size:0.78rem">
                    <span style="color:var(--text-secondary)">${t.llm_a}</span>
                    <span style="color:var(--text-secondary)">vs</span>
                    <span style="color:var(--text-secondary)">${t.llm_b}</span>
                </div>
                <span class="llm-ab-badge ${badge}">${winner}</span>
                ${t.llm_a_score != null ? `<span style="font-size:0.72rem;color:var(--text-secondary)">${t.llm_a_score?.toFixed(1)} / ${t.llm_b_score?.toFixed(1)}</span>` : ''}
            </div>`;
        }).join('');
    } catch(e) { console.error(e); }
}
</script>
{% endblock %}
