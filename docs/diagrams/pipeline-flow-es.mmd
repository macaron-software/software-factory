flowchart LR
    START((Mision\nCreada)) --> INIT[Inicializar\nWorkflow]
    INIT --> SELECT{Seleccionar\nPatron}

    SELECT -->|secuencial| SEQ[Fase 1\nFase 2\nFase N]
    SELECT -->|paralelo| PAR[Fase A + B\nsimultaneo]
    SELECT -->|jerarquico| HIER[Manager\ndelega a\nsub-agentes]
    SELECT -->|adversarial| ADV[Generador\nvs Critico]

    SEQ --> PHASE
    PAR --> PHASE
    HIER --> PHASE
    ADV --> PHASE

    subgraph PHASE_EXEC["Ejecucion de Fase"]
        PHASE[Ejecutar Fase] --> AGENT[Agente\nEjecutor]
        AGENT --> LLM_CALL[Llamada LLM\ncon herramientas]
        LLM_CALL --> RESULT{Resultado}

        RESULT -->|exito| BUILD_CHK{Fase\ncodigo?}
        BUILD_CHK -->|si| SANDBOX[Validacion\nBuild Sandbox]
        BUILD_CHK -->|no| GATE
        SANDBOX -->|ok| GATE
        SANDBOX -->|fallo| INJECT[Inyectar Error\nen Contexto]
        INJECT --> RETRY_B{Intentos\nrestantes?}
        RETRY_B -->|si| AGENT
        RETRY_B -->|no| SKIP_CHK

        RESULT -->|fallo| RETRY{Intentos\nrestantes?}
        RETRY -->|si, backoff| AGENT
        RETRY -->|no| SKIP_CHK{skip_on\n_failure?}
        SKIP_CHK -->|si| GATE
        SKIP_CHK -->|no| PAUSED

        GATE[Puerta\nCalidad] --> GATE_R{Resultado\nPuerta}
        GATE_R -->|pasa| CHECKPOINT[Checkpoint\nFase Completada]
        GATE_R -->|fallo| PAUSED
    end

    CHECKPOINT --> NEXT{Mas\nFases?}
    NEXT -->|si| PHASE
    NEXT -->|no| COMPLETE((Mision\nCompletada))

    PAUSED((Run\nPausado)) -.->|watchdog\nauto-reanudacion| PHASE

    classDef start fill:#c8e6c9,stroke:#2e7d32,color:#000
    classDef process fill:#e3f2fd,stroke:#1565c0,color:#000
    classDef decision fill:#fff3e0,stroke:#e65100,color:#000
    classDef error fill:#ffcdd2,stroke:#c62828,color:#000
    classDef success fill:#c8e6c9,stroke:#2e7d32,color:#000
    classDef pattern fill:#e0f7fa,stroke:#00695c,color:#000

    class START,COMPLETE success
    class PAUSED error
    class PHASE,AGENT,LLM_CALL,GATE,CHECKPOINT,SANDBOX,INJECT process
    class RESULT,RETRY,SKIP_CHK,BUILD_CHK,GATE_R,NEXT,SELECT,RETRY_B decision
    class INIT,SEQ,PAR,HIER,ADV pattern
