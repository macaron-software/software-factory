flowchart LR
    START((Mission\nErstellt)) --> INIT[Workflow\nInitialisieren]
    INIT --> SELECT{Pattern\nWahlen}

    SELECT -->|Sequenziell| SEQ[Phase 1\nPhase 2\nPhase N]
    SELECT -->|Parallel| PAR[Phase A + B\nGleichzeitig]
    SELECT -->|Hierarchisch| HIER[Manager\ndelegates to\nsub-agents]
    SELECT -->|Adversarial| ADV[Generator\nvs Kritiker]

    SEQ --> PHASE
    PAR --> PHASE
    HIER --> PHASE
    ADV --> PHASE

    subgraph PHASE_EXEC["Phasen-Ausfuhrung"]
        PHASE[Phase Ausfuhren] --> AGENT[Agent\nAusfuhrer]
        AGENT --> LLM_CALL[LLM-Aufruf\nmit Werkzeugen]
        LLM_CALL --> RESULT{Ergebnis}

        RESULT -->|Erfolg| BUILD_CHK{Code-\nPhase?}
        BUILD_CHK -->|yes| SANDBOX[Sandbox\nBuild-Prufung]
        BUILD_CHK -->|no| GATE
        SANDBOX -->|Bestanden| GATE
        SANDBOX -->|fail| INJECT[Fehler in\nKontext Einfugen]
        INJECT --> RETRY_B{Versuche\nubrig?}
        RETRY_B -->|yes| AGENT
        RETRY_B -->|no| SKIP_CHK

        RESULT -->|Fehler| RETRY{Versuche\nubrig?}
        RETRY -->|yes, backoff| AGENT
        RETRY -->|no| SKIP_CHK{skip_on\n_Fehler?}
        SKIP_CHK -->|yes| GATE
        SKIP_CHK -->|no| PAUSED

        GATE[Qualitats-\nTor] --> GATE_R{Gate\nErgebnis}
        GATE_R -->|Bestanden| CHECKPOINT[Checkpoint\nPhase Fertig]
        GATE_R -->|fail| PAUSED
    end

    CHECKPOINT --> NEXT{Weitere\nPhasen?}
    NEXT -->|yes| PHASE
    NEXT -->|no| COMPLETE((Mission\nAbgeschlossen))

    PAUSED((Run\nPausiert)) -.->|Watchdog\nAuto-Wiederaufnahme| PHASE

    classDef start fill:#c8e6c9,stroke:#2e7d32,color:#000
    classDef process fill:#e3f2fd,stroke:#1565c0,color:#000
    classDef decision fill:#fff3e0,stroke:#e65100,color:#000
    classDef error fill:#ffcdd2,stroke:#c62828,color:#000
    classDef Erfolg fill:#c8e6c9,stroke:#2e7d32,color:#000
    classDef pattern fill:#e0f7fa,stroke:#00695c,color:#000

    class START,COMPLETE Erfolg
    class PAUSED error
    class PHASE,AGENT,LLM_CALL,GATE,CHECKPOINT,SANDBOX,INJECT process
    class RESULT,RETRY,SKIP_CHK,BUILD_CHK,GATE_R,NEXT,SELECT,RETRY_B decision
    class INIT,SEQ,PAR,HIER,ADV pattern
