{% extends "base.html" %}

{% block topbar_actions %}
<span class="badge" style="background:var(--purple);color:#fff;font-size:0.72rem;padding:0.2rem 0.6rem;border-radius:4px">
    {{ mission.status.value|upper }}
</span>
{% endblock %}

{% block content %}
<link rel="stylesheet" href="/static/css/mission-control.css?v=20260221">


<!-- SVG defs for pattern-colored arrow markers -->
<svg width="0" height="0" style="position:absolute">
  <defs>
    <marker id="mc-arrow-sequential" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="7" markerHeight="7" orient="auto-start-reverse"><path d="M0,0 L10,5 L0,10 z" fill="#3b82f6" opacity="0.8"/></marker>
    <marker id="mc-arrow-hierarchical" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="7" markerHeight="7" orient="auto-start-reverse"><path d="M0,0 L10,5 L0,10 z" fill="#f59e0b" opacity="0.8"/></marker>
    <marker id="mc-arrow-parallel" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="7" markerHeight="7" orient="auto-start-reverse"><path d="M0,0 L10,5 L0,10 z" fill="#10b981" opacity="0.8"/></marker>
    <marker id="mc-arrow-loop" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="7" markerHeight="7" orient="auto-start-reverse"><path d="M0,0 L10,5 L0,10 z" fill="#ec4899" opacity="0.8"/></marker>
    <marker id="mc-arrow-network" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="7" markerHeight="7" orient="auto-start-reverse"><path d="M0,0 L10,5 L0,10 z" fill="#8b5cf6" opacity="0.8"/></marker>
    <marker id="mc-arrow-router" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="7" markerHeight="7" orient="auto-start-reverse"><path d="M0,0 L10,5 L0,10 z" fill="#06b6d4" opacity="0.8"/></marker>
    <marker id="mc-arrow-default" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="7" markerHeight="7" orient="auto-start-reverse"><path d="M0,0 L10,5 L0,10 z" fill="#6b7280" opacity="0.6"/></marker>
  </defs>
</svg>

<div class="mc-layout">
    <!-- ====== MAIN: Timeline + Accordions ====== -->
    <div class="mc-main">
        {% if mission.brief %}
        <div style="background:var(--bg-tertiary);border:1px solid var(--border);border-radius:8px;padding:0.6rem 0.85rem;margin-bottom:0.5rem;display:flex;align-items:baseline;gap:0.5rem">
            <span style="font-size:0.7rem;color:var(--purple);font-weight:700;white-space:nowrap">{{ _("demande") }}</span>
            <span style="font-size:0.82rem;color:var(--text-primary);line-height:1.4">{{ mission.brief }}</span>
        </div>
        {% endif %}

        {# ‚îÄ‚îÄ Result Banner: screenshots + build/run + deploy URL ‚îÄ‚îÄ #}
        {% if result_screenshots or result_build_cmd or result_deploy_url or result_launch_cmd %}
        <div class="mc-result-banner">
            <div class="mc-result-header">
                <span style="font-size:0.7rem;color:var(--green);font-weight:700">{{ _("resultat") }}</span>
                {% if result_project_type %}
                <span style="font-size:0.65rem;background:var(--bg-tertiary);color:var(--purple-light);padding:2px 8px;border-radius:10px;border:1px solid var(--border)">{{ {'macos-native':'üñ•Ô∏è macOS','ios-native':'üì± iOS','android-native':'ü§ñ Android','web-docker':'üê≥ Docker','web-node':'‚¨¢ Node.js','web-static':'Static'}.get(result_project_type, result_project_type) }}</span>
                {% endif %}
                {% if result_deploy_url %}
                <a href="{{ result_deploy_url }}" target="_blank" class="mc-result-link">{{ result_deploy_url }}</a>
                {% endif %}
                {% if result_launch_cmd %}
                <code class="mc-result-cmd mc-exec-btn" data-cmd="{{ result_launch_cmd }}" title="‚ñ∂ Cliquer pour ex√©cuter" style="color:var(--green);border-color:var(--green);cursor:pointer">üöÄ {{ result_launch_cmd }}</code>
                {% endif %}
                {% if result_run_cmd and result_run_cmd != result_launch_cmd %}
                <code class="mc-result-cmd mc-exec-btn" data-cmd="{{ result_run_cmd }}" title="‚ñ∂ Cliquer pour ex√©cuter" style="cursor:pointer">‚ñ∂ {{ result_run_cmd }}</code>
                {% endif %}
                {% if result_build_cmd and result_build_cmd != result_run_cmd %}
                <code class="mc-result-cmd mc-exec-btn" data-cmd="{{ result_build_cmd }}" title="‚ñ∂ Cliquer pour ex√©cuter" style="color:var(--text-secondary);cursor:pointer">üîß {{ result_build_cmd }}</code>
                {% endif %}
            </div>
            <!-- Inline terminal for command output -->
            <div id="mc-terminal" style="display:none;background:#0a0a12;border:1px solid var(--border);border-radius:6px;padding:8px 12px;margin-top:6px;max-height:200px;overflow-y:auto;font-family:var(--font-mono);font-size:0.75rem;line-height:1.5">
                <div id="mc-terminal-header" style="color:var(--text-secondary);margin-bottom:4px">
                    <span id="mc-terminal-cmd" style="color:var(--purple-light)"></span>
                    <span id="mc-terminal-status" style="float:right"></span>
                </div>
                <pre id="mc-terminal-output" style="margin:0;white-space:pre-wrap;color:var(--text-primary)"></pre>
            </div>
            {% if result_screenshots %}
            <div class="mc-result-shots">
                {% for s in result_screenshots %}
                <img src="/workspace/{{ mission.id }}/{{ s }}" alt="{{ s }}" loading="lazy" onclick="window.open(this.src)" onerror="this.style.display='none'">
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% endif %}
        <div class="mc-stats">
            <div class="mc-stat-item"><span class="val" id="mc-done-count">{{ mission.phases|selectattr('status.value','equalto','done')|list|length }}</span>/<span>{{ mission.phases|length }}</span> phases</div>
            <div class="mc-progress-bar"><div class="mc-progress-fill" id="mc-progress-bar" style="width:{{ ((mission.phases|selectattr('status.value','equalto','done')|list|length / mission.phases|length) * 100)|round|int if mission.phases|length > 0 else 0 }}%"></div></div>
            <div class="mc-stat-item"><span class="val" id="mc-progress">{{ ((mission.phases|selectattr('status.value','equalto','done')|list|length / mission.phases|length) * 100)|round|int if mission.phases|length > 0 else 0 }}%</span></div>
        </div>

        <!-- Tab bar -->
        <div class="mc-tabs">
            {% for tp in tab_profile %}
            <button class="mc-tab-btn{% if loop.first %} active{% endif %}" data-tab="{{ tp.id }}" onclick="switchTab('{{ tp.id }}')"><svg class="icon"><use href="#icon-{{ tp.icon }}"/></svg> {{ tp.label }}</button>
            {% endfor %}
        </div>

        <!-- Tab: Phases (default) -->
        <div class="mc-tab-panel" data-tab="phases" style="display:block">
        <div class="mc-pipeline" id="mc-pipeline">
            {% for phase in mission.phases %}
            {% set pa = phase_agents.get(phase.phase_id, []) %}
            <div class="mc-phase{% if phase.status.value == 'running' %} open{% endif %}" data-phase-id="{{ phase.phase_id }}" data-status="{{ phase.status.value }}">
                <div class="mc-phase-line">
                    <div class="mc-phase-dot"></div>
                    <div class="mc-phase-connector"></div>
                </div>
                <div class="mc-phase-card">
                    <div class="mc-phase-header" onclick="togglePhase(this)">
                        <span class="mc-phase-num">{{ loop.index }}</span>
                        <span class="mc-phase-name">{{ phase.phase_name }}</span>
                        <div class="mc-phase-avatars">
                            {% for a in pa[:4] %}
                            <img src="{{ a.avatar_url }}" title="{{ a.name }} ‚Äî {{ a.role }}" onclick="showMcPopover('{{ a.id }}',event);event.stopPropagation()" style="cursor:pointer" onerror="this.style.display='none'">
                            {% endfor %}
                            {% if pa|length > 4 %}<span class="more">+{{ pa|length - 4 }}</span>{% endif %}
                        </div>
                        <span class="mc-phase-pattern">{{ phase.pattern_id }}</span>
                        <span class="mc-phase-status-badge {{ phase.status.value }}">{{ phase.status.value }}</span>
                        <span class="mc-phase-chevron"><svg class="icon icon-xs mc-phase-chevron-icon"><use href="#icon-chevron-right"/></svg></span>
                    </div>
                    <div class="mc-phase-summary" id="summary-{{ phase.phase_id }}">
                        {% if phase.summary %}<div class="mc-summary-line"><span class="mc-summary-text">{{ phase.summary[:300] }}</span></div>{% endif %}
                        {% set shots = phase_screenshots.get(phase.phase_id, []) if phase_screenshots is defined else [] %}
                        {% if shots %}
                        <div class="mc-phase-thumbs">
                            {% for s in shots %}
                            <img class="mc-phase-thumb" src="/workspace/{{ mission.id }}/{{ s }}" alt="Screenshot" loading="lazy" onclick="window.open(this.src)" onerror="this.src='/workspace/{{ s }}'">
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    <div class="mc-phase-body">
                        <!-- Full flow graph -->
                        <div class="mc-phase-graph" id="graph-{{ phase.phase_id }}"></div>
                        <!-- Discussion below graph -->
                        <div class="mc-phase-discuss" id="discuss-{{ phase.phase_id }}">
                            {% set pmsgs = phase_messages.get(phase.phase_id, []) %}
                            {% if pmsgs %}
                                {% for msg in pmsgs %}
                                {% set msg_mode = "chat" %}
                                {% include "partials/msg_unified.html" %}
                                {% endfor %}
                            {% else %}
                                <div class="mc-discuss-empty">{{ _("en_attente_d_execution") }}</div>
                            {% endif %}
                        </div>
                    </div>
                    {% if phase.status.value == 'waiting_validation' %}
                    <div class="mc-checkpoint">
                        <h4>{{ _("checkpoint_validation_requise") }}</h4>
                        <div class="mc-checkpoint-actions">
                            <button class="mc-btn-go" onclick="validateMission('GO')">{{ _("go") }}</button>
                            <button class="mc-btn-nogo" onclick="validateMission('NOGO')">{{ _("nogo") }}</button>
                            <button class="mc-btn-pivot" onclick="validateMission('PIVOT')">{{ _("pivot") }}</button>
                        </div>
                    </div>
                    {% endif %}
                    {% if phase.summary %}
                    <div style="padding:0.35rem 0.75rem;font-size:0.72rem;color:var(--text-secondary);border-top:1px solid var(--border)">{{ phase.summary[:300] }}</div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        </div>{# end tab: phases #}

        {% if workflow_type == 'security-hacking' %}
        {% include 'partials/mc_tabs_security.html' %}

        {% elif workflow_type == 'rse-compliance' %}
        {% include 'partials/mc_tabs_rse.html' %}

        {% elif workflow_type in ('tma-maintenance', 'dsi-platform-tma') %}
        {% include 'partials/mc_tabs_tma.html' %}

        {% else %}
        {% include 'partials/mc_tabs_default.html' %}

        {% endif %}{# end workflow_type conditional tabs #}
    </div>

    <!-- ====== RIGHT SIDEBAR ====== -->
    {% include 'partials/mc_sidebar.html' %}
</div>

{% include 'partials/mc_scripts.html' %}
{% endblock %}
